SD5182HV100 Functional Specification Page 1 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
SD 5182HV1005182HV1005182HV1005182HV1005182HV1005182HV100 5182HV1005182HV100 Functional Functional Functional Functional Specification Specification Specification SpecificationSpecification Specification
SD5182HV100 Functional Specification Page 2 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
REVISION HISTORY
Ver Date Author and Comments
Add new entries below this line!
0.6
2017-May-9
First version to provide hardware guideline.
0.7
2017-June-5
修改内容参见Diff（修订记录）。
0.8
2017-June-30
增加DFX、OAM章节；
部分内容根据review意见修改，具体参见Diff（修订记录）；
0.9
2017-Aug-2
修改内容参见Diff（修订记录）。
1.0
2017-Sep-6
增加1588章节；
部分内容根据review意见修改，具体参见Diff（修订记录）；
1.1
2017-Oct-31
增加“大小端”模式说明（3.7章）；
增加PIE RX方向pkt-info长度配置说明；
增加PIE/PRBS通道指定优先级在入口队列优先级的映射的描述；
1.2
2017-Dec-06
针对“CR2017110718485377”，2.5GE SerDes变更为与USB3.0复用；
修改整体框图，增加COP AXI接口；
PQM模块补充Error Handing；
其他小改动具体参见Diff（修订记录）；
1.3
2018-Jan-11
USB接口规格修改：
原规格：1个USB3.0+1个USB2.0；
新规格：2个USB3.0；
其他改动具体参见Diff（修订记录）；
1.6
2018-Feb-11
例行版本合并，主要更新章节包括OAM、PQM、HA、EQM等，具体变更内容参见Diff版本（修订记录）；
SD5182HV100 Functional Specification Page 3 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
1 INTRODUCTION
SD5182是一颗10G PON高端家庭网关芯片，支持4GE，双频WiFi。网络处理器采用可编程架构（Programmable Search-Action），报文处理性能为10Mpps；数据通路性能为15Gbps。
本文包含以下章节：
Chapter 2 是功能概述。
Chapter 3 是系统流程描述。
Chapter 4 是接口模块描述。
Chapter 5 是数据通路子系统每个模块的详细描述。
Chapter 6是可编程转发处理子系统每个模块的详细描述。
Chapter 7是内嵌控制平面子系统每个模块的详细描述。
Chapter 8 描述芯片的时钟系统。
Chapter 9 描述芯片的复位和初始化过程。
Chapter10描述芯片的OAM功能。
Chapter11 描述芯片的1588功能。
Chapter12 描述芯片的DFX功能。
SD5182HV100 Functional Specification Page 4 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
2 FUNCTIONAL OVERVIEW
SD5182HV100 Functional Specification Page 5 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
2.1 BLOCK DIAGRAM AND HIGH-LEVEL BLOCK DESCRIPTION
2.1.1 Block Diagram
下图所示，为5182 主要的功能模块和主要的接口。该功能说明书（FS）将详细描述每个
模块的规格、行为和性能。
Egress
Port
Scheduler
(EPS)
Quark
PRBS RX PRBS TX
CoProcessor
(COP) Action
Processor
(AP)
Edit
Processor
(EP)
Order
Enforcer
(OE)
Packet Editor(PE)
Egress
Queue
Manager
(EQM)
DDR Memory Controler(DMC)
PIE
Insertion
UNI RX
NNI RX
Packet
Queue
Manager
(PQM)
Free Address
Manager
(FAM)
Memory Pool(MEMP)
PIE
Extraction
UNI TX
NNI TX
Ingress
Port
Scheduler
(IPS)
Embeded CPU
Sub-system(ECS)
Internal Control
Sub-System(ICSS)
From
ECS
To/From other blocks
UART etc
Hardware
Accelerator
(HA)
Data Path(DP)
Fine_Grain Processor(FP)
Programmable Search-Action(PSA)
SD5182H
To ECS
WiFi Offloading
Engine(WOE)
-RX
ECS AXI
WiFi Offloading
Engine(WOE)
-TX
USB
PCIe
ECS AXI
Figure 2.1-1 Block Diagram
2.1.2 Block Description
Block Name Description
NNI 网络-网络接口（Network-Network Interface）。这个接口为1 个SerDes 接
口，内部集成多个PON MAC 和1 个GE MAC，可以和10G xPON、xPON、
GE 的光收发器连接。
UNI 用户网络接口（User Network Interface）。支持4 个GE，和1 个RGMII 接
口。
IPS 入端口调度（Ingress Port Scheduler）。入口端口的汇聚和调度。
PQM 报文队列管理（Packet Queue Manager）。进行入口队列管理和调度，给PSA
提供报文头和数据；对于PSA处理完的报文，从PLB读出送给PE编辑。
HA 硬件加速器（Hardware Accelerator），分析报文头，匹配入队优先级，并生
成报文描述信息。
MEMP 存储池（Memory Pool）。报文处理延时缓存和片内缓存共享的存储器，此共
享存储池大小约8Mbit。
SD5182HV100 Functional Specification Page 6 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Block Name Description
FAM
空闲地址管理器（Free Address Manager）。 分配和回收数据通路中所有报文使用的缓存地址。并进行组播ID和权重管理。
PE
报文编辑器（Packet Editor）。 此模块根据PSA产生的报文编辑命令和编辑数据，接收经过PQM读取的原始报文，进行报文编辑。
EQM
出口队列管理（Egress Queue Manager）。进行出口队列的管理和调度。
EPS
出口端口调度器（Egress Port Scheduler）。负责读取要发送的报文数据并分发给指定的接口模块。
AP
执行处理器（Action Processor）。进行报文的分析和处理。
EP
编辑处理器（Edit Processor）。根据AP处理结果，产生报文编辑命令和报文编辑数据。
FP
Fine-Grain Processor。专职用于“控制处理”任务，如OAM、时戳处理等。仅仅由一个RAE构成。
OE
排序器（Order Enforcer）。 此模块学习每个端口报文的接收顺序，确保报文的发送顺序和接收顺序一致。同时此模块能确保一些访问协处理器命令按照顺序执行。
COP
协处理器（Co-Processor）。用于访问TCAM、内部通用memory以及外部通用memory。同时支持EM（Exact Match）和LPM（Longest Prefix Match）算法。
PIE
报文插入和提取（Packet Insert and Extract）。 给CPU提供向数据通路插入报文或从数据通路提取报文的方法。
WOE
Wifi Offloading Engine，此模块完成Wifi Offloading线路特性相关功能，如reorder、队列管理等。
ECS
嵌入CPU子系统（Embedded CPU Sub-system）。
ICSS
内部控制处理器子系统（Internal Control processor Sub-System）.。此模块让控制平面访问芯片内 的控制和状态空间。
Table 2.1-1 Block Overview
2.1.3 Service Port Interface Description
业务端口指芯片业务报文输入输出的端口， NNI接口模式通过独立的寄存器进行配置。
NNI端口模式配置列表描述：
NNI Mode CFG
NNI Mode
bit3
bit2
bit1
bit0
数值
0
0
0
0
0
GPON
0
0
0
1
1
EPON
0
0
1
0
2
10GEPON（UP 1G）
0
0
1
1
3
10GEPON
SD5182HV100 Functional Specification Page 7 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
(UP 2.5G）
0
1
0
0
4
10GEPON（对称）
0
1
0
1
5
10GGPON
0
1
1
0
6
GE光
0
1
1
1
7
2.5GE
1
0
0
0
8
SGMII
1
0
0
1
9
保留，端口去使能
1
1
0
1
D
10GGPON（对称）
Other
保留，端口去使能
Table 2.1-2 NNI Mode Description
UNI端口，因为4个GE接口和RGMII接口模式是固定的，所以不再通过UNI Mode配置，当一个USB3.0 PHY（PHY1）端口复用为2.5GE或者GE时，通过USB3.0端口模式配置。
USB3.0以太网口模式配置寄存器在“全局配置寄存器”，参考《SD5182HV100 IOMUX REG.xlsm》中的“USB3_ETH_MODE”寄存器。
2.1.4 External Interface Overview
2.1.4.1.1 Service Interfaces
 NNI侧支持xPON接口：
o NNI侧提供1个GPON/10G GPON ASYM/10G GPON SYM / EPON/ 10G EPON ASYM/10G EPON LITE/10G EPON SYM/GE/SGMII共9模的SerDes接口；
 UNI侧支持4GE接口：
o 内置4个GE PHY。
o 兼容支持100M、10M速率。
o 支持全双工、半双工。
 UNI侧支持RGMII接口：
o 支持1个RGMII接口。
o 兼容支持MII模式。
o 支持全双工、半双工。
 UNI侧支持2.5GE接口：
o 内置独立的GE MAC。
SD5182HV100 Functional Specification Page 8 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
o Serdes复用USB3.0。
 支持PCIE接口：
o 支持2个PCIE2.0接口。
 支持2个USB接口：
o 支持2个USB3.0；
o 支持一个USB3.0 PHY（PHY1）复用给UNI 2.5GE，此场景下USB3.0不可用。
 支持2路语音接口；
 支持1588v2时间同步。
o 支持1PPS输出、输入，不能同时支持。
o NNI接口支持slave模式，UNI接口支持master模式。
o 支持时间同步专用IIC接口。
2.1.4.1.2 Management Interfaces
 SPI接口：
o 支持1组SPI接口；
o 外出2个片选；
o 支持Master工作模式；
o 支持motorola和national帧格式；
 I2C接口：
o 最大支持2个I2C接口；
o 支持最高速率为2Mbps；
 UART接口：
o 最大支持3个UART接口；
o 支持最高速率为1Mbps；
 GPIO接口：
o 最大支持64个GPIO接口（复用）；
2.1.4.1.3 Other Interfaces
 DRAM接口：
o 支持1组32bit@850M Hz DDR3（最大容量512Mbyte），或者32bit@1066MHz DDR4接口（最大容量1024Mbyte）；
o 兼容支持16bit数据位宽模式。
 Flash接口：
o 支持NAND Flash（最大容量4Gbyte）或者SPI NAND Flash（最大容量1Gbyte）接口；
 JTAG接口：
SD5182HV100 Functional Specification Page 9 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
o 支持1个JTAG接口用于芯片测试；
 Clock and Reset接口；
o 一个参考时钟源；
o 一个按键复位接口；
o 内置POR。
SD5182HV100 Functional Specification Page 10 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
2.2 FEATURE LIST
2.2.1 Datapath Features
 支持硬件解析报文优先级，能够基于优先级队列进行报文处理和拥塞丢弃。
 支持片内、片外缓存。
 最大支持8Mbit片内缓存，片内缓存分为PLB/IFB，在不同应用场景下，可以上电初始化各块缓存大小。
 帧缓存为链表存储方式。片内cell的大小为160Byte，片外cell的大小为512/1024Byte。
 支持Jumbo帧，最大支持9600Byte。
 支持控制平面从数据通路提取和向数据通路插入报文。
2.2.2 Traffic Management Features
Traffic Management（TM）包括队列管理和队列调度两部分。
2.2.2.1.1 TM Queue Resource Management
 基于出口进行队列管理，支持256个优先级队列。
 每个优先级队列可以指定队列组属性，共支持32个队列组。
 缓存管理支持多级管理，包括：队列独享资源，队列组独享资源，共享资源。
 最大支持6K片内缓存cell（和PLB共享），32K片外缓存cell。
 支持加权随机早期检测(WRED - Weighted Random Early Detection)。
 支持32个Sharper模板。
2.2.2.1.2 TM Scheduler
 最多支持4级业务调度，支持48个通用调度器，4个端口调度器。
 通用调度器最多有16个输入端，支持SP/WRR算法，精度为1/255。
 端口调度器分别用于二次入队、NNI口、UNI口、PIE+PRBS口。支持RR算法。
 支持流量整形：
o 队列和调度器的输入支持单漏桶Sharper，Sharper速率为0~10Gbps。
o 队列和通用调度器shaper的令牌更新周期默认为125us，全局可配；端口调度器的令牌更新周期为8us。
o Shaper支持预借令牌，最多支持一个报文的令牌。
 支持最多43个逻辑通道输入，包括16个PON通道+1个PRBS通道+1个二次入队通道+4个PIE通道+5个UNI GE通道+1个WOE。
 只支持静态修改队列属性和调度器拓扑结构。
2.2.3 PSA Features
 通过多个多线程RISC核，配合报文预处理引擎（HA），执行用户定制的微码程序；
SD5182HV100 Functional Specification Page 11 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 RISC是一个优化的可编程Pipeline with RTC；
 针对业务处理特点，优化指令集，包括单周期多分支指令；
 通过Order Enforcer支持报文保序；
 Co-processor支持存储资源共享：支持最大2Mb片内SRAM，支持最大128Mb片外DRAM，支持8块（每块512*40bit） TCAM；
 支持对存储的直接访问、读改写等，支持Semaphore FIFO和Message FIFO；
 支持基于hash的精确匹配（EM）；
 通过HA实现报文头分析、报文信息提取和基本流分类；
2.2.4 Embedded Control Processor Features
 提供双核ARM Cortex A9 CPU，运行频率为1GHz，支持通过升压达到1.2GHz。
 CPU提供独立的64KB指令Cache和32KB数据Cache。
 提供256KB L2 Cache。
2.2.5 Power Saving Features
 支持Datapath工作频率的配置和调整；
 支持转发处理的能力根据实际流量进行动态工作频率自动调整；
 支持接口IO和SerDes的Power Down；
 支持接口MAC模块的Power Down；
 支持DDR接口工作频率的调整；
 支持内置CPU的工作频率调整和PowerDown；
 支持内部表项和存储资源根据实际需要Power Down。
2.2.6 Reliability, Test, and Debug Features
[TBD]
2.2.7 Product Compliance
 RoHs5 Compliant
SD5182HV100 Functional Specification Page 12 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
2.3 PRODUCT MARKINGS
[TBD]
SD5182HV100 Functional Specification Page 13 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
2.4 TYPICAL APPLICATIONS
SD5182 主要应用于10G PON 家庭网关、无源光局域网（POL）等设备中。
2.4.1 10G PON Home Gateway
 UNI 接口支持4 口GE；另外支持1 个RGMII 用于对接G.hn/OTT 等；
 NNI 接口支持NGPON（10G GPON 对称和非对称模式）/XGEPON（10G EPON 对
称和非对称模式）/TWDMPON/EPON/GPON/GE/2.5GE；
 支持2 个PCIe2.0 接口，对接双频WiFi 芯片；
 支持2 个USB 3.0 接口。
 支持13Gbps@128Bytes 转发性能；
 支持2 路语音。
SD5182H Optical
Module
SerDes
DDR3/4 Flash
USB3*2
GE*4
RGMII
SLIC
WiFi
AP
WiFi
AP
PCIe2 PCIe2
VoIP WiFi WiFi
PON
Figure 2.4-1 Block Diagram
2.4.2 POL Access
 4GE POE + 2POTS + WiFi 瘦AP。
 UNI 接口支持4 口GE，支持POE 应用，支持100 米传输距离；
 NNI 接口支持NGPON（10G GPON 对称和非对称模式）/XGEPON（10G EPON 对
称和非对称模式）/TWDMPON/EPON/GPON/GE/2.5GE；
 支持2 个PCIe2.0 接口，对接双频WiFi 芯片；
 支持2 路语音。
SD5182HV100 Functional Specification Page 14 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
SD5182H Optical
Module
SerDes
DDR3/4 Flash
GE*4
SLIC
WiFi
AP
WiFi
AP
PCIe2 PCIe2
VoIP WiFi WiFi
PON
POE
隔离
I2C
Figure 2.4-2 Block Diagram
SD5182HV100 Functional Specification Page 15 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
3 SYSTEM FLOWS DESCRIPTION
从用户理解整体芯片处理过程的角度，描述整个芯片的处理过程。
SD5182HV100 Functional Specification Page 16 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
3.1 SYSTEM PACKET FLOW
为描述方便，将接口模块以外的模块划分到3 个子系统中：
1）数据通道子系统（Datapath Sub-System）: 主要完成帧数据的缓存、队列管理和QoS 调
度功能。 属于数据通道子系统的主要模块有IPS、PQM、MEMP、FAM、PE、EQM、
EPS 等模块。
2）业务处理子系统：主要由可编程查找执行模块（Programmable Search-Action）、HA
模块构成，来完成报文协议分析、转发处理等功能。
3）内嵌控制平面子系统（Embedded Control Plane Sub-System）：提供内置控制CPU 和
整个芯片的配置和寄存器访问。控制平面子系统包括ECS、ICSS 等模块。
3.1.1 Main Packet Dataflow
Egress
Port
Scheduler
(EPS)
Quark
PRBS RX PRBS TX
CoProcessor
(COP) Action
Processor
(AP)
Edit
Processor
(EP)
Order
Enforcer
(OE)
Packet Editor(PE)
Egress
Queue
Manager
(EQM)
DDR Memory Controler(DMC)
PIE
Insertion
UNI RX
NNI RX
Packet
Queue
Manager
(PQM)
Free Address
Manager
(FAM)
Memory Pool(MEMP)
PIE
Extraction
UNI TX
NNI TX
Ingress
Port
Scheduler
(IPS)
Embeded CPU
Sub-system(ECS)
Internal Control
Sub-System(ICSS)
From
ECS
To/From other blocks
UART etc
Hardware
Accelerator
(HA)
Data Path(DP)
Fine_Grain Processor(FP)
Programmable Search-Action(PSA)
SD5182H
To ECS
WiFi Offloading
Engine(WOE)
-RX
WiFi Offloading
Engine(WOE)
-TX
USB
PCIe
1 3
4 5 6
8
7
9 10
2
ECS AXI
ECS AXI
Figure 3.1-1 Main Packet Dataflow
上图为基本数据流程。
MEMP 的片内作为报文缓存的资源分成两大部分：报文处理延迟缓冲区（PLB）和内部帧
缓冲区（IFB）。信元大小统一为160B，Head 信元的报文头数据为128B，FD 信息为
32B。
业务数据在芯片中的处理过程如下：
SD5182HV100 Functional Specification Page 17 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
1. 系统所有入口数据由IPS汇聚：IPS先向FAM申请缓存，对所有输入接口进行调度，按照调度结果，将报文存入PLB（MEMP）。当一个完整报文存入后，将报文头读出，发送给HA模块。
2. HA对报文头数据进行解析，生成PSA处理需要的帧描述信息（FD），并根据报文特征匹配出入口队列优先级，然后将帧描述信息、入队优先级和报文指针发送给PQM模块。
3. PQM首先将帧描述信息存入PLB（MEMP），然后根据报文入队优先级，将报文（指针）入队和调度，在系统出现反压的时候，优先级低的队列首先进行丢包（并释放MEMP缓存）。当PSA有空闲线程，PQM调度输出，将相应的报文Head再次读出，输送给PSA处理。PQM支持pull More指令读取Head外的更多数据。
PQM还负责管理PAC_ID资源，当新报文Head发给PSA时，会申请并携带PAC_ID；当PE读走单播或者组播最后一份报文时，则释放PAC_ID 资源。
4. 在Quark的AE模块进行报文的各种分析和处理。
5. 当AE完成完成一个报文的处理后，发送Transmit*命令给OE，进行保序处理，当从“保序队列”输出时：
a. 指示PQM把报文读出，准备给PE编辑。
b. 同时指示EE读取报文context信息。
c. 在Context信息全部读出后，通知AE释放线程。
6. EE模块根据报文context信息生成编辑命令（EC）和编辑数据（ED），发送给PE。
7. 在PQM将报文送给PE之后，释放Head和Body的缓存。
8. PE模块接收并缓存从PSA送过来的EC和ED，对PQM送过来的报文数据，进行相应的报文编辑（并计算checksum）。PE还负责完成编辑后的报文头及报文身体的搬运和链接，所有报文首先搬运到内置缓存（MEMP）。然后将报文描述符送给EQM。
9. EQM首先进行入队判决，成功入队的报文存入“端口组队列”（按照出端口为NNI、UNI、PIE/PRBS分为3个队列），进行调度，将调度出的报文搬运到外置缓存（DDR）或者继续存储在内置缓存中，然后将报文描述符送给“出端口队列”，进行出口QoS管理。
10. EPS模块从内置或者外置缓存读取数据，完成出口数据分发，以及地址释放。
3.1.2 Multicast Packet Flow
为提供更加灵活的多播复制机制，多播报文（包含广播报文）支持软件复制和硬件复制两种方式：
 Software Multicast Dataflow：由Quark微码完成组播复制，支持报文整包编辑；
SD5182HV100 Functional Specification Page 18 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 Hardware Multicast Dataflow：由硬件协助完成组播复制，支持报文头（128B）编辑。
下面分别描述两种组播复制流程：
3.1.2.1 Software Multicast Dataflow
Egress
Port
Scheduler
(EPS)
Quark
PRBS RX PRBS TX
CoProcessor
(COP) Action
Processor
(AP)
Edit
Processor
(EP)
Order
Enforcer
(OE)
Packet Editor(PE)
Egress
Queue
Manager
(EQM)
DDR Memory Controler(DMC)
PIE
Insertion
UNI RX
NNI RX
Packet
Queue
Manager
(PQM)
Free Address
Manager
(FAM)
Memory Pool(MEMP)
PIE
Extraction
UNI TX
NNI TX
Ingress
Port
Scheduler
(IPS)
Embeded CPU
Sub-system(ECS)
Internal Control
Sub-System(ICSS)
From
ECS
To/From other blocks
UART etc
Hardware
Accelerator
(HA)
Data Path(DP)
Fine_Grain Processor(FP)
Programmable Search-Action(PSA)
SD5182H
To ECS
WiFi Offloading
Engine(WOE)
-RX
WiFi Offloading
Engine(WOE)
-TX
USB
PCIe
1
3 4
5 6
2
ECS AXI
ECS AXI
Figure 3.1-2 Software Multicast Dataflow
1. 报文经过前面各级模块处理后发送到Quark。
2. Quark 对报文进行分析和处理，当分析后发现为组播报文时，则查找组播表，获取组
播组、组播叶子节点数等组播相关信息。对于组播非最后一片叶子报文，微码发送
“Transmit Multicast”命令（线程进入Sleep）；对于组播最后一片叶子报文，则发送
“Transmit Unicast”命令，同普通单播报文的处理方式一致。
3. OE 对这个组播报文进行保序处理，当组播报文处于保序队列头的时候，则执行如下
处理：
a. 指示PQM 从PLB 中把报文读出，等待PE 读取。
b. 指示EE 读取报文context 信息，生成EC 和ED。
c. 对于组播非最后一份叶子报文，在Context 信息全部读出后，通知AE 唤醒Sleep
线程，继续进行这个组播报文的下一份拷贝动作。
d. 对于组播最后一份叶子报文，在Context 信息全部读出后，释放AE 线程。
SD5182HV100 Functional Specification Page 19 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4. EE 模块根据报文context 信息生成编辑命令（EC）和编辑数据（ED），发送给PE。
5. PQM 模块从PLB 读取报文发送给PE，并根据Quark 指示，在组播非最后一份叶子报
文读出后，不释放PLB 中的报文缓存，一直等到组播最后一份叶子报文读出后，再
释放PLB 中的报文缓存，并释放PAC_ID。
6. PE 模块接收并缓存从PSA 送过来的EC 和ED，从PQM 读取报文数据，进行相应的
报文编辑，编辑后的报文首先搬运到内置缓存中，并且进行报文头及报文身体的链接，
最后将报文描述符送给EQM。
上述步骤2~6 不断重复，直到完成这个组播报文的复制。
3.1.2.2 Hareware Multicast Dataflow
Egress
Port
Scheduler
(EPS)
PE
Egress
Queue
Manager
(EQM)
FAM
Memory Pool(MEMP)
Ingress
Port
Scheduler
(IPS)
HA
Data Path(DP)
6
PSA ITF
MEMP RD
4a
4b
PQM
7 8 9
WTB
PTB
10
Quark
PRBS RX PRBS TX
CoProcessor
(COP) Action
Processor
(AP)
Edit
Processor
(EP)
Order
Enforcer
(OE)
DDR Memory Controler(DMC)
PIE
Insertion
UNI RX
NNI RX
PIE
Extraction
UNI TX
NNI TX
Embeded CPU
Sub-system(ECS)
Internal Control
Sub-System(ICSS)
From
ECS
To/From other blocks
UART etc
Fine_Grain Processor(FP)
Programmable Search-Action(PSA)
SD5182H
To ECS
WiFi Offloading
Engine(WOE)
-RX
WiFi Offloading
Engine(WOE)
-TX
USB
PCIe
1
2 5 3
ECS AXI
ECS AXI
Figure 3.1-3 Hardware Multicast Dataflow
1. 报文经过前面各级模块处理后发送到Quark。
2. Quark 对报文进行分析和处理，当发现为组播根报文（硬件复制）时，则查找组播表，
获取MRID[6:0]、LeafNum[4:0]、PQM_Pri[1:0]等组播相关信息。发送Tranmit Unicast，
并指示进行组播复制。
3. OE 对这个组播根报文进行保序处理，当组播报文处于保序队列头的时候，则执行如
下处理：
SD5182HV100 Functional Specification Page 20 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
a. 指示PQM进行组播复制。
b. 释放AE线程。
c. 无需EE读取报文context信息生成EC和ED。
4. PQM组播复制：
a. 通过PAC_ID获得报文头指针Pcap[12:0]、尾指针Tcap[12:0]、长度等，释放PAC_ID，按照PQM_Pri[1:0]指示，将组播根报文MRID[6:0]、LeafNum[4:0]、指针信息等写入组播复制队列（4个优先级队列，链表实现，总深度128）；在根报文第一份叶子输出时，为组播根报文申请WGT_ID[6:0]（用来管理组播根报文在PLB中的权重）。
b. PQM队列调度输出，如果是组播复制报文，则复制出一份叶子报文，通过Pcap从PLB读取报文Head，申请新的PAC_ID（并为PAC_ID记录对应的WGT_ID），同时携带MRID[6:0]、LeafNum[4:0]、SeqNo[4:0]信息，指定channel为组播复制环回专用ID，发送给Quark。1个根报文复制出LeafNum份叶子报文，每个叶子报文通过SeqNo区分。
5. Quark对组播报文进行后续的业务处理，然后发送“Transmit Unicast”命令。
6. PQM根据PAC_ID查表获得WGT_ID，查WTB（WTB记录LeafNum、已经接收到第几份叶子），判断是组播首报文、中间报文、尾报文，决定读取报文整包或者Head，以及是否释放PLB缓存，并把组播首、尾标志携带给PE模块。当组播尾报文处理完成后，释放WGT_ID。同时PQM负责在组播首报文时申请MCID，在组播报文发送过程中统计MCID_IFB组播权重，在组播尾报文时释放MCID_IFB的剩余权重。
7. PE模块对报文进行编辑。在PE模块内维护一个WGT_ID相应深度的Body地址表，当组播首报文到达时，记录body地址，组播中间报文或者尾报文到达时，通过记录的Body地址进行建链操作。
8. EQM模块内部维护一个MCID相应深度的组播Body地址表，用来存放EFB Body地址，同时这个表项有1bit标志位，用于标识这个MCID的Body地址是否已经记录过， MCID释放时，FAM通知将这个bit清0。完成通道组队列调度后，如果报文需要存放到EFB，且报文是组播报文，则释放1份MCID_IFB权重，增加1份MCID_EFB权重（MCID_EFB的初始值为0）；另外，判断这个报文的Body地址是否已经记录过，如果未记录过，将这个报文整包存放在EFB，并记录Body地址；如果这个报文的Body地址已经记录过，则仅把这个报文的Head存放到EFB，并用已经存放的Body地址建链。
9. EPS读取报文后，如果是组播报文，则进行权重释放（根据报文存储位置，确定MCID_IFB还是MCID_EFB）。
SD5182HV100 Functional Specification Page 21 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
10. FAM在收到MCID权重释放请求后，进行权重减操作，当MCID_IFB和MCID_EFB同时为0时，释放MCID。 当Body地址对应的MCID_IFB或者MCID_EFB权重值为0时，释放IFB或者EFB中的Body地址。
组播 软件复制和硬件复制两种方式的约束：
1. 硬件复制只支持Head编辑，软件复制只支持整包编辑。
2. 硬件复制之后的报文进行软件复制：此时软件复制的非尾报文，需要标记FreePkt为0，在PQM不进行WGT_ID的权重释放，这样WGT_ID的权重是平衡的；每个软件复制的报文都参与“叶子个数”的统计。这种情况下的组播软件复制报文，只能进行Head编辑。
3. 软件复制之后的报文进行硬件复制，不能直接通过硬件复制流程进行硬件复制，需要将这个叶子报文经过PRBS环回，再对其进行硬件复制，DP通道对其不敏感。
SD5182HV100 Functional Specification Page 22 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
3.2 DATAPATH SUB-SYSTEM
描述接收，编辑，存储，发送报文流程，单拷贝流程、多拷贝流程、PSA交互、QoS、各种反压、通道映射等流程。描述数据通道的处理能力。
接收方向，在拥塞情况下能够基于优先级丢弃报文。出口支持多个优先级队列，多级调度、流量抑制和整形。
3.2.1 Datapath QoS Overview
数据通路的QoS主要体现在入口方向的QoS和出口方向QoS两个方面。
3.2.1.1.1 Rx QoS
 Rx QoS主要是在报文在发送给PSA之前，进行QoS处理。
 入口处，支持片内缓存存储未处理报文。
 支持入口优先级队列。
 支持报文进行优先级识别和流分类，入不同的优先级队列。
 如果接口带宽超过PSA的处理性能造成接收缓存拥塞的时候，可以基于优先级丢弃报文，达到拥塞的时候，尽量不丢弃协议保活之类的高优先级报文。
 芯片支持基于物理端口（pause帧）和全局反压。
 芯片支持基于入端口的CAR。
 入口处支持四个优先级队列，保证高优先级业务能及时得到处理。
3.2.1.1.2 Tx QoS
 Tx QoS主要是在报文发送给端口之前，进行QoS处理。
 基于出口支持8个优先级队列。
 每个优先级队列可指定队列组属性，芯片共支持32个队列组。
 缓存管理支持多级管理，包括：队列独享资源，队列组独享资源，队列组共享资源。
 拥塞管理支持WRED，减轻TCP全局同步现象。
 支持三级调度，调度算法支持SP/WRR/SP+WRR。
 基于优先级队列和调度器输出做流量整形。
 支持出逻辑通道反压。
SD5182HV100 Functional Specification Page 23 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
3.2.2 Datapath Channel Mapping
在接收方向，SD5182会根据内部接口和外部接口不同工作模式， 将所有的数据通道输入通道映射为统一的4bit输入源端口号。输入数据端口号定义如下：
4
3
2
1
0
Description
0x0
PON
0x1
保留
0x2
保留
0x3
PRBS
0
0b01
0
CPU专用端口
0
1~3
CPU扩展端口
0
8~15
以太网口，
8：GE0，
9：GE1，
10：GE:2，
11：GE3，
12：GE4（RGMII），
13：GE5（重用USB3.0 PHY实现）
14~15：保留
19
保留
20
WOE（WiFi Offloading Engine）通道；
21~29
保留；
30
环回通道（若IPS从PRBS收到的报文环回标识为1，则为30，而不是PRBS）；
31 ：
组播硬件环回通道
Table 3.2-1输入源端口号映射表
* CPU扩展端口用于WIFI/USB等业务加速，报文格式与普通以太端口相同。
** CPU专用端口用于控制报文的发送，报文中含有指定转发等控制信息。
3.2.3 Datapath Flow Control Overview
下面分芯片与外部其他芯片之间的反压机制和芯片内部的反压机制分别描述。
SD5182HV100 Functional Specification Page 24 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
IPS完成SD5182接口全线速汇聚处理，数据通路不反压；转发引擎可以反压
DMC反压EQM，EQM反压PE， PE逐级反压至PSA，PSA反压PQM，PQM根据优先级丢包；
MEMP/DMC可以暂时反压EPS，EPS需要处理多个端口的报文分发和防欠载处理
端口流控产生有两个来源：
1、IPS检测各端口流量，产生流控信号送给超过配置门限的端口。
2、FAM按来源端口统计各端口占用的CELL数，产生流控信号送给超过配置门限的端口。IPS和DQM在报文建链时送来源端口给FAM，并按源端口统计CELL占用情况。IPS/DQM/EQM/EPS释放CELL时，FAM在释放CELL的同时根据源端口信息统计CELL占用情况。FAM送出流控指示给IPS，IPS合并后送给各接口MAC。产生流控和取消流控的门限分别可配。
3.2.4 Packet Loopback
报文通过转发到PRBS端口，PRBS 模块将报文换回到IPS入口作为一个新报文进入转发系统进行处理。
SD5182HV100 Functional Specification Page 25 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
3.3 PROGRAMABLE SERACH-ACTION SUB-SYSTEM
SD5182HV100 Functional Specification Page 26 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
3.4 EMBEDED CONTROL PLANE SUB-SYSTEM
SD5182HV100 Functional Specification Page 27 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
3.5 DEFINE FOR TEST
3.5.1 Packet Droped Analysis in Dataflow
EPS
PRBS RX PRBS TX
PE
EQM
DMC
PIE
Insertion
UNI RX
NNI RX
PQM
FAM
MEMP
PIE
Extraction
UNI TX
NNI TX
IPS
HA
PSA
1 2 3 4 5 6
Figure 3.5-1 Packet Droped Analysis in Dataflow
上图为在系统数据流中的丢包点分析。
1. IPS 模块丢包策略：直接丢包或者打Drop 标志
a) 优先保证业务接口，对PIE、PRBS 的突发进行反压，缓存耗尽由接口丢包；
b) 毛刺包，直接丢弃；
c) 超长超短、MAC ERR、SOP/EOP 异常、入口CAR 等情况，给报文打Drop 标志；
2. HA 模块丢包策略：打Drop 标志
a) L3/L4 checksum error、MAC 合法检查错，给报文打Drop 标志；
3. PQM 模块丢包策略：直接丢包
a) 队列满；
b) PSA 指示丢包：PQM释放缓存和PAC_ID；
c) 组播根报文申请不到WGT_ID；
d) ECC,命令等异常；
4. PE 模块丢包策略：打Drop 标志
SD5182HV100 Functional Specification Page 28 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
a) 编辑后长度为0、编辑后长度超长、命令异常、EE 指示Discard、ECC 错误等，
给报文打Drop 标志；
5. EQM 模块丢包策略：直接丢包
a) 前面drop 报文在此丢包；
b) 入队使能关闭；
c) 基于通道组队列进行判决丢包（一次入队）；
d) 基于出端口队列进行判断（一、二次入队），队列满、队列拥塞、WRED 丢包；
6. EPS 模块丢包策略：直接丢包
a) 出端口错、FD ECC 校验错、超长超短等处理异常情况；
3.5.2 Trace Counter
支持针对业务流的追踪统计，用以定位数据在PQM、EQM 的丢包情况。最大支持3 条业
务流的同时统计。
EPS
PRBS RX PRBS TX
PE
EQM
DMC
PIE
Insertion
UNI RX
NNI RX
PQM
FAM
MEMP
PIE
Extraction
UNI TX
NNI TX
IPS
HA
PSA
1 2 3 4 5 6
Trace Domain 1: PQM丢包追踪Trace Domain 2: EQM丢包追踪
Trace
Match
Rx Trace
Counter
PE Trace
Counter
TX Trace
Counter
Figure 3.5.2-2 Trace Counter
1. 在HA 模块，通过FC 匹配出最多3 条业务流，用2bit 的TraCntID 标识，TraCntID 为
0 表示非追踪统计业务流。匹配规则包括但不限于如下：
Port/GemPort+/Vlan+/EthType+/SMAC+/DMAC+/SIP+/DIP+/Protocal。分别统计命中的
3 条流。并送出这2bit 的TraCntID 给PQM 模块。
SD5182HV100 Functional Specification Page 29 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
2. PQM模块将TraCntID作为FD的一个域写进MEMP。在报文经过PSA处理，从MEMP再次读出送给PE时，携带上这个2bit信息。
3. 在PE模块，分别统计带有TraCntID的数据流。将TraCntID作为EPS FD的一个域写入MEMP，并作为FCB的一个域送出给EQM。
4. 当EQM报文搬运到EFB时，携带TraCntID作为EPS FD的一个域写入DDR。
5. 在EPS模块，根据这2bit TraCntID进行统计。
上述统计Trace Counter的位宽为32bit，仅统计报文个数，计满后翻转。各个模块的3个计数器CPU可读，支持写清。
SD5182HV100 Functional Specification Page 30 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
3.6 SYSTEM PERFORMANCE
3.6.1 Datapath Performance
DP通路在250MHz时钟下，处理性能可实现14Gbps。
其中DP通路各个子模块的性能大于等于14Gbps，具体可参见第5章的描述。
3.6.2 Packet Processing Performance
SD5182H的报文处理由PSA实现，所以业务处理性能主要由PSA影响。
二层转发业务的性能可实现6.8Mpps，在128Byte包长的情况下可达到8Gbps，在大于256Byte包长的情况下可达到14Gbps以上。
三层业务的性能可实现3.6Mpps。
3.6.3 Multicast Performance
在基于硬件组播复制（PQM环回，参见第3.1.2.2章节描述）的情况下，组播（叶子）流量最大可实现4Gbps。
在基于软件组播复制的情况下，组播性能受限于环回通路上DP性能、PSA性能的的影响。
SD5182HV100 Functional Specification Page 31 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
3.7 BIG-ENDIAN(BE) AND LITTLE-ENDIAN(LE)
本文解释大小端的定义，以及SD5182H各个接口的大小端选择。
3.7.1 Big-Endian and Little-Endian Definition
不同的CPU有不同的字节序类型 这些字节序是指整数在内存中保存的顺序 这个叫做主机序 。 最常见的有两种：
大端模式（Big-Endian），是指数据的高字节保存在内存的低地址中，而数据的低字节保存在内存的高地址中，这样的存储模式有点儿类似于把数据当作字符串顺序处理：地址由小向大增加，而数据从高位往低位放；这和我们的阅读习惯一致。
小端模式（Little-Endian），是指数据的高字节保存在内存的高地址中，而数据的低字节保存在内存的低地址中，这种存储模式将地址的高低和数据位权有效地结合起来，高地址部分权值高，低地址部分权值低。
下面以unsigned int value = 0x12345678为例，分别看看在两种字节序下其存储情况，我们可以用unsigned char buf[4]来表示value
大小端模式Big-Endian: 低地址存放高位，如下：
高地址 --------------- buf[3] (0x78) -- 低位 buf[2] (0x56) buf[1] (0x34) buf[0] (0x12) -- 高位 --------------- 低地址
大小端模式Little-Endian: 低地址存放低位，如下：
高地址 --------------- buf[3] (0x12) -- 高位 buf[2] (0x34) buf[1] (0x56) buf[0] (0x78) -- 低位 --------------
低地址 内存地址 小端模式存放内容 大端模式存放内容
0x4000
0x78
0x12
SD5182HV100 Functional Specification Page 32 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
0x4001 0x56 0x34
0x4002 0x34 0x56
0x4003 0x12 0x78
Table 3.7-1 大小端模式下数据存放方式比较
不同的CPU 上运行不同的操作系统，字节序也是不同的，参见下表。
处理器 操作系统 字节排序
Alpha 全部 Little endian
HP-PA NT Little endian
HP-PA UNIX Big endian
Intelx86 全部 Little endian <-----x86 系统是小端字节序系统
Motorola680x() 全部 Big endian
MIPS NT Little endian
MIPS UNIX Big endian
PowerPC NT Little endian
PowerPC 非NT Big endian <-----PPC 系统是大端字节序系统
RS/6000 UNIX Big endian
SPARC UNIX Big endian
IXP1200 ARM 全部 Little endian
3.7.2 Networks Sequence Definition
网络字节顺序是TCP/IP 中规定的一种数据表示格式，它与具体的CPU 类型、操作系统等
无关，从而可以保证数据在不同主机之间传输时能够被正确解释。网络字节顺序采用big
endian（大端）排序方式。
如下以EthernetII 封装IPv4 报文数据格式为例：
Padding
payload
FCS
IHL TOS
Total Length Identification Flags TTL
LSB:0 1 2 3 4 5 6 MLB:7
Protocol
Header Checksum SIP DIP
Fragment Offset
DIP Options
DMAC SMAC
SMAC ETHTYPE=0x0800 Version
Figure 3.7-1 Ethernet II 封装IPv4 报文格式
SD5182HV100 Functional Specification Page 33 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
3.7.3 Big-Endian and Little-Endian in SD5182
3.7.3.1 LSW数据通路中（包括但不限于DP和PSA子系统）
在LSW数据通路中，都采用网络字节序，即大端模式。高位字节在总线的最左侧。
下面分别以128、32、8bit总线为例进行说明：
1）128bit总线情况下： 127:120 119:112 111:104 103:96 95:88 87:80 79:72 71:64 63:56 55:48 47:40 39:32 31:24 23:16 15:8 7:0
DMAC
SMAC
EthType
Ver
IHL
TOS
Total Length
Identification
Fs
Frag Offset
TTL
Protocol
Header Checksum
SIP
DIP
DIP
Option
Padding
Payload
Payload
Table 3.7-2 128bit位宽数据格式
2）32bit总线情况下： 31:24 23:16 15:8 7:0
DMAC
DMAC
SMAC
SMAC
EthType
Ver
IHL
TOS
Total Length
Identification
Table 3.7-3 32bit位宽数据格式
3）8bit总线情况下： 7:0
DMAC[47:40]
…
DMAC[7:0]
SMAC[47:40]
…
SMAC[7:0]
Eth Type[15:8]
Eth Type[7:0]
Ver
IHL
Table 3.7-4 8bit位宽数据格式
3.7.3.2 MEMP Memory
1）作为内置缓存cell使用时，RAM位宽为128bit，读写都是DP内部模块，按照上述网络序“128bit总线”的位序。
2）作为CPU内存使用时，读写都是ECS子系统。MEMP内部设计统一采用小端模式。
如果32bit MPI访问模式时：
SD5182HV100 Functional Specification Page 34 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
127:120 119:112 111:104 103:96 95:88 87:80 79:72 71:64 63:56 55:48 47:40 39:32 31:24 23:16 15:8 7:0
地址c
地址8
地址4
地址0
如果8bit MPI访问模式时： 127:120 119:112 111:104 103:96 95:88 87:80 79:72 71:64 63:56 55:48 47:40 39:32 31:24 23:16 15:8 7:0
地址f
地址e
地址d
地址c
地址b
地址a
地址9
地址8
地址7
地址6
地址5
地址4
地址3
地址2
地址1
地址0
3）作为内置缓存cell使用时，如果通过ECS子系统访问进行debug，需要注意查看到的数据进行位序转换，参考上述1）和2）。
3.7.3.3 AXI总线上
AXI总线上，低位地址数据放在低位位置，类似于小端模式，如下：
1）128bit总线情况下： 127:120 119:112 111:104 103:96 95:88 87:80 79:72 71:64 63:56 55:48 47:40 39:32 31:24 23:16 15:8 7:0
Addr15
Addr14
Addr13
Addr12
Addr11
Addr10
Addr9
Addr8
Addr7
Addr6
Addr5
Addr4
Addr3
Addr2
Addr1
Addr0
2）64bit总线情况下： 63:56 55:48 47:40 39:32 31:24 23:16 15:8 7:0
Addr7
Addr6
Addr5
Addr4
Addr3
Addr2
Addr1
Addr0
3.7.3.4 DDR Memory
1）如果读、写同是DP或者PSA，DP和PSA直接针对AXI总线进行操作，而且读写位宽一致，所以DP和PSA不受位序设置影响。
2）对于PIE或者WOE模块，涉及CPU/AP和DP之间的数据交互，需要在这两个模块进行大小端的适配处理。
3）如下是PIE模块目前的处理方式：
SD5182HV100 Functional Specification Page 35 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
AXI总线A7-
Byte
A6-
Byte
A5-
Byte
A4-
Byte
A3-
Byte
A2-
Byte
A1-
Byte
A0-
Byte
63 0
DDR内数据
PIE-IPS接口
描述符Frame Data
DT
E
X
T
Rsvd
[10:0] LEN[15:0]
63 0
PTR[31:0]
Pkt_info[63:0]
LEN
[7:0]
LEN
[15:8]
PTR
[7:0]
PTR
[15:8]
PTR
[23:16]
PTR
[31:24]
A0 A1 A2 A3 A4 A5 A6 A7
rsvd
[7:0]
D+E+r
A7-
Byte
A6-
Byte
A5-
Byte
A4-
Byte
A3-
Byte
A2-
Byte
A1-
Byte
A0-
Byte
63 0
DMAC[47:0] SMAC[47:32]
DMAC
[47:40]
DMAC
[39:32]
DMAC
[15:8]
DMAC
[7:0]
SMAC
[47:40]
SMAC
[39:32]
A0 A1 A2 A3 A4 A5 A6 A7
DMAC
[31:24]
DMAC
[23:16]
PIE数据转换
SMAC[31:0] EthType
V
er
I
H
L
TOS
63 0
软件按照小端模式写描述符，变量定义为64bit 软件按照大端模式写数据Payload，大端模式与变量定义位宽无关；
PIE不做字节序转换 PIE进行字节序转换，矫正AXI的顺序
Figure 3.7-2 PIE 模块大小端处理方式
PIE 接口上，CPU 默认以32bit 为单位的变量存取报文净荷。
继承历史项目的处理方式，描述符软件采用特殊的小端模式（标准的小端模式是在一个操
作数-32bit 内进行字节调序，而目前软件是同时做了2 个32bit 的调序）写，PIE 模块直接
从AXI 总线取数据，不做位序转换；数据帧软件采用大端模式，PIE 模块从AXI 获取数
据后，需要进行字节序调整，以便PIE-IPS 接口上的数据为大端序模式。
PIE 模块对描述符、数据Payload 是否进行字节序转换，可以通过配置切换。
如果描述符配置成大端模式、数据配置成小端模式，则在PIE 里面进行位序调整如下：
AXI总线A7-
Byte
A6-
Byte
A5-
Byte
A4-
Byte
A3-
Byte
A2-
Byte
A1-
Byte
A0-
Byte
63 0
DDR内数据
PIE-IPS接口
描述符Frame Data
DT
E
X
T
Rsvd
[10:0] PTR[31:0] LEN[15:0]
Pkt_info[63:0]
LEN
[7:0]
LEN
[15:8]
PTR
[7:0]
PTR
[15:8]
PTR
[23:16]
PTR
[31:24]
A0 A1 A2 A3 A4 A5 A6 A7
rsvd
[7:0]
D+E+r
A7-
Byte
A6-
Byte
A5-
Byte
A4-
Byte
A3-
Byte
A2-
Byte
A1-
Byte
A0-
Byte
63 0
DMAC[47:0] SMAC[47:32]
DMAC
[47:40]
DMAC
[39:32]
DMAC
[15:8]
DMAC
[7:0]
SMAC
[47:40]
SMAC
[39:32]
A0 A1 A2 A3 A4 A5 A6 A7
DMAC
[31:24]
DMAC
[23:16]
PIE数据转换
SMAC[31:0] EthType
V
er
I
H
L
TOS
63 0
如果软件按照大端模式写描述符，大端模式与变量定义位宽无关； 如果软件按照小端模式写数据Payload，变量定义为32bit
PIE进行32bit转换
63 0
PIE进行字节序转换，矫正AXI的顺序
Figure 3.7-3 PIE 模块大小端处理方式二
4）PSA 访问DDR，采用大端模式。
SD5182HV100 Functional Specification Page 36 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
SD5182HV100 Functional Specification Page 37 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4 INTERFACE BLOCKS DESCRIPTION
SD5182HV100 Functional Specification Page 38 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1 NNI INTERFACE
NNI出10模SerDes接口，内置GPON/NGPON/10GEPON/GE MAC。同一时刻仅可配置为一种模式工作。本章描述XPON MAC功能，GE MAC功能放在UNI接口章节合并描述。
4.1.1 GPON MAC
主要特点如下：
 符合ITU-T G.984.1/2/3/4标准，支持符合G.984协议的Ethernet over GEM封装。
 支持下行速率为2.488Gbit/s，上行速率为1.244Gbit/s。
 支持16个TCONT，128个GEMPORT。
 支持双向FEC，支持RS（255，239），RS(255，223)的FEC编解码方式。
 支持G.984标准的AES128（Advanced Encryption Standard）解密功能。
 支持SBA（Static Bandwidth assign）/DBA（Dynamic Bandwidth assign）带宽分配，提高带宽利用率。
 支持符合G.984标准的PLOAM、嵌入式OAM、OMCI的处理。
 支持报文PRBS产生和校验功能。
 支持同步以太网功能。
 支持Dying-gasp。
 支持TYPE B，支持快速倒换。
 支持流氓ONU检测。
 支持GPON节能。
4.1.1.1 GMAC下行处理流程
下行处理按照协议定义，帧格式如下：
SD5182HV100 Functional Specification Page 39 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure 4.1-1 GMAC下行协议结构
接收SerDes恢复的码流和时钟，开始对数据进行定帧，定帧使用下行帧中PSBd中的PSync域进行， PSync域包括4个byte的固定码型（0xB6AB 31E0）。定帧时，逻辑内部要维护定帧状态机，如0所示，只有在Sync状态下帧数据才会被继续解析送到后续处理模块，否则帧数据将被直接丢弃。
Figure 4.1-2 GMAC下行定帧状态机
完成定帧后，将解扰后的数据送给下行FEC模块完成FEC解码。FEC解码按照下图完成RS(255,239)的解码校验，完成后将多个239byte的Codeword重新拼接恢复出GTC帧，送给下行GTC成帧子层。
Figure 4.1-3 下行FEC处理结构图
SD5182HV100 Functional Specification Page 40 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
下行GTC成帧子层的主要进行BIP校验，提取PLOAM、HLEND和Bwmap域。BWmap提取后通过查询AllocID表项进行过滤，得到本地的带宽授权信息后，转交给上行方向处理。PLOAM提取后直接交给下行PLOAM模块处理。
下行GTC Payload为完整的GEM业务，如下图所示：
Figure 4.1-4 下行GTC Payload结构图
通过GEM Header的校验对每个GEM帧进行定界，维护GEM帧的定帧状态机，根据状态机的状态输出Lcdg等告警信息，状态机可以软件实时查询。对GEM Header的各个域进行提取，通过提取的Port-ID查询下行GEMPORT表项，对非本地的报文进行过滤，对本地的报文还要获取基本业务类型（OMCI、单播、组播、加密属性等）。对于需要解密的业务类型，将解密后的数据按照业务类型分发到各个处理模块，对于需要重组的报文添加标识送交给业务模块进行重组。
GMAC下行支持两个完整的GEM重组通道，支持不超过两条GEM切片交织序列，遵循ITU-T G.984.3协议要求。两个GEM重组通道用rsm_id＝0和1标识，非交织切片情况下，DS GEM数据从0通道输出。
切片重组通过pti和portid两个信息判断：若通道0正在重组状态，下一个DS GEM与通道0的portid不一致，则后续DS GEM从通道1输出或重组；处于重组状态的通道收到pti为1且portid相同的GEM数据时，切换到正常状态；如果处于重组状态的通道超过配置时间阈值，则强制释放重组通道。
GMAC内部没有GEM帧重组缓存，不缓存整帧数据，仅实现切片数据的字节对齐、FCS校验和剥离功能。
4.1.1.2 GMAC上行处理流程
上行处理按照协议定义，帧格式如下：
SD5182HV100 Functional Specification Page 41 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure Figure Figure Figure Figure 4.14.14.1-5 上行 burst burst burst结构图 结构图 结构图
业务帧通过业务处理之后，会将GEMPORT信息预先映射好，通过sop数据结构和原始数据帧一起输入给上行GEM处理模块。上行GEM模块接收来自上行GTC成帧子层模块对应的TCONT带宽请求，并向业务模块提出数据请求。在原始数据帧到来后，根据帧长和带宽大小对数据包进行切片，并对切片后的报文进行GEM封装。最后将封装后的报文送交给上行GTC成帧子层模块。对于切片后剩余无法发送的报文残留数据，需要进行存储管理，在下一个上行帧中优先发送。支持对最长帧切片进行配置限制。
如果有OMCI数据要发送，则先调度OMCI数据，OMCI处理后面章节详细描述。如果在有带宽但是没有SDU帧数据的情况下，还需要完成GEM IDLE帧的生成和发送。
上行GTC成帧模块接收来自上行GEM模块切片封装好的GEM帧。将各个GEM帧拼接成GTC payload，并向DBRu模块申请相关TCONT的DBRu计数器值，并对DBRu进行计算。此外，上行 burst_header 和上行PLOAM也需要通过us_oam模块请求获得，完成整个成帧的过程。若多TCONT分配满足粘联情况，还需要将各个TCONT数据进行粘联发送然后按burst数据进行上行的FEC编码工作，生成最终的上行帧数据。
SD5182HV100 Functional Specification Page 42 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-6 上行 FECFECFEC结构图 结构图 结构图
最后就是通过各个TCONT的BWMAP，解析各个Allocation，并完成对Allocation的发光控制。实现上行GTC帧数据加扰，加扰开关可配置，添加前导码和定界符。完成上行发光控制，发光扩展和延时可配置，支持非发光区间发送数据模式（固定或随机）和pattern可配置；支持发送数据bit滑动，滑动范围为0~7bit。
4.1.1.3 GMAC OMCI
OMCI发送通道实现OMCI数据的缓存、CRC计算和插入，配置流程：
1. 读取发送通道剩余缓存大小寄存器，若剩余空间足够，进行下一步操作；
2. 配置OMCI PLI/PORTID/PTI头信息寄存器；
3. 置位头信息寄存器配置完成寄存器（OMCI_TX_RDY）；
4. 写入OMCI报文，根据配置，CRC可选择逻辑实现或软件实现；
5. 完成一个OMCI报文的写入后，上报完成中断，并统计OMCI包数。
OMCI接收通道实现OMCI数据的重组、CRC校验、缓存，配置流程：
1. 逻辑接收OMCI报文，同步进行重组和CRC校验；
2. 缓存收到的OMCI报文；
3. 收到一个完整的OMCI报文，上报接收中断，并置位OMCI接收数据有效标志（OMCI_RX_RDY）；
4. CPU收到中断或检测到OMCI_RX_RDY信号，可以从缓存中读取OMCI报文。
SD5182HV100 Functional Specification Page 43 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1.1.4 GMAC PLOAM
PLOAM发送配置流程：
1. CPU配置PLOAM发送消息ID、消息内容、发送次数寄存器；
2. 配置PLOAM发送RDY寄存器；
3. GMAC检测到BWMAP中要求发送PLOAM消息的指示，就发送一次PLOAM消息，发送内容为配置值，同步进行CRC计算和插入；若PLOAM发送RDY无效，则发送NO MESSAGE消息；
4. 发送次数等于配置的次数后，逻辑清除PLOAM发送RDY寄存器。
PLOAM接收配置流程：
1. 逻辑收到PLOAM消息，进行本地过滤和CRC校验，若通过检测则缓存PLOAM消息；
2. 若PLOAM缓存非空，逻辑从缓存内读出消息赋值给PLOAM接收寄存器，同时置位接收有效标志寄存器（RDY）；
3. CPU检测到接收标志有效，读取PLOAM接收寄存器，同时清除接收有效标志寄存器。
4.1.1.5 GMAC Flush
GMAC 内无数据缓存，Flush功能仅对TCONT的残留信息进行清除，完全由EPS_PON控制。
4.1.1.6 Table
4.1.1.6.1 GEM_INDEX索引表 表格名称
GEM_INDEX 起始地址
N/A 地址范围
N/A 表项数目
4096 每项宽度
8bits 寻址方式
直接访问，初始地址为0x08000，表项行间偏移地址间隔为4（以Port ID×4为索引地址）
Table Table Table Table Table Table 4.14.14.1-1 GEM_INDEXGEM_INDEXGEM_INDEXGEM_INDEX GEM_INDEXGEM_INDEXGEM_INDEXGEM_INDEX索引表 Field Width Type Description Reset
vld
[7]
RW
指示该gem_port是否需要统计
0x0
addr
[6:0]
RW
对应GEM统计计数器存放的地址
0x0
SD5182HV100 Functional Specification Page 44 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Table Table Table Table Table Table 4.1 -2 GEM_INDEXGEM_INDEXGEM_INDEXGEM_INDEX GEM_INDEXGEM_INDEXGEM_INDEXGEM_INDEX索引表 表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构
4.1.1.6.2 GEM_PORT统计计数器 表格名称
GEM_TBL 起始地址
N/A 地址范围
N/A 表项数目
128 每项宽度
128bits 寻址方式
直接访问，上、下行GEMPORT统计表项初始地址分别为0x0C800和0x0C000，表项行间偏移地址间隔为16（4bit），偏移地址0/4/8/12分别对应[31：0]/[63:32]/[95:64]/[127:96]数据。 读写操作
写操作：按先后顺序分别写偏移地址12、8、4和0；
读操作：按先后顺序分别读偏移地址0、4、8和12。
Table Table Table Table Table Table 4.14.14.1-3 GEM_PORTGEM_PORTGEM_PORTGEM_PORTGEM_PORTGEM_PORTGEM_PORTGEM_PORT统计数器 统计数器 统计数器 统计数器 统计数器
Field Width Type Description Reset
byte_cnt
[127:76]
RW
字节统计计数器
0x0
gem_cnt
[75:38]
RW
GEM帧统计计数器
0x0
frm_cnt
[37:0]
RW
以太帧计数器
0x0
SD5182HV100 Functional Specification Page 45 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Table Table Table Table Table Table 4.14.14.1-4 GEM_PORTGEM_PORTGEM_PORTGEM_PORTGEM_PORTGEM_PORTGEM_PORTGEM_PORT统计数器 统计数器 统计数器 统计数器 统计数器 表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构
4.1.1.6.3 BURST_STAT 表格名称
BURST_STAT 起始地址
N/A 地址范围
N/A 表项数目
256 每项宽度
8bits 寻址方式
直接访问，初始地址为0x10400，表项行间偏移地址间隔为4
Table Table Table Table Table Table 4.14.14.1-5 BURST_STATBURST_STATBURST_STATBURST_STATBURST_STATBURST_STATBURST_STATBURST_STATBURST_STATBURST_STAT
Field Width Type Description Reset
burst_data
[7:0]
RW
（1）存储抓取的上行burst数据，用于调试功能
（2）存储用于流氓ONU检测需要发送的配置数据
0x0
Table Table Table Table Table Table 4.14.14.1-6 BURST_STATBURST_STATBURST_STATBURST_STATBURST_STATBURST_STATBURST_STATBURST_STATBURST_STATBURST_STAT表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构
SD5182HV100 Functional Specification Page 46 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1.1.6.4 OMCI_TBL
Table Table Table Table Table Table 4.14.14.1-7 OMCI_TBLOMCI_TBLOMCI_TBLOMCI_TBLOMCI_TBL OMCI_TBLOMCI_TBL 表格名称
OMCI TBL 起始地址
N/A 地址范围
N/A 表项数目
上行为1024，下行为768 每项宽度
32bits 寻址方式
直接访问(头回写FIFO)，上行OMCI访问地址为0x51000，下行OMCI访问地址为0x51800
Field Width Type Description Reset
head
[31:0]
RW
head[31:20]：pli； head[19:8]：portid；head[7:5]：pti，其他保留
0x0
data
31:0
RW
Omci接收报文数据，包括CRC，data域包括pli字节
0x0
Table Table Table Table Table Table 4.14.14.1-8 OMCI_TBLOMCI_TBLOMCI_TBLOMCI_TBLOMCI_TBL OMCI_TBLOMCI_TBL表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构
SD5182HV100 Functional Specification Page 47 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1.1.6.5 RAM_BWMAP 表格名称
RAM_BWMAP 起始地址
N/A 地址范围
N/A 表项数目
512 每项宽度
86bits 寻址方式
直接访问，初始地址为0x2C000，表项行间偏移地址间隔为16，偏移地址0/4/8分别对应[31：0]/[57:32]/ ]/[95:64]数据，其他无效。 读写操作
写操作：按先后顺序分别写偏移地址8、4和0；
读操作：按先后顺序分别读偏移地址0、4和8。
Table Table Table Table Table Table 4.14.14.1-9 RAM_BWMAPRAM_BWMAPRAM_BWMAPRAM_BWMAPRAM_BWMAPRAM_BWMAPRAM_BWMAPRAM_BWMAPRAM_BWMAP
Description
BWMAP INFO
{SFC[15:0], 4’b0, sof，eof，alloc_id[11:0]，flag[11:0]，start_time[15:0]，stop_time[15:0],crc[7:0]}
BURST INFO
{SFC[15:0],36’b0,sof，eof，otdr，start_time[15:0]，stop_time[15:0]}
TCONT INFO
{SFC[15:0],38’b0,tcont[7:0]，sof，eof，sob，eob，fec，rdi，ploam，dbru[1:0]，tcont_bw[14:0]}
US/DS PLOAM INFO
SFC[15:0],36’b0,
sop
eop
{onu_id，msg_id，data1，data2}/{data3，data4，data5，data6}/
{data7，data8，data9，data10}/{CRC，reserved}
DBRU INFO
{ SFC[15:0]，44’b0，tcont[7:0]，dbru_mod[1:0]，dbru_data[15:0]
DGEM DATA
SFC[15:0],36’b0
vld
sop
{pri_en，aes，pti，pli[11:0]，port_id[11:0]，type[1:0]，pri[2:0]}/gem_data
BWMAP ERROR DATA
{SFC[15:0], cap_type[1:0],err_type[3:0],bwmap[63:0]}
PLOAM ERROR DATA
SD5182HV100 Functional Specification Page 48 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Description
{SFC[15:0], cap_type[1:0],3’b0,err_type,ploam[63:0]}
GEM ERROR DATA
{SFC[15:0], cap_type[1:0],26’b0,err_type[1:0],gem_header[39:0]}
Table Table Table Table Table Table 4.14.14.1-10 RAM_BWMAPRAM_BWMAPRAM_BWMAPRAM_BWMAPRAM_BWMAPRAM_BWMAPRAM_BWMAPRAM_BWMAPRAM_BWMAP表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构
4.1.1.6.6 RAM_ALLOC 表格名称
RAM_ALLOC 起始地址
N/A 地址范围
N/A 表项数目
65 每项宽度
13bits 寻址方式
直接访问，初始地址为0x28000，表项行间偏移地址间隔为4（以Alloc ID×4为索引地址）
Table Table Table Table Table Table 4.14.14.1-11 RAM_ALLOCRAM_ALLOCRAM_ALLOCRAM_ALLOCRAM_ALLOCRAM_ALLOCRAM_ALLOCRAM_ALLOCRAM_ALLOC
Field Width Type Description Reset
vld
[12]
RW
表项有效指示
0x0
Alloc_id
[11:0]
RW
本地的Alloc ID
0x0
Table Table Table Table Table Table 4.14.14.1-12 RAM_ALLOCRAM_ALLOCRAM_ALLOCRAM_ALLOCRAM_ALLOCRAM_ALLOCRAM_ALLOCRAM_ALLOCRAM_ALLOC表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构
该表项一共33深度，采用寄存器搭建，每一行表示属于本地的alloc_id号以及使能位，每一行映射成固定的tcont号，如第1行（地址0x28000），固定映射的tcont号等于0x0；第2行（地址0x28004），固定映射的tcont号等于0x1；第64行（地址0x280FC），固定映射的tcont号等于0x63；第65行（地址0x28100），固定映射的tcont号等于0x80（OMCI独享）。
SD5182HV100 Functional Specification Page 49 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1.1.6.7 RAM_PORTID 表格名称
RAM_PORTID 起始地址
N/A 地址范围
N/A 表项数目
4096 每项宽度
7bits 寻址方式
直接访问，初始地址为0x48000，表项行间偏移地址间隔为4（以Port ID×4为索引地址）
Table Table Table Table Table Table 4.14.14.1-13 RAM_PORTIDRAM_PORTIDRAM_PORTIDRAM_PORTIDRAM_PORTIDRAM_PORTIDRAM_PORTIDRAM_PORTIDRAM_PORTIDRAM_PORTID
6 5 4:3 2:0 DESCRIPTION PRI_EN AES TYPE PRI
pri_en
1：加密；0：不加密
0
0
3’bxxx
非本地PORTID
0
1
OMCI
1
0
pri remarking，取值0~7
非组播以太
1
1
组播
Table Table Table Table Table Table 4.14.14.1-14 RAM_PORTIDRAM_PORTIDRAM_PORTIDRAM_PORTIDRAM_PORTIDRAM_PORTIDRAM_PORTIDRAM_PORTIDRAM_PORTIDRAM_PORTID表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构
4.1.1.7 运维特性
4.1.1.7.1 GMAC OTDR诊断
GMAC OTDR诊断启动前需配置一组寄存器：
 OTDROTDROTDROTDR使能（ 使能（ 使能（ 2bit 2bit2bit，分别对应重调制或专用窗口） ，分别对应重调制或专用窗口） ，分别对应重调制或专用窗口） ，分别对应重调制或专用窗口） ，分别对应重调制或专用窗口） ，分别对应重调制或专用窗口） ，分别对应重调制或专用窗口） ，分别对应重调制或专用窗口） ，分别对应重调制或专用窗口） ，分别对应重调制或专用窗口） ，分别对应重调制或专用窗口） ，分别对应重调制或专用窗口） ，分别对应重调制或专用窗口） ，分别对应重调制或专用窗口） 。
 重调制窗口门限 重调制窗口门限 重调制窗口门限 重调制窗口门限 重调制窗口门限 重调制窗口门限 重调制窗口门限 。
 TriggerTrigger Trigger TriggerTrigger触发信号脉宽 触发信号脉宽 触发信号脉宽 触发信号脉宽 触发信号脉宽 触发信号脉宽 。
 相对于带宽起始时间的延配置寄存器 相对于带宽起始时间的延配置寄存器 相对于带宽起始时间的延配置寄存器 相对于带宽起始时间的延配置寄存器 相对于带宽起始时间的延配置寄存器 相对于带宽起始时间的延配置寄存器 相对于带宽起始时间的延配置寄存器 相对于带宽起始时间的延配置寄存器 相对于带宽起始时间的延配置寄存器 相对于带宽起始时间的延配置寄存器 相对于带宽起始时间的延配置寄存器 相对于带宽起始时间的延配置寄存器 相对于带宽起始时间的延配置寄存器 相对于带宽起始时间的延配置寄存器 相对于带宽起始时间的延配置寄存器 相对于带宽起始时间的延配置寄存器 相对于带宽起始时间的延配置寄存器 。
支持“OTDR重调制窗口”和“OTDR专用窗口”两种诊断模式：
 “OTDR “OTDR “OTDR “OTDR “OTDR 重调制窗口”：只要 重调制窗口”：只要 重调制窗口”：只要 重调制窗口”：只要 重调制窗口”：只要 重调制窗口”：只要 重调制窗口”：只要 重调制窗口”：只要 重调制窗口”：只要 ONU 上配置“ 上配置“ 上配置“ 上配置“ OTDROTDROTDROTDR测试使能”，并且收到的 测试使能”，并且收到的 测试使能”，并且收到的 测试使能”，并且收到的 测试使能”，并且收到的 测试使能”，并且收到的 测试使能”，并且收到的 测试使能”，并且收到的 测试使能”，并且收到的 测试使能”，并且收到的 测试使能”，并且收到的 Grant lengthGrant length Grant length Grant length Grant lengthGrant lengthGrant lengthGrant lengthGrant length（带宽）大于 （带宽）大于 （带宽）大于 （带宽）大于 （带宽）大于 （带宽）大于 ONU 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 上软件配置的“重调制长度门限”（比如超过 100us 的上行窗口才进重调制测试），那么 的上行窗口才进重调制测试），那么 的上行窗口才进重调制测试），那么 的上行窗口才进重调制测试），那么 的上行窗口才进重调制测试），那么 的上行窗口才进重调制测试），那么 的上行窗口才进重调制测试），那么 的上行窗口才进重调制测试），那么 的上行窗口才进重调制测试），那么 的上行窗口才进重调制测试），那么 的上行窗口才进重调制测试），那么 的上行窗口才进重调制测试），那么 的上行窗口才进重调制测试），那么 的上行窗口才进重调制测试），那么 的上行窗口才进重调制测试），那么 的上行窗口才进重调制测试），那么 的上行窗口才进重调制测试），那么 xPON MACxPON MAC xPON MAC xPON MACxPON MAC就在这个 就在这个 就在这个 就在这个 Grant/BWmapGrant/BWmap Grant/BWmap Grant/BWmapGrant/BWmapGrant/BWmapGrant/BWmapGrant/BWmap 起始时输出“ 起始时输出“ 起始时输出“ 起始时输出“ 起始时输出“ 起始时输出“ OT DR 测试触发信号”给光模块，同时在这个 测试触发信号”给光模块，同时在这个 测试触发信号”给光模块，同时在这个 测试触发信号”给光模块，同时在这个 测试触发信号”给光模块，同时在这个 测试触发信号”给光模块，同时在这个 测试触发信号”给光模块，同时在这个 测试触发信号”给光模块，同时在这个 测试触发信号”给光模块，同时在这个 测试触发信号”给光模块，同时在这个 测试触发信号”给光模块，同时在这个 测试触发信号”给光模块，同时在这个 测试触发信号”给光模块，同时在这个 测试触发信号”给光模块，同时在这个 测试触发信号”给光模块，同时在这个 测试触发信号”给光模块，同时在这个 测试触发信号”给光模块，同时在这个 Grant/BWmapGrant/BWmap Grant/BWmap Grant/BWmapGrant/BWmapGrant/BWmapGrant/BWmapGrant/BWmap 中正常发送上行业务，输出 中正常发送上行业务，输出 中正常发送上行业务，输出 中正常发送上行业务，输出 中正常发送上行业务，输出 中正常发送上行业务，输出 中正常发送上行业务，输出 中正常发送上行业务，输出 中正常发送上行业务，输出 中正常发送上行业务，输出 中正常发送上行业务，输出 中正常发送上行业务，输出 中正常发送上行业务，输出 中正常发送上行业务，输出 tx_entx_entx_entx_entx_en，就跟正常、普通的 ，就跟正常、普通的 ，就跟正常、普通的 ，就跟正常、普通的 ，就跟正常、普通的 ，就跟正常、普通的 ，就跟正常、普通的 ，就跟正常、普通的 ，就跟正常、普通的 BWmapBWmapBWmapBWmap 一样； 一样； 一样；
SD5182HV100 Functional Specification Page 50 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 “OTDR “OTDR “OTDR “OTDR “OTDR 专用窗口”的 专用窗口”的 专用窗口”的 专用窗口”的 专用窗口”的 专用窗口”的 Grant/BWmapGrant/BWmap Grant/BWmapGrant/BWmapGrant/BWmapGrant/BWmapGrant/BWmap 需要由 需要由 需要由 OLTOLTOLT进行标识、由 进行标识、由 进行标识、由 进行标识、由 进行标识、由 进行标识、由 ONU 进行识别， 进行识别， 进行识别， 进行识别， 进行识别， 然后 xPON MACxPON MAC xPON MACxPON MACxPON MACxPON MAC在这个 在这个 在这个 Grant/BWmapGrant/BWmap Grant/BWmapGrant/BWmapGrant/BWmapGrant/BWmapGrant/BWmap 起始时输出“ 起始时输出“ 起始时输出“ 起始时输出“ 起始时输出“ 起始时输出“ OTDROTDROTDROTDR测试触发信号”给 测试触发信号”给 测试触发信号”给 测试触发信号”给 测试触发信号”给 测试触发信号”给 测试触发信号”给 测试触发信号”给 光模块，同时在这个 光模块，同时在这个 光模块，同时在这个 光模块，同时在这个 光模块，同时在这个 光模块，同时在这个 光模块，同时在这个 光模块，同时在这个 光模块，同时在这个 Grant /BWmapGrant /BWmap Grant /BWmapGrant /BWmap Grant /BWmapGrant /BWmapGrant /BWmapGrant /BWmap 中不发送上行业务，输出 中不发送上行业务，输出 中不发送上行业务，输出 中不发送上行业务，输出 中不发送上行业务，输出 中不发送上行业务，输出 中不发送上行业务，输出 中不发送上行业务，输出 中不发送上行业务，输出 中不发送上行业务，输出 中不发送上行业务，输出 tx_entx_entx_entx_entx_en＝不发光 ＝不发光 ＝不发光 ＝不发光 （由光模块自己去控制 （由光模块自己去控制 （由光模块自己去控制 （由光模块自己去控制 （由光模块自己去控制 （由光模块自己去控制 （由光模块自己去控制 （由光模块自己去控制 （由光模块自己去控制 （由光模块自己去控制 OTDROTDROTDROTDR测试发光、自己去生成送 测试发光、自己去生成送 测试发光、自己去生成送 测试发光、自己去生成送 测试发光、自己去生成送 测试发光、自己去生成送 测试发光、自己去生成送 测试发光、自己去生成送 测试发光、自己去生成送 测试发光、自己去生成送 测试发光、自己去生成送 测试发光、自己去生成送 OTDR test patternOTDR test patternOTDR test patternOTDR test patternOTDR test patternOTDR test patternOTDR test patternOTDR test pattern OTDR test patternOTDR test pattern OTDR test patternOTDR test patternOTDR test patternOTDR test pattern）。
4.1.1.7.2 GMAC Rogue ONU exposure
Rogue ONU exposuree配置使能有效后，在上行方向“非有效发光区间”（没有分配上行带宽），周期性发送“固定序列”数据给Serdes。“固定序列”由软件构造并配置，存储在GMAC的表项中，表项深度为256，位宽8bit；若需要发送有效数据（正常上行数据），则停止“固定序列”的发送，待有效数据发送完成后，重新从表项地址0开始读取“固定序列”并发送。目前该功能已经放在pon_sds_if中实现，GMAC保留该功能。
4.1.1.7.3 Initialization
GMAC内部的表项的初始化由硬件复位信号的上升沿触发，所有表项初始化为0，表项完成初始化后输出初始化完成标志。
4.1.2 NGPON MAC
主要特点如下：
 支持下行9.95328Gbps，上行2.48832Gbps和9.95328Gbps速率可选择配置；
 下行支持基本的GTC定帧和GTC帧解析提取；
 上行支持基本的数据成帧调度，发光控制配合；
 上行支持16个T-CONT；
 支持每帧最多4个burst；
 支持双向FEC；
 支持上下行PLOAM处理和MIC校验；
 支持下行GEM定帧和GEM帧解析提取；
 支持全范围64K个GEM Port-ID过滤,本地最多支持512个GEM Port-ID；
 支持基于gemport双向AES-128加密；
 支持上行分片和下行重组（支持最多1个重组通道）；
 支持上下行OMCI的处理和MIC校验；
 支持变长OMCI报文（14字节～2040字节）；
 支持OMCI与业务共用TCONT；
 支持下行以太帧长度检查和FCS校验、剥离，支持Min/Max帧长过滤可配；
SD5182HV100 Functional Specification Page 51 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 支持DBRu上报；
 支持TypeB优化、OTDR、Rogue ONU Exposure等运维特性；
 支持基于最多256个GEM Port-ID的以太帧或GEM帧统计；
 支持基于TCONT的Flush功能。
4.1.2.1 NGPON MAC下行处理流程
NGPON MAC下行帧格式如下：
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-7 下行帧结构图 下行帧结构图 下行帧结构图 下行帧结构图 下行帧结构图 下行帧结构图
NGMAC下行方向的处理，按照上图协议规定的协议层次依次完成PHY适配子层、FS成帧子层、XGEM业务子层的处理。从光路接收物理层信号，进行各个层次的定帧、域解析提取。最终将解析提取的BWMAP、控制信息、Ploam、OMCI、业务帧送交到各个对应处理模块。
SD5182HV100 Functional Specification Page 52 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
下行PHY适配子层处理接收SerDes恢复的串行码流和时钟，开始对数据进行定帧，定帧使用下行帧中PSBd中的PSync域进行，如下图描述，PSync域包括8个byte的固定码型（0xC5E5 1840 FD59 BB49）。
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-8 PSBDPSBDPSBDPSBD结构图 结构图 结构图
定帧时，逻辑内部要维护定帧状态机，只有在Sync和Re-Sync状态下帧数据才会被继续解析送到后续处理模块，否则帧数据将被直接丢弃。
该状态机可以通过软件查询当前状态，状态从Re-Sync切换到Hunt时上报定帧失步中断（LOF），状态从Pre-Sync切换到Sync时上报定帧恢复中断。
SFC域除了用于下行帧定帧，还将要提取用于PON的时间同步，后面用专用章节描述。 OC Body51 bitsPIT8 bitsG.989.3_F10-3PON-ID32 bitsTOL11 bitsRE1 bitODN Class3 bitsAdministrative Label28 bitsReserved3 bitsDWLCH ID4 bitsReserved 6 bitsDS FEC1 bit
SD5182HV100 Functional Specification Page 53 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-9 下行同步状态机 下行同步状态机 下行同步状态机 下行同步状态机 下行同步状态机 下行同步状态机 下行同步状态机
完成定帧和SFC、PON OC BODY的提取后，将PHY适配子层的Payload送给下行FEC模块完成FEC解码，在G.989.3协议中，下行FEC解码是根据PSBd域的DS FEC bit进行开关；G.987.3协议模式，OC BODY域含义不同，其中下行FEC固定使能，但是需要支持私有模式，可配置下行FEC开启或关闭，在帧边界切换。协议规定FEC支持RS(248,216)模式，同时支持RS(248,232)私有模式，两种模式静态切换。
FEC解码按照下图完成RS(248,216)的解码校验，完成后将多个216byte的Codeword重新拼接恢复出GTC帧，送给下行FS成帧子层。
SD5182HV100 Functional Specification Page 54 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
FigurFigurFigurFigurFigure 4.14.14.1-10 下行 FECFECFEC结构图
4.1.2.1.1 下行GTC成帧子层处理
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-11 下行 FS 层结构图
下行GTC成帧子层的主要处理是提取FS Header里面的各个域并进行校验。主要是BWmap和PLOAM的提取，BWmap提取后通过查询AllocID表项进行过滤，得到本地的带宽授权信息后，转交给上行方向处理。BWMAP/PLOAM提取后分别交给下行BWMAP/PLOAM模块处理，后面章节再详细描述。与G987.3不同，G.989.3支持BIP域，需要兼容两种模式。
完成FS Header的各个域提取后，将FS Payload送给下行XGEM业务子层继续处理。
4.1.2.1.2 下行XGEM业务子层处理
SD5182HV100 Functional Specification Page 55 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-12 下行 GEMGEMGEM帧结构图
下行XGEM业务子层接收完整的XGTC Payload（如上图），并通过XGEM Header的校验对每个XGEM帧进行定界，维护XGEM帧的定帧状态机，根据状态机的状态输出Lcdg等告警信息，状态机可以软件实时查询。对HEC错误支持两种处理方式：当前FS帧剩余的Payload数据丢弃、GEM状态重新同步后继续处理当前帧剩余GEM帧数据。
XGEM Header的各个域：
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-13 GEM headerGEM headerGEM headerGEM headerGEM headerGEM headerGEM headerGEM headerGEM headerGEM header结构图
完成域提取后，通过提取的Port-ID查询下行GEMPORT表项，对非本地的报文进行过滤。对本地的报文还要获取基本业务类型（OMCI、单播、组播等）。
加密属性。通过对Key index的识别判断，对于需要解密的业务类型，通过Key index选取解密的密钥，并获取明文，输入AES128解密引擎进行解密。最终将解密后的数据按照业务类型分发到各个对应端口，对于需要重组的报文添加标识送交给业务模块进行重组。
OMCI下行模块的处理后续章节单独讲解。
SD5182HV100 Functional Specification Page 56 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1.2.2 NGMAC上行处理流程
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-14 上行帧结构图 上行帧结构图 上行帧结构图 上行帧结构图 上行帧结构图 上行帧结构图
SD5182HV100 Functional Specification Page 57 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1.2.2.1 上行XGEM业务子层的处理
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-15 上行切片示意图 上行切片示意图 上行切片示意图 上行切片示意图 上行切片示意图 上行切片示意图 上行切片示意图
业务帧通过业务处理之后，会将GEMPORT信息预先映射好，通过数据结构和原始数据帧一起输入给上行XGEM处理模块。
上行XGEM模块接收对应TCONT的带宽请求，并向业务模块提出数据请求。在原始数据帧到来后，根据帧长和带宽大小对数据包进行切片，并对切片后的报文进行XGEM封装，如果切片后报文不满足要求长度需要进行PADDING。最后将封装后的报文送交给上行FS成帧子层模块。对于切片后剩余无法发送的报文残留数据，需要进行存储管理，在下一个上行帧中优先发送。支持对最长帧切片进行配置限制。根据上行Port-id查AES加密表，对需要加密GEM帧的Payload同步进行AES加密。
如果有OMCI数据要发送，则先调度OMCI数据，OMCI处理后面章节详细描述。
在有带宽但是没有SDU帧数据的情况下，还需要完成XGEM IDLE帧的生成和发送。
处理上行XGEM帧的加密，包括加密计数器的获取和维护，密钥信息获取，根据加密指示完成报文的最终加密。
SD5182HV100 Functional Specification Page 58 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1.2.2.2 上行GTC成帧子层的处理
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-16 上行 FS burstFS burstFS burstFS burstFS burstFS burstFS burstFS burst结构图
上行FS成帧模块接收XGEM模块切片封装好的XGEM帧。将DBRU和XGEM帧拼接成FS Payload；DBRu基于TCONT进行获取和计算。
FS header的PLOAM通过上行PLOAM模块请求获得，加上ONU-ID和校验后产生最终的FS header；FS header、FS payload和生成的BIP校验位拼接成FS帧。
若多TCONT分配满足粘联情况，还需要将各个TCONT数据进行粘联发送。
支持Allocation跨上行帧头分配。
支持Dying GASP相关的启动和发送处理，Dying GASP消息可以软件预配置。
4.1.2.2.3 上行PHY适配子层的处理
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-17 上行 PSBUPSBUPSBUPSBU结构图
上行PHY适配子层模块完成对FS payload FEC编码工作，添加PSBu域。
支持4种模板的前导码和定界符生成；
SD5182HV100 Functional Specification Page 59 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
实现上行GTC帧数据加扰，加扰开关可配置；
针对FS层和PSBu进行发光控制；上行发光扩展和延时可配置，发光扩展范围支持0~15clk，发光延时范围支持0~31clk；
支持非发光区间发送数据模式（固定或随机）和pattern可配置；
支持发送数据按2.5G单位粒度（约0.4ns）滑动，滑动范围为0~15单位。
4.1.2.3 BWMAP处理
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-18 BWmapBWmapBWmapBWmapBWmap结构图
BWMAP处理支持本地AllocID过滤和合法性检查，对本地异常BWMAP进行告警、丢弃和保护，避免影响上行调度和发光控制。另外，BWMAP处理要满足协议规定的限制性要求，各限制条件阈值可配置。
G.989.3规定的两种速率模式对应GrantSize单位不同，2.5G和10G模式单位分别对应4Byte和16Byte。G.987.3协议差异点：StartTime和GrantSize位宽都为16bit，没有Reserved bit， GrantSize单位固定为4Byte。
4.1.2.4 OMCI处理
OMCI下行方向，接收来自下行XGEM的OMCI数据，重组在下行XGEM处理模块完成，支持直接透传模式（不重组，不进行MIC操作）。
支持对超长和超短OMCI的过滤，超长、超短门限可配置。
OMCI接收缓存空间为4kbyte，逻辑完成MIC校验后通过中断的方式通知软件。
OMCI上行方向，软件按整包写OMCI到缓存，逻辑进行MIC计算；是否做MIC校验可配置。
OMCI MIC计算引擎上下行复用；另该MIC计算引擎作为协处理器，可用于软件加速。
SD5182HV100 Functional Specification Page 60 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1.2.5 PLOAM处理
PLOAM接收方向先缓存数据，进行MIC计算（若配置为透传模式，不进行MIC校验），MIC校验错误对应PLOAM消息是否丢弃可配置。
支持单播PLOAM消息的PLOAM_IK是否采用Default IK可配置；对非Default IK的PLOAM消息可进行两次MIC校验，对应不同PLOAM_IK。
每个下行帧支持2个本地PLOAM消息处理能力，支持至少缓存8个PLOAM消息。
支持上行PLOAM消息发送，上行MIC域是否由逻辑计算可配置；PLOAM_IK可配置，支持两套PLOAM_IK；支持PLOAM消息发送次数可配置；
支持PLOAM消息发送和接收中断上报；
支持PLOAM消息相关统计，包括发送、接收、MIC校验错误、下行接收缓存溢出等。
4.1.2.6 FLUSH处理
Flush处理需要配合芯片内部的EPS_PON进行。软件配置Flush后，EPS_PON开始对对应Tcont通道的数据进行读取丢弃，并给MAC送出指示。上行XGEM模块将对应通道存储的帧切片信息直接丢弃。
4.1.2.7 Low Power接口
芯片的动态节能不需要做全芯片的深度节能方案，主要由软件控制实现，逻辑仅保留相关接口。节能状态机由软件维护，不考虑和PON节能相关联的CPU动态节能和其他部分的动态节能设计。
NGMAC内部，对节能实现的特性，包括以下：
 识别下行 识别下行 识别下行 识别下行 NGPONGPON 协议 Ploam 和 BWMAPBWMAPBWMAPBWMAPBWMAP的 FWIFWI 消息，输出唤醒指示信号。 消息，输出唤醒指示信号。 消息，输出唤醒指示信号。 消息，输出唤醒指示信号。 消息，输出唤醒指示信号。 消息，输出唤醒指示信号。 消息，输出唤醒指示信号。 消息，输出唤醒指示信号。 消息，输出唤醒指示信号。 消息，输出唤醒指示信号。 消息，输出唤醒指示信号。 消息，输出唤醒指示信号。
 接收上行 接收上行 接收上行 接收上行 SLEEP SLEEPSLEEPSLEEP信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下信号，指示在上行睡眠 期间不发光、调度数据；下期间屏蔽 期间屏蔽 期间屏蔽 期间屏蔽 LOS/LOFLOS/LOFLOS/LOF LOS/LOFLOS/LOFLOS/LOF检测。
4.1.2.8 时间同步
OLT采样下行方向报文的SFC及其对应的时间，OLT通过管理消息通道将采样信息下发给ONU，终端软件根据OLT下发的信息配置ONU触发的SFC和对应的刷新时间数值，当ONU接收到的SFC与配置匹配时，将软件配置时间刷新为本地时间，实现ONU本地时间与OLT时间同步，产生同步的1pps，并输出对应1pps时间数据。
NGPON模式下时间接口的功能框图如0所示。
SD5182HV100 Functional Specification Page 61 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
SerDes NGPON TIMESTAMP 模块
ICSS子系统
下行帧帧头信号
SuperCounter
命中信号
SuperCounter
命中中断信号
SuperCounter
配置
1pps输出有效
中断信号
同步TIME
配置寄存器
1pps
输出
TOD
1pps输出脉冲
GPON SerDes恢复线路时钟
Figure 4.1-19 时钟同步示意图
NGPON 模式下时间接口的时序如0 所示。
T1
T2
T5
T4
T3
T6
T7
OLT ONU
SuperCounter
TSOLT
SuperCounter
TSONU=TSONU+T1+T2+T3
PLOAM
TSOLT
TSONU
最远点－EQD
Figure 4.1-20 时间接口时序
如上图所示：
 T1：OLT 的发送光路处理时间。
 T2：OLT 到ONU 的光纤传输时间。
 T3：ONU 的接收光路处理时间。
 T4：ONU 处理报文的时间。
 T5：ONU 发送光路处理时间。
SD5182HV100 Functional Specification Page 62 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 T6 ：ONU 到 OLTOLTOLT的光纤传输时间。 的光纤传输时间。 的光纤传输时间。 的光纤传输时间。 的光纤传输时间。 的光纤传输时间。 的光纤传输时间。 的光纤传输时间。
 T7 ：OLTOLTOLT接收光路处理时间。 接收光路处理时间。 接收光路处理时间。 接收光路处理时间。 接收光路处理时间。 接收光路处理时间。 接收光路处理时间。 接收光路处理时间。 接收光路处理时间。
TSONU=TSOLT＋Delay，软件需要根据OLT发送的数据计算出延时Delay。
假设T1+T2+T3=T5+T6+T7时，Delay＝T1+T2+T3=(最远点–EQD–T4)/2。
4.1.2.9 Table
本章所描述表项，包括直接表项和间接表项。这些表项在寄存器列表文档中已经描述清楚了， 这里就不用重复描述，但这里要有个索引、指引、概述，在给用户提供了地图的同时，还可以再提供指路牌和指南针。
4.1.2.9.1 下行GEM PORT过滤表
表格名称
GEMPORT_FLT 起始地址
N/A 地址范围
0x05000~0x057FF 表项数目
512 每项宽度
16bits 寻址方式
直接访问
Table Table Table Table Table Table 4.14.14.1-15 GEMPORTGEMPORTGEMPORTGEMPORTGEMPORTGEMPORTGEMPORT索引表
表项数据结构 Field Width Type Description Reset
gemport
[15:0]
RW
需要匹配的16BIT GEMPORT
0xFFFF
Table Table Table Table Table Table 4.14.14.1-16 GEMPORTGEMPORTGEMPORTGEMPORTGEMPORTGEMPORTGEMPORT索引表 表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构
表项配置说明
下行GEMPORT过滤表采用ETCAM实现，复位或FLUSH初始值为0xFFFF，删除GEMPORT直接写对应地址为0xFFFF。
SD5182HV100 Functional Specification Page 63 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1.2.9.2 下行GEMPORT属性表 表格名称
GEMPORT_TYPE 起始地址
N/A 地址范围
0x04000~0x040FF 表项数目
64 每项宽度
16bits 寻址方式
直接寻址
Table Table Table Table Table Table 4.14.14.1-17 GEMPORT_TYPEGEMPORT_TYPEGEMPORT_TYPEGEMPORT_TYPEGEMPORT_TYPEGEMPORT_TYPEGEMPORT_TYPEGEMPORT_TYPEGEMPORT_TYPEGEMPORT_TYPEGEMPORT_TYPEGEMPORT_TYPE表基本描述 表基本描述 表基本描述 表基本描述 表基本描述
表项数据结构 type[1:0] Description
0
0
普通ETH
0
1
组播
1
0
OMCI
1
1
组播OMCI
Table Table Table Table Table Table 4.14.14.1-18 GEMPORT TYPEGEMPORT TYPEGEMPORT TYPEGEMPORT TYPEGEMPORT TYPEGEMPORT TYPEGEMPORT TYPEGEMPORT TYPEGEMPORT TYPEGEMPORT TYPEGEMPORT TYPEGEMPORT TYPE说明
表项配置说明
下行GEMPORT属性2bit表示，属性表每行16bit，对应8个GEMPORT属性，相邻两bit表示一个GEMPORT属性，表项首行对应关系：[15:14]—GEMPORT_INDEX0，[13:12]—GEMPORT_INDEX1…，[1:0]—GEMPORT_INDEX7；其他以此类推。
SD5182HV100 Functional Specification Page 64 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1.2.9.3 上行GEMPORT反查表 表格名称
GEMPORT_INV 起始地址
N/A 地址范围
0x05800~0x05FFF 表项数目
512 每项宽度
17bits 寻址方式
直接寻址
Table Table Table Table Table Table 4.14.14.1-19 GEMPORT_STAT_INDEXGEMPORT_STAT_INDEXGEMPORT_STAT_INDEXGEMPORT_STAT_INDEXGEMPORT_STAT_INDEXGEMPORT_STAT_INDEXGEMPORT_STAT_INDEXGEMPORT_STAT_INDEXGEMPORT_STAT_INDEXGEMPORT_STAT_INDEXGEMPORT_STAT_INDEXGEMPORT_STAT_INDEXGEMPORT_STAT_INDEXGEMPORT_STAT_INDEXGEMPORT_STAT_INDEXGEMPORT_STAT_INDEXGEMPORT_STAT_INDEXGEMPORT_STAT_INDEX表基本描述 表基本描述 表基本描述 表基本描述 表基本描述
表项数据结构 Field Width Type Description Reset
AES
16
R/W
AES加密使能
0x0
GEMPORT
15:0
R/W
上行GEMPORT
0x0
Table Table Table Table Table Table 4.14.14.1-20 GEMPORT_INVGEMPORT_INVGEMPORT_INVGEMPORT_INVGEMPORT_INVGEMPORT_INVGEMPORT_INVGEMPORT_INV GEMPORT_INVGEMPORT_INV表数据结构 说明
4.1.2.9.4 RXOMCI表项 表格名称
RXOMCI_TBL 起始地址
N/A 地址范围
0x06000~0x067FF 表项数目
512 每项宽度
32bits 寻址方式
直接访问
Table Table Table Table Table Table 4.14.14.1-21 RXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBL表基本描述 表基本描述 表基本描述 表基本描述 表基本描述
RX_OMCI与MPI接口数据格式： 31:25 24:16 15 14 13:0
sop
Rsvd
gem_port_index[8:0]
LF
err
Frm_len [13:0]
SFC[15:0]
key_idx
Rsvd
…
DATA
…
…
eop
MIC[31/23/15/7 :0]
SD5182HV100 Functional Specification Page 65 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Table Table Table Table Table Table 4.14.14.1-22 RXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBL表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构 Field Width Type Description Reset
gem_port_index
9
R
OMCI对应的GEMPORT INDEX
0x0
LF
1
R
尾片标识，用于CPU重组
0x0
err
1
R
指示MIC校验是否异常
0x0
Frm_len
14
R
OMCI帧长，当LF=0时，表示GEM帧帧长，取值范围14~2040字节
0x0
SFC
16
R
MAC收到OMCI报文时的SFC低16bit
0x0
key_idx
2
R
OMCI GEM帧AES解密KEY指示
0x0
MIC
64
R
接收到OMCI MIC域
0x0
Table Table Table Table Table Table 4.14.14.1-23 RXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBLRXOMCI_TBL表项数据说明 表项数据说明 表项数据说明 表项数据说明 表项数据说明 表项数据说明
4.1.2.9.5 TXOMCI表项 表格名称 TXOMCI_TBL
起始地址
N/A
地址范围
0x06800~0x06FFF
表项数目
512
每项宽度
32bits
寻址方式
直接访问
Table Table Table Table Table Table 4.14.14.1-24 TXOMCI_TBLTXOMCI_TBLTXOMCI_TBLTXOMCI_TBLTXOMCI_TBLTXOMCI_TBLTXOMCI_TBL TXOMCI_TBLTXOMCI_TBL表基本描述 表基本描述 表基本描述 表基本描述 表基本描述
TX_OMCI与MPI接口数据格式： 31:25 24:16 15 14 13:0
sop
Rsvd
gem_port_index[8:0]
LF
cpu_mic
Frm_len [13:0]
…
DATA
…
…
eop
MIC[31/23/15/7 :0]
Table Table Table Table Table Table 4.14.14.1-25 TXOMCI_TBLTXOMCI_TBLTXOMCI_TBLTXOMCI_TBLTXOMCI_TBLTXOMCI_TBLTXOMCI_TBL TXOMCI_TBLTXOMCI_TBL表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构 表项数据结构 Field Width Type Description Reset
SD5182HV100 Functional Specification Page 66 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
gem_port_index
9
W
OMCI对应的GEMPORT INDEX
0x0
LF
1
W
尾片标识，LF等于0，逻辑不进行MIC计算和替换。
0x0
cpu_mic
1
W
1：标识配置报文非OMCI，逻辑仅需要计算和反馈MIC 128bit计算结果。
0x0
Frm_len
14
W
OMCI帧长，当LF=0时，表示GEM帧帧长，取值范围14~2040字节。
0x0
MIC
64
W
CPU配置的MIC域。
0x0
Table Table Table Table Table Table 4.14.14.1-26 TXOMCI_TBLTXOMCI_TBLTXOMCI_TBLTXOMCI_TBLTXOMCI_TBLTXOMCI_TBLTXOMCI_TBL TXOMCI_TBLTXOMCI_TBL表项 数据说明 数据说明 数据说明 数据说明
4.1.2.9.6 GEMPORT统计表 表格名称
GEMPORT_STAT 起始地址
index索引为4’b0001(DS)/4’b0010(US) 地址范围
偏移地址范围0~255 表项数目
256（对应pid_index 0~255） 每项宽度
128bits 寻址方式
间接访问
Table Table Table Table Table Table 4.14.14.1-27 GEMPORTGEMPORTGEMPORTGEMPORTGEMPORTGEMPORTGEMPORT_STATISTICSTATISTICSTATISTICSTATISTICSTATISTICSTATISTICSTATISTICSTATISTICSTATISTIC _TABLE_TABLE_TABLE_TABLE_TABLE_TABLE表基本描述 表基本描述 表基本描述 表基本描述 表基本描述
注：分上下行两个统计表。 Field Width Type Description Reset
byte_cnt
52
R/W
上/下行字节数目
0x0
gem_cnt
38
R/W
上/下行GEM帧数目
0x0
frm_cnt
38
R/W
上/下行以太帧数目
0x0
Table Table Table Table Table Table 4.14.14.1-28 GEMPORTGEMPORTGEMPORTGEMPORTGEMPORTGEMPORTGEMPORT_STATISTICSTATISTICSTATISTICSTATISTICSTATISTICSTATISTICSTATISTICSTATISTICSTATISTIC _TABL_TABL_TABL_TABL_TABL表项数据说明 表项数据说明 表项数据说明 表项数据说明 表项数据说明 表项数据说明
SD5182HV100 Functional Specification Page 67 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1.2.9.7 DS_KEY_INDEX 查询表 表格名称
DS_KEY_INDEX 起始地址
index索引为4’b0100 地址范围
偏移地址范围0~7 表项数目
8 每项宽度
128bits 寻址方式
间接访问
Table Table Table Table Table Table 4.14.14.1-29 DS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEX DS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEX表基本描述 Field Width Type Description Reset
127:126
2
R/W
pid_idx=64*offset_addr+63的key_index
0x0
125:124
2
R/W
pid_idx=64*offset_addr+62的key_index
0x0
…
2
R/W
…
0x0
1:0
2
R/W
pid_idx=64*offset_addr的key_index
Table Table Table Table Table Table 4.14.14.1-30 DS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEX DS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEX表项数据说明 表项数据说明 表项数据说明 表项数据说明 表项数据说明 表项数据说明
4.1.2.9.8 PON_BYTE_STAT统计表 表格名称
PON_BYTE_STAT 起始地址
index索引为4’b0011 地址范围
偏移地址范围0~3 表项数目
4 每项宽度
64bits 寻址方式
间接访问
Table Table Table Table Table Table 4.14.14.1-31 DS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEX DS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEX表基本描述 Field Width Type Description Reset
offset_addr=3
64
R/W
上行指定portid eth 总字节统计（包括OMCI）
0x0
offset_addr=2
64
R/W
上行 eth 总字节统计
0x0
offset_addr=1
64
R/W
下行指定portid eth 总字节统计(包括OMCI)
0x0
SD5182HV100 Functional Specification Page 68 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Field Width Type Description Reset
offset_addr=0
64
R/W
下行 eth 总字节统计
0x0
Table Table Table Table Table Table 4.14.14.1-32 DS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEX DS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEXDS_KEY_INDEX表项数据说明 表项数据说明 表项数据说明 表项数据说明 表项数据说明 表项数据说明
4.1.2.9.9 DEBUG抓包表项 表格名称
NGMAC_DEBUG 起始地址
N/A 地址范围
0x07000~0x08FFC 表项数目
512 每项宽度
128bits 寻址方式
间接访问
Table Table Table Table Table Table 4.14.14.1-33 NGMAC_DEBUGNGMAC_DEBUGNGMAC_DEBUG NGMAC_DEBUGNGMAC_DEBUGNGMAC_DEBUGNGMAC_DEBUGNGMAC_DEBUGNGMAC_DEBUGNGMAC_DEBUG表基本描述 表基本描述 表基本描述 表基本描述 表基本描述 sop eop 127:0
XDGEM DEBUG
1
0
{ 61’b0，SFC[15:0] ,option[17:0],key_index[1:0], portid[15:0], lf,pli[13:0] }
0
x
gem_payload[127:0]
DS XPLOAM
x
x
{32’h0,SFC[15:0],14’b0,sop,eop,PLOAM_DATA[63:0]}
BWMAP(OLT) INFO
x
x
{32’h0,SFC[15:0],14’b0,sof,eof,alloc_id[13:0],dbru,ploamu,starttime[15:0],grant_size[15:0],fwi,burst_profile[1:0],hec[12:0]}
BURST INFO
x
x
{64’b0, SFC[15:0],8’b0, align_cnt[4:0],otdr, burst_profile[1:0], start_time[15:0], burst_grant[15:0]}
TCONT INFO
x
x
{ 64’b0,sfc[15:0], sob,eob, align_cnt[4:0], ploam, start_time[15:0], sob,eob, tcont_num[4:0], dbru ,grant_size[15:0]}
BURST DATA
x
x
{ 94’b0,sfc[15:0],sob,eob, burst_data[15:0] } sfc域对应上行SFC
DBRU INFO
x
x
{64’b0,sfc[15:0],11’b0,tcont_num[4:0],dbru[31:0]},注sfc为当前下行SFC
BWMAP ERROR DATA
SD5182HV100 Functional Specification Page 69 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
sop eop 127:0
x
x
{32’b0, sfc[15:0],cap_type[1:0],err_type[2:0],11’b0,bwmap_data[63:0]}
PLOAM ERROR DATA
x
x
{32’b0, sfc[15:0],cap_type[1:0],err_type[1:0],12’b0,ploam_data[63:0]}
GEM ERROR DATA
x
x
{32’b0, sfc[15:0],cap_type[1:0],err_type[2:0],11’b0,gem_data[63:0]}
Table Table Table Table Table Table 4.14.14.1-34 NGMAC_DEBUGNGMAC_DEBUGNGMAC_DEBUG NGMAC_DEBUGNGMAC_DEBUGNGMAC_DEBUGNGMAC_DEBUGNGMAC_DEBUGNGMAC_DEBUGNGMAC_DEBUG表项数据说明 表项数据说明 表项数据说明 表项数据说明 表项数据说明 表项数据说明
4.1.2.10 运维特性
4.1.2.10.1 TYPEC倒换
TYPEC为全保护场景，ONU侧主要由EPS_PON完成，NGMAC本身只需完成Flush等动作。
4.1.2.10.2 TypeB倒换优化
逻辑支持EQD更新消息的识别和处理，TypeB逻辑优化可配置，有效后逻辑独立完成EQD的更新；TypeB逻辑优化使能关闭，EQD消息由软件识别和处理。
4.1.2.10.3 OTDR
NGMAC支持两种OTDR模式：重调制窗口模式和专用窗口模式。
“OTDR重调制窗口”：只要ONU上配置“OTDR测试使能”，并且收到的Grant length（带宽）大于ONU上软件配置的“重调制长度门限”（比如超过100us的上行窗口才进行重调制测试），那么NGMAC就在这个Grant/BWmap起始时输出“OTDR测试触发信号”给光模块，同时在这个Grant/BWmap中正常发送上行业务，正常输出tx_en，就跟正常、普通的BWmap一样；
“OTDR专用窗口”的Grant/BWmap需要由OLT进行标识、由ONU进行识别，然后NGMAC在这个Grant/BWmap起始时输出“OTDR测试触发信号”给光模块，同时在这个Grant /BWmap中不发送上行业务，输出tx_en＝不发光（由光模块自己去控制OTDR测试发光、自己去生成发送OTDR test pattern）。
4.1.2.10.4 可测性
NGMAC支持多种可测试特性：
 支持下行特定 支持下行特定 支持下行特定 支持下行特定 支持下行特定 支持下行特定 PORTID PORTIDPORTIDPORTIDPORTID的统计，类别包括 的统计，类别包括 的统计，类别包括 的统计，类别包括 的统计，类别包括 的统计，类别包括 的统计，类别包括 的统计，类别包括 的统计，类别包括 的统计，类别包括 GEMGEMGEM帧总数、 切片帧总数、 切片帧总数、 切片帧总数、 切片帧总数、 切片帧总数、 切片帧总数、 切片AESAESAES有效 GEMGEMGEM统计；以太长度分段， 统计；以太长度分段， 统计；以太长度分段， 统计；以太长度分段， 统计；以太长度分段， 统计；以太长度分段， 统计；以太长度分段， 统计；以太长度分段， 统计；以太长度分段， 统计；以太长度分段， 统计；以太长度分段， 统计；以太长度分段， 64/65~1 64/65~164/65~1 64/65~164/65~127/128~255/256~511/512~1023/1024~1518/ 27/128~255/256~511/512~1023/1024~1518/27/128~255/256~511/512~1023/1024~1518/ 27/128~255/256~511/512~1023/1024~1518/ 27/128~255/256~511/512~1023/1024~1518/ 27/128~255/256~511/512~1023/1024~1518/ 27/128~255/256~511/512~1023/1024~1518/ 27/128~255/256~511/512~1023/1024~1518/ 27/128~255/256~511/512~1023/1024~1518/ 27/128~255/256~511/512~1023/1024~1518/ 27/128~255/256~511/512~1023/1024~1518/ 27/128~255/256~511/512~1023/1024~1518/27/128~255/256~511/512~1023/1024~1518/27/128~255/256~511/512~1023/1024~1518/ 27/128~255/256~511/512~1023/1024~1518/ 27/128~255/256~511/512~1023/1024~1518/27/128~255/256~511/512~1023/1024~1518/ 27/128~255/256~511/512~1023/1024~1518/ 27/128~255/256~511/512~1023/1024~1518/27/128~255/256~511/512~1023/1024~1518/ 27/128~255/256~511/512~1023/1024~1518/ 27/128~255/256~511/512~1023/1024~1518/小于 64/ 大于 1518 字节；
 支持上行特定 支持上行特定 支持上行特定 支持上行特定 支持上行特定 支持上行特定 portid portid portidportid的 GEMGEMGEM帧总数、 切片帧总数、 切片帧总数、 切片帧总数、 切片帧总数、 切片帧总数、 切片帧总数、 切片AESAESAES有效 GEMGEMGEM统计，以及 统计，以及 统计，以及 统计，以及 统计，以及 IDLEIDLEIDLEIDLE字节统计；以及太分段， 字节统计；以及太分段， 字节统计；以及太分段， 字节统计；以及太分段， 字节统计；以及太分段， 字节统计；以及太分段， 字节统计；以及太分段， 字节统计；以及太分段， 字节统计；以及太分段， 字节统计；以及太分段， 字节统计；以及太分段， 字节统计；以及太分段， 字节统计；以及太分段， 64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/64/65~127/128~255/256~511/512~1023/1024~1518/64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/64/65~127/128~255/256~511/512~1023/1024~1518/64/65~127/128~255/256~511/512~1023/1024~1518/64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/ 64/65~127/128~255/256~511/512~1023/1024~1518/小于 64/ 大于 1518 15181518字节； 字节； 字节；
SD5182HV100 Functional Specification Page 70 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 分别支持上下行 分别支持上下行 分别支持上下行 分别支持上下行 分别支持上下行 分别支持上下行 分别支持上下行 PON 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单； 口以太统计，支持总数、广播组和单；
 分别支持上下行 分别支持上下行 分别支持上下行 分别支持上下行 分别支持上下行 分别支持上下行 分别支持上下行 PON 口 GEMGEMGEM统计，支持 统计，支持 统计，支持 统计，支持 统计，支持 GEMGEMGEM帧总数、 切片帧总数、 切片帧总数、 切片帧总数、 切片帧总数、 切片帧总数、 切片帧总数、 切片AESAESAES有效 GEMGEMGEM统计；
 特定 TCONTTCONTTCONTTCONTTCONT带宽（ 带宽（ 带宽（ 1s ）统 计，共支持 计，共支持 计，共支持 计，共支持 计，共支持 8个特定 个特定 个特定 TCONTTCONTTCONTTCONTTCONT；
 DEBUGDEBUGDEBUGDEBUGDEBUG抓包功能，括上下行 抓包功能，括上下行 抓包功能，括上下行 抓包功能，括上下行 抓包功能，括上下行 抓包功能，括上下行 抓包功能，括上下行 抓包功能，括上下行 抓包功能，括上下行 抓包功能，括上下行 PLOAMPLOAMPLOAMPLOAMPLOAM消息， DBRUDBRUDBRUDBRU上报值和 上报值和 上报值和 上报值和 BWMAPBWMAPBWMAPBWMAPBWMAP信息； 信息； 信息；
 支持上行 支持上行 支持上行 支持上行 GTC/GEM HECGTC/GEM HECGTC/GEM HECGTC/GEM HECGTC/GEM HECGTC/GEM HECGTC/GEM HECGTC/GEM HEC GTC/GEM HECGTC/GEM HEC、BIPBIPBIP、DBRU CRCDBRU CRCDBRU CRCDBRU CRCDBRU CRC DBRU CRCDBRU CRC、PLOAM MICPLOAM MICPLOAM MICPLOAM MICPLOAM MICPLOAM MIC PLOAM MICPLOAM MIC域、 FECFECFEC码块插 码块插 码块插 错功能 。
4.1.2.11 Initialization
NGMAC内部的表项的初始化由硬件复位信号的上升沿触发，所有表项初始化为无效，表项完成初始化后输出初始化完成标志。
4.1.3 XEPON MAC
XEPON MAC支持EPON、10GEPON的MAC功能。
EPON主要特点如下：
 符合 802.3 802.3 802.3-2005 20052005和 CTC EPONCTC EPONCTC EPONCTC EPONCTC EPONCTC EPONCTC EPONCTC EPON设备技术要求。 设备技术要求。 设备技术要求。 设备技术要求。 设备技术要求。 设备技术要求。 设备技术要求。
 支持上下行对称 支持上下行对称 支持上下行对称 支持上下行对称 支持上下行对称 支持上下行对称 支持上下行对称 1Gbit/s1Gbit/s1Gbit/s 1Gbit/s1Gbit/s1Gbit/s速率。 速率。 速率。
 支持 8个 LLIDLLIDLLIDLLID，每个 LLIDLLIDLLID 有独立的 有独立的 有独立的 有独立的 MACMACMAC地址配置和发现注册过程。 地址配置和发现注册过程。 地址配置和发现注册过程。 地址配置和发现注册过程。 地址配置和发现注册过程。 地址配置和发现注册过程。 地址配置和发现注册过程。 地址配置和发现注册过程。 地址配置和发现注册过程。 地址配置和发现注册过程。 地址配置和发现注册过程。 地址配置和发现注册过程。
 支持双向 支持双向 支持双向 支持双向 FECFECFEC，可基于 ，可基于 ，可基于 ，可基于 ONUONUONU对上行编码和下解分别配置使能。 对上行编码和下解分别配置使能。 对上行编码和下解分别配置使能。 对上行编码和下解分别配置使能。 对上行编码和下解分别配置使能。 对上行编码和下解分别配置使能。 对上行编码和下解分别配置使能。 对上行编码和下解分别配置使能。 对上行编码和下解分别配置使能。 对上行编码和下解分别配置使能。 对上行编码和下解分别配置使能。 对上行编码和下解分别配置使能。 对上行编码和下解分别配置使能。 对上行编码和下解分别配置使能。 对上行编码和下解分别配置使能。 对上行编码和下解分别配置使能。 对上行编码和下解分别配置使能。
 支持下行三重搅动（ 支持下行三重搅动（ 支持下行三重搅动（ 支持下行三重搅动（ 支持下行三重搅动（ 支持下行三重搅动（ 支持下行三重搅动（ 支持下行三重搅动（ 支持下行三重搅动（ TripleTripleTripleTripleTripleTriple-ChurningChurning ChurningChurning ChurningChurning），可基于 ），可基于 ），可基于 ），可基于 ），可基于 LLIDLLIDLLID 配置和密钥交互。 配置和密钥交互。 配置和密钥交互。 配置和密钥交互。 配置和密钥交互。 配置和密钥交互。 配置和密钥交互。 配置和密钥交互。
 支持 AES128AES128AES128AES128 AES128（Advanced Encryption StandardAdvanced Encryption StandardAdvanced Encryption StandardAdvanced Encryption Standard Advanced Encryption StandardAdvanced Encryption StandardAdvanced Encryption StandardAdvanced Encryption StandardAdvanced Encryption Standard Advanced Encryption Standard Advanced Encryption StandardAdvanced Encryption StandardAdvanced Encryption StandardAdvanced Encryption StandardAdvanced Encryption Standard Advanced Encryption StandardAdvanced Encryption Standard Advanced Encryption StandardAdvanced Encryption StandardAdvanced Encryption Standard）解密功能。 ）解密功能。 ）解密功能。 ）解密功能。 ）解密功能。 ）解密功能。
 硬件处理 硬件处理 硬件处理 硬件处理 Grant/Grant/ Grant/生成 ReportReportReportReport Report，软件处理 ，软件处理 ，软件处理 ，软件处理 ，软件处理 Req/Reg/AckReq/Reg/AckReq/Reg/Ack Req/Reg/AckReq/Reg/AckReq/Reg/Ack Req/Reg/AckReq/Reg/Ack 完成注册过程。 完成注册过程。 完成注册过程。 完成注册过程。 完成注册过程。 完成注册过程。 完成注册过程。
 支持 CTCCTCCTC要求的 要求的 要求的 ReportReportReportReport Report功能，每个 功能，每个 功能，每个 功能，每个 功能，每个 LLIDLLIDLLIDLLID支持 8个队列报告和 个队列报告和 个队列报告和 个队列报告和 个队列报告和 个队列报告和 4个队 列集。 列集。 列集。
 支持基于 支持基于 支持基于 支持基于 LLIDLLIDLLIDLLID的 OAM Remote LoopbackOAM Remote LoopbackOAM Remote LoopbackOAM Remote Loopback OAM Remote LoopbackOAM Remote LoopbackOAM Remote LoopbackOAM Remote LoopbackOAM Remote LoopbackOAM Remote LoopbackOAM Remote LoopbackOAM Remote Loopback OAM Remote Loopback OAM Remote Loopback 功能。 功能。 功能。
 支持同步以太网功能。 支持同步以太网功能。 支持同步以太网功能。 支持同步以太网功能。 支持同步以太网功能。 支持同步以太网功能。 支持同步以太网功能。 支持同步以太网功能。 支持同步以太网功能。 支持同步以太网功能。
 支持 DyingDyingDyingDyingDying-gaspgasp gasp。
 支持 TYPE BTYPE BTYPE B TYPE BTYPE B，支持快速倒换。 ，支持快速倒换。 ，支持快速倒换。 ，支持快速倒换。 ，支持快速倒换。 ，支持快速倒换。 ，支持快速倒换。 ，支持快速倒换。
 支持流氓 支持流氓 支持流氓 支持流氓 ONU 检测。 检测。 检测。
 支持 EPONEPON 节能。 节能。 节能。
10G EPON主要特点如下：
 支持对称 和非支持对称 和非支持对称 和非支持对称 和非支持对称 和非支持对称 和非支持对称 和非支持对称 和非三种速率模式（下行 种速率模式（下行 种速率模式（下行 种速率模式（下行 种速率模式（下行 种速率模式（下行 种速率模式（下行 种速率模式（下行 10.3125G/ 10.3125G/10.3125G/ 10.3125G/ 10.3125G/10.3125G/上行 10.3125G 10.3125G10.3125G 10.3125G 10.3125G，或者下行 ，或者下行 ，或者下行 ，或者下行 ，或者下行 10 .3125G/ 3125G/ 3125G/3125G/上行 1.25G1.25G1.25G 1.25G，或者下行 ，或者下行 ，或者下行 ，或者下行 ，或者下行 10.3125G/ 10.3125G/10.3125G/ 10.3125G/ 10.3125G/10.3125G/上行 2.5G2.5G2.5G2.5G）；
 支持 16 个双向单播 个双向单播 个双向单播 个双向单播 个双向单播 LLIDLLIDLLIDLLID，16 个单向组播 个单向组播 个单向组播 个单向组播 个单向组播 LLIDLLIDLLIDLLID，1个下行广播 个下行广播 个下行广播 个下行广播 个下行广播 LLIDLLIDLLIDLLID，3个侦听 LLIDLLIDLLIDLLID；支持 广播 LLIDLLIDLLIDLLID可配置 ；
 下行支持 下行支持 下行支持 下行支持 64B/66B 64B/66B64B/66B64B/66B 64B/66B解码，上行支持 解码，上行支持 解码，上行支持 解码，上行支持 解码，上行支持 解码，上行支持 解码，上行支持 8B/10B(1G 8B/10B(1G8B/10B(1G 8B/10B(1G8B/10B(1G8B/10B(1G8B/10B(1G/2G/2G/2G)或者 64B/66B(10G) 64B/66B(10G)64B/66B(10G)64B/66B(10G) 64B/66B(10G)64B/66B(10G)64B/66B(10G) 64B/66B(10G)64B/66B(10G)编码 ；
SD5182HV100 Functional Specification Page 71 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 支持双向 支持双向 支持双向 支持双向 FECFECFEC。下行支持 。下行支持 。下行支持 。下行支持 。下行支持 RS(255,22RS(255,22 RS(255,22 RS(255,22 RS(255,22 3) 解码，可基于 解码，可基于 解码，可基于 解码，可基于 解码，可基于 解码，可基于 PON 口配置 口配置 口配置 FEC ON/OFFFEC ON/OFFFEC ON/OFFFEC ON/OFF FEC ON/OFFFEC ON/OFFFEC ON/OFFFEC ON/OFFFEC ON/OFF；
 上行 1G /2G/2G/2G模式支持 模式支持 模式支持 模式支持 RS(255,239)RS(255,239) RS(255,239)RS(255,239) RS(255,239)RS(255,239) RS(255,239)RS(255,239)编码，可基于 编码，可基于 编码，可基于 编码，可基于 编码，可基于 编码，可基于 LLIDLLIDLLID 配置 FEC ON/OFFFEC ON/OFFFEC ON/OFFFEC ON/OFF FEC ON/OFFFEC ON/OFFFEC ON/OFFFEC ON/OFFFEC ON/OFF；
 上行 10G 10G模式支持 模式支持 模式支持 模式支持 RS(255,223)RS(255,223) RS(255,223) RS(255,223)RS(255,223) RS(255,223)编码，可基于 编码，可基于 编码，可基于 编码，可基于 编码，可基于 编码，可基于 PON 口配置 口配置 口配置 FEC ON/OFFFEC ON/OFFFEC ON/OFFFEC ON/OFF FEC ON/OFFFEC ON/OFFFEC ON/OFFFEC ON/OFFFEC ON/OFF；
 支持下行解扰（ 支持下行解扰（ 支持下行解扰（ 支持下行解扰（ 支持下行解扰（ 支持下行解扰（ 支持下行解扰（ G(x)=G(x)= G(x)=1+X^39+58 1+X^39+581+X^39+581+X^39+58 1+X^39+581+X^39+581+X^39+581+X^39+58 ），上行 ），上行 ），上行 ），上行 10G 10G模式支持加扰，上行 模式支持加扰，上行 模式支持加扰，上行 模式支持加扰，上行 模式支持加扰，上行 模式支持加扰，上行 模式支持加扰，上行 模式支持加扰，上行 模式支持加扰，上行 1G /2G/2G/2G模式不支持加扰， 模式不支持加扰， 模式不支持加扰， 模式不支持加扰， 模式不支持加扰， 模式不支持加扰， 模式不支持加扰， 模式不支持加扰， 可分别配置下行解扰和上加开关； 可分别配置下行解扰和上加开关； 可分别配置下行解扰和上加开关； 可分别配置下行解扰和上加开关； 可分别配置下行解扰和上加开关； 可分别配置下行解扰和上加开关； 可分别配置下行解扰和上加开关； 可分别配置下行解扰和上加开关； 可分别配置下行解扰和上加开关； 可分别配置下行解扰和上加开关； 可分别配置下行解扰和上加开关； 可分别配置下行解扰和上加开关； 可分别配置下行解扰和上加开关； 可分别配置下行解扰和上加开关； 可分别配置下行解扰和上加开关； 可分别配置下行解扰和上加开关； 可分别配置下行解扰和上加开关；
 下行支持 下行支持 下行支持 下行支持 CTC TripleCTC TripleCTC TripleCTC TripleCTC TripleCTC Triple CTC TripleCTC TripleCTC Triple-ChurninChurnin ChurninChurnin Churnin和 CTR AESCTR AESCTR AESCTR AESCTR AESCTR AESCTR AES-128 解密；上行支持 解密；上行支持 解密；上行支持 解密；上行支持 解密；上行支持 解密；上行支持 解密；上行支持 CTR AESCTR AESCTR AESCTR AESCTR AESCTR AESCTR AES-128 加密 ；
 支持基于 支持基于 支持基于 支持基于 LLIDLLIDLLIDLLID上下行 独立的加密使能 独立的加密使能 独立的加密使能 独立的加密使能 独立的加密使能 独立的加密使能 独立的加密使能 /密钥配置和 密钥配置和 密钥配置和 密钥配置和 密钥配置和 OAMOAMOAM密钥交互 密钥交互 密钥交互 密钥交互 ；
 支持 CTCCTCCTC要求的多队列集 要求的多队列集 要求的多队列集 要求的多队列集 要求的多队列集 要求的多队列集 要求的多队列集 ReportReportReportReport Report功能，每个 功能，每个 功能，每个 功能，每个 功能，每个 LLIDLLIDLLIDLLID支持最多 支持最多 支持最多 支持最多 4个队列集报告 个队列集报告 个队列集报告 个队列集报告 个队列集报告 个队列集报告 ；
 支持基于 支持基于 支持基于 支持基于 LLIDLLIDLLIDLLID的 OAM Remote LoopbackOAM Remote LoopbackOAM Remote LoopbackOAM Remote Loopback OAM Remote LoopbackOAM Remote LoopbackOAM Remote LoopbackOAM Remote LoopbackOAM Remote LoopbackOAM Remote LoopbackOAM Remote LoopbackOAM Remote Loopback OAM Remote Loopback OAM Remote Loopback 功能 ；
 支持 CTC OAMCTC OAMCTC OAMCTC OAM CTC OAMCTC OAM扩展，支持独立的 扩展，支持独立的 扩展，支持独立的 扩展，支持独立的 扩展，支持独立的 扩展，支持独立的 扩展，支持独立的 扩展，支持独立的 OAMOAMOAM收发通路，上行支持帧长 收发通路，上行支持帧长 收发通路，上行支持帧长 收发通路，上行支持帧长 收发通路，上行支持帧长 收发通路，上行支持帧长 收发通路，上行支持帧长 收发通路，上行支持帧长 收发通路，上行支持帧长 收发通路，上行支持帧长 收发通路，上行支持帧长 22~1518 22~151822~1518 22~1518 的 OAMOAMOAM发送，下 发送，下 发送，下 发送，下 行支持帧长 行支持帧长 行支持帧长 行支持帧长 行支持帧长 64~1518 64~151864~1518 64~1518 帧长的接收； 帧长的接收； 帧长的接收； 帧长的接收； 帧长的接收； 帧长的接收；
 支持独立的 支持独立的 支持独立的 支持独立的 支持独立的 MPCPMPCPMPCPMPCP收发通道 收发通道 收发通道 收发通道 ；
 支持同步以太功能 支持同步以太功能 支持同步以太功能 支持同步以太功能 支持同步以太功能 支持同步以太功能 支持同步以太功能 支持同步以太功能 ；
 支持硬件自动发送 支持硬件自动发送 支持硬件自动发送 支持硬件自动发送 支持硬件自动发送 支持硬件自动发送 支持硬件自动发送 支持硬件自动发送 Dying GaspDying GaspDying GaspDying GaspDying Gasp Dying GaspDying GaspDying GaspDying Gasp报文 ；
 支持 OTDROTDROTDROTDR；
 支持低功耗 支持低功耗 支持低功耗 支持低功耗 支持低功耗 ；
 支持 JumboJumbo 帧（ 9.6KB 9.6KB9.6KB9.6KB）；
 支持私有 支持私有 支持私有 支持私有 GateGate Gate帧和 GrantGrant 功能 ；
 支持下行以太帧长度检查和 支持下行以太帧长度检查和 支持下行以太帧长度检查和 支持下行以太帧长度检查和 支持下行以太帧长度检查和 支持下行以太帧长度检查和 支持下行以太帧长度检查和 支持下行以太帧长度检查和 支持下行以太帧长度检查和 支持下行以太帧长度检查和 支持下行以太帧长度检查和 支持下行以太帧长度检查和 FCSFCSFCS校验、剥离，支持 校验、剥离，支持 校验、剥离，支持 校验、剥离，支持 校验、剥离，支持 校验、剥离，支持 校验、剥离，支持 校验、剥离，支持 Min/Max Min/Max Min/Max 帧长可配 帧长可配 帧长可配 帧长可配 (PAD (PAD (PAD (PAD 和 FCSFCSFCS剥离前的 剥离前的 剥离前的 剥离前的 长度 )；
 支持 LLIDLLIDLLIDLLID侦听处理 ；
 支持 Report/GateReport/GateReport/GateReport/Gate Report/GateReport/GateReport/GateReport/GateReport/GateReport/Gate报文捕获，支持密钥状态可查询 报文捕获，支持密钥状态可查询 报文捕获，支持密钥状态可查询 报文捕获，支持密钥状态可查询 报文捕获，支持密钥状态可查询 报文捕获，支持密钥状态可查询 报文捕获，支持密钥状态可查询 报文捕获，支持密钥状态可查询 报文捕获，支持密钥状态可查询 报文捕获，支持密钥状态可查询 报文捕获，支持密钥状态可查询 报文捕获，支持密钥状态可查询 报文捕获，支持密钥状态可查询 报文捕获，支持密钥状态可查询 。
4.1.3.1 概述
XEPON MAC包括EPON和10G EPON（10G对称/非对称/Lite三种模式），XEMAC结构概览如0所示：
注：后续文档中用XEMAC表示1G EPON和10G EPON共同的特性。对不同的特性，会具体说明是1G EPON的特性，还是10G EPON的特性。
SD5182HV100 Functional Specification Page 72 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
SerDes
XG_PCS
XEMAC
XG_RS
XG_MAC
IPS_PON EPS_PON
XGEMAC_MPI
66（10）
64 64 8
64 64 8
128(16) 128(16)
clk_xgemac_xgrx(10G模式使能),clk_xgemac_xgtx(XEPON对称使能)，clk_xgemac_rx，clk_xgemac_tx(公用部分)
clk_xgemac_1grx(1G模式使能)，clk_xgemac_1gtx(根据模式选择)
66（10）
8
8
128(16)
clk_xgemac_sys
EMAC_MPI
Gearbox(10G:64bit<->66bit; 1G:10bit bypass)
64（10） 64（10）
clk_xgemac_161
Figure 4.1-21 XEMAC 结构概览图
4.1.3.2 XEMAC OAM Path
XEMAC OAM 的功能主要用于终端和局端进行能力协商、时间同步、Keepalive、Dying
gasp、远端环回等功能。XEMAC 提供了分离的、独立的OAM Rx Path 和OAM Tx Path，
这样XEMAC OAM 帧就可以通过XEMAC MPI 接口直接由软件读写/收发了，有效保证
了XEMAC OAM 帧的QoS 特性，当然XEMAC OAM帧也可以和Data 帧一起走同样的接
收和发送队列。
OAM 帧格式如下图所示：
SD5182HV100 Functional Specification Page 73 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure 4.1-22 XEMAC OAM帧格式
其中Code 域的含义如下图所示。
Figure 4.1-23 XEMAC OAM Code
4.1.3.3 XEMAC MPCP Path
XEMAC 提供独立的MPCP 收发通道。发送方向能够缓存1 个MPCP 帧。接收方向能够缓
存8 个MPCP 帧(1G EPON) 或16 个MPCP 帧（10G EPON）。
发送方向，MPCP 帧存放格式：
BYTE0 BYTE1 BYTE2 BYTE3
BYTE4 BYTE5 BYTE6 BYTE7
BYTE60 BYTE61 BYTE62 BYTE63
15
bit31 bit0
SD5182HV100 Functional Specification Page 74 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure 4.1-24 MPCP 帧存放格式
接收方向，对MPCP 帧的接收判断流程：
pkt_tl = 0x8808
Fcs_ok && pkt_len=64B
非MAC Control帧
错误的MAC
Control帧，丢弃
0<Opcode=<6
opcode=1
unkw_mpcp_rcv_en=1 未知MPCP丢弃
unkw_mpcp_rcv_en=1
Llidn的reg帧，送
个MRF接收
未知MPCP丢弃
OLT MPCP丢弃 opcode=3、4、6
YES
NO
opcode=2
Da!=0x0180_C200_0001 ||
gate_flag=1 && llid!=16’hFFFF
||gate_flag=0 && llid=16’hFFFF
错误的MPCP_GAT
E帧，丢弃
Llid=16’hFFFF Da=llidn_mac_addr
da=0x0180_C200_0001
未知MPCP接收
其它ONU/Llidn的
reg帧，丢弃
MPCP reg帧，送
个MRF接收
NO
NO
NO
YES
非法MPCP reg
帧，送个MRF接收
YES
YES
NO
未知MPCP丢弃
NO
YES
MPCP gate帧，送
个MRF接收
NO
入口报文
Figure 4.1-25 MPCP 帧接收判断流程
4.1.3.4 XEMAC DS LLID Filter
XEMAC 在下行方向的RS 子层对接收帧根据帧Preamble 中的LLID 和软件配置的注册
LLID 进行过滤，将不属于本ONU 接收的帧全部滤除，只把属于本ONU 接收的帧收给后
续的解密模块和MAC 子层进行接收处理。支持LLID 的侦听处理。
4.1.3.5 XEMAC 加解密
“中国电信EPON 设备技术要求V3.0”定义了DS Triple-Churning 加密方法，对SLD
（Start of LLID Delimiter）后面的第2 个保留字节（0x55）的最低2bit 做了扩展，用于承
载三重搅动加密使能和密钥索引。
SD5182HV100 Functional Specification Page 75 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
LLID CRC DA SA L/TYPE Data FCS
Preamble 明文
加密前
加密后
高六位Flag
Key_
Index
MSB LSB
Reserved
0x5555
SLD
Reserved
0x5555
LLID CRC DA SA L/TYPE Data FCS
Preamble 数据搅动区
Reserved
0x5555
SLD
Reserved
0x5555
Figure 4.1-26 XEMAC DS Preamble Decrypt Indication
保留字节的高6bit 的取值仍遵循IEEE 802.3-2008 标准，对低2bit 进行了如下定义：
 Flag 位（bit 1）：AES/搅动标记，表示该帧是否被加密；0：明文；1：密文。
 Key_Index 位（bit 0）：密钥索引，指示ONU 在解密过程中要采用的密钥编号。
当加密功能关闭时，Key_Index 位的值应为“1”。
如果Flag＝0，则不对接收帧做任何解密操作；
如果Flag＝1，则：
 如果软件配置decipher_type＝0，则对接收帧使用三重搅动密钥进行三重搅动解
密；
 如果软件配置decipher_type＝1，则对接收帧使用AES 密钥进行AES 解密。
XEMAC AES 所遵循的DPoE 安全规范也是对这2bit 做了同样的定义。
Figure 4.1-27 XEMAC DEoP CFB-mode AES Secrity Octet
如果Flag＝0，则不对接收帧做任何解密操作；
如果Flag＝1，则：
SD5182HV100 Functional Specification Page 76 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 如果软件配置decipher_type＝0，则对接收帧使用三重搅动密钥进行
三重搅动解密；
 如果软件配置decipher_type＝1，则对接收帧使用AES 密钥进行AES
解密。
4.1.3.6 XEMAC FEC
4.1.3.6.1 1G EPON FEC
1G EPON 上下行1G 的FEC 编码使用RS(255,239)，编码格式也比较特别，是基于帧（或
者说基于报文）的FEC 编码，而上下行10G 的FEC（包括GPON、XG-PON 的FEC）是
基于流的FEC 编码），导致DS FEC Decode 所产生的Latency 跟支持的最大帧长相关，
对于标准的Eth MTU＝1518 字节，FEC Decode Latency≈12us，EMAC 需要支持MTU＝
2K 字节，FEC Decode Latency≈16us，为了减小非FEC 编码帧的接收延迟，EMAC 特别
支持FEC Decode Bypass 功能。
PCS
_RCV
A
RS_DECODER
B RS
Bypass
Bypass Path
Figure 4.1-28 1G EMAC DS FEC Decode Bypass
相关的配置寄存器包括pon_rx_fec_bypass 和pon_rx_fec_en，含义如下面两张表所示。
pon_rx_fec_bypass＝0
（Default）
pon_rx_fec_bypass＝1
支持最大帧
长MTU
可接收最大MTU=2047 字节 可接收最大MTU=9600 字节
接收延迟 固定，对所有接收帧都是
≈16us
固定，对所有接收帧都是
≈0us
非FEC 编码
帧
无Parity，不进行FEC 解码 正常接收
FEC 编码帧 进行FEC 解码，可以纠错 识别FEC Codeword，剥离
Parity，只接收有效数据，不
做解码和纠错
SD5182HV100 Functional Specification Page 77 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
pon_rx_fec_bypass＝0（Default） pon_rx_fec_bypass＝1
FEC编码帧（Jumbo帧）
识别FEC Codeword，剥离Parity，只接收有效数据，不做解码和纠错
识别FEC Codeword，剥离Parity，只接收有效数据，不做解码和纠错
Table Table Table Table Table Table 4.14.14.1-35 EPON ConfigEPON ConfigEPON ConfigEPON ConfigEPON ConfigEPON ConfigEPON ConfigEPON ConfigEPON ConfigEPON ConfigEPON Config：pon_rx_fec_bypasspon_rx_fec_bypasspon_rx_fec_bypasspon_rx_fec_bypasspon_rx_fec_bypasspon_rx_fec_bypasspon_rx_fec_bypasspon_rx_fec_bypasspon_rx_fec_bypasspon_rx_fec_bypasspon_rx_fec_bypasspon_rx_fec_bypasspon_rx_fec_bypasspon_rx_fec_bypasspon_rx_fec_bypasspon_rx_fec_bypasspon_rx_fec_bypass
pon_rx_fec_en＝0 pon_rx_fec_en＝1（Default）
接收延迟
固定，对所有接收帧都是≈16us
非FEC编码帧
无Parity，不做解码，正常接收
FEC编码帧
识别FEC Codeword，剥离Parity，只接收有效数据，不做解码和纠错
进行FEC解码，可以纠错
FEC编码帧（Jumbo帧）
识别FEC Codeword，剥离Parity，只接收有效数据，不做解码和纠错
识别FEC Codeword，剥离Parity，只接收有效数据，不做解码和纠错
Table Table Table Table Table Table 4.14.14.1-36 EPON ConfigEPON ConfigEPON ConfigEPON ConfigEPON ConfigEPON ConfigEPON ConfigEPON ConfigEPON ConfigEPON ConfigEPON Config：pon_rx_fec_enpon_rx_fec_enpon_rx_fec_enpon_rx_fec_enpon_rx_fec_enpon_rx_fec_enpon_rx_fec_enpon_rx_fec_enpon_rx_fec_enpon_rx_fec_enpon_rx_fec_enpon_rx_fec_enpon_rx_fec_en
因为DS FEC Decode的正常路径和Bypass路径的数据延迟是不一样的，且差异很大，所以在两条路径之间进行动态切换会导致数据错误或丢失，不排除会导致ONU注销、掉线。
4.1.3.6.2 10G EPON FEC
10G EPON在下行FEC使能的情况下，完成RS(255,223)的解码和纠错功能；由于FEC基于流进行编码，故可基于PON口配置FEC 的ON/OFF。
PCS_CFG_0(PCS相关配置寄存器0,地址偏移：0x0000) bit 名称 类型 描述 复位值
[28]
pon_rx_fec_en
RW
PON下行FEC纠错使能。
1：使能纠错；
0：不使能纠错。
0x1
SD5182HV100 Functional Specification Page 78 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
bit 名称 类型 描述 复位值
[27:12]
pon_tx_fec_en
RW
EPON上行FEC编码使能。
上行1G
基于LLID配置，Bit[n],
1：LLID Idex n使能FEC编码；
0：LLID Idxe n关闭FEC编码。
上行10G
基于PON口配置
任意一比特非零，则使能上行FEC编码。否则关闭上行FEC编码。
0x0000
Table Table Table Table Table Table 4.14.14.1-37 10G FEC10G FEC10G FEC10G FEC10G FEC10G FEC10G FEC配置
10G EMAC 上行 FEC，支持10G对称模式和非对称模式，不同模式使用的RS编码不同，具体如下：
上行1G模式支持RS(255,239)编码，可基于LLID配置FEC ON/OFF；
上行10G模式支持RS(255,223)编码，可基于PON口配置FEC ON/OFF。
同时支持上行FEC的插错处理。
4.1.3.7 XEMAC OTDR诊断
XEMAC支持OTDR测试功能。OLT向ONU分配OTDR测试窗口。ONU在OTDR测试窗口内触发ONU侧光模块启动OTDR测试。
XEMAC支持两种OTDR测试窗口识别方式：
方式一：通过特殊的MPCP帧进行识别，特殊的OTDR授权帧格式：
SD5182HV100 Functional Specification Page 79 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
6 DA
6 SA
2 T/L＝0x8808
2 Opcode＝0x0002
4 TS
Flag=0xFF
OTDR Start Time
OTDR Length
1
4
2
Pad
FCS
33
4
Figure 4.1-29 OTDR 帧格式
OTDR 授权和普通授权的区别：Flag 域不同，OTDR 授权的flag 域为0xFF。
方式二：当软件使能OTDR 重调制功能后(CTRL_REG8.otdr_remod_en)，XEMAC 根据软
件配置的OTDR 重调制授权长度（CTRL_REG9.otdr_grant_len）进行OTDR 授权识别。
如果收到的grant 长度大于等于重调制授权长度时，判定为OTDR 授权。
XEMAC 输出给光模块的触发脉冲宽度，极性，时延在芯片的TOP_CFG 可配置。
4.1.3.8 XEMAC 私有Gate 帧
XEMAC 支持自定义的私有Gate 帧解析执行，私有Gate 帧帧格式：
DA
SA
T/L(0x8808)
Opcode(0x0002)
TS
flag(8'bxxxx_0111)
6
6
2
2
4
1
1 force-report bitmap[15:8]
force-report bitmap[7:0]
LLID0 Grant Length
4
LLID15 Grant Length
Pad/FCS
2*16
5
Grant Start Time
1
Figure 4.1-30 私有Gate 帧格式
SD5182HV100 Functional Specification Page 80 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
XEMAC 在收到私有Gate 帧后，将内部包含的所有有效Grant（长度大于42TQ 的grant 被
认为是有效grant）解析出来，并进行私有Grant 标识。之后进行标准定义的Grant 检查
（授权开始时间，授权长度），仅对私有Gate 帧中第一个有效的Grant 进行检查，如果
检查不通过则将来自同一私有Gate 帧的Grant 全部丢弃。
私有Grant 在执行时，来自同一Gate 帧的有效Grant 连续执行。首Grant 扣除
laser_on_time 和sync_time，尾Grant 扣除laser_off_time。
4.1.3.9 XEMAC Low Power
XEMAC 低功耗模式、低功耗操作、状态机等跟GMAC 相同。XEMAC 低功耗除了支持
GPON 协议中定义的特性外还新增如下特性：
 XEMAC 在上行Sleep 时，发送方向不再发光、不发数据；
 XEMAC 在双向Sleep 时，下行应该收不到Grant，因为DS FTM/SDS
都关掉了，这时上行方向也要不发光、不发数据，GLF 可以清空。当
然，唤醒/苏醒以后，还是要及时接收、执行Grant 的。
 XEMAC 在上电/复位后收到的首个MPCP 帧 是不做Timestamp Drift
检查、不上报Drift 中断的，同样，在退出Sleep 状态后收到的首个
MPCP 帧 也应如此，直接将Localtime 同步到DS MPCP 的Timestamp
域，以避免因为Timestamp Drift 而掉线/注销。
XEMAC 下行方向收到SA(OFF) OAM（等同于GPON 的SA(OFF) PLOAM）帧格式：
6 DA=01-80-C2-00-00-02
6 SA
2 T/L＝0x8809
1 Subtype＝0x03
2 Flags
Code=0xFE
OUI=0xBC614E
Ext.opcode=0x03
Branch=0xE7
Branch=0x006
1
3
1
1
2
1 Variable width = 1
1 SA(OFF) = 0x0
Pad
FCS
33
4
Figure 4.1-31 SA(OFF) OAM帧格式
SD5182HV100 Functional Specification Page 81 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
软件可配是接收的SA(OFF) OAM走数据通路或者走OAM接收通路。同时软件可配逻辑是否响应SA(OFF) OAM，若响应则会上报中断给软件，告诉CPU需要从低功耗模式唤醒。
4.1.3.10 XEMAC Dying gasp
XEMAC Dying Gasp帧格式如下，其实Dying Gasp是OAM的一种，是OAM中flag=0x2的特殊情况： Octer Field Value
6
Destination Address
0x01-80-c2-00-00-02
6
Source Address
ONU/LLID0 MAC Address
2
Length/Type
88-09 [Slow Protocols]
1
Subtype
0x03 [OAM]
2
Flags
16’h0002
1
Code
8’h00
42
Data/Pad
8’h00
4
FCS
FCS
Table Table Table Table Table Table 4.14.14.1-38 Dying GaspDying GaspDying GaspDying GaspDying GaspDying GaspDying GaspDying GaspDying GaspDying Gasp帧格式 帧格式 帧格式
当XEMAC检测Dying_Gasp上升沿，启动Dying_Gasp发送。软件可以对DyingGasp帧发送帧数、帧flag域、帧code域进行配置。
DyingGasp具有最高发送优先级，并且可以通过截断正在发送的数据帧，保证OAM帧获得发送窗口。
4.1.3.11 XEMAC Flush
XEMAC支持基于LLID可配的Flush功能，当软件配置Flush时，XEMAC在空闲时不断从EPS_PON中抽取帧数据帧；当软件撤销Flush时，如果对应发送FIFO处于空状态则停止Flush。
Report计算由EPS_PON完成，当配置XEMAC内部Flush时，对于EPS_PON来说等同于帧数据已发送到线路上。
XEMAC的flush需要EPS_PON和EMAC共同完成。其中XEMAC内部的flush包括：对相应LLID发送报文的清空，MPCP报文的清空和OAM报文的清空。
4.1.3.12 XEMAC Remote Loopback
XEMAC远端环回功能由数据通路完成。XEMAC内部不做处理。
SD5182HV100 Functional Specification Page 82 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1.3.13 1G EPON Table
EMAC表项间接访问寄存器。 名称 说明 偏移地址 成员名称 成员范围 属性 成员初始值 成员说明
EMAC_TAB_CFG
EMAC表项访问控制寄存器
0x0FC
reserved
31
RO
0x0
保留。
-
-
-
tab_op_start
30
RWSC
0x0
软件写1，表示开始进行表项访问操作，然后1表示操作忙碌状态（正在进行访问），逻辑完成操作后自动清零（表示访问已经结束）。
-
-
-
tab_op_wr
29
RW
0x0
表项访问类型。 0：读操作； 1：写操作。
-
-
-
tab_op_err
28
RO
0x0
表项访问是否出现错误，错误原因包括但不限于：CPU访问不存在的表编号；CPU对只读表项进行写访问。只在tab_op_start为0时才有效。
-
-
-
reserved
27:24
RO
0x0
保留。
-
-
-
tab_idx
23:16
RW
0x00
要访问的表编号，具体为：
0x00：解密密钥表（可读写）
0x01：注册LLID表（可读写）
0x02：Report配置表（可读写）
0x03：MAC地址表（可读写）
0x04：阈值表（可读写）
其他配置非法
SD5182HV100 Functional Specification Page 83 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
名称 说明 偏移地址 成员名称 成员范围 属性 成员初始值 成员说明
-
-
-
tab_addr
15:0
RW
0x0000
要访问的表项地址。
解密密钥表地址构成：
bit[8:0]={key_idx,4'b0,lidx[3:0]}
注册LLID表地址构成：
bit[4:0]={lidx[4:0]}//配置16+4个通道LLID
Report配置表地址构成：
bit[9:0]={qset_idx[1:0],4'b0,lidx[3:0]}
qset_idx，队列集序号。0～2表示队列集0～2。
队列集0：threshold0对应的队列集
队列集1：threshold1对应的队列集
队列集2：threshold2对应的队列集
队列集3：full report
其中threshold0<threshold1<threshold2
MAC地址表地址构成：
bit[3:0]={lidx[3:0]}
阈值表地址构成：
bit[5:0]={ qset_idx[1:0],lidx[3:0]}
qset_idx的意义与Report配置表中的qset_idx相同
EMAC_TAB_RDATA0
EMAC表项CPU读数据寄存器0
0x100
tab_rdata0
31:0
RO
0x00000000
CPU读的表项数据。本寄存器表示tab_rdata[31:0]。 表项读数据结构请参见表项配置说明
SD5182HV100 Functional Specification Page 84 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
名称 说明 偏移地址 成员名称 成员范围 属性 成员初始值 成员说明
EMAC_TAB_RDATA1
EMAC表项CPU读数据寄存器1
0x104
tab_rdata1
31:0
RO
0x00000000
CPU读的表项数据。本寄存器表示tab_rdata[63:32]。
EMAC_TAB_RDATA2
EMAC表项CPU读数据寄存器2
0x108
tab_rdata2
31:0
RO
0x00000000
CPU读的表项数据。本寄存器表示tab_rdata[95:64]。
EMAC_TAB_RDATA3
EMAC表项CPU读数据寄存器3
0x10C
tab_rdata3
31:0
RO
0x00000000
CPU读的表项数据。本寄存器表示tab_rdata[127:96]。
EMAC_TAB_WDATA0
EMAC表项CPU写数据寄存器0
0x110
tab_wdata0
31:0
RW
0x00000000
CPU写的表项数据。本寄存器表示tab_wdata[31:0]。 表项写数据结构与表项读数据结构相同
EMAC_TAB_WDATA1
EMAC表项CPU写数据寄存器1
0x114
tab_wdata1
31:0
RW
0x00000000
CPU写的表项数据。本寄存器表示tab_wdata[63:32]。
EMAC_TAB_WDATA2
EMAC表项CPU写数据寄存器2
0x118
tab_wdata2
31:0
RW
0x00000000
CPU写的表项数据。本寄存器表示tab_wdata[95:64]。
EMAC_TAB_WDATA3
EMAC表项CPU写数据寄存器3
0x11C
tab_wdata3
31:0
RW
0x00000000
CPU写的表项数据。本寄存器表示tab_wdata[127:96]。
SD5182HV100 Functional Specification Page 85 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Table Table Table Table Table Table 4.14.14.1-39 EPONEPONEPONEPON表项间接访问寄存器 表项间接访问寄存器 表项间接访问寄存器 表项间接访问寄存器 表项间接访问寄存器 表项间接访问寄存器 表项间接访问寄存器 表项间接访问寄存器 表项间接访问寄存器
4.1.3.13.1 解密密钥表 表格名称
解密密钥表 起始地址
0x0 地址范围
分段地址：tab_addr[8:0]={key_idx,4’b0,lidx[3:0]}
key_idx:0~1
lidx:0~15 表项数目
32 每项宽度
128bits 寻址方式
密钥ID，LLID Index
Table Table Table Table Table Table 4.14.14.1-40 解密钥表基本描述 解密钥表基本描述 解密钥表基本描述 解密钥表基本描述 解密钥表基本描述 解密钥表基本描述 解密钥表基本描述 解密钥表基本描述 解密钥表基本描述
Field Width Type Description Reset
key
[127:0]
R/W
三重搅动时仅低24比特有效
0x0
Table Table Table Table Table Table 4.14.14.1-41 解密钥表数据结构说明 解密钥表数据结构说明 解密钥表数据结构说明 解密钥表数据结构说明 解密钥表数据结构说明 解密钥表数据结构说明 解密钥表数据结构说明 解密钥表数据结构说明 解密钥表数据结构说明 解密钥表数据结构说明 解密钥表数据结构说明
表项编号：0x00（解密密钥表）
SD5182HV100 Functional Specification Page 86 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
key0_0[127:0]
key1_0[127:0]
127 0
key15_0[127:0]
key0_1[127:0]
key1_1[127:0]
key15_1[127:0]
lidx0~15
kidx=0
lidx0~15
kidx=1
tab_addr[7:0] = {key_idx,4'b0,lidx[3:0]}
Figure 4.1-32 解密密钥表
解密密钥表，存储下行方向当前进行AES 或者三重搅动解密所使用的密钥。每个LLID
对应两个密钥key0,key1。上图中keyN_M，其中N 表示LLID Index，M表示Key Index。
表项中，每一行表示代表一个密钥，当采用AES 方式进行解密时使用128 比特进行解密，
当采用三重搅动方式解密时使用低24 比特作为解密密钥。
4.1.3.13.2 注册LLID 表
表格名称 注册LLID 表
起始地址 0x0
地址范围 0～19
表项数目 20
每项宽度 18bits
寻址方式 以LLID Index 为地址
Table 4.1-42 注册LLID表基本描述
Field Width Type Description Reset
mod_en [17] R/W LLID MOD 域(LLID[15])检查。
0：检查MOD 域；
1：不检查MOD 域。
0~15 ：0x0
16 ：0x1
17~19 ：0x0
SD5182HV100 Functional Specification Page 87 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
reg_st [16] R/W 注册状态或接收使能。
0：未注册或关闭；
1：已注册或使能。
0~15 ：0x0
16 ：0x1
17~19 ：0x0
reg_llid [15:0] R/W 注册LLID 0x7FFF
Table 4.1-43 注册LLID表数据结构说明
表项编号：0x01（注册LLID 表）
st reg_llid0[14:0]
st reg_llid1[14:0]
st reg_llid14[14:0]
st reg_llid15[14:0]
mod st scb_llid[15:0]
mod st snp_llid0[15:0]
mod st snp_llid1[15:0]
mod st snp_llid2[15:0]
16×Reg
LLID
SCB
LLID
3×Snoop
LLID
17 0
tab_addr[4:0] = {lidx[4:0]}
Figure 4.1-33 注册LLID表
注册LLID 表项共有20 行。每行18 比特，其中：
bit[17] : Mod 使能，0~LN-1 通道Mod 总是关闭,LN~LN+3 通道Mod 可配，当Mod 为1 时，
下行LLID 过滤时，不考虑LLID[15]是否匹配。
bit[16] : 注册或使能状态。1:表示下行方向接收对应LLID 的数据。0：表示关闭接收对应
LLID 数据。
bit[15:0]: 注册LLID，0~LN-1 通道的注册LLID 只能配置低15 比特,bit[15]默认为0。
LN~LN+3 通道所有比特可配。
SD5182HV100 Functional Specification Page 88 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1.3.13.3 Report 配置表
表格名称 Report 配置表
起始地址 0x0
地址范围 分段地址：tab_addr[9:0]={qset_idx[1:0],4’b0,lidx[3:0]}
qset_idx:0~3
lidx:0~15
表项数目 64
每项宽度 10bits
寻址方式 Qset Index,LLID Index
Table 4.1-44 Report 配置表基本描述
Field Width Type Description Reset
qset_num [9:8] R/W report 队列集数据 0x0
bitamp [7:0] R/W report Bitmap 0xFF
Table 4.1-45 Report 配置表数据结构说明
表项编号：0x02（Report 配置表）
tab_addr[9:0] = {qset_idx[1:0],4'b0.lidx[4:0]}
lidx0 qset lidx0 bitmap0
lidx1 qset lidx1 bitmap0
lidx14 qset lidx14 bitmap0
lidx15 qset lidx15 bitmap0
lidx0 bitmap3
lidx1 bitmap3
lidx14 bitmap3
lidx15 bitmap3
16×
report
config 0
16×
report
config3
16（LLID）
×4(Qset)
9 0
SD5182HV100 Functional Specification Page 89 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-34 ReportReportReportReportReportReport配置表 配置表 配置表
Report配置表负责配置Report上报qset[1:0]和bitmap[7:0]的配置。总共64行，每行10比特。
qset基于LLID进行配置，仅当tab_addr[9:8]=0是才可以写入。qset=0表示支持1个队列集，qset=1表示2个队列集，qset=2表示3个队列集，qset=3表示4个队列集。
bitmap基于LLID和队列集进行配置。每个LLID最多支持4个队列集。
4.1.3.13.4 EMAC MAC地址表 表格名称
MAC地址表 起始地址
0x0 地址范围
0~15 表项数目
16 每项宽度
48bits 寻址方式
LLID Index
Table Table Table Table Table Table 4.14.14.1-46 MACMACMAC地址表基本描述 地址表基本描述 地址表基本描述 地址表基本描述 地址表基本描述 地址表基本描述 地址表基本描述 Field Width Type Description Reset
mac_addr
[47:0]
R/W
MAC地址
0x0
Table Table Table Table Table Table 4.14.14.1-47 MACMACMAC地址表数据结构说明 地址表数据结构说明 地址表数据结构说明 地址表数据结构说明 地址表数据结构说明 地址表数据结构说明 地址表数据结构说明 地址表数据结构说明 地址表数据结构说明
表项编号：0x03（MAC地址表）
SD5182HV100 Functional Specification Page 90 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
LLID0 MAC Address[47:0]
LLID1 MAC Address[47:0]
LLID15 MAC Address[47:0]
LLID14 MAC Address[47:0]
47 0
tab_addr[3:0] = {lidx[3:0]}
Figure 4.1-35 MAC 地址表
MAC 地址表基于LLID 配置。总共16 行，每行48 比特。每个LLID 对应一个MAC 地址。
4.1.3.13.5 Report 阈值表
表格名称 Report 阈值表
起始地址 0x0
地址范围 分段地址：tab_addr[5:0]={qset_idx[1:0],lidx[3:0]}
qset_idx:0~2
lidx:0~15
表项数目 48
每项宽度 128bits
寻址方式 Qset Index,LLID Index
Table 4.1-48 Report 阈值表基本描述
Field Width Type Description Reset
q7_th [128:112] R/W 优先级7 对应的Report 阈值 0x0
q6_th [111:96] R/W 优先级6 对应的Report 阈值 0x0
q5_th [95:80] R/W 优先级5 对应的Report 阈值 0x0
q4_th [79:64] R/W 优先级4 对应的Report 阈值 0x0
q3_th [63:48] R/W 优先级3 对应的Report 阈值 0x0
q2_th [47:32] R/W 优先级2 对应的Report 阈值 0x0
q1_th [31:16] R/W 优先级1 对应的Report 阈值 0x0
q0_th [15:0] R/W 优先级0 对应的Report 阈值 0x0
SD5182HV100 Functional Specification Page 91 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Table 4.1-49 Report 阈值表数据结构说明
表项编号：0x04（阈值表）
LLID0 QSET0 Q0~7 TH
127 0
LLID1 QSET0 Q0~7 TH
LLID15 QSET0 Q0~7 TH
LLID0 QSET1 Q0~7 TH
LLID1 QSET1 Q0~7 TH
LLID15 QSET1 Q0~7 TH
LLID0 QSET2 Q0~7 TH
LLID1 QSET2 Q0~7 TH
LLID15 QSET2 Q0~7 TH
0
47
Figure 4.1-36 阈值表
report 阈值表基于LLID(16)，队列集(3)进行配置。总共48 行，每行128 比特。
SD5182HV100 Functional Specification Page 92 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1.3.14 10G EPON Table
4.1.3.14.1 PCS发送码型表 表项名称
PCS发送配置表 起始地址
0x0 地址范围
连续地址：0~12
OTDR时循环发送内容：0~7
Burst Delimiter(FEC_on)：8
Burst Delimiter(FEC_off)：9
Sync Pattern：10
End Of Burst：11
PRBS Err Pattern:12 表项数目
13 每项宽度
66bits 寻址方式
间接寻址，见地址范围
Table Table Table Table Table Table 4.14.14.1-50 PCS配置基本描述 Field Width Type Description Reset
PCS
Pattern
[65:0]
R/W
0～7行:
OTDR特殊授权时的发送数据（8组数据循环发送）
0x0
8行:
FEC使能时的突发定界符
{64’hABE4_58D8,12D8,F86B,2’b10}
9行:
FEC不使能时的突发定界符
{64’h88D0_A8B7_C743_5c97, 2’b11}
10行:
对称模式时：同步码型
非对称模式：bit[9:0]为上行测试字符0
{64’h59BB_49C5_E518_40BF, 2’b01}
11行:
对称模式时：突发结束定界符
非对称模式：bit[9:0]为上行测试字符1
{64’h5555_5555_5555_5555, 2’b01}
12行:
PRBS插错码型
0x0
Table Table Table Table Table Table 4.14.14.1-51 PCS表项数据结构
表项编号：0x00（PCS发送码型表）
SD5182HV100 Functional Specification Page 93 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-37 PCS表项结构
当诊断模式使能时，0～7行循环发送。
4.1.3.14.2 注册LLID表 表格名称
LLID注册表 起始地址
0x0 地址范围
tab_addr[5:0]= lidx[5:0]
0~35 表项数目
36 每项宽度
18bits 寻址方式
lidx
Table Table Table Table Table Table 4.14.14.1-52 注册LLID表基本描述 Field Width Type Description Reset
Reg_st
[17]
R/W
LLID注册状态
0x0
Mode_mask
[16]
R/W
LLID匹配时是否忽略mode域，1：忽略
0~(2LN-1) :
默认关注 0
2LN :
默认不关注 1
2LN+1～2LN+3:
默认不关注 1
llid
[15:0]
R/W
配置的LLID值
0x7FFE
OTDR Data1OTDR Data01270OTDR Data7BD_FEC_ONBD_FEC_OFFSync PatternEnd of Burst01781011129PRBS ERR Pattern
SD5182HV100 Functional Specification Page 94 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Table Table Table Table Table Table 4.14.14.1-53 注册LLID表数据结构说明
表项编号：0x01
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-38 解密表项结构图
LLID注册表项存储配置的LLID值和是否关注mode域配置以及该LLID的注册状态。总共36行，每行18比特。0~31行存储本ONU LLID，第0行表示LLID0，第31行表示LLID31。第32行是广播LLID，第33行是侦听LLID0，第34行是侦听LLID1，第35行是侦听LLID2。广播LLID的注册状态用不到，配置时不需关注。
01311615017llidmaskReg_stsnop0snop1snop2bcrsv
SD5182HV100 Functional Specification Page 95 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1.3.14.3 解密密钥表 表格名称
解密配置表 起始地址
0x0 地址范围
分段地址：tab_addr[6:0]={lidx[5:0], kidx ,line_id}
lidx:0~32
kidx:0~1
line_id:0~1 表项数目
130 每项宽度
128bits 寻址方式
{lidx, kidx ,line_id}
Table Table Table Table Table Table 4.14.14.1-54 解密密钥配置表基本描述
当下行三重搅动模式时 Field Width Type Description Reset
key_vld
[0:0]
R/W
密钥是否有效0：无效，1：有效
0x0
Table Table Table Table Table Table 4.14.14.1-55 搅动解密密钥偶数行数据结构说明 Field Width Type Description Reset
rsv
[127:72]
R/W
保留
0x00
Key3
[71:48]
R/W
解密的第三个key
0x0000
Key2
[47:24]
R/W
解密的第二个key
0x0000
Key1
[23:0]
R/W
解密的第一个key
0x0000
Table Table Table Table Table Table 4.14.14.1-56 搅动解密密钥表奇数行数据结构说明
当下行AES模式时。 Field Width Type Description Reset
key_vld
[0:0]
R/W
密钥是否有效0：无效，1：有效
0x0
Table Table Table Table Table Table 4.14.14.1-57 AES解密表偶数行数据结构说明 Field Width Type Description Reset
decipher_key
[127:0]
R/W
AES解密key
0x0000
SD5182HV100 Functional Specification Page 96 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Table Table Table Table Table Table 4.14.14.1-58 AES解密表奇数行数据结构说明
表项编号：0x02
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-39 解密表项结构图
解密密钥表用来存储XGEMAC下行解密密钥（三重搅动和AES共享该表项）。总共存储33个LLID(含广播)的解密密钥。每个LLID支持配置两组（分别对应kidx=0,kidx=1）。每组包含Key，VLD配置。由于标准表项最多支持128比特，因此每组密钥分两行进行配置。如0所示，偶数行（line_id=0）对应表项的VLD配置，奇数行（line_id=1）对应表项的Key配置。
注：实际存储的位宽为129bit，与上图结构有差别，主要为方便说明软件访问过程。
LLID0 key0vld01271line_id =0line_id =1lidx =0LLID1 key0vldline_id =0line_id =10123LLID31 key0vldline_id =0line_id =16263LLID31 key1vld126127lidx =1lidx =31LLID0 key1vldline_id =0line_id =1lidx =0LLID1 key1vldline_id =0line_id =164656667lidx =1line_id =0line_id =1lidx =31kidx =0kidx =1
SD5182HV100 Functional Specification Page 97 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.1.3.14.4 加密密钥表 表格名称
加密配置表 起始地址
0x0 地址范围
tab_addr[4:0]= {lidx[3:0],line_id}
lidx:0~15 表项数目
32 每项宽度
128bits 寻址方式
lidx
Table Table Table Table Table Table 4.14.14.1-59 加密配置表基本描述 Field Width Type Description Reset
Key_index
[1:1]
R/W
密钥索引
0x0
Cipher_en
[0:0]
R/W
加密是否使能0：不使能，1：使能
0x0
Table Table Table Table Table Table 4.14.14.1-60 AES加密表偶数行数据结构说明
Field Width Type Description Reset
cipher_key
[127:0]
R/W
AES加密key
0x0000
Table Table Table Table Table Table 4.14.14.1-61 AES加密表奇数行数据结构说明
表项编号：0x03
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-40 加密密钥表项结构图
加密密钥表用来存储XGEMAC上行AES加密密钥。共支持16个LLID的加密密钥配置。每个LLID支持一组配置。每组配置包含{kidx，cipher_en，key}。由于标准表项最多支持
LLID0 keycipehr_en01271line_id =0line_id =1lidx =0LLID1 keyline_id =0line_id =10123LLID15 keyline_id =0line_id =13031lidx =1lidx =15kidxcipehr_enkidxcipehr_enkidx2
SD5182HV100 Functional Specification Page 98 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
128比特，因此每组配置分两行进行读写操作。如0所示，偶数行（line_id=0）对应表项的{kidx,cipher_en}配置，奇数行（line_id=1）对应表项的key配置。
注：实际存储结构与上图有差别。
4.1.3.14.5 Report配置表 表格名称
Report配置表 起始地址
0x0 地址范围
分段地址：tab_addr[9:0]={ lidx[3:0],line_id[2:0]}
lidx:0~15
line_id:0~7 表项数目
128 每项宽度
10bits 寻址方式
LLID Index, LINE ID
Table Table Table Table Table Table 4.14.14.1-62 Report配置表基本描述 Field Width Type Description Reset
qset_num
[33:32]
R/W
report队列集数据
0x0
bitmap0
[31:24]
R/W
report bitmap0 第一个队列集对应的bitmap
0xFF
bitmap1
[23:16]
R/W
report bitmap1第二个队列集对应的bitmap
0xFF
bitmap2
[15:8]
R/W
report bitmap2 第三个队列集对应的bitmap
0xFF
bitmap3
[7:0]
R/W
report bitmap3 第四个队列集对应的bitmap
0xFF
Table Table Table Table Table Table 4.14.14.1-63 Report配置表RPT CFG（line_id=0）数据结构说明
SD5182HV100 Functional Specification Page 99 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Field Width Type Description Reset
rpt_list0~5
[63:0]
R/W
每行report list包含8字节填充内容：
rpt_list0~5[55:0]={8{rpt_pattern}}
其中每个字节对应独立的rpt_pattern配置：
rpt_patten[7:0]={reserved,type[1:0],qset[1:0],qn[2:0]}
type[1:0]
2’b00 : q_rpt[15:8]
2’b01 : q_rpt[7:0]
2’b10 : bitmap
2’b11 : dummy
qset[1:0]:
0～3：队列集0～3
qn[2:0]
队列0～7
rpt_list0={
8’h7F ,8’h7F,
8’h7F,8’h7F,
8’h7F,8’h40,
8’h00,8’h20}
rpt_list1={
8’h01,8’h21,
8’h02,8’h22,
8’h03,8’h23
8’h04,8’h24}
rpt_list2={
8’h05,8’h25,
8’h06,8’h26,
8’h07,8’h27
8’h7F,8’h7F}
rpt_list3={
8’h7F ,8’h7F,
8’h7F,8’h7F,
8’hFF,8’h7F,
8’h7F,8’h7F}
rpt_list4={
8’h7F ,8’h7F,
8’h7F,8’h7F,
8’h7F,8’h7F,
8’h7F,8’h7F}
rpt_list5={
8’h7F ,8’h7F,
8’h7F,8’h7F,
8’h7F,8’h7F,
8’h7F,8’h7F}
Table Table Table Table Table Table 4.14.14.1-64 Report配置表RPT LIST0~5(line_id=1~6)数据结构说明
Field Width Type Description Reset
reserved
[63:48]
RO
保留
0x0
SD5182HV100 Functional Specification Page 100 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
writing_lidx
[47:40]
RO
MPI正在配置的lidx。当writing有效时有效。（调试用）
0x0
reserved
[39:33]
RO
保留
0x0
writing
[32:32]
RO
MPI正在修改配置（调试用）
0x0
freshing_lidx
[31:24]
RO
配置搬移对应的lidx。当freshing有效时有效。（调试用）
0x0
reserved
[23:17]
RO
保留
0x0
freshing
[16:16]
RO
配置正在搬移状态（调试用）
0x0
err_lidx
[15:8]
RO
由于错误操作被丢弃配置对应的lidx。当last_wr_err有效时有效。
0x0
reserved
[7:1]
RO
保留
0x0
wr_err
[0:0]
RO
最近一个写操作在未写Finish之前更换了lidx。最近一次写操作被认为是有效的，之前的操作将被丢弃。标识位在下一次正确操作时清除。
0x0
Table Table Table Table Table Table 4.14.14.1-65 Report配置表CFG_FINISH（line_id=7）数据结构说明
表项编号：0x04（Report配置表）
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-41 Report表项结构图
Report配置表负责基于LLID配置Report上报qset[1:0]和bitmap0～3[7:0]的配置(RPT_CFG)，以及告知逻辑如何组帧(rpt_list)，可以使用新的配置(CFG_FINISH)。总共128行，每行64比特。
LLID0 RPT CFGLLID0 RPT_LIST0LLID0 RPT_LIST1LLID0 RPT_LIST5LLID0 CFG_FINISHLLID0 RPT CFGLLID0 RPT LIST0～5LLID15 RPT CFGLLID15 RPT_LIST0LLID15 RPT_LIST1LLID15 RPT_LIST5LLID15 CFG_FINISHLLID15 RPT CFGLLID15 RPT LIST0～563007127120
SD5182HV100 Functional Specification Page 101 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
以LLID0配置为例说明该表项配置方法：
当需要修改LLID0的report配置时，软件对0~6行内容依次进行刷新。由于第0行的RPT_CFG配置和第1～6行的RPT_LIST配置有一一对应关系，因此为了保证逻辑能够同时正确的更新配置，软件需要写第7行告知逻辑可以使用最新的配置。写LLID0 CFG_FINISH成功，表明配置刷新完成。否则逻辑仍然使用默认配置。该表项每个LLID为一个更新单元。对某个LLID更新时如果没有写FINISH，就直接更换其他LLID配置。表项会在对应的LLID CFG_FINISH域返回操作错误。
注：表项配置结构图同实际存储结构有差别。
4.1.3.14.6 授权捕获表 表格名称
授权捕获表 起始地址
0x0 地址范围
0~255 表项数目
256 每项宽度
80 寻址方式
间接寻址
Table Table Table Table Table Table 4.14.14.1-66 授权捕获表项描述 Field Width Type Description Reset
TS
[79:48]
R/W
时戳
0x0
Start_time
[47:16]
R/W
授权的起始时间
0x0
Length
[15:0]
R/W
授权的长度
0x0
Table Table Table Table Table Table 4.14.14.1-67 授权捕获表数据结构
表项编号：0x05（授权捕获表）
SD5182HV100 Functional Specification Page 102 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-42 授权捕获表项结构图
只读表项。软件通过配置CAP_CTRL寄存器，启动授权捕获。当捕获完的128个授权后。逻辑停止捕获。软件通过该表项读取出捕获内容。
4.1.3.14.7 Report捕获表 表格名称
Report捕获表 起始地址
0x0 地址范围
0~255 表项数目
256 每项宽度
128 寻址方式
间接寻址
Table Table Table Table Table Table 4.14.14.1-68 Report捕获表项描述 Field Width Type Description Reset
TS
[31:0]
R/W
Report时戳
0x0
Table Table Table Table Table Table 4.14.14.1-69 Report捕获表偶数行数据结构说明
Field Width Type Description Reset
Rpt_list
[127:0]
R/W
根据起始位连续捕获16字节的Report List内容
0x0
Table Table Table Table Table Table 4.14.14.1-70 Report捕获表奇数行数据结构说明
表项编号：0x06（Report捕获表）
Cap_grant_data, 1st grantCap_grant_data, 2rd grantCap_grant_data, 256th grantCap_grant_data, 255th grant470Addr[6:0]= grant NO.
SD5182HV100 Functional Specification Page 103 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-43 Report捕获表项结构图
只读表项。软件通过配置CAP_CTRL寄存器，启动Report捕获。当捕获完128个Report后，逻辑停止捕获。软件通过该表项读取出捕获内容。每个Report捕获内容超过128比特，因此分两行进行读取。偶数行获取TS，奇数行获取16字节的Report内容。
4.1.3.14.8 Report阈值表 表格名称
Report阈值表 起始地址
0x0 地址范围
分段地址：tab_addr[5:0]={qset_idx[1:0],lidx[3:0]}
qset_idx:0~2
lidx:0~15 表项数目
48 每项宽度
128bits 寻址方式
Qset Index,LLID Index
Table Table Table Table Table Table 4.14.14.1-71 Report阈值表基本描述 Field Width Type Description Reset
q7_th
[128:112]
R/W
优先级7对应的Report阈值
0x0
q6_th
[111:96]
R/W
优先级6对应的Report阈值
0x0
q5_th
[95:80]
R/W
优先级5对应的Report阈值
0x0
q4_th
[79:64]
R/W
优先级4对应的Report阈值
0x0
q3_th
[63:48]
R/W
优先级3对应的Report阈值
0x0
q2_th
[47:32]
R/W
优先级2对应的Report阈值
0x0
q1_th
[31:16]
R/W
优先级1对应的Report阈值
0x0
q0_th
[15:0]
R/W
优先级0对应的Report阈值
0x0
1st RPT.Rpt_list1st RPT.TS012732line_id =0line_id =12nd RPT.Rpt_listline_id =0line_id =10123128th RPT.Rpt_listline_id =0line_id =1302552nd RPT.TS128th RPT.TS
SD5182HV100 Functional Specification Page 104 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Table Table Table Table Table Table 4.14.14.1-72 Report阈值表数据结构说明
表项编号：0x07（阈值表）
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-44 Report阈值表结构图
report阈值表基于LLID(16)，队列集(3)进行配置。总共48行，每行128比特。
4.1.3.14.9 MAC地址表 表格名称
MAC地址表 起始地址
0x0 地址范围
0~15 表项数目
16 每项宽度
48bits 寻址方式
LLID Index
Table Table Table Table Table Table 4.14.14.1-73 MAC地址表基本描述 Field Width Type Description Reset
mac_addr
[47:0]
R/W
MAC地址
0x0
Table Table Table Table Table Table 4.14.14.1-74 MAC地址表数据结构说明
表项编号：0x08（MAC地址表）
LLID0 QSET0 Q0~7 TH0127LLID1 QSET0 Q0~7 THLLID15 QSET0 Q0~7 THLLID0 QSET1 Q0~7 THLLID1 QSET1 Q0~7 THLLID15 QSET1 Q0~7 THLLID0 QSET2 Q0~7 THLLID1 QSET2 Q0~7 THLLID15 QSET2 Q0~7 TH047
SD5182HV100 Functional Specification Page 105 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure Figure Figure Figure Figure Figure Figure 4.14.14.1-45 MAC地址表结构图
MAC地址表基于LLID配置。总共16行，每行48比特。每个LLID对应一个MAC地址。
4.1.3.15 Interrupt
参看寄存器手册相关中断说明。
4.1.3.16 运维特性
 OTDR
XEMAC支持三种OTDR模式：1、专用窗口模式，2、上行重调制模式，3、本地强行启动模式。
支持流氓ONU检测（包括主动检测自己是否流氓 和 周期发送自己ID辅助OLT定位流氓 两方面）
 可测性
XEMAC支持多种可测试特性,包括PCS/RS/MAC层各种统计，报文捕获功能等。
4.1.3.17 Initialization
XEMAC内部的表项的初始化由硬件复位信号的上升沿触发，所有表项初始化为无效，表项完成初始化后输出初始化完成标志。
LLID0 MAC Address[47:0]
LLID1 MAC Address[47:0]
LLID15 MAC Address[47:0]
LLID14 MAC Address[47:0]
47 0
tab_addr[3:0] = {lidx[3:0]}
SD5182HV100 Functional Specification Page 106 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.2 UNI INTERFACE
UNI接口包括内置GEPHY的4个GE电口和1个RGMII接口。内部集成5个相同的GE MAC。
4.2.1 GE MAC
MAC层特性：
 支持MAC层GMII应用；
 支持10/100M和1G/2.5G速率；
 支持全双工、半双工（仅10/100M）；
 支持全双工Pause流控；
 支持1588V2时间同步功能；
 支持帧长从12Byte到9600Byte，最小/最大帧长可基于逻辑通道独立配置；
 支持Pause时间和发送阈值参数可配；
 支持Rx FCS校验和帧长检查；
 支持Rx PAD/FCS剥离、Tx PAD/FCS添加；剥离/添加PAD时，必须剥离FCS；
 支持RX错帧不标错功能，使能可配置；使能打开，将错帧送NP处理，但不影响FCS是否剥离；
 支持Tx IPG/Preamble长度配置，支持RX IPG检查；
 支持RX Preamble（0x55）缺失，必须包含完整的SFD（0xD5）；
 支持EEE能效以太（只支持GMII接口的EEE）；
 支持PTP1588功能，支持入口/出口时戳标记和出口Checksum计算/时戳回传；
 支持基于物理端口的端口使能、端口复位和端口内/外环回功能；
 支持基于物理端口的RMON（RFC2819）和Eth MIB（RFC2665）统计功能；
 支持基于逻辑通道的Rx/Tx 包数/字节数统计功能，支持状态查询和告警。
PCS层特性：
 支持TBI接口，支持SerDes和SGMII应用；
 支持1000BASE-X 和SGMII自协商，支持自协商使能可配置；
 支持线路状态检测和异常状态告警；
支持线路状态变化次数统计。
SD5182HV100 Functional Specification Page 107 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.2.1.1 GE 帧格式
GE MAC 支持的各种帧格式。
Std Pause pkt
Chan Pause pkt
HiGig Data pkt
Std Data pkt
Chan Data pkt
PPP-link pkt
T/L
8808
pause
time FCS
Chan Tag
(4B)
Pad
HiGig-Lite Header (16B)
VLAN
Tag
T/L Data/Payload FCS
6B
first 8B of Infomation
SA
DA SA
opcode
0001
T/L
8808
pause
time SA Pad FCS
DA
0180C2-000001
opcode
0001
6B 2B 2B 2B 42B 4B
6B 6B 0/4/8/12B 2B 46~9600B 4B
VLAN
Tag
DA SA T/L
Chan Tag
(4B)
VLAN
Tag
DA SA T/L Data/Payload FCS
Chan Tag
(4B)
Rest Part of Information FCS
1B 1B 8~9600B 4B
Chan PPP-link pkt
DA
0180C2-000001
64 Byte
12~9.6K Byte
DSA Data pkt
VLAN
Tag
DA SA T/L
DSA Tag
(4B or 8B)
Addr
0xFF
Ctrl
0x03
Protocol Infomation (MPLS, LCP, etc.) FCS
2B
Addr
0xFF
Ctrl
0x03
Protocol
64~9.6K Byte
TPID
(0x8100)
Pri
3bit
Rsvd
6bit
Ch-ID
7bit
Data/Payload FCS
Data/Payload FCS
Figure 4.2-1 GE MAC 格式
SD5182 使用帧格式分别如下。
项目 Norm/Std mode Channel mode DSA mode HiGig mode
SD5182 Std Pause pkt
Std Data pkt
不支持 不支持 不支持
Table 4.2-1 GE MAC Work Mode
Norm/Std mode，流控帧在GE MAC 中Rx 过滤/终结、Tx 生成/发送。数据帧在GE MAC
中透传给NP 或从NP 传给GE MAC。
4.2.1.2 Pause 反压
GE MAC 配置为非通道化模式，MAC 只需要输出1bit 反压状态告知APP 侧，同时根据反
压状态控制MAC Tx 方向的发送。如果反压状态有效，则在帧间隙或者当前帧发送结束
后立即停止下一个数据帧的发送，但是Tx Pause 帧的发送不受影响。
通道化模式下，MAC Rx 方向会从收到通道化Pause 帧，解析处理后，会对每个通道反压
时间进行计时；同时GE MAC 会输出一组反压状态给APP 侧，其中只有被反压的通道对
应bit 有效，由上游模块停止调度对应通道的报文，直至GE MAC 撤销该通道反压状态，
才可继续调度该通道报文。
SD5182HV100 Functional Specification Page 108 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.2.1.3 MIB统计
GE MAC基于端口进行MIB统计，具体统计项如下表： 统计项 统计内容 统计内容解释
GE_RX_PKT
接收总帧数统计计数器。
MAC 接收到的报文个数统计，包长为最小帧长（包含最小帧长）以上，报文不论正确与否。 注意： 普通GE模式：接收报文长度大于等于12byte才统计； 通道化GE模式：接收报文长度大于等于16byte才统计。 以下接收统计都有此限制。
GE_RX_UC_PKT
接收单播帧数统计计数器。
MAC 接收到的正确单播帧的统计，数据帧无错误，且长度为最小帧长～最大帧长。
GE_RX_MC_PKT
接收多播帧数统计计数器。
MAC 接收到的正确组播帧的统计，数据帧无错误，且长度为最小帧长～最大帧长，不包括PAUSE帧。
GE_RX_BC_PKT
接收广播帧数统计计数器。
MAC 接收到的正确广播帧的统计，数据帧无错误，且长度为最小帧长～最大帧长。
GE_RX_PAUSE_PKT
接收流控帧数统计计数器。
MAC 接收到的PAUSE帧个数统计，数据帧无错误，且长度为最小帧长～最大帧长。
GE_RX_UNK_CTRL_PKT
接收未知控制帧数统计计 数器。
MAC 接收到的未知控制帧(TYPE=8808,但OP非0001)统计。数据帧无错误，且长度为最小帧长～最大帧长。
GE_RX_UNDER_MIN_PKT
接收超短帧数统计计数器。
MAC 接收的报文长度小于最小帧长的报文，不论报文正确与否。
GE_RX_MINTO63_PKT
接收短帧数统计计数器。
MAC 接收到的报文长度大于等于最小帧长且小于64Byte的报文计数，不论报文正确与否。
GE_RX_
接收64字
MAC 接收到的包长为64Byte的报文，不论正确
SD5182HV100 Functional Specification Page 109 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
统计项 统计内容 统计内容解释
64_PKT
节帧数统计计数器。
与否。
GE_RX_65TO127_PKT
接收65-127字节帧数统计计数器。
MAC 接收到的包长为65~127Byte的报文，不论正确与否。
GE_RX_128TO255_PKT
接收128-255字节帧数统计计数器。
MAC 接收到的包长为128~255Byte的报文，不论正确与否。
GE_RX_256TO511_PKT
接收256-511字节帧数统计计数器。
MAC 接收到的包长为256~511Byte的报文，不论正确与否。
GE_RX_512TO1023_PKT
接收512-1023字节帧数统计计数器。
MAC 接收到的包长为512~1023Byte的报文，不论正确与否。
GE_RX_1024TO1518_PKT
接收1024-1518字节帧数统计计数器。
MAC 接收到的包长为1024~1518Byte的报文，不论正确与否。
GE_RX_1519T2047_PKT
接收1519-2047字节帧数统计计数器。
MAC 接收到的包长为1519~2047的报文，不论正确与否。
GE_RX_2048TO4095_PKT
接收2048-4095字节帧数统计计数器。
MAC 接收到的包长为2048~4095的报文，不论正确与否。
GE_RX_4096TO9216_PKT
接收4096-9216字节帧数统计计
MAC 接收到的包长为4096~9216的报文，不论正确与否。
SD5182HV100 Functional Specification Page 110 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
统计项 统计内容 统计内容解释
数器。
GE_RX_OVER_MAX_PKT
接收超过最大帧长字节帧数统计计数器。
MAC 接收到的包长大于最大帧长的报文，不论正确与否。
GE_RX_UNDERSIZE_PKT
接收短帧数统计计数器。
MAC 接收到小于64Byte报文个数统计，报文数据正确。
GE_RX_FRAGEMENT_PKT
接收碎片帧统计计数器。
MAC 接收到小于64Byte报文个数统计，报文数据有FCS错误或Align错误。
GE_RX_OVER_SIZE_PKT
接收超长帧数（FCS正确）统计计数器。
MAC 接收超长报文统计。 如果报文长度超过1518Byte，且FCS正确。
GE_RX_JABBER
接收超长帧数（FCS错误）统计计数器。
MAC 接收超长报文且报文错误的统计。如果报文长度超过1518Byte，且FCS错误或Align错误。
GE_RX_FCS_ERR_PKT
接收FCS错误帧计数器。
MAC 接收到的FCS错误或者接收带有错误标志的帧统计，该包长度为Byte的整数倍。 注意：当同时又align error和FCS错误时，只统计到align error中。
GE_RX_ALIGN_ERROR
接收字节对齐错误帧数统计计数器。
MAC 接收方向报文长度不为字节整数倍的报文个数。 注意：当同时又align error和FCS错误时，只统计到align error中。
GE_RX_FIFO_OVERRUN
接收FIFO上溢次数统计计数器。
MAC 接收方向FIFO上溢统计。
GE_CH_TAG_E
在通道化模
在通道化模式下，接收报文的通道化TAG不等于
SD5182HV100 Functional Specification Page 111 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
统计项 统计内容 统计内容解释
RR
式接收的通道TAG错误统计计数器。
配置值CH_TAG（默认为8100），或通道化ID值超过实际允许的值，产生的错误统计计数器。 注意：在通道化GE模式下才有该统计。
GE_RX_BYTE_OK
接收正确帧字节数统计计数器。
MAC 接收到的正确帧 byte 数统计，该数据帧无数据错误，无FCS 错误，无对齐错误,长度为最小帧长～最大帧长；55bit可保证三年不溢出。
GE_RX_BYTE_ERR
接收错误帧字节数统计计数器。
MAC 接收到的错误帧 byte 数统计，该数据帧存在数据错误，FCS 错误，包长不为Byte的整数倍，报文长度小于最小帧长或大于最大帧长中的一种或多种。
GE_RX_MC_BYTE
接收多播帧字节数统计计数器。
MAC 接收到的多播帧 byte 数统计，不论正确与错误。
GE_RX_BC_BYTE
接收广播帧字节数统计计数器
MAC 接收到的广播帧 byte 数统计，不论正确与错误。
GE_TX_PKT
发送总帧数统计计数器。
MAC 成功发送的帧数目。无帧长限制，不论正确与否。
GE_TX_UC_PKT
发送单播帧数统计计数器。
MAC 成功发送单播帧个数统计。数据帧无错误且长度为最小帧长（包含最小帧长，下同）～最大帧长（包含最大帧长，下同）。
GE_TX_MC_PKT
发送多播帧数统计计数器。
MAC 成功发送组播帧个数统计。数据帧无错误且长度为最小帧长～最大帧长。不包括PAUSE帧。
GE_TX_BC_PKT
发送广播帧数统计计数器。
MAC 成功发送广播帧个数统计。数据帧无错误且长度为最小帧长～最大帧长。
GE_TX_PAUSE_PKT
发送流控帧数统计计数器。
MAC 发送的PAUSE帧个数统计。
GE_TX_
发送短帧统
MAC 成功发送的报文长度大于等于最小帧长且小
SD5182HV100 Functional Specification Page 112 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
统计项 统计内容 统计内容解释
MINTO63_PKT
计计数器。
于64Byte的报文计数。
GE_TX_64_PKT
发送64字节帧数统计计数器。
MAC 发送的包长为64Byte的报文，不论正确与否。
GE_TX_65TO127_PKT
发送65-127字节帧数统计计数器。
MAC 发送的包长为65~127Byte的报文，不论正确与否。
GE_TX_128TO255_PKT
发送128-255字节帧数统计计数器。
MAC 发送的包长为128~255Byte的报文，不论正确与否。
GE_TX_256TO511_PKT
发送256-511字节帧数统计计数器。
MAC 发送的包长为256~511Byte的报文，不论正确与否。
GE_TX_512TO1023_PKT
发送512-1023字节帧数统计计数器。
MAC 发送的包长为512~1023Byte的报文，不论正确与否。
GE_TX_1024TO1518_PKT
发送1024-1518字节帧数统计计数器。
MAC 发送的包长为1024~1518Byte的报文，不论正确与否。
GE_RX_1519T2047_PKT
接收1519-2047字节帧数统计计数器。
MAC 接收到的包长为1519~2047的报文，不论正确与否。
GE_TX_2048TO4095_PKT
发送2048-4095字节帧数统计计数器。
MAC 发送的包长为2048～4095的报文，不论正确与否。
SD5182HV100 Functional Specification Page 113 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
统计项 统计内容 统计内容解释
GE_TX_4096T9216_PKT
发送4096-9216字节帧数统计计数器。
MAC 发送的包长为4096～9216的报文，不论正确与否。
GE_TX_OVER_MAX_PKT
发送超过最大帧长字节帧数统计计数器。
MAC 发送超过最大帧长的报文，不论正确与否。
GE_TX_CRC_ERR_PKT
发送CRC错误帧计数器。
MAC 发送CRC错误报文的个数。
GE_TX_SINGLE_COL
发送过程中只发生1次冲突的帧数统计计数器。
半双工模式下，MAC 发生一次冲突即成功发送报文的统计。
GE_TX_MULTI_COL
发送过程中发生多次冲突的帧数统计计数器。
半双工模式下，MAC 发生多次冲突才成功发送的报文的统计。
GE_TX_EXCESS_COL
发送过程中发生迟冲突达到最大重传次数而丢弃的帧数统计计数器。
半双工模式下，MAC 由于冲突达到最大次数导致发送报文失败的报文统计。
GE_TX_LATE_COL
发送过程中发生迟冲突的帧数统计计数器。
半双工模式下，MAC 发生迟冲突的次数，发生迟冲突将导致报文发送失败统计。
GE_TX_DEFERRAL_TRANS
介质忙延迟统计计数器。
半双工模式下，MAC 由于介质繁忙导致延迟发送的报文统计，由于冲突导致的回退不在此统计。
SD5182HV100 Functional Specification Page 114 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
统计项 统计内容 统计内容解释
GE_TX_CRS_LOST
CRS错误统计计数器。
MAC 内部正在发送报文时检测到CRS下降或CRS始终无效的统计。 注意：在crs lost和tx_abort同时发生时，只统计到tx_abort条件下。
GE_TX_ABORT_PKT
发送中途放弃帧计数器。
MAC发送中途放弃帧统计。 当帧已经开始发送但是由于各种原因而造成MAC放弃后续发送时（TX FIFO underrun、excessive collision、late collision等），该计数器加1。
GE_TX_FIFO_UNDERRUN
发送FIFO下溢次数统计计数器。
MAC 发送方向的FIFO下溢统计。
GE_TX_BYTE_OK
发送正确帧字节数统计计数器。
MAC 成功发送帧 byte 数统计。 发送的报文FCS正确，包括发送的PAUSE帧。
GE_TX_BYTE_ERR
发送错误帧字节数统计计数器。
MAC 发送错误帧 byte 数统计。 发送的报文FCS错误，包括发送的PAUSE帧。
GE_TX_MC_BYTE
发送多播帧字节数统计计数器。
MAC 成功发送多播帧 byte 数统计。
GE_TX_BC_BYTE
发送多播帧字节数统计计数器。
MAC 成功发送多播帧 byte 数统计。
Table Table Table Table Table Table 4.24.24.2-2 GE MAC GE MAC GE MAC GE MAC GE MAC GE MAC MIB MIB
4.2.1.4 PCS子层
GE PCS子层实现的功能：
 实现 8B/10B 8B/10B8B/10B 8B/10B编解码， 编解码， 编解码， 编解码， PCS PCS子层与 子层与 子层与 GMIIGMIIGMIIGMII之间的数据传送是 之间的数据传送是 之间的数据传送是 之间的数据传送是 之间的数据传送是 之间的数据传送是 之间的数据传送是 之间的数据传送是 之间的数据传送是 8位的并行数据， 位的并行数据， 位的并行数据， 位的并行数据， 位的并行数据， 位的并行数据， 位的并行数据， PCS PCS 子层接收到 子层接收到 子层接收到 子层接收到 子层接收到 GMIIGMIIGMIIGMII的 8位并行比特流后通过 位并行比特流后通过 位并行比特流后通过 位并行比特流后通过 位并行比特流后通过 位并行比特流后通过 位并行比特流后通过 位并行比特流后通过 位并行比特流后通过 8B/10B 8B/10B8B/10B 8B/10B编码方式形成 编码方式形成 编码方式形成 编码方式形成 编码方式形成 编码方式形成 10 比特 码流，然后通过 码流，然后通过 码流，然后通过 码流，然后通过 码流，然后通过 码流，然后通过 码流，然后通过 10 比特接口（ 比特接口（ 比特接口（ 比特接口（ 比特接口（ TBITBITBI）与物理介质接入子层 ）与物理介质接入子层 ）与物理介质接入子层 ）与物理介质接入子层 ）与物理介质接入子层 ）与物理介质接入子层 ）与物理介质接入子层 ）与物理介质接入子层 ）与物理介质接入子层 ）与物理介质接入子层 PMAPMAPMA相连。反方向， 相连。反方向， 相连。反方向， 相连。反方向， 相连。反方向， 相连。反方向， 相连。反方向， PCS PCS子层在接收到 子层在接收到 子层在接收到 子层在接收到 子层在接收到 子层在接收到 PMAPMAPMA子层来的 子层来的 子层来的 子层来的 10 比特码流后，按 比特码流后，按 比特码流后，按 比特码流后，按 比特码流后，按 比特码流后，按 比特码流后，按 10B/8B 10B/8B10B/8B10B/8B 的解码方式 的解码方式 的解码方式 的解码方式 的解码方式 进行 解码，将恢复出的 解码，将恢复出的 解码，将恢复出的 解码，将恢复出的 解码，将恢复出的 解码，将恢复出的 解码，将恢复出的 解码，将恢复出的 8比特码通过 比特码通过 比特码通过 比特码通过 比特码通过 GMIIGMIIGMIIGMII接口送到 RS 子层。
 对于物理层是半双工模式（ 对于物理层是半双工模式（ 对于物理层是半双工模式（ 对于物理层是半双工模式（ 对于物理层是半双工模式（ 对于物理层是半双工模式（ 对于物理层是半双工模式（ 对于物理层是半双工模式（ 对于物理层是半双工模式（ 对于物理层是半双工模式（ 对于物理层是半双工模式（ 对于物理层是半双工模式（ SGMII SGMIISGMIISGMII特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。 特有）的，生成载波侦听和冲突检测指示。
SD5182HV100 Functional Specification Page 115 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 管理自协商处理，自协商开启时，协商期间状态link_down。
4.2.1.5 SGMII 接口
Serial-GMII（SGMII）接口是MAC 和PHY 之间的一种接口标准，主要用于简化MAC 和
PHY 之间的接口。
下图是SGMII 的结构及应用框图，普通PCS 层是不支持SGMII 功能的，红色部分是为了
支持SGMII 添加的模块。包括：SGMII 自协商、SGMII 发送复制功能、SGMII 接收采样
功能。
SGMII 接口可以和支持SGMII 接口的PHY 对接，可以支持1000M/100M/10M速率。
MAC
TX_SGMII
RX_SGMII
SGMII_AN PCS TBI
GMII
/MII GMII SERDES
TXD_P
TXD_N
RXD_P
RXD_N
PHY
电口
（1000M/100M/10M）
SGMII接口
Figure 4.2-2 SGMII 结构框图
GE PCS 的LINK 指示寄存器PCS_STATE 的led_link_n 指示，会检测线路上是否还
有协商码流，若有协商码流说明正处于协商的过程中，线路不link，若没有协商码
流，则说明协商完成，线路link。这种处理方式在一端自协商、一端强制情况下，
会引起Link 状态指示错误。
芯片按照“宽进严出”的原则进行设计的，即MAC 接收方向：若前导preamble 有
误码，只要SFD 和报文内容没有错误，则按照正确报文接收；发送方向：严格按照
协议发送前导和SFD，不会发送错误的前导码型。
SD5182HV100 Functional Specification Page 116 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.3 OTHER SERVICE INTERFACE
4.3.1 PCIE
4.3.1.1 功能
PCIe接口是芯片的外部接口，提供高速、高性能、点到点、双单工（Dual Simplex）、串行差分信号链路来与片外设备进行互连通讯。
 遵循PCI Express Base 2.0 Specification协议。
 支持根复合体（Root Complex）模式。
 提供2个PCI-E Link，x1 Lane，Lane最高5Gbps。
 支持GEN1模式（2.5Gbps）、GEN2模式（5.0Gbps）。
 支持Type1配置空间。
 支持TLP的最大payload为128Bytes。
 支持内部地址转换机制（iATU）。
 不支持内置DMA。
 支持配置读/写事务、memory读/写事务、IO读/写事务，支持MSI/INTx中断上报机制，支持32位存储器寻址，不支持锁定事务操作。
 支持低功耗的解决方案，支持L1，L1SS。
 不支持PCIe Spec 热插拔机制；支持暴力热插拔（拔板不挂死），即非PCIe协议规范的热插拔，支持异常链路断开。

SD5182HV100 Functional Specification Page 117 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Memory CPU
PHY0
PCIE 2.0 Device
Controller0
PIPE3
RXN
RXP
TXN
TXP
Memory CPU
PHY1
PCIE 2.0 Device
Controller1
PIPE3
RXN
RXP
TXN
TXP
Figure 4.3-1 PCIE 2.0 Device 逻辑框图
4.3.1.2 应用场景
SD5182HV100 Functional Specification Page 118 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PCIe RC
Switch
PCIe EP
存储器
DMAC
RC模式
CPU
2
4GB
系统存储器映射空间
存储器
TLP
TLP
其他子模块
1
3
4
设备ID 厂商ID
状态寄存器 命令寄存器
类代码版本
BIST 头 保留 保留
基地址0
基地址1
基地址2
基地址3
基地址4
基地址5
CardBus CIS指针
子系统厂商
ID
子系统ID
扩展ROM基地址
保留
0x00 0x00 INTp INTx
保留指针
外设
PCI兼容配置寄存器
2
1 CPU读写访问外设
DMAC读写访问外
设
3 其他子模块读写访问外设
4 外设读写访问存储器
Figure 4.3-2 PCIe 接口RC 模式应用框图
当PCIe 接口作为RC 要发起存储器读/写、IO 读/写操作时，首先需要配置对端EP 的PCI
配置头的BAR0～BAR5 寄存器，将存储器读写、IO 读写的基地址写入。0 就是以BAR0
为例（32 位地址空间），当对接的EP 有存储器读写请求时，配置BAR0 的值为存储器操
作基地址的过程。
SD5182HV100 Functional Specification Page 119 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
DW
PCI兼容
配
04
05
未初始化的BAR
06
07
08
10
写入1之后的BAR
写入起始地址之后的BAR
11111111111 0000000000000 1 00 1
31 20 4 3 1 0
11000000000 0000000000000 1 00 1
31 20 4 3 1 0
0=存储器请求
1=IO请求
10=64比特地址解码
00=32比特地址解码
1=可预取
0=不可预取
起始地址的高12比特
xxxxxxxxxxxx 0000000000000 1 00 1
31 20 4 3 1 0
BAR 0
BAR 1
BAR 2
BAR 3
BAR 4
BAR 5
Figure 4.3-3 基地址寄存器的配置示意图
4.3.1.3 数据结构
PcI Express 规范定义了四层结构。为了保持PCI Express 和目前主要硬件驱动程序以及应
用程序的完全兼容。PCI Express 仍然采用了兼容PCI 总线寻址的方式，并使用了与定义
PCI 设备即插即用特性一样的标准规范来定义PCI Express。PCI Express 规范定义的四层
结构如0 所示。
SD5182HV100 Functional Specification Page 120 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Device Core
PCI Express Core Logic
Interface
处理层
数据链路层
物理层
TX RX
Device Core
PCI Express Core Logic
Interface
处理层
数据链路层
物理层
TX RX
Link
Figure 4.3-4 PCIe 分层结构示意图
在PCI Express 结构中．首先由软件层产生数据的读写请求，然后数据将被传送到处理层
(Tranction)，处理层对数据进行封装之后再传到数据链路层(Data Link)．而数据链路层会
为已封装的数据增加时序号(Squence Number)和CRC 纠错信号，以增加传输数据的正确
性和可靠性，然后数据就到达最底层的物理层(Physical Layer)，并通过物理层传送至另一
个PCI Express 设备，并各层进行数据包逆向（拆解）过程（如0 示）。
4.3.1.4 PCIe 接口功能
PCIe 支持下面几种事务类型：
PCIe 存储器请求事务
PCIe 配置请求事务
PCIe 完成请求事务
PCIe 消息请求事务
这几种事务的应用对象如下图所示：
SD5182HV100 Functional Specification Page 121 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PCIePCIePCIePCIe请求 事务的应用对象 地址空间 处理方式 处理对象
内存
读、写
来自于或者发送到内存中的数据
I/O
读、写
来自于或者发送到I/O的数据
配置
读、写
EP相关设置
消息
中断，供应商信息，电源管理，热插拔等
事件信息，通用信息等
4.3.1.5 地址空间分配
PCIEPCIEPCIEPCIE地址空间分配 地址空间分配 地址空间分配 地址空间分配 地址空间分配 地址空间分配 - 容量 地址范围 Master/Slave
PCIE0
4KB
0x10160000 - 0x10160FFF
PCIe0 DBI寄存器地址空间
PCIE0
12KB
0x10161000 - 0x10163FFF
PCIe0 MISC寄存器地址空间
PCIE1
4KB
0x10164000 - 0x10164FFF
PCIe1 DBI寄存器地址空间
PCIE1
12KB
0x10165000 - 0x10167FFF
PCIe1 MISC寄存器地址空间
PCIE0
256MB
0x40000000 - 0x4FFFFFFF
PCIE0 Slave MEMORY地址空间
PCIE0
128MB
0x50000000 - 0x57FFFFFF
PCIE0 Slave配置地址空间
PCIE1
256MB
0x58000000 - 0x67FFFFFF
PCIE1 Slave MEMORY地址空间
PCIE1
128MB
0x68000000 - 0x6FFFFFFF
PCIE1 Slave配置地址空间
如果软件要访问DBI空间的寄存器，需要确保pcie系统控制器0和pcie系统控制器1的控制寄存器7（偏移地址0x101c）的第13bit配置为1，即PCIEn_PERICTRL7[13]=1。
4.3.1.6 iATU功能
4.3.1.6.1 iATU地址转换功能
PCIe接口的iATU功能主要实现与外设进行读写访问时，能够自由进行地址空间的转换。iATU支持32bits和64bits的地址空间的转换。其结构如下图0所示。
SD5182HV100 Functional Specification Page 122 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Region
Number
Limit Address
Lower Address
11000000
31 0
Untranslated
Address
translated
Address
Limit Address
80000000_0000FFFF
Lower Address
80000000_00000000
63 0
63 0
Region
Number
31 0
1100FFFF
支持的64比特和32比特
的地址转换
Figure 4.3-5 iATU地址转换结构示意图
iATU 寄存器访问两种途径：1 本地CPU 读写，通过DBI 总线访问，基地值为分配
的DBI 空间地址0x0；2 配置空间访问（RC 访问EP），其基地址为配置空间地址
0x0。
iATU Register Map(offset address 0x700)
Byte Offset 描述
＋0x200 iATU Viewport 寄存器
＋0x204 iATU Region Control1 寄存器
＋0x208 iATU Region Control2 寄存器
＋0x20c iATU Region 基地址低寄存器
＋0x210 iATU Region 基地址高寄存器
SD5182HV100 Functional Specification Page 123 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Byte Offset 描述
＋0x214
iATU Region 基地址限制限寄存器
＋0x218
iATU Region 目标低地址寄存器
＋0x21c
iATU Region 目标高地址寄存器
iATUiATUiATUiATU详细介绍和 详细介绍和 详细介绍和 详细介绍和 详细介绍和 iATUiATUiATUiATU寄存器详细描述请参考 寄存器详细描述请参考 寄存器详细描述请参考 寄存器详细描述请参考 寄存器详细描述请参考 寄存器详细描述请参考 寄存器详细描述请参考 寄存器详细描述请参考 寄存器详细描述请参考 寄存器详细描述请参考 DWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdf DWC_pcie_dm_reference_Hisilicon.pdf DWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdf DWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdf DWC_pcie_dm_reference_Hisilicon.pdf DWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdf DWC_pcie_dm_reference_Hisilicon.pdf DWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdfDWC_pcie_dm_reference_Hisilicon.pdf DWC_pcie_dm_reference_Hisilicon.pdf文档。
当在PCIe模块初始化完成后，需要配置iATU的相关寄存器才能进一步进行发包其配置流程步骤分两种，一种是Inbound，另外一种是Outbound。对应iATU的两种模式，既可以单独使用其中一种，也可以两种一起使用。
iATU设置步骤如下：
设置iATU View port register为对应的Region号。
设置iATU Region Lower Base Address Register和iATU Region Upper Base Address Register。
设置iATU Region Limit Address Register。
设置iATU Region Lower Target Address Register和iATU Region Upper Target Address Register。
设置iATU Region Control1 Register。
设置iATU Region Control2 Register并使能此iATU Region。
---- 结束
4.3.1.6.2 iATU具体应用
在不同的应用中，事务类型转换和目标地址转换的配置可能不同，提供了地址转换单元（ATU）用来实现本地总线上不同地址的读写操作到PCIe事务类型的转换，也可以通过地址转换单元(ATU)实现目标地址的转换的功能。
对发送方向和接收方向各提供了8个地址转换区，每一个区可单独实现某一种事务类型或地址转换功能。
发送方向的地址转换单元可实现由本地总线操作的地址到PCIe事务类型的转换或者本地总线操作的地址到到PCIe事务地址的转换。
SD5182HV100 Functional Specification Page 124 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
由本地操作地址到PCIe 事务地址转换如下图所示，本地总线上的地址原始地址(Original
address)如果在地址转换驱Region A 的范围内，则地址转换单元将此地址转换为经此地址
转换区域转换后的地址(Translated Address),在PCIe 总线上出现的PCIe 事务中的地址将由
转换后(Translated Address)来代替。
Region A
Base Start address
Base End address
Translated
Address
Original Address
Space
Translated Address
Space
Original address
Translated Address = Target Start Address + Original Address – Base Start address
Target Start address
Target End address
Figure 4.3-6 发送方向地址转换单元实现PCIe 事务地址转换
由本地操作地址到PCIe 事务类型转换如下图所示，地址转换区A 配置为某段地址范围到
PCIe 配置0 事务（CFG Type 0）的转换区域，本地操作地址在地址转换区A 范围内的操
作将会转换为PCIe 总线上的CFG0 操作。地址转换区B 配置为某段地址范围到PCIe 存储
器事务的转换区域，本地操作地址在地址转换区B 范围内的操作将换转换为PCIe 总线上
的存储器事务。
Region A
Base Start address A
Base End address A
CFG0
Original Address
Space
Type
Original Address A
Region B
MEM
Base Start address B
Base End address B
Original Address B
SD5182HV100 Functional Specification Page 125 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure 4.3-7 发送方向地址转换单元实现PCIe 事务类型转换
通过灵活配置每个发送方向的地址转换区域，可以实现多种不同的由本地总线操作到
PCIe 事务的转换方式。
与发送方向类似，接收方向也有地址转换单元可实现PCIe 事务到内部总线的地址转换。
如下图所示，接收方向接收到的PCIe 事务经地址转换区A 或B 转换后，可将对应的操作
转换到地址区域Translated Address 1 或Translated Address 2 上，若Translated Address 1 对
应为DDR 内存地址空间，则可将从PCIe 总线上接收到的满足地址转换区域条件的操作
转化为对DDR 内存内存空间的操作。
Region A
Translated
Address 2
Original Address Space Translated Address
Region B
Translated
Address 1
PCIe Inbound TLP
Target Start address 2
Target End address 2
Target Start address 1
Target End address 1
Figure 4.3-8 接收方向地址转换单元实现PCIe 事务地址转换
4.3.1.6.3 iATU 具体配置
PCIe 最大支持8 个inbound 和8 个outbound 区域，用户可以灵活使用。
以RC 模式为例子，可配置2 个区域：
 Region0
ConfigType0 转换区，将地址范围在此区域范围内的操作转换为ConfigType0 操
作。
 Region1（outbound 方向）
Memory 操作转换区，将地址范围在此区域范围内的操作转换为Memory 操作，
源地址可以是PCIeMEM地址空间的初始地址；目标地址和对接设备EP 的
BAR 地址相匹配。
SD5182HV100 Functional Specification Page 126 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
作为 RC 模式， SD 5182V100 5182V100 5182V1005182V100 5182V100对于 inboundinbound inboundinbound inbound方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 方向的地址，都是全空间译码对接 设备 EP 可以访问 SD 5182V1005182V100 5182V1005182V1005182V100 5182V100的全部地址空间，但需要注意访问 的全部地址空间，但需要注意访问 的全部地址空间，但需要注意访问 的全部地址空间，但需要注意访问 的全部地址空间，但需要注意访问 的全部地址空间，但需要注意访问 的全部地址空间，但需要注意访问 的全部地址空间，但需要注意访问 的全部地址空间，但需要注意访问 的全部地址空间，但需要注意访问 的全部地址空间，但需要注意访问 的全部地址空间，但需要注意访问 的全部地址空间，但需要注意访问 的全部地址空间，但需要注意访问 的全部地址空间，但需要注意访问 的全部地址空间，但需要注意访问 SD 5182V1005182V100 5182V100 5182V100 5182V100的内部寄存器空间，需要使用 的内部寄存器空间，需要使用 的内部寄存器空间，需要使用 的内部寄存器空间，需要使用 的内部寄存器空间，需要使用 的内部寄存器空间，需要使用 的内部寄存器空间，需要使用 的内部寄存器空间，需要使用 的内部寄存器空间，需要使用 的内部寄存器空间，需要使用 的内部寄存器空间，需要使用 的内部寄存器空间，需要使用 的内部寄存器空间，需要使用 single singlesingle single访问操作，不允许使用 访问操作，不允许使用 访问操作，不允许使用 访问操作，不允许使用 访问操作，不允许使用 访问操作，不允许使用 访问操作，不允许使用 访问操作，不允许使用 访问操作，不允许使用 访问操作，不允许使用 burst burst burst操作。
按上述iATU设置步骤分别设置2个iATU区域，其中各寄存器值如下表所示。其中各寄存器的值也可以按照需要进行配置。
PCIEPCIEPCIEPCIE（RC 模式） iATUiATUiATUiATU初始化 参考 值（仅供参考，建议直接和外设对） （仅供参考，建议直接和外设对） （仅供参考，建议直接和外设对） （仅供参考，建议直接和外设对） （仅供参考，建议直接和外设对） （仅供参考，建议直接和外设对） （仅供参考，建议直接和外设对） （仅供参考，建议直接和外设对） （仅供参考，建议直接和外设对） （仅供参考，建议直接和外设对） （仅供参考，建议直接和外设对） （仅供参考，建议直接和外设对） （仅供参考，建议直接和外设对） （仅供参考，建议直接和外设对） （仅供参考，建议直接和外设对） （仅供参考，建议直接和外设对） iATU寄存器名称 Region0参考值 Region1参考值 说明 访问外设CFG空间） 访问外设MEM空间
VideindexRegister
0x0000_0000
（outbond）
0x0000_0001
（outbond）
RegionControl1Register
0x0000_0004
（配置空间）
0x0000_0000
（MEM空间）
RegionControl2Register
0x8000_0000
0x8000_0000
LowerBaseAddressRegister
PCIe Slave地址+软件自定义的外设CFG空间偏移
PCIe Slave地址+软件自定义的外设MEM空间偏移
UpperBaseAddressRegister
0x0000_0000（高32位地址，软件可以自定义）
0x0000_0000（高32位地址，软件可以自定义）
LimitAddressRegister
PCIe Slave地址+软件自定义的外设CFG空间偏移+
0x0FFF
（4K大小）
PCIe Slave地址+软件自定义的外设MEM空间偏移
+ 外设MEM空间大小
SD5182HV100 Functional Specification Page 127 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
iATU 寄存器名称 Region0 参考值 Region1 参考值
说明 访问外设CFG 空间） 访问外设MEM空间
LowerTargetAddressRegister 0x0010_0000 外设BAR
地址低32 位
UpperTargetAddressRegister 0x0000_0000 外设BAR
地址高32 位
4.3.1.7 中断处理
4.3.1.7.1 PCIe RC 模式业务中断
4.3.1.7.1.1 RC 模式接收传统PCI INTx 中断处理参考
Hi1215V100
GIC
PCIe
cpu
外设
中断源
PCIe
MEM_Wr
assert_INTx
Message
deassert_INTx
Message
intx
assert_INTx
Message
deassert_INTx
Message
1
2
3
1 3
Figure 4.3-9 传统PCI INTx 中断处理流程图
在RC 模式下，PCIe Controller 只能够接收INTx 中断，不能发送INTx 中断。对于PCIe
Controller 而言区分INTx Message 进行处理。
SD5182V100 收到INTx 中断之后，其中断处理流程如下（仅供参考）：
SD5182HV100 Functional Specification Page 128 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
外设发出assert_INTx Message，在SD5182V100 PCIe 收到assert_INTx Message，会
将中断线拉高。
在INTx 中断上报是PCIe 默认配置，在使用INTx 之前，软件需要读取外设PCI 配置空间偏
移0x3D，中断脚（interrupt pin）寄存器，确认使用的是哪个INTx，然后将对应的中断号写
到中断线（interrupt line）寄存器将（PCIE 配置空间偏移0x3C）。例如：读取中断脚=0x1，
确认是使用INTa，则根据中断写到中断线（interrupt line）寄存器。
CPU 收到中断，根据中断号，将中断上报给上层业务软件，上层外设业务软件进入中
断处理流程，在该流程里面，上层外设软件清除外设中断（在PCIe 看到的是一个
MEM_WR 报文。
设备ID 厂商ID
状态寄存器 命令寄存器
类代码版本
BIST 头 保留 保留
基地址0
基地址1
基地址2
基地址3
基地址4
基地址5
CardBus CIS指针
子系统ID 子系统厂商ID
扩展ROM基地址
保留
0x00 0x00 INTp INTx
保留指针
00h=IRQ0
01h=IRQ1
02h=IRQ2
03h=IRQ3
.
0Fh=IRQ15
00h=No INTx Pin使用
01h=INTa
02h=INTb
03h=INTc
04h=INTd
Figure 4.3-10 传统PCI INTx 中断分配示意图
外设中断源收到中断清除指令，会发出deassert_INTx Message 报文，在PCIe 收到
deassert_INTx Message 报文，将会在相应中断线（分别对应INTa，INTb，INTc，
INTd）拉低。
----结束
说明
SD5182HV100 Functional Specification Page 129 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.3.1.7.2 Link down异常中断
由于PCIe的CPU总线是AXI总线，而AXI总线是没有time-out机制。为了防止PCIe在异常时，导致总线挂死，所以对于总线异常，针对不同情况，PCIe会有不同处理方法。
场景1：PCIe链路OK，如果报文传输出现错误，由于PCIe Spec针对报文有time-out保护，其会反映到总线异常（可以通过读取PCIe内部寄存器偏移0x8d0寄存器，bit[0]，如果等于1，则总线异常返回Error，如果等于0，则总线返回OK，数据返回全F）。
场景2：PCIe链路异常，导致报文传输异常终止，报文并没有发送到对端（典型例子就是链路断开），所以PCIe对该报文并没有time-out保护。但在AXI 总线侧会有缓冲区保护，在缓冲区里面的总线命令，会自动清空，并返回命令的响应（可以通过读取PCIe内部寄存器偏移0x8d0寄存器，bit[0]，如果等于1，则总线异常返回Error，如果等于0，则总线返回OK，数据返回全F），从而保证总线不会挂死。
对于场景2，PCIe链路会进入link down。而在link down情况下，其处理流程如下图所示：
SD5182HV100 Functional Specification Page 130 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
link up Link down状态
Link up过程中
RX、TX
接地，link
up失败，
进入link
down状态
1、清空PCIe
控制器内部的
buffer,产生
error信息给总
线接口通知系
统
2、确保buffer
已经清空后，
防挂死功能屏
蔽自动进行复
位；如果这时
候，继续有读
写操作，总线
会返回error
（可配置是否
返回error还是
OK）。直到
软件停止发送
数据
如果发生数据
读写异常，产
生相关error信
息上报给总线
接口在本阶
段，PCIe
控制器不
会响应总
线接口访
问操作
软件确认
PCIe异常
link down
处理后。
如果需要
重新业
务，则需
要重新初
始化PCIe
正常link up状态
Link up
成功
如果发生数据读
写异常，产生相
关error信息上报
给总线接口
防挂死生效
PCIe初始化不成功，软件访问
PCIe，PCIe不会响应。
如果故障无法消
除，是无法link
up成功的
Figure 4.3-11 PCIe link down 异常说明图
CORE 收到pcie link down 中断之后，进入中断处理程序，步骤如下：
查询PCIE_CTRL 模块的PERI_PCIE_STAT1[link_req_rst_not_reg]是否为1，如果是1，
则是确定link down 异常中断。
要使用link down 保护，必须在PCIe 初始化阶段，进入link up 之后，使能link down 保护开
关 PCIE_MISC_CTRL 模块的PCIE_CTRL_7 寄存器的bit[29] 等于0x1。
清除PCIE_CTRL 模块的PERI_PCIE11[link_req_rst_not_clr]=1，然后再将
bit[link_req_rst_not_clr]=0。
软件停止PCIe 通道的数据访问。
说明
SD5182HV100 Functional Specification Page 131 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
软复位PCIe控制器（SC_RST_CTRL0[pcie0_srst_n]写0）。等待至少1us时间，复位撤离。
关闭PCIe ltssm 状态机使能,关闭link down保护（PCIE_CTRL的PERI_PCIE7 [pcieN_app_ltssm_enable]=0，SC_RST_CTRL0[pcie0_srst_n]写1）。
---- 结束
如果软件需要进行访问 如果软件需要进行访问 如果软件需要进行访问 如果软件需要进行访问 如果软件需要进行访问 如果软件需要进行访问 如果软件需要进行访问 如果软件需要进行访问 如果软件需要进行访问 如果软件需要进行访问 PCIe PCIePCIe，需要重新初始化 ，需要重新初始化 ，需要重新初始化 ，需要重新初始化 ，需要重新初始化 ，需要重新初始化 ，需要重新初始化 ，需要重新初始化 PCIe PCIePCIe成功，才能重新进行 成功，才能重新进行 成功，才能重新进行 成功，才能重新进行 成功，才能重新进行 成功，才能重新进行 成功，才能重新进行 成功，才能重新进行 成功，才能重新进行 PCIe PCIePCIe业务， 业务， 业务， 否则继续访问 否则继续访问 否则继续访问 否则继续访问 否则继续访问 否则继续访问 PCIe PCIePCIe，会导致总线挂死。 ，会导致总线挂死。 ，会导致总线挂死。 ，会导致总线挂死。 ，会导致总线挂死。 ，会导致总线挂死。 ，会导致总线挂死。 ，会导致总线挂死。 ，会导致总线挂死。
4.3.1.8 初始化
Pcie的初始化流程如下图所示。
SD5182HV100 Functional Specification Page 132 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
pcie时钟复位初始化
pcie控制器link
disable
配置pcie slave端访
问timeout时间
配置控制器工作模式
切换到DBI空间
配置iATU
切换到MISC空间
使能pcie link up
Link up？？
切换到DBI空间，配置
切换gen2，然后切换
到MISC空间
Link up？？
配置IO/MEM responce
和master总线使能
是
是
否
打印错误
否
打印错误
Pcie初始化成功
SD5182HV100 Functional Specification Page 133 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure Figure Figure Figure Figure Figure Figure 4.34.34.3-12 PCIePCIePCIePCIe初始化流程图
初始化PCIE的时钟复位
− 配置管脚复用 配置管脚复用 配置管脚复用 配置管脚复用 配置管脚复用 配置管脚复用
配置 wifiwifiwifiwifi的复位管脚，并撤离 的复位管脚，并撤离 的复位管脚，并撤离 的复位管脚，并撤离 的复位管脚，并撤离 的复位管脚，并撤离 的复位管脚，并撤离 的复位管脚，并撤离 的复位管脚，并撤离 WIFI WIFI 复位（注意 wifiwifiwifi 解复位的时间，注意要 解复位的时间，注意要 解复位的时间，注意要 解复位的时间，注意要 解复位的时间，注意要 解复位的时间，注意要 解复位的时间，注意要 解复位的时间，注意要 解复位的时间，注意要 解复位的时间，注意要 区别产品板和验证版） 区别产品板和验证版） 区别产品板和验证版） 区别产品板和验证版） 区别产品板和验证版） 区别产品板和验证版） 区别产品板和验证版） 区别产品板和验证版） 区别产品板和验证版） 区别产品板和验证版）
− 打开 pcie0 pcie0pcie0，pcie1 pcie1pcie1的参考时钟 的参考时钟 的参考时钟 的参考时钟 的参考时钟
配置 0x14880020 0x14880020 0x14880020 0x14880020 0x148800200x14880020的第 13bit 13bit 13bit（pcie0 pcie0pcie0）， 14bit 14bit 14bit（pcie1 pcie1pcie1）为 0x10x10x1
− 撤离 pciePHY pciePHYpciePHY 和控制器的总复位 和控制器的总复位 和控制器的总复位 和控制器的总复位 和控制器的总复位 和控制器的总复位 和控制器的总复位 和控制器的总复位
配置 0x1488002c 0x1488002c 0x1488002c 0x1488002c 0x1488002c0x1488002c的第 21bit 21bit 21bit（pcie0 pcie0pcie0）， 22bit 22bit 22bit（pcie1 pcie1pcie1）为 0x10x10x1
− 撤离 APBAPB 接口的复位 接口的复位 接口的复位 接口的复位 接口的复位
配置 0x14880034 0x14880034 0x14880034 0x14880034 0x148800340x14880034第 6bit 6bit6bit（pcie0 pcie0pcie0）， 7bit 7bit7bit（pcie1 pcie1pcie1）为 0x10x1
等待 10us; 10us;
− 复位 PCSPCSPCS
配置 PCIe MISCPCIe MISCPCIe MISCPCIe MISCPCIe MISC PCIe MISCPCIe MISC 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 0x103C0x103C0x103C 0x103C ，第 1bit 1bit1bit为 0x0 0x0
等待 10us; 10us;
− 复位 PCIePCIePCIePCIe控制器
配置 PCIe MISCPCIe MISCPCIe MISCPCIe MISCPCIe MISC PCIe MISCPCIe MISC 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 0x103C0x103C0x103C 0x103C ，第 31bit 31bit 31bit为 0x00x00x0
等待 10us; 10us;
− 撤离 pcie PHY pcie PHYpcie PHY 的复位 的复位 的复位
配置 0x14880034 0x14880034 0x14880034 0x14880034 0x148800340x14880034第 8bit 8bit8bit（pcie0 pcie0pcie0），第 ），第 ），第 9bit 9bit9bit（pcie1 pcie1pcie1）为 0x10x10x1
等待 1ms ；
− 撤离 PCSPCSPCS
配置 PCIe MISCPCIe MISCPCIe MISCPCIe MISCPCIe MISC PCIe MISCPCIe MISC 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 0x1030x1030x103 0x103C，第 1bit 1bit1bit为 0x1 0x1
等待 250us; 250us; 250us;250us;
− 复位 PCIePCIePCIePCIe控制器
配置 PCIe MISCPCIe MISCPCIe MISCPCIe MISCPCIe MISC PCIe MISCPCIe MISC 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 寄存器，偏移地址为 0x103C0x103C0x103C 0x103C ，第 31bit 31bit 31bit为 0x10x10x1
等待 10us; 10us;
disable pcie的link使能 ，配置PERI_PCIE7[11]为0；
设置 pcie 访问EP端的timeout时间，配置PERI_PCIE6为0x80000000；
设置pcie控制器为RC模式， 配置PERI_PCIE0[31:28]为0b0100；
寄存器访问切换到DBI空间，配置PERI_PCIE7[13]为1；
使能PCIe 的IO/MEM response，master enable，配置PCIEx DBI空间的commad_status_reg（0x4）寄存器[2:0]为0b111；
设置iATU（参考iATU 初始化章节，但是实际配置值需要根据项目修改）
寄存器访问切换到MISC空间，配置PERI_PCIE7[13]为0；
SD5182HV100 Functional Specification Page 134 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
使能pcie link up，并屏蔽cfg_aer_rc_err_int和inta中断，配置PERI_PCIE7[11]，[21]，[25]为1；
判断pcie是否成功link up，读取PERI_PCIE_STAT0，如果等于 0x8020则表示gen1模式link up成功；
寄存器访问切换到DBI空间，配置PERI_PCIE7[13]为1；
切换到gen2速率，配置DBI空间的GEN2_CTRL_OFF(0x80c)的[17]为1；
寄存器访问切换到MISC空间，配置PERI_PCIE7[13]为0；
判断pcie是否成功link up，读取PERI_PCIE_STAT4，如果[17]为1，并且[23:18]为0x11则表示gen2模式成功link up。
完成以上配置步骤之后，PCIE总线开始枚举过程。
 上电时， 上电时， 上电时， 上电时， 软件仅知道总线 软件仅知道总线 软件仅知道总线 软件仅知道总线 软件仅知道总线 软件仅知道总线 软件仅知道总线 0的存在，但并不知道总线 的存在，但并不知道总线 的存在，但并不知道总线 的存在，但并不知道总线 的存在，但并不知道总线 的存在，但并不知道总线 的存在，但并不知道总线 的存在，但并不知道总线 的存在，但并不知道总线 的存在，但并不知道总线 的存在，但并不知道总线 0上挂接的设备类型 上挂接的设备类型 上挂接的设备类型 上挂接的设备类型 上挂接的设备类型 上挂接的设备类型 上挂接的设备类型 上挂接的设备类型 。
 通过 枚举过程将设置 枚举过程将设置 枚举过程将设置 枚举过程将设置 枚举过程将设置 枚举过程将设置 枚举过程将设置 PCIEPCIEPCIEPCIE系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 系统中的设备信息，枚举是按照深度优先来进行搜 索的 。
具体的枚举过程如下：
启动设备0，枚举软件尝试着读取每台设备中功能0的厂商ID，如果从总线0返回的error，则表明该设备不存在，否则连接上一个设备。
如果检测到端点设备，则枚举结束；如果检测到桥设备，则软件执行配置读操作，将设备的头类型字段读取并解析。
软件执行配置写操作，设置该设备的主总线号、二级总线号和从属总线号，然后按照步骤1和步骤2往下一级总线继续搜索。
----结束
SD5182HV100 Functional Specification Page 135 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.3.1.9 DFX
4.3.1.9.1 PCIe 内部寄存器空间
PCIE_CTRL_7 Bit[13]
serdes_ctrl 寄存器
等于1
PCIE_CTRL_22
~
PCIE_CTRL_35
pcie_misc_ctrl
pcie 内部寄存器空间(DBI空间)
PCIe capability相关
iATU相关
等于0
eDMA相关
PCIe 虚拟化相关
PCIE_CTRL_0
PCIE_CTRL_22
PCIe DFX相关
Figure 4.3-13 PCIe 相关寄存器结构意图
通过设置PERI_PCIE7[dbi_cs]=1，则访问的是pcie 内部寄存器空间（DBI 空间），PCIe
兼容的配置空间寄存器，eDMA，iATU 等都在该寄存器空间里面。
4.3.1.9.2 PCIe 向对接外设发读操作，报文不返回
 PCIe 向对接外设发读操作，报文长时间不成功返回,超出time-out 时间，要上报
中断slv_err_int（默认不打开该功能，需要软件配置，寄存器在pcie），同时
也支持总线err 屏蔽（PCIe 内部寄存器，DBI 空间，偏移0x8d0 的bit[0]，如果
等于1，则返回err，如果是0，则屏蔽err，返回OK）。如果打开了
PERI_PCIE7 的bit[30:29]，如果遇到总线err，则会收到中断。Slv_err_int 和
link down 中断是同一个中断线，收到link down 中断后，先查询区分。
SD5182HV100 Functional Specification Page 136 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 PCIe PCIePCIe通过 PCIE_CTRLCIE_CTRLCIE_CTRLCIE_CTRLCIE_CTRLCIE_CTRLCIE_CTRLCIE_CTRL模块的 模块的 模块的 PERI_PCIE_STAT6PERI_PCIE_STAT6PERI_PCIE_STAT6PERI_PCIE_STAT6PERI_PCIE_STAT6PERI_PCIE_STAT6 PERI_PCIE_STAT6PERI_PCIE_STAT6PERI_PCIE_STAT6PERI_PCIE_STAT6 PERI_PCIE_STAT6PERI_PCIE_STAT6PERI_PCIE_STAT6[pcie_slv_err_int pcie_slv_err_intpcie_slv_err_intpcie_slv_err_intpcie_slv_err_int pcie_slv_err_intpcie_slv_err_intpcie_slv_err_intpcie_slv_err_int pcie_slv_err_int pcie_slv_err_int ]等于 1，指示 ，指示 ，指示 slv_err_int slv_err_int slv_err_intslv_err_int slv_err_intslv_err_intslv_err_int slv_err_int slv_err_int 。
 PCIe0 PCIe0PCIe0PCIe0通过查询寄存器 通过查询寄存器 通过查询寄存器 通过查询寄存器 通过查询寄存器 通过查询寄存器 通过查询寄存器 PCIE_MISC_CTRL PCIE_MISC_CTRL PCIE_MISC_CTRL PCIE_MISC_CTRL PCIE_MISC_CTRL PCIE_MISC_CTRL PCIE_MISC_CTRL PCIE_MISC_CTRL PCIE_MISC_CTRL PCIE_MISC_CTRL PCIE_MISC_CTRL 模块的 PERI_PCIE_STAT1 PERI_PCIE_STAT1PERI_PCIE_STAT1PERI_PCIE_STAT1PERI_PCIE_STAT1 PERI_PCIE_STAT1PERI_PCIE_STAT1PERI_PCIE_STAT1PERI_PCIE_STAT1 PERI_PCIE_STAT1PERI_PCIE_STAT1PERI_PCIE_STAT1[link_req_rst_not_reg][link_req_rst_not_reg][link_req_rst_not_reg][link_req_rst_not_reg] [link_req_rst_not_reg][link_req_rst_not_reg] [link_req_rst_not_reg] [link_req_rst_not_reg] [link_req_rst_not_reg][link_req_rst_not_reg] [link_req_rst_not_reg] [link_req_rst_not_reg] [link_req_rst_not_reg] 查询为 查询为 查询为 1，表示 linkdownlinkdownlinkdown linkdown linkdownlinkdown。
4.3.1.9.3 PCIe通过报文paylaod长度和读请求长度查询
PCIe在大流量业务时，往往收发的是burst长度的报文，涉及到报文载荷（payload）和读请求长度的要求。重点针对与收、发包等操作有密切关系的Max_Playload_Size和Max_Read_Request_Size相关的几个寄存器见下图设置进行如下介绍。
设备能力寄存器中的“所支持的Max_Payload_Size”域段表示PCIE设备所能支持的TLP包的最大数据载荷长度，本设备所能接收和发送的所有TLP包的数据长度都不能超过此域段所表示的数据长度。对于SD5182V100来说，所支持的Max_Payload_Size值为128字节（本域段二进制值为“000”）。
Figure Figure Figure Figure Figure Figure Figure 4.34.34.3-14 PCIEPCIEPCIEPCIE设备能力寄存器（只读） 设备能力寄存器（只读） 设备能力寄存器（只读） 设备能力寄存器（只读） 设备能力寄存器（只读） 设备能力寄存器（只读） 设备能力寄存器（只读） 设备能力寄存器（只读） 设备能力寄存器（只读） 设备能力寄存器（只读） 设备能力寄存器（只读）
设备控制寄存器中的“Max_Payload_Size”域段，bit[7:5]，为软件为本设备实际配置的最大数据载荷长度。对于Hi1215V100来说，只支持“000”代表最大有效载荷为128字节，默认是“000”，128字节。
设备控制寄存器中的“Max_Read_Request_Size”域段，bit[14:12]，为软件为本设备配置的最大读请求数据长度。支持的“Max_Read_Request_Size”配置值及对应的读请求数据长度如下：
 0000 ：最大读请求 ：最大读请求 ：最大读请求 ：最大读请求 ：最大读请求 ：最大读请求 128 字节。 字节。 字节。
 0001 ：最大读请求 ：最大读请求 ：最大读请求 ：最大读请求 ：最大读请求 ：最大读请求 256 字节。 字节。 字节。
 0010 ：最大读请求 ：最大读请求 ：最大读请求 ：最大读请求 ：最大读请求 ：最大读请求 512 字节 （默认） （默认） （默认） （默认） 。
 其他：保留编码。 其他：保留编码。 其他：保留编码。 其他：保留编码。 其他：保留编码。 其他：保留编码。 其他：保留编码。 其他：保留编码。
SD5182HV100 Functional Specification Page 137 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure Figure Figure Figure Figure Figure Figure 4.34.34.3-15 PCIEPCIEPCIEPCIE设备控制能力寄存器 设备控制能力寄存器 设备控制能力寄存器 设备控制能力寄存器 设备控制能力寄存器 设备控制能力寄存器 设备控制能力寄存器 设备控制能力寄存器 设备控制能力寄存器
4.3.1.9.4 PCIe内部状态机可查看
PCIe查看内部状态机xmlh_ltssm_state[5:0]查询PCIE控制器工作状态，正常工作时为0x11,其他情况为异常。
访问寄存器地址PERI_PCIE_STAT4[pcie_xmlh_state]。
4.3.1.9.5 对接器件PCIe Credit状态
可通过查询对接器件PCIe Credit状态，内部寄存器空间偏移0x730，0x734，0x738。在发包正常情况下，该寄存器值实时更新。
4.3.1.9.6 重传缓冲区空或非空标志
通过查询内部PCIE_VENDOR_CTRL寄存器空间寄存器QUEUE_STATUS，查看重传缓冲区空或非空标志，报文没有返回指示。
4.3.1.9.7 支持各种报文异常状态查询
通过查询内部寄存器空间偏移0x104和0x110查看报文异常状态。
PCIePCIePCIePCIe不可修正的错误状态 寄存器 （偏移 0x1040x1040x1040x1040x104） bit 默认值 属性 说明
31:2531:2531:2531:2531:25
RsvdZ RsvdZRsvdZRsvdZ
0x00
Reserved Reserved ReservedReserved
24
RW1CSRW1CS RW1CS
0x00
AtomicOp Egress Blocked StatusAtomicOp Egress Blocked StatusAtomicOp Egress Blocked StatusAtomicOp Egress Blocked StatusAtomicOp Egress Blocked StatusAtomicOp Egress Blocked Status AtomicOp Egress Blocked StatusAtomicOp Egress Blocked StatusAtomicOp Egress Blocked StatusAtomicOp Egress Blocked StatusAtomicOp Egress Blocked StatusAtomicOp Egress Blocked Status AtomicOp Egress Blocked StatusAtomicOp Egress Blocked StatusAtomicOp Egress Blocked Status AtomicOp Egress Blocked StatusAtomicOp Egress Blocked StatusAtomicOp Egress Blocked Status AtomicOp Egress Blocked StatusAtomicOp Egress Blocked Status AtomicOp Egress Blocked Status AtomicOp Egress Blocked StatusAtomicOp Egress Blocked Status
0：AtomicOp Egress is not BlockedAtomicOp Egress is not BlockedAtomicOp Egress is not BlockedAtomicOp Egress is not BlockedAtomicOp Egress is not BlockedAtomicOp Egress is not Blocked AtomicOp Egress is not BlockedAtomicOp Egress is not BlockedAtomicOp Egress is not BlockedAtomicOp Egress is not BlockedAtomicOp Egress is not BlockedAtomicOp Egress is not Blocked AtomicOp Egress is not BlockedAtomicOp Egress is not BlockedAtomicOp Egress is not Blocked AtomicOp Egress is not BlockedAtomicOp Egress is not BlockedAtomicOp Egress is not BlockedAtomicOp Egress is not Blocked AtomicOp Egress is not Blocked AtomicOp Egress is not Blocked AtomicOp Egress is not Blocked ；
1：AtomicOp Egress is BlockedAtomicOp Egress is BlockedAtomicOp Egress is BlockedAtomicOp Egress is BlockedAtomicOp Egress is BlockedAtomicOp Egress is Blocked AtomicOp Egress is BlockedAtomicOp Egress is BlockedAtomicOp Egress is BlockedAtomicOp Egress is BlockedAtomicOp Egress is BlockedAtomicOp Egress is Blocked AtomicOp Egress is BlockedAtomicOp Egress is BlockedAtomicOp Egress is Blocked AtomicOp Egress is BlockedAtomicOp Egress is Blocked AtomicOp Egress is Blocked AtomicOp Egress is Blocked 。
23:2123:2123:2123:2123:21
RsvdZ RsvdZRsvdZRsvdZ
0x00
Reserved Reserved ReservedReserved
SD5182HV100 Functional Specification Page 138 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
bit 默认值 属性 说明
20
RW1CSRW1CS RW1CS
0x00
Unsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error Status Unsupported Request Error StatusUnsupported Request Error Status Unsupported Request Error StatusUnsupported Request Error Status Unsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error Status Unsupported Request Error StatusUnsupported Request Error Status
0：未检测到 Unsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request Error Unsupported Request ErrorUnsupported Request Error Unsupported Request ErrorUnsupported Request ErrorUnsupported Request Error Unsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request Error；
1：检测到 Unsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request Error Unsupported Request ErrorUnsupported Request Error Unsupported Request Error Unsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request ErrorUnsupported Request Error。
19
RW1CSRW1CS RW1CS
0x00
ECRC Error StatusECRC Error StatusECRC Error StatusECRC Error Status ECRC Error StatusECRC Error StatusECRC Error StatusECRC Error StatusECRC Error StatusECRC Error StatusECRC Error Status ECRC Error Status ECRC Error Status
0：未检测到 ECRC ErrorECRC Error ECRC Error ECRC ErrorECRC ErrorECRC ErrorECRC ErrorECRC Error；
1：检测到 ECRC ErrorECRC ErrorECRC ErrorECRC Error ECRC ErrorECRC ErrorECRC ErrorECRC ErrorECRC Error。
18
RW1CSRW1CS RW1CS
0x00
Malformed TLP StatusMalformed TLP Status Malformed TLP StatusMalformed TLP StatusMalformed TLP StatusMalformed TLP Status Malformed TLP StatusMalformed TLP StatusMalformed TLP StatusMalformed TLP StatusMalformed TLP StatusMalformed TLP Status Malformed TLP Status Malformed TLP StatusMalformed TLP Status
0：未检测到 Malformed TLPMalformed TLPMalformed TLP Malformed TLPMalformed TLPMalformed TLPMalformed TLP Malformed TLPMalformed TLPMalformed TLPMalformed TLP；
1：检测到 Malformed TLPMalformed TLPMalformed TLP Malformed TLPMalformed TLPMalformed TLPMalformed TLP Malformed TLPMalformed TLPMalformed TLPMalformed TLP。
17
RW1CSRW1CS RW1CS
0x00
Receiver Overflow Status Receiver Overflow StatusReceiver Overflow StatusReceiver Overflow Status Receiver Overflow StatusReceiver Overflow StatusReceiver Overflow StatusReceiver Overflow Status Receiver Overflow StatusReceiver Overflow Status Receiver Overflow StatusReceiver Overflow StatusReceiver Overflow Status Receiver Overflow Status Receiver Overflow Status
0：未检测到 Receiver Overflow Receiver OverflowReceiver OverflowReceiver Overflow Receiver OverflowReceiver OverflowReceiver OverflowReceiver Overflow Receiver OverflowReceiver OverflowReceiver OverflowReceiver Overflow；
1：检测到 Receiver Overflow Receiver OverflowReceiver OverflowReceiver Overflow Receiver OverflowReceiver OverflowReceiver OverflowReceiver Overflow Receiver OverflowReceiver Overflow Receiver Overflow。
16
RW1CSRW1CS RW1CS
0x00
Unexpected Completion StatusUnexpected Completion StatusUnexpected Completion Status Unexpected Completion StatusUnexpected Completion Status Unexpected Completion StatusUnexpected Completion Status Unexpected Completion StatusUnexpected Completion Status Unexpected Completion StatusUnexpected Completion StatusUnexpected Completion StatusUnexpected Completion Status Unexpected Completion StatusUnexpected Completion StatusUnexpected Completion StatusUnexpected Completion StatusUnexpected Completion Status Unexpected Completion StatusUnexpected Completion StatusUnexpected Completion StatusUnexpected Completion Status
0：未检测到 Unexpected CompletionUnexpected CompletionUnexpected Completion Unexpected CompletionUnexpected Completion Unexpected CompletionUnexpected Completion Unexpected CompletionUnexpected Completion Unexpected CompletionUnexpected CompletionUnexpected CompletionUnexpected Completion Unexpected CompletionUnexpected CompletionUnexpected Completion；
1：检测到 Unexpected CompletionUnexpected CompletionUnexpected Completion Unexpected CompletionUnexpected Completion Unexpected CompletionUnexpected Completion Unexpected CompletionUnexpected Completion Unexpected CompletionUnexpected CompletionUnexpected CompletionUnexpected Completion Unexpected CompletionUnexpected CompletionUnexpected Completion。
15
RW1CSRW1CS RW1CS
0x00
Completer Abort Status Completer Abort StatusCompleter Abort StatusCompleter Abort StatusCompleter Abort Status Completer Abort Status Completer Abort StatusCompleter Abort StatusCompleter Abort StatusCompleter Abort StatusCompleter Abort StatusCompleter Abort StatusCompleter Abort StatusCompleter Abort Status Completer Abort StatusCompleter Abort StatusCompleter Abort StatusCompleter Abort Status
0：未检测到 Completer Abort Completer AbortCompleter AbortCompleter AbortCompleter Abort Completer Abort Completer AbortCompleter AbortCompleter AbortCompleter AbortCompleter AbortCompleter Abort；
1：检测到 Completer AbortCompleter AbortCompleter AbortCompleter AbortCompleter AbortCompleter Abort Completer Abort Completer AbortCompleter AbortCompleter AbortCompleter AbortCompleter AbortCompleter Abort。
14
RW1CSRW1CS RW1CS
0x00
Completion Completion Completion Completion Completion Completion Completion Completion Completion Timeout StatusTimeout StatusTimeout StatusTimeout Status Timeout StatusTimeout StatusTimeout StatusTimeout Status Timeout StatusTimeout Status Timeout Status
0：未检测到 Completion Timeout Completion TimeoutCompletion TimeoutCompletion TimeoutCompletion Timeout Completion TimeoutCompletion TimeoutCompletion TimeoutCompletion TimeoutCompletion TimeoutCompletion TimeoutCompletion TimeoutCompletion Timeout Completion TimeoutCompletion Timeout；
1：检测到 Completion TimeoutCompletion TimeoutCompletion TimeoutCompletion TimeoutCompletion TimeoutCompletion Timeout Completion TimeoutCompletion TimeoutCompletion TimeoutCompletion TimeoutCompletion TimeoutCompletion TimeoutCompletion TimeoutCompletion Timeout Completion TimeoutCompletion Timeout
13
RW1CSRW1CS RW1CS
0x00
Flow Control Protocol Error Status Flow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error Status Flow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error Status Flow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error StatusFlow Control Protocol Error Status
0：未检测到 Flow Control Protocol Error Flow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol Error Flow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol Error Flow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol Error；
1：检测到 Flow Control Protocol Error Flow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol Error Flow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol Error Flow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol Error Flow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol ErrorFlow Control Protocol Error。
12
RW1CSRW1CS RW1CS
0x00
Poisoned TLP Status Poisoned TLP StatusPoisoned TLP StatusPoisoned TLP StatusPoisoned TLP StatusPoisoned TLP Status Poisoned TLP StatusPoisoned TLP StatusPoisoned TLP StatusPoisoned TLP StatusPoisoned TLP StatusPoisoned TLP Status Poisoned TLP Status Poisoned TLP StatusPoisoned TLP Status
0：未检测到 Poisoned TLP Poisoned TLPPoisoned TLPPoisoned TLPPoisoned TLPPoisoned TLP Poisoned TLPPoisoned TLPPoisoned TLPPoisoned TLP；
1：检测到 Poisoned TLPPoisoned TLPPoisoned TLPPoisoned TLPPoisoned TLPPoisoned TLPPoisoned TLP Poisoned TLPPoisoned TLPPoisoned TLPPoisoned TLP。
11:611:611:611:6
RsvdZ RsvdZRsvdZRsvdZ
0x00
Reserved Reserved ReservedReserved
5
RO
0x00
Surprise Down Error Status Surprise Down Error StatusSurprise Down Error StatusSurprise Down Error StatusSurprise Down Error StatusSurprise Down Error StatusSurprise Down Error Status Surprise Down Error StatusSurprise Down Error StatusSurprise Down Error StatusSurprise Down Error StatusSurprise Down Error StatusSurprise Down Error StatusSurprise Down Error StatusSurprise Down Error StatusSurprise Down Error StatusSurprise Down Error StatusSurprise Down Error StatusSurprise Down Error Status Surprise Down Error Status Surprise Down Error StatusSurprise Down Error Status，该版本 ，该版本 ，该版本 ，该版本 IP 不支 持。
4
RW1CSRW1CS RW1CS
0x00
Data Link Protocol Error StatusData Link Protocol Error Status Data Link Protocol Error Status Data Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error Status Data Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error Status Data Link Protocol Error Status Data Link Protocol Error Status
0：未检测到 Data Link Protocol ErrorData Link Protocol Error Data Link Protocol Error Data Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol Error Data Link Protocol ErrorData Link Protocol ErrorData Link Protocol Error Data Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol Error；
1：检测到 Data Link Protocol ErrorData Link Protocol Error Data Link Protocol Error Data Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol Error Data Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol Error。
3:13:13:1
RsvdZ RsvdZRsvdZRsvdZ
0x00
Reserved Reserved ReservedReserved 。
0
RsvdZ RsvdZRsvdZRsvdZ
0x00
未定义。
SD5182HV100 Functional Specification Page 139 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PCIe PCIe PCIe PCIe PCIe 可修正的错误状态寄存器（偏移 可修正的错误状态寄存器（偏移 可修正的错误状态寄存器（偏移 可修正的错误状态寄存器（偏移 可修正的错误状态寄存器（偏移 可修正的错误状态寄存器（偏移 可修正的错误状态寄存器（偏移 可修正的错误状态寄存器（偏移 可修正的错误状态寄存器（偏移 可修正的错误状态寄存器（偏移 可修正的错误状态寄存器（偏移 可修正的错误状态寄存器（偏移 可修正的错误状态寄存器（偏移 可修正的错误状态寄存器（偏移 0x1100x1100x1100x1100x110） bit 默认值 属性 说明
31:1431:1431:1431:1431:14
RsvdZ RsvdZRsvdZRsvdZ
0x00
Reserved Reserved ReservedReserved
13
RW1CSRW1CS RW1CS
0x00
Advisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory Non-Fatal Error Status Fatal Error Status Fatal Error StatusFatal Error StatusFatal Error StatusFatal Error StatusFatal Error StatusFatal Error StatusFatal Error StatusFatal Error Status Fatal Error Status Fatal Error Status
0：未检测到 Advisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory Non-Fatal ErrorFatal Error Fatal ErrorFatal ErrorFatal ErrorFatal ErrorFatal ErrorFatal ErrorFatal ErrorFatal Error；
1：检测到 Advisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory Non-Fatal Error Fatal Error Fatal ErrorFatal ErrorFatal ErrorFatal ErrorFatal ErrorFatal Error。
12
RW1CSRW1CS RW1CS
0x00
Reply Timer Timeout Status Reply Timer Timeout Status Reply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout Status Reply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout Status Reply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout Status Reply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout Status
0：未检测到 Reply Timer Timeout Reply Timer Timeout Reply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer Timeout Reply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer Timeout Reply Timer TimeoutReply Timer Timeout；
1：检测到 Reply Timer Timeout Reply Timer Timeout Reply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer Timeout Reply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer Timeout Reply Timer TimeoutReply Timer Timeout。
11:911:911:911:9
RsvdZ RsvdZRsvdZRsvdZ
0x00
Reserved Reserved ReservedReserved
8
RW1CSRW1CS RW1CS
0x00
REPLAY_NUM Rollover Status REPLAY_NUM Rollover StatusREPLAY_NUM Rollover StatusREPLAY_NUM Rollover StatusREPLAY_NUM Rollover StatusREPLAY_NUM Rollover StatusREPLAY_NUM Rollover StatusREPLAY_NUM Rollover StatusREPLAY_NUM Rollover StatusREPLAY_NUM Rollover StatusREPLAY_NUM Rollover StatusREPLAY_NUM Rollover Status REPLAY_NUM Rollover StatusREPLAY_NUM Rollover Status REPLAY_NUM Rollover StatusREPLAY_NUM Rollover Status REPLAY_NUM Rollover Status REPLAY_NUM Rollover StatusREPLAY_NUM Rollover Status
0：未检测到 REPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM Rollover REPLAY_NUM Rollover REPLAY_NUM RolloverREPLAY_NUM Rollover ；
1：检测到 REPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM Rollover REPLAY_NUM Rollover REPLAY_NUM RolloverREPLAY_NUM Rollover 。
7
RW1CSRW1CS RW1CS
0x00
Bad DLLP Status Bad DLLP StatusBad DLLP StatusBad DLLP StatusBad DLLP StatusBad DLLP StatusBad DLLP StatusBad DLLP Status Bad DLLP Status Bad DLLP Status
0：未检测到 Bad DLLP Bad DLLPBad DLLPBad DLLPBad DLLPBad DLLP；
1：检测到 Bad DLLP Bad DLLPBad DLLPBad DLLPBad DLLPBad DLLP。
6
RW1CSRW1CS RW1CS
0x00
Bad TLP Status Bad TLP StatusBad TLP StatusBad TLP StatusBad TLP StatusBad TLP StatusBad TLP Status Bad TLP Status Bad TLP StatusBad TLP Status
0：未检测到 Bad TLP Bad TLPBad TLPBad TLPBad TLP；
1：检测到 Bad TLP Bad TLPBad TLPBad TLPBad TLP。
5:15:15:1
RsvdZ RsvdZRsvdZRsvdZ
0x00
Reserved Reserved ReservedReserved
0
RW1CSRW1CS RW1CS
0x00
Receiver Error Status Receiver Error StatusReceiver Error StatusReceiver Error Status Receiver Error StatusReceiver Error StatusReceiver Error StatusReceiver Error StatusReceiver Error StatusReceiver Error StatusReceiver Error StatusReceiver Error Status Receiver Error Status Receiver Error StatusReceiver Error Status
0：未检测到 Receiver Error Receiver ErrorReceiver ErrorReceiver Error Receiver ErrorReceiver ErrorReceiver ErrorReceiver ErrorReceiver ErrorReceiver Error；
1：检测到 Receiver Error Receiver ErrorReceiver ErrorReceiver Error Receiver ErrorReceiver ErrorReceiver ErrorReceiver ErrorReceiver ErrorReceiver Error。
4.3.1.9.8 支持outboud方向timeout报文信息查询
PCIe通过查询寄存器PERI_PCIE_STAT1[radm_cpl_timeout_reg]信息。
4.3.1.9.9 支持override PCIe状态机查询
通过override PCIe内部寄存器空间偏移0x708的bit[21:16]作为状态机的值，bit[15]是使能。
如果怀疑PCIe SerDes发送端问题，可以通过设置。
4.3.1.9.10 支持override PCIe协商链路宽度设置
通过配置PCIE_VENDOR_CTRL内部寄存器PORT_LINK_CONTROL来设置。
4.3.1.9.11 环回测试
PCIe支持两种Local环回模式。一个是Local 环回，一个是remote 环回。
SD5182HV100 Functional Specification Page 140 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Local环回，不需要建立link，需要PHY的提供时钟即可，环回路径不涉及到PHY，仅仅在PCIe内部进行环回。
Remote 环回，是属于PCIe Spec也不需要建立link，需要PHY的提供时钟即可，需要链路稳定OK，环回路径涉及PHY和remote PHY。
4.3.1.9.11.1 Local环回测试
Figure Figure Figure Figure Figure Figure Figure 4.34.34.3-16 PCIePCIePCIePCIe内部本地环回
前提条件
Local loopback包括PIPE RX和PIPE TX信号，而且只在环回状态下运行，因为控制器自身是不能跟自己建立link而进入L0（xmlh_ltssm_state=0x11）状态进行报文的收发的。
进入local PIPE loopback的初始化流程
不使能Gen3 Equalization，即设置PCIe内部寄存器，中偏移量为寄存器0x700+0x190（port logic register）的寄存器的bit[16]为0，因为PHY是不参与这个换回的。
设置PCIe内部寄存器，偏移量为0x700+0x1B8的PIPE Loopback Control寄存器的bit[31]为1，使能PIPE 环回。
设置PCIe内部寄存器，偏移量为0x700+0x10的Port Link Control寄存器bit[2]为1，使能loopback。
SD5182HV100 Functional Specification Page 141 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
----结束
环回下的枚举和BAR 启动
在环回状态下，也必须要配置（通过local CPU 去配置PCIe 内部寄存器空间）BAR 地址
（EP），memory/IO 范围（downstream port），设置PCI 标准256bytes 配置空间头中的
memory 空间使能和总线master 使能（即设置PCIe 内部寄存器，配置空间中偏移地址为
0x4 的比特0、比特1 和比特2 为1）。这样的话，接收过滤才能正常接收TLP 报文。
退出本地环回
清除DBI 空间中偏移量为0x700+0x1B8 的 PIPE Loopback Control 寄存器的比特31，写其
为0 即可。
清除DBI 空间中偏移量为0x700+0x10 的 PIPE Loopback Control 寄存器的比特2，写其为
0 即可。
4.3.1.9.11.2 Remote 环回测试
用于PCIe 链路检测，如下图所示。
DDR
A
B
AMBA
AXI
Bridge
Slave
Master
比较A和B数据
是否一致
PCIe Core
iATU.outbound方向
Base addr=slave.addr
Target addr=B.addr
PCIe
PHY
PCIe
PHY
Remote device
Figure 4.3-17 remote 环回测试
软件往PCIe 方向发送读写命令，经过环回后，在DDR 内存里面进行比对，检测PCIe 链
路是否正常。
其配置过程如下：
SD5182HV100 Functional Specification Page 142 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PCIe初始化成功。（包括link up，设置PCIe DBI空间偏移0x4的命令寄存器，bit[2:0]=3b111）。
通过设置PERI_PCIE7[dbi_cs]=1，则访问的是pcie内部寄存器空间（DBI空间）
设置PCIe DBI 空间寄存器：地址偏移为0x700 + 0x10的寄存器的bit[2]设置成1；loopback使能。
循环读取PCIe DBI 空间寄存器：地址偏移为0x700 + 0x28的寄存器的bit[5:0]；如果bit[5:0]为0x1b，则PCIe进入loopback状态。
软件申请两块内存，分别是A和B，在DDR内存，初始化A地址和数据。
初始化iATU，将outbound 目标地址设置为B地址，报文类型是MEM类型，如下表所示。
Remote loopback emote loopback emote loopback emote loopback emote loopback emote loopback emote loopback emote loopback emote loopback emote loopback emote loopback emote loopback emote loopback emote loopback emote loopback 模式下， 模式下， 模式下， 模式下， iATUiATUiATUiATU配置（仅供参考） 配置（仅供参考） 配置（仅供参考） 配置（仅供参考） 配置（仅供参考） 配置（仅供参考） 配置（仅供参考） 配置（仅供参考） iATU寄存器名称 Region0参考值 说明 访问外设MEM空间
VideindexRegister
0x0000_0000
（outbond）
RegionControl1Register
0x0000_0000
RegionControl2Register
0x8000_0000
LowerBaseAddressRegister
PCIe Slave地址+软件自定义的外设MEM空间偏移
UpperBaseAddressRegister
0x0000_0000（高32位地址，软件可以自定义）
LimitAddressRegister
PCIe Slave地址+软件自定义的外设MEM空间偏移+外设MEM空间大小
LowerTargetAddressRegister
DDR内存B地址低32位
UpperTargetAddressRegister
DDR内存B地址高32位
软件将A地址和数据写到PCIe侧。
软件比较A地址和B 地址数据是否一致。
----结束
SD5182HV100 Functional Specification Page 143 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.3.2 USB
USB接口具有以下功能特点：
 支持1个usb3.0的双口控制器。
 port0支持USB3.0和USB2.0，兼容3.0/2.0。
 port1和2.5GE接口复用，可支持USB3.0和USB2.0，兼容3.0/2.0。
 完全符合 XHCI 1.0。
 仅支持USB Host模式。
 可以支持Super-speed、High-speed、Full-speed，low-speed四种设备。
 支持USB 2.0低功耗的解决方案 和 USB3.0的 U0、U1、U2、U3四种功耗状态。
 支持Host工作模式下Control Transfer、Bulk Transfer、Isochronous Transfer、Interrupt Transfer四种基本数据传输类型。
 支持内部DMA控制器。
 支持USB热插拔[Covers:OR.INTF.CPU.004]。
 如没有特别说明，寄存器不支持动态配置。
 支持PCIE3.0 SerDes复用给UNI 2.5GE。
4.3.2.1 INITIAL
请注意USB的控制器逻辑上要求两个口的pipe，utmi接口都有时钟时，才能正常工作。所以两个usb2，usb3的phy必须都解复位。如果不用port1口的combophy选择的不是usb模式配置Usb3 port1 phy解复位信号不会生效，但是crg会提供suspend时钟给port pipe_clk。初始化流程为：
打开usb phy和控制器参考时钟。
配置 0x14880020 0x14880020 0x14880020 0x14880020 0x148800200x14880020的第 12bit 12bit 12bit为 0x10x10x1，打开 ，打开 ，打开 usbusbusb控制器时钟。 控制器时钟。 控制器时钟。 控制器时钟。 控制器时钟。 控制器时钟。
配置 0x14880020 0x14880020 0x14880020 0x14880020 0x148800200x14880020的第 16bit 16bit 16bit为 0x10x10x1，打开 ，打开 ，打开 port0 usb2 port0 usb2 port0 usb2 port0 usb2port0 usb2port0 usb2 的参考时钟。 的参考时钟。 的参考时钟。 的参考时钟。 的参考时钟。 的参考时钟。
配置 0x14880020 0x14880020 0x14880020 0x14880020 0x148800200x14880020的第 17bit 17bit 17bit为 0x10x10x1，打开 ，打开 ，打开 port1 usb2 port1 usb2 port1 usb2 port1 usb2port1 usb2port1 usb2 的参考时钟。 的参考时钟。 的参考时钟。 的参考时钟。 的参考时钟。 的参考时钟。
配置 0x14880020 0x14880020 0x14880020 0x14880020 0x148800200x14880020的第 18bit 18bit 18bit为 0x10x10x1，打开 ，打开 ，打开 port0 usb3 port0 usb3 port0 usb3 port0 usb3port0 usb3port0 usb3 的参考时钟。 的参考时钟。 的参考时钟。 的参考时钟。 的参考时钟。 的参考时钟。
配置 0x14880020 0x14880020 0x14880020 0x14880020 0x148800200x14880020的第 19bit 19bit 19bit为 0x10x10x1，打开 ，打开 ，打开 port1 usb3 port1 usb3 port1 usb3 port1 usb3port1 usb3port1 usb3 的参考时钟。 的参考时钟。 的参考时钟。 的参考时钟。 的参考时钟。 的参考时钟。
撤离usb2 phy的phy复位。
配置 0x1488002c 0x1488002c 0x1488002c 0x1488002c 0x1488002c0x1488002c的第 15bit 15bit 15bit为 0x10x10x1，撤离 ，撤离 ，撤离 port0 usb2 port0 usb2 port0 usb2 port0 usb2port0 usb2port0 usb2 的 phy phy复位。
配置 0x1488002c 0x1488002c 0x1488002c 0x1488002c 0x1488002c0x1488002c的第 12bit 12bit 12bit为 0x10x10x1，撤离 ，撤离 ，撤离 port1 usb2 port1 usb2 port1 usb2 port1 usb2port1 usb2port1 usb2 的 phy phy复位。
等待35us。
SD5182HV100 Functional Specification Page 144 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
撤离usb2 phy 的port 复位。
配置0x1488002c 的第16bit 为0x1，撤离port0 usb2 的port 复位。
配置0x1488002c 的第13bit 为0x1，撤离port1 usb2 的port 复位。
撤离usb3 phy 的phy 复位。
配置0x1488002c 的第28bit 为0x1，撤离port0 usb3 的phy 复位。
配置0x1488002c 的第30bit 为0x1，撤离port1 usb3 的phy 复位。
等待10us。
撤离usb3 phy 的port 复位。
配置0x1488002c 的第29bit 为0x1，撤离port0 usb3 的port 复位。
配置0x1488002c 的第31bit 为0x1，撤离port1 usb3 的port 复位。
等待10us。
撤离控制器的复位信号。
配置0x1488002c 的第14bit 为0x1，撤离port1 usb3 控制器的复位。
等待1us。
4.3.3 HW
4.3.3.1 接口数据模式
HW 接口对PCM 语音码的一次帧传输，主要通过帧同步信号对串行数据
进行同步。
HW 接口的数据传输帧格式图（以工作在时钟频率为8.192MHz 时的情况
为例）如下图所示。
0 1 2 …… 1023 1024 0 1 2 …… 1023 1024 0
TDM_CLK
TDM_FS
TDM_RX/
TDM_TX
1 FRAM 1 FRAM
1 FRAM 1 FRAM
1 FRAM 1 FRAM
Figure 4.3-18 HW接口数据传输格式
从每一个帧同步信号TDM_FS 拉高的下一个周期开始，连续1024 个
TDM_CLK 时钟
SD5182HV100 Functional Specification Page 145 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
周期对应的收发数据为1 帧（1024bit）的串行数据。如果在宽带模式下，
则每帧对应有512 个时钟周期。
4.3.3.2 时钟与帧同步
支持五种时钟频率，分别为8.192/4.096/2.048/1.024/0.512MHz，可通过寄
存器进行配置。
每个时钟周期传送1bit 数据，帧同步时钟信号TDM_FS 的频率为8kHz，
高低电平有
效可配，默认高电平，最少电平宽度为1 个时钟周期。
还支持宽带语音的传输，在宽带语音的模式下，TDM_FS 的频率为
16kHz。
帧同步采样时钟、发送时钟和接收时钟均可以配置时钟沿，典型情况下配
置如下：
 下降沿采样帧同步
 下降沿采样接收数据
 上升沿采样发送数据
TDM 模块的时钟与帧同步时序图。
TDM_CLK
TDM_FS
125us
>T
Figure 4.3-19 TDM时钟与帧同步时序图
4.3.3.3 TDM 接收发送数据
支持接收/发送PCM 压缩码（8bit）和PCM 线性码（16bit）。
当TDM 接收/发送PCM压缩码时，每个接收/发送时隙占用8 个
TDM_CLK 时钟周期，在一个帧的传输中，每个通道占用一个时隙，8 个
通道共占用8 个时隙共（64 个时钟周期），其余时隙为空闲时隙，如下
图所示，通道0 使用TS0，通道1 使用TS1。
当支持为无绳电话模式时，通道0 使用TS0 和TS1。
SD5182HV100 Functional Specification Page 146 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
7 6 5 4 3 2 1 0 7 6 5 4 3
TDM_CLK
TDM_FS
TDM_RX 2 1 0 7
TS0 TS1
Figure 4.3-20 TDM接收PCM压缩码时序图
当TDM 接收/发送PCM线性码时，每个接收/发送时隙占用8 个
TDM_CLK 时钟周期，在一个帧的传输中，每个通道占用2 个时隙，8 个
通道共占用前8 个时隙（128 个时钟周期），其余时隙为空闲时隙，如下
图所示，通道0 使用TS0 和TS1，通道1 使用TS2 和TS3。
当支持为无绳电话模式时，通道0 使用TS0~3，通道1 使用TS4~7。
15 14 13 12 11 10 9 8 7 6 5 4 3
TDM_CLK
TDM_FS
TDM_RX 2 1 0 7
TS0 TS1
Figure 4.3-21 TDM接受PCM线性码时序图
4.3.3.4 HW比特偏移
HW 的发送时序和接收时序可以通过发送偏移和接收偏移分别进行配置，可通过配置寄存
器TDM_ALIGN（TDM 偏移调整寄存器）来实现，当发送偏移和接收偏移都为0 时，称
为典型时序；当偏移值不为0 时，相当于在典型时序的基础上右移了配置偏移量个时钟周
期。例如，当偏移量为1 时，相当于典型时序向右移动了一个周期，时隙0 的最高比特提
前了一个周期。偏移为0、偏移为1023 和偏移为1 的时序图如下图所示。
7 6 5 4 3 2 1 0 7 6 5 4 3
TDM_CLK
TDM_FS
TDM_TX/
TDM_RX(0) 2 1 0 7
默认情况，偏移0 TS TS
7 6 5 4 3 2 1 0 7 6 5 4 3 2 1 0 7
偏移为1023 TS TS
TDM_TX/
TDM_RX(1)
7 6 5 4 3 2 1 0 7 6 5 4 3 2 1 0
偏移为1 TS TS
TDM_TX/
TDM_RX(2)
6
SD5182HV100 Functional Specification Page 147 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure Figure Figure Figure Figure Figure Figure 4.34.34.3-22 HW 比特偏移时序图 比特偏移时序图 比特偏移时序图 比特偏移时序图 比特偏移时序图 比特偏移时序图 比特偏移时序图
SD5182HV100 Functional Specification Page 148 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.4 MANAGEMENT INTERFACE
SD5182HV100 Functional Specification Page 149 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4.5 OTHER INTERFACE
4.5.1 DRAM Interface
4.5.1.1 接口介绍
SD5182V100 的DDRC 提供以下功能特性：
 支持DDR3 和DDR4，初始化时配置；
 支持DDRC 时钟和颗粒时钟1：2 的模式；
 提供32bit 数据总线位宽；
 最小支持4MB，最大支持2GB；
 rank 数为1；
 支持ODT 控制；
 兼容支持16bit 位宽应用。
4.5.1.2 DDR 拓扑结构
SD5182V100 外接DDR3 SDRAM 拓扑结构（以两片DDR3 颗粒接口为例）如下图所示。
C
DDR_CLK0_P
DDR_CLK0_N
DDR_DQ[15:0]
DDR_DQS[1:0]
DDR_DM[1:0]
DDR_CKE
DDR_RAS_N
DDR_CAS_N
DDR_WE_N
DDR_ODT
DDR_BA[2:0]
DDR_A[14:0]
DDR_RESET_N
DDRC
(CKE ,/RAS , /CAS ,
/WE ,BAx, Ax , ODT , /RESET)
SD5182V100
DQ[15:0]
DQS[1:0]
DM[1:0]
DDR3 SDRAM0
DDR3 SDRAM1
AC
AC
DDR_DQ[31:16 ]
DDR_DQS[3:2]
DDR_DM[3:2]
DQ[15:0]
DQS[1:0]
DM[1:0]
CLK
SD5182HV100 Functional Specification Page 150 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure Figure Figure Figure Figure Figure Figure 4.54.54.5-1 SD5182V100SD5182V100SD5182V100SD5182V100SD5182V100SD5182V100SD5182V100SD5182V100SD5182V100SD5182V100与 DDR3DDR3DDR3DDR3的拓扑结构图 的拓扑结构图 的拓扑结构图 的拓扑结构图 的拓扑结构图 的拓扑结构图
外接DDR4 SDRAM拓扑结构与上图类似，不再列出。
DDR在上电后有个初始化流程，SDK已经集成，系统起来后，也不需要频繁配置修改相关参数。
4.5.2 Flash Interface
SD5182HV100 Functional Specification Page 151 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5 DATAPATH SUB-SYSTEM DESCRIPTION
SD5182HV100 Functional Specification Page 152 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.1 IPS_PON
IPS_PON模块作为PON MAC下行跟IPS模块的接口模块，根据NNI_MODE配置，完成各路PON MAC接口的下行数据汇聚，送给IPS模块。
5.1.1 Main Features
IPS_PON模块支持的主要特性如下：
 支持下行4种模式10G GPON/10G EPON/GPON/EPON的MAC入口数据汇聚，支持GMAC双通道报文数据重组。
 支持将输入的16bit(EPON)，32bit(GPON)和128bit(10G GPON/10G EPON)对齐到128bit，并暂存在FIFO中。
 支持下行组播报文过滤，DMAC+VLAN hash查表，组播过滤表4K，支持8个IPV4 DIP 和1个IPV6 DIP（高12bit）白名单。
 支持报文的sop/eop合法性检查；
 支持超长帧/超短帧/错误帧检查；
 支持Jumbo帧（默认9600字节）。
5.1.2 Terminology
The following terms have specific meanings in this section of the document.
Term Description
IPS
Ingress Port Schedule
PON
Passive Optical Network
GPON
Gigabit Passive Optical Network
EPON
Ethernet Passive Optical Network
Table 5.1-1 IPS_PON Terminology
SD5182HV100 Functional Specification Page 153 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.1.3 IPS_PON Overview
5.1.3.1 Request Overview
5.1.3.2 PON TX_BUF
EPS_PON需要维护16KB的TX_BUF，默认按照32通道*512byte计算，支持4种缓存模式配置（32*512byte,16*256,8*2048,4*4096）。TX_BUF由32个可以配置模式的独立FIFO构成，所有FIFO共享一块16KB的TP_RAM。
5.1.3.3 10G GPON端口
接口数据128bit，下行线速9.95328Gbps。
当接口指示信号SOP为1时，指示为帧头信息，其格式如下 Bit Field Description
127:17
rsvd
保留
16
mc
multi-cast，指示的是该gem_port_index的属性，即IPS_PON里的ds_bc（基于组播portid承载）
15:12
pri
gemport index优先级属性
11:9
rsvd
保留
8:0
gem_port_index
下行gem_port_index
Table 5.1-2 NGMAC与IPS_PON接口数据结构
5.1.3.4 GPON端口
接口数据32bit，支持最大速率2.5Gbps，GPON下行报文支持双通道重组。
当接口指示信号SOP为1时，指示为帧头信息，其格式如下
SD5182HV100 Functional Specification Page 154 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Bit Field Description
31:19
rsvd
保留
18:16
port_type
以太报文（非组播portid承载） 3’b010；组播（基于组播portid承载） 3’b011。
15
pri_en
port_pri有效标识，’1’表示port_pri有效；’0’表示port_pri无效，优先级匹配时使用报文自带优先级。
14:12
port_pri
gem_port_id携带的优先级
11:0
gem_port_id
下行gem_port_index
Table 5.1-3 GMAC与IPS_PON接口数据结构
5.1.3.5 10G EPON端口
接口数据128bit，支持最大速率10Gbps。
当接口指示信号SOP为1时，指示为帧头信息，其格式如下 Bit Field Description
127:6
rsvd
保留
5
scb
Single Copy Broadcast标识
4:0
lidx
LLID index通道标号
Table 5.1-4 10G EPON与IPS_PON接口数据结构
scb与lidx组合在一起，构成了LLID的类型 scb lidx[4:0] {scb,lidx[4:0]}编号 Description
0
0~15
0~15
单播LLID Index 0~15
0
16~31
16~31
组播LLID Index 16~31
1
0
32
广播（LLID=0x7FFF or 0xFFFF)<----- 可配置，一般都是0x7FFF
SD5182HV100 Functional Specification Page 155 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
1
1~3
33~35
侦听LLID0~2（侦听LLID不属于组播承载LLID）
1
16
48
SCB（LLID[15] = 1'b1 & LLID[14:0] ！= 本地LLID）
Table 5.1-5 10G EPON LLID类型表格
注：下行IPS_PON输出的下行广播标识ds_bc域的表达式如下：
ds_bc = （llid[5:4] != 2’b0）& (~(32<=llid <=35))
5.1.3.6 EPON端口
接口数据16bit，最大下行速率1Gbps。
当接口指示信号SOP为1时，指示为帧头信息，其格式如下 Bit Field Description
15:5
rsvd
保留
4
scb
Single Copy Broadcast标识
3:0
lidx
LLID index通道标号
Table 5.1-6 EMAC与IPS_PON接口数据结构
scb与lidx组合在一起，构成了LLID的类型 scb lidx[3:0] {scb,lidx[3:0]}编号 Description
0
0~7
0~7
单播LLID Index 0~7
0
8~15
8~15
组播LLID Index 8~15
1
0
16
广播（LLID=0x7FFF or 0xFFFF)<----- 可配置，一般都是0x7FFF
1
1~3
17~19
侦听LLID0~2（侦听LLID不属于组播承载LLID）
SD5182HV100 Functional Specification Page 156 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
1
16
48
SCB（LLID[15] = 1'b1 & LLID[14:0] ！= 本地LLID）
Table 5.1-7 EPON LLID类型表格
注：下行IPS_PON输出的下行广播标识ds_bc域的表达式如下：
ds_bc = （llid[4:3] != 2’b0）& (~(17<=llid <=19))；
5.1.3.7 下行报文组播过滤
5.1.3.7.1 配置表项
组播过滤表项大小4K，表项内容1bit，’0’表示过滤丢弃报文，’1’表示不过滤。
组播过滤表复位后会初始化为全0，所以打开此组播过滤功能前必须先把已知组播DMAC+VLAN内容配置到表项中。
5.1.3.7.2 匹配查表前提条件
匹配查表前需要满足以下条件：
1、GPON基于组播gem_port_id承载的报文/EPON基于广播或组播LLID报文；
2、DMAC[40]等于1且DMAC不等于全1（组播DMAC）；
3、DMAC不属于组播地址白名单；
以上任一条件不满足，报文直接通过，不进行组播报文匹配查表。
5.1.3.7.3 匹配查表处理
匹配查表处理过程如下：
DMAC+VLAN方式共61bit（仅DMAC匹配时，高13比特vlan等于0），经过HASH（CRC16 = X^16 + X^12 + X^5 + 1）运算得到16bit结果，取低12bit作为组播过滤查表地址查表得到是否进行组包报文过滤的结果。配置见nManager如下：
SD5182HV100 Functional Specification Page 157 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.1.3.7.4 基于DIP进行组播过滤
组播过滤需要增加DIP白名单，IPV4配置8组DIP白名单+掩码，IPV6配置1组DIP高12bit白名单+掩码，报文的DIP和掩码后的白名单匹配的不进行组播过滤。配置见nManager如下：
5.1.4 Table Structure
5.1.4.1 MCF FILTER Table
5.1.4.1.1 表格基本描述 表格名称
MCF FILTER Table 起始地址
N/A 地址范围
N/A 表项数目
4096 每项宽度
1bit 寻址方式
DMAC+VLAN方式共61bit（仅DMAC匹配时，高13比特vlan等于0），经过HASH（CRC16）运算得到16bit结果，取低12bit作为组播过滤表项地址。
Table 5.1-8 MCF_FILTER Table基本描述
5.1.4.1.2 表项数据结构 Bit Field Description
SD5182HV100 Functional Specification Page 158 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
31:1
rsv
保留
0
mac_filter
组播MAC地址标识：
0：无效组播MAC；
1：有效组播MAC。
Table 5.1-9 Report/DBRu Table数据结构
5.1.5 Initialization
组播过滤表复位后逻辑会初始化为全0（过滤丢弃报文），所以打开此组播过滤功能前必须先把已知组播的DMAC+VLAN内容配置到表项中。
5.1.6 Capacity
组播过滤表规格为4K个条目
5.1.7 Performance
物理带宽性能128bit*XPON SYS CLK = （128bit*200Mhz）= 25.6Gbps；
可以满足10G GPON/10G EPON/GPON/EPON业务性能要求。
5.1.8 Error Handling
TBD
5.1.9 DFx Features
TBD
5.2 INGRESS PORT SCHEDULE（IPS）
系统所有入口流量由IPS模块汇聚，IPS先向FAM申请缓存，然后对所有输入接口进行调度，按照调度结果，将报文存入内部缓存PLB（MEMP）。当一个完整报文存入后，将报文头Head Block读出，存到内部Head缓存中，由HA模块将数据读走。
SD5182HV100 Functional Specification Page 159 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.2.1 Main Feature
 UNI支持4个GE接口、1个1G/2.5GE接口、1个RGMII接口；
 NNI支持一路xPON口，或者支持一路1G/2.5GE接口；
 支持1个PIE物理端口；
 支持1个WOE端口；
 支持1个PRBS端口；
 支持向FAM申请缓存/建立链表的请求；
 支持各端口报文数据分组SP+RR轮询写入IFB；
 支持检测ETH口流量，产生流控信号送给超过配置门限的ETH端口；
 支持动态调频；
 支持各端口报文的sop/eop合法性检查；
 支持超长帧/超短帧/错误帧检查；
 支持WOE端口的FCB提取；
 支持PIE端口的FCB提取；
 支持PIE端口TCP/UDP报文的 CHECKSUM计算；
 支持PIE端口IPv4报文IP header Checksum计算，软件配置计算使能，计算起始位置和Checksum域清0操作；
 支持可配的PIE端口短包补零功能；
 支持GE/PIE/WOE/PRBS/NNI口CAR功能；
 支持对所有入端口的报文大于128字节的净荷部分校验和计算；
 支持jumbo帧（包长少于或等于9600Byte的报文）；
 支持GE口1588时戳提取。
5.2.2 Terminology
The following terms have special meanings in this section. Term Description
IPS
Ingress port schedule
IFB
Internal Frame Buffer
HA
Hardware Accelerator
SD5182HV100 Functional Specification Page 160 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
MEMP Memory Pool
FAM Free Address Manager
Table 5.2-1 IPS Terminology
5.2.3 IPS Overview
5.2.3.1 Introduction
IPS_SCH
IPS_HA_ITF
IPS_IF
FAM
HA
MEMP
IPS
NNI
UNI
PIE
PRBS
Figure 5.2-1 IPS structure
IPS 主要完成各接口数据的调度和写入MEMP 缓存以及从MEMP 读出报文头给HA 模块。
主要由三部分构成：
 接口模块IPS_IF，从各个端口接收数据，并进行位宽转换，同时对报文进行检查，异
常报文打上drop 标记。
 调度模块 IPS_SCH，提前向FAM模块申请16 个IFB CELL，对各个端口重组好的数据
进行SP+RR 调度，分配好CELL 空间，将调度结果写入MEMP，并向FAM发起链表
处理动作。
 HA 接口处理模块IPS_HA_ITF，根据报文缓存的首指针，将报文头从MEMP 中读出，
给到HA 模块。
SD5182HV100 Functional Specification Page 161 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.2.4 Flow Control
IPS_SCH模块负责统计各个端口的流量。支持ETH/NNI/PIE/PRBS CAR功能和ETH PAUSE功能。要求CRG模块送给IPS_SCH一个1us基准脉冲，统计间隔可配置。
CAR和PAUSE功能共用端口累加帧长plen桶和pir令牌，在固定周期内进行刷新，此刷新周期可配置，默认是125us。pir是端口峰值带宽，也称为令牌。每个刷新周期结束点比较plen和pir：
plen <= pir，plen=0；
plen > pir，plen = plen – pir。
如果刷新时间点和调度出来的帧尾eop重合，刷新时间点延后一拍。
5.2.4.1 PORT CAR
CAR机制端口承诺突发值pbs，实时监测端口累计帧长：
plen > pbs，plen保持不变，端口报文丢包；
plen <= pbs，端口报文停止丢包。
5.2.4.2 ETH PORT PAUSE
PAUSE机制端口的承诺突发值cbs，反压水线dps0和撤销反压水线dps1分别可配，实时监测端口累计帧长：
plen >= cbs + dps0，端口pause有效；
plen < cbs – dps1，端口pause失效。
IPS模块提供基于缓存占用流控和入端口流量两种机制流控开关独立配置，支持任选一种、同时打开和同时关闭。
IPS端口CAR功能和端口pause功能使能可独立配置。
5.2.5 SOP/EOP Legal Check of Packet
IPS会对报文的sop/eop合法性进行检查，如果出现异常则打上drop，并给出丢弃原因。异常类型如下描述。
 eop丢失
SD5182HV100 Functional Specification Page 162 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
SOP SOP(EOP) EOP
drop frame
EOP
Figure 5.2-2 EOP 丢失
如上图所示，在第二个sop 处添加一个eop 作为一个报文，并且打上mac_err 的
drop_reason，第二个sop 到eop 的报文作为正常报文。
 sop 丢失
SOP EOP SOP EOP
frame drop
Figure 5.2-3 SOP 丢失
如上图所示，sop 丢失，逻辑把eop 后到下一个eop 的所有报文数据直接丢弃，统计丢失
sop。
 sop/eop 重合
SOP SOP/EOP EOP
drop
SOP
frame
Figure 5.2-4 SOP/EOP 重合1
SD5182HV100 Functional Specification Page 163 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
EOP SOP/EOP EOP
frame
SOP
drop
Figure 5.2-5 SOP/EOP 重合2
如上图所示，sop/eop 重合的情况，假设前面有sop，那么会把前面的sop 到sop/eop 之间
的数据打上drop_reason 并作为丢失eop 统计。
假设前面是eop，只会丢弃sop/eop 这拍的数据，并作为丢失sop 统计。
5.2.6 Frame Exception Check
IPS 会对报文的超长帧、超短帧、错误帧进行检查。
 超长帧检查
通过CPU 配置long_frm对超长报文长度进行限制，当包长超过long_frm时，截取
long_frm的数据作为一个包，剩下部分截断，将包存入缓存，并上报HA 模块丢弃原因为
超长帧过滤。各个端口的配置是独立的。
 超短帧检查
通过CPU 配置short_frm 对超短报文长度进行限制，当包长小于short_frm时，将包存入
缓存，并上报HA 模块丢弃原因为超短帧过滤，默认值是60（不包括4 字节CRC）。最
小支持17 字节，因为小于等于16 字节的报文会统计为毛刺报文直接丢弃。当是PIE 报文
时，有独立的配置门限pie_short_frm。
 错误帧检查
由各个端口送过来的接收帧错误信号进行判断，与eop 同时有效。当此信号为1 时，表示
接收的帧为错误帧，将包存入缓存，并上报HA 模块丢弃原因为错误帧。当该报文既是错
误帧又是超长或超短帧时，标记为错误帧。
 毛刺帧检查
当各端口发送过来的报文长度小于或等于16 字节时，直接丢弃，统计为毛刺帧。
SD5182HV100 Functional Specification Page 164 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.2.7 PIE Interface
PIE_IF处理IPS和PIE之间的时序，接口数据64bit，重组成128bit位宽的数据，并请求SCH的调度；
支持对报文进行sop/eop的合法性检查，超长帧/超短帧/错误帧的检查；统计报文长度；
支持PIE通道TCP/UDP Checksum计算，可配置使能；
支持PIE通道IPv4 Checksum计算，可配置使能；
支持短包补零功能，可配置使能，短包长度可配置，默认是60Byte（不包括FCS）。
5.2.7.1 Checksum Calculation
5.2.7.1.1 TCP/UDP Packet Checksum Calculation
为提升CPU的处理性能，对于CPU发送的IPv4/IPv6承载的TCP/UDP报文，逻辑支持对TCP/UDP checksum域的替换。
TCP/UDP的checksum计算需要的字段包括：IP伪报头，TCP/UDP Header，TCP/UDP Payload。这三个字段在报文格式里面是不连续的。
TCP/UDP checksum计算所需要的控制信息如下： Field Description
CSS[7:0]
TCP/UDP CHECKSUM域计算的开始位置，单位是1字节。
CSUM_TYPE
TCP/UDP类型指示，用于计算checksum位置偏移。
0：UDP，checksum相对css偏移6字节；
1：TCP，checksum相对css偏移16字节。
CSUM_EN
CHECKSUM计算使能。
0：逻辑不计算checksum；
1：逻辑计算checksum。
Figure 5.2-6 TCP/UDP Checksum计算控制信息
CPU发送的报文在PKT_INFO里面标识的信息如上表所示。CSS(Checksum Start)用于指示开始计算TCP/UDP报文Checksum的位置；CSUM_TYPE指示报文类型是TCP还是UDP，UDP报文Checksum相对CSS偏移6字节；TCP报文Checksum相对CSS偏移16字节。CSUM_EN指示Checksum使能，高电平有效。
由于IP伪报头与TCP/UDP数据在报文中的位置是不连续的，CPU需要计算出IP伪报头的16bit数据并填 充进TCP/UDP的Checksum域。
IPS接收到PIE发送的报文，使用CSS开始位置到报文结束位置的数据进行checksum的计算，计算完成后将checksum填入TCP/UDP的checksum域。
SD5182HV100 Functional Specification Page 165 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
注意：1、计算checksum时，如果软件对报文进行padding操作，padding值必须是0才能保证checksum值计算正确，计算长度是奇数时，最后1字节低位补8bit全零。
2、checksum域的位置不支持奇数字节配置。
 IPv4 承载的TCP CheckSum
计算范围：伪首部、TCP首部、TCP数据。
包含伪头：是，伪首部加在TCP首部之前，其中PTCL为TCP的IPv4协议号，TCP Length为TCP首部和TCP数据的总长度（由IPv4首部中的Total Length域计算得出，以Byte为单位）。
Figure 5.2-7 TCP报文首报
Figure 5.2-8 IPv4承载的TCP报文伪首部
 IPv4 承载的UDP CheckSum
计算范围：伪首部、UDP首部、UDP数据。
包含伪头：是，伪首部加在UDP首部之前，其中PTCL为UDP的IPv4协议号，UDP Length为UDP首部和UDP数据的总长度（由IPv4首部中的Total Length域计算得出，以Byte为单位）。
SD5182HV100 Functional Specification Page 166 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure 5.2-9 UDP报文首部
Figure 5.2-10 IPv4承载的UDP报文伪首部
 IPv6 承载的TCP CheckSum
计算范围：伪首部、TCP首部、TCP数据。
包含伪头：是，伪首部加在TCP首部之前，其中Next Header为TCP的IPv6协议号，Upper-Layer Packet Length为TCP首部和TCP数据的总长度（由IPv6首部中的Payload Length域与各扩展头的长度计算得出，以Byte为单位）。
SD5182HV100 Functional Specification Page 167 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure 5.2-11 IPv6报文首部
Figure 5.2-12 IPv6承载的TCP报文伪首部
 IPv6 承载的UDP CheckSum
计算范围：伪首部、UDP首部、UDP数据。
包含伪头：是，伪首部加在UDP首部之前，其中Next Header为UDP的IPv6协议号，Upper-Layer Packet Length为UDP首部和UDP数据的总长度（由IPv6首部中的Payload Length域与各扩展头的长度计算得出，以Byte为单位）。
SD5182HV100 Functional Specification Page 168 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.2.7.1.2 IPv4 Packet Checksum Calculation
IPv4报文头的Checksum计算跟TCP/UDP计算方案类似，也是采用软硬件配合的方式，由软件给出相关报文指示（IPS不解析报文格式），硬件进行具体运算并刷新。
软件指示域如下： Field Description
IPV4_CSUM_START[7:0]
IPv4 Checksum域计算的开始位置，单位是1字节。
IPV4_CSUM_EN
CHECKSUM计算使能。
0：逻辑不计算checksum；
1：逻辑计算checksum。
Figure 5.2-13 IPv4 Checksum计算控制信息
ipv4_csum_en表示是IPv4报文，且需要IPS进行IP头Checksum计算；
ipv4_csum_start表示IP头Checksum计算的起始位置，单位1字节。
硬件解析的域如下：
ipv4_csum_ihl[3:0]表示Internet Header Length IPv4头长度，单位为4字节。从ipv4_csum_start当前字节低[3:0]取出，其值最小为5，此时Options不存在。IPv4包头长度最小为20字节，最大为60字节。如果超过此范围，逻辑告警。
IPS逻辑在ipv4_csum_en有效时进行IPv4报文头checksum计算，计算范围从ipv4_csum_start到ipv4_csum_ihl[3:0]*4字节位置，计算结果刷新到ipv4_csum_start + 10的固定位置。
PIE报文调度过程中需要再停止1拍把计算结果写入MEMP。
约束：
 只支持IPv4头checksum的计算，不支持IPv6头的checksum计算；
 要求软件配置原始header checksum=0。
IPV4
31~29 28~16 15~12 11~8 7~0
0 dmac[47:16]
1 dmac[15:0] smac[47:32]
2 smac[31:0]
3 Ethernet type(16bits)--0x0800 Version=4 IHL DSCP/TOS
4 Total length Identification
5 Flags Fragment offset TTL Protocol
6 Header checksum SIP[32:16]
7 SIP[15:0] DIP[32:16]
SD5182HV100 Functional Specification Page 169 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8 DIP[15:0] options
Figure 5.2-14 IPv4报文结构
注意，逻辑不支持以下异常配置：
逻辑增加软件异常配置告警，包括如下：
ipv4_csum_start配置奇数异常；
ipv4_csum_start配置大于等于报文长度异常；
ipv4_csum_start配置小于14字节异常（小于二层报文头）；
ipv4_csum_start配置大于244字节异常（已超过协议要求，并且逻辑最大只支持256字节内的checksum域写入）；
ipv4_ihl小于等于4。
5.2.7.2 PIE PORT short packet zero padding
IPS会对短包进行补零。由CPU配置短包补零使能，以及补零范围。当PIE的报文被检测为短包且配置了短包补零使能时，将该报文补到配置的长度，范围是57~64字节。
5.2.8 Error Handling
 超长和超短帧丢包，配置长度门限丢包；
 MAC ERR丢包，包括MAC打上错误标记丢包、EOP异常丢包，不可配置；
 PON FCS ERR丢包，包括PON打上错误标记丢包、SOP/EOP异常丢包，不可配置；
 入口CAR丢包，可配置使能和水线。
以上这几种情况都是标记drop_reason，数据还是需要写入MEMP。
 SOP异常丢包，报文直接丢弃不可配置；
 包长小于17字节，报文直接丢弃不可配置。
以上这几种情况报文直接在IPS丢弃，不需要输出FCB。
SD5182HV100 Functional Specification Page 170 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.2.9 Performance
IPS内部调度固定1拍写入一个128bit到MEMP。
IPS最高频率工作在250MHz，最大调度速率250*128 = 32Gbps，远大于上下行18Gbps(4GE(4G)+10GEPON(10G)+RGMII(1G)+1(PIE/WOE/2.5GE)(3G))流量，突发250us的需求。
从IPS给HA的报文只有报文头，所以长度是60B~128B，加上两拍FCB，通过计算可以得到65B的包长性能是最差的。(65+4+20)*8*250M/7次=25.42Gbps，满足系统要求的18Gbps。
考虑突发情况，PIE瞬间突发速率可以达到16Gbps，因为软件最多可能连续发32个报文。
所有端口并发线速，4GE(4G)+10GEPON(10G)+RGMII(1G)+1PIE(16G)=31Gbps。
可以算出需要缓存的报文个数是：(31G-25.42G)*(4+9)*32*4/(8*85)=17个。
其中4表示最差情况下PIE前面有4拍FCB，9表示65字节的包有9拍，32表示有32个PIE报文，4表示4ns，因为时钟是250M。
由于IPS调度机制是分组调度SP+RR方式，组间是SP，组内是RR。PIE和PRBS属于内部端口组，优先级比外部端口组低，因此PIE的突发不会影响外部端口组的调度性能，只是出现以上情况PIE突发时，IPS会反压PIE，PIE可以接受IPS反压停止发包，因此IPS与PIE接口不需要缓存报文吸收短包性能突发。
5.2.10 Power Management
5.2.10.1 Dynamic Frequency modulation
IPS监控各个端口当前的接收数据请求状态，根据流量给各端口配置不同权重，累加有数据请求的端口权重，累加权重与预设的三级阈值比较，将2bit结果送给CRG，CRG根据结果调整频率。
IPS端口
权重配置寄存器
权重默认值
NNI
NNI_LP_WEIGHT
10
PRBS
PRBS_LP_WEIGHT
1
PIE
PIE_LP_WEIGHT
1
WOE
WOE_LP_WEIGHT
1
GE*5
ETH_LP_WEIGHT
4
SD5182HV100 Functional Specification Page 171 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
全部端口权重
42
Table 5.2-2 动态调频入口权重表
lp_st[1:0]
频率等级
参考频率MHz
典型场景
0
0
50
空闲状态
1
1
100
端口总流量2Gbps
2
2
150
端口总流量6Gbps
3
3
250
端口总流量10Gbps
Table 5.2-3 动态调频档位表
各端口累加权重的计算公式：端口权重（weight）× 端口报文统计状态（status）。以GE0端口为例，req=1，status=1；req=0，status=0。
因此所有端口的累加权重weight_sum = ge0_weight × ge0_status + …… nni_weight × nni_status。
5.2.10.2 PON Low Power
IPS上报PON入口进入低功耗脉冲和唤醒低功耗脉冲。
当PON口无数据请求时间大于进入低功耗配置门限(单位1us)时，上报进入低功耗脉冲；
当接收PON口报文个数大于唤醒低功耗配置门限时，上报推出低功耗脉冲。
5.2.11 DFx Features
 支持对WOE、PIE、PRBS、ETH0~5、NNI、PON的如下统计
接收报文数目统计；
接收报文丢失SOP数目统计；
接收报文丢失EOP数目统计；
接收超长报文统计；
接收超短报文统计；
接收MAC报错报文数目统计；
接收毛刺报文数目统计；
SD5182HV100 Functional Specification Page 172 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
端口CAR丢弃统计；
端口累计帧长状态寄存器；
端口VALID信号异常统计；
PIE的CSS异常统计；
PIE端口短包填充统计。
 DEBUG寄存器如下
PIE CHKSUM DEBUG寄存器；
各端口请求、读使能和反压信号状态寄存器0~1；
PFE_FIFO DEBUG寄存器；
HA_FIFO DEBUG寄存器；
CELL_FIFO DEBUG寄存器。
 中断寄存器
IPS中断寄存器；
IPS中断掩码寄存器；
IPS中断置位寄存器；
ECC控制寄存器；
ECC校验错误状态寄存器。
SD5182HV100 Functional Specification Page 173 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.3 HARDWARE ACCELERATOR (HA)
Hardware Accelerator(HA)是一个报文解析引擎，是上下行报文进入PSA子系统前的优先级选择处理器。HA包含PA和FC两个子模块，PA对输入报文进行识别和域提取，FC对输入报文提供基本流分类和优先级处理，流分类结果作为报文携带信息输出给PQM。
5.3.1 Main Features
HA模块支持的功能特性由PA和FC两部分组成，其如下：
PA模块支持的功能特性如下：
 支持的基本帧格式 ：
o Layer2：Ethernet II、IEEE 802.3 SNAP、802.1Q、PPPoE 。
o Layer3：IPv4/IPv6 ，6RD和Dslite。
o Layer4：TCP/UDP/ ICMP/ICMPv6
 支持普通数据报文解析。
o 二层报文识别和解析，提取特征域DMAC、SMAC。
o Ethernet II和802.3 SNAP封装类型识别。
o 报文TAG类型和TAG层数解析，最多支持3层TAG解析。
o PPPoE封装，PPPoE discovery和PPPoE session阶段报文的解析，解析PPPoE协议及其承载的IP报文。
o IPv4/IPv6报文识别。
o TCP、UDP报文识别和解析，提取TCP报文控制域URG、ACK、PSH、RST、SYN和FIN。
o 6RD 、Ds-Lite隧道报文识别。
o IPV6支持自定义扩展头类型报文识别，自定义扩展头编码不能与已有的编码相同。
 支持协议报文解析。
o 支持二层协议报文： BPDU、EAPOL、MPLS和4个自定义Eth_Type报文识别。自定义Eth_Type 不能与已知的Eth_Type编码相同。
o 支持PPPoE协议报文识别：
o PPPoE Discovery阶段报文；
SD5182HV100 Functional Specification Page 174 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
o PPPoE Session阶段LCP报文。
o PPPoE Session阶段IPCP报文。
o PPPoE Session阶段CHAP报文。
o PPPoE Session阶段PAP报文。
o PPPoE Session阶段IPv6CP报文。
o 支持IPv4三层协议报文识别。
o ARP报文。
o RARP报文。
o IGMP报文。
o ICMP报文。
o 支持IPv6三层协议报文识别：ICMPv6。
o 支持四层协议报文识别：
o TCP报文；
o UDP报文；
o DHCP报文；
o DHCPv6报文。
【注】：HA需要识别的各种报文Type 参见SD5182HV100 Pac_Type.xlsx文档。
 支持OAM报文识别
o 802.3ah OAM报文识别。
o 802.1ag/Y.1731 OAM报文识别。
 支持1588 PTP报文识别。
 支持分片报文识别，IPv4：首片识别到L4层，非首片识别到L3层；IPv6：只识别分片和非分片报文。
 支持DMAC地址类型识别：unicast，multicast，broadcast ，local station’s MAC 。支持端口认证和报文合法性检查。
o 支持非法SMAC检查。
o 支持报文三层/四层CheckSum校验。
o 支持802.1x认证检查，每个端口1bit 配置，当配置使能，该端口的报文上报802.1x告警（不能丢包）。
SD5182HV100 Functional Specification Page 175 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
o 支持STP和RSTP检查，每个端口1bit配置，当配置使能，该端口的报文上报STP/RSTP告警（不能丢包）。
 支持基于UNTAG/PRI-TAG/TAG三种TAG类型的入口TAG优先级处理。
 支持报文优先级处理和源可选择：
o FCB内的报文优先级pq_valid和pq[2:0]，当pq_valid有效时，优先采用FCB内的优先级。HA 内部进行优先级的映射，所有端口共享一组8x2的优先级映射表。
o 端口优先级可配置，具有次高优先级。
o 组播，单播，广播报文优先级可配置，组播报文优先级最高，单播报文次之，广播报文最低。
o 802.1p/DSCP映射优先级。802.1p和DSCP映射分别采用4个模板，模板按端口可选择，与FC共用同一模板配置。非802.1p/DSCP报文选择Pac_Type映射优先级。
o 报文类型映射优先级，由Pac_Type映射出的优先级,映射表可配置，每一种Pac_type对应1个优先级配置。
 支持报文P/Q/T/U位置偏移指针。
o P指针：指向ETH头DMAC位置。
o Q指针：指向ETH头Ethtype位置。
o T指针：指向报文L3帧头，寻址空间64bytes。
o U指针：指向报文L4帧头，6rd或dslite报文指向内层IP头净荷位置，寻址空间32bytes。
o 输出的P/Q/T/U指针，P为基于逻辑端口配置偏移 port_hdr_posDMAC前的偏移量 ，Q/T/U指针为基于DMAC后的偏移。
 支持报文头开始位置可变：
o 支持按ingress 通道配置报文头开始位置偏移，PIE端口配置相同值，PRBS端口配置相同值。
o 支持FCB中携带的报文头位置偏移，例如：pie_ext_ind。
 支持报文类型Pac_type到流FID的映射，即默认流FID，映射表可配置。
 支持错误帧分类统计功能。
o 非法SMAC报文。
o 支持checksum 错误报文统计。
o STP和RSTP 状态检查丢弃的报文。
SD5182HV100 Functional Specification Page 176 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
o 802.1x认证检查丢弃的报文。
FC模块支持的功能特性如下：
 流分类表：
o 支持192条流分类规则，最多支持4个label，每个label可输出1条匹配结果。
o 每个表项最多支持三个匹配域，G0(32bit)/G1(16bit)/G2(16bit)。支持G0+G1+G2匹配或者G0+{G2, G1}匹配。
 流匹配域的规格：
o 支持入端口匹配（BITMAP）。
o 支持TAG /UNTAG类型报文匹配，匹配使能可配置。
 支持二层流匹配的域规格：
o 支持SMAC/DMAC匹配。
o 支持入端口TAG的SVLAN/CVLAN/SPBIT/CPBIT/STPID/CTPID匹配。
o 支持MPLS报文T/U指针后1个字节域的匹配。
o 支持入端口TAG的TAG层数匹配（TAG_SUM）。
o 支持以太类型匹配。
o 支持PPP_ENCAP（PPPoE封装）匹配。
o 支持PPPoE Session阶段Protocol匹配。
o 支持PPPoE SESSION_ID匹配。
o 支持ETH ENCAPSULE匹配（ETH/SNAP）。
o 支持TAG TYPE匹配（TAG/PRI-TAG/UNTAG）。
 支持三层/四层流匹配的域规格：
o 支持ARP DIP匹配。
o 支持IPv4 SIPv4/ DIPv4匹配。
o 支持IPv4 IP_PROTOCOL匹配。
o 支持IPv4 TOS匹配。
o 支持IPv6报文SIP/DIP联合表项匹配。
o 支持IPv6 NXT_HEADER和3个扩展NXT_HEADER匹配（任意一个匹配即可）。
SD5182HV100 Functional Specification Page 177 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
o 支持IPv6 TC匹配。
o 支持IPv6 FL匹配。
o 支持报文SPORT/DPORT的匹配（非TCP/UDP报文匹配失败）。
o 支持协议报文流匹配的域规格
o 支持ICMPv6_TYPE匹配。
o 支持TCP Control Bits匹配。
o 支持协议类型PTYPE匹配。
o 支持GEMPORT/LLID匹配（LINEINFO）。
o 支持FRM_TYPE匹配（二层单播/二层组播/广播等）。
o 支持IP_FRAG匹配（分片报文匹配）。
 流匹配规则：
o 支持是非匹配。
o 支持掩码匹配。
o 支持范围匹配。
o 支持掩码后范围匹配。
o 支持大于等于匹配。
o 支持小于匹配。
注：NXT_HEADER/扩展NXT_HEADER只支持是匹配。
o 支持联合表项匹配。
o 支持最多4条表项进行联合匹配，各表项均匹配成功时联合匹配成功。
o 支持最后一个表项动作为联合匹配最终动作。
 标记匹配行为规则：
o 支持队列优先级来源：指定值/S8021P/DSCP映射值。
 支持3个统计TC_ID，每个TC_ID对应1个32bit统计计数器，不饱和。
o FC 根据Port/GemPort+/Vlan+/EthType+/SMAC+/DMAC+/SIP+/DIP+/Protocol 匹配出3条流，分别统计命中的3条流，并送出2bit的TC_ID给PQM,1:表示流规则1命中；2：表示流规则2命中；3：表示流规则3命中；0：表示没有流规则命中。若多条流规则命中，流规则1优先级最高，流规则3优先级最低，按照优先
SD5182HV100 Functional Specification Page 178 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
级高低选择输出。
 支持最多4个有效FCID输出。每个label输出1个FCID，当流匹配无效时，输出默认FCID（该FCID由PA根据pac_type映射出的初始流ID）。
5.3.2 Terminology
The following terms have specific meanings in this section of the document.
Term Description
HA
Hardware Accelerator
PA
Packet Analyze
FC
Flow Classify
FCID
Flow Classify ID
TC_ID
Test counter ID ,流统计ID
PQM
报文队列管理
IPS
输入报文处理
Table 5.3-1 HA Terminology
5.3.3 References
There is no additional relevant documentation for this section of the document.
5.3.4 HA Data Flow
HA 模块结构和数据流如下：
SD5182HV100 Functional Specification Page 179 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Packet
Analyze
Flow
Classify
MAP0~MAP1
HA_DIO
IN_IF_FIFO OUT_IF_FIFO
Packet Analyze (PA) Flow Classify (FC)
Hardware Accelerator (HA)
“IF” From IPS “IF” To PQM
Figure 5.3-1 HA 模块结构图
PA 从IPS 模块接收32 byte FCB 和128 byte 的报文头信息，对报文进行入口安全检查，
逐层解析，识别基本帧格式和类型，提取特征域信息。。
FC 接收PA 发送的报文头信息，按照各种特征域，对报文进行分类匹配，得到报文的优
先级信息和送交NP 的流分类信息。
5.3.5 Data Struction In ITF
HA 与PQM 模块接口的数据结构参见AS 目录下SD5182HV100 接口数据结构.xlsx 文档。
5.3.6 Packet Analyze (PA)
5.3.6.1 Introduction of the Frame
PA 支持ETH(Ethernet II 和IEEE802.3 SNAP)和PPPoE 两种基本帧结构。支持各种基于此
三种以太帧的上层帧结构，主要包括：IEEE802.1Q、PPPoE、IPoE、IPoPPPoE 等。
VLAN TAG 识别，内外层每层4 个TPID 进行匹配识别，每个都可以配置；
报文格式参见《ONT 报文格式查询手册》。
SD5182HV100 Functional Specification Page 180 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.3.6.2 Special Field Extracted
按照帧结构和帧格式，提取帧数据中的特征域，提取后的特征域经过编码后可作为流分类
的输入。PA 支持L2/L3/L4 层特征域的提取。特征域提取规则参见《ONT 报文格式查询手
册》。
5.3.7 Flow Classify (FC)
FC 模块通过PA 输出的特征域，查找192 条流规则表，并进行匹配，根据匹配结果选择
优先级和送NP 的报文信息。本处需要识别的接入报文：主要是指一些需要捕获到CPU
处理的特殊协议报文。
5.3.7.1 Process Flow Of FC
FC 模块流分类处理流程如下：
从PA接收数据包描述符FCB
和报文特征域数据
开始
MAP表项与数据包数据进行
匹配
根据匹配结果，查找动作
表
根据动作表配置刷新描述
符，输出
结束
Figure 5.3-2 FC 流匹配处理流程图
SD5182HV100 Functional Specification Page 181 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.3.7.2 Format Of MAP
MAP表支持192条流表项，每个有效表项的位宽为164bit，实际表项排布方式参见寄存器列表，有效表项结构如下：
Field Name Width（bit） Description
valid
1
表项有效标识，高电平有效。
eof
1
联合表项结束标识，高电平有效。
label
2
label标签。表示的含义如下：
2'b00：label 0；
2'b01：label 1；
2'b10：label 2；
2'b11：label 3；
entry_pri
4
表项优先级。0表示最低优先级，15表示最高优先级。
pf_id
5
Quark配置的Profile ID （PF_ ID）。
fcid_out_en
1
FCID输出有效标识。
label_pri
2
Label的优先级，当多个label命中时，按优先级进行选择PQ优先级。0：优先级最高；3：优先级最低。
fcid
8
流FCID。
1p_profile_id
2
802.1p映射模板ID。
dscp_profile_id
2
DSCP映射模板ID。
pac_type_m_en
1
Packet type 修改使能。
pac_type_m
8
Packet type ，根据匹配结果对原始pac_type进行修改。
tag_match_en
1
Tag 匹配使能。
tag_ind
1
0：untag ；
1：tag 。
pq
2
入队优先级修改使能时的自定义值。
pq_en
2
修改入队优先级使能。
2'b00：不指定优先级。
2'b01：使用外层pbit值；
2'b10：使用DSCP映射值；
2'b11：使用自定义值。
SD5182HV100 Functional Specification Page 182 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
igr
32
物理入口，BITMAP格式。
0：xPON；（GE8）
1：保留；
2：保留；
3：PRBS；
4：CPU专用端口；
5：CPU扩展端口；
6：CPU扩展端口；
7：CPU扩展端口；
8：ETH0；（GE0）
9：ETH1；（GE1）
10：ETH2；（GE2）
11：ETH3；（GE3）
12：ETH4（RGMII）；（GE4）
13：ETH5（PCIe重用的以太端口）；（GE5）
14~19 保留；
20：WOE（WiFi Offloading Engine）通道；
21~29 保留；
30 ：环回通道（若IPS从PRBS收到的报文环回标识为1，则为30，而不是PRBS）；
31 ：组播硬件环回通道；
g2_mode
2
G2匹配域的匹配规则。
2’b00：等于；
2’b01：不等；
2’b10：小于；
2’b11：大于等于。
g1_mode
2
G1匹配域的匹配规则。
2’b00：等于；
2’b01：不等；
2’b10：小于；
2’b11：大于等于。
g0_mode
2
G0匹配域的匹配规则。
2’b00：等于；
2’b01：不等；
2’b10：小于；
2’b11：大于等于。
k2_mask
4
G2匹配域/KEY2对应的MASK。
k1_mask
5
G1匹配域/KEY1对应的MASK。
k0_mask
5
G0匹配域/KEY0对应的MASK。
g2
7
G2匹配域编码。
SD5182HV100 Functional Specification Page 183 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
g1
7
G1匹配域编码。
g0
7
G0匹配域编码。
k2
16
G2匹配域对应的KEY。
k1
16
G1匹配域对应的KEY。
k0
32
G0匹配域对应的KEY。
Table 5.3-2 MAP表项
MAP 子表的划分：
将192条流规则表分成12个子表，12个流分类子表划分结构如下表所示：
RAM0 RAM1
子表0
0~15 子表6 96~111
子表1
16~31 子表7 112~127
子表2
32~47 子表8 128~143
子表3
48~63 子表9 144~159
子表4
64~79 子表10 160~175
子表5
80~95 子表11 176~191
Table 5.3-3 MAP表子表划分
5.3.7.3 Match Field Selected And Match Table
5.3.7.3.1 Match Field
匹配域选择方式如下：
 支持128个匹配域编码，其中SIPv6、DIPv6各占两个编码。
 MAP表中配置不同的匹配域编码（g0、g1、g2），选择不同的匹配域进行匹配。
匹配域和编码表如下：
域名 位宽 域编号 说明
有效判断
SD5182HV100 Functional Specification Page 184 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
UN_USE
64
0
不使用
选择UN_USE表示 该域不参与匹配
DMAC
48
1
DMAC
恒有效
SMAC
48
2
SMAC
恒有效
DSAP
8
3
DSAP
SNAP有效
SSAP
8
4
SSAP
SNAP有效
CTRL
8
5
CTRL
SNAP有效
SUBTYPE_3AH
8
6
802.3ah：SUBTYPE
802.3ahETHTYPE=0x8809 有效
FLAGS_3AH
16
7
802.3ah：FLAGS
ETHTYPE=0x8809802.3ah有效
CODE_3AH
8
8
802.3ah：CODE
ETHTYPE=0x8809802.3ah有效
MELMDL_1AG
3
9
802.1ag ：MELMDL
802.1ag 有效
OPCODE_1AG
8
10
802.1ag ：OPCODE
802.1ag有效
MPLS_TU_1BYTE
8
11
T/U指针标记在栈底标签后 第一个字节
MPLS 报文
STPID
2
12
外层TPID索引【注1】
TAG报文
SPBIT
3
13
外层PBIT
TAG报文
SVLAN
12
14
外层VLAN
TAG报文
CTPID1
2
15
内层TPID索引1【注1】
TAG层数为2的报文
CPBIT1
3
16
内层PBIT1
TAG层数为2的报文
CVLAN1
12
17
内层VLAN1
TAG层数为2的报文
CTPID2
2
18
内层TPID索引2【注1】
TAG层数为3的报文
CPBIT2
3
19
内层PBIT2
TAG层数为3的报文
CVLAN2
12
20
内层VLAN2
TAG层数为3的报文
ETYPE
16
21
以太类型
恒有效
ARP_DIP
32
22
ARP报文DIP域
ARP报文有效
reserved
23~31
保留
SPORT
16
32
TCP/UDP源端口号
TCP/UDP报文有效
DPORT
16
33
TCP/UDP目的端口号
TCP/UDP报文有效
ICMPv6_TYPE
8
34
ICMPv6报文类型
ICMPv6报文有效
SD5182HV100 Functional Specification Page 185 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
SIPv4
32
35
SIPv4
下面三种报文时有效： 非隧道IPv4 DsLite报文 6RD报文
DIPv4
32
36
DIPv4
下面三种报文时有效： 非隧道IPv4 DsLite报文 6RD报文
TOS
8
37
IPv4报文头中的TOS域
下面三种报文时有效： 非隧道IPv4 DsLite报文 6RD报文
IPv4_PROTOCOL
8
38
IPv4报文头中的PROTOCOL域
下面三种报文时有效： 非隧道IPv4 DsLite报文 6RD报文
reserved
39~44
保留
SIPv6[63:0]
64
45
SIPv6[63:0]
下面三种报文时有效： 非隧道IPv6 DsLite报文 6RD报文
SIPv6[127:64]
64
46
SIPv6[127:64]
下面三种报文时有效： 非隧道IPv6 DsLite报文 6RD报文
DIPv6[63:0]
64
47
DIPv6[63:0]
下面三种报文时有效： 非隧道IPv6 DsLite报文 6RD报文
DIPv6[127:64]
64
48
DIPv6[127:64]
下面三种报文时有效： 非隧道IPv6 DsLite报文 6RD报文
SD5182HV100 Functional Specification Page 186 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
NEXT_HD
4x8
49
匹配IPv6 4个NEXT HEAHER中任意一个；
只支持是匹配，不支持掩码；
同一个表项中G0，G1和G2，只能配置1个域。
NEXT_HD有效
TC
8
50
IPv6 报文头中的TC域
下面三种报文时有效： 非隧道IPv6 DsLite报文 6RD报文
FL
20
51
IPv6 报文头中的FLOW LABEL域
下面三种报文时有效： 非隧道IPv6 DsLite报文 6RD报文
reserved
52~59
保留
PPPoE_CODE
8
60
PPPoE 报文CODE 域
PPPoE 报文
PPPoE_TAG_TYPE
16
61
PPPoE Discovery报文TAG_TYPE域
PPPoE 报文
LCP_CODE
8
62
PPPoE Session报文Protocol后第一个字节
PPPoE Session阶段报文
SESSION_ID
16
63
PPPoE ESSION_ID
PPPoE Session阶段报文
PPPoE_PROTOCOL
16
64
PPPoE Session阶段报文Protocol域
PPPoESession阶段 报文
ETH_ENCAP
1
65
封装类型: 0：ETH II封装; 1：SNAP封装.
恒有效
PPP_ENCAP
1
66
PPPoE封装: 0：非PPPoE封装； 1：PPPoE封装.
恒有效
FLENGTH
14
67
报文长度（不包括CRC长度）
恒有效
FRM_TYPE
2
68
帧类型: 2’b00：单播; 2’b01：组播; 2’b10：广播; 2’b11：保留.
恒有效
SD5182HV100 Functional Specification Page 187 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
TAG_TYPE
2
69
报文原始TAG类型： 2’b00：UNTAG 2’b01：PRI_TAG 2’b10：TAG 2’b11：保留
恒有效
TAG_SUM
2
70
报文原始TAG层数： 2’b00：无TAG； 2’b01：一层； 2’b10：两层； 2’b11：保留
恒有效
IP_FRAME
2
71
IP报文类型： 2’b00：非IP报文； 2’b01：IPv4； 2’b10：IPv6； 2’b11：保留
恒有效
L4T
2
72
L4类型 2’b00：非TCP/UDP 2’b01：TCP 2’b10：UDP 2’b11：ICMP/ICMPv6
恒有效
IP_FRAG
1
73
IPv4报文分片指示 0：非IPv4分片； 1：IPv4分片
下面三种报文时有效： 非隧道IPv4 DsLite报文 6RD报文
PKT_TUNNEL
2
74
隧道类型 2’b00：非隧道报文； 2’b01：DS_Lite报文； 2’b10：6RD报文； 2’b11：保留
恒有效
Reserved
75
保留
---
TCP_PLD_LEN
16
76
TCP 净荷长度
TCP报文有效
SD5182HV100 Functional Specification Page 188 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
TCP_CB
6
77
TCP报文头中的Contrl bits域【注3】
TCP 报文
PAC_TYPE
8
78
协议报文类型，编码参见PAC_TYPE
恒有效
LINE_INFO
20
79
线路信息GEMPORT/LLID
恒有效
FC_ID
8
80
Default 流ID
当FC 没有匹配命中时，将该ID作为FC ID输出，即透传.
恒有效
UDF0
16
81
PA自定义域0，T/U指针再偏移N byte后的2Byte 【注2】
T/U指针偏移N字节后自定义范围内有效。
UDF1
16
82
PA自定义域1，T/U指针再偏移N byte后的2Byte 【注2】
T/U指针偏移N字节后自定义范围内有效。
UDF2
16
83
PA自定义域2，T/U指针再偏移N byte后的2Byte 【注2】
T/U指针偏移N字节后自定义范围内有效。
UDF3
32
84
PA自定义域3，T/U指针再偏移N byte后的4Byte 【注2】
T/U指针偏移N字节后自定义范围内有效。
UDF4
32
85
PA自定义域4，T/U指针再偏移N byte后的4Byte 【注2】
T/U指针偏移N字节后自定义范围内有效。
RANGE0_MATCH
1
86
范围匹配0的结果
恒有效
RANGE1_MATCH
1
87
范围匹配1的结果
恒有效
RANGE2_MATCH
1
88
范围匹配2的结果
恒有效
RANGE3_MATCH
1
89
范围匹配3的结果
恒有效
DROP_REASON
8
90
丢弃原因，编码参
恒有效
METADATA
32
93
IPS 产生的METADATA数据
恒有效
reserved
94~127
保留 【注3】
Table 5.3-4 匹配域和编码表
匹配域有效判断：匹配域需要通过报文的类型来分析报文对应的匹配域是否有效。如果报文类型与匹配域不符，则对应的匹配域无效，匹配结果为不匹配。例如DIPv4域，当报
SD5182HV100 Functional Specification Page 189 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
文为PPPoE承载的IP报文时，需要通过PPPoE_Protocol判断PPPoE承载的是IPv4还是IPv6。当为IPv4时，DIPv4域有效；当为IPv6时，DIPv4域无效。
【注1】：外层STPID，内层CTPID配置，分别对应一组寄存器。
【注2】：自定义域说明。。根据T/U指针取偏移数据
【注3】：域编号77支持位宽8bit的BITMAP掩码功能。
 将KEY0/KEY1/KEY2的次低字节定义为对应KEY的MASK（最低字节为KEY内容）；
 此域编码段FC MAP表中原有的MASK无意义。
5.3.7.3.2 Match Field distribute
MAP表项可以支持3个匹配域选择（g0，g1，g2）。
 g0可以选择的匹配域最长为32bit，g1和g2可以选择的匹配域最长为16bit。
 当g1选择长度超过16bit的匹配域时，如DIPv4、SIPv4、DIPv6[63:32]等，自动将g1、g2联合成一个32bit的匹配域进行匹配，匹配域构造模式为｛KEY2，KEY1｝。此时g2选择的匹配域不参与匹配。
 对于长度超过32bit的匹配域，如MAC、SIPv6、DIPv6等，可以由g0、g1、g2域联合进行选择。 域名 位宽 域编号 G0[31:0] G1[15:0] G2[15:0]
UN_USE
64
0
UN_USE
UN_USE
UN_USE
DMAC
48
1
DMAC [31:0]
DMAC [47:32]
DMAC [47:32]
SMAC
48
2
SMAC [31:0]
SMAC [47:32]
SMAC [47:32]
DSAP
8
3
{24’b0,DSAP}
{8’b0,DSAP}
{8’b0,DSAP}
SSAP
8
4
{24’b0,SSAP}
{8’b0,SSAP}
{8’b0,SSAP}
CTRL
8
5
{24’b0,CTRL}
{8’b0,CTRL}
{8’b0,CTRL}
SUBTYPE_3AH
8
6
{24’b0,SUBTUPE_3AH}
{8’b0,SUBTUPE_3AH}
{8’b0,SUBTUPE_3AH}
FLAGS_3AH
16
7
{16’b0,FLAGS_3AH}
FLAGS_3AH
FLAGS_3AH
CODE_3AH
8
8
{24’b0,CODE_3AH}
{8’b0,CODE_3AH}
{8’b0,CODE_3AH}
MEL_1AG
3
9
{29’b0,MEL_1AG}
{13’b0,MEL_1AG}
{13’b0,MEL_1AG}
OPCODE_1AG
8
10
{24’b0,OPCODE_1AG}
{8’b0,OPCODE_1AG}
{8’b0,OPCODE_1AG}
MPLS_TU_1BYTE
8
11
{24’b0,MPLS_TU_1BYTE}
{8’b0,MPLS_TU_1BYTE}
{8’b0,MPLS_TU_1BYTE}
STPID
2
12
{30’b0,STPID}
{14’b0,STPID}
{14’b0,STPID}
SPBIT
3
13
{29’b0,SPBIT}
{13’b0,SPBIT}
{13’b0,SPBIT}
SD5182HV100 Functional Specification Page 190 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
SVLAN
12
14
{20’b0,SVLAN}
{4’b0,SVLAN}
{4’b0,SVLAN}
CTPID1
2
15
{30’b0,CTPID1}
{14’b0,CTPID1}
{14’b0,CTPID1}
CPBIT1
3
16
{29’b0,CPBIT1}
{13’b0,CPBIT1}
{13’b0,CPBIT1}
CVLAN1
12
17
{20’b0,CVLAN1}
{4’b0,CVLAN1}
{4’b0,CVLAN1}
CTPID2
2
18
{30’b0,CTPID2}
{14’b0,CTPID2}
{14’b0,CTPID2}
CPBIT2
3
19
{29’b0,CPBIT2}
{13’b0,CPBIT2}
{13’b0,CPBIT2}
CVLAN2
12
20
{20’b0,CVLAN2}
{4’b0,CVLAN2}
{4’b0,CVLAN2}
ETYPE
16
21
{16’b0,ETYPE}
ETYPE
ETYPE
ARP_DIP
32
22
ARP_DIP
ARP_DIP
不参与匹配
SPORT
16
32
{16’b0,SPORT}
SPORT
SPORT
DPORT
16
33
{16’b0,DPORT}
DPORT
DPORT
ICMPv6_TYPE
8
34
{24’b0,ICMPv6_TYPE}
{8’b0,ICMPv6_TYPE}
{8’b0,ICMPv6_TYPE}
SIPv4
32
35
SIPv4 [31:0]
SIPv4 [31:0]
不参与匹配
DIPv4
32
36
DIPv4 [31:0]
DIPv4 [31:0]
不参与匹配
TOS
8
37
{24’b0,TOS}
{8’b0,TOS}
{8’b0,TOS}
IPv4_PROTOCOL
8
38
{24’b0,IPv4_PROTOCOL}
{8’b0,IPv4_PROTOCOL}
{8’b0,IPv4_PROTOCOL}
SIPv6[63:0]
64
45
SIPv6 [31:0]
SIPv6 [63:32]
不参与匹配
SIPv6[127:64]
64
46
SIPv6 [95:64]
SIPv6 [127:96]
不参与匹配
DIPv6[63:0]
64
47
DIPv6 [31:0]
DIPv6 [63:32]
不参与匹配
DIPv6[127:64]
64
48
DIPv6 [95:64]
DIPv6 [127:96]
不参与匹配
NEXT_HD
4x8
49
{24’b0,NEXT_HD}
{8’b0,NEXT_HD}
{8’b0,NEXT_HD}
TC
8
50
{24’b0,TC}
{8’b0,TC}
{8’b0,TC}
FL
20
51
{12’b0,FL}
{12’b0,FL}
不参与匹配
PPPoE_CODE
8
60
{24’b0,PPPoE_CODE}
{8’b0,PPPoE_CODE}
{8’b0,PPPoE_CODE}
PPPoE_TAG_TYPE
16
61
{16’b0,PPPoE_TAG_TYPE}
PPPoE_TAG_TYPE
PPPoE_TAG_TYPE
LCPCODE
8
62
{24’b0,LCPCODE}
{8’b0,LCPCODE}
{8’b0,LCPCODE}
SESSION_ID
16
63
{16’b0,SESSION_ID}
SESSION_ID
SESSION_ID
PPPoE_PROTOCOL
16
64
{16’b0,PPPoE_PROTOCOL}
PPPoE_PROTOCOL
PPPoE_PROTOCOL
ETH_ENCAP
1
65
{31’b0, ETH_ENCAP}
{15’b0, ETH_ENCAP}
{15’b0, ETH_ENCAP}
PPP ENCAP
1
66
{31’b0,PPP ENCAP}
{15’b0,PPP ENCAP}
{15’b0,PPP ENCAP}
FLENGTH
14
67
{18’b0,FLENGTH}
{2’b0,FLENGTH}
{2’b0,FLENGTH}
FRM_TYPE
2
68
{30’b0,FRM_TYPE}
{14’b0,FRM_TYPE}
{14’b0,FRM_TYPE}
TAG_TYPE
2
69
{30’b0,TAG_TYPE}
{14’b0,TAG_TYPE}
{14’b0,TAG_TYPE}
TAG_SUM
2
70
{30’b0,TAG_SUM}
{14’b0,TAG_SUM}
{14’b0,TAG_SUM}
IP_FRAME
2
71
{30’b0,IP_FRAME}
{14’b0,IP_FRAME}
{14’b0,IP_FRAME}
L4T
2
72
{30’b0,L4T}
{14’b0,L4T}
{14’b0,L4T}
SD5182HV100 Functional Specification Page 191 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
IP_FRAG
1
73
{31’b0,IP_FRAG}
{15’b0,IP_FRAG}
{15’b0,IP_FRAG}
PKT_TUNNEL
2
74
{30’b0,PKT_TUNNEL}
{14’b0,PKT_TUNNEL}
{14’b0,PKT_TUNNEL}
TCP_PLD_LEN
16
76
{16’b0,TCP_PLD_LEN}
TCP_PLD_LEN
TCP_PLD_LEN
TCP_CB
6
77
{26’b0,TCP_CB}
{10’b0,TCP_CB}
{10’b0,TCP_CB}
PAC_TYPE
8
78
{24’b0,PAC_TYPE}
{8’b0,PAC_TYPE}
{8’b0,PAC_TYPE}
LINE_INFO
20
79
{12’b0,LINE_INFO}
{12’b0,LINE_INFO}
不参与匹配
FC_ID
8
80
{24’b0,FC_ID}
{8’b0,FC_ID}
{8’b0,FC_ID}
UDF0
16
81
{16’b0,UDF0}
UDF0
UDF0
UDF1
16
82
{16’b0,UDF1}
UDF1
UDF1
UDF2
16
83
{16’b0,UDF2}
UDF2
UDF2
UDF3
32
84
UDF3
UDF3
不参与匹配
UDF4
32
85
UDF4
UDF4
不参与匹配
RANGE0_MATCH
1
86
{31’b0,RANGE0_MATCH}
{15’b0,RANGE0_MATCH}
{15’b0,RANGE0_MATCH}
RANGE1_MATCH
1
87
{31’b0,RANGE1_MATCH}
{15’b0,RANGE1_MATCH}
{15’b0,RANGE1_MATCH}
RANGE2_MATCH
1
88
{31’b0,RANGE2_MATCH}
{15’b0,RANGE2_MATCH}
{15’b0,RANGE2_MATCH}
RANGE3_MATCH
1
89
{31’b0,RANGE3_MATCH}
{15’b0,RANGE3_MATCH}
{15’b0,RANGE3_MATCH}
DROP_REASON
8
90
{24’b0,DROP_REASON}
{8’b0,DROP_REASON}
{8’b0,DROP_REASON}
METADATA
32
93
METADATA
METADATA
不参与匹配
Table 5.3-5 匹配域分布
一条流可以由多个匹配域标识，FC的每个表项支持3个匹配域，一条表项可以表示一条流。如果流不需要3个匹配域，则可以不使能3个域中的任意选择域。下面通过几个实例来说明。
【实例一】：匹配DMAC[47:0]。
 DMAC的匹配域编码为0x1。
 可以有两种方式：g0+g1（g0=0x1，g1=0x1，g2=0x0）或者g0+g2 （g0=0x1，g1=0x0，g2=0x1）。
SD5182HV100 Functional Specification Page 192 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 g0用于匹配DMAC[31:0]，g1或者g2用于匹配DMAC[47:32]。
【实例二】：匹配DIPv6[63:0]。
 DIPv6[63:0]匹配域编码为0x47。
 配置为（g0=0x47，g1=0x47，g2=0x0），其中g0用于匹配DIPv6[31:0]，g1+g2联合匹配DIPv6[63:32]，g2选择的匹配域不参与匹配。
【实例三】：匹配SPBIT。
 SPBIT的匹配域编码为0x13。
 可以在g0、g1、g2三个中任选一个配置为0x13（匹配SPBIT），其他两个匹配域配置为0x0（不使用）。
 由于SPBIT长度为3比特，所以需要在高位补0以满足32/16bit的匹配域比较。即如果配置为g0=0x13，则需要在高位补29’b0；如果配置g1/g2=0x13，则需要在高位补13’b0。
5.3.7.3.3 United Table
当一条流超过3个以上的匹配域进行匹配时，则需要使用联合表项的方式进行流匹配。
 最大可以支持4个表项的联合，即最多支持12个匹配域表征一条流。
 联合表项必须连续且位于同一子表内，不能中断。
 多表项联合由VALID+EOF标识，EOF是表项结束标志。
 单表项表示一条流时，VALID和EOF同时为1。
 多表项联合表征一条流时，每个表项VALID都要有效。只有最后一个表项的EOF为1，其他的表项EOF为0，联合表项的优先级、流标识等域只有在EOF有效时才有效。
联合匹配表项示意如下：
SD5182HV100 Functional Specification Page 193 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
1 1
1 0
1 1
0 0
1 0
1 0
1 0
1 0
1 1
0 1
1 0
1 1
2个表项组成1条流
没有有效的EOF表项
2个表项组成1条流
有效单表项流多表项流无效表项
VALID EOF
4个表项组成1条流
Figure 5.3-3 联合匹配表项示意图
【实例】：匹配SIPv6[127:0]。
 需要同一子表内连续两个表项配置。
 SIPv6[63:0]的匹配域编码为0x45，SIPv6[127:64]的匹配域编码为0x46。
配置项 表项0 表项1
VALID 1 1
EOF 0 1
G0 0x45 （匹配SIPv6[31:0]） 0x46 （匹配SIPv6[95:64]）
G1 0x45 （匹配SIPv6[63:32]） 0x46（匹配SIPv6[127:96]）
G2 0x0 0x0
Table 5.3-6 联合表项匹配SIPv6配置表
SD5182HV100 Functional Specification Page 194 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.3.7.4 Match Rule
支持的匹配规则有：是非匹配、掩码匹配、范围匹配、联合表项匹配和优先级匹配。
5.3.7.4.1 Right Or Wrong Match
匹配域匹配支持是匹配（也叫做正向匹配）和非匹配（也叫做反向匹配）。
 是匹配：匹配域和规则相等则认为匹配。
 非匹配：匹配域和规则不相等则认为匹配。
5.3.7.4.2 Match With Mask
匹配域掩码使用类似IP掩码的方法，支持从低位到高位的连续掩码，掩码值范围为0~31。
【掩码匹配实例】：匹配域为SIPv4：
 如果掩码值为4，则表示SIPv4的低4位（bit[3:0]）被掩为0，只需匹配SIPv4的bit[31:4]。
 如果掩码值为31，则表示SIPv4的低31位（bit[30:0]）被掩为0，只匹配SIPv4的bit[31]。
 如果掩码值为0，则没有数据被掩掉，需要匹配SIPv4[31:0]。
当g1配置的匹配域长度超过16bit，g1、g2联合使用时，使用g1域的掩码配置来进行掩码。
每个匹配域都可以单独掩码，掩码后的匹配域和掩码后的预定义规则（key0，key1，key2）进行匹配。
5.3.7.4.3 Range Match
范围匹配支持以下特征：
 支持掩码后范围匹配。
 支持大于等于/小于匹配。
 支持SMAC/DMAC地址和SIPv6/DIPv6地址高/低64bit的范围匹配。
 通过寄存器配置匹配的范围，共支持4组范围匹配。
 匹配的计算方法为：最小值 <= 匹配域 <= 最大值。
 范围匹配的结果，作为匹配域（RANGE0_MATCH~RANGE3_MATCH）参与匹配。对应的匹配域编码为86~89。
 范围匹配结果作为特征值
【范围匹配实例】：SMAC/DMAC+ SIPv6/DIPv6高64bit范围匹配：
 输入报文格式：
SD5182HV100 Functional Specification Page 195 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
o SMAC：0x00-01-02-03-55-88。
o DMAC：0x00-01-02-60-00-00。
o SIPv6[127:64] ：5d:00:00:00:5c:00:11:00。
o DIPv6[127:64]：5d:00:00:00:ee:00:00:00。
 匹配表配置及匹配
o 匹配表配置及匹配如下：
匹配域选择
范围域选择
匹配域编码
最小值
最大值
匹配值
RANGE0_MATCH
SMAC
86
0x00-01-02-03-55-66
0x00-01-02-03-55-ff
1
RANGE1_MATCH
DMAC
87
0x00-01-02-03-55-66
0x00-01-02-66-00-00
1
RANGE2_MATCH
SIPv6[127:64]
88
5d:00:00:00:5c:00:11:00
5d:00:00:00:5c:00:12:ff
1
RANGE3_MATCH
DIPv6[127:64]
89
5d:00:00:00:ff:00:77:00
5d:00:00:00:5c:00:99:ff
0
Table 5.3-7 SMAC/DMAC+ SIPv6/DIPv6高64bit范围匹配表
 匹配结果：由上表可知，如果入口流匹配选择匹配域编码为86/87/88，且匹配规则为是匹配/不掩码，则该报文可以命中流。如果入口流匹配选择匹配域编码为87/88/89，且匹配规则为是匹配/不掩码，则该报文无法命中流。
5.3.7.4.4 Match With United Table
当匹配域超过3个，单个表项不能满足匹配需求时，可以将多个表项联合起来完成一条流的匹配处理。
5.3.7.4.5 Match With Priority
同一LABEL中，根据PRI域选择优先级高的匹配表项，优先级相同时选择地址小的匹配表项。
5.3.7.5 Flow Match And Flow Select
5.3.7.5.1 Flow Match
经过前面匹配域选择、匹配规则的描述，可以总结出流匹配的判断条件：
 入口匹配为BITMAP，表示不同端口可以匹配同一条流。
 KEY0/KEY1/KEY2的匹配规则相同：
o 配置G0/G1/G2。
o 配置匹配规则。
SD5182HV100 Functional Specification Page 196 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
o 配置KEY0/KEY1/KEY2。
o G0/G1/G2选择得到的报文匹配域与KEY0/KEY1/KEY2按照匹配规则进行比较。当入口匹配且流规则全部匹配，表示流匹配成功。
【注】：联合表项匹配成功的条件为：联合表项中所有表项都匹配。
5.3.7.5.2 Flow Select
流选择的规则如下：
 多条流命中同一label时，流选择遵守如下规则：
o 选择最高优先级的流（优先级编码数值高对应的优先级高）。
o 优先级相同，来自同一LABEL表，则选择地址索引小的流。
 流命中后获取流标识FCID。每一个LABEL输出1个FCID。
 如果流未命中，则无法获得流规则和流标识。因此不需要查找流动作表，FC不对报文做任何处理。 5.3.7.6 Flow Action（Priority process）
完成流匹配以后，根据匹配结果查询流动作表，进行后续报文入队优先级处理：
 支持四种队列优先级来源，即不指定优先级/使用报文外层PBIT值/使用DSCP映射值/使用自定义值，支持以下4种模式。
o 0：不指定优先级，则使用前级模块得到的队列优先级。
o 1：使用原始报文外层PBIT值，如果为UNTAG报文，保持原值（4个模板）。
o 2：使用原始报文DSCP映射值，使用DSCP值和DSCP模板（4个）获取的优先级。如果报文为非IP报文，或DSCP域无效的报文，保持不变。
o 3：使用自定义值2bit。
 支持Label 优先级配置label_pri，当有多个label命中时，需要先根据label 优先级选出对应label命中的流，然后，根据该label中优先级配置输出报文入队优先级。0：最高优先级；3：为最低优先级。
5.3.7.7 RAM Type
FC模块内的RAM类型如下： Memory名称 深宽度（数类型 频Mask 校软件处理
SD5182HV100 Functional Specification Page 197 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
度 Bit） 量 (SP/TP/DP) 率 （M） 验
PA_MAP_MEM
96
169164
2
SP
500
off
ECC
上报告警和中断，软件检测中断或告警，再对根据ECC中断地址重新配置表项。
PA_FIFO_RAM
32
129
1
TP
500
off
ECC
上报告警和中断，无需要软件处理。
PA_FCID_RAM
128
10
1
SP
500
off
ECC
上报告警和中断，软件检测中断或告警，再对ECC地址重新配置表项。
Table 5.3-8 RAM类型表
MAP_MEM的数据结构参见 Format Of Map 章节。
5.3.7.8 Interrupt Or Alarm
FC模块支持一下告警或中断：
 支持ECC错误告警和中断上报，包含FCB带内ECC校验和Memory ECC校验。
 支持ECC错误地址上报。
 支持中断强插。
 支持中断掩码。
 PA 报文识别出现的告警。包含：checksum 错误告警，入口报文检查告警，报文头超过128 byte 告警。
5.3.8 Performance
HA模块主频为500MHz，每16 clock 完成1个报文的处理，输出为16 clock/pkt。吞吐率最大为30Mpps。
 PA：每16 clock 完成1个报文的识别；
 FC：MAP表由2块RAM组成，6个流匹配处理单元，每个clock 可以读出2个表项，匹配2条流，96个clock内能够处理的6条流。
HA 的处理延时：最大156 个clock 。
SD5182HV100 Functional Specification Page 198 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 PA 入口FIFO延时：20 clock 。
 PA 报文识别处理延时：20 clock 。
 FC 报文流匹配处理延时：100 clock 。
 FC出口FIFO延时：16 clock 。
5.3.9 DFx Requirement
HA 支持一下DFx特性：
 Memory 支持ECC 校验，上报错误告警和错误地址，软件检测告警或中断后，对ECC 错误地址重新刷新。
 FCB 控制域支持带内ECC校验，上报错误告警和错误地址。
 支持报文checksum，入口合法性检查，报文头超过128byte 检查。
 支持FC输出FCB域可配置功能，即不管HA是否有输入报文，HA输出FCB域都可强制配置。
 支持入口报文统计：
1. 入口报文个数统计。
2. 入口报文报文丢弃统计，根据FCB中的丢弃原因统计，不真正丢弃报文。
3. 分片报文统计，包含IPv4/IPv6/6RD/Dslite报文。
4. Dslite 隧道报文统计。
5. 6RD报文统计。
6. IPv6的AH扩展头长度为奇数的报文统计。
7. 报文头超长（超过128byte）的报文统计。
8. 位置扩展头报文统计。
9. 非法MAC报文统计。
10. STP检查报文统计。
11. 802.1x检查告警统计。
12. L3/L4 checksum错误报文统计。
13. FC 流匹配命中流统计。
14. FC流匹配多条流命中流统计。
15. FC流匹配匹配失败流统计。
SD5182HV100 Functional Specification Page 199 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
16. 三条流统计匹配的流统计，每个TCID对应1个32bit的统计计数器。
5.3.10 Power Management
<Initial deliverable required for FS phase 2. Must be updated and 100% complete for FS phase 3.>
SD5182HV100 Functional Specification Page 200 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.4 PACKET QUEUE MANAGER (PQM)
PQM接收HA新报文信息，将HA解析出的报文信息写入MEMP 中报文FD位置并根据HA送来的报文优先级入PQM内部4个队列。PQM进行入口队列资源管理，在系统出现拥塞的时候，对报文进行有策略丢弃。PQM统计PSA的空闲线程，当PSA有空闲的线程时PQM把新的报文头送给PSA处理。响应PSA Pull命令，从MEMP读出报文送往PSA。 PQM响应PSA的TransmitDispatch命令，发送帧数据到PE进行编辑，可以根据TransmitDispatch命令发送整帧、帧头到PE。
5.4.1 Main Feature
 支持多播硬复制；
 支持入队管理：
o HA送来的原始报文最多支持4个优先级报文队列(PRI) ；
o PSA TransmitDispatch 指示硬复制的多播根报文最多支持4个优先级报文队列(PRI)；
o 各个优先级报文队列，可以分别配置尾丢弃、PLB拥塞丢弃门限、拥塞门限；
o 各个优先级报文队列，以可配置的SP+WRR/DRR方式调度出队；
o 原始报文队列总深度最大支持3K，多播根报文队列总深度为128Packet；
 当PSA有空闲线程时，PQM从MEMP读取新报文头数据并发送到PSA：
o 将报文的前128Byte数据+32Byte FD信息交给PSA；
o 上交的数据包括报文FD控制信息，如：报文类型、报文长度等；
 响应PSA获取数据的命令，从PLB读取数据送给PSA，支持以下命令：
o Pull_more；
o Pull_reset。
 支持新报文和 Pull命令之间的RR调度。
 响应PSA 的TransmitDispatch命令，发送帧数据到PE进行编辑，可以根据TransmitDispatch命令发送整帧、帧头到PE。
 管理PAC_ID资源，申请和释放PAC_ID，PAC_ID可用数量可以配置，最大支持96个PAC_ID。
 管理WGT_ID资源，申请和释放WGT_ID，WGT_ID数量支持128个。
 根据PSA指示释放PLB Cell资源。
SD5182HV100 Functional Specification Page 201 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 支持PSA命令的正确性的检测。
 支持OE保序流ID的映射；
 统计PQM的资源占用情况，经过加权计算后提供给CRG，作为调整频率的依据。
5.4.2 Terminology
The following terms have special meanings in this section. Term Description
FD
帧对应的描述符
PD
PAC_ID对应的描述符
MEMP
Memory Pool，内置缓存空间，使用SRAM搭建。
PQM
Packet Queue Manager，入端口报文队列管理。
FAM
Free Address Manager
PE
Packet Edit
PAC_ID/PID
报文ID
WGT_ID/WID
权重ID，PQM用来绑定多播根报文。
MCID
多播ID，用来绑定出口缓存中的多播报文。
Table 5.4-1 PQM Terminology
SD5182HV100 Functional Specification Page 202 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.4.3 PQM Overview
HA
MEMP
FD
SP/
WRR
PSA
credit pull
PSA ITF
MEMP READ ITF
pull rd_cmd
pull rd_data
data transmit
pkt
tran rd_cmd
MEMP WRITE ITF
tran rd_data
app
rls
PE
fd
PD_TABLE
PAC_ID Manage
idle_pid
FAM
PLB rls query
Mc Root
Figure 5.4-1 PQM Overview Diagram
5.4.4 Performance
5.4.4.1 Throughput
接收HA 的FD 为8cycle/pkt， 入队性能为250MHz/8 = 31.25Mpps
PQM 数据总线宽度128bit， 10 个DP_CLK cycle 处理一个Cell； PSA NEW Packet 性能
为 250MHz/10 * 75% = 18.75 Mpps （75%为MEMP 的读效率，内部流水可以无开销）。
PE 接口带宽为128bit * 250MHz * 80% = 25.6Gbps (80%为流水效率)。
5.4.4.2 Latency
空载时，报文提交给PSA 时延约为200cycle， 200*4ns = 800ns
5.4.5 HA FCB Process
SD5182HV100 Functional Specification Page 203 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
MEMP wr itf
HA
FD@32Byte
xoff
Drop prcs
PLB
rls
Ori EQ
Judge
FD Write
Update Queue info PQS
EQ
MCRoot FD
xoff
TP
WGT_ID
app
MRD Write
Mc EQ
Judge
Figure 5.4-2 HA FCB Process
HA 解析完帧头信息后，发送32Byte 的原始报文FD 给PQM。PQM 根据报文的长度、队
列优先级信息和当前的队列拥塞状态进行入队判决，如果报文成功入队，PQM 根据报文
头指针向MEMP 写入这32Byte 的FD 信息，同时更新相应的IQM的队列信息，譬如队尾
指针，队列报文统计等。如果报文入队失败或HA 指示丢弃（可配置是否丢弃）的报文，
则PQM 向FAM 释放PLB 缓存资源，并统计丢弃报文个数。PSA 指示的硬复制的报文不
需要将FD 写入MEMP。
入队判决流程：
SD5182HV100 Functional Specification Page 204 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
接收HA待入队
原始报文
HA指示丢弃?
入队成功
统计原始报文队列资
源
N
结束
Y 配置丢弃 Y
PLB总资源
超过水线？
Y
N
队列的
PLB拥塞丢弃水线
已经满足？
Y
N
PLB&队列拥塞？ Y
N
入队失败
统计丢包个数
向PQS请求更新链表
WGT_ID耗尽?
N
队列处于
尾丢状态？
N
WGT_ID&队列拥
塞？
Y
Y
Y
入队成功
统计多播根队列资源
释放PLB资源
N
接收TP待入队
多播根报文
队列处于
尾丢状态？
Y
N
向PQS请求更新多播根
队列链表
Figure 5.4-3 EnQueue FLOW
SD5182HV100 Functional Specification Page 205 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.4.6 Priority Queues Scheduling
PSA
INC
idle_thr_cnt
PD_TABLE
PAC_ID Manage
idle_pid
app
new_header
process
DEC
MEMP
rd cmd
rd data
qout
pkt_data
sch_en
sch
Figure 5.4-4 Priority Queues Scheduling
PQM 支持4 个原始报文优先级队列,原始报文优先级队列可以配置丢弃门限，单位为PLB
Cell 数，所有原始报文队列的深度之和等于PLB Cell 数量。 支持4 个多播根报文优先级
队列，多播根报文优先级队列可以配置丢弃门限，单位为根报文个数，所有多播根报文队
列的深度之和最大等于128。
PQM 内部维护一个PSA 的空闲线程计数器，当PSA 释放一个线程会给PQM 一个加的统
计脉冲，当PQM 送出一个新报文给PSA 时，空闲线程计数器减一。当空闲线程计数器的
值为非零时，优先级队列里的报文才能调度出队。
4 个原始报文队列和4 个多播根报文队列时展平在一起参与调度的，每个队列有所属自身
队列的3bit 的优先级配置和4bit 的WRR/DRR 权重配置值，当队列的优先级配置的值越
小时，优先级就越高，配置优先级相同的队列调度优先级一样，组内做WRR/DRR 调度；
如下图所示：原始报文队列0、1 和多播队列0 配置成同一优先级，譬如配置成7；原始
报文队列2、3 和多播队列1 配置成同一优先级，譬如配置成6；多播队列2、3 配置成同
一优先级，譬如配置成5；那么调度关系就是：
首先：
原始报文队列0、1 和多播队列0 组内进行WRR/DRR 调度， 标记为组7；
SD5182HV100 Functional Specification Page 206 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
原始报文队列2、3 和多播队列1 组内进行WRR/DRR 调度，标记为组6；
多播队列2、3 组内进行WRR/DRR 调度，标记为组5；
然后：
组间进行SP 调度，调度优先级为组5 > 组6 > 组7;
WRR
WRR
SP
pri0_queue
pri1_queue
pri2_queue
pri3_queue
mc_pri3_queue
mc_pri0_queue
mc_pri1_queue
mc_pri2_queue
WRR
Figure 5.4-3 优先级队列调度
5.4.7 PULL Command Process
Quark
MEMP
Pull命令处理
QUK发送PULL命令
发送读命令
PQM
PD表
取PD
Pull返回结果处理
命令历史返回读数据
返回执行结果和数据
SD5182HV100 Functional Specification Page 207 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure 5.4-4 PULL命令处理
PSA开始处理报文后，会发送PullMore、PullReset指令来获取报文控制信息和报文数据，PSA用PAC_ID来标识每条指令，Pull More命令会以1Byte为粒度进行。
PQM首先检查指令的合法性，包括PAC_ID错误、数据范围错误。在执行过程中，PQM会检查指令执行过程的正确性。正确执行的指令会返回命令正确执行指示和报文数据，未能正确执行的指令只返回错误指示和错误类型。
PQM会按命令接收的顺序返回数据。
如果空闲线程计数器非0和Pull命令同时有效时，两者之间进行RR调度，新报文头数据和Pull命令返回的数据通过同一数据接口发送给PSA。
PullMore：以Byte为粒度，初始指针在报文的第129Byte（因为报文的前128B已经交给PSA）， 微码一次最多可以Pull 128Byte64Byte， 因为PQM的PLB缓存Cell大小是160B，当Pull More的长度跨PLB Cell时PQM 只返回本Cell的数据，在数据返回时通过status告诉微码还剩多少数据待返回Cell。即PQM不支持跨Cell读取报文，当一个PullMore被PQM发现跨了Cell之后，PQM只返回当前Cell指针指向的Cell剩余的数据，下一个cell的报文内容不读取也不返回，需要微码根据PullMore response的状态判断是否还需要再发送多一个PullMore指令将上次未返回的在下一个cell的报文读出来。这个时候，微码只需要指示需要推窗的大小。
PullReset：重新将报文的前128Byte（包长小于128Byte，则为实际包长）交给PSA，PullMore指针跳回报文的第129Byte（第二个Cell地址的Offset 为0的位置）。
Pull More 命令的处理：
PQM按照160Byte来维护Pull More指针，新报文上交160Byte给PSA之后,Pull More 初始指针落在报文的第二个Cell offset 为0 的位置，见下图蓝色箭头。
Pull More 的PLB当前 Cell 地址和Cell内Offset 基于Pac_id记录于PQM 的PPTR表中。
Cell内offset 由PQM根据Pull长度来维护，譬如第一次Pull 了65Byte55Byte， 那么PQM就把Cell内Offset移到65Byte55Byte的位置，第二次Pull长度为8 Byte，Cell内Offset移到73Byte63Byte的位置。PSA给PQM的Pull命令只需要提供Pull长度，不需要offset。Pull长度以Byte为粒度 ， 受PSA处理的限制，一次PULL最大的长度为128Byte64Byte。
SD5182HV100 Functional Specification Page 208 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
FD PAYLOAD
32B 128B
PAYLOAD PAYLOAD
160B 160B
CELL0 CELL1 CELL2
Offset = 0
Offset = Σ pull len
Figure 5.4-5 Pull More Process Diagram0
如果Pull 命令的长度没有跨越160Byte Cell 边界，即从之前记录的Pull 的Offset 位置加上
本次Pull 命令的长度不大于160，则PQM 反馈Pull 命令指示的Len 长度的数据，Pull
Response 接口的Status 指示为0。
如果当一个Pull 命令的长度跨越160Byte Cell 边界时，PQM 只返回本Cell 的数据，下一
个Cell 的数据不返回，并通过Pull Response 接口的Status 指示微码还剩下多少没有返
回，微码收到后重新发一个剩余长度的Pull More 命令来PULL 剩下的数据。
如下图所以，当前Cell offset 是在1096Byte 位置， 本Cell 还剩64Byte54Byte 时， PSA 的
Pull more 长度为80Byte60Byte，此时PQM 只返回本Cell 的64Byte54Byte, offset 走到下
一个Cell 的0 地址，并在返回数据时通过Response 状态信号告诉微码还剩16Byte 的数据
未返回，微码收到数据后再重新发一个Pull 16Byte 的命令。
PAYLOAD PAYLOAD
Offset = 0
返回54Byte 数据
Offset =106Byte
PULL LEN == 60Byte
Figure 5.4-6 Pull More Process Diagram1
SD5182HV100 Functional Specification Page 209 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.4.8 PULL Command Set
PQM 模块响应Quark的Pull Reset/More命令，给Quark回复相应长度的Head/Body数据；并根据“O”接口的FreeThread指示，给Quark发送新报文的FD（报文描述信息）和head。
下面介绍Pull Reset/More命令的请求和应答格式。 K接口Request KK接口Response PAC_ID CMD START_LOC PAC_ID CMD RSP_ID STATUS 其他
PullReset
合法检查：0~95，且已经分配过
=1
不关注
同K
同K
同K
Bit[7]==0x0，表示无异常；
Bit[7]==0x1，表示异常，B[6:4]表示错误编码；
OF_ID=0；
DEFAULT_PF_ID=0。
PullMore
=2
[7:0]：不关注；
[15:8]：Pull长度，进行合法检查：0~63表示1~64字节；
同K
同K
同K
Bit[7]==0x0，表示当前cell剩余长度小于Pull长度，Bit[6:0]指示待返回的数据长度；
Bit[7]==0x1，表示异常，B[6:4]表示错误编码；
OF_ID=0；
DEFAULT_PF_ID=0。
CMD非法
不关注
除1、2以外
不关注
同K
同K
同K
Bit[7]==0x1，表示异常，B[6:4]表示错误编码；
OF_ID=0；
DEFAULT_PF_ID=0。
PullNew
PQM根据线程统计实现发送，不关注K接口Request
PQM分配
=0
=0
Bit[7]==0x0，表示无异常；
Bit[7]==0x1，Bit[6:0]表示异常编码
OF_ID和DEFAULT_PF_ID有PQM查表获得。
Table 5.4-2 Pull More/Reset Commond
注：在Pull More/Reset 的Response时，STATUS异常编码需要和COP的异常编码保持统一，STATUS[7:4]，使用除13、14、15三个以外的编码。
SD5182HV100 Functional Specification Page 210 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.4.9 TransmitDispatch Command Process
TransmitDispatch命令有以下几种种类型：
o PQM根据WGT_ID维护硬复制的多播叶子份数，当收到多播硬复制的首叶子报文的TransmitDispatch命令时，读出整包发给PE处理，如果首叶子Discard，则指示下一份叶子为首叶子，并读出整包发给PE，释放叶子PAC_ID；
o 硬复制中间叶子报文的transmitDispatch命令，PQM只读出报文头发给PE处理，释放叶子PAC_ID；
o ，PQM根据Leaf_num和叶子份数统计识别到当前TransmitDispatch命令是硬复制的最后一份报文时释放根报文的PLB资源，释放叶子PAC_ID；
o Copy to Copy:微码对硬复制的叶子再做复制的情况，PQM根据freePkt指示统计硬复制份数，Copy to Copy 叶子会跟硬复制的叶子共享Body.
o 单播报文，把整帧数据发送给PE，此时FreePkt有效，释放PAC_ID和PLB缓存；
o PQM收到Discard命令时，不读MEMP，若FreePkt有效且非多播硬复制的叶子报文，释放PAC_ID和PLB缓存，只发送报文FCB给PE，通知PE丢弃该报文的EC和ED。若多播非最后一份叶子，Freepkt有效时只释放PAC_ID，不释放PLB，PQM收到最后一份叶子时才释放PLB。若discard有效但FreePkt无效的非多播叶子，不读MEMP，发送丢弃FCB给PE，不释放PAC_ID和PLB。多播硬复制叶子的PAC_ID是否释放由微码决定，PLB释放由PQM决定。
o 非法PAC_ID命令（PAC_ID的值96~127）。当收到这种PAC_ID 的transmitDispatch命令的时候，不读MEMP，直接将命令发到PE，同时把丢弃标志置1 。
o PSA指示PQM进行硬复制的（通过mc信号指示硬复制），PQM入队保存多播根报文信息，释放多播根报文的PAC_ID，多播根报文送入优先级队列；
PQM综合TransmitDispatch命令和PAC_ID描述符来判断命令正确性，以下类型的命令被作为错误命令处理：
o 未分配给PSA的PAC_ID命令将被丢弃，并产生告警。
o PSA复制组播叶子分数超过阈值，PQM会丢弃数据，并发送Discard指示给PE。
5.4.10 Memery Pool Interface
PQM和MEMP之间有1个写接口和2个读接口，采用FIFO接口，FIFO位于MEMP。
PQM通过写接口把从HA收到的FD写入PLB。
PQM通过读接口1完成PSA的pull命令和新报文头的数据读取。
SD5182HV100 Functional Specification Page 211 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PQM通过读接口2读出报文数据发送给PE。
PQM受MEMP 接口FIFO的空满状态反压。
5.4.11 PAC_ID Management
PQM从原始报文优先级队列调度出报文，分配PAC_ID，送给PSA处理。PSA发送TransmitDispatch命令后，如果是TransmitDispatch命令中的FREEPKT指示有效，PQM在报文数据发送到PE后，释放PAC_ID。
对于大于95的pac_id，是没有报文数据缓存到MEMP的。当收到这个PAC_ID 的transmitDispatch命令的时候，不读MEMP，直接将命令发到PE，同时把丢弃标志置1。
为节省PAC_ID数量，只有处于以下状态的报文会占用PAC_ID：
A.PSA处理中的报文或在OE队列中等待发送给PQM的报文。
B.在PQM发送队列中等待发送给PE的报文。
在原始报文队列中等待处理的原始报文不占用PAC_ID。
C．进入多播根队列前的报文。
PQM收到命令时会检测对应PAC_ID的当前状态和命令的符合度。PAC_ID有2种状态，收到与当前状态不匹配的命令会产生中断告警。
o PAC_ID已经回收不能再收到PSA命令；
o PAC_ID的值非法；（96~127）
5.4.12 Ordered Flow ID MAPING
支持保序流ID的映射，PQM设置一张映射表，表项深度为128，索引为{chan,pqm_pri}, 表项内容是保序流ID。pqm_pri为HA送给PQM的2bit入队优先级。
5.4.13 Multicast Process
硬复制流程：
微码对原始报文解析之后，如果报文需要进行硬复制，则发送硬复制的TransmitDispatch 命令给PQM，通过mc信号指示PQM进行硬复制，复制份数通过LeafNum标识。PQM申请WGT_ID，保存多播根报文信息 ，释放多播根报文的PAC_ID，报文入多播根优先级队列，统计队列资源；
SD5182HV100 Functional Specification Page 212 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
多播根报文出队时，从MRD 表里获取多播根信息，进行报文的复制，每个多播根队列维
护一个叶子序列号，每发送一份叶子到PSA，序列号加1。每个多播队列以一份叶子的粒
度参与调度。
PQM 基于WGT_ID 统计transmitDispatch 叶子份数，当某个WGT_ID 的transmitDispatch
的叶子份数等于复制份数时，释放多播根的PLB 资源。
PQM 在PSAtransmitDispatch 首份叶子时，申请MCID，MCID 随报文FCB 送给PE。
Copy to Copy : 微码对硬复制叶子再做复制
Copy to Copy 的叶子跟原来的叶子共享根报文，所以WGT_ID 也是同一个，当微码指示
freePkt 时才维护WGT_ID 的权重。如下图所示，标识为1，2，3，4 的叶子是硬复制的叶
子报文，标识为a,b,c 的为叶子2 的Copy to Copy 的叶子报文，叶子报文a、b、c 的
pac_id 就是叶子报文2 的pac_id, 在a/b/c 叶子中如果有叶子的Freepkt 指示有效才去刷新
WTB 中WGT_ID 权重值，下图的例子会有6 份同Body 的报文发送到PE。A/B/C 三份叶
子可以transmitDispatch 整包或首CELL 到PE。
a c
1 2 3 4
b
root
Hard
copy
Figure 5.4-7 Copy to Copy
5.4.14 Backpressure & Drop
5.4.14.1 HA Backpressure
PQM 通过接口FIFO 的将满信号反压HA，HA 接口FIFO 在2 种情况下会出现将满。
1、丢包释放FIFO 将满反压。
2、MEMP 写接口反压。
SD5182HV100 Functional Specification Page 213 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
HA
HA ITF FIFO DROP FIFO
PQM MEMP WR
ITF
FAM
MEMP
Figure 5.4-8 HA 反压
5.4.14.2 Pull interface Backpressure
PQM 通过接口Pull 命令接口FIFO 的将满信号反压PSA Pull request 接口，PQM 的Pull 相
应接口受PSA 的反压。PULL 命令和New Pkt 之间有调度，调度的时延和读MEMP 的时
延会导致PULL 接口FIFO 将满。
Quark
MEMP RD ITF
Pull cmd FIFO Pull data
Figure 5.4-9 PSA PULL 反压
5.4.14.3 TransmitDispatch interface Backpressure
PSA TransmitDispatch 命令接口受接口FIFO 的反压，该反压是可以逐级传递的，当PE
TransmitDispatch 报文数据接口反压PQM 时，报文数据接口FIFO 反压MEMP 的读数据，
MEMP 的数据FIFO 反压到MEMP 的读命令FIFO， 读命令FIFO 再反压回
TransmitDispatch 的命令fifo。
SD5182HV100 Functional Specification Page 214 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Quark
PE
Transmit cmd
MEMP
Figure 5.4-10 TransmitDispatch 反压
5.4.14.4 PQM Drop
PQM 原始报文优先级队列可通过寄存器PQM_PRI(0~3)_DROP_THRESH 配置丢弃
产生和取消阈值，队列深度超过阈值时，可以把入队报文直接送回收队列；配置单位为队
列占用的PLB Cell 数量。
丢弃的产生阈值必须大于等于取消阈值，软件要保证配置正确。
1. 尾丢门限：队列缓存的最大深度，当队列里的报文占用的缓存CELL 数目超过
该水线时，所有进入该队列的报文都被丢弃。
2. PLB 拥塞丢弃：每个队列有一个PLB 拥塞丢弃水线配置，当PLB 的占用量超
过本队列的配置水线时，本队列新入队的报文会被丢弃。
SD5182HV100 Functional Specification Page 215 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PLB资源
占用
PLB 拥塞处理
Q3 PLB拥塞丢弃门限
Q2 PLB拥塞丢弃门限
Q1 PLB拥塞丢弃门限
Q0 PLB拥塞丢弃门限
Figure 5.4-11 PLB 拥塞丢弃
3. 拥塞丢弃：当队列缓存超过队列拥塞水线，且PLB 缓存占用超过PLB 拥塞水
线时，本队列新入队的报文会被丢弃。
5.4.15 Error Handing
1，Pull 命令异常：
1）CMD 非法：
2）LEN 非法：
3）PAC_ID 非法：
4）PullMore 长度异常；
2，TransmitDispatch 命令异常：
1）PAC_ID 非法：
3，内部处理异常：
1）线程耗尽：（不需要反馈给PSA？）
2）Copy to Copy 时mc_cnt 大于32 溢出；
4，其他异常，如内部FIFO 溢出等，不作特别描述。
具体异常描述和处理（异常编码等），参加下表描述：
SD5182HV100 Functional Specification Page 216 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
异常类别 异常子类 描述 异常编码，STATUS[6:4] PQM处理方式 Pull Cmd异常 PAC_ID值异常 大于95，或者是未激活的PAC_ID。 1 1，反馈PSA； 2，记录错误：每种异常对应1bit错误指示，每种异常记录最后一个非法信息（如CMD值、PAC_ID）； 3，PID非法上报中断； CMD范围非法 CMD不等于1、2则非法； 42 START_LOC值非法 [15:8]表示pull长度，0~63分别表示1~64Byte，大于63则非法； 23 PullMore非法 对包长不大于128B的报文发起PullMore 43 TransmitDispatch命令异常 PAC_ID值异常 大于95，或者是未激活的PAC_ID。 不反馈PSA 记录异常状态，上报中断； 多播leafnum为0 - 不反馈PSA 记录异常状态； 内部处理异常 线程释放溢出 空闲线程计数大于64。 不反馈PSA 记录异常状态； KK接口Credit释放溢出 释放导致有效Credit超过16个 不反馈PSA 记录异常状态； Copy to Copy时叶子份数溢出 mc_cnt计数大于32 不反馈PSA 记录异常状态； ECC 2bit及以上错误 - 不反馈PSA 上报中断，记录异常状态；
Table 5.4-3 PQM Error Handing
注1：Pull Cmd异常编码，根据PID、CMD、PullLength等信息出现异常情况产生，如上表。当多个异常同时出现时，只会上报一个异常编码，按照1、2、3、4的优先级顺序，编码1优先级最高，如当同时出现类型为编码1、2的错误，上报编码1，以此类推。
注2：当Pull Cmd出现CMD==0的异常情况时，将异常编码设定为4，可以和目前Pull New的有效异常编码错开。
SD5182HV100 Functional Specification Page 217 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.4.16 Statistics
A. 可以统计从HA收到的总报文数个数。
B. 可以统计PSA 的空闲线程个数和发送给PSA的各优先级的新报文个数。
C. 可以统计PSA的Pull 命令个数。
D. 可以统计PSA的TransmitDispatch 命令个数。
E. 可以统计PSA的discard 有效的命令个数。
E. 可以统计PSA的freepkt 有效的命令个数。
F. 可以统计因优先级队列占用资源超门限丢弃的报文数。
G. 可以统计错误的PSA Pull命令和TransmitDispatch命令，可以分类型（PAC_ID属性错、帧长范围错等。
H.可以统计NP复制份数超门限报文数量
I. 可以统计表项校验错误。
J．NP组播复制（分别统计dicard无效和有效两组）：
1）组播非尾报文；
2）组播尾报文+单播报文；
K．PQM组播复制（分别统计dicard无效和有效两组）：
1）组播根报文；
2）组播叶子报文；
5.4.17 Table structure
PQM没有需要用户配置的表项。（映射OE）
5.4.18 Memory Protection
PLB中的控制信息采用ECC校验，2bit检错，1bit纠错；发生不可纠的错误时，会上报中断，可能会造成丢帧、缓存泄漏、线程挂死，但不会造成业务全部中断。
帧间链表采用ECC校验，具有检1bit错能力。帧间链表发生校验错时，会上报中断，需要软件重新初始化逻辑。
其它内部表项采用奇偶校验，具有检1bit错能力。表项发生校验错时，会上报中断，可能会造成丢帧、缓存泄漏、线程挂死，但不会造成业务全部中断。
SD5182HV100 Functional Specification Page 218 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.4.19 Initialization
上电复位后，PQM自动启动RAM初始化，可以通过轮询PQM_ INIT_ DONE寄存器，来确认初始化是否完成。
5.4.20 Debugging Features
所有表项用户可读可写（仅用于调试目的，PQM正常工作时没有需要用户配置的表项）。
所有FIFO的空满信号可读，同时出现空满的错误状态可记录。
A.支持单步模式发送数据给PSA，即一个报文的transmitDispatch命令下发后再发送新的报文给PSA。
B．支持PSA设置PAC_ID空门限。
C. 支持队列链异常告警；
D．支持缓存资源使用溢出告警；
E．支持收发包统计；
F．支持实时反压状态可读；
G. 支持实时的资源(PCA_ID / PLB / 线程 … )占用情况可读；
SD5182HV100 Functional Specification Page 219 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
SD5182HV100 Functional Specification Page 220 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.5 FREE ADDRESS MANAGER(FAM)
Free Address Manager(FAM)负责管理空闲缓存、帧内链表、组播ID和组播权重。
5.5.1 Main Features
FAM的主要特性如下：
 管理片内6K个cell地址，片外32K个cell地址。
 支持缓存链表管理，片内缓存1条链表，片外缓存分为8条链表（每条链表对应DDR的1个BANK）；9条链表共享1块链表RAM。
 响应IPS/PE/EQM的申请缓存请求，IPS/PE申请片内缓存，EQM申请片外缓存。在分配片外缓存时，从8个BANK中轮流分配；
 响应IPS/PE/EQM的建链申请，保存帧内链表，与空闲缓存链表共享1块链表RAM。
 响应PQM/EQM/EPS的帧内链的释放请求。
 响应PQM/ EQM/EPS的帧内链查询请求。
 支持2K个MCID的管理，每个MCID有5bit的IFB权重值和5bit的EFB权重值。
 支持将内置缓存划分为PLB、PEB、IFB三个逻辑空间，支持静态配置这三个逻辑空间的最大可用缓存个数；
 支持统计缓存的总体占用情况；
 支持统计每个源端口进来的报文占用的cell数，可以配置每个端口的流控产生门限和取消门限，并根据配置门限产生流控指示。
 支持CPU间接访问链表RAM（只读）。
5.5.2 Terminology
The following terms have specific meanings in this section of the document. Term Description
IFB
Internal Frame Buffer
PLB
Packet Latency Buffer
PEB
Packet Edit Buffer
EFB
External Frame Buffer
FAM
Free Address Manager
IPS
Ingress Port Schedule
EPS
Egress Port Schedule
PE
Packet Edit
PQM
Packet Queue Manager
SD5182HV100 Functional Specification Page 221 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Term Description
EQM Egress Queue Manager
Table 5.5-1 FAM Terminology
5.5.3 FAM Overview
5.5.3.1 链表结构
next_point
next_point
……
Null
Null
next_point
……
Null
链表和权重RAM
EFB空闲CELL链表0~7
tail_0
next_point
head_0
EFB帧内链
head tail
head tail
next_point
next_point
Null
……
……
IFB空闲CELL链表
tail head
IFB帧内链
vld_0
vld_7 tail_7 head_7
vld
.
.
.
next_point
next_point
Figure 5.5-1 链表结构
FAM需要维护32K 个外置cell 和6K 个内置cell 地址，因此链表深度为32K+6K，地址位
宽为16bit。地址0~7FFF 为外置缓存空间，8000~97FF 为内置缓存空间。
5.5.3.2 EFB 地址映射
为提高DDR 带宽利用率，将EFB 按DDR bank 划分为8 条空闲链，以EFB Cell 地址的低
3bit 来区分不同的bank。申请时轮询8 条链分配空闲地址，释放回收地址是按地址低3bit
来回收到各自bank。这样，当一个报文占用多个cell 时，占用多个bank 的概率就很大，
读写DDR 会交织bank 读写。
因为共支持32K Cell，所以EFB Cell 地址空间：0~7FFF ，其中
 Bank0 Cell 地址：0~8~16~24~32…（共4K 个）
 Bank1 Cell 地址：1~9~17~25~33…（共4K 个）
 .
SD5182HV100 Functional Specification Page 222 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 .
 .
 Bank2 Cell 地址：7~15~23~31~39…（共4K 个）
EFB Cell 大小可配置为512B 或者1024B，所以Cell 内地址宽度为9/10bit。
5.5.3.3 权重管理
1 1 1 1 1 1 1 1 0 0
1 1 1 1 1 0 1 1 1 1
...
0 0 0 0 0 0 0 0 0 0
1
1
0
1F
...
2K
6bit
wgt_efb
mcid_map row_info
31
0
0
63
...
1F
...
6bit
wgt_ifb
Figure 5.5-2 MCID_MAP 表和WGT_TAB 示意图
对于组播报文，为节省缓存空间占用，以及从PLB 到PEB，从PEB 到EFB 的搬运动作，
所以对于组播只进行Head 编辑的情况下，只有组播第一个报文，才会搬运整个报文（包
括Head 和Body），组播中间报文和尾报文，仅搬运Head，并和首报文的Body 链接在一
起，Body 不再搬运。
另外，因为组播报文，可能存在部分叶子报文在IFB，部分叶子报文在EFB 的情况，为
了避免内外置缓存的交叉链接（交叉链接会导致EPS 等模块处理复杂），每个组播报文
在IFB 或者EFB 中的第一份叶子报文会整包搬运（携带Body），后面的叶子报文只搬运
Head，和第一份叶子报文的Body 进行链接。
Cell 链表RAM中每个地址条目没有权重值，为保证组播报文的地址不被提前释放而造成
组播报文丢失，通过MCID 进行组播权重管理。MCID 共支持2K 个，每个MCID 有6bit
的IFB 权重和6bit 的EFB 权重。权重值由0~32 代表权重0~32。
SD5182HV100 Functional Specification Page 223 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.5.3.4 帧内链表建立
一个报文可能会占用多个地址，地址之间通过帧内链表链接在一起。帧内链表与空闲链表共享CID_TABLE。
IPS/PE/EQM在存储一个CELL后会发起建链请求：IPS/PE/EQM给出当前地址和下一跳地址到FAM。FAM根据当前地址和下一跳地址建立帧内链表。如果指示报文只有一个cell，则不需要建链，只做统计。
5.5.3.5 帧内链表查询
PQM/EQM/EPS会查询帧内链表， FAM查询CID_Table返回帧内链的下一跳地址。
5.5.3.6 缓存地址申请
IPS/PE申请缓存时，FAM固定分配内置缓存地址，需要更新内置缓存链表信息。EQM申请缓存时，FAM固定分配EFB地址，FAM会轮流分配8个BANK的地址给EQM。
5.5.3.7 缓存地址释放
收到PQM的释放请求时，FAM直接更新链表头、尾信息，并更新链表RAM内容。
收到EPS/EQM的释放请求时，根据权重指示释放。
5.5.3.8 统计
FAM支持以下统计：
 PLB占用数量（计数器PLB_USED_CNT）；
 PEB占用数量（计数器PEB_USED_CNT）；
 IFB占用数量（计数器IFB_USED_CNT）；
 EFB占用数量（计数器EFB_USED_CNT）；
 IFB（内置）空闲CELL数量（计数器IFB_IDLE_CNT）；
 8个BANK的EFB空闲CELL数量（计数器EFB0~7_USED_CNT）；
 每个源端口收到的报文占用的CELL的数量（计数器IGR0~31_USED_CNT）；
 MCID的占用数量（计数器MCID_USED_CNT）；
5.5.3.9 流控和低功耗指示
FAM可以统计各源端口收到的报文占用的PLB/IFB/EFB缓存数量，在建链请求和释放请求时统计。10GE/GE端口支持源端口流控功能。当从10GE/GE收到的报文占用的缓存数量(可配置是PLB或者EFB+IFB或仅EFB)超过流控产生门限时，产生流控指示；当从10GE/GE收到的报文占用的缓存数量低于流控撤销门限时，取消流控指示。
SD5182HV100 Functional Specification Page 224 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
FAM可以分别统计IFB/PLB/EFB的总占用数量（计数器USED_CNT）。IQM和协议通路中的报文体现在FAM的PLB统计中。可配置三级比较门限与计数器比较，比较结果送给CRG用于请求不同的时钟频率。计数器IFB/EFB_USED_CNT仅用于调试目的。
5.5.4 Table Structure
5.5.4.1 寻址方式
采用间接寻址方式访问链表和权重RAM（只读），间接访问控制寄存器在FAM寄存器列表中有描述。主要包括FAM_TAB_CFG（tab_op_start、tab_op_err、tab_addr）和读数据所存寄存器FAM_TAB_RDATA。软件操作前要访问tab_op_start这个bit，如果为0才能开始一次操作；tab_op_err指示访问地址错误。
5.5.4.2 CID Table
链表RAM，维护：由逻辑维护，CPU只读，初始化为0。
5.5.4.2.1 表格基本描述 表格名称
CID Table 起始地址
N/A 地址范围
N/A 表项数目
38912 每项宽度
22bits 寻址方式
索引方式为CELL地址
Table 5.5-2 CID Table基本描述
5.5.4.2.2 表项数据结构 Bit Name Description
21:6
nxt_ptr
下一跳指针
5:0
Ecc
Ecc计算值
Table 5.5-3 CID Table数据结构
报文链表的有效长度通过报文描述符中的头尾地址、报文长度来获取。通过头尾地址、报文长度来界定报文链的起始点、结束点，即报文链表的有效cell数。
SD5182HV100 Functional Specification Page 225 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.5.4.3 WGT Table
权重RAM，维护：由逻辑维护，CPU只读，IFB权重值初始化为32，EFB权重值初始化为0。
5.5.4.3.1 表格基本描述 表格名称
WGT Table 起始地址
N/A 地址范围
N/A 表项数目
2048 每项宽度
12bits（不包括ecc校验码） 寻址方式
索引方式为MCID值
Table 5.5-4 WGT Table基本描述
5.5.4.3.2 表项数据结构 Bit Name Description
10:5
wgt_efb
外置缓存权重
5:0
wgt_ifb
内置缓存权重
Table 5.5-5 WGT Table数据结构
5.5.5 Capacity
支持6K（6114）个cell的内置缓存管理。
支持32K个外置cell缓存管理。
支持2K个MCID。并分别支持IFB和EFB的权重管理。
SD5182HV100 Functional Specification Page 226 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.5.6 Performance
5.5.6.1 Throughput
下表为走内置缓存情况下，不同包长的报文访问FAM的CID Table 的访问率，FAM采用
DP 的250MHz 时钟可以满足性能需求。
Figure 5.5-3 数据走IFB 性能分析
下表为走外置缓存情况下，不同包长的报文访问FAM的CID Table 的访问率，FAM采用
DP 的250MHz 时钟可以满足性能需求。
Figure 5.5-4 数据走EFB 性能分析
5.5.6.2 Latency
缓存申请，建链，查询，释放都表现为对链表CID-RAM 的读写操作，通过调度方式每次
仲裁出一个操作命令以防止访问冲突。采用SP 调度方式，读写优先级为：初始化写>建
链写>查询读>申请读>释放读写>cpu 间接读，详细表现为：
初始化写
>IPS 建链>PE 建链>EQM 建链（除IPS 外，其他建链暂存在FIFO 中）
报文长度
(去crc)
ips申请ips建链pqm释放pqm查询pe申请pe建链
eqm释放
（丢包）
eps释放eps查询每包访问总和入口包率PSA包率入口访问率
PSA后访
问率
访问率总
和
60 1 0 1 0 1 0 0 1 0 4 26.79 26.79 26.79 80.35714 107.14
61 1 0 1 0 1 0 0 1 0 4 26.47 26.47 26.47 79.41176 105.88
127 1 0 1 0 1 0 0 1 0 4 14.90 14.90 14.90 44.70199 59.60
128 1 0 1 0 1 0 0 1 0 4 14.80 14.80 14.80 44.40789 59.21
129 2 1 1 1 2 1 0 1 1 10 14.71 14.71 44.12 102.9412 147.06
130 2 1 1 1 2 1 0 1 1 10 14.61 14.61 43.83 102.2727 146.10
287 2 1 1 1 2 1 0 1 1 10 7.23 7.23 21.70 50.64 72.35
288 2 1 1 1 2 1 0 1 1 10 7.21 7.21 21.63 50.48 72.12
289 3 2 1 2 3 2 0 1 2 16 7.19 7.19 35.94 79.07 115.02
230 3 2 1 2 3 2 0 1 2 16 8.86 8.86 44.29 97.44 141.73
447 3 2 1 2 3 2 0 1 2 16 4.78 4.78 23.89 52.55 76.43
448 3 2 1 2 3 2 0 1 2 16 4.77 4.77 23.83 52.44 76.27
449 4 3 1 3 4 3 0 1 3 22 4.76 4.76 33.30 71.35 104.65
450 4 3 1 3 4 3 0 1 3 22 4.75 4.75 33.23 71.20 104.43
607 4 3 1 3 4 3 0 1 3 22 3.57 3.57 24.96 53.49 78.45
608 4 3 1 3 4 3 0 1 3 22 3.56 3.56 24.92 53.40 78.32
609 5 4 1 4 5 4 0 1 4 28 3.55 3.55 31.99 67.54 99.53
610 5 4 1 4 5 4 0 1 4 28 3.55 3.55 31.94 67.43 99.37
IFB情况
（考虑PE编辑后包长增加128B的情况）
报文长度
(去crc)
IPS申请IPS建链PQM释放PQM查询PE申请PE建链EQM释放EQM查询EQM申请EQM建链
eqm释放
（丢包）
EPS释放EPS查询每包访问总和入口包率PSA包率入口访问率
PSA后访
问率
访问率总
和
60 1 0 1 0 1 0 1 0 1 0 0 1 0 6 26.79 26.79 26.79 133.9286 160.71
61 1 0 1 0 1 0 1 0 1 0 0 1 0 6 26.47 26.47 26.47 132.3529 158.82
112 1 0 1 0 1 0 1 0 1 0 0 1 0 6 16.54 16.54 16.54 82.72059 99.26
113 1 0 1 0 1 0 1 0 1 0 0 1 0 6 16.42 16.42 16.42 82.11679 98.54
127 1 0 1 0 1 0 1 0 1 0 0 1 0 6 14.90 14.90 14.90 74.50331 89.40
128 1 0 1 0 1 0 1 0 1 0 0 1 0 6 14.80 14.80 14.80 74.01316 88.82
129 2 1 1 1 2 1 1 1 1 0 0 1 0 12 14.71 14.71 44.12 132.3529 176.47
130 2 1 1 1 2 1 1 1 1 0 0 1 0 12 14.61 14.61 43.83 131.4935 175.32
287 2 1 1 1 2 1 1 1 1 0 0 1 0 12 7.23 7.23 21.70 65.11254 86.82
288 2 1 1 1 2 1 1 1 1 0 0 1 0 12 7.21 7.21 21.63 64.90385 86.54
289 3 2 1 2 3 2 1 2 1 0 0 1 0 18 7.19 7.19 35.94 93.45048 129.39
290 3 2 1 2 3 2 1 2 1 0 0 1 0 18 7.17 7.17 35.83 93.15287 128.98
368 3 2 1 2 3 2 1 2 2 1 0 2 1 22 5.74 5.74 28.70 97.57653 126.28
369 3 2 1 2 3 2 1 2 3 2 0 3 2 26 5.73 5.73 28.63 120.229 148.85
447 3 2 1 2 3 2 1 2 3 2 0 3 2 26 4.78 4.78 23.89 100.3185 124.20
448 3 2 1 2 3 2 1 2 3 2 0 3 2 26 4.77 4.77 23.83 100.1059 123.94
449 4 3 1 3 4 3 1 3 3 2 0 3 2 32 4.76 4.76 33.30 118.9218 152.22
450 4 3 1 3 4 3 1 3 3 2 0 3 2 32 4.75 4.75 33.23 118.6709 151.90
607 4 3 1 3 4 3 1 3 3 2 0 3 2 32 3.57 3.57 24.96 89.14422 114.10
608 4 3 1 3 4 3 1 3 3 2 0 3 2 32 3.56 3.56 24.92 89.00316 113.92
609 5 4 1 4 5 4 1 4 3 2 0 3 2 38 3.55 3.55 31.99 103.0806 135.07
610 5 4 1 4 5 4 1 4 3 2 0 3 2 38 3.55 3.55 31.94 102.918 134.86
EFB情况（假设512B cell情况，1024B的cell访问次数更少，情况更好）
（考虑PE编辑后包长增加128B的情况）
SD5182HV100 Functional Specification Page 227 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
>EPS查询>EQM查询>PE查询>PQM查询（最快6拍）
>IPS申请>PE申请>EQM申请（先申请16个放各个外部FIFO中）
>释放请求>释放时查询（EFB） （EPS、EQM、PE等模块的释放请求首先按SP调度快速写入FIFO中，串行输出）
>CPU间接访问
缓存申请采用预申请放入FIFO备用的方式（每个需求接口都有独立的FIFO），缓存释放采用暂存FIFO的方式，所以只要FAM总体性能满足需求，则延迟很小。缓存释放有4个接口，SP调度写入FIFO，进行依次释放。
IPS的建链请求优先级最高，1拍完成（无ack返回信号）；因IPS存在连续建链的情况，所以其它模块的请求可以暂存在FIFO中，FAM通常在2拍内响应建链请求；通常PE/EQM各自最快10拍发起一次建链请求。
FAM响应查询请求有固定的时序，最小延迟为6拍；通常情况下，每个模块的建链和查询请求间隔最小为10拍（所有建链和查询接口共6个），所以查询请求通常可以在16拍内响应；考虑到IPS建链请求的不确定性，如8个输入接口连续建链的时候，则可能导致查询的延迟大于16拍，所以要求PQM/EQM/EPS能够接受大于16拍响应的情况。
5.5.7 Initialization
系统复位时对空闲链状态寄存器和和链表RAM进行初始化。
5.5.7.1 链表RAM初始化：
 EFB空间：0~7FFF，存储单元初始化为{addr[14:3] +1，addr[2:0]}。
 IFB空间：8000~97FF，存储单元初始化为{addr[14:0]+1}。
初始化结果：
 链表0: 0~8~16~24~32…
 链表1：1~9~17~25~33…
 .
 .
 .
 链表7：7~15~23~31~39…
 链表8：8000~8001~…~97FF.
EFB链表状态寄存器：
 链表0：efb_idle_head0 = 0，efb_idle_tail0 = 7FF8，efb_idle_vld0 = 1；
SD5182HV100 Functional Specification Page 228 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 链表1：efb_idle_head1 = 1，efb_idle_tail1 = 7FF9，efb_idle_vld1 = 1；
 链表2：efb_idle_head2 = 2，efb_idle_tail2 = 7FFA，efb_idle_vld2 = 1；
 链表3：efb_idle_head3 = 3，efb_idle_tail3 = 7FFB，efb_idle_vld3 = 1；
 链表4：efb_idle_head4 = 4，efb_idle_tail4 = 7FFC，efb_idle_vld4 = 1；
 链表5：efb_idle_head5 = 5，efb_idle_tail5 = 7FFD，efb_idle_vld5 = 1；
 链表6：efb_idle_head6 = 6，efb_idle_tail6 = 7FFE，efb_idle_vld6 = 1；
 链表7：efb_idle_head7 = 7，efb_idle_tail7 = 7FFF，efb_idle_vld7 = 1。
IFB链表状态寄存器：
 链表8：ifb_idle_head = 8000，ifb_idle_tail = 97FF，ifb_idle_vld = 1。
5.5.7.2 Mcid_map表寄存器初始化：
初始化结果：全1。
5.5.8 CPU Access
支持CPU间接访问（只读）链表RAM和权重RAM，用于Debug。
间接访问寄存器如下：
SD5182HV100 Functional Specification Page 229 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
寄存器名称 属性 描述 tab_op_start
RWSC
cpu间接访问启动命令。
0：访问结束，此时可以进行写1启动操作。
1：正在进行访问，不能进行写1操作。此位可以自清，一次访问结束后自动清零。
注意：此寄存器为自清寄存器，写1之后，本次表项访问结束之后会自清为0，如果由于内部异常，导致该bit一直为1，则软件可以直接写0。 tab_idx
RW
表项操作选择索引：
0：链表RAM；
1：权重RAM tab_addr[15:0]
RW
RAM偏移地址。
当访问链表RAM时，tab_addr取值范围为0~38911；
当访问权重RAM时，tab_addr取值范围为0~2047。 tab_rdata[31:0]
RO
表项间接访问读数据。 tab_op_err
RO
间接访问地址超出链表RAM偏移地址范围。只在tab_op_start为0时有效。
Table 5.5-6 间接访问寄存器
5.5.9 DFx Features
支持缓存占用、空闲数量统计（参见5.5.3.8）；
支持各模块操作次数统计；
支持ECC错误记录、中断；分别记录ECC 2bit错误和1bit错误的次数；ECC 1bit错误时反馈纠错后的数据。
CID-TAB校验有2bit错误的情况，链表一定会出现混乱，产生中断，建议系统复位；
WGT-TAG校验有2bit错误的情况，权重可能无法释放或者读出的body数据错误。
SD5182HV100 Functional Specification Page 230 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.6 MEMORY POOL(MEMP)
Memory Pool（MEMP）是芯片内置的用于缓存报文的空间。数据通道中的多个处理环节分别需要大容量的内置Memory来临时存储报文数据，我们将这些Memory集中放置在MEMP模块，实现资源共享，通过灵活配置，应付各种应用场景。
MEMP在逻辑上分为PLB、PEB和IFB三部分缓存空间，其中PLB用于缓存入端口报文（PE前）；PEB用于缓存PE编辑之后、进出口队列之前的报文；IFB用于缓存 出端口队列报文（存于片内的部分）。
5.6.1 Main Features
MEMP的主要特性如下：
 支持4写5读并行操作，内部按照读写地址冲突与否进行串行或并行操作；
 读写冲突时，按指定优先级顺序执行；
 MEMP由5个单端口SRAM构成，每个SRAM位宽为128bit；
 MEMP在逻辑上以160Byte的cell为空间进行划分；
 共支持6K个cell，划分为PLB、PEB和IFB三个缓存空间，通过上电初始化配置，可以灵活改变三个缓存空间的容量大小；
 支持业务接口burst方式的读操作；
 支持CPU直接访问MEMP，读写数据位宽为32bit；
5.6.2 Terminology
The following terms have specific meanings in this section of the document.
Term Description
PLB
Packet Latency Buffer
IFB
Internal Frame Buffer
PEB
Packet Edit Buffer
ECC
Error Correction Code
Table 5.6-1 MEMP Terminology
5.6.3 MEMP Overview
SD5182HV100 Functional Specification Page 231 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
0 SRAM0
128bit
cell0 cell1 cell2
Cell
6143
SRAM0_RW
MEMP_RW_ARB
IPS_WR PQM_WRR PE_W EPS_RR CPU_RW
SRAM1_RW SRAM0_RW SRAM0_RW SRAM0_RW
128bit 128bit 128bit 128bit
1
2
3
4
5
12286
12287
SRAM1 SRAM2 SRAM3 SRAM4
EQM_R
Figure 5.6-1 MEMP 的逻辑划分
5 个读写模块完成3 写（IPS 写整包，PQM 写FD，PE 写整包或Head）5 读（IPS 读Head，
PQM 读Head 或部分Body，PQM 读整包或Head，EQM 读整包或Head，EPS 读整包）操
作，加上CPU 读写接口，共4 写6 读。
读写仲裁模块（MEMP_RW_ARB）根据各个读写命令操作的地址，完成5 块SRAM的读
写命令的分发，并配置到各个SRAM的读写端口上。
MEMP 由5 个位宽128bit 的SRAM 组成，逻辑上每一行地址为80B，每二行设计为一个
CELL（每个CELL 就是160B）。
数据存储方式和FAM的地址分配相关，报文缓存在多个cell 时，由链表进行管理。
5.6.4 Service Module Access
MEMP 对接收10 个读写请求来源的处理优先级可配置，默认顺序为：
IPS_WR > PQM_WR_FD > EPS_RD(ID0==ID1==ID2==ID3) > PE_WR > IPS_RD >
(PQM_RD==PQM_RD_HD) > EQM_RD > CPU；
SD5182HV100 Functional Specification Page 232 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PQM
MEMP
IPS PE EPS
Head+body Head
Head
or body
Head+body
Write
Read
Flow
Fd
Head
or body
EQM
Head
or body
Head+body
DDR
fd
Figure 5.6-2 外部模块对MEMP 的访问示意图
5.6.4.1 IPS Write and Read
IPS 模块对PLB 的操作，一写一读。
一写：IPS 将接收报文数据完整写入PLB；
一读：读取128Byte Head 给HA 模块解析。
5.6.4.2 PQM Write and Read
PQM 模块对PLB 的操作，一写二读。
一写：HA 解析出PSA 需要的FD 信息，存入报文第一个cell 的前32Byte。
一读：读取报文Head cell 给PSA。支持PSA 通过PullMore 指令申请读取Body；
二读：如果是组播非第一个报文，只读取报文Head cell 给PE；否则读取整个报文给PE。
5.6.4.3 PE Write
PE 模块对IFB 的操作，一写。
一写：无论报文存储目的地为IFB 或EFB，先将编辑后的报文写入IFB。
5.6.4.4 EQM Read
EQM 模块对IFB 的操作，一读。
一读：EQM 对出口Buffer 组调度，分析报文存储目的地，如果为EFB，则从IFB 读出。
5.6.4.5 EPS Read
EPS 模块对IFB 的操作，一读。
一读：读取整包报文数据，分发给目的接口。
SD5182HV100 Functional Specification Page 233 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.6.4.6 Burst Mode Read
所有业务接口（IPS/PQM/EQM/EPS）的读操作，支持Burst模式。每个读操作命令包含起始地址和Burst长度，读操作处理模块会根据读命令中的burst长度分解成若干个读操作，从而节省外部接口的读命令个数。
5.6.5 Control Processor Access
MEMP模块有两组CP接口，其中接口一的读写范围为512KB，地址空间兼容511x系列芯片；接口二为新增接口，主要针对MEMP RAM的读写，访问空间为MEMP全部可用空间，接口二主要应用在启动或者Debug场景。
一写：写任意地址任意数据。
一读：读任意地址的数据。
在Debug模式下，允许CPU以直接寻址的方式读写MEMP中的内容，32bit为访问粒度，不影响芯片的正常工作。
在芯片安全启动时，Boot阶段，作为启动RAM，支持CPU以32bit为粒度的读写控制。
5.6.6 Error Handling
MEMP数据仅FD数据做带内ECC校验，这个由外部访问模块完成，其他数据不做校验。
5.6.7 Initialization
支持上电初始化。
5.6.8 Capacity
MEMP缓存空间支持6144个160Byte的cell。
5.6.9 Performance
5.6.9.1 Throughput
MEMP的最高工作时钟为250MHz，内部5个SRAM的端口可同时操作，最高效率情况下，总带宽为250*5=1250Mlps（lines per second）。如下表可以看出，当不采用RAM交织方式的情况下，RAM0的读写次数明显高于其它RAM，从而导致RAM的频率需求超过250MHz。
SD5182HV100 Functional Specification Page 234 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure 5.6-3 性能分析数据
参考：如下为不同报文长度情况下，每个RAM的读写次数统计。
SD5182HV100 Functional Specification Page 235 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
采用RAM交织方式，可以提升MEMP的效率：
SD5182HV100 Functional Specification Page 236 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
0
CELL0
RAM0
1 2 3 4
RAM1 RAM2 RAM3 RAM4
5 6 7 8 9
0
CELL1
4 1 2 3
9 5 6 7 8
0
CELL2
3 4 1 2
8 9 5 6 7
0
CELL3
2 3 4 1
7 8 9 5 6
0
CELL4
1 2 3 4
6 7 8 9 5
Figure 5.6-4 MEMP RAM 交织示意图
 MEMP 内部包含5 块RAM（物理上的），每块RAM 的位宽为128bit；
 每个CELL 为160BYTE，分成10 个128bit；每个128bit 分别用0-9 表示其偏移(offset)；
 为了提高特殊包长对RAM 的访问效率，如64BYTE 的包长，RAM 的访问根据CELL
地址和CELL 内部数据偏移决定每个128BIT 在RAM 中的存储位置，如上图所示。具
体计算方法如下：
RAM 地址：{CELL_ADDR,1’b0} + offset/5；
RAM 选择：(CELL_ADDR%5 + offset)%5;
通过这种方法就可以让不同CELL 地址、不同offset 的数据写到不同RAM 上去，充分利
用RAM 的带宽。
在采用RAM 交织方式后，最佳效率情况下，对RAM 的频率需求远低于250MHZ。
经过ESL 仿真分析，MEMP 性能可以满足项目性能需求。
SD5182HV100 Functional Specification Page 237 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.6.9.2 Latency
通常情况下，参见各接口通道的优先级顺序（5.6.4），读操作的优先级相对于写操作低，在各端口操作同一个SRAM时，读数据返回最坏情况下需要8个时钟周期，写操作的完成最坏情况下需要5个时钟周期。
因为SRAM访问的调度采用的是SP调度，所以如果高优先级通道在瞬间流量比较大的情况下，低优先级通道的延时会相应增加。
对于CPU访问，由于优先级最低，相对延时大些。
SD5182HV100 Functional Specification Page 238 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.7 PACKET EDITOR (PE)
PE 模块从Quark 接收EC（Edit Command）和ED（Edit Data），存储到内部的Buffer 中。
PE 从PQM 接收原始报文数据，根据编辑命令（EC）对报文进行编辑。在申请到FAM
（Free Address Manager）的缓存地址之后，将编辑完成的报文数据写入内部缓存IFB
（Internal Frame Buffer）中，最后将报文的FCB（Frame Control Block）送给EQM
（Egress Queue Manager）模块处理。
下图是PE 模块与外部模块的接口关系。
Packet Editer(PE)
Quark
PQM
FAM
TMS
MEMP
EQM
Figure 5.7-1 PE 与外面模块接口图
5.7.1 Main Feature
PE 模块的主要特性描述如下：
 顺序执行ECB（Edit Command Buffer）中的命令，命令类型如下：
o ADD：添加长度为0 ~48Bytes 的数据到原始报文中的指定位置；
o REPLACE：把0~128Bytes 的连续字段，替换成0~48Bytes 的新数据；
o KEEP：保持最多16383Bytes 数据的原始数据；
o REMOVE：删除最多16383Bytes 数据的原始数据。
 支持当编辑命令（Edit Command）没有覆盖整个原始报文数据的时候，根据Quark
过来的指示自动生成剩下原始报文的KEEP/REMOVE 命令。
o 当EDIT_INFO 的TXTOEND 标记无效的时候，对EC 命令没有覆盖的报文段，
全部删除；如果有TXTOEND 标记有效的时候，PE 保持剩下的报文传输。
 支持剥离报文最后4 字节。
SD5182HV100 Functional Specification Page 239 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
o 当EDIT_INFO的REMOVE_LAST标记为1时删除报文的最后4个字节；当REMOVE_LAST标记为0时，不进行任何操作。
 支持IP头的TTL(Time To Live)/HL(Hop Limit)的修改。
 支持对TPID的修改，最多支持四层TAG同时修改。
 支持三组Checksum计算，分别是IPv4头、TCP/UDP和一组扩展的Checksum。
 支持对报文打上时戳。
5.7.2 Terminology Term Description
EC
Edit Command.编辑命令，由Atom发给PE用来指示对报文进行修改，每个EC可以携带0～48byte编辑数据。
ECB
Edit Command Buffer.从Quark接收的EC被存储在Edit Command Buffer (ECB) 中，ECB只存储EC的控制信息。
EDB
Edit Data Buffer.用来存储EC的编辑数据 。
MEMP
Memory Pool，内置缓存空间，使用SRAM搭建。
PQM
Ingress Queue Manager，入端口报文队列管理。
EQM
Egress Queue Manager，出端口报文队列管理。
HOPLMT
Hop Limit. IPv6头的HopLimit域。
TTL
Time to Live. IPv4头的TTL域。
FAM
Free Address Manager.自由地址管理。
IFB
Internal Frame Buffer.内置转发缓存。
FD
Frame Descriptor.帧描述符。
Table 5.7-1 PE Terminology
5.7.3 PE Overview
PE模块执行报文编辑时，当前指针就是原始报文当前的位置。当PE开始编辑一个新的报文时，该指针被初始化为报文头，即置为0。指针通过每个EC命令在原始报文上顺序移动。如果用户希望直接跳到包尾，那么不必知道报文的长度，只需要执行KEEP 16383Byte的命令，就可以将指针指向包尾。
SD5182HV100 Functional Specification Page 240 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.7.4 Edit Command Overview
5.7.4.1 Packet Edit Commands
下面的表格给出PE 支持的所有EC 命令和每个命令的命名。
Item Capacity
ADD [ADD_SIZE] 执行ADD 命令是将“ADD_SIZE”Bytes 的数据插到原始报文中；ADD_SIZE 的
范围是0~48 字节。插入的报文位置是由当前的指针指示，执行ADD 命令不会
移动指针。
REPLACE [REP_SIZE,
ADD_SIZE]
执行REPLACE 命令是先删除“REP_SIZE”Bytes 的原始报文数据，再添加
“ADD_SIZE”Bytes 的数据到原始报文中；REP_SIZE 的范围是0~128 字节，
ADD_SIZE 的范围是0~48 字节。插入的报文位置是由当前的指针指示，执行
REPLACE 命令会将指针向前移动REP_SIZE。
如果剩余的原始报文数据少于REP_SIZE，只有实际的原始报文长度被剥离。
KEEP
[KEEP_RM_SIZE]
执行KEEP 命令是保持“KEEP_RM_SIZE”Bytes 的原始报文数据；
KEEP_RM_SIZE 的范围是0~16383 字节。起始的位置是由当前的指针指示，执
行KEEP 命令会将指针向前移动KEEP_RM_SIZE。
如果剩余的原始报文数据少于KEEP_RM_SIZE，只有实际的原始报文长度被保
持。
REMOVE
[KEEP_RM_SIZE]
执行REMOVE 命令是删除“KEEP_RM_SIZE”Bytes 的原始报文数据；
KEEP_RM_SIZE 的范围是0~16383 字节。起始的位置是由当前的指针指示，执
行REMOVE 命令会将指针向前移动KEEP_RM_SIZE。
如果剩余的原始报文数据少于KEEP_RM_SIZE，只有实际的原始报文长度被删
除。
Table 5.7-2 编辑命令表
PE 报文的编辑可以支持ADD，REPLACE，KEEP 或者REMOVE 命令，命令可以是任意
指定的原始报文位置。
Edit
Commands
Original
Packet
Edited
Packet
REMOVE ADD REPLACE KEEP ADD
Beginning of
the Packet
End of
Packet
EDIT
CMD
EDIT
CMD
Edit Data A
EDIT
CMD
Edit Data C
L2
Header
IP Header Part 1 IP Header Part 2 IP Payload
EDIT
CMD
EDIT
CMD
Added Header
(Edit Data A)
Modified IP Header
Part 1 (Edit Data B)
IP Header Part 2 IP Payload
Trailer (Edit
Data C)
Edit Data B
SD5182HV100 Functional Specification Page 241 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure 5.7-2 Packet Editing Functionality
上图对报文的编辑操作进行了一个示例，报文编辑按照如下的方式进行：
 根据命令将L2 报文头全部删除；
 在IP 头前面添加了一个数据块A；
 将原来的IP Header Part1 头按照数据块B 的数据进行修改；
 IP Header Part 2 到报文的尾部，不做任何修改；
 在报文的尾部添加数据块C。
5.7.4.2 IP TTL/HOPLIMIT Update
当TTL 的更新标记有效的时候，PE 会在编辑动作完成之后，将报文指定位置的原始
TTL/HOPLIMIT 1 字节信息读出来，然后进行减1 操作之后替换到报文中。当原始值为0
的时候，在报文尾时获取报文长度信息，进行命令合法性检查（见5.7.6 章节），如果在
报文尾当前拍发现命令异常，则当前拍数据不做编辑，并打上错误标记。TTL/HOTLMT
字段的起始位置是由EDIT_INFO 中的TTL_START [7:0]指定。
EDIT_INFO 的数据结构见5.7.9.1 所示。
需要的信息如下：
TTL_START[7:0] 指示在编辑后的报文TTL 头的起始位置，单位1 字
节。
TTL TTL 的更新使能。
Table 5.7-3 TTL 需要的EDIT_INFO 信息表
编辑示意图如下：
PACKET DATA
TTL_START
TTL
1B
Figure 5.7-3 TTL 编辑示意图
上图是编辑后的报文，由Quark 指示TTL 的起始位置，从TTL 的位置开始取出1 字节数
据进行减1 后回写；如果原始值为0 则保持不变。
5.7.4.3 Checksum Update
PE 可以支持三个Checksum 的更新动作，分别是IPv4 Checksum、TCP/UDP Checksum、
扩展的Checksum。在报文所有编辑动作执行完成之后，由EDIT_INFO 指定相关信息进
行Checksum 计算，并把计算后的值更新到指定的Checksum 域的位置。执行之前需要判
断命令是否合法（见5.7.6 章节）来决定是丢弃还是执行。
SD5182HV100 Functional Specification Page 242 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
微码需保证不存在某组Checksum的计算范围与另一组Checksum 域值位置出现重叠的
场景。否则逻辑将按Checksum 域的原始值进行计算。
5.7.4.3.1 IH Checksum
需要的信息如下：
IH_START[7:0] 指示在编辑后的报文IH_头的起始位置，单位1 字
节。
IH_LENGTH[7:0] 指示IH_头长度需要计算Checksum 的长度，单位1
字节。
IH_OFFSET[7:0] IH_计算Checksum 域相对于IH_START 的位置偏移
，单位1 字节。
IH_CHECKSUM IH Checksum 计算使能
Table 5.7-4 IPv4 Checksum需要的EDIT_INFO 信息表
PE 的Checksum 计算范围是：IPv4 首部，从Version 域开始到Option 末尾结束。由Quark
给出的IH_START[7:0]、IH_LENGTH[7:0]决定。
编辑示意图如下：
PACKET DATA
IH_START
2B
IH_LENGTH
IH_OFFSET
CHS
Figure 5.7-4 IH Checksum更新示意图
上图是编辑后的报文，当IH_CHECKSUM为1 时，PE 开始从IH_START 计算到
IH_START+IH_LENGTH 结束，当IH_LENGTH 是奇数时，低位要补1 字节0；计算结果
放到IH_START+IH_OFFSET 位置。
该运用可用于IPv4 头的Checksum 计算，或者类似于IPv4 头的IP Checksum 计算。IPv4
报文运用实例见5.7.11.1。
5.7.4.3.2 TH Checksum
需要的信息如下：
IP_START[7:0] 指示编辑后报文的TCP/UDP 伪首部SIP 的起始位
置，单位1 字节。
IP_LENGTH[7:0] 指示TCP/UDP 伪首部中IP 长度，从IP_START 算
SD5182HV100 Functional Specification Page 243 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
起，单位1 字节。
TH_START[7:0] 指示编辑后报文的TCP/UDP 报文头的起始位置，单
位1 字节。
TH_OFFSET[7:0] 指示TH_计算Checksum 域相对于TH_START 的位
置偏移，单位1 字节。
PAD0[7:0] 要求微码填充8bit 全零。
PROTOCAL[7:0] IPv4 的PROTOCAL 域或者IPv6 的Next header 域。
FL_LENGTH[15:0] 指示在TCP/UDP 头开始到包尾的长度，也是TH_头
需要算Checksum 的长度，单位1 字节。
TH_CHECKSUM TH Checksum 计算使能。
FL_LENGTH_FLAG 指示是否要加上FL_LENGTH 域的值。
0：不需要加；
1：需要加。
UDP 指示TH_Checksum 计算结果为0 时，是否需要修改
成全f；
1：全0 需要改成全f；
0：全0 不需要改成全f。
Table 5.7-5 TCP/UDP Checksum 需要的EDIT_INFO 信息表
根据TCP/UDP 报文协议，Checksum 计算的范围是伪首部、TCP/UDP 首部、TCP/UDP 数
据。由Quark 给出TCP/UDP 头的起始位置、计算长度、伪首部中SIP 字段的起始位置，
IP 长度、PROTOCOL/Next Header 和Length 字段以及Checksum 使能的指示。
编辑示意图如下：
PACKET DATA
TH_START
2B
FL_LENGTH
TH_OFFSET
CHS
IP_START
IP_LENGTH
Figure 5.7-5 TH Checksum更新示意图1
当TH_CHECKSUM为1 时，PE 开始从TH_START 计算到TH_START+FL_LENGTH，
加上从IP_START 到IP_START+IP_LENGTH 的计算值以及{PAD0，PROTOCOL[7:0]}和
FL_LENGTH 值一起计算，将计算结果放到TH_START+TH_OFFSET[7:0]位置。当
FL_LENGTH 是奇数时，需要在其尾部补上一字节0。当IP_LENGTH 是奇数时，同样需
要在计算IP 时将尾部补上一字节0。
计算结果如果是全0 还需要根据UDP 字段做特殊处理，UDP 字段为1 时表示计算结果为
全0 要改成全f；UDP 字段为0 时表示计算结果不变。
注：UDP 报文只能用TH_Checksum 计算，其他两组无法做到计算结果全0 改全f 的动作。
SD5182HV100 Functional Specification Page 244 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
该运用可用于TCP/UDP 头的Checksum 计算。TCP/UDP 报文运用实例见5.7.11.2。
该功能可用于实现特殊报文的Checksum 计算，当某类特殊报文需要计算Checksum 的范
围不连续时，可由硬件计算连续的一段，其他由微码计算，微码计算结果放到{PAD0，
PROTOCOL[7:0]}的位置，同时把IP_LENGTH 清零、FL_LENGTH_FLAG 置0，再将两
者的结果合并。
编辑示意图如下：
FD Packet Data
TH_START
2B
FL_LENGTH
TH_OFFSET
CHS 软件计算
Figure 5.7-6 TH Checksum更新示意图2
将IP_LENGTH 置0，则不会进行IP 部分的计算，再将微码计算结果16bit 放到
{PAD0[7:0],PROTOCOL[7:0]}的位置，而硬件计算的是TH_START 到
TH_START+FL_LENGTH 的结果，两者再加到一起，算出Checksum结果放到
TH_START+TH_OFFSET 的位置。
注： TCP/UDP 计算伪首部时还需要加上FL_LENGTH 域的值，所以默认情况下
FL_LENGTH_FLAG 为0；在处理特殊报文时，通过将FL_LENGTH_FLAG 配置为1，使
逻辑不加上FL_LENGTH 的值，而不需要微码去减掉FL_LENGTH。
如果需要硬件计算两段不连续的数据，也可以配置IP_LENGTH 的值，范围在0~255。
5.7.4.3.3 Extend Checksum
计算扩展功能的CHECKSUM需要的信息如下：
EXT_START[15:0] 指示编辑后报文的EXT Checksum 计算的起始位
置，单位1 字节。
EXT_LENGTH[15:0] 指示EXT Checksum 计算的长度，从EXT_START
开始算起，单位1 字节。
EXT_OFFSET[15:0] 指示EXT_计算Checksum 域相对于EXT_START 的
位置偏移，单位1 字节。
EXT_CHECKSUM EXT Checksum 使能
Table 5.7-6 EXT Checksum需要的EDIT_INFO 信息表
扩展的Checksum 功能是由Quark 来指定计算的起始位置和计算长度，同时指定
Checksum 字段的位置和使能。这个功能主要用于特殊报文的Checksum计算。其运用类
似于IH Checksum，不同的是范围可以支持0~65535；其运用示意图可参见5.7.4.3.1 所述。
SD5182HV100 Functional Specification Page 245 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
该运用可用于ETH over GRE 报文的Checksum 计算，运用实例见5.7.11.3。
当EXT_CHECKSUM为1 时，PE 从EXT_START 开始计算到EXT_START+
EXT_LENGTH 结束，计算得出的结果写到EXT_START+ EXT_OFFSET 的位置，
LENGTH 是奇数时，需要在尾部补1 字节0。
5.7.4.4 TPID Replace
PE 支持TPID 值替换，由Quark 指示TPID 的替换使能和TPID_COMPRESSED 以及
TPID_START 实现。支持4 种可配置的TPID 值，放在DP 顶层的寄存器中，所以需要通
过TPID_COMPRESSED 进行索引。
PE 模块根据Quark 指示，将报文指定位置的16bit TPID 值替成从Quark 指定的
TPID_COMPRESSED 索引得到的新的TPID。在报文尾时获取报文长度信息，进行命令合
法性检查（见5.7.6 章节），如果在报文尾当前拍发现命令异常，则当前拍数据不做编辑，
并打上错误标记。支持四层TAG 的修改，TPID_REP_BITMAP[3:0]对应TPID0~3 的使能；
TPID_COMPRESSED[7:0]对应TPID0~3 的2bit 索引值；TPID_START[7:0]是指第一个
TPID 的起始位置，不管TAG0 所对应的TPID_REP_BITMAP 是否为1，所以PE 需要根
据TPID_START 以及TPID_REP_BITMAP 得出各个TPID 的起始位置。
TPID 替换示意图如下：
Packet Data
TPID_START
TAG0 TAG1 TAG2 TAG3
4B 4B 4B 4B
sch
TPID0[15:0]
TPID1[15:0]
TPID2[15:0]
TPID3[15:0]
TPID_COMPRESSED[7:6] TPID_COMPRESSED[1:0]
...
TPID0[15:0]
TPID1[15:0]
TPID2[15:0]
TPID3[15:0]
sch
TPID[15:0] TPID[15:0]
Figure 5.7-7 TPID 替换示意图
PE 在TPID_REP_BITMAP[3]有效时，取出TPID_COMPRESSED[7:6]，通过本地索引得
到2 字节的TPID 信息，将TPID 信息替换到TPID_START[7:0]的位置。
PE 在TPID_REP_BITMAP[2]有效时，取出TPID_COMPRESSED[5:4]，通过本地索引得
到2 字节的TPID 信息，将TPID 信息替换到TPID_START[7:0]+4 的位置。
其他情况类推。
SD5182HV100 Functional Specification Page 246 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.7.4.5 TxTimeStamp Replace
PE 支持将TxTimeStamp 信息携带到报文中。命令执行之前需要判断是否合法（见5.7.6
章节）来决定是丢弃还是执行。
由Quark 给出TxTimeStamp 的替换信息，为1 时表示需要携带时戳，将本地获取的64bit
时戳信息替换Quark 指定的位置。
时戳替换的示意图如下：
PACKET DATA
TIMESTAMP_START 8B
TIMESTAMP
Figure 5.7-8 时戳替换示意图
5.7.4.6 Edit Commands Receiving
当PE 模块从Quark 接收到EC 之后，首先判断EC 命令的合法性（见5.7.6 章节），丢弃
无效的EC。对于合法的EC 所对应的编辑数据ED，通过EC 命令中的ED_LOC 和从
Quark 收到的QUK_EDB_LOC 计算出ED 的偏移，计算公式如下：
ED_OFFSET = ED_LOC – QUK_EDB_LOC
ED 在Quark 中的位置示意图：
其他信息
TM_INFO
EDIT_INFO
其他信息
ED
EC
QUK_EDB_LOC
ED_LOC
Figure 5.7-9 ED 在Quark 中的位置信息示意图
SD5182HV100 Functional Specification Page 247 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
QUK_EDB_LOC 是指在Quark 中EDB 的起始位置；ED_LOC 是指EDB 的起始位置加
上EC 对应的ED 在EDB 中的位置，所以在PE 将EDB 缓存起来后，需要用
ED_LOC – QUK_EDB_LOC 来找到ED 的位置。
每个报文的ECDB 信息最大是256Byte，其中ECB 最大支持128Byte，即支持最大32 条
EC；EDB 最大支持200Byte；在发送ECB、EDB 之前固定会发送两拍EDIT_INFO 信息，
一拍TM_INFO 信息。
5.7.4.7 TXTOEND
如果用户发送数据包时没有发送任何EC，或者EC 消耗完时，报文还没消耗完，这种情
况下处理数据包的方式有两种：
 如果发送命令有TXTOEND 使能，PE 将产生一个KEEP[16383]的EC 给这个报文，该
报文将不用修改发送出去。
 如果发送命令没有TXTOEND 使能，PE 将产生一个REMOVE[16383]的EC 给这个报
文，该报文将剩余部分全部删除。
报文没有任何EC 时，Quark 还是要将EDIT_INFO、TM_INFO 信息发给PE，PE 只需要
判断第三拍时的QUK_PE_LAST 为1，就可以知道这个报文是没有EC、ED 信息，只有
EDIT_INFO、TM_INFO 信息。
TXTOEND 的示意图如下：
Paket Data
KEEP/REMOVE[16383]
0
REPLACE[10,4]
10
KEEP[4]
14
REMOVE[8]
22
NO EC
Curr_ptr
Figure 5.7-10 TXTOEND 示意图
在当前指针没有到达包尾时，如果没有EC，则判断TXTOEND 字段，为1 时产生
KEEP[16383]，使数据从当前指针位置保持到包尾；为0 时产生REMOVE[16383]，使数
据从当前指针位置删除到包尾。
如果是组播报文该动作与首份叶子保持一致。
SD5182HV100 Functional Specification Page 248 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.7.4.8 REMOVE_LAST
REMOVE_LAST 用于指示是否剥离报文的最后4 字节，可用于剥离CRC 或者1588 报文
时戳。所有报文在检查合法性的时候都要先检查该bit 是否使能，如果使能，则判断时包
长要减4。
REMOVE_LAST 的示意图如下：
Paket Data
REMOVE[4]
0 Curr_ptr
EC0、EC1、EC2...ECN
Figure 5.7-11 REMOVE_LAST 示意图
当REMOVE_LAST 为1 时，执行完所有EC，指针会指向倒数第4 字节的位置，然后产
生REMOVE[4]命令，删除最后四字节。当REMOVE_LAST 为0 时，执行完所有EC，指
针直接跳到包尾。
如果是组播报文该动作与首份叶子保持一致。
5.7.5 Multicast
对于共享body 的组播报文不能做整包编辑，不共享body 的组播报文以及其他单播报文支
持整包编辑。
组播报文异常处理见5.7.6 章节。
5.7.6 Error Handling
编辑命令异常丢弃情况以及编辑后的特殊场景处理如下表所述。EC 命令异常按类型产生
告警，并对打上drop_reason 的报文进行统计。
特殊场景类型 场景 动作
组播转单播 组播首叶子编辑后BODY 为0。
（举例：报文只有129~131Byte，且
要做remove_last）
PE 模块基于WGT_ID 记录组播首份
叶子编辑后是否无BODY；如果是，
则把该组播的所有叶子改成单播，送
给EQM模块；同时，在首份叶子时
给EQM模块送出一个组播无BODY
的指示。
SD5182HV100 Functional Specification Page 249 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
EQM模块收到PE的组播无BODY指示时，向FAM模块给出MCID权重释放的指示，权重值为32，CELL链长度为1。
FAM模块支持CELL链长度为1，MCID权重为32的组播地址释放。
组播CHECKSUM
组播报文的IH CHECKSUM计算。
组播报文的IH CHECKSUM只支持在HEAD部分计算。
组播报文的EXT CHECKSUM计算。
组播报文的EXT CHECKSUM只支持在HEAD部分计算。
组播报文的TH CHECKSUM计算。
组播报文的TH CHECKSUM只支持从TH_START（在HEAD里面）计算到BODY结束。不关注FL_LENGTH，但FL_LENGTH仍参与伪首部计算。
注：组播转单播的报文，TH CHECKSUM同样固定计算到包尾。
TH CHECKSUM软硬件配合计算
通过微码计算一部分结束，填到伪首部的{PAD0[7:0],PROTOCOL[7:0]}字段，硬件计算一部分结果，两者再要加得到结果。
如果此时不需要IP部分参与计算，则把IP_LENGTH置为0；如果需要IP部分参与计算，IP_LENGTH给出相应长度，这时TH_OFFSET的域与IP计算部分是同一个CHECKSUM，如果两者重叠，按清零来进行计算。
CHECKSUM计算结果配置为0
将UDP报文的CHECKSUM结果配置为0。
将TH CHECKSUM的FL_LENGTH配置为0，结果将会输出0，优先级最高（比全0转全f高）。
注：IH、EXT CHECKSUM的IH_LENGTH、EXT_LENGTH配置为0，同样输出结果为0，而不是保持原值。
TXTOEND
报文从当前指针位置保持到包尾
TXTOEND等于1时，报文从当前指针位置保持到包尾。
注：组播报文以首叶子的TXTOEND为准。
报文从当前指针位置删到包尾
TXTOEND等于0时，报文从当前指针位置删到包尾。
注：组播报文以首叶子的TXTOEND为准。
SD5182HV100 Functional Specification Page 250 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
REMOVE_LAST
删除报文最后四字节的CRC或者时戳
REMOVE_LAST为1时，删除最后4个字节。
注：组播报文以首叶子的REMOVE_LAST为准。
REMOVE[16383]
REMOVE到包尾。
REMOVE[16383]相当于REMOVE到包尾，相当于TXTOEND等于0。
KEEP[16383]
KEEP到包尾。
KEEP[16383]相当于KEEP到包尾，相当于TXTOEND等于1。
原报文全部被替换掉
原始报文全部被编辑到0，替换成新的报文。
微码一般做法是用REPLACE将原始报文完成替换掉。逻辑同时还支持将原始报文REMOVE掉，再ADD成新的报文。这种情况在编辑到原始报文长度为0时，不会报异常。
Table 5.7-7 特殊场景处理表
异常类型 场景 动作
Discard有效
PSA指示的丢弃，即EDIT_INFO携带的DISCARD字段为1
丢弃所有EC、ED，报文不做编辑，写入MEMP，给EQM的FCB打上drop_reason，编码为3’b010，进行统计。
注：如果同时PQM指示丢弃，则按PQM丢弃来处理。
PSA指示的DISCARD是正常流程，不需要告警。
PQM指示的丢弃，即FCB携带的DISCARD字段为1
丢弃EC、ED信息， 输出FCB信息给EQM，打上drop_reason，编码为3’b011，进行统计。这种情况下PQM没有数据给到PE，PE也不需要写任何FD和数据到MEMP。
注：PQM指示的DISCARD是正常流程，不需要告警。
命令本身SIZE大小异常
ADD命令的ADD_SIZE大于48
丢弃该EC及后续EC，产生告警。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。默认配置丢弃。
REPLACE命令的REP_SIZE大于128或者ADD_SIZE大于48
丢弃该EC及后续EC，产生告警。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。默认配置丢弃。
SD5182HV100 Functional Specification Page 251 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
ADD、REPLACE命令的ED_END_LOC大于ED_NUM（ED_END_LOC是指ED_LOC加上EC_SIZE；ED_NUM是指接收到的ED字节数，按每拍16Byte的精度计算）
丢弃该EC及后续EC，产生告警。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。默认配置丢弃。
每个报文最后一拍EC命令时，LBO等于0或大于4
丢弃该EC及后续EC，产生告警。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。
PE将LBO等于0或者大于4时，都认为只有一个EC来处理。默认配置丢弃。
ED_LOC小于QUK_EDB_LOC
丢弃该EC及后续EC，产生告警。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。
默认配置丢弃。
命令窗口大于剩余包长（剩余包长是指当前指针的位置到包尾之间的长度）
REPLACE命令的REP_SIZE大于剩余包长
执行这条EC，删到实际长度，丢弃后续EC，产生告警。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。
默认配置丢弃。
REMOVE命令的KEEP_RM_SIZE大于剩余包长（REMOVE[16383]除外）
执行这条EC，删到实际长度，丢弃后续EC，产生告警。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。
默认配置丢弃。
KEEP命令的KEEP_RM_SIZE大于剩余包长（KEEP[16383]除外）
执行这条EC，删到实际长度，丢弃后续EC，产生告警。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。
默认配置丢弃。
命令个数过多
上一个命令刚好执行到包尾，再来一个除ADD之外的命令，不管窗口大小，丢弃该EC及后续EC，产生告警；加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为
SD5182HV100 Functional Specification Page 252 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
3’b000。
默认配置丢弃。
TTL命令的TTL_START大于或等于编辑后包长
丢弃该命令，产生告警。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。
默认配置丢弃。
CHKSUM命令的IH_START[7:0]+IH_LENGTH[7:0]或者IH_START[7:0]+IH_OFFSET[7:0]+2或者IP_START[7:0]+IP_LENGTH[7:0]或者TH_START[7:0]+FL_LENGTH[7:0]或者TH_START[7:0]+TH_OFFSET[7:0]+2或者EXT_START[15:0]+EXT_LENGTH[15:0]或者EXT_START[15:0]+EXT_OFFSET[15:0]+2大于编辑后包长
三组CHKSUM的异常不互相影响，哪一组CHKSUM有异常，就哪一组不做CHKSUM更新。针对三组CHECKSUM有三个告警；加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。默认配置丢弃。
TPID命令的TPID_REP_BITMAP[0]*12+TPID_START+2或者TPID_REP_BITMAP[1]*8+TPID_START+2或者TPID_REP_BITMAP[2]*4+TPID_START+2或者TPID_START+2大于编辑后包长
单播在EOP时判断，组播在HEAD_EOP到EOP之间判断，如果命令异常，则该报文在ERROR的前面一拍已被编辑的保持不变，后面部分不做编辑，产生告警。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。默认配置丢弃。
TIMESTAMP命令的TXTIMESTAMP_START+8大于编辑后包长
单播在EOP时判断，组播在HEAD_EOP到EOP之间判断，如果命令异常，则该报文在ERROR的前面一拍已被编辑的保持不变，后面部分不做编辑，产生告警。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。默认配置丢弃。
编辑后长度异常
编辑后长度为0
使包长减为负的EC，执行该EC，删到实际长度，即删到包长为0，丢弃后续EC，产生告警，数据不需要写入MEMP，给EQM的FCB长度域置为0，打上drop_reason，编码为3’b001。
SD5182HV100 Functional Specification Page 253 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
编辑后包长刚好为0，产生告警。数据不需要写入MEMP，给EQM的长度域置为0，打上drop_reason，编码为3’b001。
组播报文编辑后HEAD长度为0
使HEAD长度减为负的EC，执行该EC，删到实际长度，即删到包长为0，丢弃后续EC，产生告警，BODY部分需要写入MEMP，给EQM的FCB长度域hl置0，bl按实际长度给出，打上drop_reason，编码为3’b001。
编辑后HEAD长度刚好为0，产生告警。BODY部分需要写入MEMP，给EQM的FCB长度域hl置0，bl按实际长度给出，打上drop_reason，编码为3’b001。
组播报文首份叶子编辑后整包长度为0。
只有TXTOEND等于0时，可能出现这种情况。丢弃后续EC，产生告警，数据不需要写入MEMP，给EQM的FCB长度域置为0，同时按组播转单播处理，给EQM模块送出一个组播无BODY的指示，以及本地按WGT_ID维护一个组播转单播的标识，将后续页子全部转为单播。打上drop_reason，编码为3’b001。
编辑后长度大于pkt_len_th（默认值是16383（包括FRM_INFO、EXT_FD等FCB）
对编辑后的包长进行判断，大于配置值时，产生告警。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。默认配置丢弃。
组播报文头长度大于319（包括FRM_INFO、EXT_FD等FCB）
对编辑后的HEAD长度进行判断，大于配置值时，产生告警。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。默认配置丢弃。
注：编辑完后，同时使组播报文头长度大于319且整包长度大于pkt_len_th时，先执行报文头长度截断到319，再将剩余长度与pkt_len_th比较，如果还大于时，再继续将整包截断到pkt_len_th。
SD5182HV100 Functional Specification Page 254 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
TXTOEND异常
组播非首叶子的TXTOEND与首叶子的不同
PE按WGT_ID锁存首叶子的TXTOEND信息，非首叶子固定按首叶子的TXTOEND执行，如果出现异常，产生告警。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。
默认配置丢弃。
REMOVE_LAST异常
组播非首叶子的REMOVE_LAST与首叶子的不同
PE按WGT_ID锁存首叶子的REMOVE_LAST信息，非首叶子固定按首叶子的REMOVE_LAST执行，如果出现异常，产生告警。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。
默认配置丢弃。
CHECKSUM异常
IH_OFFSET、TH_OFFSET、EXT_OFFSET两两有重叠
产生告警，不进行CHECKSUM计算。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。
默认配置丢弃。
IH_OFFSET在TH_CHECKSUM或EXT_CHECKSUM的计算范围内，或者TH_OFFSET在IH_CHECKSUM或EXT_CHECKSUM的计算范围内，或者EXT_OFFSET在IH_CHECKSUM或TH_CHECKSUM的计算范围内
产生告警，按原值进行计算。加上配置是否丢弃该报文，丢弃时drop_reason编码为3’b100，并进行统计；不丢弃时drop_reason编码为3’b000。
默认配置丢弃。
Table 5.7-8 异常命令处理表
注1：一次编辑命令包括ADD、REMOVE、KEEP、REPLACE、TXTOEND、REMOVE_LAST；二次编辑命令包括TTL、TPID、TIMESTAMP、IH_CHECKSUM、TH_CHECKSUM、EXT_CHECKSUM。
注2：一次编辑命令出现异常时，丢弃后续命令，是指丢弃一次编辑命令中除REMOVE_LAST和TXTOEND的命令，不影响二次编辑命令；二次编辑命令出现异常时，不影响其他命令。为保证组播首叶子出现EC异常时，影响后续叶子报文，所以即使有EC异常也不丢弃REMOVE_LAST和TXTOEND命令。
注3：组播共享BODY时只支持编辑包头，上述包长是指包头长度；组播不共享BODY时支持编辑整包，上述包长是指整包包长，这种情况下在PE看到的是单播的报文。
注4：PE各种异常汇集成一个中断，产生中断告警。
SD5182HV100 Functional Specification Page 255 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.7.7 Performance
PE主要性能如下：
PE从PQM接收报文数据，每拍是128bit；输出给MEMP每拍也是128bit。因此吞吐量为128bit*250M=32Gbps。远大于需求的18Gbps的流量。所以吞吐量不是瓶颈。而对于最短包的转发性能才是瓶颈。
对于短包的性能计算，以以太网包为例，最短包长为64B，传输中的IPG为12B，Preamble为8B。合计最短包长为(64+20+4)*8=704bit。上下行18Gbps的有效载荷流量。因此，一个最短包所能接受最大处理时间为704/18=39.1ns。内部时钟周期为4ns(250M)，最短包所支持最大延时为39.1/4=9cycles。
性能需要根据使用的命令数量多少，命令类型，命令执行的位置，来决定报文头编辑处理能力。编辑动作包括：添加、删除、替换。当编辑后长度变长，则出口速率会大于入口速率。此时，要求出口速率为线速。当编辑后长度变短，出口速率会小于入口速率。此时，很难对出口速率进行量化测试。因此，对这种情况的性能测试仅要求入口速率达到线速。同理，对于编辑后包长不变的，则要求出/入口均达到线速。
下面提供典型场景分析，PE可以达到18Gbps的带宽。
5.7.7.1 Scene 1
Eth、Ipv4、UDP报文，切 1层Vlan，L2转发 EC.CMD:Replace EC.KEEP_RM_SIZE=42B EC. REP_SIZE =42B EC. ED_LOC=… EditInfo.QUK_EDB_LOC=… EditInfo.TPID_REP=0b1000 EditInfo. TPID_COMPRESSED = 0 EditInfo. TXTOEND=1 EditInfo.Other不关心
性能分析：假设在包长等于65Byte的情况下，数据需要5个时钟周期，EC处理需要1个时钟周期，EDIT_INFO处理不需要消耗性能，FRM_INFO需要1个时钟周期，编辑后包长不变，所以该场景的性能是(65+20+4)*8*0.25/7=19.7Gbps。
5.7.7.2 Scene 2
Eth、切1层Vlan， Ipv6、UDP报文入隧道，IPV6替换为IPv4，L3转发 EC0.CMD:Replace EC0.KEEP_RM_SIZE=62B EC0. REP_SIZE =42B EC0. ED_LOC=… EditInfo.QUK_EDB_LOC=… EditInfo.TPID_REP=0b1000
SD5182HV100 Functional Specification Page 256 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
EditInfo. TPID_COMPRESSED = 0 EditInfo. TXTOEND=1 EditInfo.TTL=1； EditInfo.IH_CHECKSUM=1; EditInfo .IH_START=… EditInfo .IH_LENGTH=… EditInfo.Other不关心
性能分析：假设在包长等于65Byte的情况下，数据需要5个时钟周期，该场景EC处理不需要消耗时钟周期，因为替换动作之后有两次删除动作，可以吸收处理延时，EDIT_INFO处理不需要消耗性能，FRM_INFO需要1个时钟周期，编辑后包长是42Byte，按前面分析，还是用入口的65Byte来进行计算，所以该场景的性能是(65+20+4)*8*0.25/6=29.6Gbps。
5.7.7.3 Scene 3
Eth、带2层Vlan加2层Vlan， PPP Ipv4、UDP报文入隧道，IPV4外分一层IPv6，L3转发 EC0.CMD:Replace EC0.KEEP_RM_SIZE=54B EC0. REP_SIZE =48B EC0. ED_LOC=… EC1.CMD:Add EC1. ADD_SIZE =48B EC1. ED_LOC=… EC2.CMD:Add EC2. ADD_SIZE =6B EC2. ED_LOC=… EditInfo.QUK_EDB_LOC=… EditInfo.TPID_REP=0b1111 EditInfo. TPID_COMPRESSED = 0b01 10 11 00 EditInfo. TXTOEND=1 EditInfo.TTL=1； EditInfo.IH_CHECKSUM=1; EditInfo .IH_START=… EditInfo .IH_LENGTH=… EditInfo.Other不关心
性能分析：假设在包长等于65Byte的情况下，数据需要5个时钟周期，该场景EC处理需要3个时钟周期，EDIT_INFO处理不需要消耗性能，FRM_INFO需要1个时钟周期，编辑后包长是113Byte，按前面分析，按照出口的113Byte来进行计算，所以该场景的性能是(113+20+4)*8*0.25/8=34.25Gbps。
SD5182HV100 Functional Specification Page 257 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.7.8 PE To MEMP FD
PE写MEMP的数据结构分为4部分：
1. 128bit FRM_INFO(FD)域：主要携带端口、长度与分片信息。
2. 128bit Extended_FD域（Option）：携带给EPS模块的OAM Y.1731 LM报文更新信息。
3. 4*64bit LRO域：主要携带To PIE口的重组信息。
4. 4 * 64bit VAR_INFO域 (Option)：Variable域。携带To PIE和To PRBS的一些特定信息。具体长度由顶层register配置，以8B为边界，最多32B。
5. Frame Data域：报文payload内容，通常从DMAC、SMAC开始。
其中FRM_INFO是固定的，Extended_FD是可配的，LRO是发送PIE口且有重组时才有，长度是32B，VAR_INFO是发送到PIE或PRBS端口才有，且发往PIE时可配长度是8B~32B，发往PRBS时可配长度是固定8B。
各个段的信息处理如下：
 FRM_INFO信息由PE从PQM、TM_INFO获取，以及PE自行计算得到，Quark只需要关注TM_INFO数据结构；
 EXT FD信息以EC+ED的形式带过来，要求添加在报文头，有这个EC时，Quark需要将TM_INFO的exd_fd域置1；
 PIE的LRO信息，32Byte，以EC+ED的形式带过来，要求跟在EXT FD（如果有）后面，添加在报文头；
 PIE的PIPE0，8Byte，以EC+ED的形式带过来，要求跟在EXT FD（如果有）、LRO（如果有）后面，添加在报文头；
 PIE的PIPE1，8Byte，由EC+ED的形式带过来，要求跟在PIPE0后面，添加在报文头；
 PIE的PIPE2，8Byte，由EC的形式带过来，当报文是TR143/TWAMP时，Quark指示PE带上64bit时戳信息，要求跟在PIPE1后面，添加在报文头；
 PIE的PIPE3，8Byte，是RESERVED；
PRBS信息由EC+ED的形式带过来，要求跟在EXT FD（如果有）后面，添加在报文头。
5.7.8.1 Extend FD Data Structure MSB LSB Width Field Description
71
0
72
reserved
保留。
80
72
9
lm_smp_idx
LM采样索引，用于EPS进行出口LM采样。
SD5182HV100 Functional Specification Page 258 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Table 5.7-9 Extend FD Data Structure
5.7.8.2 To PIE PRBSVAR_INFO Data Structure
PIE的数据结构见《SD5182HV100 PIE FS》；
PRBS的数据结构见《SD5182HV100 PRBS FS》。
5.7.9 Command Set Reference（Quark和PE的文档只能有一份数据结构）
Quark和PE之间EC和ED通过同一个接口传输，数据位宽为128bit，接口请参见《Internal Interfaces AS》中的KL接口描述。
Quark给PE的信息中，第1个周期传输的是TM_INFO[127:0]，第2个周期开始到传输的是EC、 ED信息。由QUK_PE_VALID指示当前数据是否有效；由QUK_PE_ECB_VLD指示当前数据是EC还是ED；由QUK_PE_ECB_LAST指示ECB的最后1个周期；由QUK_PE_ECB_LBO指示最后一个ECB有多少个EC有效；由QUK_PE_LAST指示数据最后1个周期；如果该报文没有EC、ED，则第1个周期，传输TM_INFO时QUK_PE_LAST就拉高。
EDIT_INFO信息是由带外传输。
[8]：采样有效标识，高电平有效。 [7:0]：采样索引。
89
81
9
lm_cnt_idx0
LM统计索引0，用于EPS进行出口LM统计。 [8]：采样有效标识，高电平有效。 [7:0]：采样索引。
98
90
9
lm_cnt_idx1
LM统计索引1，用于EPS进行出口LM统计。 [8]：采样有效标识，高电平有效。 [7:0]：采样索引。
107
99
9
lm_cnt_idx2
LM统计索引2，用于EPS进行出口LM统计。 [8]：采样有效标识，高电平有效。 [7:0]：采样索引。
115
108
8
lm_edit_offset
LM采样值编辑位置，以DMAC为起始点计算。
127
116
12
reserved
保留。
SD5182HV100 Functional Specification Page 259 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.7.9.1 QUK_PE_EDIT_INFO Data Structure rw
31
30
29
28 27 26 25 24
23
22
21
20 19 18 17 16
15
14
13
12 11 10 9 8
7
6
5
4 3 2 1 0
0
QUK_EDB_LOC[7:0]
REMOVE_LAST
TXTOEND
DISCARD
FL_LENGTH_FLAG
TTL
IH_CHECKSUM
TH_CHECKSUM
EXT_CHECKSUM
TPID_REP_BIDMAP[3:0]
TIMESTAMP
UDP
RSVD[9:0]
4
TPID_COMPRESSED[7:0]
TPID_START[7:0]
TIMESTAMP_START[15:0]
8
TTL_START[7:0]
IH_START[7:0]
IH_LENGTH[7:0]
IH_OFFSET[7:0] 12 IP_START[7:0] IP_LENGTH[7:0] TH_START[7:0] TH_OFFSET[7:0] 16 PAD0[7:0] PROTOCAL[7:0] FL_LENGTH[15:0] 20 EXT_START[15:0] EXT_LENGTH[15:0] 24 EXT_OFFSET[15:0] RSVD[15:0]
28
RSVD[31:0]
Table 5.7-10 EDIT_INFO数据结构
Field Description
QUK_EDB_LOC[7:0]
ED_LOC是EC命令对应的ED数据在整个数据块中的位置，从而可以计算出ED的偏移ED_OFFSET，计算公式如下：
ED_OFFSET = ED_LOC[7:0] – QUK_EDB_LOC[7:0]
REMOVE_LAST
指示PE删除报文的最后四个字节。
0：不删除；
1：删除。
TXTOEND
Transmit-to-end指令，指示在EC命令用完，但报文没有消耗完时的处理。
0：对EC命令没有覆盖的报文段，全部丢弃，即自动产生REMOVE命令；
1：保持剩下的报文传输，即自动产生KEEP命令。
DISCARD
丢弃报文，这时候要把数据和
SD5182HV100 Functional Specification Page 260 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
EC都丢弃。
FL_LENGTH_FLAG
指示计算TH的Checksum时，是否要加上FL_LENGTH字段。
0：需要加上；
1：不需要加上。
TTL
指示PE是否需要在编辑的报文中更新TTL/HopLimit。
0：不需要更新TTL；
1：需要更新TTL。
IH_CHECKSUM
三层checksum计算使能
TH_ CHECKSUM
四层checksum计算使能。
EXT_CHECKSUM
扩展checksum计算使能
TPID_REP_BITMAP[3:0]
TAG0~3替换TPID的使能。
[3]：TAG0的TPID替换使能；
[2]：TAG1的TPID替换使能；
[1]：TAG2的TPID替换使能；
[0]：TAG3的TPID替换使能；
TIMESTAMP
报文修改时戳的使能。
UDP
指示TH_Checksum计算结果为0时，是否需要修改成全f；
1：全0需要改成全f；
0：全0不需要改成全f。
RSVD[9:0]
保留位。
TPID_COMPRESSED [7:0]
TAG0~3压缩的TPID
[7:6]：TAG0；
[5:4]：TAG1；
[3:2]：TAG2；
[1:0]：TAG3；
2’b00：PE_TPID_CFG_0；
2’b01：PE_TPID_CFG_1；
2’b10：PE_TPID_CFG_2；
2’b11：PE_TPID_CFG_3；
TPID_START[7:0]
指示在编辑报文中第一个TPID的起始位置，基于编辑后的报文，从报文第一个字节算起，单位1字节。
SD5182HV100 Functional Specification Page 261 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
TIMESTAMP_START[15:0]
指示在编辑报文中TxTimeStamp的起始位置，基于编辑后的报文，从报文第一个字节算起，单位1字节。
TTL_START[7:0]
指示在编辑报文中TTL/HopLimit的开始位置，基于编辑后的报文，从报文第一个字节算起，单位1字节。
IH_START[7:0]
指示在编辑报文中三层头的开始位置，基于编辑后的报文，从报文第一个字节算起，单位1字节。
IH_LENGTH[7:0]
指示在编辑报文中需要计算Checksum的长度，基于编辑后的报文，单位1字节。
IH_OFFSET[7:0]
指示在编辑报文中三层头的Checksum在编辑后报文的位置，从IH_START算起，单位1字节。
IP_START[7:0]
指示在编辑报文中TCP/UDP报文伪首部的SIP在编辑后报文的开始位置，从报文第一个字节算起，单位1字节。
IP_LENGTH[7:0]
指示在编辑报文中TCP/UDP报文伪首部的IP长度，单位1字 节。
TH_START[7:0]
指示在编辑报文中四层头的偏移，是基于编辑后，从报文第一个字节算起，单位1字节。
TH_OFFSET[7:0]
指示在编辑报文中四层头的Checksum在编辑后报文的位置，从TH_START算起，单位1字节。
PAD0[7:0]
由Quark填充8bit全零。
PROTOCOL[7:0]
如果是IPv4，指的是编辑后报文的PROTOCOL字段；如果是IPv6，指的是编辑后报文的Next Header字段。
FL_LENGTH[15:0]
指的是伪首部中length域字段；如果是IPv4承载的TCP/UDP报文，是指TCP/UDP length；如果是IPv6承载的TCP/UDP报文，是指Upper-Layer Packet
SD5182HV100 Functional Specification Page 262 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Length。
同时也指示TH_计算Checksum的长度。
单位1字节。
EXT_START[15:0]
指示扩展Checksum计算的开始位置，基于编辑后的报文，从报文第一个字节算起，单位1字节。
EXT_LENGTH[15:0]
指示扩展Checksum计算的长度，基于编辑后的报文，单位1字节。
EXT_OFFSET[15:0]
指示在需要更新的Checksum在编辑后报文的位置，从EXT_START算起，单位1字节。
Table 5.7-11 Edit_INFO数据结构描述
注：上表中的各个功能的START都是基于报文编辑之后，从第一个字节算起，包括了FCB部分（Extended_FD、VAR_INFO都是通过编辑命令加到报文头），由Quark编辑的部分都需要计算进来，PE不感知Quark编辑的内容。
5.7.9.2 ED Data Structure KB1~3 bits Field Description
KB1[127:0]
NEW_DATA[383:256]
当EC命令为 ADD, REPLACE 的时候，需要索引对应的编辑数据ED，该数据就是从这个域中获得。
KB2[127:0]
NEW_DATA[255:128]
KB3[127:0]
NEW_DATA[127:0]
Table 5.7-12 Edit Data Overview
5.7.9.3 EC Data Structure Bit Name description
EC[31:30]
reserved
-
SD5182HV100 Functional Specification Page 263 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
EC[29:24]
ADD_SIZE[5:0]/ KEEP_RM_SIZE[13:8]
ADD命令或者REPLACE命令中ADD部分的命令长度：
0: 0 bytes; 1: 1 bytes; ...... 47: 47 bytes; 48: 48 bytes;
Others: Reserved. 如果命令长度超过48Bytes，PE认为是一个错误的命令，把命令抛弃。
当命令为KEEP或者REMOVE的时候，这个域用于表示KEEP_RM_SIZE的高6bit。
EC[23:16]
REP_SIZE[7:0]/ KEEP_RM_SIZE[7:0]
REPLACE命令的长度，其REMOVE部分的长度与ADD部分的长度可以是不同的，长度域的说明如下：
0: 0 bytes; 1: 1 bytes; ...... 127: 127 bytes; 128: 128 bytes;
Others: Reserved.超过部分认为是非法的EC命令。
当命令为KEEP或者REMOVE的时候，这个域用于表示KEEP_RM_SIZE的低8bit。KEEP_RM_SIZE共14bit，该域的说明如下：
0: 0 bytes; 1: 1 bytes; ...... 16383: 16383 bytes;
EC[15:8]
ED_LOC[7:0]
EC命令对应的ED数据在整个数据块中的位置，从而可以计算出ED的偏移ED_OFFSET，计算公式如下：
ED_OFFSET = ED_LOC – QUK_EDB_LOC
EC[7:3]
Reserved
-
EC[2:0]
CMD[2:0]
Edit Command, the Quark supports following Edit Commands:
0x0: ADD
0x1: REPLACE
0x2: KEEP
0x3: REMOVE
Table 5.7-13 Command Request Overview
5.7.9.4 TM_INFO Data Structure MSB LSB Width Field Description
127
115
13
Reserved
保留。
114
113
2
rxhash
五元组RXHASH值，用于EPS映射PIE通道。
SD5182HV100 Functional Specification Page 264 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
112
112
1
gro_id_en
GRO重组报文流ID匹配使能，用于EPS映射PIE通道。
111
108
4
gro_id
GRO重组报文流ID，用于EPS映射PIE通道。
107
104
4
reserved
保留。
103
92
12
gemport_id
Gemport ID，就是FCB中的line_info[11:0]。
91
86
6
Reserved
保留。
85
85
1
ext_fd
扩展fd指示。
84
84
1
frm_1588
报文为1588的指示信号，出口为ETH的1588报文需要该标志。
83
83
1
flow_st_vld3
流统计索引3有效指示。
82
82
1
flow_st_vld2
流统计索引2有效指示。
81
81
1
flow_st_vld1
流统计索引1有效指示。
80
80
1
flow_st_vld0
流统计索引0有效指示。
79
72
8
flow_st_idx3
流统计索引3。
71
64
8
flow_st_idx2
流统计索引2。
63
56
8
flow_st_idx1
流统计索引1。
55
48
8
flow_st_idx0
流统计索引0。
47
45
3
Reserved
保留。
44
40
5
wred_pattern
WRED 模板。
39
33
7
Reserved
保留。
32
32
1
qid2_vld
报文二次入队的有效指示。
31
24
8
qid2[7:0]
报文二次入队的队列号。
23
16
8
qid1[7:0]
报文首次入队的队列号。
15
12
4
reserved
保留。
8
4
3
pri [3:0]
报文的队列优先级，PIE使用4bit，其他端口使用低3bit。
7
7
1
scr
DBA报文颜色（GPON使用）
6
6
1
esat_pkt
ESAT报文标识，高电平有效。
5
5
1
prbs_loop
PRBS环回。
4
0
5
egrb[4:0]
Reserved（不需要从PSA传递，在EQM放映射表）
Table 5.7-14 TM_INFO Overview
5.7.10 DFx Features
PE支持的重要寄存器如下：
SD5182HV100 Functional Specification Page 265 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 JUMBO帧门限配置寄存器；
 ECD_AFIFO将满水线配置寄存器；
 EC_FIFO将满水线配置寄存器；
 FCB_FIFO将满水线配置寄存器；
 CHS_FIFO将满水线配置寄存器；
 PAC_INFO_FIFO将满水线配置寄存器。
 ECC错误记录、中断。
 单步（EC个数）调试配置寄存器。
 PAC_ID不一致告警。
PE支持的debug类寄存器如下：
 PE模块接收报文统计；
 PE模块发送报文统计；
 PE模块编辑后长度为0的报文报计；
 PE模块接收PQM丢弃的报文统计；
 PE模块接收Quark丢弃的报文统计；
 TCID0~2统计寄存器；
 组播报文个数统计；
 ECC错误个数统计；
 基于报文的ECB个数统计；
 基于报文的ECD个数统计；
 1588时戳寄存器（分高低32bit寄存）；
 打到报文的时戳寄存器；
 非法EC告警；
 ECD_AFIFO状态寄存器；
 EC_FIFO状态寄存器；
 FCB_FIFO状态寄存器；
 CELL_FIFO状态寄存器；
 CHS_FIFO状态寄存器；
SD5182HV100 Functional Specification Page 266 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 PAC_INFO_FIFO状态寄存器。
5.7.11 Appendix
5.7.11.1 IPv4 Checksum
举例如下：
IPV4
31~29 28~16 15~12 11~8 7~0
0 dmac[47:16]
1 dmac[15:0] smac[47:32]
2 smac[31:0]
3 Ethernet type(16bits)--0x0800 Version=4 IHL DSCP/TOS
4 Total length Identification
5 Flags Fragment offset TTL Protocol
6 Header checksum SIP[32:16]
7 SIP[15:0] DIP[32:16]
8 DIP[15:0] options
Table 5.7-15 IPv4报文格式
 IH_START[7:0]指示IPv4头的起始位置，即上表第3行Version字段的起始位置；
 IH_LENGTH[7:0]指示IPv4头需要计算Checksum的范围，即上表第3行的Version字段开始到options字段结束的范围，其中options长度是可变的；
 IH_OFFSET[7:0]指示IPv4头的Checksum域的位置，即上表第6行Header checksum字段的开始位置，从IH_START[7:0]开始算起。
5.7.11.2 TCP/UDP Checksum
举例如下：
IPV6_TCP
31~25 24~16 15~12 11~4 3 2 1 0
0 dmac[47:16]
1 dmac[15:0] smac[47:32]
2 smac[31:0]
3 Ethernet type(16bits)--0x86dd Version=6 Traffic Class Flow Label
4 Flow Label Payload length
5 Next Header=4 Hop Limit sip[127:112]
6 sip[111:80]
7 sip[79:48]
SD5182HV100 Functional Specification Page 267 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8 sip[47:16]
9 sip[15:0] dip[127:112]
10 dip[111:80]
11 dip[79:48]
12 dip[47:16]
13 dip[15:0] SPORT(16bit)
14 DPORT(16bit) Sequence Number[31:16]
15 Sequence Number[15:0] Acknowlegment Number[31:16]
16 Acknowlegment Number[15:0] data_offset reserved URG ACK PSH RST SYN FIN
17 window checksum
18 urgent pointer option[31:16]
19 option[15:0] payload
Table 5.7-16 四层报文格式
 TH_START[7:0]用于指示TCP/UDP头的起始位置，即上表中第13行SPORT字段的起始位置；
 FL_LENGTH[15:0]是由Quark计算出的TCP/UDP头加上TCP/UDP数据的总长度，也是TCP/UDP报文计算Checksum的长度，即上表中从13行SPORT字段的起始位置到报文尾；
 TH_OFFSET[7:0]用于指示TCP/UDP头Checksum字段的偏移位置，即上表中第17行Checksum字段的起始位置，从TH_START[7:0]开始算起；
 IP_START[7:0]用于指示TCP/UDP报文伪首部中SIP的起始位置，即上表中第5行SIP字段的起始位置；
 IP_LENGTH[7:0]用于指示TCP/UDP报文伪首部中IP域的长度，即上表中从第5行SIP字段的起始位置到第13行DIP字段的结束位置，从IP_START[7:0]开始算起；
 PAD0是8bit全零数据，用于与PROTOCOL字段拼接成16bit，PAD0放在高8bit；
 PROTOCOL[7:0]是从三层头中提取出来的字段，如果是IPv4，则提取出来的是PROTOCOL字段；如果是IPv6，则取出来的是Next Header字段，如上表第5行Next Header字段；
 FL_LENGTH_FLAG用于指示计算时是否需要加上FL_LENGTH的值，默认情况下该功能是计算TCP/UDP的Checksum，伪首部需要加上FL_LENGTH的值，所以默认是加上；
 UDP字段用于指示计算结果为全0时是否改成全f，UDP等于1表示结果为全0时需要改全f；UDP等于0表示结果不需要更改；默认情况下UDP为0。
5.7.11.3 EXT Checksum
 ETH over GRE
SD5182HV100 Functional Specification Page 268 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
ETHoGRE 的封装处理如下图所示。
DATA
IP
原始报文
VLAN
MAC
DATA
IP
封装后报文
VLAN
MAC
GRE头
隧道IP
VLAN
接口MAC
ETH over GRE
Figure 5.7-12 ETHoGRE 封装处理图
其中GRE 头的格式如下表所示。
ETH over GRE
31 30 29 28 27~19 18~16 15~0
0 C K S RSVD Version Protocol Type
1 checksum(optional) reserved(optional)
2 key(optional)
3 Sequence number(optional)
x DATA
注释： 各字段的意义
C
校验和验证位。如果该位置1，表示GRE 头插入了校验和字段；该位为0 表示GRE 头不包
含校验和字段
X
关键字位。如果该位置1，表示GRE 头插入了关键字（key)字段；该位为0 表示GRE 头不
包含关键字字段
S 是否带序列号的标识
Version 版本信息
Protocol
Type
乘客协议的协议类型
checksum 对GRE 头及其负载的校验和字段
key 关键字字段，隧道接收端用于对收到的报文进行验证
Table 5.7-17 GRE 报文信息表
 EXT_START[15:0]指示GRE 头的起始位置，即上表中“0”的位置；
 EXT_LENGTH[15:0]指示GRE 头的长度，即上表中从“0”的起始位置到“x”的结
束位置，“x”表示长度是可变的，结束位置是指DATA 的结束位置；
 EXT_OFFSET[15:0]指示的是Checksum 字段的起始位置，即上表中“1”的位置。
SD5182HV100 Functional Specification Page 269 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.8 EGRESS QUEUE MANAGER(EQM )
Egress Queue Management（EQM）模块接收PE送过来的包信息，控制报文数据的存储，基于输出队列进行缓存管理和调度，完成PON口的入队DBA信息发送给EPS_PON。
5.8.1 Main Features
 支持管理报文数据的存储：
o 根据端口组内置缓存使用情况和相应的水线配置进行自适应内外置缓存选择；
o 支持基于出端口组固定选择内外置缓存，组播报文单独配置；
o 支持将目的缓存是EFB的报文写入外部缓存；
 基于出口进行队列管理，队列规格：256队列；
 支持片外和片内缓存：
o 最大支持32K个片外Cell；
o 最大支持6K个片内Cell；
o 每个EFB Cell 大小512BYTE/1024BYTE 可配置；
 每个队列可配选择队列属性模板：
o 支持32个队列属性模板；
o 支持队列独享资源数目配置；
o 支持队列最大资源数目配置；
o 支持队列组属性配置。
 支持32个队列组：每个队列可配置同属于两个队列组；
 支持三级缓存管理：
o 支持队列缓存管理；
o 支持队列组缓存管理；
o 支持整芯片缓存统计管理。
 支持48个shaper模板；
 二次入队：
o 支持专用的二次入队调度端口，调度出队的报文从EPS环回到EQM入口再次入队；
 支持通用调度器：
SD5182HV100 Functional Specification Page 270 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
o 48个
o 每个通用调度器支持16个输入端；
o 每个通用调度器输入端支持上一级调度器输出或者队列输出；
o 每个通用调度器输入端调度组属性和调度权重可配置；
o 调度算法支持WRR、DRR、SP、SP+WRR/DRR，权重精度为1/255；
o 0~7号调度器支持共享带宽调度，剩余带宽支持按优先级分配和按权重分配；
o SP调度最大支持8个优先级；
o 输出有一个shaper进行限速；
o 使用共享带宽调度的调度器只能使用0~7输入端。
 支持端口调度器：
o 支持4个端口调度器；
o 每个端口调度器输入端支持上一级通用调度器输出；
o 端口调度器0输入端为2个，用于二次入队，分别上、下行内部环回虚拟端口；
o 端口调度器1输入端为5个，用于4个PIE虚拟端口和1个PRBS端口；
o 端口调度器2输入端为5个，用于ETH端口；
o 端口调度器3输入端为16个，用于PON端口；
o 调度算法仅支持RR调度；
o 每个端口调度器上可配置shaper进行限速。
 流量整形（shaper）：
o 支持48个shaper模板；
o 支持单漏桶；
o 支持预借令牌，最多支持一个报文预借；
o shaper速率支持0-10Gbps；
o 通用调度器shaper精度为16 Kbps；端口调度器shaper步长1Mbps；
o 通用调度器突发尺寸0-16M Bytes，步长1Bytes；
o 通用调度器令牌更新周期默认为31.25us，全局可配；端口调度器令牌更新周期为8us。
 PIE逻辑通道映射：
SD5182HV100 Functional Specification Page 271 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
o EQM配合EPS完成PIE逻辑通道的映射。
 PON DBA上报：
o 成功入队报文均上报DBA；
o 支持 报文长度（包括4Byte FCS）上报；
o 支持队列优先级上报；
 支持组播报文通过MCID管理转发；
 支持Quark 512个业务流索引统计，索引0/1统计到前256项，索引2/3统计到后256项；
 支持队列拥塞退出水线可配置；
 报文丢弃：
o 基于16BYTE CELL字节水线配置报文丢弃；
o 基于缓存CELL数目水线配置报文丢弃；
o 基于16Byte Cell水线配置报文丢弃功能支持使能配置，默认使能。
 支持队列统计功能：
o 支持基于队列报文个数和字节统计，包括出队，尾丢弃和拥塞丢弃统计；报文的入队统计为出队统计加上攒在队列的报文统计的和，由软件读出进行计算。
 只支持静态修改队列属性和调度器拓扑结构；
 支持低功耗功能。
 支持报文的丢弃动作。
o PE送过来的报文已经打上drop标记，表示前级模块处理已经将该报文丢弃了，则直接丢弃。
o 组播叶子的份数超过配置的组播叶子份数限制。（PQM透传指示丢弃）
o 无可用的缓存地址，报文丢弃（仅强制模式）。
5.8.2 Terminology
The following terms have specific meanings in this section of the document.
SD5182HV100 Functional Specification Page 272 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Term Description
SP Strict Priority
RR Round Robin.
WRR Weight Round Robin
MEMP Memory Pool，IFB
QE Queue Entity
PBM Packet Buffer Manager
FAM Free Address Manager
Table 5.8-1 EQM Terminology
5.8.3 Performance
缓存管理性能为8 拍同时完成一个报文的入队及一个报文的出队。调度性能为单端口（目
的端口，对应最后一级调度器输出）16 拍，双端口及多端口（目的端口，对应最后一级
调度器输出）8 拍调度一个报文。
PBM 模块入队的最大性能为8cycle/pkt , 受PDM 写DDR 的反压，反压会逐级传递到PE。
QE 模块入队的性能为8cycle/pkt。
QS 端口交织调度性能12.5Mpps，单端口性能调度为6.25Mpps
因此EQM 的性能瓶颈在PDM 子模块的DDR 写操作。若PE 入口流量大于DDR 写带宽
时，EQM 会反压到PE。
5.8.4 EQM Overview
EQM 的基本框图：
A
EQM
PBM PDM QE
QS
I
B
D
BUF CELL APP
F
DMC_WR
C
RLS to FAM H DBA
J
K
G
MEMP_RD
FD
from EPS
FD
from PE
Qout
Qin Link Qout Link
FD
to EPS
Shaping
compensate
Exact Plen
SD5182HV100 Functional Specification Page 273 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure 5.8-1 EQM Block Diagram
5.8.4.1 Block Introduction
PBM：Packet Buffer Manager,PBM子模块从PE或EPS模块接收报文信息，用于缓存管理。缓存管理包括：队列资源管理和WRED，播叶子丢弃，冗余权重释放，入队报文资源统计等。
PDM: 决策将报文数据存储在IFB或者EFB，若决策为EFB的报文，则将报文从IFB中读出并写入EFB中。
QE: 为每个队列维护链表信息：头指针、尾指针、空闲状态等。每次报文入队时，更新队列链表的尾指针；每次报文出队时，更新队列链表的头指针。同时，还根据入队和出队状态，维护队列链表的空闲状态。
QS：主要完成多级调度和Shaping 操作。
5.8.4.2 Work Flow
EQM的基本业务流程如下图所示：
SD5182HV100 Functional Specification Page 274 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
入队判决
内外置缓存的选择
成功入队
入队失败
更新队列空满状态
和队列链状态
报文出队
报文缓存释放
EPS
二次入队？
YES
正常转发
PE
报文从IFB搬到EFB
EFB
FD
调度&shaping
IFB
Figure 5.8-2 LMEM High-Level Diagram
SD5182HV100 Functional Specification Page 275 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PE 的入队报文和EPS 的反馈的二次入队报文在EQM 首先是要做入队判决，成功入队的
报文进行内外置缓存的选择，若是EFB 转发的报文需要将报文从IFB 搬到EFB 中，然后
报文才进入正常的业务队列，并更新队列链表状态和空状态；如果是IFB 转发的报文，
则报文不需要搬，直接更新队列状态。入队失败的报文，向FAM释放缓存并统计丢包。
报文出队时，发出报文的FD 给EPS。如果报文是二次入队报文，在EPS 从DDR 获得FD
信息后反馈报文信息给EQM 进行二次入队，非二次入队的报文EPS 会正常转发到端口上。
5.8.5 Packet Buffer Manager（PBM）
5.8.5.1 TM Info Structure
QUARK 与PE 的EC、ED 接口会发送TM 信息到DP，数据结构如下：
TM_INFO ED/EC
Figure 5.8-3 PSA to PE Data Interface
MSB LSB Width Field Description
7 0 8 qid1[7:0] 初次入队队列ID。
15 8 8 qid2[7:0] 二次入队队列ID。
16 16 1 qid2_vld 二次入队队列ID 有效指示。
19 17 3 idx[2:0] 二次入队用于查询WRED_TS 的优先权。
35 20 16 hh_ptr[15:0] 报文头链首cell 地址。HL 不为0 时有效。CADDR = 15。
51 36 16 ht_ptr[15:0] 报文头链尾cell 地址。HL 不为0 时有效。CADDR = 15。
67 52 16 bh_ptr[15:0]
报文BODY 链首cell 地址。HL=0 时，表示报文头CELL
地址。
83 68 16 bt_ptr[15:0]
报文BODY 链尾cell 地址。HL=0 时，表示报文尾CELL
地址。
88 84 5 igr[4:0] 报文源端口。
97 89 9 hl[8:0] 报文头长度，单位Byte。
111 98 14 bl[13:0] 报文body 长度，单位Byte。
112 112 1 first_leaf
第一份组播叶子指示，单播报文时，first_leaf 和last_leaf
同时有效。
113 113 1 last_leaf
最后一份组播叶子指示，单播报文时，first_leaf 和
last_leaf 同时有效。
117 114 4 pri[3:0] EPON:队列的优先级; GPON: {2’b0,scr}。
128 118 11 mcid[10:0] 组播ID。
SD5182HV100 Functional Specification Page 276 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
135 129 7 flow_st_idx0[6:0] 流统计索引0。
136 136 1 flow_st_vld0 流统计索引0 有效指示。
143 137 7 flow_st_idx1[6:0] 流统计索引1。
144 144 1 flow_st_vld1 流统计索引1 有效指示。
146 145 2
drop_reason[1:0] PE 的丢弃原因：
2’b00：不丢弃；
2’b01：报文编辑后长度为0；
2’b10：Quark 指示报文是DISCARD；
2’b11：PQM指示报文是DISCARD 且是组播报文。
151 147 5 mc_rls_wgt[4:0] 组播报文释放的冗余权重。
160 152 9 ecc[8:0] ECC 校验。
Table 5.8-2 TM info structure
5.8.5.2 Buffer Resource Management
支持三种资源管理方式：基于报文个数管理、CELL 数管理、16BYTE 为单位的资源管理。
报文数管理和CELL 管理支持全局可配置，要么配置成报文数管理，要么配置成CELL 管
理,16B 缓存管理可以单独配置关闭。系统运行过程中BYTE 管理和CELL 管理（或包管
理）同时运行。下面的描述适合上述三种管理方式。
 芯片的队列资源分为两部分:队列独享资源和共享资源。
 队列独享队列资源是为队列预留的队列资源，即该队列至少可用的队列资源数目，即
使该队列不用，其它队列也不能占用。
 共享队列资源是为队列竞争使用的。一个报文申请入队，优先占用该队列的独享队列
资源。如果独享队列资源已经用完，再申请占用共享资源。返还的时候，优先返还共
享资源，之后返还独享资源。
 队列独享资源，共享资源之和必须小于等于芯片支持的最大队列资源数目。如果配置
不正确，则每个队列的独享队列资源得不到保证。
 队列基于模板可配独享队列资源和最大队列长度。
队
列
可
配
独
享
资
源
共 享 资 源
队
列
可
配
独
享
资
源
队
列
可
配
独
享
资
源
队
列
可
配
独
享
资
源
队
列
可
配
独
享
资
源
队
列
可
配
独
享
资
源
队
列
可
配
独
享
资
源
队
列
可
配
独
享
资
源
队
列
可
配
独
享
资
源
队
列
可
配
独
享
资
源
队
列
可
配
独
享
资
源
队
列
可
配
独
享
资
源
Figure 5.8-4 Reserved and Share Queue Resource
队列组的划分及配置:
SD5182HV100 Functional Specification Page 277 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 队列组是指一组队列，队列组的划分基于队列模板可配，即队列属于哪个队列组可配。
 具有队列组的属性，是指基于队列组的配置对缓存进行管理。
 软件可规划队列组的划分方法，逻辑不做限制。
 队列组可配队列组最大共享资源group_max。灵活配置，既可限制队列组的最大共享
资源占用，又可达到保留共享资源给队列组使用的效果。
组1最大共享资源保留给组0共享资源
所有共享资源
保留给组1共享资源 组0最大共享资源
Figure 5.8-5 Reserved and Share Queue Resource
队列组可配队列组芯片拥塞的丢弃门限chip_drop_group。灵活配置，可达到在拥塞情况
下，保留给优先权高，流量大的队列组共享资源的效果。
共享资源
组X能共享
资源
组Y能共
享资源
组Z能共
享资源
组芯片级拥塞处理
组X芯片级丢弃门限
组Y芯片级丢弃门限
组Z芯片级丢弃门限
Figure 5.8-6 组芯片级共享资源门限示意图
5.8.5.3 Tail-Drop
因为队列资源使用策略的配置，导致报文丢弃，称为尾丢弃。具体包括队列长度超过阈
值，或者独享队列资源已经用完，申请不到共享队列资源。
SD5182HV100 Functional Specification Page 278 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
当队列发生尾丢弃之后，什么时候允许接收报文，基于队列模板可配。具体选择有：
 基于字节统计的队列深度值低于丢弃阈值；
 队列深度低于队列尾丢弃阈值；
 队列深度低于队列尾丢弃阈值的x/8，x具体值在队列模板可配。
5.8.5.4 Queue Resource Management
为了合理的利用队列资源，需要遵循的原则是尽量共享队列资源。通过拥塞管理，希望达到队列在芯片拥塞时，能够申请的缓存资源较少，反之能申请较多的缓存资源。
这里所说的队列资源是指报文的缓存资源。芯片对缓存资源的管理基即于CELL数目、也基于包数目管理，基于16BYTE级资源管理，允许预借资源。即每次判断资源数目时，用已占用资源数目进行判断。如果可以入队，则此报文必须能够全部入队，避免报文头可以接收，报文身体丢弃的决策。因为支持预借，这种情况下，芯片共享缓存需要再保留一些资源给预借，即此时队列独享资源，共享队列资源之和必须小于芯片支持的最大队列资源数目。
队列缓存管理需要明确几个概念。
首先是状态信息的一些名词:
 q_depth:队列占缓存资源的深度
 group_depth:队列组占共享缓存资源的深度
 chip_depth:芯片占共享缓存资源的深度
下面是一些配置信息:
 q_private:保留给队列的独享缓存资源
 q_max:队列最大可用缓存数目
 q_cong:队列拥塞门限。队列占用缓存数目大于等于此值时；否则，认为队列不拥塞。
 group_max:队列组最大可用共享缓存数目
 chip_drop_group:基于芯片拥塞的队列组丢弃门限。即芯片占共享缓存超过此阈值时，丢弃相应队列组的报文。
 group_cong:队列组占用共享缓存数目大于等于此值时；否则，认为队列组不拥塞。
SD5182HV100 Functional Specification Page 279 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 chip_cong:芯片的拥塞阈值。即芯片占共享缓存资源超过此值认为芯片已经拥塞。
下面是具体的包丢弃管理方案
N
N
入队成功报文丢弃，入回收队列
Y
Y
结束
N
芯片总资源>=总体资源配置
队列尾丢？
（队列深度大于等于尾丢门限）
N
队列组尾丢？
（队列组0或1缓存深度大于等于组尾丢门限）
队列组芯片尾丢？
（芯片共享缓存大于等于队列组0或1的芯片丢弃门限）
芯片尾丢？
（芯片共享缓存大于等于芯片最大共享缓存门限）
拥塞丢弃？
（队列拥塞& 队列组拥塞& 芯片拥塞）
队列深度小于独享资源？
N
队列配置错误？
（队列链接调度器配置错误或队列出口错误等？）
N
N
WRED丢弃
N
Y
Y
N
Y
Y
Y
Y
Y
Y
N
DQM指示丢弃或 队列模板丢弃或 入队使能丢弃?
接收DQM入队请求/二次入队请求
SD5182HV100 Functional Specification Page 280 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure 5.8-7 入队判决方案
上述算法适用于16B缓存管理方案、CELL管理方案、包管理方案。如果任何一套算法判决丢弃，则包应该丢弃。运行过程中，字节级管理方案、CELL管理方案（或包管理方案）任何一套方案判决为丢弃则该报文须丢弃。
5.8.5.5 Multicast Buffer Calculation
当配置为基于CELL（或配置为PKT）、16BYTE单元进行缓存管理的时候，会统计每个报文占用的CELL数目和16BYTE单元数目。组播报文比较特殊，组播叶子需要缓存不同的报文头，但是报文身体共用一个。因此支持两种计算方法，全局可配:一种为组播叶子只统计报文头占的CELL数目和16BYTE单元数目，另外一种为组播叶子统计报文头和身子占的CELL数目和BYTE单元数目。
5.8.5.6 Buffer Cell And Packet Statistic
由于出队的时候，16Byte ,CELL的计数释放需要等EPS返回的FD信息才释放，而PKT的计数释放是在出队时刻就完成了，因此两者的释放时刻不同。因此如果当前发流的情况下，CPU读取队列的16Byte,CELL,PKT，芯片的16Byte,CELL和PKT统计的时候，可能存在不一致情况。但是EQM能保证，如果停流的情况下，CELL和PKT的计数应该清零。
5.8.5.7 Surplus Weight Release
PE 模块负责组播报文的MCID申请，在最好一份叶子报文时将组播MCID的冗余权重送到EQM进行释放；最后一份叶子报文有可能NP转发决策为丢弃，但仍然需要将其送到EQM进行冗余权重的释放。冗余权重的计算在PE完成，PE从first leaf 到last leaf数出一份组播里有多少叶子报文是正常转发的，然后用32减去正常转发的叶子分数（不算last leaf）就是冗余权重。
5.8.5.8 IFB/EFB Selection
内外置缓存的选择
自适应的动态选择内置或者外置的算法如下：
出端口组的绑定关系见寄存器NNI_GP，ETH_GP，PIE_GP，PRBS_GP，WOE_GP。
出端口组的水线配置见寄存器PORT0_GP_TH，PORT1_GP_TH，PORT2_GP_TH，PORT3_GP_TH，FREE_CNT_TH。
SD5182HV100 Functional Specification Page 281 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
具体的缓存选择功能如下：
通过FAM送过来的4组出端口的IFB cell统计值，判断报文所属的出端口是否有足够的资源支持报文存放到IFB中，如果资源不足，则存放到EFB中；
Jumbo帧固定走内置缓存，无足够的内置缓存时丢弃报文；
出端口总共有4组，对应的优先级别从port0～port3递减，使用4个出端口IFB资源使用统计，port_cnt0~port_cnt3。
各个出端口组的要求如下：
对于port3要求： port0_cnt+port1_cnt+port2_cnt+port3_cnt <=port3_gp_th才能走IFB通道；
对于port2要求： port0_cnt+port1_cnt+port2_cnt <=port2_gp_th才能走IFB通道；
对于port1要求： port0_cnt+port1_cnt <=*port1_gp_th才能走IFB通道；
对于port0要求： port0_cnt <=port0_gp_th才能走IFB通道；
DQM根据出端口egrb映射出对应的出端口组号，处理流程如下：
SD5182HV100 Functional Specification Page 282 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
收到报文信息
IFB空闲cell
超过水线？
端口组
统计大于等于
水线？
IFB处理
Y
N
Y
N
EFB处理
IFB空闲cell
是否足够存下
当前包
EFB空闲cell
是否足够存下
当前包
丢弃处理
Y
Y
N
N
Figure 5.8-8 内外置缓存的选择
5.8.6 Internal Loop
为了提供用户级的Qos，需要层次化的调度拓扑，EQM 采用二次入队的方法来实现这个
功能。PE 编辑后的报文进入EQM 的队列，如果二次入队指示有效，则经过拥塞管理、
调度然后从PORT0 端口调度出队后进入EPS，EPS 读取二次入队所需要的队列信息后再
环回到EQM 的入端口，再重新经过拥塞管理、调度发往真正的出端口。
功能示意图如下：
SD5182HV100 Functional Specification Page 283 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PON
GSCH
PORTx
GSCH
ux
GSCH
userg
SCH
u0
GSCH
u1
GSCH
userg
SCH
ETH0
GSCH
ETH1
SCH
Port
SCH
P0
SCH
Logic
Channel
Output
Port
Output
EPS
EQM
Output
PE
RR
二次入队
环回
ux
GSCH
MAC
LOOP
Figure 5.8-9 二次入队处理示意图
5.8.7 Packet Data Manager
PDM 子模块根据报文的转发出端口 进行分组管理，可以配置上行报文使用EFB 缓存
报文，下行报文使用IFB 缓存报文，这样可以减少上行报文因为写DDR 的时延大而
阻塞下行的要缓存到IFB 的报文，可以更充分地利用IFB 的带宽，减轻EFB 的带宽负
荷。
 PDM 子模块负责EFB 缓存地址的申请使用。当报文选择缓存到EFB 时，PDM 向
FAM申请EFB CELL 地址， PDM 模块将报文数据写入相应的CELL 地址中，同
时完成帧内链的链接。
 PDM 子模块决策报文是缓存在IFB 还是EFB， 有两种模式选择内外置缓存，采用
哪种模式是配置决定的。模式1（自适应模式）：根据 端口组IFB 缓存的占用情
SD5182HV100 Functional Specification Page 284 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
况，优先使用IFB，IFB 超过端口组的IFB 占用水线时使用EFB 缓存报文；模式2
（强制模式，仅作为Debug 使用）： 根据报文的出端口和通道组配置，将报文分
成4 个组，按组固定配置使用IFB 或EFB；
 如果报文选择缓存在EFB，则PDM 模块将报文数据从PLB 搬到EFB，然后将FD
送往QE 子模块入队。如果报文选择缓存在EFB，则不需要搬动报文，只需要将报
文的所占的PLB 资源统计转为IFB 资源统计，然后将FD 送往QE。
 当配置使用自适应模式缓存选择，出端口总共有4 组，对应的优先级别从port0～
port3 递减，使用4 个出端口IFB 资源使用统计，port_cnt0~port_cnt3 另外还有一个
组播身体专用的cell 使用资源统计mc_cnt。
 当报文为单播报文的时候，各个出端口组的要求如下：
 对于port3 要求：mc_cnt+port0_cnt+port1_cnt+port2_cnt+port3_cnt <=port3_gp_th 才
能走IFB 通道
 对于port2 要求：mc_cnt+port0_cnt+port1_cnt+port2_cnt <=port2_gp_th 才能走IFB
通道；
 对于port1 要求：mc_cnt+port0_cnt+port1_cnt <=*port1_gp_th 才能走IFB 通道；
 对于port0 要求：mc_cnt+port0_cnt <=port0_gp_th 才能走IFB 通道；
PBM
IFB空闲cell
超过水线？
端口组
统计大于等于
水线？
IFB
EFB
Y
N
Y
N
Y
N
Figure 5.8-10 内外置缓存选择
SD5182HV100 Functional Specification Page 285 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.8.8 Queue Schedule
5.8.8.1 Schedule Topology Overview
 EQM可以支持业务/用户/端口调度。同时支持基于逻辑通道的反压。
 调度器拓扑结构示意图（调度拓扑可配置）如下:
SD5182HV100 Functional Specification Page 286 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
0
1
7
0
P
R
B
S
0
1
3
0
1
2
3
0
1
3
0
1
2
3
用
户
调
度
器
0 E
T
H
1
~
5
1
2
3
P
O
N
0 C
P
U
0
~
3
1
2
3
端
口
调
度
器
0
RR
端
口
调
度
器
1
R
R
cpu0~3
u0
u1
ux
端
口
调
度
器
2
R
ETH0~4 R
上行
出
口
调
度
R
R
RR EPS
0
1
3
0
1
2
3
D
R
R
0
1
2
3
0
1
2
3
D
R
R
0
1
3
0
1
2
3
D
R
R
下行
Figure 5.8-11 SCHEDULER TOPOLOGY 示意图
SD5182HV100 Functional Specification Page 287 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.8.8.2 Schedule Output
 EQM 的调度输出支持基于逻辑通道的反压,PE 的入队和EPS 的二次入队请求首释
放通道FIFO 的将满反压。逻辑通道EQM_CHID 的具体含义见错误!未找到引用源。
EQM _CHID 说明章节。
 EPS 需要周期把逻辑通道的状态送给EQM，EQM 把它映射到调度器的输出。受反
压的调度器输出不能送给EPS。
 EPS 送给EQM 的反压状态有一定的延时。因此，允许反压产生之后，EQM 还送
出1~2 个帧描述符FD 给EPS。
 同一个端口，最快16 拍送出一个FD；
 不同端口之间，最快可以8 拍输出一个FD；
5.8.8.3 Port Schedule
逻辑支持4 个端口调度器。为了节省模块间的布线资源，需要时分复用一组总线，把调度
结果送给后序模块。端口之间进行RR 轮询。
ETH/NNI
LOOP
RR
PON/NNI
Port0
Port1
Port2
Port3
PIE_PRBS
EPS
Circuit SCH
Figure 5.8-12 Port Schedule
5.8.8.4 Shaper
 EQM 的实体队列、调度器的输出都有shaper 进行限速。
 SHAPER 支持预借令牌。最多预借一个报文的令牌。
 基于实体队列的shaper:每个队列可配绑定支持一个shaper，即同时支持的shaper
数目跟实体队列数目一致。当shaper 令牌不够时，相当于一级调度器看不到此实
体队列的调度请求。
 通用调度器的shaper:每个通用调度器可配绑定支持一个shaper，即同时支持的
shaper 数目跟通用调度器的数目一致。当shaper 令牌不够时，相当于通用调度器没
有调度结果。
SD5182HV100 Functional Specification Page 288 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.8.8.5 Schedule Algorithm
EQM 同时支持RR、 SP/WRR 等调度算法。下面详细解释各个算法的特点和用法。
Strict Priority：
Strict Priority(SP)调度即严格优先级调度，是基于优先队列（Priority Queuing，PQ）
的一种调度算法。该算法按照队列优先级的高低进行调度，高优先级先调度，低优先级后
调度.高实体队列非空，就先调度优先级高的队列出队，只有在优先级高的队列调度空后，
才调度低实体队列。如下图所示，从Queue0 到Queue3 也按照优先级的降序做绝对优先
调度，在报文出队的时候，SP 首先让处于最高优先级的Queue0 队列中的报文出队，直到
Queue0 队列中的报文发送完，然后发送中优先队列中的报文，同样直到发送完，依次类
推，只有Queue0、Queuel 和Queue2 队列的报文全部出队才去调度Queue3 队列。只要高
实体队列非空就一直调度高实体队列， 优先级级别越低的队列得到调度机会就越少
(Queue0>Queuel>Queue2>Queue3)。
SP
SP
pri1_queue
pri2_queue
pri3_queue
SP
pri0_queue
Figure 5.8-13 Strict Priority
Round Robin：
Round Robin (RR),也就是轮流调度各个输入端。主要适用于对帧长不敏感，各个输入端权
重一样的调度。
Weight Round Robin：
WRR 调度要求定义一个数值用于规定当前队列与其他优先级队列的相对重要性
（weight）。WRR 调度防止低优先级的队列在高优先级队列传输时被完全忽略。WRR 调
度对各个队列实行轮流发送机制。报文的权重与队列的重要性相对应。通过调度功能，即
使高优先级的队列为非空，低优先级的队列也能获得机会发送报文，这样带宽资源可以得
到充分的利用。
SD5182HV100 Functional Specification Page 289 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
SP/WRR:
SP/WRR 是SP 和WRR 混合调度，如下图所示。对每个输入端可配组属性及WRR 调度权
重。逻辑对同一组的输入端进行WRR 调度，然后对各个组进行SP 调度。进行SP 调度时
候，0 优先权最高，7 优先权最低。
WR
R
WR
R
WR
R
SP
0
1
7
Figure 5.8-14 SP/WRR
5.8.8.6 Share-Bandwidth Schedule
共享带宽设计需要支持的目标：
支持用户间的带宽保障
支持用户业务间的带宽保障。
支持用户间高优先级业务的带宽保证。
场景1（多用户带宽保证）：
总上行带宽20Mbps。
如果只有用户A 上网，则A 独占20Mbps 带宽。
如果用户B 加入，则A/B 各分配最低5Mbps 保证带宽，A 优先级比B 高，可以优先级占
用10Mbps 的保留带宽，A 最高15Mbps 最大带宽。
如果A 和B 同时在线，则A/B 各分配最低5Mbps 保证带宽，则剩余的10Mbps 带宽可以
按比例分配给A 和B。
场景2（多业务带宽保证）：
SD5182HV100 Functional Specification Page 290 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
总上行带宽20Mbps。
如果用户只有上网业务，则独享20Mbps 带宽。
如果用户有视频和上网业务，视频和上网各配置5Mbps 的保证带宽，则视频优先级高可
以分配到15Mbps 带宽，上网分配5Mbps。
如果用户有视频和上网业务，视频和上网各配置5Mbps 的保证带宽，则剩余的10Mbps 带
宽可以按比例分配给视频和上网。
场景3（多用户多业务带宽保证）：……
用户A 在玩即时游戏，用户B 在做FTP 下载。
则用户A 优先使用带宽，用户B 低优先级使用带宽。
0
1
2
3
0
0
1
2
3
1
0
1
2
3
...3
用户业务
端口优先级队列
0
...3
1
用户
0
...15
1
W
R
R
R
R
W
R
R
0
1
...3
0
...3
1
W
R
R
端口1
端口2
(S,U,P)
Statistic
NP
业务识别
qos策略
业务流
A
C
L
?
W
R
R
W
R
R
R
R
EQM
QID1
QID2
Figure 5.8-15 典型调度拓扑
QoS 需要支持如上图所示的拓扑结构：用户业务队列，用户队列，和端口优先级队列。
从外到内，
SD5182HV100 Functional Specification Page 291 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 第一级为端口优先级队列，支持4/8个业务优先级。
 第二级为用户队列。
 第三级为用户业务队列，每个用户4/8个优先级队列。
实现方案：
游戏
视频
上网
下载
保证带宽令牌桶溢出
时，溢出部分令牌添
加到共享令牌中
125us 周期添加预留
带宽令牌
125us 周期添加保证
带宽令牌
图表 10 共享带宽令牌
A.保证带宽令牌桶：
各种业务的保证令牌根据配置的xir 配置的大小，按照固定的125us 周期往令牌桶里添加
令牌。如果业务流量少于保证带宽，令牌桶慢慢就会被填满，周期性添加令牌时就会有溢
出，溢出部分的令牌就会被添加到共享令牌桶中。
B.共带宽令牌桶：
共享保证令牌桶根据配置的保留带宽配置的大小，按照固定的125us 周期往令牌桶里添加
令牌。如果各个保证带宽令牌有溢出，溢出部分的令牌会加上周期性添加的令牌一起添加
到共享令牌桶中。
调度:
在有保证带宽令牌的情况下，优先使用保证带宽令牌桶里的令牌，消耗共享令牌阶段采用
RR 调度，确保各业务流的保证带宽能实施。
SD5182HV100 Functional Specification Page 292 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
在调度器各个输入的保证带宽都消耗完或队列空的情况下，根据保留带宽的分配策略来调度；若按照优先级来分配保留带宽则此阶段进行SP调度，若按照比例来分配保留带宽，则此阶段进行WRR调度。
1. 仅0~7号通用调度器支持共享带宽特性；耗不完的保证带宽会转为共享带宽，共享带宽的根据配置采用SP调度或RR调度。
2. 将GSSA表中的specific_sch_sel配置成2‘b10，共享带宽按照优先级分配，调度器输入端抢占共享带宽的优先级在GSSA表中配置。
3. 将GSSA表中的specific_sch_sel配置成2‘b11，共享带宽按照比例权重分配，各输入端的抢占共享带宽权重在STS表中配置。
4. 使用该共享带宽调度时，调度器各个输入端的保证带和共享带宽的BWT表中的bw_ctrl_en配置成1；
5. 使用共享带宽特性的调度器仅支持0~7 8个输入端。
6. 保证带宽的配置在BWT表中0~63的表项中配置，譬如调度器0的输入2的保证带宽是在BWT的地址0x02上配置；调度器3的输入1的保证带宽是在是在BWT的地址0x31上配置；
7. 0~7共享带宽的配置在BWT表中地址为64~71的表项中配置，譬如调度器0在BWT的地址64上配置；调度器7的共享带宽是在BWT的地址71上配置；
8. 使用共享带宽特性的调度器仅支持0~7 8个输入端。
9. 保证带宽的XBS建议配置成2倍的速率配置值，譬如保证带宽10Mbps,则XBS建议配置成MAX {MTU，2*10_000/64 Byte}。
10. 共享带宽的XBS至少需要配置成调度器总带宽的匹配值的2倍，譬如调度器有4个输入端，每个输入端的保证带宽为20Mbps,共享带宽为10Mbps, 则共享带宽的XBS至少需要配置成MAX{MTU，2* 90000/64 Byte}。
注：
SD5182HV100 Functional Specification Page 293 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
1. 多级调度时，仅支持其中一级调调度器支持共享带宽特性，同一调度收敛树上不支持多级调度同时使用共享带宽特性。
2. 使用共享带宽特性的调度器不支持传统的shaping功能。(调度器的输入支持shaping, 调度器的输出不支持shaping)
5.8.9 Error Handling
 缓存资源占用量超过配置的水线时，会上报中断。
 缓存资源占用量减溢出时，会记录历史状态，无恢复措施。
 调度拓扑配置错误时，会记录错误状态。
 RAM校验错误时，会记录错误状态。
5.8.10 Debug Features
EQM内部状态，CPU可读。如果配置寄存器EQM_DEBUG_CTRL，打开调试开关TAB_DEBUG，则状态表CPU也可以配置进行调试。
 A. 支持调度拓扑连接错误的告警可查询；
 B. 支持调度错误（调出空队列）告警；
 C. 支持缓存资源占用超过总容量的告警；
 D. 支持模块级收发包统计，拥塞管理丢包，异常丢包统计可查询；
 E. 支持按队列入队和丢包统计，丢包包括：尾丢弃，拥塞丢弃；
 F.支持实时查询芯片当前队列缓存的包数目和CELL数目；
 G.支持单包出队调试模式；
5.8.11 Power Management
EQM 统计二次入队队列里攒着的报文，如果队列报文统计不为0，则输出1bit busy信号有效，否则输出busy 信号无效。当Busy 信号有效时，申请高档位的频率，当Busy信号无效时，申请低档位的频率。
5.8.12 Table Configuration
因支持的队列和队列资源数目较多，很多控制信息都是存储在内部表项中。表项采用间接访问方式，可以节省地址访问空间，有利于各个项目重用。
下面的描述需要操作寄存器EQM_TAB_CFG，EQM_TAB_RDATA0~5，EQM_TAB_WDATA0~5，具体请参看寄存器描述。
5.8.12.1 Table Write
具体步骤如下:
 查询寄存器EQM_TAB_CFG，等待上次操作完成。
SD5182HV100 Functional Specification Page 294 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
寄存器EQM_TAB_CFG. TAB_OP_START为0，表示上次操作已经完成；为1，说明CPU上次操作还没有完成，需要继续等待，直到上次操作完成。
 配置寄存器EQM_TAB_WDATA0~5。
根据所配置的表项的位宽，决定需要配置的寄存器数目。最终EQM会把{ EQM_TAB_WDATA5，EQM_TAB_WDATA4, EQM_TAB_WDATA3, EQM_TAB_WDATA2，EQM_TAB_WDATA1, EQM_TAB_WDATA0}写进相应表项的对应地址。如果相应TAB的位置不足192位，则取低位的值配置。如调度器属性表GSSA，位宽为96bit，如果配置表GSSA，则逻辑会把{ EQM_TAB_WDATA2[31:0], EQM_TAB_WDATA1, EQM_TAB_WDATA0}写进相应TAB的对应地址。
 配置寄存器EQM_TAB_CFG，发动写操作。
具体为EQM_TAB_CFG.TAB_OP_START为1，EQM_TAB_CFG.TAB_OP_WR为1，EQM_TAB_CFG.TAB_IDX/ EQM_TAB_CFG.TAB_ADDR为所需要配置的TAB的编号和具体地址。
 查询寄存器EQM_TAB_CFG，等待这次操作完成。
寄存器EQM_TAB_CFG. TAB_OP_START为0，表示上次操作已经完成；为1，说明CPU上次操作还没有完成，需要继续等待，直到上次操作完成。
5.8.12.2 Table Read
具体步骤如下:
 查询寄存器EQM_TAB_CFG，等待上次操作完成。
寄存器EQM_TAB_CFG. TAB_OP_START为0，表示上次操作已经完成；为1，说明CPU上次操作还没有完成，需要继续等待，直到上次操作完成。
 配置寄存器EQM_TAB_CFG，发动读操作。
具体为EQM_TAB_CFG.TAB_OP_START为1，EQM_TAB_CFG.TAB_OP_WR为0，EQM_TAB_CFG.TAB_IDX/ EQM_TAB_CFG.TAB_ADDR为所需要配置的TAB的编号和具体地址。
 查询寄存器EQM_TAB_CFG，等待这次操作完成。
寄存器EQM_TAB_CFG. TAB_OP_START为0，表示上次操作已经完成；为1，说明CPU上次操作还没有完成，需要继续等待，直到上次操作完成。
 读寄存器EQM_TAB_RDATA0~5。
根据所配置的TAB的位宽，决定需要读取的寄存器数目。
如调度器属性表QGA，位宽为96bit，则逻辑会把长字2写入寄存器EQM_TAB_RDATA2中，长字1写入寄存器EQM_TAB_RDATA1中，长字0写入寄存器EQM_TAB_RDATA0中。
SD5182HV100 Functional Specification Page 295 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.8.12.3 Dfx of Table Access
CPU操作可能会因为以下几个原因导致出错:
 EQM_TAB_CFG.TAB_IDX配置错误。即如果CPU访问内部不存在的TAB。
 对内部状态TAB进行写操作，但是没有把相关使能打开。
EQM内部所有的状态表，在正常模式下，CPU是只读的。如果要进行写操作，则需要把相应的使能打开，具体为把寄存器的EQM_DEBUG_CTRL . TAB_DEBUG配置为1。
 CPU操作TAB出错的表现和解决方法
一旦CPU操作TAB出错，逻辑会马上返还操作完成并报错。具体表现为EQM_TAB_CFG.TAB_OP_ERR为1。软件需要检查自己的操作命令，修改正确后，再发动一次正确的操作。
SD5182HV100 Functional Specification Page 296 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.8.13 Table Structure
5.8.13.1 EQM_CHID Specification
芯片中有很多涉及EQM_CHID域，在这统一进行解释EQM_CHID为发送方向的逻辑通道号，其格式如下表所示。
Table 5.8-3 EQM_CHID
5.8.13.2 QMS Table
队列属性模板选择，维护:由CPU维护，逻辑只读。 表格名称
QMS Table 起始地址
N/A 地址范围
N/A 表项数目
SD5182H: 256/16 = 16 每项宽度
32bits×4Word 寻址方式
索引方式为{队列号/16}，每行存16个队列的模板选择； ECC/PARITY
PARITY
Table 5.8-4 QMS Table表基本描述
Bit Name Description
长字0 7 6:5 4:3 2 1 0 Description PSCH
1
0
0~15
PON CHANNEL
3
0
0
1
000
RESERVED
4
0
0
2
00
0~1
LOOPBACK0-1
0
0
0
3
000
PRBS
1
0
1
0~3
000
PIE channel
1
0
8-13
000
ETH 0-5
2
1
0100
000
WOE channel
1
SD5182HV100 Functional Specification Page 297 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
31
q3_enq_en
队列入队使能 1: 入队0：不入队.
逻辑初始化成0，队列不能入队，需要软件配置后队列才能入队。
30:29
reserve
保留
28:24
q3_mode
队列资源模板选择。
23
q2_enq_en
队列入队使能 1: 入队0：不入队
逻辑初始化成0，队列不能入队，需要软件配置后队列才能入队。
22:21
reserve
保留
20:16
q2_mode
队列资源模板选择。
15
q1_enq_en
队列入队使能 1: 入队0：不入队.
逻辑初始化成0，队列不能入队，需要软件配置后队列才能入队。
14:13
reserve
保留
12:8
q1_mode
队列资源模板选择。
7
q0_enq_en
队列入队使能 1: 入队0：不入队.
逻辑初始化成0，队列不能入队，需要软件配置后队列才能入队。
6:5
reserve
保留
4:0
q0_mode
队列资源模板选择。
长字1
31
q7_enq_en
队列入队使能 1: 入队0：不入队.
逻辑初始化成0，队列不能入队，需要软件配置后队列才能入队。
30:29
reserve
保留
28:24
q7_mode
队列资源模板选择。
23
q6_enq_en
队列入队使能 1: 入队0：不入队.
逻辑初始化成0，队列不能入队，需要软件配置后队列才能入队。
22:21
reserve
保留
SD5182HV100 Functional Specification Page 298 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
20:16
q6_mode
队列资源模板选择。
15
q5_enq_en
队列入队使能 1: 入队 0：不入队.
逻辑初始化成0，队列不能入队，需要软件配置后队列才能入队。
14:13
reserve
保留
12:8
q5_mode
队列资源模板选择。
7
q4_enq_en
队列入队使能 1: 入队0：不入队.
逻辑初始化成0，队列不能入队，需要软件配置后队列才能入队。
6:5
reserve
保留
4:0
q4_mode
队列资源模板选择。
长字2
31
q11_enq_en
队列入队使能 1: 入队0：不入队.
逻辑初始化成0，队列不能入队，需要软件配置后队列才能入队。
30:29
reserve
保留
28:24
q11_mode
队列资源模板选择。
23
q10_enq_en
队列入队使能 1: 入队0：不入队
逻辑初始化成0，队列不能入队，需要软件配置后队列才能入队。
22:21
reserve
保留
20:16
q10_mode
队列资源模板选择。
15
q9_enq_en
队列入队使能 1: 入队0：不入队
逻辑初始化成0，队列不能入队，需要软件配置后队列才能入队。
14:13
reserve
保留
12:8
q9_mode
队列资源模板选择。
7
q8_enq_en
队列入队使能 1: 入队0：不入队.
逻辑初始化成0，队列不能入队，需要软件配置后队列才能入队。
SD5182HV100 Functional Specification Page 299 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
6:5
reserve
保留
4:0
q8_mode
队列资源模板选择。
长字3
31
q15_enq_en
队列入队使能 1: 入队0：不入队.
逻辑初始化成0，队列不能入队，需要软件配置后队列才能入队。
30:29
reserve
保留
28:24
q15_mode
队列资源模板选择。
23
q14_enq_en
队列入队使能 1: 入队0：不入队
逻辑初始化成0，队列不能入队，需要软件配置后队列才能入队。
22:21
reserve
保留
20:16
q14_mode
队列资源模板选择。
15
q13_enq_en
队列入队使能 1: 入队0：不入队.
逻辑初始化成0，队列不能入队，需要软件配置后队列才能入队。
14:13
reserve
保留
12:8
q13_mode
队列资源模板选择。
7
q12_enq_en
队列入队使能 1: 入队0：不入队.
逻辑初始化成0，队列不能入队，需要软件配置后队列才能入队。
6:5
reserve
保留
4:0
q12_mode
队列资源模板选择。
Table 5.8-5 QMS Table 数据结构
5.8.13.3 QMC Table
队列属性模板配置， 维护:由CPU维护，逻辑只读。
SD5182HV100 Functional Specification Page 300 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
表格名称
QMC Table 起始地址
N/A 地址范围
N/A 表项数目
32 每项宽度
32bits×6Word ECC/PARITY
PARITY 寻址方式
索引方式为{队列属性板板号}，每行存1个模板配置；
Table 5.8-6 QMC Table 表基本描述
Bit Field Description
长字0
31
Drop_all
丢弃使能 1：丢弃，0：不丢弃
30：28
tail_drop_mode
当发生尾丢弃后，队列深度小于一定阈值之后，才能继续接收报文，否则仍然作为尾丢弃处理。此阈值控制如下：
3’b111：96.875%的尾丢弃阈值；
3’b110：93.75%的尾丢弃阈值；
3’b101：90.625%的尾丢弃阈值；
3’b100：87.5%尾丢弃阈值；
3’b011：84.375%的尾丢弃阈值；
3’b010：81.25%的尾丢弃阈值；
3’b001：78.125%的尾丢弃阈值；
3’b000：100%尾丢弃阈值；
27:26
Reserve
保留
25:21
group_num1
队列的队列组1选择。
SD5182HV100 Functional Specification Page 301 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
20:16
group_num0
队列的队列组0选择。
15:13
reserve
保留
12:0
q_ifb_max
队列尾丢弃阈值（SD5182H保留）
长字1
31:29
reserve
保留
28
qmc_vp_use
Qmc模板有效标志信号（软件用来判断模板是否已经被占用，逻辑不使用这个bit）
27:26
reserve
保留
25:17
q_ifb_private
队列独享空间深度(保留)
16:13
reserve
保留
12:0
q_ifb_cong
队列拥塞门限(保留)
长字2
31:20
reserve
保留
19:16
q_mcid_drop_mode
当MCID的使用个数大于下面的配置阈值时，该队列开始丢弃报文。
0: 100% 的MCID
1: 6.25% 的MCID
2: 12.5% 的MCID
3: 18.75% 的MCID
4: 25% 的MCID
5: 31.25% 的MCID
6: 37.5% 的MCID
7: 43.75% 的MCID
8: 50% 的MCID
9: 56.25% 的MCID
SD5182HV100 Functional Specification Page 302 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
10: 62.5% 的MCID
11: 68.75% 的MCID
12: 75% 的MCID
13: 81.25% 的MCID
14: 87.5% 的MCID
15: 93.75% 的MCID
15:0
q_efb_max
队列尾丢弃阈值
长字3
31:29
Reserve
保留
28:20
q_efb_private
队列独享空间深度（CELL_PKT）
19
Reserve
保留
18:16
q_cong_exit_mode
队列拥塞退出阈值，相对于q_efb_cong和q_16b_cong，当队列深度小于一定阈值之后，退出拥塞状态，否则仍然作为队列拥塞处理。此阈值控制如下:
3’b111：93.75%的退出阈值； 15/16
3’b110：87.5%的退出阈值； 14/16
3’b101：81.25%的退出阈值； 13/16
3’b100：75%退出阈值； 12/16
3’b011：68.75%的退出阈值； 11/16
3’b010：62.5%的退出阈值； 10/16
3’b001：56.25%的退出阈值； 9/16
3’b000：100%退出阈值； 16/16
15:0
q_efb_cong
队列拥塞门限(CELL_PKT)
长字4
31:16
q_16b_cong
队列拥塞门限(16B)（低16bit）
SD5182HV100 Functional Specification Page 303 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
15:14
reserve
保留
13:0
q_16b_private
队列独享空间（16BYTE）
长字5
31
reserve
保留
30:8
q_16b_max
队列的最大深度（16B）
7
reserve
保留
6:0
q_16b_cong
队列拥塞门限(16B)(高7bit)
Table 5.8-7 QMC Table 数据结构
5.8.13.4 WRED Table
WRED模板配置，表项规格为16x128，每个地址存两个模板，共32个模板。维护:由CPU维护，逻辑只读。如果选择模板0，则不根据WRED进行丢弃。 表格名称
WRED Table 起始地址
N/A 地址范围
N/A 表项数目
16 每项宽度
32bits×4Word ECC/PARITY
PARITY 寻址方式
索引方式为{WRED模板号/2}，每行存2个WRED丢弃模板,共32个模板。
Table 5.8-8 WRED Table 基本描述
Bit Field Description
长字0
31:24
wred0_drop_p1
wred丢弃概率1。该值为丢弃概率256xp。
例如若丢弃概率为25%，则配置为256x25%=0x40。
SD5182HV100 Functional Specification Page 304 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
23:16
wred0_drop_thr1
wred丢弃阈值1，占队列尾丢弃阈值的百分比256xp
15:8
wred0_drop_p0
wred丢弃概率0。该值为丢弃概率256xp。
例如若丢弃概率为25%，则配置为256x25%=0x40。
7:0
wred0_drop_thr0
wred丢弃阈值0，占队列尾丢弃阈值的百分比256xp
例如若超过尾丢弃阈值的20%，则配置为256x20%=0x33。
长字1
31:24
wred0_drop_p3
wred丢弃概率3。该值为丢弃概率256xp。
例如若丢弃概率为25%，则配置为256x25%=0x40。
23:16
wred0_drop_thr3
wred丢弃阈值3，占队列尾丢弃阈值的百分比256xp
15:8
wred0_drop_p2
wred丢弃概率2。该值为丢弃概率256xp。
例如若丢弃概率为25%，则配置为256x25%=0x40。
7:0
wred0_drop_thr2
wred丢弃阈值2，占队列尾丢弃阈值的百分比256xp
长字2
31:24
wred1_drop_p1
wred丢弃概率1。该值为丢弃概率256xp。
例如若丢弃概率为25%，则配置为256x25%=0x40。
23:16
wred1_drop_thr1
wred丢弃阈值1，占队列尾丢弃阈值的百分比256xp
15:8
wred1_drop_p0
wred丢弃概率0。该值为丢弃概率256xp。
例如若丢弃概率为25%，则配置为
SD5182HV100 Functional Specification Page 305 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
256x25%=0x40。
7:0
wred1_drop_thr0
wred丢弃阈值0，占队列尾丢弃阈值的百分比256xp
例如若超过尾丢弃阈值的20%，则配置为256x20%=0x33。
长字3
31:24
wred1_drop_p3
wred丢弃概率3。该值为丢弃概率256xp。
例如若丢弃概率为25%，则配置为256x25%=0x40。
23:16
wred1_drop_thr3
wred丢弃阈值3，占队列尾丢弃阈值的百分比256xp
15:8
wred1_drop_p2
wred丢弃概率2。该值为丢弃概率256xp。
例如若丢弃概率为25%，则配置为256x25%=0x40。
7:0
wred1_drop_thr2
wred丢弃阈值2，占队列尾丢弃阈值的百分比256xp
Table 5.8-9 WRED Table 数据结构
5.8.13.5 QGA Table
队列组属性表，表项规格为32*192，维护:由CPU维护，逻辑只读。
QGA Table Specification 表格名称
QGA Table 起始地址
N/A 地址范围
N/A 表项数目
32 每项宽度
32×6Word 寻址方式
索引方式为{group_num} ECC/PARITY
N/A
SD5182HV100 Functional Specification Page 306 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Table 5.8-10 QGA Table表基本描述
QGA Table Structure
表1 Bit Field Description
长字0
31:29
reserved
保留
28:16
group_ifb_max
队列组IFB最大可用共享缓存资源阈值（保留）
15:0
group_efb_max
队列组EFB最大可用共享缓存资源阈值
长字1
31:29
reserve
保留
28:16
group_ifb_cong
队列组拥塞门限（保留）
15:0
group_efb_cong
队列组拥塞门限
长字2
31:29
reserved
保留
28:16
chip_drop_group_i fb
芯片拥塞的队列组丢弃门限。即芯片占共享缓存超过此阈值时，丢弃相应队列组的报文。（保留）
15:0
chip_drop_group_efb
芯片拥塞的队列组丢弃门限。即芯片占共享缓存超过此阈值时，丢弃相应队列组的报文。
长字3
31:23
reserve
保留
22:0
group_16b_max
组最大门限（16B）
SD5182HV100 Functional Specification Page 307 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
长字4
31:23
reserve
保留
22:0
group_16b_cong
组拥塞门限（16B）
长字5
31:23
reserve
保留
22:0
chip_drop_group_16b
芯片拥塞的队列组丢弃门限。即芯片占共享缓存超过此阈值时，丢弃相应队列组的报文（16B）
Table 5.8-11 QGA Table数据结构
5.8.13.6 QLS Table
队列链表状态表项规格为256x160
维护:由逻辑维护，CPU只读。
QLS Table Specification 表格名称
QLS Table 起始地址
N/A 地址范围
N/A 表项数目
SD5182H：256 每项宽度
32bits×5Word ECC/PARITY
N/A 寻址方式
索引方式为实体队列号
Table 5.8-12 QLS Table表基本描述
QLS Table Structure Bit Field Description
长字0
31:16
q_head
队列头指针（SD5182H保留）
SD5182HV100 Functional Specification Page 308 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
15:0
q_tail
队列尾指针（SD5182H保留）
长字1
31
q_tail_drop_st
队列是否处于尾丢弃状态。(CELL,PKT)
30
q_byte_drop_st
队列是否处于尾丢弃状态(BYTE)
29:15
q_16b_pri_cnt
队列的私有空间计数统计(16B)
14
q_16b_cnt_h1b
实体队列占用BYTE 的数目最高bit。
13:0
q_head_depth
当前需调度出队的包长度（SD5182H保留）
长字2
31:0
Reserve
保留
长字3
31:16
q_efb_cell_num
实体队列占用块的数目
15:0
q_efb_pkt_num
实体队列占用报文的数目
长字4
31:22
q_pri_cnt
队列的私有空间计数统计(CELL,PKT)
21:0
q_16b_cnt
实体队列占用16B的数目。
Table 5.8-13队列链表状态表QLS数据结构
5.8.13.7 QDC Table
队列丢弃和出队统计表，规格为256x192维护:逻辑统计，CPU读清零。
QDC Table Specification 表格名称
QDC Table 起始地址
N/A 地址范围
N/A 表项数目
5182H：256 每项宽度
32bits×6Word ECC/PARITY/NO
N/A 寻址方式
索引方式为实体队列号
Table 5.8-14 QDC Table表基本描述
SD5182HV100 Functional Specification Page 309 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
QDC Table Structure Bit Field Description
长字0
31:0
tail_drop_pkt
因入队决策为尾丢的报文数目。统计条件为：
(q_cnt > q_max) || (group_cnt > group_max) || ((share_cnt > share_max)(如果还有private该队列能继续入队)) || (share_cnt > group_chip_share_max )|| ((chip_cnt >chip_max(包含私有和共享）);
长字1
31:0
cong_drop_pkt
因入队决策为拥塞丢弃的报文数目。统计条件为：（q_cnt >q_cong）&& (g_cnt > g_cong) && (chip_cnt > chip_cong)
长字2
31:0
Wred_drop_pkt
入队决策为WRED丢弃的报文数目
长字3
31:0
out_pkt(低32bit)
调度器调度出队的报文数目，如果队列送到EPS，则是该队列送到EPS得数目，如果是二次入队的队列，则是该队列送到环回端口的数目
长字4
31:4
Reserve
保留。
3:0
out_pkt（高4bit）
调度器调度出队的报文数目，如果队列送到EPS，则是该队列送到EPS得数目，如果是二次入队的队列，则是该队列送到环回端口的数目
长字5
31:0
q_mcid_drop_pkt
当报文入队时，若使用的MCID的数量大于该队列的mcid的丢弃水线
SD5182HV100 Functional Specification Page 310 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
(q_mcid_drop_mode)时，统计因此该队列丢弃的报文个数
Table 5.8-15队列丢弃统计表QDC数据结构
5.8.13.8 PMC Table
端口MCID丢弃表，规格为16x32维护:逻辑统计，CPU读清零。
PMC Table Specification 表格名称
PMC Table 起始地址
N/A 地址范围
N/A 表项数目
5182H：16 每项宽度
32bits×1Word ECC/PARITY/NO
N/A 寻址方式
索引方式为映射后的端口号，如下所示：
0：NNI 1：PRBS 2~5：PIE
6~13：ETH0~ETH7
14：WOE 15：保留端口
Table 5.8-16 PMC Table表基本描述
PMC Table Structure Bit Field Description
长字0
31:0
Port_mcid_drop_pkt
当报文入队时，若使用的MCID的数量大于该端口的mcid的丢弃水线(port_mcid_drop_mode)时，统计因此该端口丢弃的报文个数
Table 5.8-17端口MCID丢弃统计表PMC数据结构
5.8.13.9 QDC_BYTE Table
QDC_BYTE Table Specification 表格名称
QDC BYTE Table
SD5182HV100 Functional Specification Page 311 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
起始地址
N/A 地址范围
N/A 表项数目
256 每项宽度
32bits×5Word ECC/PARITY/NO
N/A 寻址方式
索引方式为实体队列号
Table 5.8-18 QDC BYTE Table表基本描述
QDC_BYTE Table Structure Bit Field Description
长字0
31:0
tail_drop_byte
因入队决策为尾丢的报文字节数。统计条件为：
(q_cnt > q_max) || (group_cnt > group_max) || ((share_cnt > share_max)(如果还有private该队列能继续入队)) || (share_cnt > group_chip_share_max )|| ((chip_cnt >chip_max(包含私有和共享）);
长字1
31:0
cong_drop_byte
因入队决策为拥塞丢弃的报文字节数。统计条件为：（q_cnt >q_cong）&& (g_cnt > g_cong) && (chip_cnt > chip_cong)
长字2
31:0
Wred_drop_byte
入队决策为WRED丢弃的报文字节数
长字3
31:0
out_pkt_byte(低32bit)
调度器调度出队的报文字节数，如果队列送到EPS，则是该队列送到EPS得数目，如果是二次入队的队列，则是该队列送到环回端口的数目
长字4
SD5182HV100 Functional Specification Page 312 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
31:4
Reserve
保留。
3:0
Out_pkt_byte（高4bit）
调度器调度出队的报文数目，如果队列送到EPS，则是该队列送到EPS得数目，如果是二次入队的队列，则是该队列送到环回端口的数目
长字5
31:0
q_store_byte
队列里缓存的报文字节统计
Table 5.8-19队列丢弃统计表QDC_BYTE数据结构
5.8.13.10 GSSA Table
通用调度器调度属性表,表项规格为64x96维护:由CPU维护。
注意：用户级业务调度器和端口级业务调度器仅有4个输入，只需要配置输入端0~输入端3；而用户调度器有16个输入端，十六个输入端都需要配置；
GSSA Table Specification 表格名称
GSSA Table 起始地址
N/A 地址范围
N/A 表项数目
5182H：48 每项宽度
32bits×3Word ECC/PARITY/NO
N/A 寻址方式
索引方式为通用调度器编号
Table 5.8-20 GSSA Table表基本描述
GSSATable Structure Bit Field Description
长字0
31:18
Reserve
保留
17:16
specific_sch_sel
2’b00: 不是使用特定的调度算法，调度使用方式跟5118一样，是普通的WRR、SP调度；
SD5182HV100 Functional Specification Page 313 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
2’b01：保留；
2’b10：共享带宽调度，共享带宽分配按优先级分配；
2’b11：共享带宽调度，共享带宽分配按权重分配，权重在STS表配置；
15:8
Reserve
保留
7:0
eqm_chid
逻辑端口号。具体含义见EQM_CHID表的解释
长字1
31:24
Reserve
保留
23:21
input7_gnum
输入端的优先级属性，0最高，7最低
20:18
input6_gnum
输入端的优先级属性，0最高，7最低
17:15
input5_gnum
输入端的优先级属性，0最高，7最低
14:12
input4_gnum
输入端的优先级属性，0最高，7最低
11:9
input3_gnum
输入端的优先级属性，0最高，7最低
8:6
input2_gnum
输入端的优先级属性，0最高，7最低
5:3
input1_gnum
输入端的优先级属性，0最高，7最低
2:0
input0_gnum
输入端的优先级属性，0最高，7最低
长字2
31:24
Rsv
保留
23:21
input15_gnum
输入端的优先级属性，0最高，7最低
20:18
input14_gnum
输入端的优先级属性，0最高，7最低
17:15
input13_gnum
输入端的优先级属性，0最高，7最低
14:12
input12_gnum
输入端的优先级属性，0最高，7最低
11:9
input11_gnum
输入端的优先级属性，0最高，7最低
8:6
input10_gnum
输入端的优先级属性，0最高，7最低
5:3
input9_gnum
输入端的优先级属性，0最高，7最低
2:0
input8_gnum
输入端的优先级属性，0最高，7最低
Table 5.8-21通用调度器调度属性表GSSA数据结构
SD5182HV100 Functional Specification Page 314 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.8.13.11 QSL Table
队列调度器连接关系表,表项规格为(256+48) x32，
维护:由CPU初始化，逻辑维护。
QSL Table Specification 表格名称
QSL Table 起始地址
N/A 地址范围
N/A 表项数目
SD5182H : 256+48 每项宽度
32bits×1Word ECC/PARITY/NO
ECC 寻址方式
索引方式为输入端，即：
队列作为输入端，索引为{队列号}；
通用调度器作为输入端，索引为{队列总数目+通用调度器编号}；
Table 5.8-22 QSL Table表基本描述
QSLTable Structure
队列调度器连接关系表QSL数据结构 Bit Field Description
长字0
31:19
Reserve
保留
18
vp_use
有没有跟调度器的输入端相连
0:没有跟调度器的输入端相连
1:已经跟调度器的输入端相连
17:14
vp_num
对应通用调度器的第几个输入端，取值为0~15。
仅在父调度器为通用调度器有效。
13
sch_logic
父调度器输出是否跟逻辑通道相连
SD5182HV100 Functional Specification Page 315 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
12:6
reserve
保留
5:0
sch_num
对应的通用调度器ID。
Table 5.8-23 QSL Table表基本描述
5.8.13.12 STS Table
调度器令牌状态表,表项规格为(256+48)*32维护:由CPU初始化，逻辑维护。
STS Table Specification 表格名称
STS Table 起始地址
N/A 地址范围
N/A 表项数目
SD5182H：256+48 每项宽度
32bits×2Word ECC/PARITY/NO
N/A 寻址方式
索引方式为调度器的输入端，可能为队列、通用调度器的输出。
队列输出作为输入端，索引为{队列号}，每行存一个队列输出的配置。队列只能连到通用调度器的输入端。
通用调度器的输出作为输入端，索引为{Q_NUM+通用调度器编号}，每行存一个调度器输出的配置。
Table 5.8-24 STS Table表基本描述
STS Table Structure Bit Field Description
长字0
31:26
reserve
保留
25:24
Wgt_unit_sel
DRR调度算法情况下，单位权重代表的令牌数。
00:2K；
01:4K；
SD5182HV100 Functional Specification Page 316 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
10:8K；
11:16K;
23:16
Pir_wgt
PIR的调度权重。最大为255。（CPU配置）
WRR调度算法下：1个单位代表一个包 ；
DRR调度算法下：1个单位代表2048byte;
15
schedule_sel
0:WRR 1:DRR
14:9
reserved
保留
8
pir_tk_borr_st_wrr/drr_pir_token[8]
WRR情况下，令牌预借标志0：没有处于预借状态 1：处于预借状态； DRR情况下，令牌统计的第8bit；
7:0
Wrr_Pir_token/Drr_pir_token[7:0]
PIR的调度令牌。（逻辑更新,WRR情况下的令牌统计，DRR情况下令牌统计的低8bit）
长字1
31:15
reserved
保留
14
pir_tk_borr_st_drr
DRR情况下是否已经处于预借令牌状态（逻辑更新）
0:没有处于预借令牌状态
1:已经处于预借令牌状态
13:0
Drr_pir_token[22:9]
DRR_PIR的调度令牌高14bit。（逻辑更新）
Table 5.8-25调度器令牌状态表STS数据结构
5.8.13.13 GSMA Table
表项规格为(48*16)*32，逻辑维护，CPU可读。
GSMA Table Specification 表格名称
GSMA Table
SD5182HV100 Functional Specification Page 317 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
起始地址
N/A 地址范围
N/A 表项数目
SD5182H： 48×16 每项宽度
32bits×1Word ECC/PARITY/NO
ECC 寻址方式
索引方式为{通用调度器编号, 调度器输入端编号}，每个调度器保留16个输入端的配置。
Table 5.8-26 GSMA Table表基本描述
GSMA Table Structure
通用调度器成员属性表GSMA数据结构 Bit Field Description
长字0
31:16
reserve
保留
15
Val
该调度器的输入端是否被占用
0: 没有给占用
1: 已经给占用
14
vp_sch
调度器的输入端为子调度器的输出或者实体队列。为1表示为子调度器的输出；为0表示实体队列直接连到本调度器的输入端。
13:8
reserve
保留
7:0
q_num
如果对应的是实体队列，q_num[7:0]表示256个实体队列号；
如果对应的是子调度器的输出，则
q_num[5:0]表示子调度器的ID；
Table 5.8-27 GSMA Table数据结构
5.8.13.14 SHT Table
表项规格为48*64。
SD5182HV100 Functional Specification Page 318 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
维护:由CPU维护，逻辑只读。
SHT Table Specification 表格名称
SHT Table 起始地址
N/A 地址范围
N/A 表项数目
48 每项宽度
32bits×2Word ECC/PARITY/NO
N/A 寻址方式
索引方式为SHAPER模板号，存储SHAPER模板配置。
Table 5.8-28 SHT Table表基本描述
SHT Table Structure Bit Field Description
长字0
31:25
reserve
保留
24
Shape_mode
0:BPS模式，1：PPS模式 （这个bit只给软件使用，逻辑不用，用来标识当前模板是BPS模板还是PPS模板；队列、通用调度器、端口调度器SHAPER采用哪种模式看QSCT、SSCT、PSCT的模式配置）
23:20
reserve
保留
19:0
XIR
1:队列与通用调度器的shape配置，单位为16Kbps，支持的速率范围为:0～10Gbps（例如带宽1.6Mbps，需要配置CIR=1.6Mbps/16Kbps=100），支持QSCT,SSCT，刷新周期为125US。
2:端口调度器的shape模板配置,单位为1Mbps，支持PSCT，刷新周期为8US;如带宽为1G,则配置为1000M/1M=1000;
3：队列和通用调度器情况下，如果对应PPS模式的模板，单位取决于 SHAPE_MODE_PPS寄存器的配置值。
SD5182HV100 Functional Specification Page 319 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
配置为0：单位为1PPS
配置为1：单位为16PPS。
4：端口调度器情况下，XIR值即为PPS值；
长字1
31:24
reserve
保留
23:0
XBS
1：队列和通用调度器情况BPS下：支持的突发度，单位为1byte，支持的突发范围为0~16Mbyte。建议配置值为：
CBS0 > 2*MTU（最大包长）;
CBS1 > xir*16k*125US（当前的刷新时间）/8(byte);
取CBS0和CBS1中的最大的一个配置对应SHAPE模板的CBS。
2：队列和通用调度器在PPS情况下：
CBSP0 == n*2000, n>=2
CBSP1 == ((xir*16k*125US（当前刷新时间）/8（byte）)/2000) ↑（上取整）*2000.
取CBSP0和CBSP1的最大值配置。
3：端口调度器BPS情况下：
CBS0 > 2*MTU（最大包长）;
CBS1 > xir*1Mbit*8US（当前的刷新时间）/8(byte);
取CBS0和CBS1中的最大的一个配置对应SHAPE模板的CBS。
4:端口调度器PPS情况下：
CBS0 == n * 125000byte n>=2;
CBS1 > （xir*1Mbit*8US（当前的刷新时间）/8(byte);
取CBS0和CBS1中的最大的一个配置对应SHAPE模板的CBS。
Table 5.8-29 SHT Table数据结构
SD5182HV100 Functional Specification Page 320 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.8.13.15 QSCT Table
队列输出的SHAPER配置及令牌状态表，规格为256*64维护:由CPU初始化令牌和模板选择，逻辑维护令牌数，刷新周期125US。
QSCT Table Specification 表格名称
QSCT Table 起始地址
N/A 地址范围
N/A 表项数目
SD5182H：256 每项宽度
32bits×2Word ECC/PARITY/NO
N/A 寻址方式
索引方式为{队列号},每行存一个队列的SHAPER配置及状态。基于队列的SHAPER只支持PIR相关配置及状态。
Table 5.8-30 QSCT Table表基本描述
QSCT Table Structure Bit Field Description
长字0
31:17
reserve
保留
16
qshp_mode
队列的SHAPE模式0：BPS，1：PPS
15:8
qshp_adj
Shaper的帧长修正因子（有符号数-128-127），软件应该配置修正因子的补码（CPU配置）。
7:6
reserve
保留
5:0
pir_shp_mnum
PIR SHAPER对应的模板选择。支持32个模板。0模板表示不受shaper限制（CPU配置）。
长字1
31:25
reserve
保留
24
pir_shp_borr_st
PIR SHAPER是否已经处于预借令牌状态（CPU初始化，逻辑更新）
SD5182HV100 Functional Specification Page 321 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
0:没有处于预借令牌状态
1:已经处于预借令牌状态
23:0
pir_tk_byte
PIR SHAPER令牌数，单位为Byte（CPU初始化，逻辑更新）
注：当速率动态切换时，软件需要延迟1ms左右再把该令牌桶pir_tk_byte和pir_shp_borr_st清零。
Table 5.8-31 shaper令牌统计表QSCT数据结构
5.8.13.16 SSCT Table
调度器输出的SHAPER配置及令牌状态表，规格为48*64，
维护:由CPU初始化令牌和模板选择，逻辑维护令牌数，刷新周期125US。
SSCT Table Specification 表格名称
SSCT Table 起始地址
N/A 地址范围
N/A 表项数目
SD5182H：48 每项宽度
32bits×2Word ECC/PARITY/NO
N/A 寻址方式
通用调度器输出的SHAPER，索引为{通用调度器编号},每行存一个通用调度器的SHAPER配置及状态。基于通用调度器的SHAPER只支持PIR相关配置及状态。
Table 5.8-32 SSCT Table表基本描述
SSCT Table Structure Bit Field Description
长字0
31:9
reserve
保留
8
Sshp_mode
通用调度器的SHAPE模式，0：BPS，1：PPS
7:6
reserve
保留
SD5182HV100 Functional Specification Page 322 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5:0
pir_shp_mnum
PIR SHAPER对应的模板选择。支持64个模板。0模板表示不受shaper限制（CPU配置）
长字1
31:25
reserve
保留
24
pir_shp_borr_st
PIR SHAPER是否已经处于预借令牌状态（CPU初始化，逻辑更新）
0:没有处于预借令牌状态
1:已经处于预借令牌状态
23:0
pir_tk_byte
PIR SHAPER令牌数，单位为Byte（CPU初始化，逻辑更新）
注：当速率动态切换时，软件需要延迟1ms左右再把该令牌桶pir_tk_byte和pir_shp_borr_st清零。
Table 5.8-33 shaper令牌统计表SSCT数据结构
5.8.13.17 PSCT Table
基于端口调度器的SHAPER配置及令牌状态表，规格为4*64维护:由CPU初始化模板选择，逻辑维护令牌数，刷新周期8US。
PSCT Table Specification 表格名称
PSCT Table 起始地址
N/A 地址范围
N/A 表项数目
4 每项宽度
32bits×2Word ECC/PARITY/NO
N/A 寻址方式
索引方式为端口调度器编号
Table 5.8-34 PSCT Table表基本描述
PSCT Table Structure Bit Field Description
SD5182HV100 Functional Specification Page 323 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
长字0
31:9
reserve
保留
8
Pshp_mode
端口调度器SHP模式，0：BPS，1：PPS
7:6
reserve
保留
5:0
pir_shp_mnum
PIR SHAPER对应的模板选择。支持48个模板。0模板表示不受shaper限制（CPU配置）
长字1
31:25
reserve
保留
24
pir_shp_borr_st
PIR SHAPER是否已经处于预借令牌状态（CPU初始化，逻辑更新）
0:没有处于预借令牌状态
1:已经处于预借令牌状态
23:0
pir_tk_byte
PIR SHAPER令牌数，单位为Byte（CPU初始化，逻辑更新）
注：当速率动态切换时，软件需要延迟1ms左右再把该令牌桶pir_tk_byte和pir_shp_borr_st清零。
Table 5.8-35 shaper令牌统计表PSCT数据结构
5.8.13.18 QWCT Table（SD5182H保留）
基于队列和优先级的WRED模板配置表，规格为(256*8)*5维护:由CPU初始化，逻辑查询。
SD5182HV100 Functional Specification Page 324 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
表格名称
QWCT Table 起始地址
N/A 地址范围
N/A 表项数目
2048 每项宽度
32bits ECC/PARITY/NO
PARITY 寻址方式
索引方式为{队列号，优先级}
Table 5.8-36 QWCT Table表基本描述
QWCT数据结构 Bit Field Description
长字0
31:5
reserve
保留
4:0
wred_ts_num
Queue对应的WRED模板号（CPU配置）
Table 5.8-37 QWCT Table表数据结构
5.8.13.19 BWT Table
表项规格为72*64。
维护:由CPU维护，逻辑只读。
BWT Table Specification 表格名称
BWT Table
注：带宽配置表，仅用在5182的SmartQos共享带宽特性,仅调度器0~7支持共享带宽特性，且使用该特性时，仅可以使用调度器的0~7个输入端。 起始地址
N/A 地址范围
N/A 表项数目
8*8 +8 = 72 每项宽度
32bits×2Word
SD5182HV100 Functional Specification Page 325 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
ECC/PARITY/NO
N/A 寻址方式
保证带宽：索引方式为{调度器编号，调度器输入端编号}；
共享带宽：64+调度器编号。
注：仅支持0~7号调度器。
Table 5.8-38 BWT Table表基本描述
BWT Table Structure Bit Field Description
长字0
31:25
reserve
保留
24
bw_ctrl_en
0:关闭，1：打开
注意：使用共享带宽调度时需要配置成1。
23:20
reserve
保留
19:0
XIR
刷新周期默认为125US。
BPS模式下：
调度器的shape配置，单位为16Kbps。
支持的速率范围为0～10Gbps。
例如带宽1.6Mbps，XIR=1.6Mbps/16Kbps=100。
PPS模式下：
队列与通用调度器的shape配置，单位取决于 SHAPE_MODE_PPS寄存器的配置值。
配置为0：单位为1PPS
配置为1：单位为16PPS，
长字1
31:24
reserve
保留
23:0
XBS
1：支持的突发大小，单位为1byte，支持的突发范围为0~16Mbyte。建议配置值为：
SD5182HV100 Functional Specification Page 326 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
XBS0 > 2*MTU（最大包长）;
XBS1 > xir*16k*125US（当前的刷新时间）/8(byte);
取XBS0和XBS1中的最大的一个配置对应SHAPE模板的XBS。
Table 5.8-39 调度器带宽配置表BWT 数据结构
5.8.13.20 STK Table
调度器带宽配置及令牌状态表，规格为72*64，
维护:由CPU初始化令牌和模板选择，逻辑维护令牌数，刷新周期125US。
STK Table Specification 表格名称
STK Table
注：令牌状态表，仅用在5182的SmartQos共享带宽特性
不支持动态配置。 起始地址
N/A 地址范围
N/A 表项数目
8*8+8 = 136 每项宽度
32bits×2Word ECC/PARITY/NO
N/A 寻址方式
保证带宽：索引方式为{调度器编号，调度器输入端编号}；
共享带宽：64+调度器编号。
注：仅支持0~7号调度器。
Table 5.8-40 STK Table表基本描述
STK Table Structure Bit Field Description
长字0
SD5182HV100 Functional Specification Page 327 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
31:17
reserve
保留
16
bw_mode
队列的SHAPE模式0：BPS，1：PPS
15:0
reserve
保留
长字1
31:25
reserve
保留
24
pir_bw_borr_st
是否已经处于预借令牌状态（CPU初始化，逻辑更新）
0:没有处于预借令牌状态
1:已经处于预借令牌状态
23:0
pir_bw_tk_byte
令牌数，单位为Byte（CPU初始化，逻辑更新）
注：当速率动态切换时，软件需要延迟1ms左右再把该令牌桶pir_bw_tk_byte和pir_bw_borr_st清零。
Table 5.8-41 带宽令牌统计表STK 数据结构
5.8.13.21 FST Table
业务流统计表，规格为512*192，
维护:CPU可访问，逻辑维护。
FST Table Specification 表格名称
业务流统计表。 起始地址
N/A 地址范围
N/A 表项数目
512 每项宽度
32bit*6WORD ECC/PARITY/NO
N/A 寻址方式
索引方式为{NP 流IDX}；PSA给EQM 4个统计索引，前2个索引统计到表项0~255；后两个索引统计到表项256~511。
Table 5.8-42 FST Table表基本描述
SD5182HV100 Functional Specification Page 328 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
FST Table Structure Bit Field Description
长字0
31:0
eq_pkt_cnt
入队业务流报文个数统计
长字1
31:0
eq_byte_cnt
入队业务流报文字节数统计（低32bit）
长字2
31:16
reserved
保留
15:0
eq_byte_cnt
入队业务流报文字节数统计
长字3
31:0
drop_pkt_cnt
丢弃业务流报文个数统计
长字4
31:0
drop_byte_cnt
丢弃业务流报文字节数统计（低32bit）
长字5
31:17
reserved
保留
16
flow_vld
表项统计条目有效位（软件使用，逻辑保持）
15:0
drop_byte_cnt
丢弃业务流报文字节数统计
Table 5.8-43 业务流统计表FST 数据结构
5.8.13.22 QLK Table
队列链表状态表项规格为256x64
维护:由逻辑维护，CPU只读。
QLINK Table Specification 表格名称
QLS Table 起始地址
N/A 地址范围
N/A 表项数目
SD5182H：256 每项宽度
×2Word
SD5182HV100 Functional Specification Page 329 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
ECC/PARITY
N/A 寻址方式
索引方式为实体队列号
Table 5.8-44 QLINK Table表基本描述
QLK Table Structure Bit Field Description
长字0
31:16
q_head
队列头指针
15:0
q_tail
队列尾指针
长字1
31:25
reserverd
保留
24:16
q_head_len
最高1bit，标记报文是单播/组播报文；
对于单播报文，用剩余的8bit，表示报文长度，单位是16Byte，所以最大可以标记4Kbyte（16个Block），可以最大化发挥DDR效率；
对于组播报文，用3bit表示Head长度，5bit表示Body长度，单位是32Byte，最大可以标记（256+1K）Byte，即5个Blcok。
15:14
reserverd
保留
13:0
q_head_depth
当前需调度出队的包长度
SD5182HV100 Functional Specification Page 330 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.9 EGRESS PORT SCHEDULER (EPS)
出端口调度提供外接各端口的数据输出调度功能，其中xPON端口基于tcont/llid完成调度，其他端口基于物理端口进行调度。
5.9.1 Main Feature
 使用29个FD_FIFO对EQM发来的FD进行缓存，分别对应1个xPON的16个TCONT/LLID 逻辑通道、1个PRBS端口、4个PIE端口、1个WOE端口、6个GE端口，1个二次入队的环回端口。
 支持PIE的4个虚拟端口的8个通道ID的映射。
 PIE接口支持基于8个通道的反压，逻辑端口之间进行整帧切换发送。若多个通道映射到同一个逻辑端口，则一个通道的反压会影响到该逻辑端口其他通道的发送。
 支持WOE的1个虚拟端口。
 支持对29个FD_FIFO的轮询和调度。
 支持不同报文的IFB、EFB混合转发。
 支持根据前级模块指示，判断 IFB或EFB中 HEAD和BODY数据是分离放置或合并放置。
 支持EFB cell大小为512/1024Byte可配置。
 支持输出基于帧的地址回收信息给FAM模块实现缓存回收，同时反馈源端口给FAM用于计算基于源端口的反压。
 支持基于FD_FIFO的反压信号给EQM，各个端口单独配置水线。
 支持动态调频功能。
 支持xPON低功耗：根据PON口的入队、出队进行队列内报文统计，当PON口队列无报文的时间超过配置的阈值后进入低功耗；处于低功耗时，当EQM入队报文超过配置的阈值时退出低功耗。
 支持GPON、10G GPON模式下FCS计算，支持FCS 插错。
 支持WAN口统计：支持全局15个基于PORT+VLAN+MAC配置的报文统计，每个统计项包括单播报文、组播报文、广播报文，3项统计，每项统计支持报文个数统计和字节数统计。
 支持jumbo帧（包长少于或等于9600Byte的报文）。
 支持1731报文的统计和编辑。
 支持1588报文标识透传。
SD5182HV100 Functional Specification Page 331 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.9.2 Terminology
The following terms have special meanings in this section.
Term Description
EPS Egress port schedule
IFB Internal Frame Buffer
EFB External Frame Buffer
MEMP Memory Pool
FAM Free Address Manager
DMC DDR Memory Controller
Table 5.9-1 EPS Terminology
5.9.3 EPS Overview
5.9.3.1 Introduction
EPS_
Load
eps_pon xPON mac
6*16
128
64
64
EPS_
SEND
128 128
EQM
EFB(DMC)
FD
128
Read
FC
2*PIE
EPS
Tx
Buf
(121K
B)
IFB
RRBS
FAM
rls
query
128
Read
6*GE
NNI_GE
16
Figure 5.9-1 EPS Overview
EPS 根据出端口状态和EQM 调度出的帧数据描述符（FD），向EFB 或IFB 发出报文读
命令。在读出报文后，释放相应cell 的地址和组播ID。读出的数据缓存到TX BUF 内，
在端口没有出现反压的情况下，分别调度出缓存，发送到相应的物理端口。EPS 模块主要
由三部分构成：
 EPS LOAD 负责管理各个通道的FD_FIFO、IFB 和EFB 数据的读取、帧内链表的查询
和帧地址的释放。
 Tx Buffer 用于每个逻辑通道缓存各自需要发送的数据。
SD5182HV100 Functional Specification Page 332 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 EPS SEND负责对各端口数据进行RR轮询和位宽转换，如果是xGPON模式下还需要进行FCS计算；最后将数据发送给各端口。
EPS LOAD模块有29个FD_FIFO，缓存EQM发来的FD信息，分别对应1个xPON的16个TCONT/LLID 逻辑通道、1个PRBS端口、5个PIE端口、6个GE端口，1个二次入队的环回端口。
TX_BUF模块用于缓存输出接口对应的数 据，缓存大小分别是：
 1个TCONT对应6KB，共16个TCONT；
 1个GE对应3KB，共5个GE口；
 1个2.5GE对应3KB，共1个2.5GE口；
 1个PIE对应1KB，共4个虚拟端口；
 1个WOE对应3KB，共1个虚拟端口；
 1个PRBS对应2KB，共1个PRBS口。
总缓存是：16*6k+6*3k+4*1k+3k+2k=123k。
注：如果XPON需要高低优先级队列，TCONT/LLID个数都要再减半。
TCONT缓存的96KByte空间可通过TX_BUF反压水线灵活配置，支持32tcont时，反压水线配置为3K；支持8tcont时，反压水线配置为12K；以此类推，个数只支持2的N次方。
5.9.4 PIE_CHANNEL MAP
EPS在PIE端口支持8个逻辑通道，对应PIE的8个接收队列。PIE的8个队列可以配置成最多4个虚拟端口，每个端口可支持多个优先级。EQM送出的PIE端口报文需要在EPS映射到逻辑通道；
EPS支持16条规则匹配映射到PIE的8个队列，实现使用寄存器配置方式；具体内容如下：
规则条目：16
匹配内容：igr[31:0](bitmap)+rxhash[1:0]+pie_ech[1:0]+pie_sq[3:0]+gro_id[3:0]。
igr为源端口，rxhash为五元组哈希值，pie_ech为pie的虚拟端口号，pie_sq为pie的优先级，gro_id为GRO重组报文流ID。
匹配规则：igr固定匹配，其它4项可选匹配，其中gro_id[3:0]还需要前级模块的gro_id_en使能匹配域，若某条规则中gro_id需要参与匹配，即寄存器中gro_id_vld为1，但是gro_id_en无效，则本条规则匹配失败。gro_id_en无效表示报文没有gro_id[3:0]字段。
SD5182HV100 Functional Specification Page 333 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
igr是bitmap的形式，可以同时配多个bit有效，只要报文的igr[4:0]字段转换成bitmap后与其中1bit对应上，则igr域匹配成功。
匹配结果：所有规则遍历匹配，同时命中多条规则，取匹配优先级最高的作为命中结果；若命中优先级相同，取序号最小的作为命中结果；没有命中规则时，取默认pie_chid。
规则属性：设置规则有效位，无效规则不参与匹配；
匹配动作：指定报文的pie_chid[2:0]；
其中igr+rxhash[1:0]+gro_id[3:0]+gro_id_en信息来自报文FD，pie_ech[1:0] + pie_sq[3:0]信息来自EQM FD。
成员名 范围 属性 描述
pie_rule_vld
31
RW
PIE队列映射规则有效位。
pie_chid
30:28
RW
PIE队列映射ID（匹配结果）。
reserved
27:24
RO
保留。
pie_rule_pri
23:20
RW
匹配优先级。
gro_id_vld
19
RW
GRO重组报文流ID有效位。
reserved
18:16
RO
保留。
gro_id
15:12
RW
GRO重组报文流ID。
rxhash_vld
11
RW
五元组RXHASH值有效位。
reserved
10
RO
保留。
rxhash
9:8
RW
五元组RXHASH值。
pie_ech_vld
7
RW
PIE虚拟端口有效位。
pie_ech
6:5
RW
PIE虚拟端口。
pie_sq_vld
4
RW
PIE报文优先级有效位。
pie_sq
3:0
RW
PIE报文优先级。
Table 5.9-2 PIE队列映射寄存器配置0
成员名 范围 属性 描述
igr
31:0
RW
报文源端口（bitmap）。
Table 5.9-3 PIE队列映射寄存器配置1
以下图为例，PIE被划分为2个虚拟端口，虚拟端口0占用队列4~7，虚拟端口1占用队列2~3。EPS可以根据EQM通用调度器的CHID和输入端编号把EQM队列一对一或多对一映射到PIE队列。
SD5182HV100 Functional Specification Page 334 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
接收队列7
接收队列0
接收队列1
接收队列6
接收队列5
接收队列4
接收队列3
接收队列2
Port
SCH
GSCH
GSCH
GSCH
EPS
MAP
软件
调度器
软件
调度器
PIE
Figure 5.9-2 PIE 逻辑通道映射
5.9.5 EPS to EQM Backpress Interface
EPS 给EQM 的反压信号，直接送给EQM 的端口调度器。
eps_eqm_UNI{0..5}_xoff UNI FD_FIFO Full 反压信号
eps_eqm_xPON{0..15}_xoff xPON 16 个通道的反压状态信号
eps_eqm_pie_xoff{0..3} PIE Port 4 个FD_FIFO Full 反压信号
eps_eqm_prbs_xoff PRBS FD_FIFO Full 反压信号
eps_eqm_woe_xoff WOE FD_FIFO Full 反压信号
eps_eqm_lp_xoff loopback FD_FIFO Full 反压信号
5.9.6 Second Loop Path
EPS 根据ECHID=loopback 来判断二次入队的报文。
EPS 接收到报文之后，从DDR 或MEMP 中读出FD 后将FD 环回给EQM 进行二次入队。
读回的报文FD 即可完成EQM 二次入队环回处理，二次入队报文不需要写入FD_FIFO 参
加调度发送处理。
5.9.7 IFB/EFB Cell
IFB CELL 大小为160Byte，切片大小也是160Byte，每次切片都需要查询NCAP；
SD5182HV100 Functional Specification Page 335 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
EFB CELL大小为512Byte、1024Byte可配置，切片大小为256Byte，当配置为512B时，每2次切片需要1次查询；配置为1024B时，每4次切片需要1次查询。
切片完成后，需要根据当前的切片信息发出读IFB/EFB的帧数据的命令。
当前切片完成后，如果报文的剩余长度不为0，即剩余的CELL个数不为0，则向FAM发出下一个CELL查询，查询命令是先写入一个FIFO，FIFO的读侧与FAM接口当查询空闲且FIFO非空时就会发起查询操作，这样做的目的是吸收FAM查询的抖动。因为IFB一个CELL的大小就是160Byte，每切完一次160Byte都要去查询下一缓存节点的地址，因此需要每次切片完成之后都要屏蔽当前的通道的调度，直至查询的下一个CELL地址返回。
5.9.8 1731 Packet Processing
5.9.8.1 1731 Packet Statistics
1731报文的统计表位宽为32bit，共支持256个统计项，对于统计有效标识为高电平的统计项，根据ext_fd中相应的统计索引作为地址，将统计表中的表项内容读出，加1后再写回该表项中，完成一次统计。一个报文可能会有多个统计项同时有效，需要依次进行统计。1731报文最多只有3个统计索引和1个编辑索引，在3个统计索引和1个编辑索引同时有效的情况下，共需四读三写7拍即可完成一个报文的统计，因此1731统计表选用一片单口RAM实现。
5.9.8.2 1731 Packet Edit
对于ext_fd中采样有效标识为高电平的报文，需要进行报文编辑，将ext_fd中的采样索引作为地址，读出1731统计表中相应表项的内容，从报文的指定位置开始，用前面读出表项内容的32bit数据对报文进行改写。指定的改写位置从DMAC开始计算，偏移量为ext_fd中的LM采样编辑位置（lm_edit_offset）。
这里从1731统计表中读出的统计值是该报文被统计之前的值。
对于1731统计表，只能进行CPU写清零，没有其他清零方式；统计满32bit后翻转，不饱和。
5.9.9 Error Handling
 超短包丢弃；丢包不释放缓存。
 FD ECC校验错误报文丢弃，不释放缓存。
 出端口错误报文丢弃，可配置是否释放缓存。
SD5182HV100 Functional Specification Page 336 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.9.10 Performance
EPS 切片调度最快8拍调度出一个160Byte数据块，但由于EPS和缓存的接口是128bit，EPS Merge模块需要15拍才能读完一个160Byte的数据块，则一般情况下，调度器会受到MERGE的反压，实际的调度是15拍调度一个160Byte的数据块。则EPS的内部处理带宽为：
250MHz： (160Byte * 8) ÷15* 250Mhz = 21.3Gbps
所有端口并发线速4GE(4G)+10GEPON(10G)+RGMII(1G)+1PIE(3G)=18Gbps。
如果频率是250MHz，性能可以满足带宽需求。
5.9.11 Power Management
5.9.11.1 Dynamic Frequency modulation
EPS与EQM配合完成各端口待发送报文数的统计，实现动态调频功能。需要做以下端口或逻辑通道的报文统计：
 GE按端口统计；
 PIE端口按端口统计；
 PRBS端口按端口统计；
 xPON按逻辑通道统计；
 WOE端口按端口统计。
EPS累加有待发送报文端口的权重，与配置的三级阈值比较，送出比较结果给CRG，CRG根据结果动态调整工作频率。
5.9.11.2 PON Low Power
EPS根据PON口的入队、出队进行队列内报文统计，当PON口队列无报文的时间超过配置的阈值后进入低功耗（IPS和EPS分别提供进入低功耗中断，当两者都有中断时才进入低功耗）；处于低功耗时，当EQM入队报文超过配置的阈值时退出低功耗。
 进入低功耗检测
检测条件
当进入低功耗检测使能时，逻辑统计EPS模块PON口队列（EQM入队加1、EPS输出减1）为空的时间，当无报文的时间达到配置阈值，则报进入低功耗中断；
阈值配置
PON_ENLP_TH，单位1us，默认值1s。
SD5182HV100 Functional Specification Page 337 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
EN_LP_ENABLE，进入低功耗检测使能，默认关闭硬件逻辑的进入低功耗检测，由软件自行检测。
 退出低功耗检测
检测条件
软件配置退出低功耗检测使能，逻辑根据配置开始两种模式的退出检测，维护两个计数器：
1）EPS每收到一个PON口报文，计数加1（最大值饱和），每发送一个报文减1（最小为0）；
2）EPS每收到一个PON口报文，计数加1（最大值饱和），每到一个周期则减固定的令牌（最小值为0）；
只要有一个计数器大于等于各自的配置阈值时，则EPS上报退出低功耗中断；同时记录2-bit的触发状态，供软件查询是哪种检测方式触发了退出低功耗中断。
上报中断之后计数器继续加减，软件清除退出低功耗检测使能ex_lp_enable后，计数器清零，在配置使能ex_lp_enable为1时，开始下一次计数检测。
配置
PON_EXLP_TH，报文个数。 bits 成员名称 复位值 成员说明
31:6
reserved
0
保留位
5
ex_lp_credit_st
0
减令牌的方式触发退出低功耗状态
4
ex_lp_pkt_st
0
减报文的方式触发退出低功耗状态
3
ex_lp_credit_mode
0
退出低功耗检测模式：减令牌方式使能
2
ex_lp_pkt_mode
1
退出低功耗检测模式：减报文方式使能
1
ex_lp_enable
0
退出低功耗检测使能配置
0
en_lp_enable
0
进入低功耗检测使能配置
Table 5.9-4 退出低功耗检测使能以及退出检测模式和状态
bits 成员名称 复位值 成员说明
31:24
ex_lp_credit
0
退出低功耗每周期所减的令牌，默认值0
23:0
ex_lp_period
0xF4240
退出低功耗减令牌的周期，单位是us，默认值1s
Table 5.9-5 定期减令牌的配置
SD5182HV100 Functional Specification Page 338 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
bits 成员名称 复位值 成员说明
63:48
pon_flux_th2
0
令牌模式有流量的阈值
47:32
pon_lp_off_th2
0
令牌模式退出低功耗的阈值
31:16
pon_flux_th
0
报文模式有流量的阈值
15:0
pon_lp_off_th
0
报文模式退出低功耗的阈值
Table 5.9-6 两套退出低功耗阈值和有流量的阈值配置
 有无流量状态检测
检测条件
统计PON口队列中的报文数目，当报文数目达到配置阈值时，则报有流量状态；当报进入低功耗中断时，则报无流量状态。
跟退出低功耗检测类似，逻辑提供两种有无流量状态检测（报文模式和令牌模式）和两个流量状态。
当逻辑检测到进入低功耗时，计数清零；
当软件配置退出低功耗检测使能时，计数清零。
5.9.12 GPON FCS Calculation
EPS支持GPON/10GGPON模式下ETH 帧FCS的计算，在Txbuf的出口一边发送数据一边计算FCS，在发送到帧尾时填入32bit的FCS值后发送给EPS_PON。
5.9.13 WAN PORT Statistics
使用PORT(5bit)+VLAN(14bit)+SMAC (49bit)共15组配置寄存器，匹配后进行统计；EPS命中两个配置项后，可以同时进行两次统计。VLAN，SMAC可单独控制匹配使能，VLAN可匹配Untag报文。
每组统计的内容如下，每项统计位宽为84bit，包括报文字节和个数统计。统计表项深度为8*4=32。位宽为84bit。查表索引为｛配置索引，成员索引｝。字节统计时包括报文的CRC长度。 成员索引 统计项 描述
0
uc_cnt
单播MAC报文，包括个数和字节数
SD5182HV100 Functional Specification Page 339 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
1
mc_cnt
组播MAC报文，包括个数和字节数
2
bc_cnt
广播MAC报文，包括个数和字节数
3
RSV
保留
Table 5.9-7 报文类型统计表
可配置PIE视频诊断报文不做WAN口统计；
ETH端口1588报文不做WAN口统计；
PRBS端口的环回报文不做WAN口统计；
PIE端口1588报文不做WAN口统计；
二次环回报文不做WAN口统计。
WAN口统计表 成员名 范围 属性 描述
frame_cnt_h
83:80
RW
报文个数统计，高4bit,即frame_cnt[35:32]。
byte_cnt
79:32
RW
报文字节数统计。
frame_cnt
31:0
RW
报文个数统计。
Table 5.9-8 WAN口统计表
5.9.14 DFx Features
 统计
WAN0~14统计匹配SMAC寄存器；
基于帧 长的报文统计；
毛刺包统计；
错误出端口报文统计；
RAM失效统计；
EPS出口PON0~15报文统计；
EPS出口PIE0~3报文统计；
EPS出口PIE0~7报文统计；
EPS出口WOE报文统计；
EPS出口PRBS报文统计；
EPS出口ETH0~5报文统计；
基于TraceCounter的3种报文个数统计。
SD5182HV100 Functional Specification Page 340 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 DEUBG
PON口流量状态寄存器；
PON低功耗置位历史状态寄存器；
PON低功耗退出触发状态寄存器；
PON口减令牌方式流量状态寄存器；
DMC接口DEBUG信号。
 中断寄存器
EPS中断寄存器；
EPS中断掩码寄存器；
EPS中断强制置位寄存器。
5.9.15 TABLE Features
EPS入口统计表；
WAN出口统计表；
LM统计表。
SD5182HV100 Functional Specification Page 341 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.10 EPS_PON
EPS_PON接收EPS送过来的上行数据，经过异步转换和接口适配根据10G GPON/GPON/10G EPON/EPON模式把数据发给NGMAC/GMAC/XGEMAC，并进行dbru/report的带宽计算。
5.10.1 Main Features
EPS_PON模块支持的主要特性如下：
 5182H支持GPON/xGPON上行16个TCONT，5182T支持xGPON上行32个TCONT；
 支持10G EPON对称模式上行16个单播LLID，10G EPON非对称模式2.5G/1G模式上行16个单播LLID，EPON上行8个单播LLID。
 支持16个T-CONT的DBRu或者16个LLID的Report计算，可查询配置Report/Dbru。Report/Dbru写操作进行单独配置保护；支持计算的IPG可配置，支持计算溢出告警。
 支持平均帧长计算，可以配置是否进行平均帧长计算。
 支持基于通道进行使能的Flush，支持对flush丢弃的报文进行分通道统计。
 支持TCONT/LLID最大个数减半的优先级抢占模式，比如支持10G EPON 8个LLID优先级抢占模式。
 支持TX_BUFFER内部FIFO发送水线门限可配置；
 支持多模共享的TX_BUF_PON，并每从TX_BUF_PON的FIFO读出1个报文，都要向EPS反馈一个减信号，用于EPS进行PON低功耗统计。
 支持TX_BUF_PON的FIFO通道数可配，支持32/16/8/4个通道的配置。
5.10.2 Terminology
The following terms have specific meanings in this section of the document.
Term Description
EPS
Egress Port Schedule
PON
Passive Optical Network
GPON
Gigabit Passive Optical Network
SD5182HV100 Functional Specification Page 342 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Term Description
EPON Ethernet Passive Optical Network
Table 5.10-1 EPS_PON Terminology
5.10.3 EPS_PON Overview
5.10.3.1 PON TX_BUF
EPS_PON 需要维护8KB 的TX_BUF，默认按照32 通道*256byte 计算，支持4 种缓存
模式配置（32*256byte,16*512byte,8*1024,4*2048）。TX_BUF 由32 个可以配置模式的独
立FIFO 构成，所有FIFO 共享一块8KB 的TP_RAM。默认配置16 个通道支持5182H 的
16 个TCONT 和LLID 规格。
5.10.3.2 xPON DBRu/Report Calculate
EPS_PON 根据来自EQM 的增脉冲（报文长度）和EPS_PON 内部发送界面（向xPON
MAC 发送或者内部flush）的减脉冲（报文长度），来计算整个上行队列的帧数据发送到
线路上所需要的发送窗口大小。
 xEPON：
EPS_PON 按XGEMAC 请求的LLID，优先级，FEC 使能状态， 向XGEMAC 分别提供
Full Report 带宽。并且同时提供当前上行方向的平均帧长，XGEMAC 根据该平均帧长估
算上行方向的阈值Report。EPS_PON 提供给XGEMAC 的Full Report 值计算方式（伪码
），如下（单位为TQ）：
_ fe c _ c o s t ( _ , _ ) fe c _ c o s t ( _ , _ )
7
fe c _ c o s t ( , ) 1 6 2 0 1 0 [0 ] , ( [0 ,1] , [6 4 ,1 0 2 4 0 ] )
239
fu l l r p t fe c e n in c le n fe c e n d e c le n
le n
fe c le n fe c fe c le n le n fe c le n
 
  
         
 
 
 
其中公式中的20 = 8(premble) + 12(ipg，可配置)
1G 情况下最后实际上报的rpt 值为：
ceil(full_rpt/2)；
在2.5G 情况下最后实际上报的rpt 值为：
ceil(full_rpt/4)；
在10G 情况下最后实际上报的rpt 值为：
ceil(full_rpt/20)；
 xGPON：
SD5182HV100 Functional Specification Page 343 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
EPS_PON 按TCONT，向xGMAC 同时统计Scr=1 以及Scr=0 的DBru 值，EPS_PON 提供
给xGMAC 的DBru 值计算方式如下：
d b ru   in c _ len   d e c _ len
注：上述算式中的inc_len,dec_len 都包括FCS 和GEM Header（GEM Header 可配置，
GPON 5 字节，XGPON 8 字节）。
xGMAC Dbru 值，入队方向按帧刷新Dbru 值，出队方向按每16Cycles 或者T-CONT 切换
时刷新一次Dbru 值。
5.10.3.3 xPON Flush 功能
当xPON MAC 掉线时需要启动Flush 功能对上行缓存中待发送的数据进行抽取，以释放
这些数据占用的缓存。
xEPON 模式时，首先需要在EPS_PON 中启动一个或者多个LLID 的Flush，当Flush 启动
时，EPS_PON 会屏蔽对应LLID 的cur_vld/nxt_vld， EPS_PON 负责清空对应LLID 在
EPS_PON 中缓存的帧数据，并继续向EPS 抽取帧数据。
xGPON 模式时，在EPS_PON 中启动一个或者多个T-CONT Flush 即可，操作和EPON 模
式类似，EPS_PON 会通过接口输出给 xGMAC 每个TCONT 实时Flush 状态。
5.10.3.4 EPON 的高优先级抢占模式
使用XPON Bonding 模式减小高优先级的时延。实现思路如下：
利用EPS，EPS_PON 中两个通道分别承载xPON MAC 中的同一个LLID/T-CONT 的高优
先级报文和低优先级报文。
当xPON MAC 向EPS_PON 请求对应LLID/T-CONT 数据时，EPS_PON 优先发送高优先
级的报文。
只有当EPS,EPS_PON 中高优先级报文完整发送出去，且队列为空后，再发送低优先级的
报文。
在绑定模式时，xPON MAC 送给EPS_PON 的LLID Idex/T-CONT n，对应EPS_PON 内部
通道2n,2n+1。
SD5182HV100 Functional Specification Page 344 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.10.4 Table Structure
5.10.4.1 Report/DBRu Table
5.10.4.1.1 表格基本描述 表格名称
Report/DBRu Table 起始地址
0x0 地址范围
0~127 表项数目
128 每项宽度
96bits 寻址方式
EPON:{Pri,LLID Index};
GPON: T-CONT
Table 5.10-2 Report/DBRu Table基本描述
5.10.4.1.2 表项数据结构 Field Width Type Description Reset
reserved
95:78
RO
保留
0x0
avg_len
77:64
R/W
xEPON模式时平均帧长
0x40
reserved
63:60
RO
保留
0x0
full_rpt1
59:32
R/W
xEPON模式：FEC ON full report
xGPON模式：SCR=1 DBRU
0x0
reserved
31:28
RO
保留
0x0
full_rpt0
27:0
R/W
xEPON模式：FEC OFF full report
xGPON模式：SCR=0 DBRU
0x0
Table 5.10-3 Report/DBRu Table数据结构
5.10.4.1.3 表项访问说明
间接表项配置。
SD5182HV100 Functional Specification Page 345 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Avg_len ：14比特位宽 仅xEPON时使用，基于LLID,优先级记录上行缓存中平均帧长，初始值64
Full_rpt1：28比特位宽，xEPON模式时该域表征FEC ON的Full Report，xGPON模式时该域表征SCR=1时的DBRU，初始值为0。Full_rpt0：28比特位宽，xEPON情形时该域表征FEC OFF的Full Report，xGPON模式时该域表征SCR=0时的DBRU，初始值为0。表项大小：逻辑表项大小128*70bit(xEPON：16LLID*8PRI xGPON 32TCONT)
表性属性：默认情形下，该表项为只读
其他说明：软件可以通过配置CTRL_REG0.rpt_wr_en，获得该表项的写权限。
软件可以通过配置CTRL_REG0.avg_en，暂停逻辑自动更新平均帧长（仅用于xEPON模式）
5.10.5 Initialization
Report/DBRu表，逻辑会把平均包长初始化成64，其它域为0。
5.10.6 Capacity
Report/DBRu表深度为128，最大支持16个LLID+8个Pri的Report上报。
5.10.7 Performance
与EPS接口位宽128bit，DP时钟250MHZ;
物理带宽128*250MHZ = 32Gbps，可以满足上行最大10Gbps的业务带宽要求。
SD5182HV100 Functional Specification Page 346 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.10.1 Error Handling
TBD
5.10.2 DFx Features
TBD
5.11 PSEUDO-RANDOM BINARY SEQUENCE (PRBS)
PRBS主要用于装备测试、单向吞吐量测试和双向吞吐量测试。支持RFC2544报文收发。
主要特性如下：
 PRBS模块根据软件配置选择多包连续校验或单包内部校验模式；
 根据软件配置将PRBS数据流封装成以太报文传给IPS模块；
 接收EPS模块数据，剥离ETH头；
 对接收到的PRBS的数据进行校验，统计错误bit数；
 统计发包数与收包数；
 外环回功能，将EPS送过来的数据流经由FIFO传送给IPS；
 支持RFC2544吞吐量和丢包率测量报文的发送和接收；
5.11.1 Main Features
 支持两种阶数的PRBS数据产生和校验：
 PRBS-23；
 PRBS-31。
 支持将PRBS数据流封装成以太报文发送：
 支持最多8通道发送报文；
 支持发送报文的以太报文头可配置；
 支持发包插错；
 支持两种发包模式：单次发包和连续发包；
 单次发包模式下，支持发包完成上报中断。
 支持将接收到的以太报文，剥除以太报文头后，对净荷进行PRBS校验：
 支持最多8通道接收报文；
SD5182HV100 Functional Specification Page 347 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 支持接收报文两种校验模式：单包内部校验和多包连续校验；
 支持收包错误上报中断。
 支持通道的区分：发送方向支持使用不同的SMAC/DMAC来区分通道，通道的SMAC/DMAC由逻辑自动生成，基本原则方法是SMAC/DMAC+子通道号；接收方向支持通过入端口配置映射到不同的通道上；
 支持对接收报文PRBS校验错误比特数进行统计；
 支持单向TM测试和双向DM测试，支持是否关注报文优先级可配置；
 支持报文的伪装发送，报文的FCB可配置，包括端口信息、CPU指定转发等；
 支持报文外环回功能，将EPS送过来的外环回报文直接传送给IPS；
 支持RFC2544吞吐量和丢包率测量报文的发送和接收；
 支持整个RFC2544报文头完全可配置，报文头最大长度64字节；
 支持RFC2544报文BODY长度可配置，报文头+BODY最大2047字节，支持BODY内容可配置为PRBS码流和固定16-bit的码型；
 支持RFC2544轮流发送不同长度的BODY，最大8种长度，用于模拟随机报文长度；
 支持Burst和Continue两种发包模式；
 支持RFC2544报文接收、校验和统计，支持基于报文中的序列号（SEQ-ID）进行丢包、乱序等判断；
 支持RFC2544反射报文的接收，并将反射报文环回发送给IPS模块；
 支持对发送报文个数和接收报文个数进行统计；
 支持Jumbo帧的发送和接收；
 支持Untag报文的发送和接收。
5.11.2 Terminology
The following terms have specific meanings in this section of the document.
SD5182HV100 Functional Specification Page 348 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Term Description
PRBS Pseudo-Random Binary Sequence
CRC Cyclic Redundancy Codes
IPS Ingress Port Schedule
EPS Egress Queue Management
Table 5.11-1 PRBS Terminology
5.11.3 PRBS Overview
5.11.3.1 PRBS 包数据产生及发送处理
prbs
dmac
smac
eth_type
Add_
def_tag
Add_snap
Add_tst
CRC
TLV
head
Add_tag
Figure 5.11-1 LMEM High-Level Diagram
PRBS 产生PRBS 包数据给IPS，PRBS 包数据包括软件可配置的帧头及内部PRBS 发生器
产生的PRBS 码流。
 支持软件配置整个报文头信息，配置长度最大64B；
 软件可配置DMAC、SMAC、ETH_TYPE 域，默认添加一层TAG；
 支持再添加一层TAG 的封装；
 支持SNAP 封装；
 支持TST 报文头的添加；TST 帧中的pattern 域中pattern[0]为0，则不带CRC-
32 校验，pattern[0]为1，则带CRC-32 校验，需要在PRBS 码流最后添加CRC-
32 校验码；pattern[1]为0，则PRBS 码流全零，pattern[1]为0，则PRBS 码流为
PRBS 发生器产生的数据流；TST 帧封装需要在PRBS 包的最后添加tst_end_tlv
域。
SD5182HV100 Functional Specification Page 349 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 支持软件配置发送不同的测试报文类型，RFC2544类型、普通PRBS测试类型。
PRBS码流发生器控制：
 软件可配置PRBS发包使能，PRBS种子，PRBS发包长度；
 支持8个通道发包，可配置每个通道的发包个数；可配置发包模式为单次发包或连续发包，单次发包，所有通道发包个数完成后停止发包；连续发包，连续循环发送每个通道配置的发包个数；
 可配置PRBS码流产生格式为PRBS-23或PRBS-31；
 可配置每次发包的PRBS净荷是否相同，每次发包时重新加载PRBS种子，使产生的PRBS净荷相同；连续截取由同一个PRBS种子产生的prbs码流作为每次发包的净荷，使PRBS净荷不相同，这种模式用于多包连续校验；
 PRBS码流中插入误码可配置，每次发包只插入一次；
 单次发包完成后上报中断；
支持发送报文的FCB可配置，FCB包括：
igr[4:0]： 入端口
egress [4:0]：指定转发端口
xid[3:0]： CPU指定转发模板
cpu_act[1:0]： CPU指定转发
line_info [19:0]：线路信息
pq[2:0]： 报文队列优先级
5.11.3.2 PRBS包接收及校验处理
从EPS接收PRBS包，根据控制信息剥离包头，将PRBS Code 送入PRBS接收器进行PRBS校验。如果是TST帧且带CRC-32校验码，则同时进行CRC-32校验；
支持多包连续校验和单包内部校验：
多包连续校验，PRBS源产生一条完整的PRBS流，每条流发出去的包根据payload长度配置，顺序截取相应字节PRBS码进行ETH封装，并发出去（支持通道间的连续校验）。此模式要求校验包与包之间的连续性；每条流从通道0发至最后一个通道，再返回通道0开始轮流发送；支持8个通道连续发包，每个通道发包个数可配（至少发一个包）。
单包内部校验，PRBS源产生一条完整的PRBS流，每条流发出去的包根据payload长度配置，随机截取相应字节PRBS码进行ETH封装，并发出去（实际上每次发包时都重新加载PRBS种子产生PRBS码流）。此模式不需要校验包与包之间的连续性；可以根据发包使能配置相应通道发包，只支持8个通道任意通道组合发包。
可配置PRBS多包校验模式下失步统计范围（寄存器prbs_sync_range）；
SD5182HV100 Functional Specification Page 350 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
可配置PRBS多包校验模式下失步统计错误bit数范围（寄存器prbs_err_range），即若在每个PRBS码流的prbs_sync_range个字节范围内，出现prbs_err_range个bit错误，则PRBS码流失步。若没有出现prbs_err_range个bit错误，则PRBS码流同步；
同步失步状态可查询。
5.11.3.3 单向和双向吞吐量测试
支持TEST_MODE可配置，当TEST_MODE=0时，为装备测试场景；
当TEST_MODE=1时，为单向吞吐量测试场景，PRBS发送TST帧。若配置不关注优先级，通路处理同装备测试场景；关注优先级时，发送方向，将报文帧头外层TAG优先级替换为tm_up_pbit（软件配置）。接收方向，比较报文帧头外层TAG优先级是否为tm_dn_pbit（软件配置），如果不等，且配置不等时丢弃，则将报文丢弃。
当TEST_MODE=2时，为双向吞吐量测试场景，PRBS模块将EPS输入的报文环回给IPS；若配置不关注优先级，直接环回；关注优先级时，将优先级替换成tm_up_pbit（软件配置）。
5.11.3.4 RFC2544报文收发
RFC2544报文主要应用于网络节点之间的线路质量检测，评估线路性能及对业务的满足度。RFC2544按照测量种类分为四种：学习测量、时延测量、流量测量、丢包率测量。其中的学习测量和时延抖动测量由CPU通过PIE模块发送和接收。流量测量和丢包率测量由PRBS完成发送和接收，并进行报文数的统计。
PRBS内置RFC2544报文收发功能，RFC2544报文头格式固定如下，流量和丢包率测量时由CPU配置到PRBS模块中。报文body数据由软件指定为全0、全1、或者是PRBS码流，body的长度可配置。
CPU可配置的报文格式为：
Figure 5.11-2 RFC2544报文头数据格式
SD5182HV100 Functional Specification Page 351 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
ver IHL
flags
0 1 2 3 4 5 6 7
ETHTYPE=0x0800 TOS
Total Length Identification frag offset TTL Protocol=17
payload
FCS
source Port
Header checksum SIP DIP
DIP Destination Port Length
checksum
DMAC SMAC
SMAC
Figure 5.11-3 IPv4封装UDP报文格式
Name Description
DMAC 目的MAC 地址，CPU 配置
SMAC 原MAC 地址，CPU 配置
VLAN VLAN ID，CPU 配置
IP 报文IP 地址，由CPU 指定或配置
UDP 报文UDP 头，由CPU 配置
时延 2544 时延测量报文标识。此类型的CPU 通过PIE 下发和接收，通过报文内时戳信息，计算
报文在链路上的延时大小
学习 2544 学习报文标识。此类型的报文由CPU 通过PIE 下发和接收，通过学习建立测量链路
丢包 流量测量、丢包率测量报文标识，PRBS 进行2544 报文收发，并统计出收发包个数，此类
型报文不发送给CPU
TSTID 测量模式配置：多流同时收发时用到。暂时保留
测试例校验 测量报文正确性校验值。发送的时候，由软件指定好，接收的时候，根据tstid 获得CPU 配
置在PRBS 中的校验值，和报文中的此校验值进行比较，如果不相等，进行错误统计
xTimestamp 时间信息，分别填充32bit 的秒时间和32bit 的纳秒时间，由PE 模块进行刷新
SEQID 序列号；起始序列号由CPU 配置到PRBS 模块。发送时打上序号；接收侧进行乱序的识
别，吞吐量测量、丢包率测量时使用序号，学习报文不关心。时延测量时，发起端接收到
反射回来的时延报文时，需要用接收到的时戳信息替换此序列号。
RSVD 保留位，逻辑填全0
Table 5.11-2 RFC2544 Head Parameter Description
SD5182HV100 Functional Specification Page 352 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PRBS模块的RFC2544主要特性有：
 支持发包使能可配置，PRBS模块监测到发包使能为1时，开始按照既定的配置发送RFC2544报文，在发包使能为0时，停止RFC2544报文发送；
 支持收包使能可配置，在收包使能为1时，开始RFC2544的报文接收、比较和统计，在收包使能为0时，停止RFC2544报文的接收，并独立统计收包使能为0时丢弃的RFC2544报文个数；
 支持发包测试模式可配置，包括发包模式（Burst模式和Continuous模式）、发包间隔、发包周期、每周期发送报文个数、报文长度可配置；
 发包模式为Burst（突发）模式时，PRBS模块在配置的发包周期内，连续发送报文，发送报文个数由配置的每周期发送报文个数决定。在下一个发包周期开始时，再次连续发送到配置的报文个数为止。
 发包模式配置为Continuous（连续）模式时，PRBS模块每发送完一个报文后，固定等待一个配置的发包间隔，然后接着发送下一个报文，依次类推，直到CPU配置发包不使能。
 支持发包间隔可配置，在Continuous（连续）发包模式下有效，单位为1个时钟周期2.5ns，对应2个字节，位宽24-bit；
 支持发包周期和发包周期内的发包个数可配置，在Burst（突发）发包模式下有效，发包周期单位为ms，位宽24-bit；发包个数位宽24-bit；当配置的发包个数超过PRBS模块的最大发包能力时，以PRBS模块的最大发包个数为准；
 支持发送和接收的RFC2544报文头可配置，报文头长度可配置（最大64字节），报文头中的“时延”指示位偏移量由CPU配置。PRBS逻辑根据“时延”位置偏移量来获取TSTID、TSTID校验值和序列号等，对于吞吐量和丢包率测试报文，PRBS模块关注序列号，不关注时戳信息；
 支持RFC2544发送报文长度可配置：提供8个报文BODY长度和长度有效的配置寄存器，逻辑在发送报文时，根据长度域的有效指示，依次按指示的BODY长度封装报文进行发送（模拟长度随机）；BODY加报文头的总长度配置范围在60～2047字节之间；
 支持报文body数据类型可配置为全0、全1或PRBS码流；
 RFC2544报文头格式仅支持IPv4承载的UDP格式，软件在配置报文头时，因为BODY长度不唯一性，涉及到IPv4的“Total Length”、“Header Checksum”域和UDP的“Length”、“Checksum”这四个域的刷新，由软硬件配合完成：
 IPv4的Total Length和UDP的Length：软件配置为0，逻辑根据当前实际发送的报文长度，刷新这两个域；
SD5182HV100 Functional Specification Page 353 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 IPv4的Header Checksum：软件根据Total Length=0先计算一个完整的Checksum配置到报文头中，逻辑根据实际的Total Length，刷新IPv4的Checksum域；
 UDP的Checksum：软件配置为0，表示不做Checksum计算（UDP协议支持），逻辑不做操作。
 RFC2544报文在PRBS模块不进行CRC计算和校验，CRC由MAC完成；
 RFC2544报文的发送流量由软件根据配置的发包模式、发包间隔、发包周期、每周期发送报文个数、报文长度进行计算：在Burst模式下，由发包周期内所发报文的个数和长度计算；在Continuous模式下，PRBS模块的最大发包速率是每拍（2.5ns）发送2个字节，根据期望的发包速率和发包长度可推算出每个报文发送完毕之后的间隔；
假设配置的8个有效长度的报文长度分别为L0、L1、L2、L3、L4、L5、L6、L7，PRBS时钟周期为T ns。PRBS模块发送数据位宽为16bit，CPU配置发包速率为R，则R=(L0+L1+… +L7)*8 /(((L0+L1+…+L7)/2+8*GAP)*T)；
注1：根据上面公式，软件可以根据期望发布速率推算出发布间隔GAP；
注2：上述长度只包括报文头长度和BODY长度，CPU计算流量GAP时还需要考虑报文前导和后缀（CRC等）长度；
注3：PRBS模块发送接口的最小粒度是2字节，建议报文长度配置为偶数以获取精确的流量，否则每个报文长度存在1字节的正负偏差；
 最大测试流量为10Gbps，不支持同时配置多条流（tstid）进行测试；
 支持不带业务和带业务测试；
 支持RFC2544接收报文的TSTID校验：将接收报文中的TSTID和TSTID校验值与CPU配置的TSTID和TSTID校验值进行比较，两者均一致，则TSTID校验正确，否则，TSTID校验错误，进行错误统计；
 支持RFC2544接收报文的TSTID校验使能可配置，默认使能；
 支持RFC2544发送报文的TSTID域插入错误bit，插错bit可配置；
 支持RFC2544发送报文的序列号递增：每次启动RFC2544报文发送时，首个报文的序列号采用CPU配置的发送序列号，后续发送报文的序列号在前面一个报文序列号的基础上加1；
 支持RFC2544接收报文基于TSTID进行序列号检测：
正常情况下，当前接收的序列号RXcurr(seq) =上次接收的序列号RXlast(seq) + 1；
当RXcurr(seq) > RXlast(seq) + 1时，则表示有报文丢弃，报文丢弃个数累加RX curr(seq) – RXlast(seq) –1，且刷新RX last(seq) = RXcurr(seq)；
SD5182HV100 Functional Specification Page 354 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
当RXcurr(seq) < RXlast(seq) + 1时，则表示有报文乱序，给出乱序状态和中断，乱序统计加1，报文丢弃个数统计减1，且RX last(seq)保持不变；
注：序列号检测不考虑重传报文；首个接收报文须跟报文头配置的序列号相等。
 支持RFC2544报文发送个数统计和接收总个数统计；支持接收报文的TSTID校验错误统计、序列号丢弃的个数统计、序列号乱序的个数统计、接收使能期间的绿色、黄色报文个数统计。
 支持PRBS模块发送RFC2544报文至IPS模块时，CPU可配置：
 指定转发模板为“CPU发送DOWN方向2544报文”；
 伪装端口为2544测试端口；
 指定出端口为2544测试端口；
 指定LINE_INFO和PQ；
 支持PRBS模块作为RFC2544报文UP型端口的反射端将报文从EPS环回到IPS模块：
EPS模块输入的报文，如果指示为RFC2544反射返回报文，则将原始出端口作为报文的伪装入端口，并环回到IPS模块。
RFC2544反射报文的原始出端口由PRBS模块根据模式配置的伪装入端口决定，即PRBS发送时，FCB信息全部采用PRBS寄存器配置的相关信息。
5.11.3.5 外环回报文处理
对于EPS模块输入的报文，如果环回报文指示信号有效，则在接口出直接将报文环回输出到IPS模块，并进行环回报文个数统计。
首先从EPS输入的SOP前两拍数据中解析出INGRESS入端口和LINE_INFO信息，然后将环回指示、INGRESS入端口和LINE_INFO填入FCB，其它FCB信息采用PRBS模块配置的FCB相关信息，带外送给IPS模块。
对于报文LINE_INFO之后的数据，只做接收并转发，不做任何解析。
5.11.3.6 低功耗相关
PRBS模块没有大的RAM，没有RAM低功耗要求；
对于动态调频，由DP动态调频整体控制，PRBS端口的输入输出流量大小是DP动态调频的考量因素之一，分别在IPS模块和EPS模块控制。
对于PRBS装备测试，流量的大小通过发包间隔来配置，这跟时钟周期相关，因此测试时建议关闭DP动态调频功能。
SD5182HV100 Functional Specification Page 355 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
如果必须要在打开DP动态调频的情况下控制PRBS端口的流量，可以配置IPS模块中PRBS端口的CAR、并打开CAR的反压功能，通过IPS的CAR来实现PRBS端口的流量控制。
5.11.3.7 兼容性
跟SD5118V200芯片相比，SD5182H的PRBS模块删除了RFC2544的颜色统计和反射报文的环回功能，接口位宽从16-bit扩展到64-bit。
对SD5182H PRBS模块来说，一共有如下4种场景报文处理：
1. PRBS装备测试；
2. 单向吞吐量测试；
3. 双向吞吐量测试；
4. RFC2544吞吐量和丢包率测试；
5. 外环回报文处理。
对于前面4种测试场景，彼此是互斥的，不同时存在，但2、3、4种场景报文可能会跟外环回报文业务并存，这需要PRBS模块在发送报文时做好测试报文和外环回报文的仲裁反压保持处理。
5.11.4 Initialization
PRBS模块没有表现，无需初始化。
5.11.5 Capacity
无
5.11.6 Performance
PRBS模块接口数据位宽64-bit，SD5182H芯片DP的时钟频率是250MHz，理论上最大输入、输出带宽为64-bit*250MHz=16Gbps；SD5182T芯片DP时钟频率为400MHz时，PRBS模块最大输入、输出带宽为25.6Gbps，剔除少量的报文间隔等开销带宽，依然可以满足普通装备测试和吞吐量测试的需要。
SD5182HV100 Functional Specification Page 356 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.11.7 Error Handling
无
5.11.8 DFx Features
5.11.8.1 统计
统计每个通道发送的报文数；
统计每个通道接收的报文数；
统计每个通道的错包误码数；
统计TST帧seq_num错误数；
统计TST帧CRC校验错误数；
统计发送的RFC2544报文个数；
统计接收到的总的RFC2544报文个数；
统计RFC2544接收使能期间的RFC2544绿色、黄色报文个数；
统计RFC2544接收使能期间的RFC2544绿色、黄色报文字节数；
统计RFC2544接收使能期间的TSTID校验错误报文个数；
统计RFC2544接收使能期间的序列号丢弃的个数；
统计RFC2544接收使能期间的序列号乱序的个数；
统计接收到的RFC2544反射端环回的报文个数；
RFC2544的统计寄存器，报文个数统计位宽48-bit，字节数统计位宽64-bit；
统计外环回报文的个数；
5.12 PACKET INSERT AND EXTRACT (PIE)
Packet Insert and Extract （PIE）主要完成CPU接收（提取）包或者发送（插入）包的功能。CPU可以通过PIE向/从各个业务端口发送/接收包。
SD5182HV100 Functional Specification Page 357 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
IPS
EPS
CPUTX
CPURX
PIE_AXI_IF
clk_ahb
clk_ips
PIE
64
PIE_TXDCP_WRR
ECS
AXI
clk_eps
DIO
Figure 5.12-1 PIE Logical Block Diagram
The main features of PIE are:
OR 编号 DR 编号 FS 编号
衍生需求 DR.perf.01
FS.PIE.13
FS.PIE.15
OR.FUNC.04 DR.LSW.19
FS.PIE.01
FS.PIE.03
OR.FUNC.04 DR.LSW.22
FS.PIE.07
FS.PIE.08
FS.PIE.13
FS.PIE.14
FS.PIE.15
FS.PIE.16
OR.FUNC.02 DR.LSW.07 FS.PIE.18
 FS.PIE.01 支持2^n（n=0～3 为parameter 参数）个单次发包通道；
 FS.PIE.02 发包通道支持SP+WRR 调度，SP 调度时通道号等于优先级（逻辑通道号越
大，优先级越高）；
 FS.PIE.03 支持2^n（n=0～4 为parameter 参数）个收包通道；
 FS.PIE.04 发包支持电路级/cycle 级反压，单次发包支持基于通道的报文级反压；
 FS.PIE.05 收包支持按虚端口反压和丢弃可配置，默认丢弃；
 FS.PIE.06 收包支持all in one（所有包进入收包逻辑通道0）功能；
SD5182HV100 Functional Specification Page 358 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 FS.PIE.07发包支持中断上报门限可配，当发包中断门限配置为1时即为单次发包中断；
 FS.PIE.08收包支持4种中断模式：单次收包中断、有包中断、周期中断、多次收包中断；
 FS.PIE.09支持任意字节对齐的收发缓冲区，按Cacheline（32B）对齐方式访问DDR（Cacheline规格宏隔离）；
 FS.PIE.10支持AXI读接口流水（Outstanding）能力为8；
 FS.PIE.11支持净荷、描述符在DDR中存储的大/小端模式独立可配；
 FS.PIE.12支持丢弃错包功能；
 FS.PIE.13支持TSO，支持发送方向发送TCP分片报文，不支持IP/UDP分片；
 FS.PIE.14支持发送方向PKT_INFO大小随包指示，非分片报文支持64/128/192bits，分片报文支持64/128bits；
 FS.PIE.15支持LRO，支持接收方向通道TCP分片报文重组，不支持IP/UDP分片报文重组；
 FS.PIE.16支持接收方向PKT_INFO大小按通道可配置，报文支持64/128/192bits；
 FS.PIE.17支持基于接收/发送逻辑通道的报文统计；
 FS.PIE.19 PIE中断支持9个中断：发送与接收方向各4个，一个总中断，可独立与通道绑定。
 FS.PIE.19 PIE 支持周期发包功能，16个发包通道。
5.12.1 Terminology
The following terms have special meanings in this section. Term Description
IPS
Ingress Port Schedule
EPS
Egress Port Schedule
Tx/Rx DCP
Tx/Rx Descriptor
SD5182HV100 Functional Specification Page 359 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
FD
Frame Descriptor
MSS
Max Segment Size
TSO
TCP Segmentation Offload
LRO
Large Receive Offload
Table 5.12-1 PIE Terminology
5.12.2 Capacity
5.12.2.1 Table Spec
表项名称
宽度
深度
描述
Table 5.12-2 PIE表项规格
5.12.3 Performance
 参见SD5182HV100 PIE DS 收发性能章节。
5.12.4 Transmit Packet
CPU可发起一次单次发包，最小包长1Byte，最大包长10K Byte。
5.12.4.1 Tx Legacy Descriptor
5.12.4.1.1 Tx Legacy Descriptor Format 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0
0
H
DTYPE
INFO_EXT
DD
Rsvd
L
FRAG_LEN[15:0]
1
H
TX_BUF_PTR[31:0]
L
2
H
pkt_info[31:16]
L
pkt_info[15: 0]
3
H
pkt_info[63:48]
L
pkt_info[47:32]
Table 5.12-2 Tx Legacy Descriptor Format
SD5182HV100 Functional Specification Page 360 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.12.4.1.2 FRAG_LEN
指定发送报文长度，单位Byte，最大支持10KBytes。
5.12.4.1.3 INFO_EXT
Packet INFO Extend指示。
2’b00：PKT_INFO长度为64bit，不需要读DDR中的TX Info Extend Descriptor；
2’b01：PKT_INFO长度为128bit，需要读TX Info Extend Descriptor；
2’b10：PKT_INFO长度为192bit，需要读TX Info Extend Descriptor；
2’b11：保留。
INFO_EXT仅当描述符DTYPE指示sop=1时有效。
5.12.4.1.4 DD
Descriptor Done，描述符完成指示。
0：PIE回写描述符将DD域写成0x0；
1：软件写描述符完成。
5.12.4.1.5 DTYPE
Descriptor Type指示。
3’b011：Tx Legcy Descriptor，sop=1，eop=1。
3’b010：Tx Legcy Descriptor，sop=1，eop=0。
3’b000：Tx Legcy Descriptor，sop=0，eop=0。
3’b001：Tx Legcy Descriptor，sop=0，eop=1。
3’b111：Tx Extend Descriptor，sop=1，eop=1。
3’b110：Tx Extend Descriptor，sop=1，eop=0。
3’b100：Tx Extend Descriptor，sop=0，eop=0。
3’b101：Tx Extend Descriptor，sop=0，eop=1。
5.12.4.1.6 TX_BUF_PTR
发送报文数据存放在系统缓存中的绝对地址。
如下图所示，TX_BUF_PTR指向缓存中存放报文首字节。
要求RX_BUF_PTR以32B对齐；
SD5182HV100 Functional Specification Page 361 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
BUF_SIZE 由软件分配好，发送报文时，单个描述符的报文数据长度不超过单个描述符对
应的BUF_SIZE。
Buff_Addr=0
Buff_Addr=N
Buff_Addr=TX_BUF_PTR
BUF_SIZE
Figure 5.12-1 PIE TX_BUF_PTR Diagram
5.12.4.1.7 PKT_INFO
报文信息，该域由软件定义，PIE 对PKT_INFO 将不做任何操作，放在报文头之前发送给
IPS。
PKT_INFO 详细内容参见文档：\5182H\1.ChipKey\01.Architecture\1.5
AS\src\SD5182HV100 接口数据结构.xlsx 。
5.12.4.2 Tx Extend Descriptor
5.12.4.2.1 Tx Extend Descriptor Format
15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0
0
H DTYPE INFO_EXT SNAP IPv4 TCP HDRLEN[7:0]
L FRAG_LEN[15:0]
1
H
TX_BUF_PTR[31:0]
L
2
H TAG_SUM Rsvd MSS[11:0]
L L4PTR[7:0] L3PTR[7:0]
3
H PKT_LEN[15:0]
L Rsvd
SD5182HV100 Functional Specification Page 362 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.12.4.2.2 FRAG_LEN
当前描述符的报文长度，单位Byte，支持65535 Bytes。
5.12.4.2.3 INFO_EXT
Packet INFO Extend指示。
2’b00：PKT_INFO长度为64bit，需要读TX Info Extend Descriptor；
2’b01：PKT_INFO长度为128bit，需要读TX Info Extend Descriptor；
2’b10：保留；
2’b11：保留。
INFO_EXT仅当描述符DTYPE指示sop=1时有效。
5.12.4.2.4 DTYPE
Descriptor Type指示。
3’b011：Tx Legcy Descriptor，sop=1，eop=1。
3’b010：Tx Legcy Descriptor，sop=1，eop=0。
3’b000：Tx Legcy Descriptor，sop=0，eop=0。
3’b001：Tx Legcy Descriptor，sop=0，eop=1。
3’b111：Tx Extend Descriptor，sop=1，eop=1。
3’b110：Tx Extend Descriptor，sop=1，eop=0。
3’b100：Tx Extend Descriptor，sop=0，eop=0。
3’b101：Tx Extend Descriptor，sop=0，eop=1。
5.12.4.2.5 MSS
Max Segment Size，分片报文净荷长度，单位Byte。
MSS仅当DTYPE为Tx Extend Descriptor，sop=1时有效。
分片报文的长度为MSS+HRDLEN，最后一片分片报文将是实际净荷大小+HRDLEN。
MSS需要满足IP Header Length + TCP/UDP Header Length + MSS ≤ MTU
非最后一片的分片报文报文发送格式如下图所示：
SD5182HV100 Functional Specification Page 363 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Payload
PKT_INFO
PKT_INFO_EXT
(optional)
15 0
Header HRDLEN
MSS
5.12.4.2.6 HRDLEN
Header Length，每个分片报文的报文头长度，单位Byte。
HRDLEN 不大于SOP 描述符中的FRAG_LEN，即TSO 报文的报文头不能跨描述符。
HRDLEN 仅当DTYPE 为Tx Extend Descriptor，sop=1 时有效。
HRDLEN 包括2/3/4 层的报文头。
首分片报文描述符中的HRDLEN 如下图所示：
Buff_Addr=0
Buff_Addr=N
Buff_Addr=TX_BUF_PTR
BUF_SIZE
HRDLEN
PKT_LEN－HRDLEN
Header
SEG Payload
Figure 5.12-1 DTYPE SOP=1 HRDLEN Diagram
SD5182HV100 Functional Specification Page 364 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
非首分片报文描述符指向的数据缓存只有payload。
Buff_Addr=0
Buff_Addr=N
Buff_Addr=TX_BUF_PTR
BUF_SIZE
PKT_LEN
Header
SEG Payload
Figure 5.12-1 DTYPE SOP=0 Diagram
5.12.4.2.7 SNAP
指示当前报文为SNAP 报文。
0：Ethernet II；
1：SNAP；
5.12.4.2.8 IPv4
指示当前报文为IPv4/IPv6 承载。
0：IPv6；
1：IPv4；
5.12.4.2.9 TCP
指示当前报文为TCP/UDP。
0：UDP；（不支持UDP 报文进行TSO 分片）
1：TCP；
5.12.4.2.10 L3PTR
IP Header Pointer，单位Byte，最大支持255-Bytes。
指示IPv4/IPv6 报文头偏移字节数，首字节计数为0。
SD5182HV100 Functional Specification Page 365 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
以下面Ethernet II 封装IPv4 报文为例，二层报文头长度为14bytes，则IPv4 的报文头
L3PTR 为14。
Padding
payload
FCS
IHL TOS
Total Length Identification Flags TTL
LSB:0 1 2 3 4 5 6 MLB:7
Protocol
Header Checksum SIP DIP
Fragment Offset
DIP Options
DMAC SMAC
SMAC ETHTYPE=0x0800 Version
5.12.4.2.11 L4PTR
UDP/TCP header Pointer，单位Byte，最大支持255 Bytes。
指示UDP/TCP 报文头偏移字节数，首字节计数为0。
5.12.4.2.12 TAG_SUM
UDP/TCP 报文头中的TAG 层数。
5.12.4.2.13 PKT_LEN
UDP/TCP 报文总长度，包含Header 和Payload，单位Byte，最大支持65535 Bytes。
5.12.4.2.14 PKT_INFO
报文信息，该域由软件定义，PIE 对PKT_INFO 将不做任何操作，放在报文头之前发送给
IPS。
每个分片报文都会携带分片报文的第一个描述符中的PKT_INFO。
PKT_INFO 详细内容参见文档：\5182H\1.ChipKey\01.Architecture\1.5
AS\src\SD5182HV100 接口数据结构.xlsx 。
5.12.4.3 Tx Info Extend Descriptor
Tx Legacy Descriptor 和Tx Extend Descriptor 携带的PKT_INFO 信息不够时，可以通过描
述符中的INFO_EXT 定义下一个描述符为Tx info Extend Descriptor，Tx info Extend
Descriptor 的SIZE 为16bytes，支持8 或者16bytes 有效。
SD5182HV100 Functional Specification Page 366 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
在Tx Descriptor Ring 上Tx Info Extend Descriptor 必须跟随在sop=1 的Tx Legacy
Descriptor 或Tx Extend Descriptor 的下一个指针。
5.12.4.3.1 Tx Info Extend Descriptor Format
15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0
0
H pkt_info_ext[31:16]
L pkt_info_ext[15:0]
1
H pkt_info_ext[63: 48]
L pkt_info_ext[47:32]
2
H pkt_info_ext[64+31:64+16]
L pkt_info_ext[64+15:64+0]
3
H pkt_info_ext[64+63:64+48]
L pkt_info_ext[64+47:64+32]
5.12.4.3.2 Pkt_Info_Ext Transimision
报文扩展信息，该域由软件定义，PIE 对PKT_INFO 将不做任何操作，放在报文头之前发
送给IPS，如下图所示：
Payload
PKT_INFO
PKT_INFO_EXT
(optional)
15 0
Figure 5.12-1 Pkt_info Diagram
5.12.4.3.3 Tx Info Extend Descriptor Write Back
Tx Info Extend Descriptor 不需要回写。
SD5182HV100 Functional Specification Page 367 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.12.4.4 Tx Descriptor Ring
0
1
N-1 2
N
Descriptor 0
.
.
.
Descriptor 1
Descriptor 2
Descriptor 3
Descriptor N
RingBaseAddr + 0
RingBaseAddr + 16
RingBaseAddr + 32
RingBaseAddr + 48
RingBaseAddr + N*16
.
.
.
M DD=0 DD=1
CPU当前描述符指针:WPTR
逻辑当前描述符指针:RPTR
Figure 5.12-2 Tx Descriptor Buffer 示意图
PIE 发送方向最多支持8 个单次发包逻辑通道，每个逻辑通道对应一个环形队列缓存，用
于存放发送报文的描述符，每个环形队列最大支持32K 个描述符。每个发送环形队列缓
存位于连续地址空间。发送描述符包含报文缓存地址、报文长度和其它需要透传的控制信
息（转发方式、转发需要的控制信息、指定来源端口、校验加速使能等）。
5.12.4.5 IPS Interface
发包的全部包控制信息由CPU 编辑在Tx Descriptor 中，PIE 从描述符中提取包控制信息，
然后添加在包头传输给IPS 模块，提供给LSW解析和处理。
PIE 发包给IPS 的帧格式为：
PKT_INFO PACKET DATA
8/16/24B 64~65535KB
PKT_CTRL
8B
PKT_CTRL：
15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0
0 Rsvd tx_ch_id[7:0]
1 Rsvd
2
Rsvd
3
SD5182HV100 Functional Specification Page 368 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Header
and
Payload
PKT_INFO
PKT_INFO_EXT
(optional)
15 0
8 or 16bytes
4 or 8bytes
64 ~ 65535bytes
5.12.4.6 Single Transmit Packet
5.12.4.6.1 Single Transmit Descriptor PTR Update
WPTR：Descriptor Ring 写指针，初始值为0，由软件更新，软件填充有效的Descriptor 后
将刷新WPTR 指向NEXT。
RPTR：Descriptor Ring 读指针，初始值为0，由PIE 更新，PIE 完成Descriptor 的报文发
送后将刷新RPTR 指向NEXT。
RPTR 与WPTR 相等表示有效描述符为空。
RX_Descriptor_0
RX_Descriptor_1
RX_Descriptor_n
RX_Descriptor_n+1
…
RX_Descriptor_n+2
RX_Descriptor_n+3
RX_Descriptor_n+4
RX_Descriptor_n+5
RX_Descriptor_n+6
WPTR RX_Descriptor_n+7
RPTR
RX_Descriptor_Tail-1
RX_Descriptor_Tail
…
报文已发送
无效描述符
报文
未发送
无效描述符
有效描述符
SD5182HV100 Functional Specification Page 369 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.12.4.6.2 Single Transmit Descriptor Ring
单次发包通过配置一个或者多个Tx Legacy Descriptor。
如果报文需要更多的PKT_INFO，可以通过在SOP=1 的Tx Legacy Descriptor 后面增加一
个Tx Info Extend Descriptor，如下图中的Packet_1。
发送报文的payload 超过Tx Legacy Descriptor 的BUF_SIZE 时，可以通过多个Tx Legacy
Descriptor 组成一个报文，如下图中的Packet_2。
在一个eop=1 的Tx Legacy Descriptor 后可以接Tx Extend Descriptor 或者Tx Legacy
Descriptor。
TX_Legacy_Descriptor
SOP=1
EOP=1
TX_Legacy_Descriptor
SOP=1
EOP=1
TX_Info_Extend_Descriptor
TX_Legacy_Descriptor
SOP=1
EOP=0
TX_Legacy_Descriptor
SOP=0
EOP=0
TX_Info_Extend_Descriptor
TX_Legacy_Descriptor
SOP=0
EOP=1
Payload
PKT_INFO
Payload
PKT_INFO
PKT_INFO_EXT
PKT_INFO
PKT_INFO_EXT
Payload_0
Payload_1
Payload_2
Tx Descriptor Ring
Packet_0
Packet_1
Packet_2
Packet Transmit
5.12.4.6.3 Single Transmit Step of PIE
以发包通道0 为例，单次发包配置寄存器如下：
STEP Description
1 分配通道0 发送描述符的起始地址：PIE_TX_CH0_STR_ADDR（第一个描述符
的首字节地址），要求32Byte 边界对齐。
2 定义通道0 描述符的个数：PIE_TX_CH0_DCP_NUM，个数要求为2 的整数
幂。
初始化PIE_TX_CH0_CUR_WPTR
SD5182HV100 Functional Specification Page 370 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
3
软件分配发送报文缓存，并用待发送包绝对地址、发包长度等信息填充TX描述符，并且将Payload数据写入发包缓冲区
4
CPU配置PIE_TX_CH0_CUR_WPTR指针，启动发包
5
PIE检测到PIE_TX_CH0_CUR_WPTR指针刷新，通过对比PIE_TX_CH0_CUR_RPTR获知软件填充了有效的描述符，PIE等待调度CH0的发包权限
6
PIE预读取通道0的PIE_TX_CH0_CUR_RPTR指针系统缓存中的描述符
6
通道0获取发送权限PIE发送报文，将发送描述符对应的报文，单次发包将发送将一个完整的报文，
7
单次发包更新RPTR，发包完成
5.12.4.7 Generic Segmentation Offloding
为了节省CPU性能，PIE支持TCP Segmentation Offloding（TSO），将超过Maximum Transmission Unit（MTU）的报文切割成MSS大小报文，并且携带2、3和4层报文头，刷新报文头的域信息后将分片报文发送出去。
PIE发送方向支持TCP的分片报文，不支持IP/UDP分片。
分片报文格式支持：
 Ethernet 802.3
 IEEE 802.1q VLAN（Ethernet 802.3ac）
 Ethernet Type 2
 Ethernet SNAP
5.12.4.7.1 TCP/UDP TSO Packet
TCP/UDP分片报文读取Tx Extend Descriptor（DTYPE SOP=1）中的PKT_INFO和PKT_INFO_EXT（optional），再读取Tx Extend Descriptor（DTYPE SOP=1）中HRDLEN指定的Header，最后加上MSS字节的Payload组成一个分片报文发送。
TCP/UDP分片报文报文发送格式如下图所示：
SD5182HV100 Functional Specification Page 371 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Payload
PKT_INFO
PKT_INFO_EXT
(optional)
15 0
Header HRDLEN
MSS
Or
Last Frame
Payload Size
5.12.4.7.2 Segment Transmit Descriptor PTR Update
WPTR：Descriptor Ring 写指针，初始值为0，由软件更新，软件填充有效的Descriptor 后
将刷新WPTR 指向NEXT。
RPTR：Descriptor Ring 读指针，初始值为0，由PIE 更新，PIE 完成一组分片报文
Descriptor 的报文发送后将刷新指向NEXT，否则RPTR 指向分片报文SOP=1 的保持不变。
RPTR 与WPTR 相等表示有效描述符为空。
RX_Descriptor_0
RX_Descriptor_1
RX_Descriptor_n
RX_Descriptor_n+1
SOP=1 EOP=0
…
RX_Descriptor_n+2
SOP=0 EOP=0
RX_Descriptor_n+3
SOP=0 EOP=0
RX_Descriptor_n+4
SOP=0 EOP=1
RX_Descriptor_n+5
SOP=1 EOP=0
RX_Descriptor_n+6
SOP=0 EOP=0
WPTR RX_Descriptor_n+7
RPTR
RX_Descriptor_Tail-1
RX_Descriptor_Tail
…
报文已发送
无效描述符
报文
未发送
无效描述符
有效描述符
RPTR
完成一组分片报
文将RPTR刷新
SD5182HV100 Functional Specification Page 372 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.12.4.7.3 Segment Transmit Descriptor Ring
TSO发包需要配置一个或者多个Tx Extend Descriptor。
如果报文需要更多的PKT_INFO，可以通过在SOP=1的Tx Extend Descriptor后面增加一个Tx Info Extend Descriptor，如下图中的SEG_1，所有分片报文都使用SOP=1的PKT_INFO。
发送报文的payload超过Tx Extend Descriptor的BUF_SIZE时，可以通过多个Tx Legacy Descriptor组成一个报文，如下图中的SEG_2。每个Tx Extend Descriptor的定义当前描述符指向的缓存数据的PKT_LEN。
在一个EOP=1的Tx Extend Descriptor后可以接Tx Extend Descriptor或者Tx Legacy Descriptor。
SD5182HV100 Functional Specification Page 373 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
TX_Extend_Descriptor
SOP=1
EOP=1
TX_Extend_Descriptor
SOP=1
EOP=1
TX_Info_Extend_Descriptor
TX_Extend_Descriptor
SOP=1
EOP=0
TX_Extend_Descriptor
SOP=0
EOP=0
TX_Info_Extend_Descriptor
TX_Extend_Descriptor
SOP=0
EOP=1
Payload_MSS_0
PKT_INFO
PKT_INFO
PKT_INFO_EXT
Tx Descriptor Ring
SEG_0/Packet_0
Packet Transmit
Header
Payload_MSS1
PKT_INFO
SEG_0/Packet_0
Header
Payload_Last
PKT_INFO
SEG_0/Packet_eop
Header
...
Header
Payload_MSS_0
SEG_1/Packet_0
PKT_INFO
PKT_INFO_EXT
Header
Payload_MSS_0
SEG_1/Packet_1
...
PKT_INFO
PKT_INFO_EXT
Header
Payload_MSS_Last
SEG_1/Packet_eop
PKT_INFO
PKT_INFO_EXT
Header
Payload_MSS_0
SEG_2/Packet_0
PKT_INFO
PKT_INFO_EXT
Header
Payload_MSS_0
SEG_2/Packet_1
...
PKT_INFO
PKT_INFO_EXT
Header
Payload_MSS_Last
SEG_2/Packet_eop
SD5182HV100 Functional Specification Page 374 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.12.4.7.4 TSO Header Updating
5.12.4.7.4.1 MAC Header
5.12.4.7.4.1.1 Type/Len (for SNAP Packets)
Type/Len
软件配置原报文
—
分片首报文
MSS + HDRLEN – 14（有TAG则需考虑TAG长度）
非首、非尾分片报文
MSS + HDRLEN – 14（有TAG则需考虑TAG长度）
分片尾报文
Last Frame Payload bytes + HDRLEN – 14（有TAG则需考虑TAG长度）
5.12.4.7.4.1.2 IPv4 Header
5.12.4.7.4.1.3 Total Length
Total Length
软件配置原报文
—
分片首报文
MSS + HDRLEN – L3PTR
非首、非尾分片报文
MSS + HDRLEN –L3PTR
分片尾报文
Last Frame Payload bytes + HDRLEN –L3PTR
5.12.4.7.4.1.4 IPv4 Checksum
Checksum
软件配置原报文
0x0
分片首报文
0x0，IPS计算
非首、非尾分片报文
0x0，IPS计算
分片尾报文
0x0，IPS计算
5.12.4.7.4.2 IPv6 Header
PIE仅支持IPv6SIZE为40bytes。
5.12.4.7.4.2.1 Payload Length
SD5182HV100 Functional Specification Page 375 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Payload Length
软件配置原报文
—
分片首报文
MSS + HDRLEN – L3PTR – IPv6SIZE
非首、非尾分片报文
MSS + HDRLEN – L3PTR – IPv6SIZE
分片尾报文
Last Frame Payload bytes + HDRLEN – L3PTR – IPv6SIZE
5.12.4.7.4.3 TCP Header
5.12.4.7.4.3.1 Sequence Number
Sequence Number
软件配置原报文
N，软件配置
分片首报文
N
非首、非尾分片报文
上个报文的SN + 上个报文的TCP Payload Size
分片尾报文
上个报文的SN + 上个报文的TCP Payload Size
5.12.4.7.4.3.2 TCP Checksum
TCP Checksum
软件配置原报文
0x0
分片首报文
0x0，IPS计算
非首、非尾分片报文
0x0，IPS计算
分片尾报文
0x0，IPS计算
5.12.4.7.4.3.3 FIN
FIN
软件配置原报文
1’b1
1’b0
分片首报文
1’b0
1’b0
非首、非尾分片报文
1’b0
1’b0
分片尾报文
1’b1
1’b0
5.12.4.7.4.3.4 PSH
SD5182HV100 Functional Specification Page 376 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PSH
软件配置原报文
1’b1
1’b0
分片首报文
1’b0
1’b0
非首、非尾分片报文
1’b0
1’b0
分片尾报文
1’b1
1’b0
5.12.4.7.4.4 UDP Header
5.12.4.7.4.4.1 Length
Length
软件配置原报文
—
分片首报文
MSS + HDRLEN – L4PTR
非首、非尾分片报文
MSS + HDRLEN – L4PTR
分片尾报文
MSS + HDRLEN – L4PTR
5.12.4.7.4.4.2 UDP Checksum
UDP Checksum
软件配置原报文
0x0
分片首报文
0x0，IPS计算
非首、非尾分片报文
0x0，IPS计算
分片尾报文
0x0，IPS计算
5.12.4.7.5 Segment Transmit Packet Step of PIE
STEP
Description
1
分配通道0发送描述符的起始地址：PIE_TX_CH0_STR_ADDR（第一个描述符的首字节地址），要求32Byte边界对齐。
2
定义通道0描述符的个数：PIE_TX_CH0_DCP_NUM，个数要求为2的整数幂。
初始化PIE_TX_CH0_CUR_WPTR
3
软件分配发送报文缓存，并用待发送包绝对地址、发包长度等信息填充TX描述符，并且将Payload数据写入发包缓冲区
4
CPU配置PIE_TX_CH0_CUR_WPTR指针，启动发包
SD5182HV100 Functional Specification Page 377 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5
PIE检测到PIE_TX_CH0_CUR_WPTR指针刷新，通过对比PIE_TX_CH0_CUR_RPTR获知软件填充了有效的描述符，PIE等待调度CH0的发包权限
6
PIE预读取通道0的PIE_TX_CH0_CUR_RPTR指针系统缓存中的描述符
6
通道0获取发送权限PIE发送报文，将发送描述符对应的报文净荷分片，将分片描述符SOP=1的PKT_INFO/Header与净荷组成分片报文，分片发包将发送一个完成的分片报文
7
完成分片发包更新更新payload的指针，如果一组分片报文发送完成更新RPTR，否则RPTR指向分片报文的SOP=1
5.12.4.8 Transmit Backpressure
发包支持反压：如果IPS处理PIE的数据带宽不够，可以反压PIE模块，则PIE模块会暂停从系统缓存中取包数据。
5.12.4.9 Transmit Schedule
PIE使用RR调度每个通道进行报文发送，PIE发送完一个普通报文或者分片报文将重新进行RR调度通道进行报文发送。
5.12.5 Period Transmit Packet
PIE支持2n （n=4～8为parameter参数）个周期发包逻辑通道，周期发包功能支持宏隔离。每个周期发包逻辑通道对应一个描述符，这些描述符按线性队列存储在DDR中。
周期发包分普通模式和事件模式2种。事件模式时，报文长度为24字节的控制信息，净荷为0，不需要使用发包描述符；普通模式时，报文净荷最小1字节，最大10K Byte。
5.12.5.1 PTx Descriptor
周期发包不回写描述符，格式如下： 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0
0
H
Rsvd
ptx_sn_max[14:0]
L
Rsvd
pkt_length [13:0]
1
H
tx_buf_ptr[31:0]
L
2
H
pkt_info[31:16]
L
pkt_info[15: 0]
3
H
pkt_info[63:48]
L
pkt_info[47:32]
SD5182HV100 Functional Specification Page 378 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
ptx_sn_max：周期性发包配置的序列号最大值。
pkt_length：周期报文的长度，单位字节。
tx_buf_ptr：当前描述符指定的报文缓存区起始地址，可以按任意字节边界对齐。
pkt_info：完全由软件定义，PIE 逻辑不识别具体内容。
5.12.5.2 PTx Table
周期发包需要一个周期控制表项和一个模式控制表项。表项地址和周期发包逻辑通道
号一一对应。
周期配置表项：
Addr Field Width Description
0xn ptx_period_ctrl 45:0
bit[45:23]：ptx_period 发包周期；
bit[22:0]：ptx_period_cnt 周期性计时器。
注：n 周期发包逻辑通道编号。
模式配置表项：
Addr Field Width Description
0xn ptx_mode_ctrl 48:0
bit[48]：报文模式控制，0：普通模式；1：事件模式
bit[47]：发包模式控制：0：连续模式；1：单次模式
bit[46:32]：序列号计数器。每发送一个报文，序列号加一。当序列
号计数到配置的最大值时，序列号从0 开始循环计数。
bit[31:0]：周期发包计数器。统计周期发包的个数。
注：n 周期发包逻辑通道编号。
5.12.5.3 IPS Interfance
（1） 周期普通发包帧格式（PTX Packet）
PKT_INFO PACKET DATA
8B 1~10KB
PKT_CTRL
8B
pkt_ctrl、pkt_info、Packet Data 的具体格式如下表所示：
15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0
0 Rsvd 0 1 ptx_ch_id[7:0]
1 Rsvd ptx_sn[14:0]
2 Rsvd
3 Rsvd
4 pkt_info[15: 0]
5 pkt_info[31:16]
6 pkt_info[47:32]
SD5182HV100 Functional Specification Page 379 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
7 pkt_info[63:48]
… Packet Data/Payload (1Byte~10KByte, Read from DRAM Tx Buffer)
ptx_ch_id：周期发包逻辑通道号。
ptx_sn:周期发包序列号。
（1） 周期事件发包帧格式（PTX Event）
PKT_INFO
16B
PKT_CTRL
8B
15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0
0 Rsvd 1 1 ptx_ch_id[7:0]
1 Rsvd/Pad
2 Rsvd/Pad
3 Rsvd/Pad
4 Rsvd/Pad
5 Rsvd/Pad
6 Rsvd/Pad
7 Rsvd/Pad
SD5182HV100 Functional Specification Page 380 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8
Rsvd/Pad
9
Rsvd/Pad
10
Rsvd/Pad
11
Rsvd/Pad
ptx_ch_id：周期发包逻辑通道号。
5.12.5.4 Steps of PTx
周期发包寄存器寄存器：
1) PIE_PTX_STR_ADDR ： 周期发包描述符的起始地址，要求16Byte边界对齐。
2) PIE_PTX_ CHn_EN：周期发包通道使能，支持动态配置；n为周期发包逻辑通道编号。
3) PIE_PTX_GLB_EN ：周期发包全局使能。
CPU处理周期性发包的步骤：
1) CPU分配PTX描述符的缓存区的起始地址，然后配置PIE_PTX_STR _ADDR。
2) CPU分配PTX发包缓冲区空间，将包数据写入发包缓冲区；并将待发送报文的缓存起始地址、报文长度等信息填入PTX描述符。
3) CPU配置PIE_PTX_EN和PIE_PTX_ CHn_EN，启动周期发包。
逻辑处理周期性发包的步骤：
1) 当逻辑检测到PIE_PTX_GLB_EN和PIE_PTX_ CHn_EN使能后，从周期控制表项中获取使能逻辑通道的周期信息，打开对应逻辑通道的周期定时功能，开始定时计数；
2) 当定时周期到达后，逻辑自动用发包周期重置周期计时器，重新开始定时计数。然后从周期模式控制表项中读取对应通道的报文模式。若报文为事件模式（event_mode为1），直接发送24Byte长度的控制报文到IPS；若报文为普通模式，则读取对应通道的描述符获取报文的缓存起始地址及长度等信息，将报文从DDR读出发送至IPS。
3) 当多个逻辑通道的定时周期同时到达时，逻辑按通道号依次轮询各发包逻辑通道，循环发包。
在整个周期性发包过程，CPU只需要配置使能启动发包，中间过程不需要任何参与，可以完全解放CPU。
5.12.6 Receive Packet
PIE最多支持8个收包逻辑通道(即8个队列)。收包的有效包长：1Byte～16KByte。
PIE的所有逻辑通道均支持接收分片报文。
SD5182HV100 Functional Specification Page 381 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.12.6.1 Rx Descriptor
5.12.6.1.1 Rx Descriptor Format 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0
0
H
Rsvd
DTYPE
Rsvd
Rsvd
DD
Rsvd
L
PKT_LEN[15:0]
1
H
RX_BUF_PTR[31:0]
L
2
H
pkt_info[31:16]
L
pkt_info[15: 0]
3
H
pkt_info[63:48]
L
pkt_info[47: 32]
5.12.6.1.2 RX_BUF_PTR
接收报文数据存放在系统缓存中的绝对地址。
要求RX_BUF_PTR以32B对齐；
5.12.6.1.3 PKT_LEN
最大支持16Kbytes，单位bytes。
接收报文长度，包括header和payload。
5.12.6.1.4 DD
Descriptor Done，描述符完成指示。
0：PIE回写描述符将DD域写成0x0；
1：软件写描述符完成。
（软件可使用DD域管理环形队列，但依然需要配置各通道描述符指针信息供收包使用。）
5.12.6.1.5 DTYPE
Descriptor Type指示。
2’b11：Rx Descriptor，sop=1，eop=1。
2’b10：Rx Descriptor，sop=1，eop=0。
2’b00：Rx Descriptor，sop=0，eop=0。
2’b01：Rx Descriptor，sop=0，eop=1。
SD5182HV100 Functional Specification Page 382 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.12.6.1.6 Rx Receive Descriptor Write Back 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0
0
H
Rsvd
DTYPE
Rsvd
Rsvd
DD
Rsvd
L
PKT_LEN[15:0]
1
H
RX_BUF_PTR[31:0]
L
2
H
pkt_info[31:16]
L
pkt_info[15: 0]
3
H
pkt_info[63:48]
L
pkt_info[47: 32]
接收完整报文后，或者软件分片的系统缓存写满BUF_SIZE字节时，PIE将回写Rx Receive Descriptor，更新描述符中的DTYPE、DD、PKT_LEN、PKT_INFO。
5.12.6.2 Rx Info Extend Descriptor
Rx Descriptor携带的PKT_INFO信息不够时，可以通过寄存器RX_INFO_EXT指定所有通道每个Rx Descriptor后都跟随一个Rx info Extend Descriptor，Rx info Extend Descriptor的SIZE为16bytes，支持8或者16bytes有效。
5.12.6.2.1 Tx Info Extend Descriptor Format 15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0
0
H
pkt_info_ext[31:16]
L
pkt_info_ext[15:0]
1
H
pkt_info_ext[63: 48]
L
pkt_info_ext[47:32]
2
H
pkt_info_ext[64+31:64+16]
L
pkt_info_ext[64+15:64+0]
3
H
pkt_info_ext[64+63:64+48]
L
pkt_info_ext[64+47:64+32]
5.12.6.3 Receive Descriptor Ring
SD5182HV100 Functional Specification Page 383 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
0
1
N-1 2
N
Descriptor 0
.
.
.
Descriptor 1
Descriptor 2
Descriptor 3
Descriptor N
RingBaseAddr + 0
RingBaseAddr + 16
RingBaseAddr + 32
RingBaseAddr + 48
RingBaseAddr +
N*16
.
.
.
M Owner=0 Owner=1
CPU当前描述符指针WPTR
逻辑当前描述符指针RPTR
Figure 5.12-3 Rx Descriptor Buffer 示意图
PIE 接收方向最多支持8 个接收环形队列缓存，用于存放接收报文的描述符，每个环形队
列最大支持32K 个描述符。每个接收环形队列缓存位于连续地址空间。接收描述符包含
报文缓存地址和其它控制信息（报文长度、来源端口、报文接收原因、报文校验信息等）。
5.12.6.3.1 Receive Descriptor Ring By RX_INFO_EXT
PIE 通过寄存器RX_INFO_EXT 定义通道的Rx Descriptor 跟随Rx info Extend Descriptor，
PIE 接收通道单独配置。
RX_INFO_EXT 配置为64bit PKT_INFO 有效时，Rx Descriptor Ring 如下图所示：
RX_Descriptor_2
RX_Descriptor_3
RX_Descriptor_0
RX_Descriptor_1
RingBaseAddr+0
RingBaseAddr+16
RingBaseAddr+32
RingBaseAddr+48
...
RingBaseAddr+N RX_Descriptor_N
Figure 5.12-3 Rx Descriptor Ring without Extend 示意图
RX_INFO_EXT 配置为128/192bit PKT_INFO 有效时，Rx Descriptor Ring 如下图所示，
PIE 将读取Rx Descriptor 和Rx Info Extend Descriptor，接收报文后将回写Rx Descriptor，
如果在接收报文的SOP=1 时需要回写Rx Info Extend Descriptor，否则不需要回写Rx Info
Extend Descriptor。
SD5182HV100 Functional Specification Page 384 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
RX_Descriptor_1
RX_Info_Extend_1
RX_Descriptor_0
RX_Info_Extend_0
RingBaseAddr+0
RingBaseAddr+16
RingBaseAddr+32
RingBaseAddr+48
...
RingBaseAddr+N RX_Descriptor_N
RX_Info_Extend_N
Figure 5.12-3 Rx Descriptor Ring with Extend 示意图
5.12.6.4 Single Receive Packet
5.12.6.4.1 Single Receive Descriptor PTR Update
CPU 维护RX Descriptor 链的RPTR_SOFT 和WPTR 指针。
WPTR：CPU 当前填充有效描述符指针CPU 填充一个有效的RX Descriptor 则将WPTR 刷
新为NEXT；
RPTR_SOFT：CPU 当前读取描述符指针，CPU 读取描述符中的报文则将RPTR_SOFT 刷
新为NEXT。
PIE 维护RPTR 指针，RPTR 指向当前操作的RX Descriptor。CPU 通过获取RPTR 指针可
以得到当前未取走的接收报文。
RPTR- RPTR_SOFT 即为当前未取走报文描述符个数。
WPTR-RPTR 即为当前未使用描述符个数。
SD5182HV100 Functional Specification Page 385 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
RX_Descriptor_0
RX_Descriptor_1
RX_Descriptor_n
RX_Descriptor_n+1
…
RX_Descriptor_n+2
RX_Descriptor_n+3
RX_Descriptor_n+4
RX_Descriptor_n+5
RX_Descriptor_n+6
WPTR RX_Descriptor_n+7
RPTR_SOFT
RPTR
RX_Descriptor_Tail-1
RX_Descriptor_Tail
…
接收报文
已取走
无效描述符
接收报文
未取走
未接收报文
有效描述符
无效描述符
5.12.6.4.2 Single Receive Descriptor Ring
PIE 支持单个报文接收，接收EPS 输入单个报文则当前报文接收完成，PIE 完成描述符回
写后上报收包中断。
支持超长报文接收，即多个描述符对应一个完整的包，如下图中的Packet_1。
收包方向每个描述符对应的缓存区容量寄存器可配，以128-Byte 为单位，最小值为
1536Byte，最大值为65536byte，不可动态配置。接收方向包长度大于单个描述符对应的
缓存容量时，逻辑自动将包切片，使用连续的描述符存储包内容，只在最后一个描述符中
标记EOP，指示包结束。
SD5182HV100 Functional Specification Page 386 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
RX_Descriptor
SOP=1
EOP=1
RX_Descriptor
SOP=1
EOP=0
RX_Descriptor
SOP=0
EOP=0
RX_Descriptor
SOP=0
EOP=1
RX_Descriptor
SOP=1
EOP=1
Payload
PKT_INFO
Payload
PKT_INFO
PKT_INFO
Payload
Rx Descriptor Ring
Packet_0
Packet_1
Packet_2
Packet Receive
Packet_0
Payload
Rx Buffer
Packet_1
Payload_0
Packet_1
Payload_1
Packet_1
Payload_2
Packet_2
Payload
Figure 5.12-3 Rx Descriptor For Single Receive 示意图
5.12.6.5 Generic Receive Offload
PIE 支持LRO（Large Receive Offload），LRO 合并的报文头，数据部分合并存储，提高
报文携带数据的效率。
PIE 支持TCP 分片报文的组包操作，PIE 将MAC 层、IP 层和TCP 层的报文头合并，数据
部分合并存储。
PIE 支持如下情况终止组包操作：
序号 组包条件 当前报文
是否组包
下一报文
是否组包
1 非同一条流报文，芯片通过流ID 分区。
（由软件保证，分时复用同一PIE 通道进行组包的报文流，后一条
LRO流打开之前，由软件确保前一条LRO组包的报文全部从PIE 通
道中被取走）
—
—
2 IPv4 报文头校验和不正确。
（可以支持，LSW进行IP checksum检测，错误指示送给PIE，PIE 对
这类报文停止组包）
N N
3 IPv4/IPv6 报文长度不正确。
（可以支持，需要LSW新增ip 报文length 域检测，错误指示送给
PIE，PIE 对这类报文停止组包）
N N
4 IPv4 头带option 域。 N N
SD5182HV100 Functional Specification Page 387 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
（可以支持，LSW提供带option指示，带option不组包）
5
分片ip报文。
（确认ip分片报文不组包）
N
N
6
IP头ttl、tos、flag fragment字段不相等。
（都不检测）
Y
Y
7
ip头identification字段不连续
（不检测）
Y
Y
8
tcp的ack的序列号不一致。
（不检测）
Y
Y
9
tcp的option域不一致。
（部分支持，LSW提供带TCP option指示，带TCP option不组包）
N
N
10
报文payload长度不等于mss
（不检测）
Y
Y
11
tcp报文不连续。
（可以支持，PIE检测TCP报文SN是否连续，不连续停止组包）
Y
N
12
TCP报头标志为URG（紧急）、PSH（急迫）、RST（复位）、SYN（同步）、FIN（终止）、 CWR（拥塞，为TCP_CB的保留位，详见报文格式）。
（可以支持， PIE新增字段提取检测，字段域为1不组包）
N
N
13
报文长度大于65535B 。
（可以支持，寄存器可配）
N
Y
终止组包操作之后，重新另起描述符进行新的组包过程。对IP分片/IPv4 Option/TCPOption这类不符合组包条件的报文，按照Single Receive Packet接收报文。
PIE的8个接收通路支持LRO，PIE的RX_SEG_CHAN接收的的分片报文将是连续接收分片报文，从第一片分片到最后一片分片中间不能间插分片组以外的其他报文，如有间插情况，将终止当前组包，重新开始新的组包过程。
5.12.6.5.1 LRO_INFO
PIE为了对TCP分片报文的组包，PIE接收TCP分片报文的LRO_INFO中需要携带下面信息：
1) IP报文头偏移字节数：L3PTR[7:0]；
SD5182HV100 Functional Specification Page 388 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
2) IP 报文头为IPv4 或者IPv6 指示：L3_Type；
3) TCP 报文头偏移字节数：L4PTR[7:0]；
4) 报文头长度：HRDLEN[7:0]；
5) TCP 分片报文流组包标识：LRO_VLD；
6) IP 分片报文指示；
7) IPv4 Checksum 错误指示；
8) IPv4 Option 指示；
9) IPv4/IPv6 报文长度错误指示；
10) TCP Option 指示；
11) TCP SN；
12) TCP Ctrl Bits。
LRO_INFO 详细内容参见文档：\5182H\1.ChipKey\01.Architecture\1.5
AS\src\SD5182HV100 接口数据结构.xlsx 。
5.12.6.5.2 LRO Packet Format
报文重组过程中，PIE 将保留First Fragment 的报文头，后面的分片的报文头将丢弃，将
分片报文的Payload 连续的存储在连续写入PIE 数据存储，并且刷新分片报文头中的相关
域信息。
PIE 接收的TCP 分片报文将是IPv4 或者IPv6 封装的TCP 报文，报文格式如下所示。
Eth IP TCP Payload
HRDLEN
L3PTR L4PTR
Figure 5.12-3 IPv4/6 承载TCP 报文格式
PIE 接收一组TCP 分片报文的需要报文头保持一致，只能是IPv4 承载或者IPv6 承载，在
一组TCP 分片报文中不能变化。
如果PIE 连续接收分片报文，通过PKT_INFO 中携带报文头信息识别报文头，PIE 将保留
首片的2,3,4,层报文头，将分片报文的Payload 拼接后连续存储。
如下图所示，PIE 通过RX Descriptor 缓存一组TCP 分片报文，RX Descriptor_0 中存储
TCP 首片的报文头。
SD5182HV100 Functional Specification Page 389 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
1st Segmet Eth IP TCP Payload_0
2nd Segmet Eth IP TCP Payload_1
…
Eth IP TCP Payload_Last
TCP
Segmet
Rx Descriptor_0
Rx Descriptor_1
…
Rx Descriptor_X-1
缓存1st的Header
和Payload_0~Last
Rx Descriptor
Last Segmet
5.12.6.5.3 LRO Header Updating
PIE 接收的分片报文后将刷新首分片报文头的域信息。
5.12.6.5.3.1 MAC Header
5.12.6.5.3.1.1 Type/Len（For SNAP Packets）
Type/Len
分片首报文 不修改
非首、非尾分片报文 Type/Len + Payload
分片尾报文 Type/Len + Payload
5.12.6.5.3.2 IPv4 Header
5.12.6.5.3.2.1 Total Length
Total Length
分片首报文 不修改
非首、非尾分片报文 Total Length + Payload
分片尾报文 Total Length + Payload
5.12.6.5.3.2.2 IPv4 Checksum
IPv4 Checksum
分片首报文 不修改
非首、非尾分片报文 根据Total Length 增量修改
分片尾报文 根据Total Length 增量修改
5.12.6.5.3.3 IPv6 Header
5.12.6.5.3.3.1 Payload Length
Payload Length
SD5182HV100 Functional Specification Page 390 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
分片首报文
不修改
非首、非尾分片报文
Payload Length + Payload
分片尾报文
Payload Length + Payload
5.12.6.5.3.4 TCP Header
5.12.6.5.3.4.1 TCP Checksum
TCP Checksum
分片首报文
不修改
非首、非尾分片报文
计算
分片尾报文
计算
5.12.6.5.3.4.2 FIN
FIN
分片首报文
不修改
非首、非尾分片报文
不修改
分片尾报文
刷新
5.12.6.5.3.4.3 PSH
PSH
分片首报文
不修改
非首、非尾分片报文
不修改
分片尾报文
刷新
5.12.6.5.4 LRO Disorder Check
PIE将进行TCP分片报文的乱序检测，如果分片报文乱序，则PIE分配一个新的RX Descriptor存储乱序报文，后续分片报文如果没乱序则连续存储，否则都分配单个描述符缓存。
5.12.6.5.4.1 TCP Sequence Number
PIE通过检测TCP分片报文Sequence Number判断是否乱序。
SN检测方法：
非首分片报文Sequence Number = 前一个报文的Sequence Number + 前一个报文的TCP Payload Size。
SD5182HV100 Functional Specification Page 391 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.12.6.5.5 LRO Descriptor Ring
PIE通过PKT_INFO中携带的LRO_VLD以及其他非排除条件决定进行组包。
PIE支持单个描述符指向的数据缓存接收多个分片报文的payload，并且分片报文的payload在数据缓存中是连续的。
PIE支持多个描述符缓存一组分片报文，SOP=1的描述符指向的数据缓存中存放报文头和payload，每次接收一个分片报文PIE将更新报文头的域。
SD5182HV100 Functional Specification Page 392 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
RX_Descriptor
SOP=1
EOP=0
RX_Descriptor
SOP=0
EOP=0
Payload
PKT_INFO
Payload
PKT_INFO
PKT_INFO
Payload
Rx_CHAN_x
Descriptor Ring
First Segment
Second Segmet
N-1 Segmet
RX_SEG_CHAN_x
Packet Receive
Unfragmentable
Payload
Rx Buffer
Payload
RX_Descriptor
SOP=0
EOP=1
Payload
PKT_INFO
Payload
N Segmet
PKT_INFO
Payload
N+1 Segmet
...
PKT_INFO
Payload
M-1 Segmet
...
...
PKT_INFO
Payload
X-1 Segmet
...
PKT_INFO
Payload
Last Segmet
...
5.12.6.5.6 LRO Descriptor PTR Update
LRO 模式下的RPTR_SOFT 和WPTR 指针操作与单次收包一致。
LRO 模式下CPU 通过获取RPTR_CUR 指针可以得到当前未取走的接收报文，为了支持
CPU 读取PIE 当前操作的描述符中的分片报文，避免PIE 与CPU 对同一个描述符的缓存
SD5182HV100 Functional Specification Page 393 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
读写冲突，LRO 的模式下RPTR 刷新与单次收包有区别，PIE 需要增加RPTR_RC、
RPTR_HRD、RPTR_CURR、CURR_NEXT。
RPTR_RC：CPU 读取RPTR 动作清0，PIE 接收完分片报文后将RPTR_RC 置1，初始值
为0。
RPTR_HRD：当前分片报文重组的Header 存放描述符指针，初始值等于RPTR；
RPTR_CURR：当前分片报文重组使用描述符指针，初始值等于RPTR；
CURR_NEXT：当前分片报文重组使用描述符的NEXT 有效空描述符，初始值为RPTR 的
NEXT；
RX_Descriptor_0
RX_Descriptor_1
RX_Descriptor_n
RX_Descriptor_n+1
…
RX_Descriptor_n+2
Header
RX_Descriptor_n+3
RX_Descriptor_n+4
RX_Descriptor_n+5
RX_Descriptor_n+6
WPTR
RPTR_CURR
RX_Descriptor_Tail-1
RX_Descriptor_Tail
…
接收报文
已取走
无效描述符
接收报文
未取走
未接收报文有效描述符
无效描述符
RPTR_SOFT
RPTR_HRD
CURR_NEXT
RX_Descriptor_n+8
RX_Descriptor_n+7
如果接收分片报文符合任意一种不组包条件或者RPTR_RC 为0，则PIE 结束
RPTR_CURR 指向当前RX Descriptor 组包，申请一个新的RX Descriptor 接收当前的分片
报文，RPTR 处接收Header+Payload。
5.12.6.5.7 LRO Descriptor PTR Update With RPTR_RC
LRO 接收分片报文过程中PIE 需要读写RPTR_CURR 和RPTR_HRD 描述符缓存的数据，
接收分片报文过程中需要保证CPU 不读取RPTR_HRD 开始往后的数据。
PIE 通过检测RPTR_RC 得到CPU 是否需要读取之前接收成功的分片报文，PIE 将在缓存
分片报文前判断CPU 是否需要读取，如果CPU 需要读取（RPTR_RC=0）已经接收好的
SD5182HV100 Functional Specification Page 394 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
分片报文，那PIE后续接收的分片报文将使用一个新的RX Descriptor存储分片报文的Header+Payload；如果CPU不需要读取（RPTR_RC=1），那PIE后续接收的分片报文将丢弃Header，将Payload连续存储在RPTR_CURR的描述符缓存，接收完成后刷新RPTR_HRD的描述符中header信息。
PIE在接收分片报文过程中，如果报文Payload长度大于RPTR_CURR的描述符剩余缓存大小，PIE将RPTR_CURR的描述符缓存写满后将使用RPTR_NEXT继续存储分片报文，同时将RPTR_CURR指向CURR_NEXT，CURR_NEXT指向下一个有效的空描述符。
PIE接收完成分片报文后，将刷新RPTR为CURR_NEXT，支持CPU将已接收重组的分片报文取走，并且将RPTR_RC置为1，如果下一个分片报文来之前CPU不读取，PIE将重组分片报文，连续存储分片报文Payload。
SD5182HV100 Functional Specification Page 395 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
RPTR_RC
PIE接收分片报文
RPTR_RC=0 RPTR_RC=1
RPTR<=RPTR_NEXT
RPTR_RC<=1
RPTR_CURR
缓存是否溢出？
NO
YES
RPTR_CURR连续存储
方式缓存报文Payload
报文缓存是否
结束？
NO
RPTR_CURR<=RPTR_NEXT
RPTR_NEXT<=NEXT
RPTR_HRD<=RPTR
RPTR_CURR<=RPTR
RPTR缓存报文
Header+Payload
RPTR<=RPTR_HRD
5.12.6.5.7.1 CPU Feed And TSO With RPTR_RC
PIE 顺序接收分片报文，CPU 取报文可能发生在PIE 接收空闲或者PIE 接收报文过程中，
PIE 需要避免与CPU 的取报文的冲突。
下面通过例子介绍PIE 规避CPU 取报文冲突的流程。
SD5182HV100 Functional Specification Page 396 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
START1 END1
Time
END0 START2
PIE接收空闲PIE接收分片报文区间PIE接收空闲
1 2 3
Header
Payload_x
Header
Payload_y
在END0 时刻，上一个分片报文将Payload_x 已经存放在RPTR_CURR，RPTR_HRD 已经
刷新相关域信息，RPTR 指向CURR_NEXT，RC 置为1。
在START1 时刻PIE 接收新的分片报文Header+Payload_y。
在END0~START1 的区间1 PIE 的RPTR、PIE_HRD、RPTR_CURR、CURR_NEXT 都将
保持不变。
RX_Descriptor_0
RX_Descriptor_1
…
WPTR
RPTR_CURR
RX_Descriptor_Tail-1
RX_Descriptor_Tail
…
RPTR_SOFT
RPTR_HRD
RPTR, CURR_NEXT
CPU Write
Header
Header
CPU
Read
CPU
Write
PIE
RW
Header
Payload
Payload_x
Payload
Payload
Payload
Payload
Figure 5.12-3 PIE 接收空闲时刻图
1、START1 时刻RC=0，即区间1 CPU 读取RPTR。
CPU 可能正在读取RPTR_SOFT~RPTR-1 区间的描述符中的报文，即下图中的CPU 读操
作范围。
PIE 为了避免与CPU 读取操作冲突，PIE 的RW操作范围在RPTR~WPTR-1。PIE 将分片
报文的Header+Payload_y 都存入RPTR 中，将RPTR_HRD 和RPTR_CURR 都指向RPTR。
SD5182HV100 Functional Specification Page 397 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
RX_Descriptor_0
RX_Descriptor_1
…
WPTR
RX_Descriptor_Tail-1
RX_Descriptor_Tail
…
RPTR_SOFT
RPTR, RPTR_CURR, RPTR_HRD
CPU Write
Header
Header
CPU
Read
CPU
Write
PIE
RW
Header
Payload
Payload_x
Payload
Payload
Payload
Payload
Header Payload_y
CURR_NEXT
PIE RW操作范围
CPU 写操作范围
CPU 读操作范围
在END1 时刻，PIE 接收完Header+Payload_y，PIE 将RPTR 刷新为CURR_NEXT，在
END1 时刻之后的PIE 空闲时刻CPU 可以将报文取走。
SD5182HV100 Functional Specification Page 398 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
RX_Descriptor_0
RX_Descriptor_1
…
WPTR
RX_Descriptor_Tail-1
RX_Descriptor_Tail
…
RPTR_SOFT
RPTR_CURR, RPTR_HRD
CPU Write
Header
Header
CPU
Read
CPU
Write
PIE
RW
Header
Payload
Payload_x
Payload
Payload
Payload
Payload
Header Payload_y
RPTR, CURR_NEXT
CPU 写操作范围
CPU 读操作范围
CPU 可以读操作范围
2、START1 时刻RC=1，即区间1 CPU 未读取RPTR。
CPU 可能正在读取RPTR_SOFT~RPTR-1 区间的描述符中的报文，即下图中的CPU 读操
作范围。
PIE 为了避免与CPU 读取操作冲突，PIE 将RPTR 刷新为RPTR_HRD，PIE 将分片报文的
Payload_y 都存入RPTR_CURR 中。
SD5182HV100 Functional Specification Page 399 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
RX_Descriptor_0
RX_Descriptor_1
…
WPTR
RPTR_CURR
RX_Descriptor_Tail-1
RX_Descriptor_Tail
…
RPTR_SOFT
RPTR, RPTR_HRD
CURR_NEXT
CPU Write
Header
Header
CPU
Read
CPU
Write
PIE
RW
Header
Payload
Payload_x
Payload
Payload
Payload
Payload
CPU 读操作范围
PIE RW操作范围Payload_y
CPU 写操作范围
在END1 时刻，PIE 接收完Payload_y，PIE 将RPTR 刷新为CURR_NEXT，在END1 时刻
之后的PIE 空闲时刻CPU 可以将报文取走。
SD5182HV100 Functional Specification Page 400 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
RX_Descriptor_0
RX_Descriptor_1
…
WPTR
RX_Descriptor_Tail-1
RX_Descriptor_Tail
…
RPTR_SOFT
RPTR_CURR
CPU Write
Header
Header
CPU
Read
CPU
Write
PIE
RW
Header
Payload
Payload_x
Payload
Payload
Payload
Payload
Payload_y
RPTR, CURR_NEXT
CPU 写操作范围
CPU 读操作范围
RPTR_HRD
5.12.6.5.7.2 IP Segment Packet Receive
PIE 支持IPv4/IPv6 的分片报文，PIE 接收PKT_INFO 中携带IP 分片报文标识；
PIE 支持LRO 通道接收的IP 分片报文都按照Single Receive 方式存储。
如下图所示，PIE 将IP 分片报文按单独描述符缓存，TCP 的分片报文按照Payload 连续存
储。
1st Segmet Eth IP TCP Payload_0
2nd Segmet Eth IP TCP Payload_1
…
…
Last Segmet Eth IP TCP Payload_Last
Eth IP TCP Payload_M
Eth IP Payload_M+1
IPv4/6 1st Segmet
M-1 Segmet Eth IP TCP Payload_M-1
TCP
Segmet
Eth IP Payload_M+N-1
IPv4/6
Segmet
IPv4/6 Last Segmet
IPv4/6 2nd Segmet
N Segmet Eth IP TCP Payload_M+N
…
TCP
Segmet
Rx Descriptor_0
Rx Descriptor_1
…
Rx Descriptor_X-1
缓存1st的Header
和Payload_0~M-1
Rx Descriptor_X
…
Rx Descriptor_X+N-1
缓存IPv4/6 Header
和Payload_M~N-1
Rx Descriptor_Y
…
Rx Descriptor_Z-1
缓存N的Header
和Payload_N~Last
第一组Rx Descriptor
第二组Rx Descriptor
第三组Rx Descriptor
SD5182HV100 Functional Specification Page 401 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.12.6.6 Receive Steps of PIE of CPU
以收包通道0为例，配置寄存器如下：
1. PIE_RX_CH0_STR_ADDR 软件描述符的起始地址（第一个描述符的首字节地址），地址要求32字节边界对齐。
2. PIE_RX_CH0_DCP_NUM 软件描述符的个数。
3. PIE_RX_CH0_CUR_WPTR 当前软件配置的收包描述符指向的地址指针。
4. PIE_RX_CH0_RPTR 当前PIE模块收包描述符指向的地址指针，只读寄存器。
中断及状态寄存器：
1. PIE_RX_CH0_INT 表示每个通道收包中断寄存器
2. PIE_CH0_RXDCP_EMPTY_STS 单次收包描述符无效状态
CPU收包步骤如下：
1. CPU分配RX描述符的缓存区的起始地址，然后配置PIE_RX_CH0_STR _ADDR 和 PIE_RX_CH0_ DCP_ NUM。
2. CPU分配收包缓冲区DDR-DRAM绝对地址，并用绝对地址等信息填充RX描述符。
3. CPU配置PIE_RX_CH0_CUR_WPTR指针，启动收包。
4. CPU接收到逻辑单次收包中断PIE_RX_CH0_INT，则清中断PIE_RX_CH0_INT并且处理完中断子程序后跳转到步骤3。
5.12.6.7 Receive Steps of PIE
以收包逻辑通道为例，PIE收包步骤：
1. EPS向CPURX写入包数据（EPS输出的包已经有优先级的调度），并且PIE接收EPS随路发送的通道号。
2. PIE模块根据通道号，查询单次收包指针PIE_RX_CH0_RPTR，如果当前指针PIE_RX_CH0_RPTR等于PIE_RX_CH0_CUR_WPTR指针，PIE根据当前配置选择丢弃或者反压报文，上报状态PIE_CH0_RXDCP_EMPTY_STS有效，跳转到步骤3；如果当前指针PIE_RX_CH0_RPTR不等于PIE_RX_CH0_CUR_WPTR指针，跳转到步骤4。
3. 等待CPU配置寄存器PIE_RX_CH0_CUR_WPTR，相当于启动收包，跳转到步骤2。
4. PIE从PIE_RX_CH0_STR_ADDR +16* PIE_RX_CH0_RPTR地址取描述符。
5. PIE根据当前指示队列的有效的描述符进行收包，按描述符中的缓冲区绝对地址写入DDR-DRAM。
SD5182HV100 Functional Specification Page 402 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
6. 收包完成后，等待AXI 总线回复RESP 为OKAY 后，PIE 即清零DD 标志位，然后回
写修改描述符。回写命令成功后，PIE 上报可屏蔽中断PIE_RX_CH0 _INT，将
PIE_RX_CH0_RPTR 加一。再跳转到步骤1。
5.12.6.8 EPS Interface
收包的全部包控制信息由NP 编辑在包头，PIE 从包头中提取包控制信息写入收包描述符
中，供CPU 解析和处理。
EPS 发送给PIE 模块的包数据格式如下图所示，通道号带外传输。
PKT_INFO PACKET DATA
8/16/24B 1~2KB
LRO_INFO
32B
FRM_LEN
LRO_INFO、PKT_INFO 详细内容参见文档：\5182H\1.ChipKey\01.Architecture\1.5
AS\src\SD5182HV100 接口数据结构.xlsx 。
5.12.6.9 Receive DCP Fetch
PIE 内部提供每个通道缓存4 个DCP 的FIFO，使用RR 轮询通道的方式将DDR 中的
DCP 搬移到FIFO 内。
当CPU 写入新的Receive DCP，并且更新通道的DCP_WPTR[n]，PIE 通过检测
DCP_WPTR[n]与DCP_RPTR[n]的差判断DDR 是否有DCP 需要搬移，当FIFO 未满，并
且轮询到通道n，即将DDR 的Receive DCP 搬移到FIFO，加速接收报文。
PIE 当前接收通道M的报文，如果对应的DCP FIFO 将空，PIE 在完成当前通道的DCP 搬
移FIFO 后将直接指向通道M，开始通道M的Receive DCP 搬移到FIFO 操作。
5.12.6.10 Backpressure and Drop
收包支持反压和丢弃2 种情况:
反压：
（1） 如果配置为反压，根据从EPS 接收的通道号从对应的RX 描述符中读取收包描述
符为空，则反压EPS 模块。直到能获取新的RX 描述符。
（2） EPS 有包数据写入PIE，但是PIE 中的CPURX_FIFO 满，则整体反压EPS 模块。
丢弃：
（1） 如果配置为丢弃，EPS 中某队列有数据输入PIE，但是PIE 中对应的队列描述符无
效，则丢弃该队列的包数据。
SD5182HV100 Functional Specification Page 403 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
（2） 收Jumbo包，判断当前的描述符个数不足以收取当前Jumbo包，丢包。
（3） 多次收包遇到超长包丢弃：如果多次收包的包长大于分配的Buff_size的长度，丢包。并且丢包统计加一。
5.12.6.11 All In One Receive Packet
根据配置，收包可以选择按通道号入队或者全部进入单一队列。进入单一队列只是进入通道0队列。
5.12.7 Descriptor Ring instruction
发送方向单次发包描述符有DD域，软件写1，逻辑写0，软件可使用DD域管理发包描述符环形队列，但依然需要配置各通道描述符指针信息供逻辑发包使用。分片报文发包描述符无DD域，因此软件只能使用指针管理描述符队列。
接收方向描述符有DD域，软件写1，逻辑写0，软件可使用DD域管理发包描述符环形队列，但依然需要配置各通道描述符指针信息供逻辑收包使用。
5.12.8 RX /TX Interruption and Queue Priority
5.12.8.1 RX Interruption and Queue Priority
PIE 8个收包队列的优先级由前级模块处理，PIE串行收包，所以8个收包队列的无优先顺序。8个收包通道都有独立的收包中断和中断模式、参数配置，支持如下四种中断模式：（软件可以实时动态 更改中断模式，不影响中断上报功能）
1、普通单次收包中断：每完成一次收包，回写描述符成功就上报中断；
2、有包中断：
单次收包：只要这个收包队列中有包需要软件读取，就持续上报中断，除非软件把收包队列读空，或者软件屏蔽这个中断；
分片报文收包：只要这个收包队列中有分片报文需要软件读取，就持续上报中断，除非软件把收包队列读空，或者软件屏蔽这个中断；
3、收包周期中断：只要收包队列中有包需要软件读取，就周期上报中断（根据软件配置的上报周期，从而可以控制中断的频度）；
4、多次收包中断：每收N个报文或者N个分片报文才上报一次中断，另外如果收包队列中有包需要软件读取，还有timeout机制周期性中断提醒软件，防止中断丢失/遗漏；
5.12.8.2 TX Interruption and Queue Priority
PIE 8个发包队列优先级支持SP+WRR（SP :绝对优先调度，WRR:加权轮询调度）调度可配。优先级配置寄存器为SP_SCH_PRE（地址：0X0240），SP调度时，优先级顺序如下：
SD5182HV100 Functional Specification Page 404 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
队列15>…队列3>队列2>队列1>队列0>。权重配置寄存器为PRISCH_WEIGH（地址：0X0224）。8个发包队列支持多次发包中断，当中断阈值配置为1即为单次发包中断。
5.12.9 DDR Accessing
5.12.9.1 Big-endian and Little-endian Configure
CPU在DDR中存取报文时，存在大小端模式两种方式；而报文在出芯片后，肯定是大端模式（网络序）。PIE可以根据CPU在DDR中存取报文的大小端模式做相应转换。
（1） 大小端
CPU配置endian_cfg寄存器，作为CPU在DDR中存取报文位序的指示。
假设需要发送一个以太报文，其数据格式是：AABB_CCDD_EEFF_0102_0304_0506_8081_8283_8485_......
CPU默认以32bit为单位存取报文净荷，如果是大端模式的CPU，默认写入DDR的格式是：
地址 0 1 2 3
0000_A000
AA
BB
CC
DD
0000_A004
EE
FF
01
02
0000_A008
03
04
05
06
0000_A00C
80
81
82
83
那么AXI读出的数据是：02_01_FF_EE_DD_CC_BB_AA……
PIE需要在64bit内部，按照字节完成大小端的转换，才能转换成AABB_CCDD_EEFF_0102的正确的格式。
如果是小端模式的CPU，默认写入DDR的格式是：
地址 0 1 2 3
0000_A000
DD
CC
BB
AA
0000_A004
02
01
FF
EE
0000_A008
06
05
04
03
0000_A00C
83
82
81
80
那么AXI读出的数据是（AXI总线是64bit位宽）：EE_FF_01_02_AA_BB_CC_DD……
PIE需要将高32bit和低32bit对调，才能转换成AABB_CCDD_EEFF_0102的正确的格式。
（2） 填充
SD5182HV100 Functional Specification Page 405 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
如果包长不是4 的整数倍，例如以太报文其数据格式是：AABB_CCDD_EEFF_0102_0304
如果是小端模式的CPU，写入DDR 的格式是：
地址 0 1 2 3
0000_A000 DD CC BB AA
0000_A004 02 01 FF EE
0000_A008 xx xx 04 03
xx 代表软件必须填充的字节。
（3） 描述符部分也支持大小端配置，配置寄存器为dcp_endian_cfg，PIE 默认按照小端
模式处理。
5.12.9.2 Cacheline 32B
PIE 逻辑支持任意字节对齐的收发缓冲区，按Cacheline（32B）对齐方式访问DDR。
根据ACP（Accelerating Coherence Port）的总线行为分析，采用 64 位BURST4 读写操作
，首地址按照 Cache-Line（32B）对齐访问DDR，读写效率最高。
任意字节对齐的收发缓冲区指的是配置报文接收/发送缓冲区指针，可以是任意DDR 的地
址，PIE 自动补充无效数据，按照Cacheline（32B）对齐方式访问DDR。
如下图所示，指定报文接收/发送缓冲区指针为9000_A029，实际按照9000_A020 地址开
始按照Cacheline（32B）对齐方式访问DDR。
9000_A020
9000_A040
9000_A060
9000_A080
9000_A029
Figure 5.12-5 Cacheline 32B
5.12.9.3 Mastet ID
PIE 访问DDR 区域时，数据分为3 种类型：tx descriptor、rx descriptor、帧净荷，共对应
3 个Master id，如下表所示：
SD5182HV100 Functional Specification Page 406 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
读写操作
映射Master ID
收包读描述符
0
发包读描述符
1
发包读净荷
2
收包写描述符
0
发包写描述符
1
收包写净荷
2
5.12.9.4 AXI Abnormal Process
PIE 访问DDR可能出现的异常包含访问错误和访问超时2种。一般访问出错都是因为访问了不存在的地址；当DDR地址空间被映射至片外主控CPU的外挂DRAM，读写的latency非常大时，可能会出现访问超时。
对于访问出错PIE提供了中断寄存器可查询，区分读错误和写错误。同时提供错误具体类型寄存器可查（地址：0x0014）。
对于访问超时，PIE提供位宽16bit单位为1us的超时阈值配置寄存器(0x0000)。当使用片内主控CPU时推荐阈值配置为10us；当使用片外主控CPU的外挂DRAM时，推荐阈值配置为1ms。同时提供具体访问超时类型供参考（地址：0x0014）.
5.12.10RX/TX Statistic
1、 PIE_RX_STS
基于逻辑通道的接收计数器表项，CHn通道的基地址是0x20×n，然后其表项地址＝基地址＋下述偏移地址。 Addr Field Width Description
0x00
rx_pkt_cnt
39:0
接收包个数统计
0x01
rx_byte_cnt
39:0
接收包字节统计
0x02
rx_uc_pkt_cnt
39:0
接收单播包个数统计
0x03
rx_uc_byte_cnt
39:0
接收单播包字节数统计
0x04
rx_mc_pkt_cnt
39:0
接收多播包个数统计
0x05
rx_mc_byte_cnt
39:0
接收多播包字节数统计
0x06
rx_bc_pkt_cnt
39:0
接收广播播包个数统计
SD5182HV100 Functional Specification Page 407 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
0x07
rx_bc_byte_cnt
39:0
接收广播包字节数统计
0x08
rx_slice_pkt_cnt
39:0
接收切片包个数统计
0x09
rx_slice_byte_cnt
39:0
接收切片包字节统计
0x0A
rx_drop_pkt_cnt
39:0
接收描述符不足丢包，包个数统计
0x0B
rx_drop_byte_cnt
39:0
接收描述符不足丢包，包字节统计
0x0C
drop_err_pkt_cnt
39:0
接收通过不回写描述符丢弃前级模块输入的错包，包个数统计
0x0D
drop_err_byte_cnt
39:0
接收通过不回写描述符丢弃前级模块输入的错包，包字节统计
Table 5.12-3 PIE_RX_STAT表数据结构说明
2、 PIE_TX_STS
基于逻辑通道的发送计数器表项，CHn通道的基地址是0x20×n，然后其表项地址＝基地址＋下述偏移地址。 Addr Field Width Description
0x00
stx_ch0_pkt_cnt_
39:0
从TX Descriptor侧的统计发送包个数统计
0x01
stx_ch0_byte_cnt
39:0
从TX Descriptor侧的统计发送包字节数统计
0x02
stx_ch0_uc_pkt_cnt
39:0
发送单播包个数统计
0x03
stx_ch0_uc_byte_cnt
39:0
发送单播包字节数统计
0x04
stx_ch0_mc_pkt_cnt
39:0
发送多播包个数统计
0x05
stx_ch0_mc_byte_cnt
39:0
发送多播包字节数统计
0x06
stx_ch0_bc_pkt_cnt
39:0
发送广播包个数统计
0x07
stx_ch0_bc_byte_cnt
39:0
发送广播包字节数统计
Table 5.12-9 PIE_RX_STAT表数据结构说明
5.12.11低功耗功能
 不支持。
5.12.12DFx功能
 支持各FIFO的上下溢Debug寄存器，详见《SimgaHomeV100 PIE REG》。
SD5182HV100 Functional Specification Page 408 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5.12.13RAM奇偶校验
 不支持。
5.12.14PIE相关复位要求
 PIE不允许进行动态配置。
 在PIE复位之后，LSW（DP+PFE）需要同时进行复位；PIE复位撤离之后，需要先完成PIE的配置，再撤离LSW（DP+PFE）。
PIE RX pkt_info长度支持8、16、24B，通过全局寄存器pie_rx_pkt_info_len[1:0]配置，PSA、DP（EQM、EPS）等模块通过这个配置，获知PIE RX方向pkt_info长度，进行数据的添加、提取、计算等操作。
考虑到PIE模块的CBB化等因素，PIE模块内部需要独立的rx_pkt_info_len配置，软件需要确保这两个配置一致。
SD5182HV100 Functional Specification Page 409 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
6 PROGRAMMABLE SEARCH-ACTION SUB-SYSTEM DESCRIPTION
This is for the L1 Heading style purpose; the block level owner should ignore this level.
SD5182HV100 Functional Specification Page 410 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
7 EMBEDED CONTROL PLANE SUB-SYSTEM DESCRIPTION
This is for the L1 Heading style purpose; the block level owner should ignore this level.
SD5182HV100 Functional Specification Page 411 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
7.1 INTERNAL CONTROL SUB-SYSTEM (ICSS)
ICSS是读写源设备（CPU）对目标设备（内部寄存器、RAM）做读写操作的桥梁。根据读写源设备送来的控制信号产生读写目标设备的片选，读写，数据总线，地址总线信号，完成对目标设备的操作。
7.1.1 The main features of ICSS
 支持内部CPU访问内部逻辑寄存器和RAM；
 ICSS通过AHB SLAVE接口挂在AXI_PERI总线上，仅支持single操作；
 汇聚各个模块送上来的中断，上报给中断控制器GIC；
 MDIO；
 TOP CFG，提供全局配置。
7.1.2 Terminology
The following terms have special meanings in this section.
Term Description
Burst
A set of uninterrupted accesses to contiguous 32-bit words.
ICSS
Internal Control Sub-System
ECS
Embedded CPU Sub-system
RR
Round-Robin
Table 7.1-1 Control Plane Access Terminology
SD5182HV100 Functional Specification Page 412 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
7.1.3 Access to Registers and Memories
ECS 访问寄存器和RAM 示意图如下所示：
Internal Control
Sub-System
(ICSS)
........
PSA & DP & ITF & TOP
COP
QUARK
PSA
AXI AHB
... ...
Embedded CPU
Sub-system
(ECS)
AXI_PER
CPU
MASTER SLAVE
MASTER
Figure 7.1-1 配置空间访问 图
SD5182HV100 Functional Specification Page 413 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
1. ECS 访问内部寄存器和RAM 时，ECS 作为master，发送读写命令，ICSS 作为slave，
接收命令，根据地址进行译码，选择操作对应的寄存器和RAM。
2. PSA 访问内部寄存器和RAM 时，PSA 作为master，发送读写命令，ICSS 作为slave，
接收命令，根据地址进行译码，选择操作对应的寄存器和RAM。
3. 访问保留地址时的异常处理：
对芯片内部的保留地址空间进行读操作时，ICSS 将返回“读成功”标志，并且读出
数据为全“0”。
对芯片内部的保留地址空间进行写操作时，ICSS 不会将数据写入到内部，会返回“
写成功”的标志。
访问超时机制，ICSS 超时自动返回，保证不会挂死，超时以ms 为单位可配，支持超
时地址可记录。
7.1.4 Wide Register and Wide Memories Accesses
在SD5182 中，寄存器和RAM 的访问必须以32bit 对齐的。
操作宽度大于32bit 的寄存器和RAM 时，读写源设备必须产生连续的32bit 操作，地址从
低位到高位，来完成此类操作。即访问N bit 宽度的RAM 时，需连续产生N/32（N 能整
除32）或者N/32+1（N 不能整除32）次32bit 操作，来完成访问。
如下图所示，CPU 访问68bit 宽度的RAM，访问起始地址为0 时，需CPU 连续访问地址
0、4、8，完成对RAM的一次访问。访问起始地址为12 时，需连续访问12、16、20，完
成该次访问。
不按照上述操作可能会引起表项读写错误。
........
4
4
4
32
32
32
32
32
32
0
12
24
start addr
68
Figure 7.1-2 超宽表项访问示意图
7.1.5 Control Plane Memory Maps
根据芯片地址分配方案，芯片总共4GByte 空间分配如下：
SD5182HV100 Functional Specification Page 414 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Table 7.1-2 SD5182H地址空间分配表
SD5182HV100 Functional Specification Page 415 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
业务处理的逻辑寄存器和RAM的地址分配空间为0x1100_0000~0x14ff_ffff。空间共64MByte。具体分配如下：
Table 7.1-3 SD5182业务地址空间分配表
起始地址
结束地址
容量（byte）
内容说明
实际使用地址位宽
0x1100_0000
0x1107_FFFF
512K
DP_GLB
19
0x1108_0000
0x110F_FFFF
512K
IPS
19
0x1110_0000
0x1117_FFFF
512K
FAM
19
0x1118_0000
0x111F_FFFF
512K
PE
19
0x1120_0000
0x1127_FFFF
512K
EQM
19
0x1128_0000
0x112F_FFFF
512K
EPS
19
0x1130_0000
0x1137_FFFF
512K
MEMP
19
SD5182HV100 Functional Specification Page 416 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
起始地址
结束地址
容量（byte）
内容说明
实际使用地址位宽
0x1138_0000
0x113F_FFFF
512K
PRBS
19
0x1140_0000
0x1147_FFFF
512K
HA
19
0x1148_0000
0x114F_FFFF
512K
PQM
19
0x1150_0000
0x117F_FFFF
3M
RSVD
0x1180_0000
0x118F_FFFF
1M
MEMP RAM
20
0x1190_0000
0x11FF_FFFF
7M
RSVD
0x1200_0000
0x121F_FFFF
2048K
QUARK(含QUARK、OE、IMEM)
21
0x1220_0000
0x1227_FFFF
512K
RSVD
19
0x1228_0000
0x122F_FFFF
512K
RSVD
19
0x1230_0000
0x126F_FFFF
4M
COP（含COP TLE IMEM）
22
0x1270_0000
0x13FF_FFFF
21M
RSVD
0x1400_0000
0x1407_FFFF
512K
ITF_GLB
19
0x1408_0000
0x140F_FFFF
512K
GMAC
19
0x1410_0000
0x1417_FFFF
512K
EMAC
19
0x1418_0000
0x141F_FFFF
512K
IPS_PON
19
0x1420_0000
0x1427_FFFF
512K
EPS_PON
19
0x1428_0000
0x142F_FFFF
512K
SERSES_IF
19
0x1430_0000
0x1437_FFFF
512K
GE MAC0/ RSVD
19
0x1438_0000
0x143F_FFFF
512K
GE MAC1/RSVD
19
0x1440_0000
0x1447_FFFF
512K
GE MAC2/RSVD
19
0x1448_0000
0x144F_FFFF
512K
GE MAC3/RSVD
19
0x1450_0000
0x1457_FFFF
512K
GE MAC4(RGMII)
19
SD5182HV100 Functional Specification Page 417 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
起始地址
结束地址
容量（byte）
内容说明
实际使用地址位宽
0x1458_0000
0x145F_FFFF
512K
GE MAC5(PCIE重用, 其中后半段地址为PCS地址）
19
0x1460_0000
0x1467_FFFF
512K
MDIO0
19
0x1468_0000
0x146F_FFFF
512K
MDIO1
19
0x1470_0000
0x1477_FFFF
512K
RSVD
19
0x1478_0000
0x147F_FFFF
512K
XGMAC
19
0x1480_0000
0x1487_FFFF
512K
XGEMAC
19
0x1488_0000
0x148F_FFFF
512K
CRG
19
0x1490_0000
0x1497_FFFF
512K
TOP_IOMUX
19
0x1498_0000
0x149F_FFFF
512K
LSWGLB
19
0x14A0_0000
0x14A7_FFFF
512K
TIME_STP
19
0x14A8_0000
0x14AF_FFFF
512K
PONLINK
19
0x14B0_0000
0x14B7_FFFF
512K
RSVD
19
0x14B8_0000
0x14BF_FFFF
512K
RSVD
19
0x14C0_0000
0x14C8_FFFF
512K
RSVD
19
0x14B8_0000
0x14FF_FFFF
6.5M
RSVD
19
0x14C0_0000
0x14C7_FFFF
512K
AVFS
0x14C8_0000
0x14CF_FFFF
512K
RSVD
19
0x14D0_0000
0x14D7_FFFF
512K
RSVD
19
0x14D8_0000
0x14DF_FFFF
512K
GE MAC8(后半段地址为PCS地址）
19
0x14E0_0000
0x14FF_FFFF
2M
RSVD
19
7.1.6 Interrupts
表2 SD5182V100S 中断请求分配表
中断号
中断源
中断信号
IRQ中断
FIQ中断
32
nmi_tsensor_int
过温NMI中断
-
FIQ
SD5182HV100 Functional Specification Page 418 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
中断号
中断源
中断信号
IRQ中断
FIQ中断
33
nmi_dying_gasp_int
Dying gasp中断
-
FIQ
34
nmi_wdg_int
Watch dog中断
-
FIQ
35
保留
保留
不涉及
不涉及
36
保留
保留
不涉及
不涉及
37
保留
保留
不涉及
不涉及
38
保留
保留
不涉及
不涉及
39
保留
保留
不涉及
不涉及
40
保留
保留
不涉及
不涉及
41
保留
保留
不涉及
不涉及
42
保留
保留
不涉及
不涉及
43
hw_msif_int
HW msi中断
IRQ
44
a9_parity_int
A9 parity错误中断
不涉及
不涉及
45
保留
保留
不涉及
不涉及
46
保留
保留
不涉及
不涉及
47
保留
保留
不涉及
不涉及
48
保留
保留
不涉及
不涉及
49
保留
保留
不涉及
不涉及
50
保留
保留
不涉及
不涉及
51
保留
保留
不涉及
不涉及
52
保留
保留
不涉及
不涉及
53
保留
保留
不涉及
不涉及
54
保留
保留
不涉及
不涉及
55
保留
保留
不涉及
不涉及
56
保留
保留
不涉及
不涉及
57
保留
保留
不涉及
不涉及
SD5182HV100 Functional Specification Page 419 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
中断号
中断源
中断信号
IRQ中断
FIQ中断
58
保留
保留
不涉及
不涉及
59
保留
保留
不涉及
不涉及
60
ddrc_err_int
MDDRC 错误中断
IRQ
-
61
zsp2arm_int1
ZSP上报A9中断1
IRQ
-
62
zsp2arm_int2
ZSP上报A9中断2
IRQ
-
63
zsp2arm_int3
ZSP上报A9中断3
IRQ
-
64
COMMTX[0]
CPU0数据发送满中断
IRQ
-
65
COMMRX[0]
CPU0数据接收满中断
IRQ
-
66
L2_INT_COMB
L2 中断
IRQ
-
67
保留
保留
不涉及
不涉及
68
保留
保留
不涉及
不涉及
69
zsp2arm_int0
ZSP上报A9中断0
IRQ
-
70
usb_ohci_int
USB2 OHCI 中断
IRQ
-
71
usb_ehci_int
USB2 EHCI 中断
IRQ
-
72
fmc_int
fmc中断
IRQ
-
73
保留
保留
不涉及
不涉及
74
保留
保留
不涉及
不涉及
75
保留
保留
不涉及
不涉及
76
i2c0_int
I2C0中断
IRQ
-
77
uart0_int
UART0中断
IRQ
-
SD5182HV100 Functional Specification Page 420 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
中断号
中断源
中断信号
IRQ中断
FIQ中断
78
uart1_int
UART1中断
IRQ
-
79
timer01_int
TIMER01中断
IRQ
-
80
timer23_int
TIMER23中断
IRQ
-
81
gpio0_int
GPIO0中断
IRQ
-
82
gpio1_int
GPIO1中断
IRQ
-
83
保留
保留
不涉及
不涉及
84
保留
保留
不涉及
不涉及
85
保留
保留
不涉及
不涉及
86
保留
保留
不涉及
不涉及
87
保留
保留
不涉及
不涉及
88
保留
保留
不涉及
不涉及
89
保留
保留
不涉及
不涉及
90
dmac_int1
DMAC中断
IRQ
-
91
pcie0_radm_inta
PCIe0传统中断a
IRQ
-
92
pcie0_radm_intb
PCIe0传统中断b
IRQ
-
93
pcie0_radm_intc
PCIe0传统中断c
IRQ
-
94
pcie0_radm_intd
PCIe0传统中断d
IRQ
-
95
保留
保留
不涉及
不涉及
96
保留
保留
不涉及
不涉及
97
保留
保留
不涉及
不涉及
98
保留
保留
不涉及
不涉及
99
PMUIRQ[0]
CPU0 PMU中断
IRQ
-
100
sci_intr
SCI中断
IRQ
-
SD5182HV100 Functional Specification Page 421 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
中断号
中断源
中断信号
IRQ中断
FIQ中断
101
pcie0_link_down_int
PCIe0链路断开中断
IRQ
-
102
保留
保留
不涉及
不涉及
103
pcie0_pm_int
PCIe0低功耗退出中断
IRQ
-
104
保留
保留
不涉及
不涉及
105
pcie0_msi_ctrl_int
PCIe0消息中断
IRQ
-
106
保留
保留
不涉及
不涉及
107
ssi1_intr
SPI1中断
IRQ
-
108
保留
保留
不涉及
不涉及
109
保留
保留
不涉及
不涉及
110
保留
保留
不涉及
不涉及
111
arm_1ms_int
HW中断
IRQ
-
112
arm_10ms_03_int
HW中断
IRQ
-
113
arm_10ms_02_int
HW中断
IRQ
-
114
arm_10ms_01_int
HW中断
IRQ
-
115
arm_10ms_1_int
HW中断
IRQ
-
116
arm_10ms_0_int
HW中断
IRQ
-
117
保留
保留
不涉及
不涉及
118
保留
保留
不涉及
不涉及
119
pie_int[0]
PIE中断
IRQ
-
120
pie_int[1]
PIE中断
IRQ
-
121
pie_int[2]
PIE中断
IRQ
-
122
pie_int[3]
PIE中断
IRQ
-
123
pie_int[4]
PIE中断
IRQ
-
124
COP_AGE_INT
COP老化中断
IRQ
-
SD5182HV100 Functional Specification Page 422 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
中断号
中断源
中断信号
IRQ中断
FIQ中断
125
COP_EM_INT
COP EM中断
IRQ
-
126
COP_ECC_INT
COP ECC中断中断
IRQ
-
127
保留
保留
不涉及
不涉及
128
ZSI_INT
ZSI中断
IRQ
-
129
CRG_INT
W DG中断
IRQ
-
130
PRBS_ INT
PRBS中断
IRQ
-
131
EQM_INT
EQM中断
IRQ
-
132
PQM_INT
PQM中断
IRQ
不涉及
133
保留
保留
IRQ
134
XPON_LP_INT
PON低功耗中断
IRQ
-
135
RSVD
预留整芯片使用
IRQ
-
136
EPS_PON_INT
EPS_PON中断
IRQ
-
137
保留
保留
IRQ
-
138
保留
保留
不涉及
不涉及
139
保留
保留
不涉及
不涉及
140
EMAC_INT
EMAC中断
IRQ
-
141
GMAC_INT
GMAC中断
IRQ
-
142
ROUGUE_ONU_INT
流氓onu中断
IRQ
-
143
SILENT_ONT_INT
静默onu中断
IRQ
-
144
XPON_AWAKE_INT
pon的awake中断
IRQ
-
145
TOP_IOMUX_INT(LED 扩展中断)
LED 扩展中断
IRQ
-
146
GE MAC0
gemac0上报的mpi访问中断
IRQ
-
SD5182HV100 Functional Specification Page 423 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
中断号
中断源
中断信号
IRQ中断
FIQ中断
147
GE MAC1
gemac1上报的mpi访问中断
IRQ
-
148
GE MAC2
gemac2上报的mpi访问中断
不涉及
不涉及
149
GE MAC3
gemac3上报的mpi访问中断
不涉及
不涉及
150
GE MAC4
Gemac4上报的mpi访问中断
不涉及
不涉及
151
GE MAC5
Gemac5上报的mpi访问中断
不涉及
不涉及
152
MDIO0_INT
MDIO0中断
不涉及
不涉及
153
MDIO1_INT
MDIO1中断
不涉及
不涉及
154
PHY_INT0
GEPHY0 中断
IRQ
-
155
PHY_INT1
GEPHY1 中断
IRQ
-
156
PHY_INT2
GEPHY0 中断
不涉及
不涉及
157
PHY_INT3
GEPHY1 中断
不涉及
不涉及
158
保留
保留
不涉及
不涉及
159
保留
保留
不涉及
不涉及
160
保留
保留
IRQ
-
161
DP_ECC_INT
DP的ECC中断输出
不涉及
不涉及
162
保留
保留
不涉及
不涉及
163
保留
保留
不涉及
不涉及
164
保留
保留
不涉及
不涉及
165
XGMAC_INT
不涉及
不涉及
166
保留
保留
不涉及
不涉及
167
XGEMAC_INT
不涉及
不涉及
168
保留
保留
不涉及
不涉及
SD5182HV100 Functional Specification Page 424 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
中断号
中断源
中断信号
IRQ中断
FIQ中断
169
TMS_INT(17M)
TMS模块的中断
IRQ
-
170
PCS_8_INT
NNI PCS中断
IRQ
-
171
PCS_5_INT
PCIE GE PCS中断
IRQ
不涉及
172
保留
保留
不涉及
不涉及
173
保留
保留
不涉及
不涉及
174
保留
保留
不涉及
不涉及
175
PON_SDS_IF_INT
PON_SDS_IF中断
IRQ
-
176
CPU_AVFS_INT
不涉及
不涉及
177
保留
预留整芯片使用
不涉及
不涉及
178
保留
预留整芯片使用
不涉及
不涉及
179
保留
预留整芯片使用
不涉及
不涉及
180
保留
预留整芯片使用
不涉及
不涉及
181
保留
预留整芯片使用
不涉及
不涉及
182
保留
保留
不涉及
不涉及
183
GE MAC8
Gemac5上报的mpi访问中断
不涉及
不涉及
184
cop_int
COP中断。
IRQ
不涉及
185
quk_oe_int
QUK OE中断。
IRQ
不涉及
186
quk_fp_int
QUK FP中断。
IRQ
不涉及
187
quk_ep_int
QUK EP中断。
IRQ
不涉及
188
quk_ap_int
QUK AP中断。
IRQ
不涉及
189
保留
预留整芯片使用
IRQ
-
190
保留
预留整芯片使用
IRQ
-
191
保留
预留整芯片使用
IRQ
-
SD5182HV100 Functional Specification Page 425 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
SD5182 内置ECS 子系统，所有中断汇聚到GIC（General interrupt controller），对于重要
业务中断，直连GIC。
SD5182 其他中断（如ECC 中断）采用多级中断，每级中断都可屏蔽，是否屏蔽中断可通
过CPU 进行配置。
SD5182 的中断树分为3 级，如下所示：
PSA
GIC一级中断
DP
IPS模块中断
一级中断
二级中断
INT&MASK
三级中断
INT&MASK
PIE模块中断
TCAM模块中断
SRAM模块中断
EMSC
三级中断结构
MAC业务中断
EPS模块中断
PE模块中断
ITF
XGMAC模块中断
XGMAC模块中断
5*GEMAC
Figure 7.1-3 SD5182 业务中断分配示意 图
SD5182HV100 Functional Specification Page 426 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
7.1.7 MDIO
MDIO（Management Data Input/Output）提供了对外部PHY芯片的访问方式。通过MDIO接口可以实现对外部PHY芯片的管理，如配置PHY的工作模式，获取PHY的工作状态、各种参数等。
SD5182的MDIO支持如下特性：
 支持2套MDIO接口，1组控制外部PHY，1组控制集成PHY；
 每套MDIO支持32个PHY地址（5bit地址编码）；
 支持三种访问模式：单次访问模式/单次扫描模式/自动扫描模式；
 自动获取PHY信息；
 支持自动扫描，支持扫描ID顺序和序号可配置，支持MDIO轮询地址可配；
 MDC频率范围可配(<10MHz)；
CPU对PHY的读/写操作均通过间接访问方式实现，即CPU将需要被访问的PHY地址（PHYID）、需要被访问的PHY芯片内部的寄存器地址（REGID）、操作类型（读或写）及需要写入PHY的数据配置在MDIO相应的寄存器中，通过MDIO去“间接”完成对某个PHY中的某个寄存器的访问。MDIO完成对PHY的访问后，通过下述两种方式通知CPU来获取访问结果。
 中断方式
 CPU轮询方式
7.1.8 TOP_CFG全局配置
SD5182HV100 Functional Specification Page 427 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
提供全局配置，包括一下几个方面：
各个接口复用模式选择配置寄存器；
ARM启动MEM BIST控制寄存器；
基准脉冲配置寄存器，芯片内部CAR、Shapping等模块需要基准脉冲做时间计数；
临终遗言配置寄存器；
低功耗控制寄存器；
部分时钟、时序控制寄存器；
7.1.9 寄存器类型
类型 功能说明
RW
可读可写
RO
只读，不可写
RC
读清零
RWCI
可读，内部功能模块对其提供脉冲进行加1操作，写全零清零。
RWCN
可读，内部功能模块对其提供脉冲进行加N操作，写全零清零。
RWC
CPU写0清0，逻辑置1，CPU写1无效。
RWS
CPU写1置1，逻辑清0，CPU写0无效。
RWCC
CPU写1清0，逻辑置1。可用于生成中断状态寄存器。
RWSC
CPU写1置1，写0清0，逻辑清0。
RONI
只读，子模块不必对其提供输入，一般用于版本寄存器。
ROU
只读，可根据逻辑提供的增减脉冲自动计数，一般用于内部资源计算
SD5182HV100 Functional Specification Page 428 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
RCI
读清零＋递增，CPU读取后寄存器清零，内部功能模块对其提供脉冲进行加1操作。
SD5182HV100 Functional Specification Page 429 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8 CLK INTRODUCTION
本章描述芯片时钟结构，用以指导CRG设计、验证和应用。
8.1 TERMINOLOGY Term Description
PLL
Phase-Locked Loop，锁相环。 将芯片输入的高稳定度的晶振时钟倍频到内部逻辑使用的高频时钟。
Table 8.1-1 Clocking Terminology
8.2 CLOCK OVERVIEW
芯片外接一个单端时钟晶振参考源，兼容双端晶振，频点为40MHz。内部连接一个内置CMU的SerDes和5个SC PLL。SerDes内置的CMU接收管脚输入时钟并产生xPON参考时钟。CMU产生的SerDes差分参考时钟频率为156.25/155.52MHz。
内部集成5个SC PLL，分别支持不同partition的时钟频点需求。
下图所示，为5182时钟结构图，下面将详细描述每个时钟域的功能和规格。
SD5182HV100 Functional Specification Page 430 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
40MHz
4GEPHY
NNI SDS
（2CMU 1CS1DS1SS）
xPON MAC、
GE MAC的接
收、发送、工
作时钟域
xpon_sys_clk
sds_tx_clk
GE MAC
ECS时钟域
PSA时钟域
TCK
25MHz JTAG时钟域
SD5182
LSW PLL
25MHz
125MHz
A9 CORE
CPU PLL
DDR PLL
1000/1200MHz
clk_apb
clk_axi
DDRC
425/533MHz
DDRPHY
CMU
clk_ahb
Osc /div2
RCD
DIV8
40/25MHz diff
HW
4倍频
sds_rxo_clk
Div FRAC
49.152MHz
clk_lsw_500m
sds_rxo_clk
DIVn
时钟模块
8K 25MHz
DIVn
dft_clk
osc_clk
100MHz USB CTRL
COMB PLL
DP时钟域
500MHz
Clk_ecs_166m
LSW PLL 1GHz
2GHz
PCIE
100MHz
PCIE PLL
CombPHY
125MHz
LSW125MHz
DIV2
DIV10
DIV3/4
DIV5
ELIM
2GHz
DIV4/5
FIX 500M
500MHz
DIV2 ELIM
clk_dp
clk_dp_root
DIV2
1GHz
clk_xpon_sys
DIV2
ELIM
sec DIV3
RGMII DIV2
clk_ecs_500m
DIV2
RGMII
FMC
1M/1US/
100US
SPI DIV12
IIC
DIV3
clk_ecs_250m DIV4
2GHz
500MHz DIV2
1GHz SDIO
DIV6 clk_zsp
Div FRAC clk_uart
DIV2
CombPHY
LSW 100M
DIV2
PCIE 100M
Figure 8.2-1 SD5182 CLK Block Diagram
芯片内部集成5 个SC PLL。分别为：CPU PLL、DDR PLL、Comb PLL（支持USB）、
PCIE PLL、LSW PLL。5 个PLL 均使用单板提供的40MHz 的晶振做为参考时钟。
SerDes 恢复时钟作为xPON MAC 的工作时钟，保证NNI 接口数据的正常收发。
为支持同步语音的应用，SerDes 恢复时钟同时经过数字倍频（GPON/EPON/GE 模式）后，
在通过小数分频，获得49.152MHz 的HW时钟，然后分频出不同语音类型。
SD5182HV100 Functional Specification Page 431 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
GEPHY参考时钟选择LSW PLL输出的125MHz再经过5分频后的25MHz时钟。
1588时间同步、同步以太模式下，SerDes恢复出线路时钟，分频产生8K时钟送到芯片管脚输出，单板通过板级时钟模块跟踪这个8K时钟实现时钟同步后，产生25MHz时钟输入给芯片，作为LSW PLL的参考源，倍频出2GHz时钟，然后分频产生25MHz同步时钟，作为GEPHY的同步时钟源。GEPHY也可以选择单板同步后输入的25MHz时钟作为参考时钟。
SD5182HV100 Functional Specification Page 432 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8.3 EXTERNAL INPUT CLOCKS
介绍芯片的输入时钟。 时钟 频率(MHz) 来源 用途
CLK_REF
40
单板晶振送出的本地时钟
用作芯片参考时钟
JTAG_TCK
25
测试时钟
JTAG测试时钟
Table 8.3-1 外部输入时钟
SD5182HV100 Functional Specification Page 433 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8.4 EXTERNAL OUTPUT CLOCKS
介绍芯片的输出时钟。 时钟 频率(Hz) 说明
CLK_OUT_8K
8K
XPON同步输出的8K时钟
DDR_CLK0_P/N
850/1066M
DDRPHY送出的接口时钟
SPI_CLK
25M
SPI 控制器送出的SPI接口时钟
PCIE0_REFCLK_P/N
100M
WiFi输出参考时钟
PCIE1_REFCLK_P/N
100M
WiFi输出参考时钟
SCL
3.4MHz
I2C接口时钟
HW_CLK
8.192MHz
语音接口时钟
SFC_CLK
62.5/50/31.25MHz
FMC PHY对外接口时钟
SD_CLK
200/100/50/25MHz
送出给片外存储的cclk_out不支持调相
RGMII_CLK
125MHz
RGMII输出的125MHz的GTX时钟
Table 8.4-1 输出到外部时钟
SD5182HV100 Functional Specification Page 434 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8.5 SC PLL
介绍CRG 模块使用到的通用PLL，不包含模拟IP（SerDes、DDRPHY）内部的PLL。模
拟IP 内的PLL 是通过模拟IP 内的寄存器来进行控制。
REFCLK
POSTDIV1
FOUTPOSTDIV
VCO
equal
frequency
FOUTVCO
POSTDIV2
dsmpd=0
dsmpd=1 fbdiv
（fbdiv+frac)
refdiv
CLK_VCO
Figure 8.5-1 PLL 功能结构图
红色字体表示PLL 的输入参考时钟、输出时钟
蓝色字体表示PLL 的配置参数
PLL 输出时钟的频率计算公式为如下：
当dsmpd=1，FOUTVCO=FREF/refdiv * fbdiv，整数分频模式
当dsmpd=0，FOUTVCO=FREF/refdiv * (fbdiv + frac)，小数分频模式
FOUTPOSTDIV=FOUTVCO/postdiv1/postdiv2
FOUT2= FOUTPOSTDIV/4
REFCLK 如果使用的是晶振时钟，则输入到PLL 的参考时钟为晶振时钟。
PLL 内部VCO 输出时钟频率FOUTVCO 的有效频率范围为900MHz～3200MHz。
注意：在进行分频系数配置时，需要先用postdiv1，再用postdiv2，即要postdiv1>=
postdiv2。原因是sc pll 28hpm的postdiv 第二级分频器，在某些极限条件下，不能工作到
3GHz 以上，直通（即postdiv2=1）时除外。所以要先用postdiv1 进行分频，先将频率降
下来。用户在PLL 应用时，请按照上表中的配置参数使用。
应用时，PLL 的频率只可在SLOW模式切换，且只能应用于文档中描述的配置。
SD5182HV100 Functional Specification Page 435 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8.6 CMU
CMU内置在SerDes里面，主要为SerDes的不同模式提供参考时钟，可配置寄存器选择SerDes工作在不同模式下的参考时钟频点。
下表列出不同场景下CMU的时钟输出频点：
工作模式 GPON XGPON EPON XEPON GE 2.5GE
时钟输出频率（MHz）
155.52
622.08
125
644.53125
125
312.5
SD5182HV100 Functional Specification Page 436 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8.7 CLOCK DOMAINS PER BLOCK/INTERFACE
文档中描述的时钟选择电路需要输出多选一时钟的，都统一做成无毛刺的频率切换，用扣
除高频时钟脉冲的方式来实现。
在有固定分频关系的同步时钟，要做到上升沿对齐。
文档时钟结构图中ELIM 模块含义为时钟消除模块，可以对时钟周期性去掉一些电平变化，
达到降频的目的。
图中不同的时钟域之间一般是异步关系，在CRG 设计，STA 分析中要注意区分。
8.7.1 ECS Sestem Clocking
芯片上电后， ECS 系统工作于芯片管脚输入的晶振时钟，待PLL 锁定后，软件通过配置
系统控制器，使ECS 系统工作于PLL 产生的时钟。
8.7.1.1 A9&L2 Source Clock Switch
系统上电后，软件通过配置系统控制器，可以使A9 和L2 的时钟源切换到A9 PLL 产生的
时钟。
A9
OSC CLK
A9 PLL(1/1.2GHz) MUX
A9 CLK 1G/1.2GHz)
ELIM
LSW PLL(1GHz)
Figure 8.7-1 SD5182 A9 时钟结构
A9 的工作时钟可以为1GHz 和1.2GHz，在切换时钟频点时，需要按照下面表格的配置步
骤正确完成。
在配置切换时钟频点前后，需要把时钟先切换为LSW PLL 送过来的1GHz 时钟，完成A9
PLL 配置后，在切换为A9 PLL 输出时钟。
A9 需要降功耗处理时，需要配置ELIM单元，可以使CPU 降到低频时钟运行。
A9 PLL 的调频配置模式：
SD5182HV100 Functional Specification Page 437 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
寄存器 调频配置步骤说明
avfs_bypass_en = 1
afs_en = 0
afs_mode=0
1、 将A9&L2时钟源切换到固定1GHz时钟；
2、 A9 PLL 下电。
3、 配置A9 PLL相关的分频参数；
4、 A9 PLL下电撤消。
5、 等待LOCK信号为高切换时钟源到A9 PLL时钟。
6、 需要再次配置时，重复此配置过程。
8.7.1.2 ECS Sub_System Clocking ECS系统模式 A9 (MHz) L2 Cashe (MHz) AXI_ ACP (MHz) AXI_PERI (MHz) AHB， (MHz) APB, (MHz)
上电启动 20 20 6.66 6.66 5 2
CASE0 1000 (默认) 1000 (默认) 333 (默认) 333 (默认) 250 (默认) 100 (默认)
CASE1 1200 1200 333 333 250 100
Table 8.7-1 ECS系统时钟频率模式表
SD5182HV100 Functional Specification Page 438 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
DIV3/4
AHB
IPSec
ahb_clk 250/200MHz
DIV2
ZSP
166MHz
AXI
ACP/PERI
axi_clk 333/250MHz MUX
OSC CLK
Clk lsw 1g
DIV4/5
FMC
DIV8/
10/16
125/100/62.5MHz
DIV10 APB_BUS
DIV6
SDIO
DIV2
100MHz
SPI
UART
IIC
83MHz
100MHz
100MHz
ipsec_clk 333MHz
DIV3
ecs_clk
DIV12
DIV
frac
1GHz
2GHz
clk_lsw_2g
Clk pcie 1g
MUX
clk_pcie_2g
Figure 8.7-2 SD5182 ECS 时钟结构
SD5182HV100 Functional Specification Page 439 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8.7.1.3 USB Clocking
USB3.0 PHY USB2.0 PHY
USB3.0
Controller
USB2.0
Controller
DIV5
20MHz
125MHz 60MHz
COMB PLL(100MHz)
Figure 8.7-3 USB 接口时钟结构图
芯片集成一个USB2.0 和一个USB3.0。
USB2.0/3.0 控制器的AXI Master 和ACP 总线相连，使用ACP 总线时钟，通过同步桥进行
接口转换。
USB2.0/3.0 控制器的AHB Slaver 接口连接在PERI 总线上，主要用于内部寄存器访问，该
接口和AHB Master 使用相同的同钟。
USB3.0 的PHY 使用Synopsys Comb PHY，其参考时钟为PLL 分频出的100MHz 时钟。
USB2.0 的PHY 使用Synopsys PHY，其参考时钟为PLL 分频出的20MHz 时钟。
8.7.1.4 PCIE Clocking
PCIE PHY PCIE Ctrl
PCIE PLL(100MHz) 250MHz
Figure 8.7-4 PCIE 接口时钟结构图
芯片集成2 个PCIE 2.0 接口。PCIE 控制器通连接在ACP 总线上，其AXI Master 接口时
钟为ACP 总线时钟，频率为250MHz。
PCIE 控制器相关配置在APB 总线上，接口时钟为APB 总线时钟，频率为100MHz，该时
钟和其他时钟均为异步关系。
PCIE 控制器通过PIPE 接口和PHY 连接，PIPE 接口时钟为PHY 输出的250MHz 时钟，
该时钟和控制器内其他时钟为异步关系。
PCIE PHY 的参考时钟为本地PLL 分频得到的100MHz，该时钟要求满足PHY 对时钟的
抖动，频偏需求。
两个PCIEPHY 分别给出参考时钟。
SD5182HV100 Functional Specification Page 440 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8.7.1.5 PIE Clocking
AXI_ACP
DP
PIE
CLK_DP
CLK_ACP
Figure 8.7-5 PIE 模块时钟结构图
PIE 有两个时钟域，DP 接口时钟和AXI 总线接口时钟。DP 时钟域电路和IPS 及EPS 接口，
负责从DP 收发数据，总线时钟域进行与CPU 及DDR 之间的数据交换。
PIE 在ACP 总线上，PIE 的工作时钟及axi_mstr 接口工作在ACP 时钟域。
CRG 需要给PIE 提供2 个周期性脉信号： 100us、1us，这2 个周期性脉冲的时钟可以与
PIE 的时钟为异步关系，高脉宽大于100ns。
8.7.1.6 HW Clocking
ZSP
V500 MUX
SDS RX CLK
4x/2x
LSW PLL
(500MHz)
49.152MHz
MUX
Clk_hw_in
DIV
6~96
DIV
FRAC
MUX
DIV2
PCS
ZSI
ISI
Figure 8.7-6 HW接口时钟结构图
如上图所示，HW支持三种接口，分别是PCM，ZSI，ISI 接口。
HW的PCM接口支持8.192/4.096/2.048/1.024/0.512 Mbps 多种速率，如果输出接口为ISI
类型，要求PCM接口速率为2.048Mbps。因此49.152MHz 的分频给出的接口时钟时钟可
配置到不同频点，以支持多速率。同时要求支持PCM接口时钟来源于外接设备。
PCM/ZSI/ISI 接口可选择输出时钟，在CRG 通过接口模式配置将时钟通过MUX 后统一输
出，在ISI 模式下，接口输出时钟频率为24.576MHz。
ZSI 和ISI 接口模块的配置均通过SPI 接口完成。
SD5182HV100 Functional Specification Page 441 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
芯片需要支持同步语音，要求clk_hw_49m时钟来源可选择同步时钟源和本地时钟源，同
步同钟源使用SerDes 的线路恢复时钟源，在不同的模式下，先将SerDes 恢复时钟进行倍
频处理，再使用倍频时钟分频得到49.152MHz 时钟。
上行方向为GPON/EPON/GE 模式时，使用SerDes rx 时钟的4 倍频（或2 倍频）时钟；
2.5GE 模式以上时直接使用SerDes rx 时钟。
根据模式不同，选择不同的倍频时钟后，进行小数分频，获得49.152MHz 时钟，发送给
ZSPV500 使用。同时产生不同HW接口的输出时钟。
DIV FRAC 单元为小数分频器，根据输入时钟频点不同，配置的分频参数不同。具体参考
下面表格。
模式 速率 倍频 div_ftw div_max 输出时钟
GPON 155.52 2 128 405 49.152
XGPON 622.08 1 64 405 49.152
EPON/GE/SGMII 125 4 3072 15625 49.152
XGEPON 644.53125 1 131072 859375 49.152
2.5GE 312.5 1 24576 78125 49.152
LSW 500M 500 1 3072 15625 49.152
8.7.2 DDR Clocking
DDR PLL(425/533MHz) DDR PHY
16x2/16x1
MDDRC
CLK_DP
CLK_PSA
CLK_AXI
Figure 8.7-7 DDR 时钟结构图
DDR 有独立的PLL 提供时钟，初始化时时钟频点可配置。
DDR PLL 支持展频功能。
DDR 包括MDDRC 和DDRPHY 两部分，为同步时钟系统。MDDRC 需要响应来自DP，
PSA，ECS 系统的读写请求，MDDRC 与DP，PSA，ECS 处于不同的时钟域，在
MDDRC 需要进行异步时钟的隔离。
SD5182HV100 Functional Specification Page 442 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8.7.3 DP & PSA Clocking
PSA
DP
LSW PLL(1GHz)
ELIM
MUX
ELIM
1GHz MUX
CLK_DP_ROOT
CLK_PSA
PCIE PLL(1GHz)
1GHz
LSW PLL(1GHz)
PCIE PLL(1GHz)
DIV2
CLK_PSA_FIX_500M
CLK_TMS_500M
DIV2
DIV2
CLK_TMS_125M
CLK_DP_OCC
CLK_XPON_SYS_OCC MUX
DIV4
DIV6
MUX
LSW PLL(1GHz)
PCIE PLL(1GHz)
Figure 8.7-8 转发部分时钟结构图
DP 和PSA 构成芯片的转发系统。
PSA 主要工作时钟频率为500MHz，可编程NP lite 处理器。PSA 时钟支持扣脉冲操作，
在没有业务处理时，频率可以降低到1/8 频点。
DP 时钟主要工作频点为250MHz，同时需要一个500MHz 时钟。250MHz 和500MHz 时
钟需要做同步处理，保证相同相位。同样，DP 时钟也支持扣脉冲操作，支持芯片的低功
耗操作。
DP 和MAC 间的接口时钟为clk_xpon_sys_occ，此时钟正常工作时为250MHz，通过配置
可以调整时钟为166MHz，以降低功耗。
DP、PSA 周边模块有相互异步的时钟域，参考下图模块说明：
SD5182HV100 Functional Specification Page 443 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
XPON
MAC
DP时钟域:250MHz
PQM
IPS
GE
MAC
PIE
PRBS
H
IPS A
PON
COP AP OE EP
PE
EPS
MEMP
MDDRC
EQM
EPS
PON
GE
MAC
PIE
PRBS
XPON
MAC
FAM
PSA时钟域:500MHz
GE MAC时钟域:125/312.5MHz
XPON MAC时钟域:155.52/156.25MHz
ECS ACP总线时钟:333MHz
DDR时钟:533MHz
DP和MAC过渡时钟域:250MHz HA时钟:500MHz
TMS
TMS时钟域:500MHz
Figure 8.7-9 DP_PSA 异步接口示意图
8.7.4 NNI Clocking
NNI
SerDes
各种MAC
（含PCS的各
种编码转换）
rx_data_sds
tx_data_sds
rx_data_mac
tx_data_mac
ips_rx_data_mac
tx_eps_data_mac
IPS_PON
EPS_PON
SDS_IF
A接口B接口C接口
IPS
EPS
SD5182HV100 Functional Specification Page 444 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure 8.7-10 NNI MAC模块时钟示意图
MAC
A接口
B接口
C接口
TX
RX
TX
RX
TX
RX
GPON
1.24416G,
8bit@155.52MHz
2.48832G
16bit@155.52 MHz
1.24416G ，8bit@155.52MHz
2.48832G，16bit@155.52MHz
1.24416G ，32bit@250MHz
2.48832G，32bit@250MHz
XGPON
2.48832G,
16bit@155.52MHz
9.95328G
16bit@622.08MHz
2.48832G，16bit@155.52MHz
9.95328G，64bit@155.52MHz
2.48832G，32bit@250MHz
9.95328G，128bit@250MHz
NGPON
9.95328G
16bit@622.08MHz
9.95328G
16bit@622.08MHz
9.95328G，64bit@155.52MHz
9.95328G，64bit@155.52MHz
9.95328G，128bit@250MHz
9.95328G，128bit@250MHz
EPON
1.25G,
10bit@125MHz
1.25G,
10bit@125MHz
1.25G，10bit@125MHz
1.25G，10bit@125MHz
1G，16bit@250MHz
1G，16bit@250MHz
XEPON_S
10.3125G, 16bit@644.53125MHz
10.3125G, 16bit@644.53125MHz
10.3125G，64bit@161MHz
10.3125G，64bit@161MHz
10G
128bit@250MHz
10G
128bit@250MHz
XEPON_A
2.5G/1.25G,
10bit@250/125MHz
10.3125G,
16bit@ 644.53125MHz
2.5G/1.25G,
10bit@250/125MHz
10.3125G，64bit@161MHz
2.5G
128bit@250MHz
2.5G
128bit@250MHz
GE
1.25G/3.125G,
10 bit@ 125/312.5MHz
1.25G/3.125G,
10 bit@ 125/312.5MHz
1.25G/3.125G, 10 bit@125/312.5MHz
1.25G/3.125G, 10 bit@125/312.5MHz
1G/2.5G
32bit@250MHz
1G/2.5G
32bit@250MHz
Table 8.7-2 NNI侧时钟频率模式表
C接口采用独立于DP和MAC的时钟，频率为250MHz，主要目的是解决XPON系统在上行突发发送数据时，能够满足MAC的数据请求带宽。另外在转发部分整体动态低功耗状态下，这个接口的时钟保持常开状态，目的是在转发逻辑降功耗期间，能够保证ITF的数据环回功能能够正常操作和执行。
SD5182HV100 Functional Specification Page 445 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
NNI
SerDes
rxoclk
txoclk
XGPON发送接口电路
GPON接收接口电路
XEPON接收接口时钟
GE/2.5GE MAC接收接
口时钟
XGPON接收接口电路
622.08MHz
GPON发送接口电路
XEPON发送接口时钟
GE/2.5GE MAC发送接
口时钟
155.52MHz
125/312.5MHz
125/312.5MHz
155.52MHz
EPON接收接口时钟
125MHz
EPON接收接口时钟
125MHz
644.53125MHz
250MHz
155.52MHz
644.53125MHz
GE工作时钟
PLL Clock
125/312.5MHz
Figure 8.7-11 SerDes 恢复时钟结构
SD5182HV100 Functional Specification Page 446 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8.7.4.1 GPON Clocking
CDR
Serializer
CMU0
VCO
SS
CMU
CS
RX
TX
155.52Mhz
155.52Mhz
16bit
8bit
clk_sds_rx
clk_sds_tx clk_sds_rx
clk_line clk_sys
clk_sys
16bit
8bit
1.24416Gbps
25/50Mhz PONlink
2.48832Gbps
RX
TX
16bit
D
Aync Gear-box
D
idle gen
D
Sync Gear-box
D
GMAC
Aync_fifo
Aync_fifo
GMAC
155.52Mhz
NNI_SDS_IF
155.52Mhz
RX
TX
Figure 8.7-12 GPON 模式时钟结构图
8.7.4.2 XGPON1 Clocking
CDR
Serializer
CMU
VCO
SS
CMU
CS
RX
TX
16bit
16bit
clk_sds_rx
clk_sds_tx clk_155m
clk_155m clk_sys
clk_sys
64bit
155.52Mhz
16bit
25/50Mhz PONlink
9.95328Gbps
RX
TX
64bit
D
Aync Gear-box
D
idle gen
D
Sync Gear-box
D
GMAC
Aync_fifo
Aync_fifo
XGMAC
155.52Mhz
NNI_SDS_IF
2.48832Gbps
DIV4
622.08Mhz
155.52Mhz
155.52Mhz
RX
TX
Figure 8.7-13 XGPON 模式时钟结构图
SD5182HV100 Functional Specification Page 447 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8.7.4.3 XGPON2 Clocking
CDR
Serializer
CMU
VCO
SS
CMU
CS
RX
TX
16bit
16bit
clk_sds_rx
clk_sds_tx clk_155m
clk_155m clk_sys
clk_sys
64bit
155.52Mhz
64bit
PONlink
9.95328Gbps
RX
TX
64bit
D
Aync Gear-box
D
idle gen
D
Sync Gear-box
D
GMAC
Aync_fifo
Aync_fifo
XGMAC
155.52Mhz
NNI_SDS_IF
9.95328Gbps
DIV4
622.08Mhz
622.08Mhz
155.52Mhz
RX
TX
25/50Mhz
Figure 8.7-14 XGPON 模式时钟结构图
8.7.4.4 EPON Clocking
CDR
Serializer
CMU
VCO
SS
CMU
CS
RX
TX
125Mhz
125Mhz
10bit
10bit
clk_sds_rx
clk_sds_tx clk_sds_rx
clk_line clk_sys
clk_sys
10bit
125Mhz
10bit
1.25Gbps
PONlink
1.25Gbps
RX
TX
10bit
D
Aync Gear-box
D
idle gen
D
Sync Gear-box
D
GMAC
Aync_fifo
Aync_fifo
EMAC
125Mhz
NNI_SDS_IF RX
TX
25/50Mhz
Figure 8.7-15 EPON 模式时钟结构图
SD5182HV100 Functional Specification Page 448 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8.7.4.5 XEPON Clocking
25/50Mhz
CDR
Serializer
CMU
VCO
SS
CMU
CS
RX
TX
16bit
16bit
clk_sds_rx
clk_sds_tx clk_161m
clk_sys
clk_sys
64bit
64bit
PONlink
RX
TX
64bit
D
Aync Gear-box
D
idle gen
D
Sync Gear-box
D
GMAC
Aync_fifo
Aync_fifo
NNI_SDS_IF XEMAC
DIV4
64转66
66转64
clk_161M clk_156M
10.3125Gbps
10.3125Gbps
644.53125Mhz
644.53125Mhz
clk_156M
161.1328125Mhz
161.1328125Mhz
RX
TX
DIV4
clk_sys
Figure 8.7-16 XEPON 对称模式时钟结构图
8.7.4.6 XEPON_A Clocking
CDR
Serializer
CMU0
VCO
SS
CMU0
CS
RX
TX
1.25/2.5Gbps
PONlink
10.3125Gbps
25/50Mhz
CMU1
CMU1
16bit
10bit
clk_sds_rx
clk_sds_tx
clk_sys
64bit
10bit
RX
TX
64bit
D
Aync Gear-box
D
idle gen
D
Sync Gear-box
D
GMAC
Aync_fifo
Aync_fifo
NNI_SDS_IF XEMAC
DIV4
64转66
clk_161M clk_156M
644.53125Mhz
125/250Mhz
161.1328125Mhz
125/250Mhz
D
RX
TX
Figure 8.7-17 XEPON 非对称模式时钟结构图
SD5182HV100 Functional Specification Page 449 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8.7.4.7 GE Clocking
CDR
Serializer
CMU
VCO
SS
CMU
CS
RX
TX
10bit
10bit
clk_sds_rx
clk_sds_tx
clk_sys
clk_sys
10bit
10bit
25/50Mhz PONlink
RX
TX
10bit
D
Aync Gear-box
D
idle gen
D
Sync Gear-box
D
Aync_fifo
Aync_fifo
NNI_SDS_IF GE
3.125Gbps
1.25Gbps
3.125Gbps
1.25Gbps
312.5/125Mhz
312.5/125Mhz
312.5/125Mhz
312.5/125Mhz
Aync_fifo
Aync_fifo
clk_1588
clk_1588
RX
TX
Figure 8.7-18 NNI 侧GE 模式时钟结构图
8.7.5 UNI Clocking
8.7.5.1 4GE Clocking
4*GE
PHY
GEMAC
rx_data_sds
tx_data_sds
rx_data_mac
tx_data_mac
rx_data_mac_mux
tx_data_mac_mux
GMII
A接口B接口C接口
IPS_PON
EPS_PON
IPS
EPS
MAC A接口 B接口(GMII) C接口
TX RX TX RX TX RX
GE 1G,
8bit@125MH
z
1G
8bit@125MH
z
1G,
8bit@2.5/25/1
25MHz
1G
8bit@2.5/25/1
25MHz
1G
32bit@250M
Hz
1G
32bit@250M
Hz
SD5182HV100 Functional Specification Page 450 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Table 8.7-3 NNI 侧时钟频率模式表
8.7.5.2 RGMII GE Clocking
SDS_IF
RX
GE MAC
IPS
EPS
clk_dp
TX
ASYN FIFO
clk_gemac_125m
clk_gemac_sys
ASYN FIFO
clk_rgmii_tx_2x
PLL
RX
RGMII
ASYN
FIFO
ASYN
FIFO
clk_rgmii_rxc
DIV2 clk_rgmii_250m
DLY7 MUX
315度
DLY0 0度
8phase
Figure 8.7-19 UNI 侧RGMII（GE MAC4）模式时钟结构图
UNI 侧单独一个MAC 支持外置RGMII 接口模式，其时钟结构上图所示，在RX 和TX 方
向，异步过渡在GE MAC 里完成，RGMII 模式的RX 和TX 方向均为同步时钟域。
RGMII 的TX 方向需要使用一个2 倍时钟进行发送。RX 方向使用PHY 输出的RX 时钟采
集数据，支持RX 时钟调相；
8.7.5.3 2.5GE Clocking
用户侧2.5GE 接口是复用USB 接口实现的，方便对接外部接口为2.5GE 的SerDes 接口。
芯片内部设置独立的GE MAC，时钟频点跑312.5MHz。同时兼容支持GE 模模式。MAC
和PHY 之间为SGMII 接口，PCS 需要做8b/10b 编码转换，放在MAC 侧实现。时钟结构
参考下图。
SD5182HV100 Functional Specification Page 451 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
SDS_I
F
RX
GE MAC
IPS
EPS
clk_sys
TX
ASYN
FIFO
312.5/125MHz clk_gemac_sys
ASYN
FIFO
SDS TXO_CLK
OR LSW PLL
RX
PCS
ASYN
FIFO
ASYN
FIFO
clk_sgmii_rx
COMB
PHY
clk_sgmii_tx
UNI_RXD
UNI_TXD
Figure 8.7-20 UNI 2.5GE 模式时钟结构图
Table 8.7-4 2.5GE 时钟频率模式表
8.7.6 Other Clocking
MDIO 电路，需要125MHz 时钟，通过ETH_PLL 进行DIV 产生。
TSensorV510 IP 需要提供1M 时钟，±5%精度以内，占空比45～55%以内；这个时钟与
其他所有时钟都是异步关系，TSensorV510 与TOP_CFG 的接口也需要按照异步接口来进
行设计。
MAC A 接口 B 接口(GMII) C 接口
TX RX TX RX TX RX
GE 1G/2.5G, 8
bit@125/312.
5MHz
1G/2.5G, 8
bit@125/312.
5MHz
1G/2.5G, 8
bit@2.5/25/12
5/312.5MHz
1G/2.5G, 8
bit@2.5/25/12
5/312.5MHz
1G/2.5G
32bit@250M
Hz
1G/2.5G
32bit@250M
Hz
SD5182HV100 Functional Specification Page 452 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8.8 CLOCKING GATING
本章介绍需要进行门控的时钟。
时钟门控可以有效的降低功耗，强烈建议用户根据自身的应用场景，关闭不使用的电路的时钟。
SD5182HV100 Functional Specification Page 453 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
时钟 是否能门控 上电默认 频率 (MHz) 描述
clk_ecs_raw
否
NA
1000~1200
CPU核的原始时钟
clk_apb
否
NA
100
APB总线时钟
clk_ahb
否
NA
250
AXI总线时钟
clk_axi
否
NA
333
ACP总线时钟
clk_apb_timer01
time01_clk_en
ON
100
TIMER01的APB工作时钟
clk_apb_timer23
time23_clk_en
ON
100
TIMER23的APB工作时钟
clk_apb_timer45
time45_clk_en
ON
100
TIMER45的APB工作时钟
clk_led
led_clk_en
OFF
25~78.125
LED模块工作
clk_abp_uart0
uart0_clk_en
ON
100
UART0工作时钟。
clk_abp_uart1
uart1_clk_en
ON
100
UART1工作时钟。
clk_abp_uart2
uart2_clk_en
ON
100
UART2工作时钟。
clk_apb_spi1
spi1_clk_en
ON
100
SPI接口时钟
clk_axi_ipsec
clk_ipsec_sys
ipsec_clk_en
OFF
333
IPSEC工作时钟。
clk_apb_mddrc
apb_mddrc_clk_en
OFF
100
DDR控制器的APB总线时钟。
clk_ddrc
ddrc_clk_en
OFF
430/533
DDR时钟，430M/533M
clk_hw_49m
hw_clk_en
OFF
49.152
HW的时钟源。
clk_sfc_2x
sfc_clk_en
ON
125
SFC FLASH控制器时钟。
clk_ahb_nandc
nandc_clk_en
ON
250
NAND FLASH控制器时钟。
clk_zsp_core
zsp_clk_en
OFF
166
ZSP模块CORE时钟。
clk_ahb_zsp
否
NA
250
ZSP模块AHB接口时钟。
clk_sdio_ccin
clk_sdio_drv
clk_sdio_sample
sdio_clk_en
OFF
200/100/50/25
SDIO工作时钟。
SD5182HV100 Functional Specification Page 454 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
时钟 是否能门控 上电默认 频率 (MHz) 描述
clk_sys_pie
clk_axi_pie
pie_clk_en
ON
250
clk_sys_pie为DP时钟域
clk_axi_pie为ACP总线时钟域
clk_phy_ref
usb0~3_phy_clk_en
OFF
100
USB的PHY参考时钟。
usb_ref_clk
usb_ctrl_clk_en
OFF
100
USB控制器参考时钟。
clk_pcie_ref
pcie0~1_clk_en
OFF
100
PCIE PHY参考时钟。
clk_ahb_dmac
dmac_clk_en
OFF
533
DMAC时钟。
clk_psa
psa_clk_en
OFF
500
PSA时钟，可在基准时钟上动态调频。
clk_dp
dp_clk_en
ON
250
DP时钟，可在基准时钟上动态调频。
SD5182HV100 Functional Specification Page 455 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8.9 TEST CLOCK
8.9.1 Input Test Clock
芯片输入的测试源头：
设计上会单独开发一个CKD 模块。CKD 模块包含检测时钟的分频，因为分频时钟并不作
为时钟检查，只是作为数据应用，无需放在CRG 内实现，可以有效减少顶层走线。
8.9.2 Output Test Clock
输出部分重要时钟，为测试使用。包括：所有PLL 输出时钟，SerDes 输出时钟，PHY 的
输出时钟。
PLL输出的时钟
MAC工作时钟等
DIV
10
clk_test_sel[5:0]
A9工作时钟
Figure 8.9-1 Test Clock 模块电路结构图
默认clk_test 时钟输出A9 的工作时钟，可以管脚观测。
其他可观察时钟参考寄存器手册中的描述，按照配置输出对应的可观察时钟。
8.9.3 DFT Clock
DFT 的功能，在CRG 设计中需要兼顾考虑，满足DFT 对时钟、复位的可控性。
DFT 时钟尽量提升频率。
8.9.3.1 JTAG Clocking
芯片含有一个JTAG 接口，用于芯片测试。TCK 支持25MHz。
SD5182HV100 Functional Specification Page 456 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
8.9.3.2 OCC Clocking
芯片内的高频时钟需要利用OCC电路进行DFT测试，一般高于100MHz的时钟就会使用OCC进行控制，具体的添加方法请设计人员在DS阶段与DFT人员讨论决定。
SD5182HV100 Functional Specification Page 457 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
9 RESET INTRODUCTION
9.1 RESET OVERVIEW
上电复位可以由芯片内部的POR 电路 或是 RESET_N 管脚来产生芯片的初始化复位，复
位撤离后，首先撤离系统控制器复位、将上电配置字强制输入状态、撤离EFUSE、
MEMP；然后撤离上电配置字的输入状态，复位BUCK，LDOC；撤离看门狗的复位，看
门狗进行复位延时后，对CRG 配置的软复位控制电路撤离；再进行CRG 时钟电路的撤
离，最后进行ECS 子系统和其他转发面的复位撤离。
芯片在系统下电时支持DYING GASP 引发的复位，当电压下降到配置阈值时，上报中断
触发软件对DYING GASP 的处理，软件处理时间芯片可配置，保证软件可处理完毕所有
任务，然后内部产生全局复位，复位时间1～10s。为防止上电时突然掉电导致对FLASH
接口产生疑是错误操作的电平，设计如下延时复位方案。
延时配置
默认0ms
掉电检测 延时器 复位系统
中断
Figure 9.1-1 Dying Gasp 复位
DYING GASP 产生的掉电复位默认有效，延时值默认为0ms，延时器以0.5ms 步进，最
大支持1000ms。在芯片完成启动后，由软件通过配置延时值来保证掉电时不会很快清除
芯片。
SD5182HV100 Functional Specification Page 458 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
POR
RESET_N
POR_RST_N
WDG
CPU
L2
系统控制器
EFUSE复位撤离
IO DIE同步复位开始
获取上电配置字状态
PSA
配置复位
软复位
DP
配置复位
软复位
MAC
配置复位
软复位logic soft reset
UART
soft reset
HW
soft reset
GPIO
soft reset
DDR
soft reset
PCIE
soft reset
USB
soft reset
I2C
soft reset
ZSP soft reset
TIMER soft reset
IPSEC soft reset
SDIO
soft reset
SFC
soft reset
soft reset
soft reset
soft reset
滤毛刺
电路
滤毛刺
电路
ECS SubSystem
CRG软复位处
理逻辑
system
soft reset
CRG分频电路
delay
soft reset other
检沿延时
产生复位
dying gasp
OR
pd_reset_en
Delay
上电配置字相关管脚强
制输入状态撤离
AND
AND
AND
AND
Delay Delay
Delay
Delay
0.5ms
步进
Delay Delay
Delay
logic soft reset
logic soft reset
Figure 9.1-2 SD5182HV100 芯片逻辑复位概略图
基于各子系统间异步逻辑的关系，要求存在异步处理的接口信号部分不能存在组合逻辑，
不同时钟域的两端都需要寄存器输入、输出。保证不同时钟域间复位和复位撤离的逻辑安
全。
需要特别关注COP 和QUARK 间的信号处理，复位撤离先QUARK 后COP。
Soft reset 复位为基于子系统、子模块的整体复位。
Logic soft reset 复位不复位配置相关表项、寄存器。
SD5182HV100 Functional Specification Page 459 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
9.2 POWER UP
DC-DC
12V
SD5182H
DC-DC 3.3V
1.8V
T28 模拟CORE电源
T28 数字CORE电源
CPU电源
T28 模拟IO电源
T28 数字IO电源
DDRPHY & DDR IO电源
T28 ODIO 3.15v电源
CPU AVFS
分压 DYING Gasp 1.2v
DC-DC 0.85~1.1V
0.9V
DC-DC
1.5V/1.2V
DC-DC
Figure 9.2-1 SD5182HV100 芯片供电方案
SD5182H支持的供电方案有多种选择，如上图所示：
1.单板提供3.3v电源，提供IO DIE的IO电源及T28 DIE上的ODIO电源。
2.单板提供0.85～1.0v的CPU电源。
3.单板提供0.9v电源，为T28 DIE的数字CORE和模拟CORE供电。其中模拟CORE电源也可以
选择由LDOC输出的电源。
4.单板提供1.8v电源，为T28模拟IO和数字IO提供电源。
5.芯片集成的32bit位宽DDRPHY功耗稍大，需要单板提供1.5v或1.2v电源，为DDRPHY和DDR
IO提供模拟和数字电源。
SD5182HV100 Functional Specification Page 460 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
12V
1.8V DC-DC
3.3V DC-DC
0.9V DC-DC
RESET
t0 t1 t2 t3 t4
Time
Figure 9.2-2 SD5182H 芯片上电顺序
t0:12V上电时间
t1:0.9v上电时间
t2:1.8v上电时间。
T3:3.3v上电时间，t3-t1 < 2ms，0.9v电源上电后，在2ms之内要求完成3.3v上电
T4:芯片内部解复位，开始复位流程，0.9v上电完成后，约12ms～19ms，内部复位撤消，
内部开始启动复位流程。
SD5182HV100 Functional Specification Page 461 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
9.3 RESET RLEASE
组合逻辑过滤10ns毛刺，展宽
390625周期
展宽1ms
看门狗复位输出（展宽5ms)
看门狗复位/系统软复位相与后展宽
1ms
展宽1204cycles(12~41us)
0ms
上电复位或者按键复位
系统控制器部分逻辑/上电配
置字复位撤离
上电配置字相关管脚强制输入
状态撤离，看门狗复位撤离
系统软复位处理逻辑复位撤离
CRG分频等相关电路复位撤离
IO DIE上GPIO和GEPHY复位
ECS复位撤离
其他逻辑复位撤离
(相对于ecs复位撤离，延迟40ns）
-12~-2ms
上电,管脚复位域
看门狗复位域
系统软复位复位域
组合逻辑过滤10ns毛刺，展宽100us
SWITCH开关切换，打开ODIO 3v电源
~12ms 100us 5ms 1ms 5ms 1ms 12~41us
Figure 9.3-1 SD5182H 芯片复位撤离流程
在ECS 小系统起来后，CPU 按照芯片逻辑由内到外的顺序配置各个子partition 的复位撤
离，保证芯片各逻辑的复位安全有序撤离。
9.3.1 Source of Reset
采用组合逻辑滤毛刺的方式分别对管脚复位(rst_n)和POR 复位(por_rst_n)进行滤毛刺
处理。要求能够过滤毛刺宽度为10ns。经过滤毛刺的复位进行相与后可做为整芯片的复
位源。
支持下电复位，检测到基准电压下降到某个阈值后，逻辑进行下电复位保护，可以在
经过一段配置时间后对整芯片进行复位操作。
9.3.2 Special Logic Reset Release
这里的特殊逻辑是针对一些只能够在上电或者外部按键才能够复位的逻辑。这些逻辑
在上电后的复位撤离顺序。
SD5182HV100 Functional Specification Page 462 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
SD5182H主要有以下逻辑需要在该阶段进行复位：
1. 系统控制器中，软件调试寄存器；
2. EFUSE复位撤离；
3. 上电配置字逻辑；
4. 看门狗逻辑；
该阶段复位分为两个阶段：
第一阶段，完成上述的1,2,3,4逻辑的复位。
第二阶段，完成 “上电配置字相关管脚”强制输入状态的撤离。
注意：系统控制器的复位撤离实际上是在0.9V稳定之后约12ms才撤离的，因为系统控制器的复位撤离需要使用clk_apb同步。
9.3.3 Watch Dog
1）复位部分
看门狗负责监控CPU运行状态。当CPU运行异常时，对整芯片进行重启操作。看门狗具备一下功能：
1，支持通过配置wdg_en_cfg寄存器来开启和关闭看门狗功能。默认是开启的。
关闭看门狗：对wdg_en_cfg依次配置0xABCD5182，0xED574447 ；
打开看门狗：对wdg_en_cfg依次配置0x4F4E5452，0x12345182。
2，支持上一次复位原因记录
3，JTAG工作时，自动关闭看门狗
2）时钟部分
此时整个芯片的时钟只有参考时钟。
9.3.4 System Softer Reset Release
在看门狗复位之后，系统软复位与看门狗复位合并之前。需要对系统全局软复位产生逻辑进行复位撤离。
9.3.5 CRG Reset Release
对CRG中分频电路进行复位撤离。
SD5182HV100 Functional Specification Page 463 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
9.3.6 ECS Reset Release
对ECS系统进行复位撤离。A9复位撤离时序由ECS CRG控制。以保证A9取指，运行时时钟复位均处于正确的状态。
9.3.7 Core Reset Release
在ECS系统的总线，外设复位之后，对Core和接口逻辑进行复位撤离。Core逻辑复位会经过对应模块时钟域进行同步。同时对应模块的内部复位顺序，软复位也是在这个阶段进行处理。
9.4 INITIAL
9.4.1 Initial CRG
1、 上电复位结束时，所有时钟源头都选用晶振时钟，小系统所涉及模块在执行前的时钟频率：
晶振时钟频率（MHz） 40
clk_a9&L2
40
晶振时钟
clk_apb
4
晶振时钟/10
clk_ahb
10
晶振时钟/4
clk_acp
13.3
晶振时钟/3
clk_fmc
5
晶振时钟/8
2、 上电复位结束时，小系统所涉及模块在执行前的复位状态：
均是复位撤离状态，A9复位最后撤离。
9.4.2 Initial Process
SD5182H支持从SPI Nand/Nand Flash，BOOTROM启动。启动流程如下:
SD5182HV100 Functional Specification Page 464 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
单板DC-DC的0.9V上电
单板DC-DC的3.3v上电
POR复位撤离
0.9v电源稳定之后12ms POR复位撤离
延时2～7ms后复位撤离
EFUSE开始Load数据
0
3ms
19ms
约5ms后，上电配置采集完成。
EFUSE数据Load完成。
Tsensor温度校准完成。看门狗开始工作
24ms
约6ms后，所有启动需要的时钟分频完成
（目前处于Slow模式，时钟来源都是晶
振）
30ms
约最多41us后，ECS AXI,AHB,APB总线复
位撤离。
MEMP 等启动需要的逻辑复位撤离。
A9复位撤离。(约360个A9时钟周期）
约6us后，A9开始取指。
（约50个A9时钟周期）
31ms
22ms
0.9V上电完成
3.3V上电完成
3ms之内晶振时钟稳定
电压校准完成
温度传感器校准完成，
上电配置字采集完成
CRG初始化完成
A9完成启动
配置ECS PLL。1500个周期后(120us，推荐
等待1ms)，ECSPLL Lock。待ECS PLL锁定
之后，配置xtal_clk_sel，完成芯片从Slow到
Normal的模式切换。
ECSPLL Lock
启动完成
逻辑自动
完成的过程
BOOTROM或者Uboot
UART端口初始化。
判断Flash类型。
初始化对应Flash访问控制器
5182支持两类启动方式：
1，从BOOTROM启动，再跳转至SPI
NAND/Nand Flash。
2，直接从SPI NAND/Nand Flash中启
动。
启动类型由上电配置字和efuse确定，默
认是从BOOTROM启动。
Flash类型由硬件配置字决定。
单板DC-DC的1.8v上电
2ms
晶振时钟稳定
晶振电源(3.3v) 稳定后1ms之内时钟稳定
19ms之内复位撤离
单板DC-DC的1.8v上电
芯片内部LDOC的1.5v/1.2v上电
SD5182HV100 Functional Specification Page 465 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure 9.4-1 SD5182H 启动流程
ECS 系统起来后，对PSA 部分的微码加载流程如下：
ECS系统OK
PSA复位撤离
CPU加载微码
启动完成
N
查询System PLL是否lock
PSA initial OK
Y
Y
N
Figure 9.4-2 SD5182H 微码加载流程
SD5182HV100 Functional Specification Page 466 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
10 OAM
本章描述芯片的OAM功能，主要包括支持OAM的类型、特性、流程和模块分工。
10.1 TERMINOLOGY Term Description
Table 10.1-1 Terminology
SD5182HV100 Functional Specification Page 467 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
10.2 OAM FLOW
基于5182H 转发引擎为可编程的NP 处理器，同时PIE 模块处理能力短包64B 可以达到
800Mbps，长包256B 可以达到2.5Gbps，原则上所有OAM 报文可由CPU 进行收发，
PSA 处理OAM 报文头，生成报文编辑命令，PE 完成报文编辑。
CPU/PIE
PSA
UNI
NNI
E
P
S
PRBS
I
P
S
P
E
H
A
NNI UNI
OAM 报文处理涉及模块如上图，具体流程为：
1. CPU 产生报文，通过PIE 发送到转发通道，或CPU 指定报文通过PIE 定时收发，
或CPU 配置PRBS 进行报文收发；
2. IPS 接收报文，生成报文的FCB，发送给HA；
3. HA 识别报文（3ah、1ag 指定域识别，其他5 元组识别），不做特殊处理，不能
丢包，交PSA 处理；
4. PSA 识别报文，根据协议完成处理，并生成报文编辑命令；
5. PE 完成报文编辑，入队；
6. EPS 根据出端口配置发送到指定端口，并做相应的统计和编辑；
7. PRBS 完成报文接收，校验，统计；
8. CPU/PIE 接收报文，并查询相应模块的统计。
在进行OAM 吞吐量测试时（或报文净荷要求为PRBS 码流），需要CPU 配置PRBS 模块
完成，吞吐量测试所需的大流量由PRBS 生成，PRBS 可同时处理报文的发送和接收、校
验。PRBS 和PIE 支持定时收发包功能，净荷CPU 可配置。
OAM 报文是否需要环回由微码处理。
下面讲下几个典型OAM 报文的详细处理过程。
SD5182HV100 Functional Specification Page 468 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
10.3 802.3AH
3ah 主要功能有：OAM 对端发现功能、OAM 链路监控功能、远端故障通知功能、OAM
远端环回功能、远端MIB 获取功能（带内网管）。
10.3.1 整体方案
CPU/PIE
PSA
UNI
NNI
E
P
S
PRBS
I
P
S
P
E
H
A
NNI UNI
3ah 主要由6 个单元配合实现：IPS，HA，PSA，EPS，PE，CPU/PIE。各个单元的主要功
能是：
处理单元 功能
IPS 透传数据
HA 根据配置识别3ah 协议报文，携带报文类型透传给PSA，终结报文在HA 打标
记转发。丢弃报文做基于端口统计。支持事件通告处理。
PSA 1， 解析报文，进一步识别非法SMAC 检查（HA 实现），或者STP/RSTP 状态
检查丢弃（微码实现），或者802.1x 认证丢弃（微码实现）的报文，用
于错帧统计生成报文编辑命令。
2， 错帧事件统计和上报：支持基于端口配置事件通告类型，进行错帧统
计，上报中断；
3， 环回：根据近端环回或者远端环回的配置进行相应转发或者丢弃。
支持环回操作。
OE 需要提供独享的OE 保序队列，支持数据流和PDU 混流，并支持frame 保
序统计。基于OE 队列保序的frame 统计组，组内最大支持8 个成员，通过
bitmap 控制成员是否进行+1 的统计。（对端数据流+CPU 输入经过微码处理
后送同一个保序队列）
PE 报文编辑，EQM 丢弃报文丢包处理。
EPS 透传数据。
带格式的: 字体颜色: 粉红
带格式的: 字体颜色: 粉红, (中文) 中文(中国)
带格式的: 字体: +中文正文 (宋体), 10.5 磅
带格式的: 列出段落, 编号 + 级别: 1 + 编号样式: 1, 2, 3, …
+ 起始编号: 1 + 对齐方式: 左侧 + 对齐位置: 0 厘米 + 缩
进位置: 0.63 厘米
带格式的: 字体: +中文正文 (宋体), 10.5 磅
带格式的: 字体: +中文正文 (宋体), 10.5 磅
带格式的: 字体颜色: 粉红
SD5182HV100 Functional Specification Page 469 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
CPU/PIE
收发报文、查询统计。
3ah协议分析和处理。
10.3.2 具体功能点
10.3.2.1 事件通告
为了从不同的角度进行性能统计，HAPSA支持三种事件通告统计，丢包在PEEQM实现：
o 错帧事件通告；
o 错帧秒事件通告；
o 错帧周期事件通告。
每个端口的事件通告功能单独使能。
每个端口同时仅支持三种事件通告中的一种，各端口通过配置来选择事件通告的类型。
计时所用的定时器时间精度为100ms。
错帧定义：在HA或之前完成错帧识别，为非法SMAC检查（HA实现），或者STP/RSTP状态检查丢弃（微码实现），或者802.1x认证丢弃（微码实现）的报文为错帧。
三种事件及其包含的TLV个字段的含义（软件产生协议报文）：
错帧事件：在一定时间内，检测到接收的错帧数大于或等于定义的门限值时所产生的事件。
错帧事件TLV包含了如下一些字段：
o Event Type：事件类型，固定为0x02，表示时间为错帧事件；
o Event Length：事件长度，固定为0x1A；
o Event Time Stamp（功能）：事件发生时刻的时间戳，记录事件产生的时间点，记录单位为100ms；
o Errored Frame Window（配置）：错帧窗口，定义每次进行错帧统计的时间周期；
o Errored Frame Threshold（配置）：错帧门限，定义了在错帧窗口周期内产生错帧事件的实际错帧数最小值；
o Errored Frames（统计）：实际错帧数，指一个错帧窗口内收到的错帧数的实际值；
SD5182HV100 Functional Specification Page 470 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
o Error Running Total（统计）：总错帧数，指从链路监控使能开始，检测到的总错帧数；
o Event Running Total（统计）：总错帧事件数，指从链路监控使能开始，检测到产生的总错帧事件数。
错帧秒事件：在指定秒数内，检测到的错帧秒数大于或等于定义的门限值时所产生的事件。（错帧秒：1秒内接收到的错帧数量大于0，则称之为一个错帧秒。）
错帧秒事件TLV包含了如下一些字段：
o Event Type：事件类型，固定为0x04，表示时间为错帧事件；
o Event Length：事件长度，固定为0x12；
o Event Time Stamp（功能）：事件发生时刻的时间戳，记录事件产生的时间点，记录单位为100ms；
o Errored Seconds Summary Window（配置）：错帧秒窗口，定义了统计错帧秒的时间周期；
o Errored Seconds Summary Threshold（配置）：错帧秒门限，定义了在错帧秒窗口内产生错帧秒事件的实际错帧秒事件最小值；
o Errored Seconds Summary（统计）：实际错帧秒数，指一个错帧秒窗口内收到的错帧秒数的实际值；
o Error Running Total（统计）：总错帧秒数，指从链路监控使能开始，检测到的总错帧秒数；
o Event Running Total（统计）：总错帧秒事件数，指从链路监控使能开始，检测到产生的总错帧秒事件数。
错帧周期事件：在指定数量的收到的帧中，错帧数量大于或等于定义的门限值时所产生的事件。
o Event Type：事件类型，固定为0x03，表示时间为错帧事件；
o Event Length：事件长度，固定为0x1C；
o Event Time Stamp（功能）：事件发生时刻的时间戳，记录事件产生的时间点，记录单位为100ms；
o Errored Frame Window（配置）：错帧窗口，定义了统计错帧秒的计数周期；
o Errored Frame Threshold（配置）：错帧门限，定义了在错帧窗口计数周期内产生错帧事件的实际错帧数最小值；
SD5182HV100 Functional Specification Page 471 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
o Errored Frames（统计）：实际错帧数，指一个错帧窗口计数周期内收到的错帧数的实际值；
o Error Running Total（统计）：总错帧数，指从链路监控使能开始，检测到的总错帧数；
o Event Running Total（统计）：总错帧事件数，指从链路监控使能开始，检测到产生的总错帧周期事件数。
10.3.2.2 近端环回和远端环回
近端环回端口、远端环回端口和远端环回测试均由微码实现，相应的报文统计也由微码实现。
近端环回：
o 近端环回端口对来自线路的非OAMPDU报文进行环回（原数据返回）；
o 近端环回端口对设备内发向该端口的非OAMPDU进行丢弃；
o 近端环回端口对OAMPDU报文既可以发送也可以接收。
远端环回：
o 远端环回端口接受远端环回测试端口发送的测试数据报文；
o 远端环回端口对来自线路的环回报文进行终结；
o 远端环回端口对设备内发向该端口的非OAMPDU报文进行丢弃；
o 远端环回端口对OAMPDU报文既可以发送也可以接收。
注意：
o 全局只支持1路802.3ah远端环回；
o 因为物理层丢弃的报文，如FCS校验错丢弃，无缓存空间丢弃的报文不能被环回。
基于端口支持近端，远端环回配置。
近端环回有效时：
o 不进行入端口tag处理，MAC黑白名单检查，IP黑白名单检查，入口VLAN检查，协议报文处理，1AG/Y.1731处理。
o 直接将接收到得非OAMPDU报文发送回源端口，同时对报文个数进行计数。
o OAMPDU报文根据寄存器配置处理。
SD5182HV100 Functional Specification Page 472 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
远端环回有效时：
o 直接将接收到得非OAMPDU报文丢弃，同时对报文个数进行计数。
o 选择远端环回数据源，可选择除环回端口外的任意物理端口作为数据源，将数据直接发送到远端环回端口。
o OAMPDU报文根据寄存器配置处理。
SD5182HV100 Functional Specification Page 473 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
10.4 1AG/1731
1ag/1731 特性有：
1. 支持vlan+port 识别MEP/MIP；
2. 每个端口支持8 个MEP/MIP；
3. 支持MIP 对LBM/LTM报文的识别和捕获；
4. 支持共享MAC 的MEP 匹配；
5. 支持32 路LM 测试，支持单端和双端测试；
6. 最大支持4Gbps 流量；
7. 支持连通性测试；
8. 支持DM 测试，支持被动双向测试；
9. 支持吞吐量测试，支持单向和双向测试，支持PRBS31 码型。
10.4.1 整体方案
CPU/PIE
PSA
U
N
I
N
N
I
E
P
S
PRBS
I
P
S
P
E
H
A
802.1ag 和Y.1731 协议的连通性检测和性能检测功能，主要由7 个单元配合实现：IPS，
HA，PSA，EPS，PE，CPU/PIE，PRBS。各个单元的主要功能是：
处理单元 功能
IPS 透传数据
HA 根据配置识别报文，透传数据
PSA 支持共享MAC
支持连通性检测
SD5182HV100 Functional Specification Page 474 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
支持LM测试，支持数据报文的计数统计和CFMPDU报文的计数采样。 支持DM测试，支持对测试报文时戳采样。 支持TM测试，支持硬件自动回应TM测试报文。 支持DMAC+VLAN对报文进行转发。 支持CVLAN和SVLAN切换。 实现802.1ag和Y.1731协议处理。 支持协议报文接收和发送。 支持报文统计。
PE 报文编辑。时戳由PSA通过ED携带。
EPS
LM统计。
CPU/PIE
生成报文、接收报文、查询统计。
PRBS
生成报文、接收报文并统计。
LM统计放在EQM之后的EPS模块进行统计和编辑，报文匹配在NP完成，微码给出3个统计索引、1个采样索引（报文所属维护域）、报文编辑的Offset到PE，PE透传这些信息到EPS。EPS统计表项深度为256， 相当同时支持32路LM测试，每路8个优先级。一个报文只在3个维护域上起作用。
10.4.2 具体功能点
以下功能点，除吞吐量检测的发包由PRBS实现外，其他主要由微码实现。
10.4.2.1 支持unaware vlan
MEP匹配时，支持unaware vlan。
非unaware vlan时，MEP由PORT+VLAN+MDL进行匹配。Unaware vlan时，MEP由PORT+MDL匹配，不关注vlan。
Unaware vlan应用时：
 此端口下的所有的MEP均为vlan unaware。
 CFMPDU报文不匹配VLAN，包括连通性测试，LM，DM，TM。
 LM测试时的数据报文也不匹配VLAN。
批注 [Z(1]: 1，支持MEP/MIP报文匹配；
2，支持各种检测协议报文、的识别、转发、统计等；
3，支持时延报文的时戳处理（采样、打时戳）；
4，支持吞吐量测试报文的识别、计数索引、编辑动作处理，具体统计和编辑的实施在EPS模块（QoS后）；
5，协议报文交由CPU处理。
批注 [Z(2]: 原来ONU需要PE打时戳，根据入口和出口需要加上offset。
——以前的NP芯片都是直接在处理点获取时戳，通过ED携带给PE编辑。
和汪文明确认。
SD5182HV100 Functional Specification Page 475 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
10.4.2.2 支持共享MAC
支持所有UP型MEP共享一个MAC地址。
5118为UP型MEP单独使用一个MAC地址，此地址只使用于UP型MEP，不和br0，各个WAN口MAC地址共享。
在转发面（L2），使用MAC+VLAN可以确定MEP所在的端口。
因此5118的共享MAC MEP查找方式为：
L2用MAC+VLAN转发到端口
端口处，用VLAN+MDL匹配MEP。
此时要求：
不同端口的VLAN不能存在相同的VLAN。
10.4.2.3 连通性检测
10.4.2.3.1 综述
支持基于vlan+port识别MEP/MIP，每个端口可以支持8个MEP/MIP，配置属性包括MEP方向（UP/DOWN），MP类型（MEP/MIP），和维护域等级（MDL）。
注意：入口只支持使用报文的原始外层vlan进行MEP/MIP匹配，不支持切换后的vlan做匹配。出口只支持使用报文的出口VLAN进行匹配。
支持对CFMPDU进行高MDL报文透传，低MDL报文丢弃，相等MDL报文捕获。对于相等MDL域的协议处理，如CCM定时发送，链路故障定位等，都由上层软件完成，逻辑捕获CFMPDU报文到CPU协助软件处理。
支持基于MEP/MIP属性，对不同的报文进行处理，MPs报文处理规则如下表。
MEP
CCM报文
Vlan+port匹配
Mdl相等
同向捕获
背向丢弃
Mdl大
透传
Mdl小
配置捕获或丢弃
Vlan+port不匹配
透传
AIS报文
Vlan+port匹配
AIS使能
配置捕获或透传
AIS不使能
透传
Vlan+port不匹配
透传
SD5182HV100 Functional Specification Page 476 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
其他报文
(LBM,LTM,…)
Vlan+port 匹配 Mdl 相等 同向捕获
背向丢弃
Mdl 大 透传
Mdl 小 丢弃
Vlan+port 不匹配 透传
MIP
LBM 报文 Vlan+port+dmac 匹
配
捕获
Vlan+port+dmac 不
匹配
透传
LTM 报文 Vlan+port 匹配 捕获
Vlan+port 不匹配 透传
其他报文 透传
10.4.2.3.2 连通性检测流程
UP 型MEP 连通性测试的实现流程如下（以UNI UP MEP 为例）：
发送CCM
CPU UP MEP FWD
DOWN
MEP
peer
MEP
切换VLAN，学习
MAC+VLAN
接收CCM
发送CCM
转发，切换VLAN
匹配MEP，捕获
CCM
接收CCM
PON
匹配MEP
透传
透传
SD5182HV100 Functional Specification Page 477 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
步骤
模块
行为
1
CPU
发送CCM报文：
1）指定转发，指定转发模板为“CPU发送UP方向 CFMPDU报文”
2）进行端口伪装，伪装端口为UNI口
3）出端口为PON口，指定发送的gemport，tcont，pq（或不指定，由逻辑映射）
4）发送报文VLAN为CVLAN，PBIT为CPBIT，MAC为MEP MAC（独享或共享）
2
UP MEP
以伪装入口PORT+CVLAN+MDL匹配MEP，测试状态为连通性测试，不产生任何动作。
注：如果存在低MDL的MEP，则对报文进行计数。
3
FWD
切换CVLAN为SVLAN，
学习SMAC+SVLAN，（或不学习，静态配置）
不做DMAC+SVLAN转发，
不映射gemport，tcont，pq
使用CPU指定的gemport，tcont，pq入队。
4
DOWN MEP
以出口PORT+SVLAN+MDL匹配MEP，做DOWN MEP功能。
注:DOWN MEP的等级应该比UP MEP等级低，报文处理结果应该为透传，如果做LM则需要进行LM统计。
5
Peer MEP
接收CFMPDU报文
1
Peer MEP
发送CFMPDU报文
2
DOWN MEP
以入口PORT+SVLAN+MDL匹配MEP，做DOWN MEP功能。
注:DOWN MEP的等级应该比UP MEP等级低，报文处理结果应该为透传，如果做LM则需要进行LM统计。
3
FWD
根据MAC+SVLAN转发到UNI口
切换SVLAN为CVLAN
4
UP MEP
以出口PORT+CVLAN+MDL匹配MEP，捕获报文。
SD5182HV100 Functional Specification Page 478 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
携带TOCPU reason 和端口信息。
捕获报文是修改为CVLAN 后的报文。
5 CPU 接收CFMPDU 报文，进行协议处理
DOWN 型MEP 连通性测试的实现流程如下（以PON DOWN MEP 为例）：
发送CCM
CPU UP MEP FWD
DOWN
MEP
peer
MEP
接收CCM
发送CCM
无动作
匹配MEP，捕获
CCM
接收CCM
PON
无动作无动作
匹配MEP
无动作
步骤 模块 行为
1 CPU 代替MEP 发送CCM报文：
1）指定转发，指定转发模板为“CPU 发送DOWN 方向
CFMPDU 报文”
2）进行端口伪装，伪装端口为PON 口
3）出端口为PON 口，指定发送的gemport，tcont，pq（或不指定
，由逻辑映射）
4）发送报文VLAN 为SVLAN，PBIT 为SPBIT，MAC 为MEP
MAC（独享或共享）
2 UP MEP 无动作
3 FWD 不切换SVLAN，
不学习SMAC+SVLAN，
不做DMAC+SVLAN 转发，
不做源端口抑制，
SD5182HV100 Functional Specification Page 479 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
不映射gemport，tcont，pq，
使用CPU指定的gemport，tcont，pq入队。（或不指定，由逻辑映射）
4
DOWN MEP
以PORT+SVLAN+MEL匹配MEP，测试状态为连通性测试，不产生任何动作。
注：如果存在低MDL的MEP，则对报文进行计数。
5
Peer MEP
接收CFMPDU报文
1
Peer MEP
发送CFMPDU报文
2
DOWN MEP
以PORT+SVLAN+MDL匹配MEP，捕获报文。
携带TOCPU reason和端口信息。
捕获报文是原始报文。
3
FWD
无动作
4
UP MEP
无动作
5
CPU
接收CFMPDU报文，进行协议处理。
10.4.2.4 帧丢失检测(LM)
LM支持单端LM和双端LM。
10.4.2.4.1 综述
由软硬件共同完成LM测试。
软件实现LM测试报文的处理和帧丢失计算，逻辑识别LM测试报文，捕获到CPU。
对于LM测试的数据报文，逻辑进行数据报文计数，数据报文根据port+vlan+mac（可选）匹配，如果为LM使能，则根据报文相对于MEP方向，则获取计数器组索引（rxfcl_idx/txfcl_idx）：
 如果报文方向与MEP方向为同向（面向MEP的尖），则进行rxfcl计数。
 如果报文方向与MEP方向为背向（面向MEP的边），则进行txfcl计数。
每个计数器组包括8个cnt，每个cnt对应一个pri。Pri和cnt之间的对应关系由映射表进行配置，rxfcl和txfcl的映射表分别独立，由计数器组索引+pri查找映射表，获取最终的计数器TXFCL/RXFCL。
数据报文包括的非CFMPDU报文和高等级CFMPDU报文。
SD5182HV100 Functional Specification Page 480 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
10.4.2.4.2 双端LM
支持基于CCM报文进行双端LM测试。对于对端发送的CCM报文，捕获到CPU并采样当前计数值编辑到报文中。对于CPU发送的CCM报文，并采样当前计数值编辑到报文中，发送给对端MEP。
双端LM测试时，对于同等级的APS报文，作为数据报文进行计数。其他同等级的CFMPDU报文不进行计数。
10.4.2.4.3 单端LM
支持基于LMM/LMR报文进行单端LM测试。
对于对端发送的LMM报文，捕获到CPU并采样当前计数值编辑到报文中。对于CPU发送的LMR报文，并采样当前计数值编辑到报文中，发送给对端MEP。
单端LM测试时，对于同等级的CCM和APS报文，作为数据报文进行计数。其他同等级的CFMPDU报文不进行计数。
10.4.2.4.4 LM测试流程
LM测试流程如下：
SD5182HV100 Functional Specification Page 481 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
发送CCM/LMR
CPU UP MEP FWD
DOWN
MEP
peer
MEP
学习MAC+VLAN
接收CCM/LMR
发送CCM/LMM
转发
匹配MEP，采样
RxFCL统计
接收CCM/LMM
数据报文
TxFCL统计
转发
RxFCL统计
TxFCL统计
转发
RxFCL统计
匹配MEP，采样
TxFCL统计
数据报文
CCM/APS
CCM/APS
PON
透传
透传
透传
透传
步骤 模块 行为
LM 计数流程
1 CPU/用户 CPU 发送同等级CCM/APS 报文，同连通性测试。
用户发送数据报文。
2 UP MEP 接收CPU 指定转发的同等级CCM/APS 报文，
1）以伪装PORT+CVLAN+MDL 匹配MEP，
2）以+/DMAC+/SMAC 匹配流（可使能），
3）以cpbit 进行TxFCL 统计（映射关系可配置）。
接收数据报文（包括高等级CFMPDU 报文），
SD5182HV100 Functional Specification Page 482 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
1）以PORT+CVLAN+MDL匹配MEP，
2）以+/DMAC+/SMAC匹配流（可使能），
3）以cpbit进行TxFCL统计（映射关系可配置）。
3
FWD
指定转发的同等级CCM/APS报文：
切换CVLAN为SVLAN，
学习MAC+SVLAN，
不映射gemport，tcont，pq
使用CPU指定的gemport，tcont，pq入队。（或不指定，由逻辑映射）
数据报文：
切换CVLAN为SVLAN，
学习MAC+SVLAN，
以DMAC+SVLAN转发到PON口
映射gemport，tcont，pq
4
DOWN MEP
以出口PORT+SVLAN匹配MEP，做DOWN MEP功能。
注:如果做LM需要进行LM统计。
5
Peer MEP
对CCM/APS和数据报文进行RxFCL计数
1
Peer MEP
对CCM/APS和数据报文进行TxFCL计数
2
DOWN MEP
以入口PORT+SVLAN匹配MEP，做DOWN MEP功能。
注:如果做LM需要进行LM统计。
3
FWD
根据MAC+SVLAN转发到UNI口
切换SVLAN为CVLAN，SPBIT为CPBIT
4
UP MEP
接收同等级CCM/APS报文，
1）以出口PORT+CVLAN+MDL匹配MEP，
2）以+/DMAC+/SMAC匹配流（可使能），
3）以cpbit进行RxFCL统计（映射关系可配置）。
SD5182HV100 Functional Specification Page 483 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
接收数据报文（包括高等级CFMPDU报文），
1）以出口PORT+CVLAN匹配MEP，
2）以+/DMAC+/SMAC匹配流，
3）以cpbit进行RxFCL统计（映射关系可配置）。
5
CPU
接收同等级CCM/APS报文
LM采样流程
1
Peer MEP
发送LM测试用的LMM/CCM报文，携带TxFCL
2
DOWN MEP
以入口PORT+SVLAN+MDL匹配MEP，做DOWN MEP功能。
注：DOWN MEP的等级应该比UP MEP等级低，报文处理结果应该为透传，
2
FWD
根据MAC+SVLAN转发到UNI口
切换SVLAN为CVLAN，SPBIT为CPBIT
3
UP MEP
以PORT+CVLAN+MDL匹配MEP，
识别LM测试，根据CPBIT采样当前计数器值（RxFCL），
编辑计数器值到报文中，
捕获报文，携带TOCPU reason和端口信息。
捕获报文是修改为CVLAN后的报文。
4
CPU
接收LMM/CMM报文
1
CPU
发送LM测试用的LMR/CCM报文，同连通性测试。
2
UP MEP
以PORT+CVLAN+MDL匹配MEP，
识别LM测试，根据CPBIT采样当前计数器值（TxFCL），
编辑计数器值到报文中，
3
FWD
切换CVLAN为SVLAN，CPBIT为SPBIT
学习MAC+SVLAN，
转发报文到PON口，
4
DOWN MEP
以出口PORT+SVLAN+MDL匹配MEP，做DOWN MEP功能。
注:DOWN MEP的等级应该比UP MEP等级低，报文处理结果应该为透传，如果做LM则需要进行LM统计。
SD5182HV100 Functional Specification Page 484 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5 Peer MEP 接收LMR/CCM报文，采样RxFCL，计算LM。
DOWN 型MEP 测试如下：
发送CCM/LMR
CPU UP MEP FWD
DOWN
MEP
peer
MEP
接收CCM/LMR
发送CCM/LMM
无动作
匹配MEP，采样
RxFCL统计
接收CCM/LMM
数据报文
转发 TxFCL统计
RxFCL统计
TxFCL统计
转发
RxFCL统计
匹配MEP，采样
TxFCL统计
数据报文
CCM/APS
CCM/APS
PON
透传
透传
无动作
无动作
无动作
步骤 模块 行为
LM 计数流程
1 CPU/用户 CPU 发送同等级CCM/APS 报文，同连通性测试。
用户发送数据报文（包括高等级CFMPDU 报文）。
2 UP MEP 对于CPU 发送的CCM/APS 报文，无动作。
SD5182HV100 Functional Specification Page 485 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
对于数据报文，如果端口LM使能，以PORT+CVLAN匹配计数。否则无动作。
3
FWD
对于CPU发送的CCM/APS报文，无动作。
数据报文（包括高等级CFMPDU报文）：
切换CVLAN为SVLAN，
学习MAC+SVLAN，
以DMAC+SVLAN转发到PON口
映射gemport，tcont，pq
4
DOWN MEP
接收CPU指定转发的同等级CCM/APS报文，
1）以出口PORT+SVLAN+MDL匹配MEP，
2）以+/DMAC+/SMAC匹配流（可使能），
3）以spbit进行TxFCL统计（映射关系可配置）。
接收数据报文（包括高等级CFMPDU报文），
1）以PORT+SVLAN+MDL匹配MEP，
2）以+/DMAC+/SMAC匹配流（可使能），
3）以spbit进行TxFCL统计（映射关系可配置）。。
5
Peer MEP
对CCM/APS和数据报文进行RxFCL计数
1
Peer MEP
对CCM/APS和数据报文进行TxFCL计数
2
DOWN MEP
接收同等级CCM/APS报文，
1）以入口PORT+SVLAN+MDL匹配MEP，
2）以+/DMAC+/SMAC匹配流（可使能），
3）以spbit进行RxFCL统计（映射关系可配置）。
4）捕获报文到CPU，捕获报文为未修改的SVLAN
接收数据报文（包括高等级CFMPDU报文），
1）以入口PORT+SVLAN匹配MEP，
SD5182HV100 Functional Specification Page 486 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
2）以+/DMAC+/SMAC匹配流，
3）以spbit进行RxFCL统计（映射关系可配置）。
3
FWD
接收同等级CCM/APS报文，无动作。
数据报文：
根据MAC+SVLAN转发到UNI口
切换SVLAN为CVLAN，SPBIT为CPBIT
4
UP MEP
同等级CCM/APS报文，无动作
对于数据报文（包括高等级CFMPDU报文），如果端口LM使能，以PORT+CVLAN匹配计数。否则无动作。
5
CPU
接收同等级CCM/APS报文
LM采样流程
1
Peer MEP
发送LM测试用的LMM/CCM报文，携带TxFCL
2
DOWN MEP
以入口PORT+SVLAN+MDL匹配MEP，
识别LM测试，根据SPBIT采样当前计数器值（RxFCL），
编辑计数器值到报文中，
捕获报文，携带TOCPU reason和端口信息。
捕获报文为未修改的SVLAN
2
FWD
无动作
3
UP MEP
无动作
4
CPU
接收LMM/CMM报文
1
CPU
发送LM测试用的LMR/CCM报文，同连通性测试。
2
UP MEP
无动作
3
FWD
无动作
4
DOWN MEP
以出口PORT+SVLAN+MDL匹配MEP，
识别LM测试，根据SPBIT采样当前计数器值（TxFCL），
编辑计数器值到报文中，
5
Peer MEP
接收LMR/CCM报文，采样RxFCL，计算LM。
SD5182HV100 Functional Specification Page 487 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
10.4.2.5 帧时延检测(DM)
DM 支持被动双向DM 测试，不支持单向DM 测试。
由软硬件共同完成DM 测试。
软件实现DM 测试报文的处理和计算，逻辑识别DM 测试报文，捕获到CPU。
DM 测试时，支持64bit 完整时戳，64bit 时戳组成为[32bit 秒计时，32bit ns 计时].
10.4.2.5.1 DM 测试流程
DM 测试只支持双向DM，不支持单向DM。
以UNI UP MEP 的DM测试为例：
发送DMR
CPU UP MEP FWD PON
peer
MEP
切换VLAN，学习
MAC+VLAN
接收DMR，计算
DM
发送DMM
转发
匹配MEP，打时
戳
接收DMM
匹配MEP，打时
戳
DOWN
MEP
透传
透传
步骤 模块 行为
1 Peer MEP 发送DM 测试用的DMM 报文，携带发送时戳
2 DOWN MEP 以入口PORT+SVLAN+MDL 匹配MEP，做DOWN MEP 功能。
注：DOWN MEP 的等级应该比UP MEP 等级低，报文处理结果
应该为透传，
SD5182HV100 Functional Specification Page 488 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
2
FWD
根据MAC+SVLAN转发到UNI口
切换SVLAN为CVLAN，SPBIT为CPBIT
3
UP MEP
以PORT+CVLAN+MDL匹配MEP，
识别DM测试，采样当前时戳，
时戳值编辑到报文中，
捕获报文，携带TOCPU reason和端口信息。
捕获报文是修改为CVLAN后的报文。
4
CPU
接收DMM报文，转换为DMR报文
1
CPU
发送DM测试用的DMR报文，同连通性测试DOWN型MEP。
2
UP MEP
以PORT+CVLAN+MDL匹配MEP，
识别DM测试，采样当前时戳，
编辑时戳值到报文中，
3
FWD
切换CVLAN为SVLAN，
学习MAC+SVLAN，
转发报文到PON口，
4
DOWN MEP
以出口PORT+SVLAN+MDL匹配MEP，做DOWN MEP功能。
注:DOWN MEP的等级应该比UP MEP等级低，报文处理结果应该为透传，如果做LM则需要进行LM统计。
4
Peer MEP
接收DMR报文，采样时戳，计算DM。
DOWN 型MEP DM测试：
SD5182HV100 Functional Specification Page 489 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
发送DMR
CPU UP MEP FWD PON
peer
MEP
接收DMR，计算
DM
发送DMM
接收DMM
匹配MEP，打时
戳
DOWN
MEP
匹配MEP，打
时戳
透传
透传
透传
透传
步骤 模块 行为
1 Peer MEP 发送DM 测试用的DMM 报文，携带发送时戳
2 DOWN MEP 以PORT+SVLAN+MDL 匹配MEP，
识别DM 测试，采样当前时戳，
时戳值编辑到报文中，
捕获报文，携带TOCPU reason 和端口信息。
捕获报文是原始SVLAN 报文。
2 FWD 无动作
3 UP MEP 无动作
4 CPU 接收DMM 报文，转换为DMR 报文
1 CPU 发送DM 测试用的DMR 报文，同连通性测试DOWN 型MEP。
2 UP MEP 无动作
3 FWD 无动作
4 DOWN MEP 以PORT+SVLAN+MDL 匹配MEP，
识别DM 测试，采样当前时戳，
编辑时戳值到报文中，
SD5182HV100 Functional Specification Page 490 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
4
Peer MEP
接收DMR报文，采样时戳，计算DM。
10.4.2.6 吞吐量检测（TM）
只支持一路TM。支持单向吞吐量测试和双向吞吐量测试（通过不同模式配置）。
吞吐量测试的报文处理由逻辑PRBS完成，PRBS进行发送和接收报文计数，并对接收报文进行检测，产生告警上报CPU。由CPU完成链路吞吐量的计算。
10.4.2.6.1 单向吞吐量测试
支持TST帧进行单向吞吐量测试。支持4种TST帧码型：
1. 全0不带CRC
2. 全0带CRC
3. PRBS31不带CRC
4. PRBS31带CRC
接收报文支持PRBS码型校验，CRC校验，sequence number校验。
支持接收报文数统计，PRBS误码bit数统计，CRC错误报文数统计，和sequence number错误报文数统计。
支持接收校验错误报文触发中断，通知CPU。
UP型MEP单向TM测试流程如下
SD5182HV100 Functional Specification Page 491 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
发送TST
PRBS UP MEP FWD
DOWN
MEP
peer
MEP
学习MAC+VLAN
接收TST，计算TM
发送TST
转发
匹配MEP,重定向
到PRBS
接收TST，校验
匹配MEP
CPU
配置PRBS
计算TM
PON
透传
透传
步骤 模块 行为
1 Peer MEP 发送TM 测试用的TST 报文
2 DOWN MEP 以入口PORT+SVLAN+MDL 匹配MEP，做DOWN MEP 功能。
注:DOWN MEP 的等级应该比UP MEP 等级低，报文处理结果应
该为透传，如果做LM 则需要进行LM 统计。
3 FWD 根据MAC+SVLAN 转发到UNI 口
切换SVLAN 为CVLAN，SPBIT 为CPBIT
3 UP MEP 以PORT+CVLAN+MDL 匹配MEP，识别TM 测试，
重定向到PRBS。
携带源端口信息（PON）和目的端口信息（UNI）。
4 PRBS 接收TST，校验，上报结果到CPU
5 CPU 计算TM
1 PRBS 发送TST 报文。
DMAC 为CPU 配置DMAC。
SMAC 为CPU 配置SMAC。
VLAN 为CVLAN。
SD5182HV100 Functional Specification Page 492 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PBIT 为CPBIT。
指定转发，指定转发模板为“CPU 发送UP 方向 CFMPDU 报文”
进行端口伪装，伪装端口为TST 报文的目的端口。
指定报文发送到PON 口，同时指定gemport，tcont，pq（这3 个
信息由CPU 配置）。（或不指定，由逻辑映射）
2 UP MEP 以伪装入口PORT+CVLAN+MDL 匹配MEP，测试状态为TM 测
试，不产生任何动作。
3 FWD 切换CVLAN 为SVLAN，
学习MAC+SVLAN，
4 DOWN MEP 以出口PORT+SVLAN+MDL 匹配MEP，做DOWN MEP 功能。
注:DOWN MEP 的等级应该比UP MEP 等级低，报文处理结果应
该为透传，如果做LM 则需要进行LM 统计。
5 Peer MEP 接收TST 报文，计算DM。
DOWN 型单向MEP 测试流程：
发送TST
PRBS UP MEP FWD
DOWN
MEP
peer
MEP
接收TST，计算TM
发送TST
匹配MEP,重定向
到PRBS
接收TST，校验
CPU
配置PRBS
计算TM
PON
透传
透传
透传
透传
匹配MEP
步骤 模块 行为
1 Peer MEP 发送TM 测试用的TST 报文
2 DOWN MEP 以PORT+SVLAN+MDL 匹配MEP，识别TM 测试，
重定向到PRBS。
携带源端口信息（PON）和目的端口信息（PON）。
3 FWD 无动作
SD5182HV100 Functional Specification Page 493 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
3
UP MEP
无动作
4
PRBS
接收TST，校验，上报结果到CPU
5
CPU
计算TM
1
PRBS
发送TST报文。
DMAC为CPU配置DMAC。
SMAC为CPU配置SMAC。
VLAN为SVLAN。
PBIT为SPBIT。
指定转发，指定转发模板为“CPU发送DOWN方向 CFMPDU报文”
进行端口伪装，伪装端口为TST报文的目的端口。
指定报文发送到PON口，同时指定gemport，tcont，pq（这3个信息由CPU配置）。（或不指定，由逻辑映射）
2
UP MEP
无动作。
3
FWD
无动作
4
DOWN MEP
以出口PORT+SVLAN+MDL匹配MEP，测试状态为TM测试，不产生任何动作。
5
Peer MEP
接收TST报文，计算TM。
10.4.2.6.2 双向吞吐量
支持被动双向吞吐量测试。
UP 型MEP双向TM测试流程如下：
SD5182HV100 Functional Specification Page 494 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
发送LBR
PRBS UP MEP FWD PON
peer
MEP
切换VLAN，学习
MAC+VLAN
接收DMR，计算
TM
发送LBM
转发，切换VLAN
匹配MEP，重定
向到PRBS
接收LBM
匹配MEP
DOWN
MEP
透传
透传
步骤 模块 行为
1 Peer MEP 发送TM 测试用的LBM报文
2 DOWN MEP 以入口PORT+SVLAN+MDL 匹配MEP，做DOWN MEP 功能。
注：DOWN MEP 的等级应该比UP MEP 等级低，报文处理结果
应该为透传，
2 FWD 根据MAC+SVLAN 转发到UNI 口
切换SVLAN 为CVLAN，SPBIT 为CPBIT
3 UP MEP 以PORT+CVLAN+MDL 匹配MEP，识别TM 测试
重定向到PRBS。
携带源端口信息（PON）和目的端口信息（UNI）。
4 PRBS 接收LBM
1 PRBS 转换LBM 报文为LBR 报文。
DMAC 为LBM的SMAC。
SMAC 为配置MAC，
VLAN 为CVLAN。
SD5182HV100 Functional Specification Page 495 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PBIT 为CPBIT。
指定转发，指定转发模板为“CPU 发送UP 方向 CFMPDU 报文”
进行端口伪装，伪装端口为LBM 报文的目的端口。
指定报文发送到PON 口，同时指定gemport，tcont，pq（这3 个
信息由CPU 配置）。（或不指定，由逻辑映射）
2 UP MEP 以伪装入口PORT+CVLAN+MDL 匹配MEP，测试状态为TM 测
试，不产生任何动作。
3 FWD 切换CVLAN 为SVLAN，CPBIT 为SPBIT
学习MAC+SVLAN，
4 DOWN MEP 以出口PORT+SVLAN+MDL 匹配MEP，做DOWN MEP 功能。
注:DOWN MEP 的等级应该比UP MEP 等级低，报文处理结果应
该为透传，如果做LM 则需要进行LM 统计。
4 Peer MEP 接收LBR 报文，采样时戳，计算TM。
DOWN 型MEP 双向TM 测试流程如下
发送LBR
PRBS UP MEP FWD PON
peer
MEP
接收DMR，计算
TM
发送LBM
无动作
接收LBM
DOWN
MEP
匹配MEP，重定
向到PRBS
无动作
匹配MEP
无动作
无动作
步骤 模块 行为
1 Peer MEP 发送TM 测试用的LBM报文
2 DOWN MEP 以PORT+SVLAN+MDL 匹配MEP，识别TM 测试
重定向到PRBS。
携带源端口信息（PON）和目的端口信息（PON）。
SD5182HV100 Functional Specification Page 496 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
2
FWD
无动作
3
UP MEP
无动作
4
PRBS
接收LBM
1
PRBS
转换LBM报文为LBR报文。
DMAC为LBM的SMAC。
SMAC为配置MAC，
VLAN为SVLAN。
PBIT为SPBIT。
指定转发，指定转发模板为“CPU发送DOWN方向 CFMPDU报文”
进行端口伪装，伪装端口为LBM报文的目的端口（PON）。
指定报文发送到PON口，同时指定gemport，tcont，pq（这3个信息由CPU配置）。（或不指定，由逻辑映射）
2
UP MEP
无动作
3
FWD
无动作
4
DOWN MEP
以出口PORT+SVLAN+MDL匹配MEP，测试状态为TM测试，不产生任何动作。
4
Peer MEP
接收LBR报文，采样时戳，计算TM。
10.4.2.7 SLM检测
逻辑不进行SLM检测，仅识别并捕获SLM报文，交CPU。由CPU完成SLM检测。 10.4.2.8 限制点
无法做到1AG定义的MEP在Bridge层次中的位置，
没有1AG时Bridge的层次如下：
批注 [Z(3]: 李智帮忙确认是否还存在这个限制。
SD5182HV100 Functional Specification Page 497 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
加入1ag之后的Bridge层次结构如下：
SD5182HV100 Functional Specification Page 498 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
对于UP 型MEP，其位于port filtering entities（主要是VLAN检查）之上，frame filtering（主要是协议报文处理和基于MAC+VLAN的过滤表）之下。
对于DOWN型MEP，位于port filtering entities之下，Queuing entities（CAR，队列）之上。
SD5182HV100 Functional Specification Page 499 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Level1的DOWN型MEP，则位于Queuing entities之下。
对于UP型MEP，是在port filtering entities之上，frame filtering之下。对于down型MEP，位于port filtering entities之下，Queuing entities之上。
对于UP型的MEP，其入口处理的报文都是VLAN检查之后的，出口处理的报文都是VLAN检查和队列管理之前（CAR之后，入队之前）的。
对于DOWN型MEP，其入口处理的报文都是VLAN检查之前的，出口处理的报文都是VLAN检查之后，队列管理之前（CAR之后，入队之前）的。
SD5182HV100 Functional Specification Page 500 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
10.5 IP FPM
10.5.1 整体方案
CPU/PIE
PSA
U
N
I
N
N
I
E
P
S
I
P
S
P
E
H
A
主要由6 个单元配合实现：IPS，HA，PSA，PE，EPS，CPU/PIE。各个单元的主要功能
是：
处理单元 功能（4 路）
IPS 透传报文。
HA FC 五元组报文解析，透传给PSA
PSA 五元组匹配 ACL 实现
提供丢包相关配置（使能，流标识，颜色，着色位置等）
支持根据流标识，对报文进行着色，支持单bit 染色，染色
位置可配置，并统计
支持对着色报文进行统计
支持即时颜色切换
支持丢包周期计时
支持丢包相关配置
支持读取统计计数
PE 根据编辑命令完成报文编辑，计算checksum。
EPS 正常发送报文。
CPU/PIE 生成报文，收发报文。可查询各模块统计。
批注 [Z(4]: FC 匹配，或者在PSA 识别？
SD5182HV100 Functional Specification Page 501 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
此OAM报文由微码处理和统计，逻辑仅提供通道。
10.5.2 具体功能
IP FPM（Flow Performance Monitor）特性：
1. 只支持UNI,NNI上行方向的IP FPM测量，支持丢包测量和时延测量。
2. 支持4条业务流配置，业务流识别条件有：SIP，DIP，ip protocol，DSCP，sPort，dPort，物理端口，可掩码。收发共用。
3. 基于业务流，支持丢包测量和时延测量，同一业务流，支持两种测量。
4. 只支持IPv4 FPM测量，不支持IPv6 FPM测量。
5. 支持单向组播测量，支持单组播源，双组播源测量，仅支持作为组播叶子测量节点。
6. 全局可配置，
– IPv4丢包测量染色位置：TOS [3:7]，ipv4 flag[0]。单bit配置，Uppoint/Downpoint共用。
– IPv4时延测量染色位置：TOS [3:7]，ipv4 flag[0]。单bit配置，Uppoint/Downpoint共用。
– IPv4组播源指示位置：TOS [3:7]，ipv4 flag[0]。单bit配置。
7. 基于业务流可分别配置，
– 单组播测量指示。
– 丢包测量使能。
– 丢包测量Uppoint方向染色颜色。单bit配置。Downpoint方向支持可配置颜色清0.
– 时延测量Uppoint使能，时延测量Uppoint染色触发，Downpoint检测使能（缺省使能）。
– 时延测量时，Uppoint方向非采样报文染色bit清0，采样报文染色bit置1. Downpoint是否将染色bit清0（可配置）。
– 组播测量时，Downpoint是否将组播源指示bit清0（可配置）。
8. 基于业务流提供，
– 丢包测量Uppoint颜色0，颜色1统计。RWC类型
SD5182HV100 Functional Specification Page 502 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
– 丢包测量Downpoint颜色0，颜色1统计。RWC类型
– 只支持协议定义的累计计数。
– 丢包测量颜色统计支持帧个数(64bit)，字节数（64bit）。其中字节数为IP报文长度。
– 丢包测量Downpoint方向当前颜色状态。（连续N个报文颜色相同时，切换颜色状态。）
– 时延测量Uppoint时戳，支持1588V2标准时戳（80bit），CPU查询(64bit)。
– 时延测量Downpoint时戳，接收报文指示（RWC类型），CPU查询。
– 时延测量接收报文颜色，报文长度（IP报文长度）。
– 时延测量时，支持Uppoint，Downpoint记录报文的IP五元组。
– 组播测量时，组播源指示（RO）和组播源切换指示(RWC)。
9. 支持IPv4报文染色后，ip head checksum重校验。
10. 只支持单播报文的测量，不支持组播，广播，未知报文的测量。对于内部拷贝，只支持对原始报文着色和统计。
11. 不支持IPinIP隧道报文的测试。
12. 不支持维护域重叠（同一个端口匹配多条流）和嵌套（UNI和NNI同时匹配）。
13. 支持ACL对NTP报文的捕获
14. 支持分片报文处理
SD5182HV100 Functional Specification Page 503 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
10.5.2.1 丢包测量
10.5.2.1.1 发送方向的丢包测量
着色
五元组 颜色配置 颜色0统计 颜色1统计
CPU
PSA
报文
报文
TMS
计时
PE
报文
功能分工：
模块 功能描述
CPU（软件
）
1.支持ONU 与远端通信
2.支持丢包相关配置
3.支持读取统计计数
PSA 1.提供丢包相关配置（使能，流标识，颜色，着色位置等）
2.支持根据流标识，对报文进行着色，支持单bit 染色，染色位置可配置，
并统计。
3.支持对着色报文进行统计。
4.支持丢包周期计时。
5.支持即时颜色切换。
TMS 1. 支持1588V2标准80bit计时器
2. 发送时间到PSA
PE 1. 报文编辑，重新校验checksum。
流程描述：
1. 软件和远端设备进行ip fpm 相关通信；
2. 软件配置PSA（流标识，颜色，着色位置等），使能ip fpm 功能；
SD5182HV100 Functional Specification Page 504 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
3. PSA 进行周期计时 ；
4. PSA 匹配报文，进行染色，并统计；
5. PSA 切换颜色，并切换统计；
6. 软件读取采样统计，发送到远端。
10.5.2.1.2 接收方向的丢包测量
颜色检查
五元组 颜色0统计 颜色1统计
CPU
PSA
报文
报文
TMS
计时
PE
报文
功能分工：
模块 功能描述
CPU（软件
）
1.支持ONU 与远端通信；
2.支持丢包相关配置；
3.支持读取统计计数。
PSA 1.提供丢包相关配置（使能，流标识，颜色，着色位置等）；
2.支持根据流标识，对报文颜色进行检查，并统计；
3.对着色进行清0.若为组播测量，将组播源也清0；
4.支持丢包周期计时；
5.支持当前颜色状态上报 。
（注：需要讨论的问题，如果避免刚启动时的颜色误统计）
TMS 3. 支持1588V2标准80bit计时器
4. 发送时间到PSA
SD5182HV100 Functional Specification Page 505 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PE 2. 报文编辑，重新校验checksum。
流程描述：
1. 软件和远端设备进行ip fpm相关通信；
2. 软件配置PSA 使能ip fpm功能；
3. PSA 匹配报文，根据颜色，并统计；
4. 软件读取前一周期采样统计，发送到远端；
5. 软件将统计计数器清。
10.5.2.2 时延测量
10.5.2.2.1 发送方向时延测量
着色
五元组 颜色配置 时戳 报文信息
CPU
PSA
报文
报文
TMS
计时
PE
报文
功能分工：
模块 功能描述
CPU（软件
）
1.支持ONU 与远端通信
2.支持时延相关配置
3.支持查询，读取时戳和报文信息
PSA 1.提供时延相关配置（使能，流标识，颜色，着色位置等）
2.支持根据流标识，对报文进行着色，支持单bit 染色，染色位置可配置。
SD5182HV100 Functional Specification Page 506 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
3.支持延时周期计时
4.支持对着色报文进行记录，供CPU 查询
PE 3. 报文编辑，重新校验checksum。
流程描述：
1. 软件和远端设备进行ip fpm 相关通信；
2. 软件配置PSA（流标识，颜色，着色位置等），使能ip fpm 功能；
3. PSA 进行周期计时；
4. PSA 匹配报文，进行染色，记录时戳和报文信息，供CPU 查询；
5. 软件读取时戳，发送到远端。
10.5.2.2.2 接收方向时延测量
着色
五元组 时戳 报文信息
CPU
PSA
报文报文
TMS
计时
PE
报文
功能分工：
模块 功能描述
CPU（软件
）
1.支持ONU 与远端通信
2.支持时延周期计时
3.支持时延相关配置
4.支持读取接收时戳
PSA 1.提供丢包相关配置（使能，流标识，颜色，着色位置等）
SD5182HV100 Functional Specification Page 507 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
2.支持根据流标识，对报文进行颜色检查。
3.支持对着色报文进行时戳记录，报文信息记录 ，并给出匹配报文指示
PE
4. 报文编辑，重新校验checksum。
流程描述：
1. 软件和远端设备进行ip fpm相关通信，
2. 软件配置PSA使能ip fpm功能
3. PSA匹配报文，根据颜色，记录时戳和报文信息，给出匹配报文指示，供CPU查询。
4. 对着色进行清0.若为组播测量，将组播源也清0.
5. 软件读取时戳，发送到远端。
6. 清除匹配报文指示。 10.5.2.3 IP分片报文处理
10.5.2.3.1 丢包测试分片报文处理
匹配流规则时，IP首片报文匹配时用报文解析的端口号匹配，后续片端口号的字段直接填0，匹配流规则时，根据寄存器选择，使用端口号0或不使用端口号进行匹配。
首片命中流规则以后计数时包计数和字节计数都统计，后续片命中流规则以后计数只计字节计数，不计包计数。
后续片是否匹配流规则提供寄存器可配置。
10.5.2.3.2 时延测试分片报文处理
Uppoint只选择非分片报文来设置时延测量标志位，Uppoint收到的分片报文（包括首片）的时延测量标志位始终清0。
Downpoint只选择时延测量标志位置1的分片报文的首片去查流规则，后续片不查流规则直接透传通过时延测量处理模块。
批注 [Z(5]: 是否需要支持？
SD5182HV100 Functional Specification Page 508 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
10.6 RFC2544
RFC2544 定义了一套标准的方法评估网络的性能，此方法屏蔽了不同网络场景以及检测
报文格式的差异，是一套标准的网络的性能评估方法。通过2544 报文测量，在网络业务
割接之前，能够评估网络是否达到预先设计的性能指标：吞吐量、丢包、时延抖动。
10.6.1 整体方案：
CPU/PIE
PSA
U
N
I
N
N
I
E
P
S
PRBS
I
P
S
P
E
H
A
RFC2544 按照测量种类分为四种：学习测量、时延测量、流量测量、丢包率测量。其中
的学习测量和时延抖动测量由CPU 通过PIE 模块发送和接收。流量和丢包率测量由
PRBS 完成发送和接收，并进行报文数的统计。
主要由7 个单元配合实现：IPS，HA，PSA，EPS，PE，CPU/PIE，PRBS。各个单元的主
要功能是：
处理单元 功能（1 路）
IPS 透传数据，生成FCB 报文头。
HA FC 五元组报文解析，透传给PSA。
PSA 支持2544 报文识别。
支持2544 报文协议处理。
产生2544 报文编辑命令，确定出端口。
支持报文统计。
PE 根据报文编辑命令，完成报文编辑。
EPS 根据出端口调度出队。
CPU/PIE 学习测量和时延抖动测量收发包，查询统计。
SD5182HV100 Functional Specification Page 509 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PRBS
产生2544报文净荷，并根据配置添加报文头。
流量和丢包率测量收发包。
接收PRBS报文，并统计。
10.6.2 具体功能
 支持网络时延测量；
 支持网络吞吐量测量，最大带宽为收发各4Gbps；
 支持网络丢包率测量；
 支持指定测量报文内容和长度；
 支持逻辑对报文打时间戳；
 支持单条流进行测量，最大流量为4Gbps；
 基于物理端口支持阻断，阻断即不带业务测量，非阻断即带业务测量；
 支持从入口插入捕获报文进行测量，不支持从出口插入报文进行测量；
 支持报文反射，即报文的目的端口即为报文的输入端口；
 支持报文过滤，即通过识别RFC2544报文，进行丢弃；
 支持报文乱序识别，乱序报文仅统计不丢包；
 不支持随机包长发送；
 不支持IPV6报文、不支持隧道报文。
流量和丢包率测量由PRBS收发包处理。CPU配置64B报文头到PRBS模块中，净荷部分由PRBS产生。报文body数据由软件指定为全0、全1、或者是PRBS码流，body的长度可配置。RFC2544报文头格式固定如下：
SD5182HV100 Functional Specification Page 510 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Figure 10.6-1 RFC2544 HEAD DATA
Name Description
DMAC
目的MAC地址，CPU配置
SMAC
原MAC地址，CPU配置
VLAN
VLAN ID，CPU配置
IP
报文IP地址，由CPU指定或配置
UDP
报文UDP头，由CPU配置
时延
2544时延测量报文标识。此类型的CPU通过PIE下发和接收，通过报文内时戳信息，计算报文在链路上的延时大小
学习
2544学习报文标识。此类型的报文由CPU通过PIE下发和接收，通过学习建立测量链路
丢包
流量测量、丢包率测量报文标识，PRBS进行2544报文收发，并统计出收发包个数，此类型报文不发送给CPU
TSTID
测量模式配置：多流同时收发时用到。暂时保留
测试例校验
测量报文正确性校验值。发送的时候，由软件指定好，接收的时候，根据tstid获得CPU配置在PRBS中的校验值，和报文中的此校验值进行比较，如果不相等，进行错误统计
xTimestamp
时间信息，分别填充32bit的秒时间和32bit的纳秒时间，由PE模块进行刷新
SEQID
序列号；起始序列号由CPU配置到PRBS模块。发送时打上序号；接收侧进行乱序的识别，吞吐量测量、丢包率测量时使用序号，学习报文不关心。时延测量时，发起端接收到反射回来的时延报文时，需要用接收到的时戳信息替换此序列号。
RSVD
保留位，逻辑填全0
Table 10.6-1 RFC2544 Head Parameter Description
简单测量组网如下：
SD5182HV100 Functional Specification Page 511 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
AC
UNI侧
二层口
CE
发起端
接口B
反射端
接口A
Figure 10.6-2 RFC2544 APPLICATION
芯片可配置支持RFC2544 测量包括两个角色：发起端和反射端，但不能同时支持。
发起端通过接口B 发送2544 测量报文，反射端通过接口A 接收测量报文，经过MAC 地
址学习、地址交换后，测量报文通过接口A 返回，发起端通过接口B 收到反射的报文，
进行统计、延时计算、序列号统计操作，完成测量。
PSA 通过出端口号、MAC、IP、UDP Port、报文类型标识（学习、丢包、时延）识别
2544 测量报文，其中MAC、IP、UDP Port 可独立配置一组掩码，收发共用。
UDP Port 默认值为：目的端口号为0x7，源端口号为0xC020。
2544 测量流程：
 配置MAC 地址、配置本地角色；
 启动学习报文测量；
 启动时延测量或吞吐量测量或丢包率测量；
 收集测量结果信息，给出测量结果。
下面分别详细描述学习报文测量、时延测量、吞吐量测量、丢包率测量过程，吞吐量和丢
包率可以在同一个测量用例中实现，放在一个流程中描述。
10.6.2.1 学习测量
CPU 通过PIE 进行报文收发，具体步骤：
发起端：
 步骤1、CPU 配置MAC 地址；
 步骤2、CPU 通过PIE 端口发送2544 学习报文，SMAC 为PIE 端口MAC；
 步骤3、PSA 识别2544 学习报文；
 步骤4、PSA 根据阻断配置完成此出端口其他报文的丢弃；
SD5182HV100 Functional Specification Page 512 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 步骤5、PSA识别报文的SMAC和配置的SMAC一致，转发此学习报文到出端口；
 步骤13、PSA识别2544学习报文；
 步骤14、PSA识别到报文中DMAC和配置的SMAC一致时，转发学习报文到CPU。
反射端：
 步骤1、CPU配置MAC地址；
 步骤6、PSA识别到2544学习报文；
 步骤7、PSA学习到发起端MAC（即SMAC）；
 步骤8、PSA根据配置获取入端口反射、或出端口反射；
 步骤9、PSA根据阻断配置完成此出端口其他报文的丢弃；
 步骤10、PSA识别如果配置了MAC/IP，则过滤MAC/IP，否则，基于出端口环回；
 步骤11、PE根据编辑命令（MAC/IP/UDP端口号交换）完成学习报文头编辑；
 步骤12、转发学习报文到出端口；
系统连续多次学习报文测量成功，则认为学习测量结束。
10.6.2.2 时延测量
CPU通过PIE进行报文收发，具体步骤：
发起端：
 步骤1、CPU配置MAC/IP地址；
 步骤2、CPU通过PIE端口发送2544时延测量报文；
 步骤3、PSA识别2544时延测量报文；
 步骤4、PSA根据阻断配置完成此出端口其他报文的丢弃；
 步骤5、识别报文SMAC和配置SMAC一致，PSA转发此时延报文到出端口；
 步骤6、PE根据编辑命令（刷新时戳信息）完成报文头编辑；
 步骤7、EPS调度2544时延报文到出端口；
 步骤15、PSA识别2544时延报文；
 步骤16、当报文的DMAC/DIP为配置的SMAC/SIP时，转发学习报文到CPU；
SD5182HV100 Functional Specification Page 513 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 步骤17、PE根据编辑命令（用本地时戳信息替代报文头序列号）完成报文头编辑；
 步骤18、EPS调度时延测量报文到PIE，发送给CPU；
 步骤19、CPU读取两个时戳信息，计算出RTD值。
反射端：
 步骤1、CPU配置MAC/IP地址；
 步骤8、PSA识别到2544时延报文；
 步骤9、PSA根据配置获取入端口反射、或出端口反射；
 步骤10、PSA根据阻断配置完成此入端口、出端口其他报文的丢弃；
 步骤12、PSA识别如果配置了MAC/IP，则过滤MAC/IP，否则，基于出端口环回；
 步骤13、PE根据编辑命令（MAC/IP/UDP端口号交换）完成时延报文头编辑；
 步骤14、转发时延报文到出端口；
系统可以指定包长，周期性进行时延测量，获取平均时延值。
系统可以指定不同包长，多次进行时延测量，测量出不同包长下的转发时延。
10.6.2.3 吞吐量、丢包率测量
CPU配置PRBS进行报文收发，具体步骤：
发起端：
 步骤1、CPU配置MAC/IP地址；
 步骤2、CPU配置PRBS发送2544吞吐量测量报文，SMAC为PRBS端口MAC；
 步骤3、PRBS按照CPU配置的报文长度、发包间隔启动发包，同时按照CPU配置的初始序列号对发送报文进行累加编号；
 步骤3、PSA识别2544测量报文；
 步骤4、PSA根据阻断配置完成此出端口其他报文的丢弃；
 步骤5、PSA判断报文SMAC/SIP和配置的SMAC/SIP一致，转发时延报文到出端口；
 步骤6、PE根据编辑命令（或无编辑命令）完成报文头编辑；
SD5182HV100 Functional Specification Page 514 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
 步骤7、EPS调度2544时延报文到出端口；
 步骤15、PSA识别2544时延报文；
 步骤16、当PSA识别到报文的DMAC/DIP为配置的SMAC/SIP时，转发吞吐量报文到PRBS；
 步骤17、PE根据编辑命令（或无编辑命令）完成报文头编辑；
 步骤18、EPS调度吞吐量报文到PRBS；
 步骤19、PRBS接收吞吐量报文，进行TSTID的校验码验证，验证错误进行统计；
 步骤20、PRBS同时进行序列号的进行识别和计算，并统计序列号出现跳变的情况；
 步骤21、PRBS发送、接收报文的同时，分别进行发送、接收报文个数的统计。
 步骤22、CPU配置测量结束，读取各统计值，分析测量结果。
反射端：
 步骤1、CPU配置MAC/DIP地址；
 步骤8、PSA识别到2544时延报文；
 步骤9、PSA根据配置获取入端口反射、或出端口反射；
 步骤10、PSA根据阻断配置完成此出端口其他报文的丢弃；
 步骤12、PSA识别如果配置了MAC/IP，则过滤MAC/IP，否则，基于出端口环回；
 步骤13、PE根据编辑命令（MAC/IP/UDP端口号交换）完成时延报文头编辑；
 步骤14、转发时延报文到出端口；
在固定包长下，系统通过发送不同速率的吞吐量测试报文，直到连续两次测量没有出现丢包，则认为找到此包长下的最大流量值。通过遍历不同包长，可以找到不同包长下的吞吐量值。
同时，通过不同包长，不同速率下的收发报文个数统计，可以获取不同包长、不同速率下的丢包率。
RFC2544报文过滤：PSA在识别到2544报文后，按照CPU配置的过滤操作，把2544报文转发到PRBS，PRBS做报文统计，丢弃处理。
业务报文阻断：PSA在识别到此物理端口的阻断配置后，此端口的非2544报文需要丢弃，PSA对此端口接收到的非2544报文打丢弃标识。由DP丢弃报文。非阻断配置下，此端口的其他业务报文正常转发，不能丢弃。
SD5182HV100 Functional Specification Page 515 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
RFC2544的学习报文、时延测量报文由CPU进行通过PIE进行报文收发，CPU对报文内容进行配置和校验。CPU和PIE交互流程没有特殊点。
RFC2544的吞吐量测量、丢包率测量是在PRBS模块进行，PRBS按照CPU配置的报文头格式、报文长度、发包间隔、发包模式、秒发包个数、发送测量使能、接收测量使能等参数生成测量报文进行发送。发包模式分两种模式：burst、continuous。
 Burst模式下，CPU根据报文长度大小，来配置每秒钟发送的报文个数，逻辑在1秒内连续发包，直到发送配置的报文个数为止。在下一个1秒到时，再次连续发送到配置的报文个数为止。
 Continuous模式下，CPU按照配置的发包周期进行报文的发送，可设置为每100xNns、1xNus等发送一个报文。当配置值小于最快发包周期时，按最大发包周期进行。
PRBS在发送和接收吞吐量测量、丢包率测量的RFC2544报文时，需要对报文的序列号字段进行处理，发送报文时按照CPU配置的起始序列号进行累加一发送各个报文。接收时需要针对序列号字段进行检测，发现接收的序列号小于之前接收报文的序列号时，则判断报文乱序，置乱序状态标识，同时进行错序统计。
PRBS在收发包过程中，需要对收发包进行独立统计，通过收发报文的个数统计，由CPU计算完成线路丢包率的计算。统计寄存器读清。
PRBS在收包过程中，需要对收包的TSTID进行识别，通过TSTID找到CPU配置的测量例校验值，通过比较CPU配置的校验值和报文中的校验值，如果错误进行统计，CPU配置校验值。
SD5182HV100 Functional Specification Page 516 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
10.7 Y.1564
在RFC2544基础上，实现流量整形的桶溢出功能；
1564的延时测量报文、抖动测量报文同样由CPU配置PRBS进行收发，PSA针对报文时戳部分进行处理，方便CPU计算延时和抖动；
不支持带业务进行1564测试；
PSA基于流实现1564测量，配置相应的CIR/EIR，对报文进行染色；
PSA支持针对1564进行CAR操作；
PSA支持报文绿色、黄色独立统计；
1564测量支持单向测量；
PSA支持发起端、终结端、反射端三个模式；
支持多种长度的测量报文收发，具体参考下面描述：
流量测量和丢包率测量由CPU配置报文头到PRBS模块，PRBS进行1564测量报文的发送和接收。相对于RFC2544，1564测量需要支持最多8个不同长度的测量报文同时发送。需要配置的寄存器有：有效位标识、有效长度、发包周期。
在一个发包周期内，不同长度的测量报文顺序发送，各报文发送一遍后，再次循环顺序发送不同长度的测量报文。直到CPU配置测量结束。
10.7.1 整体方案：
参考RFC2544整体实现。
SD5182HV100 Functional Specification Page 517 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
11 1588
本章描述芯片的1588功能。
11.1 TIMESTAMP
TimeStamp模块主要完成在1588场景下，对同步时间的计数，维护本地的标准时间；ETH接口MAC打时戳时获取的标准时间也从TimeStamp模块获取；此外，外时间接口1pps传输的时间也从TimeStamp获得；本地时间计数器还可以在秒脉冲到来时上报中断，并提供时间读接口给CPU。
TimeStamp的同步方式根据应用方式的不同，支持以下时间同步方式，具体采用哪种同步方式采用寄存器配置：
 GPON/XGPON私有时间同步方式
 EPON/XEPON私有时间同步方式(包括TK模式和802.1AS模式)
 GE、百兆模式支持1588时间同步方式
 1pps+TOD输入时间同步方式
 NNI口支持Slave，UNI口支持Master
TimeStamp还支持以下外部接口：
 支持通过I2C接口由外接时钟设备计算时间
 支持1pps+TOD输出时间同步
 支持8k时钟输出
SD5182HV100 Functional Specification Page 518 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
11.2 1588 报文处理流程
1pps in 1pps out
EPS
ETH_MAC
0~3 PSA
ECS
TMS
TSD
CRG
P
I
E
M
P
I
PON
MAC
IPS
PE
1
2
3
5
6
7
8
10
9
11
4
Figure 11.2-1 SD5182H PTP1588 架构图
11.2.1 ETH Mac Rx 方向处理流程
报文流向：--->
1
--->
2
--->
3
-->
4
->
5
->
6
1
从线路侧接收以太报文，1588 报文与数据报文从线路侧被接收。
2
IPS 从ETH MAC 接收数据报文和1588 报文，1588 报文带内传输接收时戳（报文尾
部携带时戳信息），接收时戳基于TMS 的RTC 计时在ETH MAC 打的。
3
IPS 将接收到的1588 报文和数据报文一同传送给PSA，时戳信息位置在报文尾部不
变（5118 项目为IPS 取时戳信息放在报文头的FCB 中）。
4
PSA 内部解析报文，识别PTP1588 报文，生成报文编辑命令，发送给PE。时戳信
息默认在报文尾部不变，如果需要时戳信息放在报文头的FCB 中，则需要微码给出相应
的编辑命令。
PSA 针对1588 模式下的数据报文，需要固定删除尾部的时戳信息。
5
PE 按照编辑命令完成报文编辑后入队。
6
1588 报文被EPS 调度出队后，转发到PIE 接口，CPU 接收1588 报文。
SD5182HV100 Functional Specification Page 519 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
11.2.2 ETH Mac Tx 方向处理流程
报文流向：
7
-->
3
-->
4
-->
8
-->
1
7
CPU 基于状态机判断是否需要进行发包，CPU 构造发包内容和命令通过PIE 发送，
对Sync 报文和Follow_Up 报文，可以使用PIE 内的周期发包机制进行发送。
3
IPS 不识别1588 报文，直接转发到PSA，PSA 识别报文，生成报文编辑命令，发送
到PE，PE 按照指示修改报文内容。
4
PE 按要求编辑命令修改报文内容，包括修改sequence id（微码给出替换命令）、
checksum 计算等。编辑完成后入队。
8
EPS 调度出队后发送报文至ETH MAC，MAC 按照报文头的控制信息修改报文内容。
1
MAC 修改完报文内容后，通过外部接口发送报文。
CPU 发送报文时，定时发送报文可以使用PIE 的定时发送器来完成，包括Sync，
Follow_Up，Delay_req，Pdelay_req，Announce，PIE 定时发送报文不支持sequence id 的
自动递增，由微码识别并生成编辑命令后，PE 完成sequence id 的替换。PE 除按照编辑命
令完成sequence id 的修改外，还需要计算新的checksum 并更新。
发送的1588 报文时戳是在MAC 更新的，MAC 在更新时戳后，会重新计算checksum 并
更新。
微码根据port ID 域＋端口来维护每个端口的1588 报文sequence id 值。5182H 项目端口
数为7。
11.2.3 1588 报文PIE 收发包格式
11.2.3.1 PIE 发包格式
1588 报文发送可以通过CPU 直接构造包或者由PIE 定时发包机制发送，两种方
式发送的报文都需要符合特定的报文格式。
对CPU 或PIE 发送的报文，在SD5182 均包括两部分，一部分为报文的控制部分，
即FCB，共64bit，各bit 含义可以参考《SD5182HV100 PIE 接口数据格式》”描
述。另一部分为报文数据部分。
在此需要说明的是如果发送需要逻辑配合处理的1588 报文，则FCB 里的cpu_act
要配置为0x2。
SD5182HV100 Functional Specification Page 520 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
如果发送报文的cpu_act=0x2，则报文的数据部分如下表描述，报文内容的前
8BYTE 为1588 报文的控制信息，用于通知逻辑的动作。实际上只使用前面的
5BYTE，后面的3BYTE 要求填充为全0。
15 14 13 12 11 10 9 8 7 6 5 4 3 2 1 0
sop MCF[2:0] RTS RTP IPv6 OFFSET[9:0]
PID[7:0] SQID[15:8]
SQID[7:0]
Table 11.2-1 软件发送1588 报文格式
 MCF[2:0]：Opcode，指示时戳修改方式，具体如下；
• 000，无操作。
• 001，New 80bits Timestamp = 80bits Timestamp + TX_Port_Delay。
• 80bits Timestamp[79:32](+/-1)，
• //80bit S 部分，不做-1 溢出保护，不做+1 翻转保护，下同。
• 80bitsTimestamp[31:0] +/- {9'b0,TX_Port_Delay[22:0]}。
• //80bit NS 部分，减法从S 部分借1，下同。
• 010，The New CF = Original CF- Asym_Delay.
• // 修改CF 域 48bit NS 整数部分，不做减法溢出保护，不做加法翻转保护，下同。
• 011，The New CF = Original CF + 48bits Timestamp + TX_Port_Delay。
• 100，寄存序列信息；
new80bit = ts80_add_latency=80bits Timestamp + TX_Port_Delay（加入port 延时处理）
；
new48bit = ts48_add_latency=48bits Timestamp + TX_Port_Delay（加入port 延时处理）
。
• 101，若序列信息比对相等,new 80bit timestp = new80bit。序列信息不相等，不修改时
戳，并对报文标错。
SD5182HV100 Functional Specification Page 521 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
• 110，The New CF = Original CF + 48bits Timestamp + TX_Port_Delay - Asym_Delay。
• 111，若序列信息比对相等, The New CF = new48bit + Original CF (current packet)。序
列信息不相等，不修改时戳，并对报文标错。
 RTS: 时戳回传使能, 1 有效;回传32bit 时戳信息，24bit 序列信息，5182H 项目不使用。
 RTP:返回时戳类型;
 1’b0:来自80-bit 时戳;{80bit_ts[33:32], 80bit_ts[29:0]};
 1’b1:来自48-bit 时戳;{48bit_ts[31:0]}。
 IPV6:为1 表示是IPV6 封装，需要更新checksum。udp_offset 由OFST 推算而来（
OFST 减去40BYTE），详见3.5。
 OFST[9:0]: 1588 payload 偏移指示，从DMAC 开始计算。
 即OFST[9:0] = 6 + 6 + 2 + X byte；（具体数据如下图）。
DMAC
SMAC
Ethernet
Type
Operation
Code
Other Field
1588 Payload Field
FCS
Ethernet
header
Ohter
Field
payload
6Byte
4 Byte
Extended 1588 Payload
Field
44～64Byte
FCS
6Byte
2Byte
8Byte
XByte
2Byte
Offet Pointer
Figure 11.2-2 CPU 发送1588 报文格式
PID[7：0]：标识报文类型。
MCF[2:0]为3'b100 时，寄存序列信息为seq_id[23:0]；
MCF[2:0]为3'b101 或3'b111 时，寄存序列信息为seq_id_ff[23:0]，若seq_id_ff 与seq_id
相等，则对时戳做出相应更新操作，否则不更新时戳，并产生包错误指示标志；
SD5182HV100 Functional Specification Page 522 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
当RTS为1时，表示序列信息seq_id[23:0]需要寄存，并送入时戳回传寄存器。
11.2.3.2 PIE收包格式
从ETH端口接收到1588报文通过芯片硬件转发后，通过EPS被PIE接收，PIE接收到的报文内容具有两部分，一部分为控制信息，具体描述参考《SD5182HV100 PIE接口数据结构》，另一部分为数据信息。
首先对于CPU接收到报文，其控制信息里会带有一个预先定义的cpu reason。这个cpu reason由微码生成，放在FCB中。
PE不识别这个cpu reason字段，按照微码给的编辑命令完成报文编辑后入队。
EPS根据出端口信息，把报文调度出队后发送给PIE，软件可以根据接收报文的cpu reason来判断报文格式是否为1588特殊格式。
具体接收的1588报文数据信息默认格式如下（不带FCB信息）：
15
14
13
12
11
10
9
8
7
6
5
4
3
2
1
0
PAYLOAD
PAYLOAD
TIMESTAMP[31:16]
TIMESTAMP[15: 0]
Table 11.2-2 软件接收1588报文格式
如果软件要求本地时戳信息放在报文头部，则TIMESTAMP[31:0]信息需要放在PAYLOAD前面。
TIMESTAMP[31:0]:接收报文时戳的低32bit，即ns部分。
PAYLOAD：报文净荷，从DMAC开始。
11.2.4 GPON/XGPON的同步方式
OLT采样下行方向报文的SuperCount及其对应的时间，OLT通过管理消息通道将采样信息下发给SD51XX。终端软件读取OLT下发的信息后配置SD51XX触发的SuperCount和对应的同步时间数值，当SD51XX接收到下行帧的SuperCount与配置匹配时，将软件配置同步时间刷新到本地时间，实现SD51XX本地时间与OLT时间同步，产生同步的1pps，并输出对应1pps时间数据。
GPON模式下时间接口的功能框图如下图所示。
SD5182HV100 Functional Specification Page 523 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
SerDes GPON TIMESTAMP 模块
ICSS子系统
下行帧帧头信号
SuperCounter
命中信号
SuperCounter
配置
1pps输出有效
中断信号
同步TIME
配置寄存器
1pps
输出
TOD
1pps输出脉冲
TOD UART口输出
GPON SerDes恢复线路时钟
Figure 11.2-3 GPON 时间接口的功能框图
T1
T2
T5
T4
T3
T6
T7
OLT ONU
SuperCounter
TSOLT
SuperCounter
TSONU=TSONU+T1+T2+T3
PLOAM
TSOLT
TSONU
最远点－EQD
Figure 11.2-4 GPON 时间同步示意图
如上图所示：
T1：OLT 的发送光路处理时间。
T2：OLT 到ONT 的光纤传输时间。
SD5182HV100 Functional Specification Page 524 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
T3：ONT的接收光路处理时间。
T4：ONT处理报文的时间。
T5：ONT发送光路处理时间。
T6：ONT到OLT的光纤传输时间。
T7：OLT接收光路处理时间。
TSONT=TSOLT＋Delay，软件需要根据OLT发送的数据计算出延时Delay。
假设T1+T2+T3=T5+T6+T7时，Delay＝T1+T2+T3=(最远点–EQD–T4)/2。
在SD51XX中SerDes接口进行串并转换时间20ns，并串转换的时间为40ns，
T4=(FIXED_DELAY+49)6.43+40+20（ns）
Delay=(最远点–EQD–T4)/2+20+(106.43)（ns）
PLOAM帧Correct_Time表如下所示。
Octets
Content
Description
1
255
ONU-ID，广播
1
249
Message ID
1
0
索引，为0
6
TS_s[47:0]
时间计数器秒计数
3
Reserved
保留
Table 11.2-3 PLOAM帧Correct_Time表／OMCI
Octets
Content
Description
1
255
ONU-ID，广播
1
249
Message ID
1
1
索引，为1
4
SuperCount[29:0]
suppercount第29～0位
4
TS_ns[31:0]
时间计数器纳秒计数
1
Reserved
保留
Table 11.2-4 PLOAM帧Correct_Time表
SD5182HV100 Functional Specification Page 525 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PLOAM帧Ext_Range_Info 表如错误!未找到引用源。所示。
Octets Content Description
1 ONU-ID ONU-ID，单播
1 250 Message ID
1 1 索引，为1
4 RTDmax[31:0] 最远点ONU RTD
5 Reserved 保留
Table 11.2-5 PLOAM帧Ext_Range_Info 表
11.2.5 EPON 的同步方式
ONT 注册后，ONT 与OLT 的MAC 层Timestamp 计数器同步，OLT 将通过OAM 帧广
播下发PPS 时对应的时间和下一个秒脉冲的Timestamp 数值，并单播下发OLT 计算ONT
的RTT。终端软件通过读取OLT 下发的信息后配置SD51XX 触发的Timestamp 和对应的
同步时间数值，当SD51XX EPON 的Timestamp 计数器与软件配置匹配时，将软件配置的
同步时间刷新到本地时间，实现SD51XX 本地时间与OLT 时间同步，并输出PPS 时间数
据。
EPON 模式下时间接口的功能框图如下图所示：
EPON
SerDes
TIMESTAMP 模块
CPU子系统
PPS
命中信号
Timestamp
配置
1pps输出有效
中断信号
同步TIME
配置寄存器
1pps输
出TOD
1pps输出脉冲
TOD UART口输出
125MHz时钟
Figure 11.2-5 EPON 模式时间接口功能图
SD5182HV100 Functional Specification Page 526 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
OLT
timestamp
ONU
timestamp
PPS_TOD
OAM
TSOLT
TSONU=TSOLT
TSOLT_pps
TSONU==
TSOLT_PPS_NEXT_1s-RTT/2+ADJ
刷新ONU的TOD时间
PPS
TSOLT_PPS_NEXT_1S
PPS
TSOLT_PPS_NEXT_1S
RTT
1s
TSOLT_PPS_NEXT_1S
Figure 11.2-6 EPON 时间同步示意图
错误!未找到引用源。中的补偿时间（ADJ）包括OLT 端PPS 与Timestamp 的延迟和接
收的不对称延时，由于OLT 端的PPS 秒的产生情况不一定，需要视实际情况进行调整补
偿时间。
EPON OLT 下发OAM 帧的数据结构如下面各表所示。
Octets Content Description
6 0x0180_C200_0001 MAC Control
6 SA OLT SA
2 0x8809 Type/Length
1 0x03 Subtype
2 Flag Flag
1 0xFE Code
3 0x00_0DB6 OUI
6 0x0307_00E3_0100 最低字节。
00：disable；
01：enable。
33 PAD 填充码
SD5182HV100 Functional Specification Page 527 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Octets
Content
Description
4
FCS
前向纠错编码
Table 11.2-6 同步以太网功能使能OAM表
Octets
Content
Description
6
0x0180_C200_0001
MAC Control
6
SA
OLT SA
2
0x8809
Type/Length
1
0x03
Subtype
2
Flag
Flag
1
0xFE
Code
3
0x00_0DB6
OUI
9
0x11_0700_B710_0001_0101
-
4
0xFFFF_FFF4
-
4
ONU RTT
ONU RTT，单位TQ
22
PAD
填充码
4
FCS
前向纠错编码
Table 11.2-7 RTT传送OAM表
Octets
Content
Description
6
0x0180_C200_0001
MAC Control
6
SA
OLT SA
2
0x8809
Type/Length
1
0x03
Subtype
2
Flag
Flag
1
0xFE
Code
3
0x00_0DB6
OUI
5
0x11_0700_B604
-
SD5182HV100 Functional Specification Page 528 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Octets
Content
Description
4
PPS TS
Next 1pps Timestamp数值
30
PAD
填充码
4
FCS
前向纠错编码
Table 11.2-8 Timestamp传送OAM表
Octets
Content
Description
6
0x0180_C200_0001
MAC Control。
6
SA
OLT SA。
2
0x8809
Type/Length。
1
0x03
Subtype。
2
Flag
Flag。
1
0xFE
Code。
3
0x00_0DB6
OUI。
1
0x11
操作码。
1
Branch
Branch。
2
Leaf
Leaf。
1
0x4F
Length。
1
SN
SN。
11
MFR_ID，Code
“厂商名称，命令”，ASCII编码。
13
YYMMDDHHMMSS
年为两个数字，2000～2099，24小时制，ASCII编码。
2
TOD_ID
取值范围1～3。
1：RTC；
2：GPS时间；
3：UTC时间。
ASCII编码。
SD5182HV100 Functional Specification Page 529 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Octets
Content
Description
2
PPS_VLD
取值范围0～1。
0：输出1pps；
1：1pps不输出。
ASCII编码。
2
MODE
取值范围1～2。
1：估计观察点模式；
2：固定观察点模式。
ASCII编码。
13
YYMMDDHHMMSS
预报UTC闰秒调整日期/时间，ASCII编码。
3
LeapSecond
+1：加1秒；
00：不调整；
–1：减1秒。
ASCII编码。
3
UTCoffsetGPS
取值范围00～99，为UTC与GPS时间差，ASCII编码。
13
YYMMDDHHMMSS
UTC日期/时间戳，不用时置0，ASCII编码。
5
GPSweeks
GPS周计数，取值范围0000～3182，ASCII编码。
7
GPSseconds
一个GPS周的秒计数，取值范围000000～604799，ASCII编码。
3
0x2C_0B08
TOD传输结束符号。
3
PAD
填充码。
4
FCS
前向纠错编码。
Table 11.2-9 TOD传送OAM表
SD5182HV100 Functional Specification Page 530 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
11.2.6 XEPON的同步方式
XEPON只工作在802.1as模式。
ONT注册后，ONT与OLT的MAC层Timestamp计数器同步，OLT将通过Timesync报文下发PPS时对应的时间和下一个秒脉冲的Timestamp数值，OLT计算ONT的RTT并不下发，只是补偿到TIMESTAMP时戳中。
Timesync报文并不能在XEPON协议栈中解析，需要通过转发通路通路捕获至CPU。ONT软件通过解析Timesync报文后，将OLT下发的信息配置SD51XX触发的Timestamp和对应的同步时间数值，当SD51XX EPON的Timestamp计数器与软件配置匹配时，将软件配置的同步时间刷新到本地时间，实现SD51XX本地时间与OLT时间同步，并输出PPS时间数据。
Timesync报文格式如下：
Octets
Content
Description
6
0x0180_C200_0002
MAC Control
6
SA
OLT SA
2
0x8809
Type/Length
1
0x0A
Subtype
3
0x0080C2
Organizationally Unique Identifier (OUI)
2
0x0001
Message identifier
4
selected timestamp
X field ，单位TQ
10
time-of-day
ToDX,i is the time-of-day when a downstream MPCP message that would carry a timestamp of X would have
arrived at the clock slave i.
10
sourcePortIdentity
sourcePortIdentity
1
logMessageInterval
logMessageInterval
8
rateRatio
rateRatio
2
gmTimeBaseIndicator
gmTimeBaseIndicator
12
lastGmPhaseChange
lastGmPhaseChange
4
scaledLastGmFreqChange
scaledLastGmFreqChange
4
FCS
前向纠错编码
SD5182HV100 Functional Specification Page 531 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Table 11.2-10 Timesync表
11.2.6.1.1 TK模式和802.1AS模式的实现区别
在TK模式下，需要更新本地时间时，CPU将要更新的48bit秒级时间写入相应寄存器，逻辑在EMAC输出的1PPS脉冲上升沿更新本地时间，秒级时间更新为软件配置的数据，纳秒级时间更新为999,000,000纳秒（为了防止EMAC 1PPS的抖动造成本地丢失1PPS脉冲输出，因此软件与硬件配合，默认EMAC输出1PPS脉冲的上升沿时的纳秒时刻为999ms）。
在802.1AS模式下，需要更新本地时间时，CPU识别和解析802.1as协议报文，将要更新的48bit秒级时间+32bit纳秒时间写入相应寄存器，逻辑在EMAC输出的1PPS脉冲上升沿更新本地80bit时间。
11.2.7 1588标准同步方式
通过内部CPU计算Offset，并把Offset通过ICSS访问寄存器接口配置到TimeStamp模块寄存器，TimeStamp的本地时间计数器就根据Offset进行调整。
通过I2C与外部时钟扣板交互，由外部扣板计算时间，通过IIC传递给SD51XX绝对时间值，并产生1pps脉冲。软件通过1pps脉冲进行时间同步。
11.2.8 1pps输入时间同步方式
SD51XX的TimeStamp支持片外的时间源设备对片内进行同步。具体方式为：Sec级的时间同步，需要片外设备通过UART/I2C/ETH MAC等外设或接口告知内置CPU，CPU通过配置寄存器的方式对TimeStamp同步；ns级的时间通过1pps的输入管脚传递标准S脉冲，直接对TimeStamp进行同步。
11.2.9 TimeStamp计数器时钟选择
依据1588的应用场景不同，Timestamp会提供两种计数频率：155.52M/125M。155.52M的计数频率仅用于上行模式为GPON/XGPON时，51XX采用GPON/XGPON私有时间同步，此时，TimeStamp的本地时间计数器，使用GPON/XGPON的线路恢复时钟155.52M。
在EPON上行私有时间同步模式下，Timestamp工作在125M的EPON线路恢复时钟，TYPEC情况下，该时钟也可以选择从两个PON中的一个获得。
在XEPON上行时间同步模式下，从Serdes RX恢复的是156.25M的线路时钟，需要先经过TIMER_PLL分频处理为125MHz后，Timestamp工作在这个125M的线路恢复时钟。8K时钟由于从156.25M无法整数分频得到，因此也是从125M的线路恢复时钟分频得到。
SD5182HV100 Functional Specification Page 532 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
在GE 模式下，SD51XX 支持标准的1588 处理，Timestamp 工作在125M，这个125M
时钟来源于1588 选源，如果选源到某个GE 口，则该端口SDS 恢复时钟将被送至
Timestamp;如果该接口是用户侧的GMII 接口，还可以是该接口RX 时钟。GE 模式，
125M 计数时钟还可能来源于片外，该时钟为从时钟扣板输入SD51XX 的25M时钟，经
过PLL 倍频至125M给Timestamp 使用。
更多1588 时钟描述请参见SD51XX Clocking 章节。
HiLink
SerDeS
OSC
ECSPLL DIV
125MHz
TimeStamp Master时钟
TimeStamp Slave时钟
UNI GE工作时钟
25MHz
syncE
25/38.88/40/77.76MHz
25MHz
CMU
155.52/156.25
UNI PHY参考时钟
M
U
X
rxoclk
DIV
2000MHz
DIV
DIV
其他电路
工作时钟
PLL1
M 8K时钟输出
U
X
155.52MHz
DIV
其他电路
工作时钟
CMU
DIV
M
U
X
CMU
DIV
HiLink
SerDeS
155.52/156.25
DIV
500MHz TimeStamp Slave时钟
UNI XFI PTP时钟
Figure 11.2-7 1588 及同步以太时钟方案图
11.3 1PPS 时间接口
SD51XX 支持1 个1pps 输入、1 个1pps 输出＋TOD 接口，其中TOD 接口采用UART
和软件配合实现传递。输出模式下，根据local_time 本地时间输出1pps 脉冲信号，提供
1pps 输出有效中断，同时通过寄存器反馈1pps 输出对应的秒级时间信息给内置CPU。
1pps 还可以用来作为输入同步方式，可以配置选择1pps 为输入同步源； 1pps 输入模式
下，芯片作为终端器件，根据上级芯片的1pps 输入信号来同步本地时间，维护本地时间
计数器。
SD5182HV100 Functional Specification Page 533 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
12 DFX
本章描述芯片的DFX功能，主要包括低功耗设计、可测试性设计、可Debug性设计、可扩展性设计。用以指导设计、验证和应用。
12.1 TERMINOLOGY Term Description
Table 12.1-1 Terminology
SD5182HV100 Functional Specification Page 534 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
12.2 DFT(DESIGN FOR TEST)
可测试性是芯片设计中比较重要的关键特性，主要目标是在芯片完成制造后，通过测试来确保芯片没有物理损伤、没有功能、性能缺失，确保量产芯片没有问题。
可测试性分两种方案：测试模式下的可测试性设计和功能模式下的可测试性设计。测试模式下的可测试性设计有专门的团队完成，主要目标确保芯片制造没有问题，通常是在ATE机台完成，包括CP和FT测试。因为有独立的ATE模式下的DFT设计方案，本章不再描述，下面重点讲下功能模式下的可测试性设计。
12.2.1 LOOPBACK
12.2.1.1 SerDes LOOPBACK
SerDes环回支持三种配置模式：
 TX到RX方向的串行环回（所有PON模式下均不支持串行换回）；
 RX到TX方向的并行环回；
 TX到RX方向的并行环回（不过CDR）。
环回1的数据可以是内部逻辑产生，也可以由SerDes自带的PRBS产生，TX和RX速率配置相同。此环回经过SerDes的TX和RX通路，但不经过PAD和IO，在SerDes端口进行的环回。
环回2为外环回，RX接收到的数据通过并行数据口环回到TX方向。此环回经过CDR等SerDes的大部分数据通路。
环回3为内部逻辑的数据环回，通常用于问题debug，此环回不经过SerDes的数据通路，仅在内部逻辑接口处做的数据环回。
三个环回不能同时配置。详细环回路径请参考下图：
Figure 12.2-1 SerDes环回示意图
SD5182HV100 Functional Specification Page 535 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
12.2.1.2 GE MAC LOOPBACK
GE MAC 的环回也有三种模式：MAC 系统内环，MAC PCS 系统外环、PCS 线路侧环回。
参考下图说明：
Figure 12.2-2 GEM AC 环回示意图
MAC PCS
APP侧
线路侧
GE_MAC_PCS
2、MAC_PCS系统外环回
1、MAC系统内环
3、PCS线路侧环回
MAC 内外环回不能同时应用（1、2 环回只能同时一个有效）；
MAC 环回与PCS 环回相互独立，即可同时配置1、3 环回同时作用，完成整个MAC_PCS
的内外环回。
MAC 环回控制
SD5182HV100 Functional Specification Page 536 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
cf_out_loopback_en，控制环回2，完成MAC_PCS整个系统外环回；cf_out_loopback_driver用于控制外环回时，是否同时输出数据给用户侧。
cf_in_loopback_en，控制环回1，只是MAC侧的内环回，此时无信号到PCS。
PCS环回控制
pcs_out_loopback，控制环回3，完成PCS侧外环回；此时MAC给PCS的TX信号无效，PCS给MAC的RX信号有效。
12.2.1.3 GEPHY LOOPBACK
GEPHY核支持两种环回模式。环回模式主要用于在开发阶段的问题定位以及产品功能测试。根据环回的数据流方向，环回模式可以分成两类：“线环回”和“MAC环回”。MAC环回是数据包从MAC的TX通道发出后，重新环回至MAC的RX通道。线环回是指从双绞线接收进来的数据（RX通道），环回至PHY的TX通道并发回双绞线端。如下图。
Figure 12.2-3环回方向示意图
12.2.1.3.1 MAC 环回
Gphy核的MAC环回可以让GMII接口发送数据传送到GMII接收输出端（送回MAC）。
这个环回Gphy不需要和对端建立link。
SD5182HV100 Functional Specification Page 537 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
12.2.1.3.2 线环回
线环回是设计用于在没有MAC层参与的情况下检测传输线接口（MDI）。在进行线环回前，Gphy必须与对接器件建立可靠的连接。另外，环回模式需要通过MDIO控制寄存器使能。
12.2.1.4 PCIE LOOPBACK
PCIe支持两种Local环回模式。一个是Local 环回，一个是remote 环回。
Local环回，不需要建立link，需要PHY的提供时钟即可，环回路径不涉及到PHY，仅仅在PCIe内部进行环回。
Remote 环回，是属于PCIe Spec也不需要建立link，需要PHY的提供时钟即可，需要链路稳定OK，环回路径涉及PHY和remote PHY。
12.2.1.4.1 Local环回测试
PCIe内部本地环回
前提条件:
Local loopback包括PIPE RX和PIPE TX信号，而且只在环回状态下运行，因为控制器自身是不能跟自己建立link而进入L0（xmlh_ltssm_state=0x11）状态进行报文的收发的。
SD5182HV100 Functional Specification Page 538 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
进入local PIPE loopback的初始化流程:
不使能Gen3 Equalization，即设置PCIe内部寄存器，中偏移量为寄存器0x700+0x190（port logic register）的寄存器的bit[16]为0，因为PHY是不参与这个换回的。
设置PCIe内部寄存器，偏移量为0x700+0x1B8的PIPE Loopback Control寄存器的bit[31]为1，使能PIPE 环回。
设置PCIe内部寄存器，偏移量为0x700+0x10的Port Link Control寄存器bit[2]为1，使能loopback。
----结束
环回下的枚举和BAR启动:
在环回状态下，也必须要配置（通过local CPU去配置PCIe内部寄存器空间）BAR地址（EP），memory/IO范围（downstream port），设置PCI标准256bytes配置空间头中的memory空间使能和总线master使能（即设置PCIe内部寄存器，配置空间中偏移地址为0x4的比特0、比特1和比特2为1）。这样的话，接收过滤才能正常接收TLP报文。
退出本地环回:
清除DBI空间中偏移量为0x700+0x1B8的 PIPE Loopback Control寄存器的比特31，写其为0即可。
清除DBI空间中偏移量为0x700+0x10的 PIPE Loopback Control寄存器的比特2，写其为0即可。
12.2.1.4.2 Remote 环回测试
用于PCIe链路检测，如0所示。
remote 环回测试
SD5182HV100 Functional Specification Page 539 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.

DDR
A
B
AMBA
AXI
Bridge
Slave
Master
比较A和B数据
是否一致
PCIe Core
iATU.outbound方向
Base addr=slave.addr
Target addr=B.addr
PCIe
PHY
PCIe
PHY
Remote device
软件往PCIe 方向发送读写命令，经过环回后，在DDR 内存里面进行比对，检测PCIe 链
路是否正常。
其配置过程如下：
PCIe 初始化成功。（包括link up，设置PCIe DBI 空间偏移0x4 的命令寄
存器，bit[2:0]=3b111）。
通过设置PERI_PCIE7[dbi_cs]=1，则访问的是pcie 内部寄存器空间（DBI
空间）
设置PCIe DBI 空间寄存器：地址偏移为0x700 + 0x10 的寄存器的bit[2]设
置成1；loopback 使能。
循环读取PCIe DBI 空间寄存器：地址偏移为0x700 + 0x28 的寄存器的
bit[5:0]；如果bit[5:0]为0x1b，则PCIe 进入loopback 状态。
软件申请两块内存，分别是A 和B，在DDR 内存，初始化A 地址和数据。
初始化iATU，将outbound 目标地址设置为B 地址，报文类型是MEM类
型，如下表所示。
Remote loopback 模式下，iATU 配置（仅供参考）
iATU 寄存器名称 Region0 参考值
说明 访问外设MEM空间
VideindexRegister 0x0000_0000
（outbond）
SD5182HV100 Functional Specification Page 540 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
iATU寄存器名称 Region0参考值 说明 访问外设MEM空间
RegionControl1Register
0x0000_0000
RegionControl2Register
0x8000_0000
LowerBaseAddressRegister
PCIe Slave地址+软件自定义的外设MEM空间偏移
UpperBaseAddressRegister
0x0000_0000（高32位地址，软件可以自定义）
LimitAddressRegister
PCIe Slave地址+软件自定义的外设MEM空间偏移+外设MEM空间大小
LowerTargetAddressRegister
DDR内存B地址低32位
UpperTargetAddressRegister
DDR内存B地址高32位
软件将A地址和数据写到PCIe侧。
软件比较A地址和B 地址数据是否一致。
----结束
12.2.2 LINE DIAGNOSE
12.2.2.1 PRBS
PRBS主要用于装备测试、单向吞吐量测试和双向吞吐量测试。
PRBS主要特性：
支持两种阶数的PRBS数据产生和校验：
PRBS-23；
PRBS-31。
支持将PRBS数据流封装成以太报文发送：
支持最多8通道发送报文；
SD5182HV100 Functional Specification Page 541 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
支持发送报文的以太报文头可配置；
支持发包插错；
支持两种发包模式：单次发包和连续发包；
单次发包模式下，支持发包完成上报中断。
支持将接收到的以太报文，剥除以太报文头后，对净荷进行PRBS校验：
支持最多8通道接收报文；
支持接收报文两种校验模式：单包内部校验和多包连续校验；
支持收包错误上报中断。
支持通道的区分：发送方向支持使用不同的SMAC/DMAC来区分通道，通道的SMAC/DMAC由逻辑自动生成，基本原则方法是SMAC/DMAC+子通道号；接收方向支持通过入端口配置映射到不同的通道上；
支持对接收报文PRBS校验错误比特数进行统计；
支持单向TM测试和双向DM测试，支持是否关注报文优先级可配置；
支持报文的伪装发送，报文的FCB可配置，包括端口信息、CPU指定转发等；
支持报文外环回功能，将EPS送过来的外环回报文直接传送给IPS；
支持对发送报文个数和接收报文个数进行统计；
支持jubmo帧；
是否添加默认TAG可配置，支持Untag报文。
PON业务也有定位手段，例如Ploam消息等；视频诊断；
12.2.3 FMEA
FMEA基于芯片实现和网络芯片校验准则，结合产品应用场景，完成SD5182HV100的FMEA设计。主要包括校验和中断两部分。
校验部分分ECC校验和Parity校验。主要原则是：内部集成的大块RAM部分，如果功能重要（队列），出问题影响比较大（系统挂死），做ECC校验。影响有限（单个报文错）的部分RAM做了奇偶校验。
ECC校验结果有中断上报，出现问题时软件可以及时响应，奇偶校验结果没有中断，需要软件查询相应的状态寄存器。
SD5182HV100 Functional Specification Page 542 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
中断部分则把芯片中各个Partition比较重要的事件发生时触发中断，芯片内部设计有比较完善的中断方案，软件可以根据中断类型和中断号，识别问题大小，执行相应的措施。
详细的校验和中断寄存器请参考寄存器手册描述。
12.2.4 MEMORY BIST
SD5182HV100针对芯片内部集成的RAM设计有 Function Mbist。针对外部DDR颗粒，支持EXMbist测试。当然，ATE模式下也有相应的Mbist测试功能。
12.2.4.1 Function Mbist
虽然芯片中支持DFT Mbist，但在实际应用中，芯片偶尔还是存在由于RAM缓存问题导致的误码和丢包情况，需要针对这些问题做进一步的debug，因此，功能模式下的Mbist也需要支持。
Function Mbist使用的电路和DFT Mbist基本相同，仅仅接口调用不同，是在功能模式下，由CPU配置相关寄存器，按照一定的流程收发读写数据，达到测试内部RAM的目的。
由于Function Mbist由软件执行，相应的测试速度会比较慢。可以作为RAM故障的定位手段之一，在分析完问题根因后，提出ATE测试向量的需求，在前端完成芯片的筛选。
12.2.4.2 EXMbist
芯片内部RAM有Mbist可以进行测试，针对外部缓存单元，芯片也内置了一个模块来对其进行测试，就是EXMbist。
EXMbist是芯片集成的一个功能模块，在功能模式下使用，挂在DDR控制器逻辑上，通过DDR读写访问通道完成对外置RAM的数据读写操作。从而可以基于片外RAM的全覆盖完成问题的分析和定位。
EXMbist不支持在线测试，主要应用于单板启动阶段和ATE测试。
12.2.4.3 eTCAM Mbist
芯片内部调用eTCAM单元，eTCAM有专用的Mbist电路进行测试，测试结果可以通过MPI接口读取。
SD5182HV100 Functional Specification Page 543 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
12.2.5 XPON DFT
12.2.5.1 TypeB倒换
EPON和10GEPON模式的TypeB倒换主要功能是OLT侧完成，本章不再描述，下面主要描述GPON、NGPON和XGSPON模式的typeB倒换功能。
XPON MAC逻辑支持EQD更新消息的识别和处理，TypeB逻辑优化可配置，有效后逻辑独立完成EQD的更新；TypeB逻辑使能关闭时，EQD消息由软件识别和处理。
12.2.5.2 OTDR
XPON MAC支持两种OTDR模式：重调制窗口模式和专用窗口模式。
“OTDR重调制窗口”：只要ONU上配置“OTDR测试使能”，并且收到的Grant length（带宽）大于ONU上软件配置的“重调制长度门限”（比如超过100us的上行窗口才进行重调制测试），那么XPON MAC就在这个Grant/BWmap起始时输出“OTDR测试触发信号”给光模块，同时在这个Grant/BWmap中正常发送上行业务，正常输出tx_en，就跟正常、普通的BWmap一样；
“OTDR专用窗口”的Grant/BWmap需要由OLT进行标识、由ONU进行识别，然后XPON MAC在这个Grant/BWmap起始时输出“OTDR测试触发信号”给光模块，同时在这个Grant /BWmap中不发送上行业务，输出tx_en＝不发光（由光模块自己去控制OTDR测试发光、自己去生成发送OTDR test pattern）。
12.2.5.3 Rogue ONU Exposure
Rogue ONU Exposuree配置使能有效后，在上行方向“非有效发光区间”（没有分配上行带宽），周期性发送“固定序列”数据给Serdes。“固定序列”由软件构造并配置，存储在GMAC的表项中，表项深度为256，位宽8bit；若需要发送有效数据（正常上行数据），则停止“固定序列”的发送，待有效数据发送完成后，重新从表项地址0开始读取“固定序列”并发送。
12.2.6 USB3 DFT
功能说明
1、支持DEBUG[]、UTMI+、PIPE3信号时钟域同步DGB clk domain；
2、支持DEBUG信号通过DBG_SEL进行多种选择组合；
3、支持多PORT端口配置，默认为PORT0；
4、支持DGB_SIG[31:0]进行MASK[31:0]，MASK可配，MASK后输出DGB_SIG_MASK[31:0]；
SD5182HV100 Functional Specification Page 544 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
5、支持检测DGB_SIG_MASK[31:0]信号跳变，将变化的DGB_SIG_MASK写入USB3_DGB_RAM；
6、支持2种DEBUG方式：触发模式和非触发模式；
触发模式（DBG_MODE=0x1）：
通过CPU配置DBG_TRI[31:0]，检测DGB_SIG_MASK[31:0]与DBG_TRI[31:0]是否匹配，如果匹配，并且满足配置的触发次数，则上报触发的写地址dbg_tri_waddr和当前写循环写RAM次数的dbg_tri_wcnt，并且支持匹配后写次数可配DBG_WCNT，最大支持RAM_Depth-1，可以DEBUG匹配前和匹配后的状态。
非触发模式（DBG_MODE=0x0）：
通过配置DBG_WCNT停止RAM的写操作，记录N*Depth~（N+1）*Depth-1的状态跳变，DBG_WCNT={Depth{1’b1}}时可以无限制写，其他则为可配置完成1~2^^(Depth-1)-1次写满操作即暂停，可以通过分别配置DBG_WCNT0,1,2,3,4……打印出N*Depth~（N+1）*Depth-1的DGB_SIG_MASK[31:0]变化，当完成DEBUG后输出写完标记。
7、支持CPU直接读取瞬态状态DBG_BYPASS[31:0]；
12.2.6.1 DEBUG流程
12.2.6.1.1 触发模式
假设RAM的depth=128，当前DEBUG想抓取USB3_Link_State为U1前63个状态，和U1后64个状态的状态机的行为的操作步骤：
步骤1：配置DBG_CLK_SEL选择MAC3_CLK；
步骤2：配置DBG_SRST_N为不复位；
步骤3：将DBG_TRI_CNT_CFG配置为触发次数为TRI_CNT；
步骤4：将DBG_WCNT配置为64；
步骤5：将DBG_TRI[31:0]中对应的USB3_Link_State配置为U1；
步骤6：设置MASK[31:0]将除USB3_Link_State的其他信息掩码掉；
步骤7：使能DBG_EN；
当USB3_Link_State出现第（TRI_CNT+1）次USB3_Link_State=U1时，则上报DEBUG触发成功将dbg_finish_sync置高，并且同时上报缓存USB3_Link_State=U1的RAM的地址信息dbg_tri_waddr、循环写RAM的计数dbg_tri_wcnt；USB_DBG将继续
SD5182HV100 Functional Specification Page 545 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
记录触发后的64 个状态后停止写入RAM，则RAM 中记录了63 个触发之前的状态，触
发状态，触发后64 个状态。
12.2.6.1.2 非触发模式
假设RAM 的depth=128，当前DEBUG 想抓取USB3_Link_State 第256~383 次的变化
的操作步骤：
步骤1：配置DBG_CLK_SEL 选择MAC3_CLK；
步骤2：配置DBG_SRST_N 为不复位；
步骤3：将DBG_WCNT 配置为2；
步骤4：设置MASK[31:0]将除USB3_Link_State 的其他信息掩码掉；
步骤5：使能DBG_EN；
使用RAM 记录USB3_Link_State 的变化，当USB3_Link_State 跳变383 次后将停止将
跳变信息写入，并同时将dbg_finish_sync 置为高，整个RAM 中记录着第256~383 次的
状态变化信息，并上报DEBUG 完成标志dbg_finish_sync 置高。
12.2.6.2 功能框图
USB3_DBG_RAM
TWO_PORT
Width:32bit
Depth=128
USB_MISC USB3_TOP
DEBUG[n-1:0]
WR APB
UTMI+
PIPE3
READ
DBG_BYPASS[31:0]
Mac3_clk
Mac2_clk
Bus_clk_early
DBG_CLK_SEL[1:0]
Q
dbg_clk
DBG_SEL[2:0]
32
DBG_Mask[31:0]
32
WDATA[31:0]
Q D
1
0
dbg_clk
DBG_PORT
QQ D
USB_DBG
检测数据变化，按照配置要
求写入RAM
QQ D Q
DBG_MODE
DBG_TRI[31:0]
DBG_USB2_KJCNT[3:0]
DBG_WCNT[AWIDTH-1:0]
DBG_RAM_CNT[15:0]
DBG_EN
WCLK
APB_CLK->RCLK
SRST
SCAN
dbg_clk SYNC
DBG_SRST_N
apb_resetn
dbg_rst_n
usb3_dbg_clk CRG
12.2.6.2.1 CRG 说明
USB_DBG 模块工作在DBG_CLK 时钟域，由DBG_CLK_SEL[1:0]选择
MAC3_CLK/MAC2_CLK/BUS_CLK_EARLY；
SD5182HV100 Functional Specification Page 546 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
USB_DBG 模块使用DBG_CLK 时钟同步APB_RESETN 产生同步复位DBG_RST_N，支
持软复位dbg_srst_n，使用DBG_RST_N 复位DBG_CLK 时钟域逻辑；
A
B
S 0
Y
DBG_CLK_SEL[0]
Mac3_clk
Mac2_clk
Bus_clk_early
A
B
S 0
Y
DBG_CLK_SEL[1] A
B
S 0
Y
dft_clk_rst_sel
dbg_clk
SRST
SCAN
SYNC
clk
apb_resetn async_rst_n
sync_rst_n
dbg_rst_n
dbg_srst_n srst_n
dft_mode
dft_rst_n
dft_clk_rst_sel
dft_lgc_rst_n
12.2.6.2.2 接口说明
表3 USB3_DBG接口信号列表
Signal Name Width Direction Description
clock&reset Interface
apb_clk
1
I
CRG_TOP 输出的APB 时钟信
号。
apb_resetn
1
I
CRG_TOP 输出的APB 复位信
号，低有效。
mac3_clk
1
I
USB3 控制器输出的mac3_clk
时钟信号。
mac3_clk 为port[0].pipe_clk（
125Mhz）或者
usb_supend_clk(1Mhz)
mac2_clk
1
I
USB3 控制器输出的mac2_clk
时钟信号。
mac3_clk 为port[0].utmi_clk（
60Mhz）
bus_ctrl_early
1
I
USB3 控制器使用的AXI master
时钟。
usb3_dbg_clk
1
O
输出dbg_clk_sel 选择后的时钟
到CRG，使用CRG 支持频率检
测。
SD5182HV100 Functional Specification Page 547 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
DFT Interface
dft_ctrl_bus
I
RAM的DFT输入。
dft_glb_gt_se
1
I
RAM的DFT输入。
dft_mem_gt_se
1
I
RAM的DFT输入。
ctrl_bus
I
RAM的DFT输入。
dft_lgc_rst_n
1
I
dbg_rst的DFT输入。
dft_clk_rst_sel
1
I
dbg_rst的DFT输入。 USB3_MISC Interface RAM READ Interface
dbg_ram_rd
1
I
DBG_RAM读有效，高有效，APB_CLK时钟域。
dbg_ram_raddr
RAM_AWIDTH
I
DBG_RAM读地址，APB_CLK时钟域。
dbg_ram_rdata
RAM_DWIDTH
O
输出DBG_RAM读数据，在dbg_ram_rd的下一拍输出，APB_CLK时钟域。 CONFIG Interface
dbg_srst_n
1
I
DBG软复位，APB_CLK时钟域。
0：复位；(default)
1：不复位。
dbg_en
1
I
DBG使能信号，APB_CLK时钟域。
0：关闭debug；(default)
1：使能debug。
dbg_init
1
I
DBG初始化DBG_RAM信号，
APB_CLK时钟域。
0：不初始化DBG_RAM；(default)
1：使能初始化DGB_RAM。
SD5182HV100 Functional Specification Page 548 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
dbg_sel
3
I
DBG信号选择信号，APB_CLK时钟域。
要求在dbg_en使能时保持静态。
dbg_clk_sel
2
I
DBG时钟域选择信号，APB_CLK时钟域。
2’b00：bus_clk_early；(default)
2’b01：mac2_clk；
2’b1x：mac3_clk；
要求在dbg_en使能时保持静态。
dbg_mode
1
I
DBG模式选择信号，APB_CLK时钟域。
0：非触发模式；(default)
1：触发模式。
要求在dbg_en使能时保持静态。
dbg_mask
32
I
DBG信号MASK信号，APB_CLK时钟域。
0：掩码后输出数据；(default)
1：掩码后输出为0。
要求在dbg_en使能时保持静态。
dbg_tri
32
I
触发模式的触发状态配置信号，APB_CLK时钟域。
要求在dbg_en使能时保持静态。
dbg_wcnt_cfg
RAM_AWIDTH
I
DBG写操作配置，APB_CLK时钟域。。
非触发模式：
dbg_wcnt_cfg=0x7F，无限制循环写DBG_RAM；
SD5182HV100 Functional Specification Page 549 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
dbg_wcnt_cfg=0x0~0x7E，则DBG_RAM完成循环0x0~0x7E写操作后停止；
触发模式：
当触发条件满足后继续写dbg_wcnt_cfg次DBG_RAM。
要求在dbg_en使能时保持静态。
dbg_tri_cnt_cfg
4
I
触发模式下配置触发次数。
配置为0x0表示第1次触发。
dbg_u2_kjcnt_cfg
4
I
USB2 DBG usb2_port_state状态写HST_CHIRP_J/K操作配置，APB_CLK时钟域。
dbg_u2_kjcnt_cfg=0xF，无限制循环写DBG_RAM；
dbg_u2_kjcnt_cfg=0x0~0xE，则当写满dbg_u2_kjcnt_cfg次HST_CHIRP_J/K对后的JK对将过滤掉，不写入DBG_RAM，直到出现HST_CHIRP_END状态。
要求在dbg_en使能时保持静态。 CONFIG Interface
dbg_bypass_sync
RAM_DWIDTH
O
BYPASS debug信息，APB_CLK时钟域。
dbg_tri_waddr
RAM_AWIDTH
O
记录触发模式debug触发状态存入DBG_RAM的地址，APB_CLK时钟域。
dbg_en=0将dbg_finish_sync清为0。
dbg_tri_wcnt
RAM_AWIDTH
O
记录触发模式debug触发状态循环写DBG_RAM的计数，APB_CLK时钟域。
SD5182HV100 Functional Specification Page 550 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
dbg_en=0将dbg_tri_wcnt清为0。
dbg_waddr_sync
RAM_AWIDTH
O
指示当前写DBG_RAM的地址，APB_CLK时钟域。
dbg_finish_sync
1
O
完成debug指示，APB_CLK时钟域。
0：未完成；
1：完成；
dbg_en=0将dbg_finish_sync清为0。 UTMI Interface
utmi_linestate
2
I
UTMI接口信号，utmi_clk时钟域
utmi_xcvrselect
2
I
UTMI接口信号，utmi_clk时钟域
utmi_opmode
2
I
UTMI接口信号，utmi_clk时钟域
utmi_rxvalid
1
I
UTMI接口信号，utmi_clk时钟域
utmi_rxactive
1
I
UTMI接口信号，utmi_clk时钟域
utmi_txvalid
1
I
UTMI接口信号，utmi_clk时钟域
utmi_txactive
1
I
UTMI接口信号，utmi_clk时钟域 PIPE Interface
pipe3_RxValid
1
I
PIPE3接口信号，pipe_clk时钟域
pipe3_PhyStatus
1
I
PIPE3接口信号，pipe_clk时钟域
pipe3_RxEqTrain
1
I
PIPE3接口信号，pipe_clk时钟域
SD5182HV100 Functional Specification Page 551 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
pipe3_RxElecIdle
1 I PIPE3 接口信号，pipe_clk 时钟
域
pipe3_PowerDown
2 I PIPE3 接口信号，pipe_clk 时钟
域
pipe3_RxTermination
1 I PIPE3 接口信号，pipe_clk 时钟
域
pipe3_TxElecIdl
1 I PIPE3 接口信号，pipe_clk 时钟
域
pipe3_TxDataK
4 I PIPE3 接口信号，pipe_clk 时钟
域
DWC USB3 Interface
debug 66 I DWC usb3 DEBUG 输出信号
12.2.6.2.3 RAM 读操作时序说明
Apb_clk
XXX Addr
XXX XXX RDATA XXX
dbg_ram_rd
dbg_ram_raddr XXX XXX
dbg_ram_rdata
12.2.6.3 DEBUG 信号说明
12.2.6.3.1 USB3 DEBUG
由usb3 controller 输出。
SD5182HV100 Functional Specification Page 552 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
NO CASE: ONLY HUB MODE
NO CASE: ONLY HUB MODE
NO CASE: ONLY SSIC MODE
NO CASE: ONLY SSIC MODE
CLK_GATE: 0:clk gate disable
CLK_GATE: 0:clk gate disable
CLK_GATE: 0:clk gate disable
Suspend_clk enable: 1:Suspend clk
Buffer Manager Unit IDLE: 1:IDLE
AXI master IDLE: 1:IDLE
NO CASE: ONLY HOST
UTMI suspend com_n: 0:IDLE
UTMI L1 suspend com_n: 0:IDLE
USB2 speed
NO CASE: ONLY HOST
USB2 txrx state
USB2 port state *注1
Bus error： 1：error
125us counter
USB3 link state
USB3 link sub_state
Controller->U2PHY.UTMI suspend: 0:IDLE 与管脚一致
Mac3_clk：port[0].pipe_clk/125Mhz or usb_supend_clk(1Mhz)
Mac2_clk/Mac_clk：port[0].utmi_clk，60Mhz
Bus_clk：AXI master时钟，由chip内部提供的usb_bus_clk_early
Async：异步
USB2 Speed：
USB2 TXRX State：
SD5182HV100 Functional Specification Page 553 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
USB2 PORT State：
SD5182HV100 Functional Specification Page 554 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
注意：对于HOST 模式下USB2 将会发送255us/50ms 的KJ 对，状态机将在
HST_CHIRP_J/K 不断切换，按照协议要求最少5 对KJ，该处将支持可配置（
DGB_USB2_KJCNT[3:0]）个HST_CHIRP_J/K 对，多余的HST_CHIRP_J/K 将过滤掉。
USB3 LINK STATE
SD5182HV100 Functional Specification Page 555 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
USB3 SUB STATE
12.2.6.3.2 PIPE3
注意：PIPE3 接口的时钟域各自端口USB3 PHY 输出的pipe_clk，低功耗下为suspend clk
SD5182HV100 Functional Specification Page 556 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
Pipe3_RxValid：U3 phy输出
Pipe3_PhyStatus：U3 phy输出，PHY的rate/receiver detection/power management state transitions变化
Pipe3_RxEqTrain：U3 phy输出
Pipe3_RxElecIdle：U3 phy输出，支持接收Electrical Idle
Pipe3_powerdown[1:0]：U3 controller输出，指示速率
Pipe3_RxTermination：U3 controller输出
Pipe3_TxValid：
Pipe3_TxElecIdle：U3 controller输出
12.2.6.3.3 UTMI+
UTMI+端口的时钟域来自各个端口USB2 PHY输出的UTMI_CLK，端口间为同频不同相
utmi_linestatus[1:0]：U2 phy输出，表示DP/DM状态
utmi_xcvrSelect[1:0]：Controller输出，控制DP/DM对地电阻开关
utmi_opmode[1:0]：operational mode，握手发送KJ时为0x2，发送报文时为0x0
utmi_rxactive：0:HS为DM/DP idle， FS：检测到EOP
Utmi_rxvalid：Rxdata有效指示，需要rxactive同时有效
utmi_txactive：
utmi_txvalid：
SD5182HV100 Functional Specification Page 557 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
12.2.6.3.4 USB controller HOST 模式时钟说明
SD5182HV100 Functional Specification Page 558 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
12.2.6.4 DBG_SIG 说明
DBG_SIG[31:0]由DBG_PORT 和DBG_SEL[2:0]选择：
SD5182HV100 Functional Specification Page 559 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
12.2.7 PCIE DFT
12.2.7.1 PCIe 内部寄存器空间
PCIe 相关寄存器结构意图
PCIE_CTRL_7 Bit[13]
serdes_ctrl 寄存器
等于1
PCIE_CTRL_22
~
PCIE_CTRL_35
pcie_misc_ctrl
pcie 内部寄存器空间(DBI空间)
PCIe capability相关
iATU相关
等于0
eDMA相关
PCIe 虚拟化相关
PCIE_CTRL_0
PCIE_CTRL_22
PCIe DFX相关
通过设置PERI_PCIE7[dbi_cs]=1，则访问的是pcie 内部寄存器空间（DBI 空间），PCIe
兼容的配置空间寄存器，eDMA，iATU 等都在该寄存器空间里面。
12.2.7.2 PCIe 向对接外设发读操作，报文不返回
PCIe 向对接外设发读操作，报文长时间不成功返回,超出time-out 时间，
要上报中断slv_err_int（默认不打开该功能，需要软件配置，寄存器
在pcie），同时也支持总线err 屏蔽（PCIe 内部寄存器，DBI 空间，
偏移0x8d0 的bit[0]，如果等于1，则返回err，如果是0，则屏蔽err，
返回OK）。如果打开了PERI_PCIE7 的bit[30:29]，如果遇到总线err，
则会收到中断。Slv_err_int 和link down 中断是同一个中断线，收到
link down 中断后，先查询区分。
SD5182HV100 Functional Specification Page 560 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
PCIe通过PCIE_CTRL模块的PERI_PCIE_STAT6[pcie_slv_err_int]等于1，指示slv_err_err_int。
PCIe0通过查询寄存器PCIE_MISC_CTRL 模块的PERI_PCIE_STAT1[link_req_rst_not_reg]查询为1，表示linkdown。
12.2.7.3 PCIe通过报文paylaod长度和读请求长度查询
PCIe在大流量业务时，往往收发的是burst长度的报文，涉及到报文载荷（payload）和读请求长度的要求。重点针对与收、发包等操作有密切关系的Max_Playload_Size和Max_Read_Request_Size相关的几个寄存器见下图设置进行如下介绍。
设备能力寄存器中的“所支持的Max_Payload_Size”域段表示PCIE设备所能支持的TLP包的最大数据载荷长度，本设备所能接收和发送的所有TLP包的数据长度都不能超过此域段所表示的数据长度。对于SD5118V200来说，所支持的Max_Payload_Size值为128字节（本域段二进制值为“000”）。
PCIE设备能力寄存器（只读）

设备控制寄存器中的“Max_Payload_Size”域段，bit[7:5]，为软件为本设备实际配置的最大数据载荷长度。对于Hi1215V100来说，只支持“000”代表最大有效载荷为128字节，默认是“000”，128字节。
设备控制寄存器中的“Max_Read_Request_Size”域段，bit[14:12]，为软件为本设备配置的最大读请求数据长度。支持的“Max_Read_Request_Size”配置值及对应的读请求数据长度如下：
0000：最大读请求128字节。
0001：最大读请求256字节。
0010：最大读请求512字节（默认）。
其他：保留编码。
PCIE设备控制能力寄存器
SD5182HV100 Functional Specification Page 561 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.

12.2.7.4 PCIe内部状态机可查看
PCIe查看内部状态机xmlh_ltssm_state[5:0]查询PCIE控制器工作状态，正常工作时为0x11,其他情况为异常。
访问寄存器地址PERI_PCIE_STAT4[pcie_xmlh_state]。
12.2.7.5 对接器件PCIe Credit状态
可通过查询对接器件PCIe Credit状态，内部寄存器空间偏移0x730，0x734，0x738。在发包正常情况下，该寄存器值实时更新。
12.2.7.6 重传缓冲区空或非空标志
通过查询内部PCIE_VENDOR_CTRL寄存器空间寄存器QUEUE_STATUS，查看重传缓冲区空或非空标志，报文没有返回指示。
12.2.7.7 支持各种报文异常状态查询
通过查询内部寄存器空间偏移0x104和0x110查看报文异常状态。
PCIe不可修正的错误状态寄存器（偏移0x104） bit 默认值 属性 说明
31:25
RsvdZRsvdZRsvdZRsvdZ
0x00 0x00
ReservedReservedReserved ReservedReservedReservedReserved
24
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
AtomicOp AtomicOp AtomicOp AtomicOp AtomicOp AtomicOp Egress Blocked Status Egress Blocked StatusEgress Blocked Status Egress Blocked Status Egress Blocked Status Egress Blocked StatusEgress Blocked Status Egress Blocked Status Egress Blocked Status Egress Blocked Status
0：AtomicOp Egress is not BlockedAtomicOp Egress is not Blocked AtomicOp Egress is not BlockedAtomicOp Egress is not Blocked AtomicOp Egress is not BlockedAtomicOp Egress is not Blocked AtomicOp Egress is not Blocked AtomicOp Egress is not Blocked AtomicOp Egress is not BlockedAtomicOp Egress is not BlockedAtomicOp Egress is not Blocked AtomicOp Egress is not Blocked AtomicOp Egress is not Blocked AtomicOp Egress is not BlockedAtomicOp Egress is not Blocked AtomicOp Egress is not Blocked；
1：AtomicOp Egress is BlockedAtomicOp Egress is Blocked AtomicOp Egress is BlockedAtomicOp Egress is Blocked AtomicOp Egress is BlockedAtomicOp Egress is Blocked AtomicOp Egress is Blocked AtomicOp Egress is Blocked AtomicOp Egress is BlockedAtomicOp Egress is BlockedAtomicOp Egress is BlockedAtomicOp Egress is Blocked AtomicOp Egress is BlockedAtomicOp Egress is Blocked AtomicOp Egress is Blocked。
23:21
RsvdZRsvdZRsvdZRsvdZ
0x00 0x00
ReservedReservedReserved ReservedReservedReservedReserved
SD5182HV100 Functional Specification Page 562 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
bit 默认值 属性 说明
20
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
Unsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error Status Unsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error Status Unsupported Request Error Status Unsupported Request Error StatusUnsupported Request Error Status Unsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error Status Unsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error StatusUnsupported Request Error Status Unsupported Request Error Status Unsupported Request Error Status
0：未检测到 Unsupported Request Unsupported Request Unsupported Request Unsupported Request Unsupported Request Unsupported Request Unsupported Request Unsupported Request Unsupported Request Unsupported Request Unsupported Request Error ErrorErrorError；
1：检测到 Unsupported Request Unsupported Request Unsupported Request Unsupported Request Unsupported Request Unsupported Request Unsupported Request Unsupported Request Unsupported Request Unsupported Request Unsupported Request Unsupported Request Unsupported Request Error ErrorErrorError。
19
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
ECRC Error ECRC Error ECRC Error ECRC Error ECRC Error ECRC Error ECRC Error StatusStatus Status Status
0：未检测到 ECRC Error ECRC ErrorECRC Error ECRC ErrorECRC ErrorECRC Error；
1：检测到 ECRC Error ECRC ErrorECRC Error ECRC ErrorECRC ErrorECRC Error。
18
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
Malformed TLP Status Malformed TLP StatusMalformed TLP StatusMalformed TLP StatusMalformed TLP StatusMalformed TLP StatusMalformed TLP StatusMalformed TLP Status Malformed TLP StatusMalformed TLP Status Malformed TLP Status Malformed TLP Status Malformed TLP Status Malformed TLP Status
0：未检测到 Malformed TLP Malformed TLPMalformed TLPMalformed TLPMalformed TLPMalformed TLPMalformed TLPMalformed TLP Malformed TLPMalformed TLPMalformed TLP；
1：检测到 Malformed TLP Malformed TLPMalformed TLPMalformed TLPMalformed TLPMalformed TLPMalformed TLPMalformed TLP Malformed TLPMalformed TLP 。
17
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
Receiver Overflow StatusReceiver Overflow StatusReceiver Overflow StatusReceiver Overflow StatusReceiver Overflow Status Receiver Overflow StatusReceiver Overflow StatusReceiver Overflow Status Receiver Overflow StatusReceiver Overflow StatusReceiver Overflow StatusReceiver Overflow StatusReceiver Overflow Status Receiver Overflow StatusReceiver Overflow Status Receiver Overflow Status Receiver Overflow Status Receiver Overflow Status
0：未检测到 Receiver OverflowReceiver OverflowReceiver OverflowReceiver OverflowReceiver Overflow Receiver OverflowReceiver OverflowReceiver OverflowReceiver OverflowReceiver OverflowReceiver OverflowReceiver OverflowReceiver OverflowReceiver Overflow Receiver Overflow；
1：检测到 Receiver OverflowReceiver OverflowReceiver OverflowReceiver OverflowReceiver Overflow Receiver OverflowReceiver OverflowReceiver Overflow Receiver OverflowReceiver OverflowReceiver OverflowReceiver OverflowReceiver Overflow Receiver Overflow。
16
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
Unexpected Completion StatusUnexpected Completion Status Unexpected Completion StatusUnexpected Completion Status Unexpected Completion Status Unexpected Completion Status Unexpected Completion StatusUnexpected Completion Status Unexpected Completion Status Unexpected Completion StatusUnexpected Completion Status Unexpected Completion StatusUnexpected Completion Status Unexpected Completion StatusUnexpected Completion Status Unexpected Completion Status Unexpected Completion Status
0：未检测到 Unexpected CompletionUnexpected Completion Unexpected CompletionUnexpected Completion Unexpected Completion Unexpected Completion Unexpected Completion Unexpected CompletionUnexpected Completion Unexpected CompletionUnexpected Completion；
1：检测到 Unexpected CompletionUnexpected Completion Unexpected CompletionUnexpected Completion Unexpected Completion Unexpected Completion Unexpected CompletionUnexpected Completion Unexpected Completion Unexpected CompletionUnexpected Completion Unexpected CompletionUnexpected Completion。
15
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
Completer Abort StatusCompleter Abort Status Completer Abort Status Completer Abort StatusCompleter Abort Status Completer Abort StatusCompleter Abort StatusCompleter Abort StatusCompleter Abort Status Completer Abort StatusCompleter Abort Status Completer Abort Status Completer Abort Status
0：未检测到 Completer AbortCompleter Abort Completer Abort Completer AbortCompleter Abort Completer AbortCompleter AbortCompleter AbortCompleter Abort Completer AbortCompleter Abort；
1：检测到 Completer AbortCompleter Abort Completer Abort Completer AbortCompleter Abort Completer AbortCompleter AbortCompleter Abort Completer AbortCompleter Abort。
14
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
Completion Timeout StatusCompletion Timeout Status Completion Timeout Status Completion Timeout StatusCompletion Timeout Status Completion Timeout StatusCompletion Timeout Status Completion Timeout StatusCompletion Timeout StatusCompletion Timeout StatusCompletion Timeout StatusCompletion Timeout StatusCompletion Timeout Status Completion Timeout Status Completion Timeout Status Completion Timeout Status Completion Timeout Status
0：未检测到 Completion TimeoutCompletion Timeout Completion Timeout Completion TimeoutCompletion Timeout Completion TimeoutCompletion Timeout Completion TimeoutCompletion Timeout Completion TimeoutCompletion TimeoutCompletion Timeout ；
1：检测到 Completion TimeoutCompletion Timeout Completion Timeout Completion TimeoutCompletion Timeout Completion TimeoutCompletion Timeout Completion TimeoutCompletion Timeout Completion TimeoutCompletion TimeoutCompletion Timeout
13
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
Flow Flow Flow Flow Control Protocol Error StatusControl Protocol Error StatusControl Protocol Error Status Control Protocol Error StatusControl Protocol Error StatusControl Protocol Error Status Control Protocol Error StatusControl Protocol Error StatusControl Protocol Error StatusControl Protocol Error StatusControl Protocol Error StatusControl Protocol Error StatusControl Protocol Error Status Control Protocol Error StatusControl Protocol Error StatusControl Protocol Error Status Control Protocol Error Status Control Protocol Error Status Control Protocol Error Status
0：未检测到 Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Error ErrorErrorError；
1：检测到 Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Flow Control Protocol Error ErrorErrorError。
SD5182HV100 Functional Specification Page 563 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
bit 默认值 属性 说明
12
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
Poisoned TLP StatusPoisoned TLP StatusPoisoned TLP StatusPoisoned TLP StatusPoisoned TLP StatusPoisoned TLP Status Poisoned TLP Status Poisoned TLP StatusPoisoned TLP StatusPoisoned TLP StatusPoisoned TLP Status Poisoned TLP Status Poisoned TLP Status Poisoned TLP Status
0：未检测到 Poisoned TLPPoisoned TLPPoisoned TLPPoisoned TLPPoisoned TLPPoisoned TLP Poisoned TLP Poisoned TLPPoisoned TLPPoisoned TLP；
1：检测到 Poisoned TLPPoisoned TLPPoisoned TLPPoisoned TLPPoisoned TLPPoisoned TLP Poisoned TLP Poisoned TLPPoisoned TLPPoisoned TLP。
11:611:6 11:6
RsvdZRsvdZRsvdZRsvdZ
0x00 0x00
ReservedReservedReserved ReservedReservedReservedReserved
5
RO
0x00 0x00
Surprise Down Error StatusSurprise Down Error Status Surprise Down Error Status Surprise Down Error StatusSurprise Down Error Status Surprise Down Error Status Surprise Down Error Status Surprise Down Error Status Surprise Down Error Status Surprise Down Error Status Surprise Down Error Status，该版本 IP 不支持。
4
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
Data Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error Status Data Link Protocol Error Status Data Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error Status Data Link Protocol Error StatusData Link Protocol Error StatusData Link Protocol Error Status Data Link Protocol Error Status Data Link Protocol Error Status Data Link Protocol Error Status Data Link Protocol Error Status Data Link Protocol Error Status
0：未检测到 Data Link Protocol Data Link Protocol Data Link Protocol Data Link Protocol Data Link Protocol Data Link Protocol Data Link Protocol Data Link Protocol Data Link Protocol Data Link Protocol Data Link Protocol Data Link Protocol Error ErrorErrorError；
1：检测到 Data Link Protocol ErrorData Link Protocol ErrorData Link Protocol Error Data Link Protocol Error Data Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol ErrorData Link Protocol Error Data Link Protocol ErrorData Link Protocol ErrorData Link Protocol Error。
3:1
RsvdZRsvdZRsvdZRsvdZ
0x00 0x00
ReservedReservedReserved ReservedReservedReservedReserved。
0
RsvdZRsvdZRsvdZRsvdZ
0x00 0x00
未定义。
PCIe 可修正的错误状态寄存器（偏移0x110） bit 默认值 属性 说明
31:14
RsvdZRsvdZRsvdZRsvdZ
0x00 0x00
ReservedReservedReserved ReservedReservedReservedReserved
13
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
Advisory NonAdvisory Non Advisory Non Advisory NonAdvisory NonAdvisory NonAdvisory Non Advisory NonAdvisory Non-Fatal Error Fatal Error Fatal Error Fatal Error Fatal Error StatusStatus Status Status
0：未检测到 Advisory NonAdvisory Non Advisory Non Advisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory NonAdvisory Non-Fatal Fatal Fatal Fatal Error ErrorErrorError；
1：检测到 Advisory NonAdvisory Non Advisory Non Advisory NonAdvisory NonAdvisory NonAdvisory Non Advisory Non -Fatal ErrorFatal ErrorFatal Error Fatal Error Fatal ErrorFatal Error。
12
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
Reply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout Status Reply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout StatusReply Timer Timeout Status Reply Timer Timeout Status Reply Timer Timeout Status Reply Timer Timeout Status Reply Timer Timeout Status
0：未检测到 Reply Timer TimeoutReply Timer TimeoutReply Timer Timeout Reply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer Timeout Reply Timer TimeoutReply Timer TimeoutReply Timer Timeout ；
1：检测到 Reply Timer TimeoutReply Timer TimeoutReply Timer Timeout Reply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer TimeoutReply Timer Timeout Reply Timer TimeoutReply Timer TimeoutReply Timer Timeout 。
11:911:9 11:9
RsvdZRsvdZRsvdZRsvdZ
0x00 0x00
ReservedReservedReserved ReservedReservedReservedReserved
SD5182HV100 Functional Specification Page 564 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
bit 默认值 属性 说明
8
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
REPLAY_NUM Rollover StatusREPLAY_NUM Rollover StatusREPLAY_NUM Rollover StatusREPLAY_NUM Rollover Status REPLAY_NUM Rollover StatusREPLAY_NUM Rollover StatusREPLAY_NUM Rollover Status REPLAY_NUM Rollover StatusREPLAY_NUM Rollover Status REPLAY_NUM Rollover StatusREPLAY_NUM Rollover Status REPLAY_NUM Rollover StatusREPLAY_NUM Rollover StatusREPLAY_NUM Rollover StatusREPLAY_NUM Rollover StatusREPLAY_NUM Rollover Status REPLAY_NUM Rollover Status REPLAY_NUM Rollover Status REPLAY_NUM Rollover Status
0：未检测到 REPLAY_NUM REPLAY_NUM REPLAY_NUM REPLAY_NUM REPLAY_NUM REPLAY_NUM REPLAY_NUM REPLAY_NUM REPLAY_NUM RolloverRolloverRollover Rollover RolloverRollover；
1：检测到 REPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM Rollover REPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM Rollover REPLAY_NUM RolloverREPLAY_NUM Rollover REPLAY_NUM RolloverREPLAY_NUM Rollover REPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM RolloverREPLAY_NUM Rollover。
7
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
Bad DLLP StatusBad DLLP StatusBad DLLP Status Bad DLLP StatusBad DLLP Status Bad DLLP StatusBad DLLP Status Bad DLLP Status Bad DLLP Status Bad DLLP Status
0：未检测到 Bad DLLPBad DLLPBad DLLP Bad DLLPBad DLLP Bad DLLP；
1：检测到 Bad DLLPBad DLLPBad DLLP Bad DLLPBad DLLP Bad DLLP。
6
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
Bad TLP StatusBad TLP StatusBad TLP Status Bad TLP StatusBad TLP StatusBad TLP StatusBad TLP Status Bad TLP Status Bad TLP Status Bad TLP Status
0：未检测到 Bad TLPBad TLPBad TLP Bad TLPBad TLPBad TLP；
1：检测到 Bad TLPBad TLPBad TLP Bad TLPBad TLPBad TLP。
5:1
RsvdZRsvdZRsvdZRsvdZ
0x00 0x00
ReservedReservedReserved ReservedReservedReservedReserved
0
RW1CSRW1CSRW1CS RW1CS
0x00 0x00
Receiver Error StatusReceiver Error StatusReceiver Error StatusReceiver Error StatusReceiver Error Status Receiver Error StatusReceiver Error StatusReceiver Error Status Receiver Error StatusReceiver Error StatusReceiver Error StatusReceiver Error StatusReceiver Error StatusReceiver Error Status Receiver Error Status Receiver Error Status
0：未检测到 Receiver ErrorReceiver ErrorReceiver ErrorReceiver ErrorReceiver Error Receiver ErrorReceiver ErrorReceiver Error Receiver ErrorReceiver ErrorReceiver ErrorReceiver Error；
1：检测到 Receiver Receiver Receiver Receiver Receiver Receiver Receiver Receiver Error ErrorErrorError。
12.2.7.8 支持outboud方向timeout报文信息查询
PCIe通过查询寄存器PERI_PCIE_STAT1[radm_cpl_timeout_reg]信息。
12.2.7.9 支持override PCIe状态机查询
通过override PCIe内部寄存器空间偏移0x708的bit[21:16]作为状态机的值，bit[15]是使能。
如果怀疑PCIe SerDes发送端问题，可以通过设置。
12.2.7.10 支持override PCIe协商链路宽度设置
通过配置PCIE_VENDOR_CTRL内部寄存器PORT_LINK_CONTROL来设置。
12.2.8 DDR DFT
12.2.8.1 EXMBIST
EXMBIST是离线测试DDR颗粒坏点和DDR地址、数据线的一个测试工具。内置强大测试算法，能够完成不同压力下的DDR测试任务。
SD5182HV100 Functional Specification Page 565 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
AXI EXMBIST DDRC
MDDRC_TOP
DDRPHY
EXMBIST 模块放在AXI 和DDRC 模块中间，EXMBIST 将AXI 模块发送的命令和写数据
以及自身模块发起的命令和写数据组合送到DDRC 模块，DDRC 模块返回的读数据以及
response 状态先送到EXMBIST 模块中，EXMBIST 通过最高ID 判定是送到AXI 模块还是
送到EXMBIST 模块的，并将标记为AXI 模块的读数据和response 状态送到AXI 模块。
EXMBIST 检测流程：
DDR初始化
exmbist检测标志
Y
N 正常业务流程
exmbist运行，测
试结果、故障信息
保存于片上Sram
检测完成后，将检
测结果、错误信
息、统计信息保存
到DDR保留区
在DDR将老化完
成标志置位
正常启动流程
离线检测执行是在uboot 阶段，且前提是uboot 指令还没有跳转到DDR 中。因为检测算
法会覆盖整个DDR 空间，所以指令需要运行在Flash 中或者Sram中。
SD5182HV100 Functional Specification Page 566 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
算法执行过程中禁止CPU 对DDR 做访问，或者在DDR 有数据保存，任何别的业务访问
都会修改DDR 内容，导致测试不准确。
算法检测结果可以存放在flash 中，也可以存放在DDR 的保留区，当然因这个阶段业务端
口没有使能，内置Sram也可以用于缓存测试结果。
测试程序出现问题，则打印错误信息后启动终止。测试结果正常，则启动正常初始化流程
完成系统启动。
12.2.9 CRG DFT
CRG 的可测试性设计是抽取时钟网络中关键时钟，通过管脚复用的形式在测试模式下输
出。高频时钟则通过内部分频后输出。
DIV2
观测时钟n+1
观测时钟k
PCIE_DIFF
ICG
ICG
ICG
ICG
PCIE0_REFCLK_P
PCIE0_REFCLK_N
观测时钟1
观测时钟2
观测时钟3
……
观测时钟n
WIFI0参考时钟
ICG
ICG
wifi0_observe_en
0
1
test_clk_ctrl
……
观测时钟n+2
ICG
ICG
ICG
ICG
DIV10
TEST_CLK
wifi0_observe_clk_sel
FREQ_DET
Figure 12.2-4 时钟观测电路结构图
对时钟的测试或观测的方式有两种，一种是把时钟输出到一个数字IO(TEST_CLK)进行观
测，另一种是输出到WiFi0 的差分时钟管脚上进行观测。
差分观测管脚能观测的时钟为单端面观测管脚所能观测时钟的子集。差分观测管脚可观测
的时钟主要是usb2/usb3/pcie 相关的IP 时钟，这些时钟同样可以输出到单端面观测管脚。
除此之外，单端面观测管脚还可以观测各总线时钟，cpu 时钟，及pll 输出时钟等。
WiFi0 差分时钟管脚默认状态下输出WiFi0 差分参考时钟。
TEST CLK 模块中集成了时钟检测模块，可以检测出被观测时钟的频率以及检测该时钟是
否丢失。
SD5182HV100 Functional Specification Page 567 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
TEST_CLK功能在芯片上是由上电配置字控制的，默认TEST_CLK时钟输出CPU的工作时钟的20分频时钟。
在进行MUX选择之时需要保证除选择的那一路被观测时钟外，其他时钟的ICG处于关断状态，减少观测时钟的噪声引入。
差分观测管脚可以观测的时钟： 时钟 描述
clk_pciephy0_ref_output
PCIE0 PHY输出的参考时钟
clk_pciephy1_ref_output
PCIE1 PHY输出的参考时钟
clk_pcie0_pipe
PCIE0 PHY输出的PIPE时钟
clk_pcie1_pipe
PCIE1 PHY输出的PIPE时钟
nni_sds_txoclk
PONLINK输出的TX时钟
nni_sds_rxoclk
PONLINK输出的RX时钟
uni_sds_2.5gtxclk
comb Serdes输出的2.5GE模式下的TX时钟
uni_sds_1gtxclk
comb Serdes输出的SGMII模式下的TX时钟
uni_sds_rxclk
comb Serdes输出的RX时钟
uni_sds_ref_clk
comb PHY输出的参考时钟
clk_comb0_pipe3
USB3 PIPE3接口时钟
usb3_dbg_clk
USB3的Debug时钟
clk_usb2_umti0
端口0的USB2的UTMI时钟
clk_usb2_ref0
端口0的USB2的参考时钟
clk_gephy_ref
GEPHY参考时钟
单端观测管脚可观测的时钟： 时钟 描述
clk_cpu
A9时钟
clk_apb
APB总线时钟
clk_ahb
AHB总线时钟
clk_axi
AXI总线时钟
SD5182HV100 Functional Specification Page 568 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
时钟 描述
clk_ddrc
DDR参考时钟
clk_hw_49m
HW接口49.152MHz时钟
clk_gephy_ref
GEPHY参考时钟
clk_gephy0_rx
GEPHY Port0 RXC时钟
clk_gephy1_rx
GEPHY Port1RXC时钟
clk_gephy2_rx
GEPHY Port2 RXC时钟
clk_gephy3_rx
GEPHY Port3 RXC时钟
clk_combpll
USB PLL POSTDIV时钟
clk_lswpll
LSW PLL VCO时钟
clk_pciepll
PCIE PLL POSTDIV时钟
clk_ddrpll
DDR PLL POSTDIV时钟
clk_cpupll
CPU PLL POSTDIV时钟
clk_pciephy0_ref_output
PCIE0 PHY输出的参考时钟
clk_pciephy1_ref_output
PCIE1 PHY输出的参考时钟
clk_pcie0_pipe
PCIE0 PHY输出的PIPE时钟
clk_pcie1_pipe
PCIE1 PHY输出的PIPE时钟
nni_sds_txoclk
PONLINK输出的TX时钟
nni_sds_rxoclk
PONLINK输出的RX时钟
uni_sds_2.5gtxclk
comb Serdes输出的2.5GE模式下的TX时钟
uni_sds_1gtxclk
comb Serdes输出的SGMII模式下的TX时钟
uni_sds_rxclk
comb Serdes输出的RX时钟
uni_sds_ref_clk
comb PHY输出的参考时钟
clk_comb0_pipe3
USB3 PIPE3接口时钟
usb3_dbg_clk
USB3的Debug时钟
clk_usb2_umti0
端口0的USB2的UTMI时钟
SD5182HV100 Functional Specification Page 569 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
时钟 描述
clk_usb2_ref0
端口0的USB2的参考时钟
clk_gephy_ref
GEPHY参考时钟
clk_dp
DP参考时钟
clk_psa
PSA参考时钟
clk_sys_xpspon
XPS PON和MAC间系统时钟
SD5182HV100 Functional Specification Page 570 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
12.3 DFD(DESIGN FOR DBUG)
在芯片测试、维护阶段，有效的debug手段能够快速定位、分析出问题根因，根据不同模块， debug方案的设计略有不同，但共同目标都一致：根据问题状态、统计数据可以初步分析出问题点。5182H的模块设计提供以下功能：
 提供故障检测、告警和恢复功能；
 提供数据校验和错误数据捕获；
 提供状态、统计和查询功能；
 部分XPON MAC支持插错功能；
 数据通道反压状态可查询；
 接口模块提供环回配置；
 支持微码单步执行；
 模块独立复位和时钟关断功能。
以上功能在芯片的不同模块都有涉及，都以寄存器的形式表现出来，详细的操作指导和说明，请参考具体模块的nmanager描述。
具体各partion支持的DFD功能，参考下图所示描述。
SD5182HV100 Functional Specification Page 571 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
ECS SYSTEM
DP
1、基于端口报文个数、字节数统计，
错误统计、指定报文捕获。
2、缓存占用大小统计、基于队列报文
个数统计、字节数统计。
3、独立复位和时钟关断，独立时钟调
频处理。
4、支持出队端口和入队端口反压。
5、出队尾丢弃、入队优先级丢弃，门
限可配置。
UNI MAC
1、用户侧线路故障检查、状态查询、告
警，线路误码检测，故障恢复。
2、基于端口的报文个数、字节数统计，错
误统计、报文校验、数据捕获。
3、端口GE MAC环回，PHY的环回。
4、GE MAC的独立复位和时钟关断，软复
位和硬复位独立支持。
5、校验错误数据打错误标识给DP处理。
NNI SerDes
RGMII
4xGE PHY
AXI BUS
PCIE/USB
DDRPHY DDRC
32bit DDR3-1600/
32bit DDR4-2133
IPSec
PMU
CRG
EFUSE
PSA
1、进程状态的统计、查询。
2、支持微码单步执行。
3、独立复位和时钟关断，独立时钟调
频。
4、支持反压，内部不丢包。
WOS
NNI MAC
1、线路故障检查、状态查询、告警，线路
误码检测，故障恢复。
2、线路基于端口、流的报文个数、字节数
统计，错误统计、报文校验、数据捕获。
3、端口GE MAC环回、SerDes接口内环回
和外环回。
4、XPON MAC和GE MAC的独立复位和时
钟关断，软复位和硬复位独立支持。
5、校验错误数据打错误标识给DP处理
（MAC终止的报文除外）。
SD5182HV100 Functional Specification Page 572 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
12.4 DFE(DESIGN FOR EXTEND)
可扩展性是5182H架构设计需要重点考虑的，作为第一代NP转发架构，需要支撑未来25Gbps的处理能力。
通过工艺提升来达到所处理业务的能力提升和功耗的降低是很自然的事情，本文档先不讲。基于当前工艺，芯片要提升处理能力需要通过良好的架构设计来达到目的。5182H有几个Partition独立分析可扩展性，分别是：ITF接口、数据通路DP、NP子系统PSA和ECS子系统。
接口部分由于是独立的MAC和SerDes、PHY接口，可扩展能力表现为需要出几个接口，进行物理堆砌就行了。
ECS部分本身已经具体很强的可扩展性，本章也不再描述。
5182H的可扩展能力就主要表现在DP和PSA的架构设计上面，下面详细说明。
12.4.1 DP
DP目前的转发能力为16Gbps，工作频点为250MHz，单纯的通过提升工作频点到400MHz也能提高DP的处理能到25Gbps。但是数据通路的处理能力不单纯提升报文的处理能力，还有和PSA的相关的一些规格需要扩展，队列数目需要扩展，端口数也需要扩展。DP可扩展性设计主要措施有：
 提升工作频点到300MHz、400MHz，提升DP整体处理能力；
 内置缓存的大小参数化，可根据端口突发流量来灵活设置PLB的大小；
 PAC ID的规格参数化，应对PSA线程增加时对PAC_ID的需求；
 IPS、EPS端口数目可扩展，可方便挂接上调度器；
 EQM队列、调度器、shaper等规格数目参数化设计；
 部分规格通过扩展位宽实现，比如缓存地址、QID、PAC_ID。
12.4.2 PSA
PSA包括两部分：QUARK和协处理器COP。
12.4.2.1 QUARK
QUARK的可扩展性设计主要是资源的扩张，线程数由目前的64个增加一倍。带来的影响就是线程所用到的资源增加。
提升QUARK的工作频率也能提升报文的处理能力。
SD5182HV100 Functional Specification Page 573 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
12.4.2.2 COP
COP的方案按照256B长度的报文，10Mpps的处理能力进行设计。如果要支持到128B长度报文，15Mpps的能力，当前的方案在不提升芯片制造工艺的情况下扩展能力受限。
但基于技术分析，备用的方案有：
 当前设计方案提升频点到800MHz，满足256B的处理能力需求；
 借用NP平台的SMEM实现方案，性能满足128B，15Mpps的处理能力；
 放置两个PSA进行处理。
SD5182HV100 Functional Specification Page 574 of 574
Ver-1.6 2018-02-11
Copyright © 2016 - 2017, Huawei Technologies. All rights reserved.
CONFIDENTIAL. FOR INTERNAL USE ONLY.
13 EXTERNAL INTERFACES
This is for the L1 Heading style purpose; the block level owner should ignore this level.
